## LightChaser-V3

### Generated for: Cantina : Kuru

### Generated on: 2025-08-18

## Total findings: 205

### Total HIGH findings: 1

### Total Medium findings: 6

### Total Low findings: 70

### Total Gas findings: 58

### Total NonCritical findings: 70
# Summary for High findings

| Number | Details | Instances |
|----------|----------|----------|
| [High-1] | msg.sender used in implementation of a ERC2771 relay contract | 2 |
# Summary for Medium findings

| Number | Details | Instances |
|----------|----------|----------|
| [Medium-1] | Privileged functions can create points of failure | 18 |
| [Medium-2] | Contract can accept funds with no way of extracting them | 1 |
| [Medium-3] | Withdraw/Redeem functions can fail due to blocked USDT/USDC accounts | 2 |
| [Medium-4] | `symbol()` call against arbitrary `ERC20` token can revert as not all `ERC20` tokens store their `symbol` state variable as a `string` as stated in the `ERC20` specification such as `MKR` token token which stores it as a bytes32 state variable | 1 |
| [Medium-5] | Transfer flow from `msg.sender` to protocol favours msg sender by its `amount` value rounding down when it should round up to prevent exploitation | 4 |
| [Medium-6] | Vault fees state variables can be modified post deployment which goes against the OZ `ERC4626Fees` implementation and can result in loss of fund for users who have already deposited | 1 |
# Summary for Low findings

| Number | Details | Instances |
|----------|----------|----------|
| [Low-1] | Potential division by zero should have zero checks in place  | 5 |
| [Low-2] | Division operations should always be performed after multiplication operations  | 4 |
| [Low-3] | Function with two array parameter missing a length check  | 2 |
| [Low-4] | Missing checks for address(0x0) when updating address state variables  | 2 |
| [Low-5] | Missing empty bytes check when assigning bytes/string state variable  | 1 |
| [Low-6] | Solidity version 0.8.23 won't work on all chains due to MCOPY  | 3 |
| [Low-7] | Function call without checking or using it's return values  | 6 |
| [Low-8] | Contracts do not use their OZ upgradable counterparts  | 5 |
| [Low-9] | Some tokens may revert when zero value transfers are made  | 10 |
| [Low-10] | Unsafe uint to int conversion | 15 |
| [Low-11] | Withdrawal mechanism can be Dos'd with dust withdrawals | 1 |
| [Low-12] | Vault `totalAssets` function calculates it's `totalAsset` value using non standard method that can result in incorrect accounting | 1 |
| [Low-13] | Low level calls in solidity versions preceding 0.8.14 can result in an optimiser bug | 16 |
| [Low-14] | Empty receive functions can cause gas issues | 1 |
| [Low-15] | Upgradable contracts should have a __gap variable | 5 |
| [Low-16] | The call tx.origin should not be used in any case besides in functionality to determine if a sender account is a EOA account or not as it's value can be manipulated to break access control | 1 |
| [Low-17] | Token supply should not be centralised at deployment | 1 |
| [Low-18] | Use SafeCast to safely downcast variables | 2 |
| [Low-19] | The nonReentrant modifier should be first in a function declaration | 8 |
| [Low-20] | Initializer function can be front run | 5 |
| [Low-21] | The function decimals() is not part of the ERC20 standard | 4 |
| [Low-22] | No limits when setting fees | 1 |
| [Low-23] | Loss of precision | 7 |
| [Low-24] | Missing zero address check in constructor | 2 |
| [Low-25] | Return values of transfer()/transferFrom() not checked | 1 |
| [Low-26] | Use of onlyOwner functions can be lost | 4 |
| [Low-27] | Off-by-one timestamp error | 4 |
| [Low-28] | approve()/safeApprove() may revert if the current approval is not zero | 7 |
| [Low-29] | safeApprove is deprecated | 4 |
| [Low-30] | Remaining eth may not be refunded to users | 4 |
| [Low-31] | Constant decimal values | 1 |
| [Low-32] | Function which returns data from a call has no validation for said data | 3 |
| [Low-33] | Sending tokens in a for loop | 2 |
| [Low-34] | Large approvals such as type(uint256).max may not work with some tokens | 4 |
| [Low-35] | Revert on Transfer to the Zero Address | 3 |
| [Low-36] | Return values not checked for approve() | 1 |
| [Low-37] | Consider adding a time delay to upgrade implementation functions | 4 |
| [Low-38] | The function symbol() is not part of the ERC20 standard | 2 |
| [Low-39] | No access control on receive/payable fallback | 1 |
| [Low-40] | External call recipient may consume all transaction gas | 2 |
| [Low-41] | Events may be emitted out of order due to code not follow the best practice of check-effects-interaction | 4 |
| [Low-42] | Missing zero address check in initializer | 4 |
| [Low-43] | Critical functions should have a timelock | 5 |
| [Low-44] | Unbounded loop may run out of gas | 12 |
| [Low-45] | Consider implementing two-step procedure for updating protocol addresses | 2 |
| [Low-46] | SafeTransferLib does not ensure that the token contract exists | 1 |
| [Low-47] | Don't assume specific ETH balance | 2 |
| [Low-48] | Avoid mutating function parameters | 10 |
| [Low-49] | Create methods are suspicious of the reorg attack | 1 |
| [Low-50] | Missing contract-existence checks before low-level calls | 3 |
| [Low-51] | No limits when setting price amounts | 1 |
| [Low-52] | Constructors missing validation | 2 |
| [Low-53] | Inconsistent use of _msgSender() and msg.sender in contract | 2 |
| [Low-54] | Division in comparison | 5 |
| [Low-55] | Contract contains payable functions but no withdraw/sweep function | 4 |
| [Low-56] | State variables not capped at reasonable values | 2 |
| [Low-57] | Use forceApprove in place of approve | 1 |
| [Low-58] | Lack of support for rebasing tokens | 4 |
| [Low-59] | Constructor doesn't set initial owner | 1 |
| [Low-60] | Functions calling contracts/addresses with transfer hooks are missing reentrancy guards | 14 |
| [Low-61] | Solidity version 0.8.20 won't work on all chains due to PUSH0 | 3 |
| [Low-62] | Bps variable not checked that they are below 1e4 | 7 |
| [Low-63] | Missing events in functions that are either setters, privileged or voting related | 22 |
| [Low-64] | Unsafe use of transfer()/transferFrom() with IERC20 | 1 |
| [Low-65] | Avoid floating pragma in non interface/library files | 9 |
| [Low-66] | Read only reentrancy risk detected | 20 |
| [Low-67] | Common tokens such as `WETH9` work differently on chains such a `Blast` which isn't taken into account during transfer calls. | 3 |
| [Low-68] | Function with `bool` return is called within another function without capturing or checking it's `bool` return value to verify success | 1 |
| [Low-69] | Function which utilizes Solady's `SafeTransferLib` fails to first check if a token exists before making `safeTransfer`/`safeTransferFrom` calls against it | 18 |
| [Low-70] | Deposit mechanism can be DOS'd with dust deposits due to lack of minAmount checks against deposit amount | 2 |
# Summary for NonCritical findings

| Number | Details | Instances |
|----------|----------|----------|
| [NonCritical-1] | Subtraction may underflow if multiplication is too large  | 2 |
| [NonCritical-2] | Using abi.encodePacked can result in hash collision when used in hashing functions  | 7 |
| [NonCritical-3] | Unchecked blocks with subtractions may underflow  | 2 |
| [NonCritical-4] | Getting a bool return value does not confirm the existence of a function in an external call  | 3 |
| [NonCritical-5] | Address function parameter is compared against a state variable. This check can be bypassed for tokens with multiple addresses (proxy tokens) | 4 |
| [NonCritical-6] | Contract's `initialization` function can fail due to out of GAS error on certain chains due to iteration which can prevent accurate intended deployment | 1 |
| [NonCritical-7] | Floating pragma should be avoided | 3 |
| [NonCritical-8] | Require statements should have error string | 2 |
| [NonCritical-9] | In functions which accept an address as a parameter, there should be a zero address check to prevent bugs | 37 |
| [NonCritical-10] | Enum values should be used in place of constant array indexes | 1 |
| [NonCritical-11] | Use safeTransferOwnership instead of transferOwnership | 2 |
| [NonCritical-12] | Default int values are manually set | 15 |
| [NonCritical-13] | Ownable2Step should be used in place of Ownable | 4 |
| [NonCritical-14] | Revert statements within external and public functions can be used to perform DOS attacks | 6 |
| [NonCritical-15] | Functions which are either private or internal should have a preceding _ in their name | 79 |
| [NonCritical-16] | Private and internal state variables should have a preceding _ in their name unless they are constants | 30 |
| [NonCritical-17] | Contract lines should not be longer than 120 characters for readability | 19 |
| [NonCritical-18] | Avoid updating storage when the value hasn't changed | 4 |
| [NonCritical-19] | Old Solidity version | 2 |
| [NonCritical-20] | Not all event definitions are utilizing indexed variables. | 1 |
| [NonCritical-21] | Explicitly define visibility of state variables to prevent misconceptions on what can access the variable | 16 |
| [NonCritical-22] | Contracts should have all public/external functions exposed by interfaces | 67 |
| [NonCritical-23] | Functions within contracts are not ordered according to the solidity style guide | 5 |
| [NonCritical-24] | Double type casts create complexity within the code | 13 |
| [NonCritical-25] | Emits without msg.sender parameter | 1 |
| [NonCritical-26] | A function which defines named returns in it's declaration doesn't need to use return | 7 |
| [NonCritical-27] | Constants should be on the left side of the comparison | 39 |
| [NonCritical-28] | Defined named returns not used within function  | 1 |
| [NonCritical-29] | Initialize functions do not emit an event | 5 |
| [NonCritical-30] | Both immutable and constant state variables should be CONSTANT_CASE | 3 |
| [NonCritical-31] | Overly complicated arithmetic | 19 |
| [NonCritical-32] | Using zero as a parameter | 8 |
| [NonCritical-33] | Use of non-named numeric constants | 71 |
| [NonCritical-34] | Long powers of ten should use scientific notation 1eX | 21 |
| [NonCritical-35] | Redundant else statement | 7 |
| [NonCritical-36] | Use immutable not constant for keccak state variables | 4 |
| [NonCritical-37] | Two or more functions contain the exact same code | 1 |
| [NonCritical-38] | Empty bytes check is missing | 11 |
| [NonCritical-39] | Use max instead of 0xfff... | 5 |
| [NonCritical-40] | Return bool not explicit | 1 |
| [NonCritical-41] | Assembly block creates dirty bits | 2 |
| [NonCritical-42] | call bypasses function existence check, type checking and argument packing | 2 |
| [NonCritical-43] | Cyclomatic complexity in functions | 27 |
| [NonCritical-44] | Incorrect withdraw declaration | 1 |
| [NonCritical-45] | Contract does not follow the Solidity style guide's suggested layout ordering | 1 |
| [NonCritical-46] | Don't only depend on Solidity's arithmetic ordering. | 4 |
| [NonCritical-47] | A event should be emitted if a non immutable state variable is set in a constructor | 2 |
| [NonCritical-48] | Non constant/immutable state variables are missing a setter post deployment | 2 |
| [NonCritical-49] | Addition/multiplication in unchecked block is unsafe | 5 |
| [NonCritical-50] | Long numbers should include underscores to improve readability and prevent typos | 43 |
| [NonCritical-51] | Use 'using' keyword when using specific imports rather than calling the specific import directly | 161 |
| [NonCritical-52] | Inconsistent checks of address params against address(0) | 6 |
| [NonCritical-53] | Constructors should emit an event | 3 |
| [NonCritical-54] | Contract and Abstract files should have a fixed compiler version | 12 |
| [NonCritical-55] | Function call in event emit | 7 |
| [NonCritical-56] | int/uint passed into abi.encodePacked without casting to a string. | 1 |
| [NonCritical-57] | For loop iterates on arrays not indexed | 7 |
| [NonCritical-58] | Constructor with array/string/bytes parameters has no empty array checks | 1 |
| [NonCritical-59] | Errors should have parameters | 65 |
| [NonCritical-60] | Avoid using 'owner' or '_owner' as a parameter name | 5 |
| [NonCritical-61] | Avoid arithmetic directly within array indices | 6 |
| [NonCritical-62] | Memory-safe annotation missing | 40 |
| [NonCritical-63] | Constant state variables defined more than once | 4 |
| [NonCritical-64] | Pure function accesses storage | 13 |
| [NonCritical-65] | Unnecessary struct attribute prefix | 3 |
| [NonCritical-66] | Redundant function returns constant | 1 |
| [NonCritical-67] | ERC777 tokens can introduce reentrancy risks | 3 |
| [NonCritical-68] | Avoid assembly in `view` or `pure` functions | 74 |
| [NonCritical-69] | It is best practise to initialize a local variable when they are defined | 16 |
| [NonCritical-70] | Contract calls `disableInitializers` in it's constructor but also contains a initialization function which utilizes the `initializer` modifier. | 15 |
# Summary for Gas findings

| Number | Details | Instances | Gas |
|----------|----------|----------|----------|
| [Gas-1] | State variables used within a function more than once should be cached to save gas  | 6 | 3600 |
| [Gas-2] | The result of a function call should be cached rather than re-calling the function  | 4 | 1600 |
| [Gas-3] | Avoid updating storage when the value hasn't changed  | 7 | 39200 |
| [Gas-4] | Multiple accesses of the same mapping/array key/index should be cached  | 3 | 378 |
| [Gas-5] | Shortcircuit rules can be be used to optimize some gas usage  | 6 | 75600 |
| [Gas-6] | x + y is more efficient than using += for state variables (likewise for -=) | 6 | 180 |
| [Gas-7] | Public functions not used internally can be marked as external to save gas | 10 | 0.0 |
| [Gas-8] | Calldata should be used in place of memory function parameters when not mutated | 3 | 117 |
| [Gas-9] | Usage of smaller uint/int types causes overhead | 171 | 1608255 |
| [Gas-10] | Use != 0 instead of > 0 | 27 | 2187 |
| [Gas-11] | Default bool values are manually reset | 1 | 0.0 |
| [Gas-12] | Default int values are manually reset | 9 | 0.0 |
| [Gas-13] | Function calls within for loops | 21 | 0.0 |
| [Gas-14] | For loops in public or external functions should be avoided due to high gas costs and possible DOS | 15 | 0.0 |
| [Gas-15] | Mappings used within a function more than once should be cached to save gas | 1 | 100 |
| [Gas-16] | Use assembly to check for the zero address | 12 | 0.0 |
| [Gas-17] | Some error strings are not descriptive | 43 | 0.0 |
| [Gas-18] | Can transfer 0 | 1 | 0.0 |
| [Gas-19] | State variables which are not modified within functions should be set as constants or immutable for values set at deployment | 1 | 0.0 |
| [Gas-20] | Divisions of powers of 2 can be replaced by a right shift operation to save gas | 2 | 0.0 |
| [Gas-21] | multiplications of powers of 2 can be replaced by a left shift operation to save gas | 1 | 0.0 |
| [Gas-22] | Structs can be packed into fewer storage slots | 7 | 122500 |
| [Gas-23] | Don't use _msgSender() if not supporting EIP-2771 | 37 | 21904 |
| [Gas-24] | Superfluous event fields | 1 | 34 |
| [Gas-25] | Use assembly to emit events | 23 | 20102 |
| [Gas-26] | Use assembly in place of abi.decode to extract calldata values more efficiently | 1 | 0.0 |
| [Gas-27] | Struct variables can be packed into fewer storage slots by truncating timestamp bytes | 4 | 40000 |
| [Gas-28] | Mark Functions That Revert For Normal Users As payable | 16 | 6400 |
| [Gas-29] | Lack of unchecked in loops | 31 | 63240 |
| [Gas-30] | Where a value is casted more than once, consider caching the result to save gas | 10 | 0.0 |
| [Gas-31] | Assembly let var only used on once | 2 | 0.0 |
| [Gas-32] | Assembly let var never used | 2 | 0.0 |
| [Gas-33] | Use assembly to validate msg.sender | 3 | 0.0 |
| [Gas-34] | Simple checks for zero uint can be done using assembly to save gas | 3 | 54 |
| [Gas-35] | Using nested if to save gas | 45 | 12150 |
| [Gas-36] | Using delete instead of setting mapping to 0 saves gas | 1 | 5 |
| [Gas-37] | Stack variable cost less than state variables while used in emiting event | 5 | 225 |
| [Gas-38] | Low level call can be optimized with assembly | 4 | 3968 |
| [Gas-39] | Using constants directly, rather than caching the value, saves gas | 2 | 0.0 |
| [Gas-40] | Inline modifiers used only once | 2 | 0.0 |
| [Gas-41] | Solidity versions 0.8.19 and above are more gas efficient | 2 | 4000 |
| [Gas-42] | Calling .length in a for loop wastes gas | 30 | 93120 |
| [Gas-43] | Internal functions only used once can be inlined to save gas | 19 | 10830 |
| [Gas-44] | Constructors can be marked as payable to save deployment gas | 3 | 0.0 |
| [Gas-45] | View function called more than once in iteration | 5 | 0.0 |
| [Gas-46] | Internal functions never used once can be removed | 50 | 0.0 |
| [Gas-47] | There are comparisons to boolean literals (true and false), these can be simplified to save gas | 1 | 18 |
| [Gas-48] | Use OZ Array.unsafeAccess() to avoid repeated array length checks | 26 | 1419600 |
| [Gas-49] | State variable written in a loop | 4 | 92704 |
| [Gas-50] | State variable read in a loop | 15 | 1390560 |
| [Gas-51] | Use uint256(1)/uint256(2) instead of true/false to save gas for changes | 5 | 425000 |
| [Gas-52] | Call msg.XYZ directly rather than caching the value to save gas | 1 | 0.0 |
| [Gas-53] | Consider pre-calculating the address of address(this) to save gas | 13 | 0.0 |
| [Gas-54] | Use 'storage' instead of 'memory' for struct/array state variables | 4 | 33600 |
| [Gas-55] | Empty blocks should be removed or emit something | 1 | 0.0 |
| [Gas-56] | Use constants instead of type(uint<n>).max | 43 | 0.0 |
| [Gas-57] | Using named returns for pure and view functions is cheaper than using regular returns | 62 | 99944 |
| [Gas-58] | It is redundant to compare msg.sender against address(0) | 7 | 0.0 |
## [High-1] msg.sender used in implementation of a ERC2771 relay contract

### Resolution 
ERC2771 is designed to allow presigned transaction to be executed, as such _msgSender() must be used in place of msg.sender. This is because _msgSender() looks at the transaction signer rather than the transaction sender. For example a user may presign a transaction with address A but submit the transaction with address B, in a relay implementation you'd want address A to be treated as the sender, not address B, failing to use _msgSender() will make this not the case.

Num of instances: 2

### Findings 


<details><summary>Click to show findings</summary>

['[17](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L17-L165)']
```solidity
17: contract MarginAccount is IMarginAccount, ERC2771Context, Ownable, Initializable, UUPSUpgradeable {
18:     using SafeTransferLib for address;
19: 
61:         require(msg.sender == routerContractAddress, MarginAccountErrors.OnlyRouterAllowed()); // <= FOUND


105:         require(verifiedMarket[msg.sender], MarginAccountErrors.OnlyVerifiedMarketsAllowed()); // <= FOUND


119:         require(verifiedMarket[msg.sender], MarginAccountErrors.OnlyVerifiedMarketsAllowed()); // <= FOUND


137:         require(verifiedMarket[msg.sender], MarginAccountErrors.OnlyVerifiedMarketsAllowed()); // <= FOUND


165:         require(verifiedMarket[msg.sender], MarginAccountErrors.OnlyVerifiedMarketsAllowed()); // <= FOUND


```
['[20](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L20-L1063)']
```solidity
20: contract OrderBook is Initializable, UUPSUpgradeable, ERC2771Context, AbstractAMM {
21:     OrderBookType orderBookType;
22:     address owner;
134:         require(msg.sender == owner, OrderBookErrors.Unauthorized()); // <= FOUND


738:         if (_type == OrderBookType.NATIVE_IN_QUOTE && !_isMargin && (msg.sender != address(0))) { // <= FOUND


745:         } else if (msg.sender != address(0)) { // <= FOUND


756:         if (msg.sender == address(0)) { // <= FOUND


794:         if (_type == OrderBookType.NATIVE_IN_BASE && !_isMargin && (msg.sender != address(0))) { // <= FOUND


797:         } else if (msg.sender != address(0)) { // <= FOUND


808:         if (msg.sender == address(0)) { // <= FOUND


976:             if (sizeToCreditViaVault > 0 && msg.sender != address(0)) { // <= FOUND


988:             if (msg.sender != address(0)) { // <= FOUND


1051:             if (quoteCreditVaultTaker > 0 && msg.sender != address(0)) { // <= FOUND


1063:             if (msg.sender != address(0)) { // <= FOUND


```


</details>

## [Medium-1] Privileged functions can create points of failure

### Resolution 
Ensure such accounts are protected and consider implementing multi sig to prevent a single point of failure

Num of instances: 18

### Findings 


<details><summary>Click to show findings</summary>

['[105](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruForwarder.sol#L105-L105)']
```solidity
105:     function setAllowedInterfaces(bytes4[] memory _allowedInterfaces) external onlyOwner  // <= FOUND
```
['[111](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruForwarder.sol#L111-L111)']
```solidity
111:     function removeAllowedInterfaces(bytes4[] memory _allowedInterfaces) external onlyOwner  // <= FOUND
```
['[38](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L38-L38)']
```solidity
38:     function toggleProtocolState(bool _state) external onlyOwner  // <= FOUND
```
['[44](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L44-L44)']
```solidity
44:     function setFeeCollector(address _feeCollector) external onlyOwner  // <= FOUND
```
['[105](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/periphery/MonadDeployer.sol#L105-L105)']
```solidity
105:     function setKuruAmmSpread(uint96 _kuruAmmSpread) external onlyOwner  // <= FOUND
```
['[109](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/periphery/MonadDeployer.sol#L109-L109)']
```solidity
109:     function setKuruCollective(address _kuruCollective) external onlyOwner  // <= FOUND
```
['[113](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/periphery/MonadDeployer.sol#L113-L113)']
```solidity
113:     function setKuruCollectiveFee(uint256 _kuruCollectiveFee) external onlyOwner  // <= FOUND
```
['[250](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L250-L250)']
```solidity
250:     function upgradeOrderBookImplementation(address newImplementation) external onlyOwner  // <= FOUND
```
['[260](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L260-L260)']
```solidity
260:     function upgradeVaultImplementation(address newImplementation) external onlyOwner  // <= FOUND
```
['[271](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L271-L271)']
```solidity
271:     function toggleMarkets(address[] memory markets, IOrderBook.MarketState state) external onlyOwner  // <= FOUND
```
['[281](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L281-L281)']
```solidity
281:     function upgradeMultipleOrderBookProxies(address[] memory proxies, bytes[] memory data) public onlyOwner  // <= FOUND
```
['[287](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L287-L287)']
```solidity
287:     function upgradeMultipleVaultProxies(address[] memory proxies, bytes[] memory data) public onlyOwner  // <= FOUND
```
['[298](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L298-L298)']
```solidity
298:     function transferOwnershipForContracts(address[] memory contracts, address _newOwner) external onlyOwner  // <= FOUND
```
['[84](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L84-L85)']
```solidity
84:     function transferOwnership(address _newOwner) external {
85:         _checkOwner(); // <= FOUND
86:         owner = _newOwner;
87:     }
```
['[56](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L56-L57)']
```solidity
56:     function _authorizeUpgrade(address) internal view override {
57:         _checkOwner(); // <= FOUND
58:     }
```
['[147](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L147-L148)']
```solidity
147:     function toggleMarket(MarketState _state) external {
148:         _checkOwner(); // <= FOUND
149:         require(_state != marketState, OrderBookErrors.MarketStateError());
150:         marketState = _state;
151:         emit MarketStateUpdated(marketState, _state);
152:     }
```
['[56](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L56-L57)']
```solidity
56:     function _authorizeUpgrade(address) internal view override {
57:         _checkOwner(); // <= FOUND
58:     }
```
['[147](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L147-L148)']
```solidity
147:     function toggleMarket(MarketState _state) external {
148:         _checkOwner(); // <= FOUND
149:         require(_state != marketState, OrderBookErrors.MarketStateError());
150:         marketState = _state;
151:         emit MarketStateUpdated(marketState, _state);
152:     }
```


</details>

## [Medium-2] Contract can accept funds with no way of extracting them

### Resolution 
Contracts with payable functions can accumulate Ether over time. If there's no method to withdraw these funds, they can remain trapped in the contract indefinitely, resulting in lost resources and a potential financial loss. To resolve this, a secure withdraw function should be implemented. It's recommended to limit access to this function, typically to the contract's owner or a specific set of trusted addresses. Also, to prevent re-entrancy attacks, the Checks-Effects-Interactions (CEI) pattern should be followed where state changes (effect) occur before external calls (interactions).

Num of instances: 1

### Findings 


<details><summary>Click to show findings</summary>

['[17](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L17-L17)']
```solidity
17: contract MarginAccount is IMarginAccount, ERC2771Context, Ownable, Initializable, UUPSUpgradeable 
```


</details>

## [Medium-3] Withdraw/Redeem functions can fail due to blocked USDT/USDC accounts

### Resolution 
Withdraw and redeem functions in smart contracts can fail if they involve transferring USDT, USDC, or other centralized stablecoins from blocked or blacklisted accounts. Both Tether (USDT) and USD Coin (USDC) are issued by centralized entities with the authority to freeze or blacklist addresses. When an account is blacklisted, any attempts to transfer these tokens from the blacklisted address will be blocked, causing the transaction to fail.

This issue can significantly impact decentralized finance (DeFi) protocols, which rely on seamless token transfers for operations like withdrawals and redemptions. If a user's address or the contract itself gets blacklisted, users may be unable to withdraw their funds, leading to a loss of trust and potentially severe financial consequences.

A potential way to fix this issue is to allow users to specify an alternative address for the transfer to go to. However, the contract must still validate that the withdrawal amount is correctly debited from the msg.sender's balance to prevent any unauthorized transfers. This ensures that users cannot steal other users' assets by specifying different addresses.

Num of instances: 2

### Findings 


<details><summary>Click to show findings</summary>

['[177](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L177-L186)']
```solidity
177:     function batchWithdrawMaxTokens(address[] calldata _tokens) external protocolActive {
178:         uint256 _balance;
179:         for (uint256 i = 0; i < _tokens.length; i++) {
180:             _balance = balances[_accountKey(_msgSender(), _tokens[i])];
181:             balances[_accountKey(_msgSender(), _tokens[i])] = 0;
182:             if (_balance > 0) {
183:                 if (_tokens[i] == NATIVE) {
184:                     _msgSender().safeTransferETH(_balance); // <= FOUND
185:                 } else {
186:                     _tokens[i].safeTransfer(_msgSender(), _balance); // <= FOUND
187:                 }
188:             }
189:         }
190:     }
```
['[217](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L217-L223)']
```solidity
217:     function withdraw(uint256 _amount, address _token) external protocolActive {
218:         require(_amount <= balances[_accountKey(_msgSender(), _token)], MarginAccountErrors.InsufficientBalance());
219:         balances[_accountKey(_msgSender(), _token)] -= _amount;
220:         if (_token == NATIVE) {
221:             _msgSender().safeTransferETH(_amount); // <= FOUND
222:         } else {
223:             _token.safeTransfer(_msgSender(), _amount); // <= FOUND
224:         }
225: 
226:         emit Withdrawal(_msgSender(), _token, _amount);
227:     }
```


</details>

## [Medium-4] `symbol()` call against arbitrary `ERC20` token can revert as not all `ERC20` tokens store their `symbol` state variable as a `string` as stated in the `ERC20` specification such as `MKR` token token which stores it as a bytes32 state variable

### Resolution 
The name() and symbol() functions are not consistently implemented across all tokens, and calling them on arbitrary tokens can lead to unexpected behavior or reverts. While most ERC-20 tokens adhere to the standard where these functions return string values, some tokens, such as MKR, deviate from this standard by encoding metadata fields like name and symbol as bytes32 instead of string. This mismatch can cause issues when attempting to consume metadata, as contracts expecting string outputs may fail to decode the bytes32 values, leading to reverts or incorrect data handling.

Num of instances: 1

### Findings 


<details><summary>Click to show findings</summary>

['[45](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L45-L71)']
```solidity
45:     function initialize( // <= FOUND
46:         address _owner,
47:         address token1_,
48:         address token2_,
49:         address _marginAccount,
50:         address _market,
51:         uint96 _spreadConstant
52:     ) public initializer {
53:         owner = _owner;
54:         token1 = token1_;
55:         token1Decimals = token1_ != address(0) ? ERC20(token1_).decimals() : 18;
56:         token2 = token2_;
57:         token2Decimals = token2_ != address(0) ? ERC20(token2_).decimals() : 18;
58:         marginAccount = IMarginAccount(_marginAccount);
59:         market = IOrderBook(_market);
60:         SPREAD_CONSTANT = _spreadConstant;
61:         setMarketParams();
62:         if (token1_ != address(0)) {
63:             token1_.safeApprove(_marginAccount, type(uint256).max);
64:         }
65:         if (token2_ != address(0)) {
66:             token2_.safeApprove(_marginAccount, type(uint256).max);
67:         }
68:         string memory token1Symbol;
69:         string memory token2Symbol;
70:         if (token1_ != address(0)) {
71:             token1Symbol = ERC20(token1_).symbol(); // <= FOUND
72:         } else {
73:             token1Symbol = "MON";
74:         }
75:         if (token2_ != address(0)) {
76:             token2Symbol = ERC20(token2_).symbol();
77:         } else {
78:             token2Symbol = "MON";
79:         }
80:         _name = string.concat(token1Symbol, "-", token2Symbol, "-", "KURU-AMM-VAULT");
81:     }
```


</details>

## [Medium-5] Transfer flow from `msg.sender` to protocol favours msg sender by its `amount` value rounding down when it should round up to prevent exploitation

### Resolution 
Transfer logic that calculates the amount deducted from msg.sender using rounding down (e.g. via integer division) can introduce unintended advantages for the sender. This is particularly problematic in fee or reward calculations where precision is critical. Rounding down favors the sender by potentially underpaying or avoiding marginal amounts, which can accumulate over many transactions and be exploited. Instead, the calculation should round up to ensure the full value owed is captured. Using safe mathematical utilities like mulDivUp or explicitly checking for remainders before rounding can help mitigate this. Failure to address this can lead to economic imbalances or protocol loss over time.

Num of instances: 4

### Findings 


<details><summary>Click to show findings</summary>

['[728](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L728-L728)']
```solidity
728:     function placeAndExecuteMarketBuy(uint96 _quoteSize, uint256 _minAmountOut, bool _isMargin, bool _isFillOrKill)
729:         public
730:         payable
731:         override
732:         marketActive
733:         nonReentrant
734:         returns (uint256)
735:     {
736:         OrderBookType _type = orderBookType;
737: 
738:         if (_type == OrderBookType.NATIVE_IN_QUOTE && !_isMargin && (msg.sender != address(0))) {
739:             require(
740:                 msg.value >= _pricePrecisionToQuoteAssetPrecision(_quoteSize), OrderBookErrors.NativeAssetInsufficient()
741:             );
742:             require(
743:                 msg.value < _pricePrecisionToQuoteAssetPrecision(_quoteSize + 1), OrderBookErrors.NativeAssetSurplus()
744:             );
745:         } else if (msg.sender != address(0)) {
746:             require(msg.value == 0, OrderBookErrors.NativeAssetNotRequired());
747:             _isMargin
748:                 ? marginAccount.debitUser(_msgSender(), quoteAsset, _pricePrecisionToQuoteAssetPrecision(_quoteSize))
749:                 : quoteAsset.safeTransferFrom(
750:                     _msgSender(), address(marginAccount), _pricePrecisionToQuoteAssetPrecision(_quoteSize)
751:                 );
752:         }
753: 
754:         uint256 _baseTokensCredited;
755:         (_quoteSize, _baseTokensCredited) = _marketBuyMatch(_quoteSize, _isMargin);
756:         if (msg.sender == address(0)) {
757:             return _baseTokensCredited;
758:         }
759:         if (_quoteSize > 0) {
760:             require(!_isFillOrKill, OrderBookErrors.InsufficientLiquidity());
761:             if (_type == OrderBookType.NATIVE_IN_QUOTE && !_isMargin) {
762:                 
763:                 uint256 _refund = _pricePrecisionToQuoteAssetPrecision(_quoteSize);
764:                 _handleNativeMarketRefundTransfer(_refund);
765:             } else {
766:                 marginAccount.creditUser(
767:                     _msgSender(), quoteAsset, _pricePrecisionToQuoteAssetPrecision(_quoteSize), _isMargin
768:                 );
769:             }
770:         } else if (_type == OrderBookType.NATIVE_IN_QUOTE) {
771:             address(marginAccount).safeTransferETH(msg.value);
772:         }
773:         require(_baseTokensCredited >= _minAmountOut, OrderBookErrors.SlippageExceeded());
774: 
775:         return _baseTokensCredited;
776:     }
```
['[331](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L331-L331)']
```solidity
331:     function anyToAnySwap(
332:         address[] calldata _marketAddresses,
333:         bool[] calldata _isBuy,
334:         bool[] calldata _nativeSend,
335:         address _debitToken,
336:         address _creditToken,
337:         uint256 _amount,
338:         uint256 _minAmountOut
339:     ) external payable returns (uint256 _amountOut) {
340:         require(_marketAddresses.length >= 1, RouterErrors.NoMarketsPassed());
341:         require(_isBuy.length == _marketAddresses.length, RouterErrors.LengthMismatch());
342:         require(_nativeSend.length == _marketAddresses.length, RouterErrors.LengthMismatch());
343:         if (_nativeSend[0] == false) {
344:             _debitToken.safeTransferFrom(msg.sender, address(this), _amount);
345:         }
346:         uint256 _cachedAmountIn = _amount;
347: 
348:         for (uint256 i = 0; i < _marketAddresses.length; i++) {
349:             address _currentMarket = _marketAddresses[i];
350:             MarketParams memory _marketParams = verifiedMarket[_currentMarket];
351:             require(_marketParams.pricePrecision > 0, RouterErrors.InvalidMarket());
352:             IOrderBook market = IOrderBook(_currentMarket);
353:             uint256 _value = _nativeSend[i] ? _amount : 0;
354:             _amountOut = _isBuy[i]
355:                 ? (
356:                     market.placeAndExecuteMarketBuy{value: _value}(
357:                         toU96(_amount * _marketParams.pricePrecision / 10 ** _marketParams.quoteAssetDecimals),
358:                         0,
359:                         false,
360:                         true
361:                     )
362:                 )
363:                 : market.placeAndExecuteMarketSell{value: _value}(
364:                     toU96(_amount * _marketParams.sizePrecision / 10 ** _marketParams.baseAssetDecimals), 0, false, true
365:                 );
366: 
367:             _amount = _amountOut;
368:         }
369:         require(_amountOut >= _minAmountOut, RouterErrors.SlippageExceeded());
370:         emit KuruRouterSwap(msg.sender, _debitToken, _creditToken, _cachedAmountIn, _amountOut);
371:         if (_creditToken != address(0)) {
372:             _creditToken.safeTransfer(msg.sender, _amountOut);
373:         } else {
374:             msg.sender.safeTransferETH(_amountOut);
375:         }
376:     }
```
['[156](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L156-L156)']
```solidity
156:     function deposit(uint256 baseDeposit, uint256 quoteDeposit, address receiver) // <= FOUND
157:         public
158:         payable
159:         nonReentrant
160:         returns (uint256)
161:     {
162:         require(
163:             (token1 == address(0) || token2 == address(0))
164:                 ? msg.value >= (token1 == address(0) ? baseDeposit : quoteDeposit)
165:                 : msg.value == 0,
166:             KuruAMMVaultErrors.NativeAssetMismatch()
167:         );
168: 
169:         return _mintAndDeposit(baseDeposit, quoteDeposit, receiver);
170:     }
```
['[175](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L175-L175)']
```solidity
175:     function _mintAndDeposit(uint256 baseDeposit, uint256 quoteDeposit, address receiver) internal returns (uint256) {
176:         (uint256 _baseAmount, uint256 _currentAskPrice) = _returnNormalizedAmountAndPrice(true);
177:         uint256 _shares;
178:         if (totalSupply() != 0) {
179:             uint256 _expectedQuoteAmount = (
180:                 (
181:                     FixedPointMathLib.mulDivUp(baseDeposit, _currentAskPrice, vaultPricePrecision)
182:                         * 10 ** marketParams.quoteAssetDecimals
183:                 )
184:             ) / 10 ** marketParams.baseAssetDecimals;
185:             require(_expectedQuoteAmount <= quoteDeposit, KuruAMMVaultErrors.InsufficientQuoteToken());
186:             _shares = _convertToShares(baseDeposit, _expectedQuoteAmount, _currentAskPrice);
187:             quoteDeposit = _expectedQuoteAmount;
188:             _mint(receiver, _shares);
189:         } else {
190:             _shares = FixedPointMathLib.sqrt(baseDeposit * quoteDeposit);
191:             _mint(address(marginAccount), MIN_LIQUIDITY);
192:             _shares -= MIN_LIQUIDITY;
193:             _mint(receiver, _shares);
194:             _currentAskPrice = (
195:                 ((quoteDeposit * 10 ** marketParams.baseAssetDecimals)) * vaultPricePrecision
196:                     / 10 ** marketParams.quoteAssetDecimals
197:             ) / (baseDeposit);
198:         }
199:         require(_shares > 0, KuruAMMVaultErrors.InsufficientLiquidityMinted());
200:         (uint96 _newAskSize, uint96 _newBidSize) = _getVaultSizesForBaseAmount(_baseAmount + baseDeposit);
201:         market.updateVaultOrdSz(
202:             _newAskSize,
203:             _newBidSize,
204:             _currentAskPrice,
205:             FixedPointMathLib.mulDivRound(_currentAskPrice, BPS_MULTIPLIER, BPS_MULTIPLIER + SPREAD_CONSTANT),
206:             false
207:         );
208:         address _token1 = token1;
209:         address _token2 = token2;
210:         _depositAmountsToMarginAccount(_token1, _token2, baseDeposit, quoteDeposit);
211:         uint256 _nativeRefund =
212:             _token1 == address(0) ? (msg.value - baseDeposit) : (_token2 == address(0) ? (msg.value - quoteDeposit) : 0);
213:         if (_nativeRefund > 0) {
214:             msg.sender.safeTransferETH(_nativeRefund);
215:         }
216:         emit KuruVaultDeposit(baseDeposit, quoteDeposit, _shares, receiver);
217:         return _shares;
218:     }
```


</details>

## [Medium-6] Vault fees state variables can be modified post deployment which goes against the OZ `ERC4626Fees` implementation and can result in loss of fund for users who have already deposited

Num of instances: 1

### Findings 


<details><summary>Click to show findings</summary>

['[113](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/periphery/MonadDeployer.sol#L113-L114)']
```solidity
113:     function setKuruCollectiveFee(uint256 _kuruCollectiveFee) external onlyOwner {
114:         kuruCollectiveFee = _kuruCollectiveFee; // <= FOUND
115:     }
```


</details>

## [Low-1] Potential division by zero should have zero checks in place 

### Resolution 
Implement a zero address check for found instances

Num of instances: 5

### Findings 


<details><summary>Click to show findings</summary>

['[531](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L531-L569)']
```solidity
531:     function _executeCancel(uint40 _orderId, Order memory _order) internal { // <= FOUND
532:         
533:         if (_order.prev != OrderLinkedList.NULL) {
534:             s_orders[_order.prev].next = _order.next;
535:         }
536:         if (_order.next != OrderLinkedList.NULL) {
537:             s_orders[_order.next].prev = _order.prev;
538:         }
539: 
540:         if (_order.isBuy) {
541:             
542:             if (_orderId == s_buyPricePoints[_order.price].head) {
543:                 OrderLinkedList.updateHead(s_buyPricePoints[_order.price], _order.next);
544:                 if (_order.next == OrderLinkedList.NULL) {
545:                     
546:                     TreeMath.remove(s_buyTree, _order.price);
547:                 }
548:             } else {
549:                 OrderLinkedList.adjustForTail(s_buyPricePoints[_order.price], _order.prev, _order.next);
550:             }
551: 
552:             marginAccount.creditUser( // <= FOUND
553:                 _order.ownerAddress,
554:                 quoteAsset,
555:                 (((toU96((_order.size * _order.price) / sizePrecision) * quoteDecimalMultiplier) / pricePrecision)),
556:                 true
557:             );
558:         } else {
559:             if (_orderId == s_sellPricePoints[_order.price].head) {
560:                 OrderLinkedList.updateHead(s_sellPricePoints[_order.price], _order.next);
561:                 if (_order.next == OrderLinkedList.NULL) {
562:                     
563:                     TreeMath.remove(s_sellTree, _order.price);
564:                 }
565:             } else {
566:                 OrderLinkedList.adjustForTail(s_sellPricePoints[_order.price], _order.prev, _order.next);
567:             }
568: 
569:             marginAccount.creditUser( // <= FOUND
570:                 _order.ownerAddress, baseAsset, ((_order.size * baseDecimalMultiplier) / sizePrecision), true
571:             );
572:         }
573: 
574:         emit OrderCanceled(_orderId, _order.ownerAddress, _order.price, _order.size, _order.isBuy);
575:     }
```
['[835](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L835-L836)']
```solidity
835:     function _pricePrecisionToQuoteAssetPrecision(uint96 _quote) internal view returns (uint256) { // <= FOUND
836:         return (uint256(_quote) * quoteDecimalMultiplier) / pricePrecision; // <= FOUND
837:     }
```
['[839](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L839-L840)']
```solidity
839:     function _sizePrecisionToBaseAssetPrecision(uint96 _size) internal view returns (uint256) { // <= FOUND
840:         return (uint256(_size) * baseDecimalMultiplier) / sizePrecision; // <= FOUND
841:     }
```
['[1269](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L1269-L1270)']
```solidity
1269:     function _quoteAmountRoundedDown(uint256 _size, uint32 _price) internal view returns (uint256) { // <= FOUND
1270:         return ((_price * _size) / sizePrecision) * quoteDecimalMultiplier / pricePrecision; // <= FOUND
1271:     }
```
['[1345](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L1345-L1348)']
```solidity
1345:     function _getOBBid() internal view returns (uint256) { // <= FOUND
1346:         uint32 firstRight = TreeMath.findFirstRight(s_buyTree, type(uint32).max);
1347:         if (firstRight != type(uint32).max) {
1348:             return firstRight * vaultPricePrecision / pricePrecision; // <= FOUND
1349:         }
1350:         return 0;
1351:     }
```


</details>

## [Low-2] Division operations should always be performed after multiplication operations 

### Resolution 
Perform multiplication operations first

Num of instances: 4

### Findings 


<details><summary>Click to show findings</summary>

['[238](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/AbstractAMM.sol#L238-L246)']
```solidity
238:     function _creditVaultOnMarketBuy(uint96 _sizeFilled, uint256 _fundsOwed) // <= FOUND
239:         internal
240:         view
241:         returns (bytes memory returnData)
242:     {
243:         returnData = abi.encode(
244:             kuruAmmVault, _getQuoteAsset(), _fundsOwed * 10 ** _getQuoteAssetDecimals() / vaultPricePrecision, true
245:         );
246:         uint256 feeRebate = // <= FOUND
247:             ((_sizeFilled * 10 ** _getBaseAssetDecimals() / _getSizePrecision()) * _getMakerFeeBps()) / BPS_MULTIPLIER;
248:         if (feeRebate > 0) {
249:             returnData = bytes.concat(returnData, abi.encode(kuruAmmVault, _getBaseAsset(), feeRebate, true));
250:         }
251:     }
```
['[259](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/AbstractAMM.sol#L259-L267)']
```solidity
259:     function _creditVaultOnMarketSell(uint96 _sizeOwedToVault, uint256 _fundsOwedToUser) // <= FOUND
260:         internal
261:         view
262:         returns (bytes memory returnData)
263:     {
264:         returnData = abi.encode(
265:             kuruAmmVault, _getBaseAsset(), _sizeOwedToVault * 10 ** _getBaseAssetDecimals() / _getSizePrecision(), true
266:         );
267:         uint256 feeRebate = ( // <= FOUND
268:             (_fundsOwedToUser * 10 ** _getQuoteAssetDecimals() / vaultPricePrecision) * _getMakerFeeBps()
269:         ) / BPS_MULTIPLIER;
270:         if (feeRebate > 0) {
271:             returnData = bytes.concat(returnData, abi.encode(kuruAmmVault, _getQuoteAsset(), feeRebate, true));
272:         }
273:     }
```
['[1238](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L1238-L1251)']
```solidity
1238:     function _creditMaker(bool _isMarketBuy, address _ownerAddress, uint96 _size, uint32 _price) // <= FOUND
1239:         internal
1240:         view
1241:         returns (bytes memory)
1242:     {
1243:         address creditAsset = _isMarketBuy ? quoteAsset : baseAsset;
1244:         uint256 amount =
1245:             _isMarketBuy ? _quoteAmountRoundedDown(_size, _price) : ((_size * baseDecimalMultiplier) / sizePrecision);
1246:         uint256 feeRebate;
1247:         address feeAsset;
1248:         bytes memory returnData;
1249:         if (_isMarketBuy) {
1250:             feeAsset = baseAsset;
1251:             feeRebate = (((_size * baseDecimalMultiplier) / sizePrecision) * makerFeeBps) / BPS_MULTIPLIER; // <= FOUND
1252:         } else {
1253:             feeAsset = quoteAsset;
1254:             feeRebate = (_quoteAmountRoundedDown(_size, _price) * makerFeeBps) / BPS_MULTIPLIER;
1255:         }
1256:         
1257:         if (feeRebate > 0) {
1258:             returnData = abi.encode(_ownerAddress, feeAsset, feeRebate, true);
1259:         }
1260: 
1261:         return bytes.concat(returnData, abi.encode(_ownerAddress, creditAsset, amount, true));
1262:     }
```
['[1269](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L1269-L1270)']
```solidity
1269:     function _quoteAmountRoundedDown(uint256 _size, uint32 _price) internal view returns (uint256) { // <= FOUND
1270:         return ((_price * _size) / sizePrecision) * quoteDecimalMultiplier / pricePrecision; // <= FOUND
1271:     }
```


</details>

## [Low-3] Function with two array parameter missing a length check 

### Resolution 
In Solidity, if two array parameters are used within a function and one of their lengths is used as the for-loop range, it's essential to have a length check. If the arrays are not the same length, you could experience out-of-bounds errors or unintended behavior. This could happen if the function tries to access an index that doesn't exist in the shorter array.

Resolution: Always validate that the lengths of both arrays are the same before entering the loop. Add a require statement at the start of the function to check that both arrays are of equal length. This helps maintain the integrity of the function and prevents potential errors due to differing array lengths. This requirement ensures the function fails early if the arrays don't match, rather than failing unpredictably or silently during execution.

Num of instances: 2

### Findings 


<details><summary>Click to show findings</summary>

['[281](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L281-L282)']
```solidity
281:     function upgradeMultipleOrderBookProxies(address[] memory proxies, bytes[] memory data) public onlyOwner {
282:         for (uint256 i = 0; i < proxies.length; i++) { // <= FOUND
283:             UUPSUpgradeable(proxies[i]).upgradeToAndCall(orderBookImplementation, data[i]);
284:         }
285:     }
```
['[287](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L287-L288)']
```solidity
287:     function upgradeMultipleVaultProxies(address[] memory proxies, bytes[] memory data) public onlyOwner {
288:         for (uint256 i = 0; i < proxies.length; i++) { // <= FOUND
289:             UUPSUpgradeable(proxies[i]).upgradeToAndCall(kuruAmmVaultImplementation, data[i]);
290:         }
291:     }
```


</details>

## [Low-4] Missing checks for address(0x0) when updating address state variables 

Num of instances: 2

### Findings 


<details><summary>Click to show findings</summary>

['[44](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L44-L44)']
```solidity
44:     function setFeeCollector(address _feeCollector) external onlyOwner {
45:         require(feeCollector != _feeCollector, MarginAccountErrors.FeeCollectorNotChanged());
46:         feeCollector = _feeCollector;
47:         emit FeeCollectorUpdated(_feeCollector);
48:     }
```
['[109](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/periphery/MonadDeployer.sol#L109-L109)']
```solidity
109:     function setKuruCollective(address _kuruCollective) external onlyOwner {
110:         kuruCollective = _kuruCollective;
111:     }
```


</details>

## [Low-5] Missing empty bytes check when assigning bytes/string state variable 

### Resolution 
In programming, especially when dealing with dynamically sized types like bytes and strings in Solidity, omitting a check for empty values when assigning to a state variable can lead to unexpected behavior or vulnerabilities. This oversight may allow zero-length or null values to be stored, which could be problematic in contexts where valid data is expected. Implementing explicit checks for empty bytes or strings before assignment ensures data integrity and can prevent potential logic errors or exploits in smart contracts. It's a crucial practice in robust smart contract development to validate data thoroughly before state modifications.

Num of instances: 1

### Findings 


<details><summary>Click to show findings</summary>

['[45](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L45-L80)']
```solidity
45:     function initialize(
46:         address _owner,
47:         address token1_,
48:         address token2_,
49:         address _marginAccount,
50:         address _market,
51:         uint96 _spreadConstant
52:     ) public initializer {
53:         owner = _owner;
54:         token1 = token1_;
55:         token1Decimals = token1_ != address(0) ? ERC20(token1_).decimals() : 18;
56:         token2 = token2_;
57:         token2Decimals = token2_ != address(0) ? ERC20(token2_).decimals() : 18;
58:         marginAccount = IMarginAccount(_marginAccount);
59:         market = IOrderBook(_market);
60:         SPREAD_CONSTANT = _spreadConstant;
61:         setMarketParams();
62:         if (token1_ != address(0)) {
63:             token1_.safeApprove(_marginAccount, type(uint256).max);
64:         }
65:         if (token2_ != address(0)) {
66:             token2_.safeApprove(_marginAccount, type(uint256).max);
67:         }
68:         string memory token1Symbol;
69:         string memory token2Symbol;
70:         if (token1_ != address(0)) {
71:             token1Symbol = ERC20(token1_).symbol();
72:         } else {
73:             token1Symbol = "MON";
74:         }
75:         if (token2_ != address(0)) {
76:             token2Symbol = ERC20(token2_).symbol();
77:         } else {
78:             token2Symbol = "MON";
79:         }
80:         _name = string.concat(token1Symbol, "-", token2Symbol, "-", "KURU-AMM-VAULT"); // <= FOUND
81:     }
```


</details>

## [Low-6] Solidity version 0.8.23 won't work on all chains due to MCOPY 

### Resolution 
Solidity version 0.8.23 introduces the MCOPY opcode, this may not be implemented on all chains and L2 thus reducing the portability and compatibility of the code. Consider using a earlier solidity version.

Num of instances: 3

### Findings 


<details><summary>Click to show findings</summary>

['[2](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L2-L2)']
```solidity
2: pragma solidity ^0.8.20; // <= FOUND
```
['[3](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/TreeMath.sol#L3-L3)']
```solidity
3: pragma solidity ^0.8.10; // <= FOUND
```
['[2](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L2-L2)']
```solidity
2: pragma solidity ^0.8.4; // <= FOUND
```


</details>

## [Low-7] Function call without checking or using it's return values 

### Resolution 
Calling a function which has returns without capturing said returns can indicate poor validation as it is standard to check function returns to ensure proper operation of the function call, especially when a bool return is involved as this is a clear indication that a silent revert may have been missed i.e the function returns false rather than reverting

Num of instances: 6

### Findings 


<details><summary>Click to show findings</summary>

['[305](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L305-L308)']
```solidity
305:     function mint(uint256 shares, address receiver) public payable returns (uint256, uint256) { // <= FOUND
306:         (uint256 baseDeposit, uint256 quoteDeposit) = previewMint(shares);
307: 
308:         deposit(baseDeposit, quoteDeposit, receiver); // <= FOUND
309: 
310:         return (baseDeposit, quoteDeposit);
311:     }
```
['[177](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L177-L184)']
```solidity
177:     function batchWithdrawMaxTokens(address[] calldata _tokens) external protocolActive { // <= FOUND
178:         uint256 _balance;
179:         for (uint256 i = 0; i < _tokens.length; i++) {
180:             _balance = balances[_accountKey(_msgSender(), _tokens[i])];
181:             balances[_accountKey(_msgSender(), _tokens[i])] = 0;
182:             if (_balance > 0) {
183:                 if (_tokens[i] == NATIVE) {
184:                     _msgSender().safeTransferETH(_balance); // <= FOUND
185:                 } else {
186:                     _tokens[i].safeTransfer(_msgSender(), _balance);
187:                 }
188:             }
189:         }
190:     }
```
['[217](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L217-L221)']
```solidity
217:     function withdraw(uint256 _amount, address _token) external protocolActive { // <= FOUND
218:         require(_amount <= balances[_accountKey(_msgSender(), _token)], MarginAccountErrors.InsufficientBalance());
219:         balances[_accountKey(_msgSender(), _token)] -= _amount;
220:         if (_token == NATIVE) {
221:             _msgSender().safeTransferETH(_amount); // <= FOUND
222:         } else {
223:             _token.safeTransfer(_msgSender(), _amount);
224:         }
225: 
226:         emit Withdrawal(_msgSender(), _token, _amount);
227:     }
```
['[465](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L465-L467)']
```solidity
465:     function batchCancelOrders(uint40[] calldata _orderIds) external marketNotHardPaused { // <= FOUND
466:         for (uint256 i = 0; i < _orderIds.length; i++) {
467:             _cancelOrder(_orderIds[i], true); // <= FOUND
468:         }
469: 
470:         emit OrdersCanceled(_orderIds, _msgSender());
471:     }
```
['[830](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L830-L832)']
```solidity
830:     function _handleNativeMarketRefundTransfer(uint256 _refund) internal { // <= FOUND
831:         address(marginAccount).safeTransferETH(msg.value - _refund);
832:         _msgSender().safeTransferETH(_refund); // <= FOUND
833:     }
```
['[331](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L331-L357)']
```solidity
331:     function anyToAnySwap( // <= FOUND
332:         address[] calldata _marketAddresses,
333:         bool[] calldata _isBuy,
334:         bool[] calldata _nativeSend,
335:         address _debitToken,
336:         address _creditToken,
337:         uint256 _amount,
338:         uint256 _minAmountOut
339:     ) external payable returns (uint256 _amountOut) {
340:         require(_marketAddresses.length >= 1, RouterErrors.NoMarketsPassed());
341:         require(_isBuy.length == _marketAddresses.length, RouterErrors.LengthMismatch());
342:         require(_nativeSend.length == _marketAddresses.length, RouterErrors.LengthMismatch());
343:         if (_nativeSend[0] == false) {
344:             _debitToken.safeTransferFrom(msg.sender, address(this), _amount);
345:         }
346:         uint256 _cachedAmountIn = _amount;
347: 
348:         for (uint256 i = 0; i < _marketAddresses.length; i++) {
349:             address _currentMarket = _marketAddresses[i];
350:             MarketParams memory _marketParams = verifiedMarket[_currentMarket];
351:             require(_marketParams.pricePrecision > 0, RouterErrors.InvalidMarket());
352:             IOrderBook market = IOrderBook(_currentMarket);
353:             uint256 _value = _nativeSend[i] ? _amount : 0;
354:             _amountOut = _isBuy[i]
355:                 ? (
356:                     market.placeAndExecuteMarketBuy{value: _value}(
357:                         toU96(_amount * _marketParams.pricePrecision / 10 ** _marketParams.quoteAssetDecimals), // <= FOUND
358:                         0,
359:                         false,
360:                         true
361:                     )
362:                 )
363:                 : market.placeAndExecuteMarketSell{value: _value}(
364:                     toU96(_amount * _marketParams.sizePrecision / 10 ** _marketParams.baseAssetDecimals), 0, false, true
365:                 );
366: 
367:             _amount = _amountOut;
368:         }
369:         require(_amountOut >= _minAmountOut, RouterErrors.SlippageExceeded());
370:         emit KuruRouterSwap(msg.sender, _debitToken, _creditToken, _cachedAmountIn, _amountOut);
371:         if (_creditToken != address(0)) {
372:             _creditToken.safeTransfer(msg.sender, _amountOut);
373:         } else {
374:             msg.sender.safeTransferETH(_amountOut);
375:         }
376:     }
```


</details>

## [Low-8] Contracts do not use their OZ upgradable counterparts 

### Resolution 
Using the upgradeable counterpart of the OpenZeppelin (OZ) library in Solidity is beneficial for creating contracts that can be updated in the future. OpenZeppelin's upgradeable contracts library is designed with proxy patterns in mind, which allow the logic of contracts to be upgraded while preserving the contract's state and address. This can be crucial for long-lived contracts where future requirements or improvements may not be fully known at the time of deployment. The upgradeable OZ contracts also include protection against a class of vulnerabilities related to initialization of storage variables in upgradeable contracts. Hence, it's a good idea to use them when developing contracts that may need to be upgraded in the future, as they provide a solid foundation for secure and upgradeable smart contracts.

Num of instances: 5

### Findings 


<details><summary>Click to show findings</summary>

['[17](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L17-L17)']
```solidity
17: contract MarginAccount is IMarginAccount, ERC2771Context, Ownable, Initializable, UUPSUpgradeable  // <= FOUND ' ERC2771Context,'
```
['[20](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L20-L20)']
```solidity
20: contract OrderBook is Initializable, UUPSUpgradeable, ERC2771Context, AbstractAMM  // <= FOUND ' ERC2771Context,'
```
['[18](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L18-L18)']
```solidity
18: contract KuruAMMVault is IKuruAMMVault, ERC20, Initializable, UUPSUpgradeable, ReentrancyGuardTransient  // <= FOUND ' ERC20,'
```
['[16](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruForwarder.sol#L16-L16)']
```solidity
16: contract KuruForwarder is EIP712, Initializable, Ownable, UUPSUpgradeable  // <= FOUND ' Ownable,'
```
['[23](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L23-L23)']
```solidity
23: contract Router is IRouter, Ownable, Initializable, UUPSUpgradeable  // <= FOUND ' Ownable,'
```


</details>

## [Low-9] Some tokens may revert when zero value transfers are made 

### Resolution 
Reason: In Solidity, ERC20 token transfers of value 0 can sometimes lead to unexpected issues. This is particularly relevant when dealing with fractional token amounts that round to 0 when less than 1 of the smallest unit is transferred, leading to an effective transfer of nothing while still consuming gas. Furthermore, some ERC20 token implementations may revert on attempts to transfer a value of 0. However, note that this issue doesn't generally apply to wrapper native tokens like WETH.

Resolution: It's advisable to include a condition before any transfer operation to bypass the transaction if the transfer amount is 0. This saves unnecessary gas expenditure and prevents potential function reverts. For handling fractions, ensure token decimals are appropriately assigned and contemplate setting a minimum transfer threshold to avoid rounding down to 0. When dealing with wrapped tokens like WETH, special consideration should be given to their unique characteristics.

Num of instances: 10

### Findings 


<details><summary>Click to show findings</summary>

['[220](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L220-L226)']
```solidity
220:     function _depositAmountsToMarginAccount(address _token1, address _token2, uint256 baseDeposit, uint256 quoteDeposit) // <= FOUND
221:         internal
222:     {
223:         if (_token1 == address(0)) {
224:             marginAccount.deposit{value: baseDeposit}(address(this), _token1, baseDeposit);
225:         } else {
226:             _token1.safeTransferFrom(msg.sender, address(this), baseDeposit); // <= FOUND
227:             marginAccount.deposit(address(this), _token1, baseDeposit);
228:         }
229: 
230:         if (_token2 == address(0)) {
231:             marginAccount.deposit{value: quoteDeposit}(address(this), _token2, quoteDeposit);
232:         } else {
233:             _token2.safeTransferFrom(msg.sender, address(this), quoteDeposit);
234:             marginAccount.deposit(address(this), _token2, quoteDeposit);
235:         }
236:     }
```
['[294](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L294-L298)']
```solidity
294:     function _transferTokensToUser(uint256 amount, address token, address receiver) internal { // <= FOUND
295:         if (token == address(0)) {
296:             receiver.safeTransferETH(amount);
297:         } else {
298:             token.safeTransfer(receiver, amount); // <= FOUND
299:         }
300:     }
```
['[118](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L118-L125)']
```solidity
118:     function creditUser(address _user, address _token, uint256 _amount, bool _useMargin) external protocolActive { // <= FOUND
119:         require(verifiedMarket[msg.sender], MarginAccountErrors.OnlyVerifiedMarketsAllowed());
120: 
121:         if (_useMargin) {
122:             balances[_accountKey(_user, _token)] += _amount;
123:         } else {
124:             if (_token != NATIVE) {
125:                 _token.safeTransfer(_user, _amount); // <= FOUND
126:             } else {
127:                 _user.safeTransferETH(_amount);
128:             }
129:         }
130:     }
```
['[136](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L136-L149)']
```solidity
136:     function creditUsersEncoded(bytes calldata _encodedData) external protocolActive { // <= FOUND
137:         require(verifiedMarket[msg.sender], MarginAccountErrors.OnlyVerifiedMarketsAllowed());
138: 
139:         uint256 offset = 0;
140:         while (offset < _encodedData.length) {
141:             (address _user, address _token, uint256 _amount, bool _useMargin) =
142:                 abi.decode(_encodedData[offset:offset + 128], (address, address, uint256, bool));
143:             offset += 128;
144: 
145:             if (_useMargin) {
146:                 balances[_accountKey(_user, _token)] += _amount;
147:             } else {
148:                 if (_token != NATIVE) {
149:                     _token.safeTransfer(_user, _amount); // <= FOUND
150:                 } else {
151:                     _user.safeTransferETH(_amount);
152:                 }
153:             }
154:         }
155:     }
```
['[198](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L198-L206)']
```solidity
198:     function deposit(address _user, address _token, uint256 _amount) external payable protocolActive { // <= FOUND
199:         require(_user != address(0), MarginAccountErrors.ZeroAddressNotAllowed());
200:         if (_token == NATIVE) {
201:             require(msg.value == _amount, MarginAccountErrors.NativeAssetMismatch());
202:             balances[_accountKey(_user, NATIVE)] += _amount;
203:         } else {
204:             require(msg.value == 0, MarginAccountErrors.NativeAssetMismatch());
205:             balances[_accountKey(_user, _token)] += _amount;
206:             _token.safeTransferFrom(_msgSender(), address(this), _amount); // <= FOUND
207:         }
208: 
209:         emit Deposit(_user, _token, _amount);
210:     }
```
['[217](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L217-L223)']
```solidity
217:     function withdraw(uint256 _amount, address _token) external protocolActive { // <= FOUND
218:         require(_amount <= balances[_accountKey(_msgSender(), _token)], MarginAccountErrors.InsufficientBalance());
219:         balances[_accountKey(_msgSender(), _token)] -= _amount;
220:         if (_token == NATIVE) {
221:             _msgSender().safeTransferETH(_amount);
222:         } else {
223:             _token.safeTransfer(_msgSender(), _amount); // <= FOUND
224:         }
225: 
226:         emit Withdrawal(_msgSender(), _token, _amount);
227:     }
```
['[728](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L728-L767)']
```solidity
728:     function placeAndExecuteMarketBuy(uint96 _quoteSize, uint256 _minAmountOut, bool _isMargin, bool _isFillOrKill) // <= FOUND
729:         public
730:         payable
731:         override
732:         marketActive
733:         nonReentrant
734:         returns (uint256)
735:     {
736:         OrderBookType _type = orderBookType;
737: 
738:         if (_type == OrderBookType.NATIVE_IN_QUOTE && !_isMargin && (msg.sender != address(0))) { // <= FOUND
739:             require(
740:                 msg.value >= _pricePrecisionToQuoteAssetPrecision(_quoteSize), OrderBookErrors.NativeAssetInsufficient()
741:             );
742:             require(
743:                 msg.value < _pricePrecisionToQuoteAssetPrecision(_quoteSize + 1), OrderBookErrors.NativeAssetSurplus()
744:             );
745:         } else if (msg.sender != address(0)) {
746:             require(msg.value == 0, OrderBookErrors.NativeAssetNotRequired());
747:             _isMargin // <= FOUND
748:                 ? marginAccount.debitUser(_msgSender(), quoteAsset, _pricePrecisionToQuoteAssetPrecision(_quoteSize))
749:                 : quoteAsset.safeTransferFrom(
750:                     _msgSender(), address(marginAccount), _pricePrecisionToQuoteAssetPrecision(_quoteSize)
751:                 );
752:         }
753: 
754:         uint256 _baseTokensCredited;
755:         (_quoteSize, _baseTokensCredited) = _marketBuyMatch(_quoteSize, _isMargin); // <= FOUND
756:         if (msg.sender == address(0)) {
757:             return _baseTokensCredited;
758:         }
759:         if (_quoteSize > 0) {
760:             require(!_isFillOrKill, OrderBookErrors.InsufficientLiquidity());
761:             if (_type == OrderBookType.NATIVE_IN_QUOTE && !_isMargin) { // <= FOUND
762:                 
763:                 uint256 _refund = _pricePrecisionToQuoteAssetPrecision(_quoteSize);
764:                 _handleNativeMarketRefundTransfer(_refund);
765:             } else {
766:                 marginAccount.creditUser(
767:                     _msgSender(), quoteAsset, _pricePrecisionToQuoteAssetPrecision(_quoteSize), _isMargin // <= FOUND
768:                 );
769:             }
770:         } else if (_type == OrderBookType.NATIVE_IN_QUOTE) {
771:             address(marginAccount).safeTransferETH(msg.value);
772:         }
773:         require(_baseTokensCredited >= _minAmountOut, OrderBookErrors.SlippageExceeded());
774: 
775:         return _baseTokensCredited;
776:     }
```
['[786](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L786-L817)']
```solidity
786:     function placeAndExecuteMarketSell(uint96 _size, uint256 _minAmountOut, bool _isMargin, bool _isFillOrKill) // <= FOUND
787:         public
788:         payable
789:         marketActive
790:         nonReentrant
791:         returns (uint256)
792:     {
793:         OrderBookType _type = orderBookType;
794:         if (_type == OrderBookType.NATIVE_IN_BASE && !_isMargin && (msg.sender != address(0))) { // <= FOUND
795:             require(msg.value >= _sizePrecisionToBaseAssetPrecision(_size), OrderBookErrors.NativeAssetInsufficient());
796:             require(msg.value < _sizePrecisionToBaseAssetPrecision(_size + 1), OrderBookErrors.NativeAssetSurplus());
797:         } else if (msg.sender != address(0)) {
798:             require(msg.value == 0, OrderBookErrors.NativeAssetNotRequired());
799:             _isMargin // <= FOUND
800:                 ? marginAccount.debitUser(_msgSender(), baseAsset, _sizePrecisionToBaseAssetPrecision(_size))
801:                 : baseAsset.safeTransferFrom(
802:                     _msgSender(), address(marginAccount), _sizePrecisionToBaseAssetPrecision(_size)
803:                 );
804:         }
805: 
806:         uint256 _quoteCredited;
807:         (_size, _quoteCredited) = _matchAggressiveSell(0, _size, _isMargin); // <= FOUND
808:         if (msg.sender == address(0)) {
809:             return _quoteCredited;
810:         }
811:         if (_size > 0) {
812:             require(!_isFillOrKill, OrderBookErrors.InsufficientLiquidity());
813:             if (_type == OrderBookType.NATIVE_IN_BASE && !_isMargin) { // <= FOUND
814:                 uint256 _refund = _sizePrecisionToBaseAssetPrecision(_size);
815:                 _handleNativeMarketRefundTransfer(_refund);
816:             } else {
817:                 marginAccount.creditUser(_msgSender(), baseAsset, _sizePrecisionToBaseAssetPrecision(_size), _isMargin); // <= FOUND
818:             }
819:         } else if (_type == OrderBookType.NATIVE_IN_BASE) {
820:             address(marginAccount).safeTransferETH(msg.value);
821:         }
822:         require(_quoteCredited >= _minAmountOut, OrderBookErrors.SlippageExceeded());
823:         return _quoteCredited;
824:     }
```
['[65](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/periphery/MonadDeployer.sol#L65-L93)']
```solidity
65:     function deployTokenAndMarket( // <= FOUND
66:         TokenParams memory tokenParams,
67:         MarketParams memory marketParams,
68:         bytes calldata metadata
69:     ) external payable returns (address market) {
70:         KuruERC20 token = new KuruERC20(tokenParams.name, tokenParams.symbol, tokenParams.initialSupply, address(this));
71:         market = router.deployProxy(
72:             IOrderBook.OrderBookType.NATIVE_IN_QUOTE,
73:             address(token),
74:             address(0),
75:             marketParams.sizePrecision,
76:             marketParams.pricePrecision,
77:             marketParams.tickSize,
78:             marketParams.minSize,
79:             marketParams.maxSize,
80:             marketParams.takerFeeBps,
81:             marketParams.makerFeeBps,
82:             kuruAmmSpread
83:         );
84:         if (msg.value != (marketParams.nativeTokenAmount + kuruCollectiveFee)) {
85:             revert InsufficientAssets(marketParams.nativeTokenAmount + kuruCollectiveFee, msg.value);
86:         }
87:         (address vault,,,,,,,) = IOrderBook(market).getVaultParams();
88:         uint256 _supplyToVault = tokenParams.initialSupply * (10 ** 4 - tokenParams.supplyToDev) / 10 ** 4;
89:         token.approve(vault, _supplyToVault);
90:         IKuruAMMVault(vault).deposit{value: marketParams.nativeTokenAmount}(
91:             _supplyToVault, marketParams.nativeTokenAmount, address(this)
92:         );
93:         token.transfer(tokenParams.dev, tokenParams.initialSupply - _supplyToVault); // <= FOUND
94:         marginAccount.deposit{value: kuruCollectiveFee}(kuruCollective, address(0), kuruCollectiveFee);
95:         emit PumpingTime(
96:             address(token),
97:             tokenParams.tokenURI,
98:             tokenParams.dev,
99:             tokenParams.initialSupply - _supplyToVault,
100:             market,
101:             metadata
102:         );
103:     }
```
['[331](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L331-L372)']
```solidity
331:     function anyToAnySwap( // <= FOUND
332:         address[] calldata _marketAddresses,
333:         bool[] calldata _isBuy,
334:         bool[] calldata _nativeSend,
335:         address _debitToken,
336:         address _creditToken,
337:         uint256 _amount,
338:         uint256 _minAmountOut
339:     ) external payable returns (uint256 _amountOut) {
340:         require(_marketAddresses.length >= 1, RouterErrors.NoMarketsPassed());
341:         require(_isBuy.length == _marketAddresses.length, RouterErrors.LengthMismatch());
342:         require(_nativeSend.length == _marketAddresses.length, RouterErrors.LengthMismatch());
343:         if (_nativeSend[0] == false) {
344:             _debitToken.safeTransferFrom(msg.sender, address(this), _amount);
345:         }
346:         uint256 _cachedAmountIn = _amount;
347: 
348:         for (uint256 i = 0; i < _marketAddresses.length; i++) {
349:             address _currentMarket = _marketAddresses[i];
350:             MarketParams memory _marketParams = verifiedMarket[_currentMarket];
351:             require(_marketParams.pricePrecision > 0, RouterErrors.InvalidMarket());
352:             IOrderBook market = IOrderBook(_currentMarket);
353:             uint256 _value = _nativeSend[i] ? _amount : 0;
354:             _amountOut = _isBuy[i]
355:                 ? (
356:                     market.placeAndExecuteMarketBuy{value: _value}(
357:                         toU96(_amount * _marketParams.pricePrecision / 10 ** _marketParams.quoteAssetDecimals),
358:                         0,
359:                         false,
360:                         true
361:                     )
362:                 )
363:                 : market.placeAndExecuteMarketSell{value: _value}(
364:                     toU96(_amount * _marketParams.sizePrecision / 10 ** _marketParams.baseAssetDecimals), 0, false, true
365:                 );
366: 
367:             _amount = _amountOut;
368:         }
369:         require(_amountOut >= _minAmountOut, RouterErrors.SlippageExceeded());
370:         emit KuruRouterSwap(msg.sender, _debitToken, _creditToken, _cachedAmountIn, _amountOut);
371:         if (_creditToken != address(0)) {
372:             _creditToken.safeTransfer(msg.sender, _amountOut); // <= FOUND
373:         } else {
374:             msg.sender.safeTransferETH(_amountOut);
375:         }
376:     }
```


</details>

## [Low-10] Unsafe uint to int conversion

### Resolution 
Unsafe conversion from `uint` to `int` in Solidity can lead to unexpected overflows if the unsigned integer value exceeds the positive limit of the corresponding signed integer type. This is due to the fact that signed integers use one bit for the sign, effectively halving the positive range. An example is converting a `uint256` number greater than `type(uint128).max` to an `int256`, which can result in an overflow. To mitigate this risk, consider using libraries like SafeCast, which include functions specifically designed to safely cast between different numerical types. They perform necessary checks and revert the transaction if an unsafe cast is attempted, thereby enhancing the security and robustness of the code.

Num of instances: 15

### Findings 


<details><summary>Click to show findings</summary>

['[376](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L376-L396)']
```solidity
376:     function _convertToAssetsWithNewSize(uint256 shares) // <= FOUND
377:         internal
378:         view
379:         returns (uint256, uint256, uint96, uint96, bool)
380:     {
381:         (uint256 _baseAmount,) = _returnNormalizedAmountAndPrice(false);
382:         uint256 _baseAmountAfterRemoval = _baseAmount - FixedPointMathLib.mulDiv(shares, _baseAmount, totalSupply());
383:         (uint96 _newAskSize, uint96 _newBidSize) = _getVaultSizesForBaseAmount(_baseAmountAfterRemoval);
384:         (
385:             ,
386:             uint256 _vaultBestBid,
387:             uint96 _partiallyFilledBidSize,
388:             uint256 _vaultBestAsk,
389:             uint96 _partiallyFilledAskSize,
390:             ,
391:             ,
392:         ) = market.getVaultParams();
393:         MarketParams memory _marketParams = marketParams;
394:         (uint256 _reserveBase, uint256 _reserveQuote) = totalAssets();
395:         if (_partiallyFilledAskSize > _newAskSize || _partiallyFilledBidSize > _newBidSize) {
396:             int256 _baseOwedToVault = ( // <= FOUND
397:                 int256(uint256(_partiallyFilledAskSize)) - int256(uint256(_partiallyFilledBidSize))
398:             ) * int256(10 ** _marketParams.baseAssetDecimals) / int256(uint256(_marketParams.sizePrecision));
399:             int256 _quoteOwedToVault = (
400:                 int256(FixedPointMathLib.mulDivUp(_partiallyFilledBidSize, _vaultBestBid, _marketParams.sizePrecision))
401:                     - int256(FixedPointMathLib.mulDiv(_partiallyFilledAskSize, _vaultBestAsk, _marketParams.sizePrecision))
402:             ) * int256(10 ** _marketParams.quoteAssetDecimals) / int256(vaultPricePrecision);
403:             uint256 _baseOwedToUser;
404:             uint256 _quoteOwedToUser;
405:             if (_baseOwedToVault < 0) {
406:                 _reserveBase = _reserveBase - (uint256(-1 * _baseOwedToVault));
407:                 _baseOwedToUser =
408:                     FixedPointMathLib.mulDiv(shares, _reserveBase, totalSupply()) + uint256(-1 * _baseOwedToVault);
409:             } else {
410:                 _reserveBase = _reserveBase + (uint256(_baseOwedToVault));
411:                 _baseOwedToUser =
412:                     FixedPointMathLib.mulDiv(shares, _reserveBase, totalSupply()) - uint256(_baseOwedToVault);
413:             }
414:             if (_quoteOwedToVault < 0) {
415:                 _reserveQuote = _reserveQuote - (uint256(-1 * _quoteOwedToVault));
416:                 _quoteOwedToUser =
417:                     FixedPointMathLib.mulDiv(shares, _reserveQuote, totalSupply()) + uint256(-1 * _quoteOwedToVault);
418:             } else {
419:                 _reserveQuote = _reserveQuote + (uint256(_quoteOwedToVault));
420:                 _quoteOwedToUser =
421:                     FixedPointMathLib.mulDiv(shares, _reserveQuote, totalSupply()) - uint256(_quoteOwedToVault);
422:             }
423:             return (_baseOwedToUser, _quoteOwedToUser, _newAskSize, _newBidSize, true);
424:         } else {
425:             uint256 _baseOwedToUser = FixedPointMathLib.mulDiv(shares, _reserveBase, totalSupply());
426:             uint256 _quoteOwedToUser = FixedPointMathLib.mulDiv(shares, _reserveQuote, totalSupply());
427:             return (_baseOwedToUser, _quoteOwedToUser, _newAskSize, _newBidSize, false);
428:         }
429:     }
```
['[194](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L194-L196)']
```solidity
194:     function powWad(int256 x, int256 y) internal pure returns (int256) { // <= FOUND
195:         
196:         return expWad((lnWad(x) * y) / int256(WAD)); // <= FOUND
197:     }
```
['[202](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L202-L263)']
```solidity
202:     function expWad(int256 x) internal pure returns (int256 r) { // <= FOUND
203:         unchecked {
204:             
205:             
206:             if (x <= -41446531673892822313) return r;
207: 
208:             
209:             assembly {
210:                 
211:                 
212:                 if iszero(slt(x, 135305999368893231589)) {
213:                     mstore(0x00, 0xa37bfec9) 
214:                     revert(0x1c, 0x04)
215:                 }
216:             }
217: 
218:             
219:             
220:             
221:             x = (x << 78) / 5 ** 18;
222: 
223:             
224:             
225:             
226:             int256 k = ((x << 96) / 54916777467707473351141471128 + 2 ** 95) >> 96;
227:             x = x - k * 54916777467707473351141471128;
228: 
229:             
230: 
231:             
232:             
233:             int256 y = x + 1346386616545796478920950773328;
234:             y = ((y * x) >> 96) + 57155421227552351082224309758442;
235:             int256 p = y + x - 94201549194550492254356042504812;
236:             p = ((p * y) >> 96) + 28719021644029726153956944680412240;
237:             p = p * x + (4385272521454847904659076985693276 << 96);
238: 
239:             
240:             int256 q = x - 2855989394907223263936484059900;
241:             q = ((q * x) >> 96) + 50020603652535783019961831881945;
242:             q = ((q * x) >> 96) - 533845033583426703283633433725380;
243:             q = ((q * x) >> 96) + 3604857256930695427073651918091429;
244:             q = ((q * x) >> 96) - 14423608567350463180887372962807573;
245:             q = ((q * x) >> 96) + 26449188498355588339934803723976023;
246: 
247:             
248:             assembly {
249:                 
250:                 
251:                 
252:                 r := sdiv(p, q)
253:             }
254: 
255:             
256: 
257:             
258:             
259:             
260:             
261:             
262:             
263:             r = int256((uint256(r) * 3822833074963236453042738258902158003155416615667) >> uint256(195 - k)); // <= FOUND
264:         }
265:     }
```
['[346](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L346-L350)']
```solidity
346:     function lambertW0Wad(int256 x) internal pure returns (int256 w) { // <= FOUND
347:         
348:         unchecked {
349:             if ((w = x) <= -367879441171442322) revert OutOfDomain(); 
350:             int256 wad = int256(WAD); // <= FOUND
351:             int256 p = x;
352:             uint256 c; 
353:             uint256 i = 4; 
354:             if (w <= 0x1ffffffffffff) {
355:                 if (-0x4000000000000 <= w) {
356:                     i = 1; 
357:                 } else if (w <= -0x3ffffffffffffff) {
358:                     i = 32; 
359:                 }
360:             } else if (uint256(w >> 63) == uint256(0)) {
361:                 
362:                 assembly {
363:                     
364:                     let v := shr(49, w)
365:                     let l := shl(3, lt(0xff, v))
366:                     l := add(or(l, byte(and(0x1f, shr(shr(l, v), 0x8421084210842108cc6318c6db6d54be)),
367:                         0x0706060506020504060203020504030106050205030304010505030400000000)), 49)
368:                     w := sdiv(shl(l, 7), byte(sub(l, 31), 0x0303030303030303040506080c13))
369:                     c := gt(l, 60)
370:                     i := add(2, add(gt(l, 53), c))
371:                 }
372:             } else {
373:                 int256 ll = lnWad(w = lnWad(w));
374:                 
375:                 assembly {
376:                     
377:                     w := add(sdiv(mul(ll, 1023715080943847266), w), sub(w, ll))
378:                     i := add(3, iszero(shr(68, x)))
379:                     c := iszero(shr(143, x))
380:                 }
381:                 if (c == uint256(0)) {
382:                     do { 
383:                         int256 e = expWad(w);
384:                         
385:                         assembly {
386:                             let t := mul(w, div(e, wad))
387:                             w := sub(w, sdiv(sub(t, x), div(add(e, t), wad)))
388:                         }
389:                         if (p <= w) break;
390:                         p = w;
391:                     } while (--i != uint256(0));
392:                     
393:                     assembly {
394:                         w := sub(w, sgt(w, 2))
395:                     }
396:                     return w;
397:                 }
398:             }
399:             do { 
400:                 int256 e = expWad(w);
401:                 
402:                 assembly {
403:                     let t := add(w, wad)
404:                     let s := sub(mul(w, e), mul(x, wad))
405:                     w := sub(w, sdiv(mul(s, wad), sub(mul(e, t), sdiv(mul(add(t, wad), s), add(t, t)))))
406:                 }
407:                 if (p <= w) break;
408:                 p = w;
409:             } while (--i != c);
410:             
411:             assembly {
412:                 w := sub(w, sgt(w, 2))
413:             }
414:             
415:             
416:             if (c == uint256(0)) return w;
417:             int256 t = w | 1;
418:             
419:             assembly {
420:                 x := sdiv(mul(x, wad), t)
421:             }
422:             x = (t * (wad + lnWad(x)));
423:             
424:             assembly {
425:                 w := sdiv(x, add(wad, t))
426:             }
427:         }
428:     }
```
['[1051](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L1051-L1053)']
```solidity
1051:     function lerp(int256 a, int256 b, int256 t, int256 begin, int256 end) internal pure returns (int256) { // <= FOUND
1052:         if (begin > end) {
1053:             t = int256(~uint256(t)); // <= FOUND
1054:             begin = int256(~uint256(begin));
1055:             end = int256(~uint256(end));
1056:         }
1057:         if (t <= begin) return a;
1058:         if (t >= end) return b;
1059:         
1060:         unchecked {
1061:             if (b >= a) return int256(uint256(a) + fullMulDiv(uint256(b) - uint256(a),
1062:                 uint256(t) - uint256(begin), uint256(end) - uint256(begin)));
1063:             return int256(uint256(a) - fullMulDiv(uint256(a) - uint256(b),
1064:                 uint256(t) - uint256(begin), uint256(end) - uint256(begin)));
1065:         }
1066:     }
```
['[396](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L396-L398)']
```solidity
396:             int256 _baseOwedToVault = (
397:                 int256(uint256(_partiallyFilledAskSize)) - int256(uint256(_partiallyFilledBidSize)) // <= FOUND
398:             ) * int256(10 ** _marketParams.baseAssetDecimals) / int256(uint256(_marketParams.sizePrecision)); // <= FOUND
```
['[399](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L399-L402)']
```solidity
399:             int256 _quoteOwedToVault = (
400:                 int256(FixedPointMathLib.mulDivUp(_partiallyFilledBidSize, _vaultBestBid, _marketParams.sizePrecision)) // <= FOUND
401:                     - int256(FixedPointMathLib.mulDiv(_partiallyFilledAskSize, _vaultBestAsk, _marketParams.sizePrecision)) // <= FOUND
402:             ) * int256(10 ** _marketParams.quoteAssetDecimals) / int256(vaultPricePrecision); // <= FOUND
```
['[196](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L196-L197)']
```solidity
196:         
197:         return expWad((lnWad(x) * y) / int256(WAD)); // <= FOUND
```
['[263](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L263-L271)']
```solidity
263:             
264: 
265:             
266:             
267:             
268:             
269:             
270:             
271:             r = int256((uint256(r) * 3822833074963236453042738258902158003155416615667) >> uint256(195 - k)); // <= FOUND
```
['[350](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L350-L350)']
```solidity
350:             int256 wad = int256(WAD); // <= FOUND
```
['[1053](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L1053-L1053)']
```solidity
1053:             t = int256(~uint256(t)); // <= FOUND
```
['[1054](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L1054-L1054)']
```solidity
1054:             begin = int256(~uint256(begin)); // <= FOUND
```
['[1055](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L1055-L1055)']
```solidity
1055:             end = int256(~uint256(end)); // <= FOUND
```
['[1061](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L1061-L1061)']
```solidity
1061:             if (b >= a) return int256(uint256(a) + fullMulDiv(uint256(b) - uint256(a), // <= FOUND
1062:                 uint256(t) - uint256(begin), uint256(end) - uint256(begin)));
```
['[1063](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L1063-L1063)']
```solidity
1063:             return int256(uint256(a) - fullMulDiv(uint256(a) - uint256(b), // <= FOUND
1064:                 uint256(t) - uint256(begin), uint256(end) - uint256(begin)));
```


</details>

## [Low-11] Withdrawal mechanism can be Dos'd with dust withdrawals

### Resolution 
As the 'amount' value is not validated against a minimum amount, a potential attacker can make a large number of micro withdrawal requests such a 1e1 for a token with 1e18 decimals. As such they can prevent other users from withdrawing their assets. A resolution to this is implementing a minimum withdrawal amount, although this will need setter limits of it's own to prevent it from being changed to a number so high, no one can withdraw. 

Num of instances: 1

### Findings 


<details><summary>Click to show findings</summary>

['[241](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L241-L252)']
```solidity
241:     function withdraw(uint256 _shares, address _receiver, address _owner) // <= FOUND
242:         public
243:         nonReentrant
244:         returns (uint256, uint256)
245:     {
246:         require(_shares <= balanceOf(_owner), KuruAMMVaultErrors.InsufficientBalance());
247: 
248:         if (msg.sender != _owner) {
249:             _spendAllowance(_owner, msg.sender, _shares);
250:         }
251: 
252:         return _burnAndWithdraw(_shares, _receiver, _owner); // <= FOUND
253:     }
```


</details>

## [Low-12] Vault `totalAssets` function calculates it's `totalAsset` value using non standard method that can result in incorrect accounting

Num of instances: 1

### Findings 


<details><summary>Click to show findings</summary>

['[149](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L149-L149)']
```solidity
149:     function totalAssets() public view returns (uint256, uint256) {
150:         return (marginAccount.getBalance(address(this), token1), marginAccount.getBalance(address(this), token2));
151:     }
```


</details>

## [Low-13] Low level calls in solidity versions preceding 0.8.14 can result in an optimiser bug

### Resolution 
In Solidity versions 0.8.13 and 0.8.14, a known optimizer bug presents potential risks when a variable is used in a separate assembly block from the one in which it was stored. Specifically, the 'mstore' operation could be optimized out due to this bug, leading to the use of uninitialized memory. Although the current code does not exhibit this risky pattern of execution, it does utilize 'mstore' within assembly blocks, which introduces a vulnerability risk for future code modifications. As a preventative measure, it is advisable to avoid the usage of the afflicted Solidity versions, 0.8.13 and 0.8.14. Instead, consider utilizing a version that is not impacted by this optimizer bug to prevent potential memory initialization issues in your smart contract.

Num of instances: 16

### Findings 


<details><summary>Click to show findings</summary>

['[66](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L66-L69)']
```solidity
66:         assembly { // <= FOUND
67:             
68:             if mul(y, gt(x, div(not(0), y))) {
69:                 mstore(0x00, 0xbac65e5b)  // <= FOUND
70:                 revert(0x1c, 0x04)
71:             }
72:             z := div(mul(x, y), WAD)
73:         }
```
['[79](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L79-L83)']
```solidity
79:         assembly { // <= FOUND
80:             z := mul(x, y)
81:             
82:             if iszero(gt(or(iszero(x), eq(sdiv(z, x), y)), lt(not(x), eq(y, shl(255, 1))))) {
83:                 mstore(0x00, 0xedcd4dd4)  // <= FOUND
84:                 revert(0x1c, 0x04)
85:             }
86:             z := sdiv(z, WAD)
87:         }
```
['[109](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L109-L112)']
```solidity
109:         assembly { // <= FOUND
110:             
111:             if mul(y, gt(x, div(not(0), y))) {
112:                 mstore(0x00, 0xbac65e5b)  // <= FOUND
113:                 revert(0x1c, 0x04)
114:             }
115:             z := add(iszero(iszero(mod(mul(x, y), WAD))), div(mul(x, y), WAD))
116:         }
```
['[130](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L130-L133)']
```solidity
130:         assembly { // <= FOUND
131:             
132:             if iszero(mul(y, iszero(mul(WAD, gt(x, div(not(0), WAD)))))) {
133:                 mstore(0x00, 0x7c5f487d)  // <= FOUND
134:                 revert(0x1c, 0x04)
135:             }
136:             z := div(mul(x, WAD), y)
137:         }
```
['[143](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L143-L147)']
```solidity
143:         assembly { // <= FOUND
144:             z := mul(x, WAD)
145:             
146:             if iszero(and(iszero(iszero(y)), eq(sdiv(z, WAD), x))) {
147:                 mstore(0x00, 0x5c43740d)  // <= FOUND
148:                 revert(0x1c, 0x04)
149:             }
150:             z := sdiv(mul(x, WAD), y)
151:         }
```
['[173](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L173-L176)']
```solidity
173:         assembly { // <= FOUND
174:             
175:             if iszero(mul(y, iszero(mul(WAD, gt(x, div(not(0), WAD)))))) {
176:                 mstore(0x00, 0x7c5f487d)  // <= FOUND
177:                 revert(0x1c, 0x04)
178:             }
179:             z := add(iszero(iszero(mod(mul(x, WAD), y))), div(mul(x, WAD), y))
180:         }
```
['[272](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L272-L286)']
```solidity
272:         assembly { // <= FOUND
273:             
274:             
275:             
276:             
277: 
278:             
279:             r := shl(7, lt(0xffffffffffffffffffffffffffffffff, x))
280:             r := or(r, shl(6, lt(0xffffffffffffffff, shr(r, x))))
281:             r := or(r, shl(5, lt(0xffffffff, shr(r, x))))
282:             r := or(r, shl(4, lt(0xffff, shr(r, x))))
283:             r := or(r, shl(3, lt(0xff, shr(r, x))))
284:             
285:             if iszero(sgt(x, 0)) {
286:                 mstore(0x00, 0x1615e638)  // <= FOUND
287:                 revert(0x1c, 0x04)
288:             }
289:             
290:             r := xor(r, byte(and(0x1f, shr(shr(r, x), 0x8421084210842108cc6318c6db6d54be)),
291:                 0xf8f9f9faf9fdfafbf9fdfcfdfafbfcfef9fafdfafcfcfbfefafafcfbffffffff))
292: 
293:             
294:             
295:             x := shr(159, shl(r, x))
296: 
297:             
298:             
299:             
300:             let p := sub( 
301:                 sar(96, mul(add(43456485725739037958740375743393,
302:                 sar(96, mul(add(24828157081833163892658089445524,
303:                 sar(96, mul(add(3273285459638523848632254066296,
304:                     x), x))), x))), x)), 11111509109440967052023855526967)
305:             p := sub(sar(96, mul(p, x)), 45023709667254063763336534515857)
306:             p := sub(sar(96, mul(p, x)), 14706773417378608786704636184526)
307:             p := sub(mul(p, x), shl(96, 795164235651350426258249787498))
308:             
309: 
310:             
311:             let q := add(5573035233440673466300451813936, x)
312:             q := add(71694874799317883764090561454958, sar(96, mul(x, q)))
313:             q := add(283447036172924575727196451306956, sar(96, mul(x, q)))
314:             q := add(401686690394027663651624208769553, sar(96, mul(x, q)))
315:             q := add(204048457590392012362485061816622, sar(96, mul(x, q)))
316:             q := add(31853899698501571402653359427138, sar(96, mul(x, q)))
317:             q := add(909429971244387300277376558375, sar(96, mul(x, q)))
318: 
319:             
320: 
321:             
322:             
323:             
324:             
325:             
326: 
327:             
328:             
329:             p := sdiv(p, q)
330:             
331:             p := mul(1677202110996718588342820967067443963516166, p)
332:             
333:             
334:             p := add(mul(16597577552685614221487285958193947469193820559219878177908093499208371, sub(159, r)), p)
335:             
336:             p := add(600920179829731861736702779321621459595472258049074101567377883020018308, p)
337:             
338:             r := sar(174, p)
339:         }
```
['[439](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L439-L462)']
```solidity
439:         assembly { // <= FOUND
440:             
441:             
442:             
443:             
444:             
445: 
446:             
447:             result := mul(x, y) 
448:             for {} 1 {} {
449:                 
450:                 if iszero(mul(or(iszero(x), eq(div(result, x), y)), d)) {
451:                     let mm := mulmod(x, y, not(0))
452:                     let p1 := sub(mm, add(result, lt(mm, result))) 
453: 
454:                     
455: 
456:                     
457:                     let r := mulmod(x, y, d) 
458:                     let t := and(d, sub(0, d)) 
459:                     
460:                     
461:                     if iszero(gt(d, p1)) {
462:                         mstore(0x00, 0xae47f702)  // <= FOUND
463:                         revert(0x1c, 0x04)
464:                     }
465:                     d := div(d, t) 
466:                     
467:                     
468:                     
469:                     
470:                     
471:                     let inv := xor(2, mul(3, d))
472:                     
473:                     
474:                     
475:                     inv := mul(inv, sub(2, mul(d, inv))) 
476:                     inv := mul(inv, sub(2, mul(d, inv))) 
477:                     inv := mul(inv, sub(2, mul(d, inv))) 
478:                     inv := mul(inv, sub(2, mul(d, inv))) 
479:                     inv := mul(inv, sub(2, mul(d, inv))) 
480:                     result :=
481:                         mul(
482:                             
483:                             
484:                             
485:                             or(mul(sub(p1, gt(r, result)), add(div(sub(0, t), t), 1)), div(sub(result, r), t)),
486:                             mul(sub(2, mul(d, inv)), inv) 
487:                         )
488:                     break
489:                 }
490:                 result := div(result, d)
491:                 break
492:             }
493:         }
```
['[529](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L529-L533)']
```solidity
529:         assembly { // <= FOUND
530:             if mulmod(x, y, d) {
531:                 result := add(result, 1)
532:                 if iszero(result) {
533:                     mstore(0x00, 0xae47f702)  // <= FOUND
534:                     revert(0x1c, 0x04)
535:                 }
536:             }
537:         }
```
['[544](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L544-L548)']
```solidity
544:         assembly { // <= FOUND
545:             z := mul(x, y)
546:             
547:             if iszero(mul(or(iszero(x), eq(div(z, x), y)), d)) {
548:                 mstore(0x00, 0xad251c27)  // <= FOUND
549:                 revert(0x1c, 0x04)
550:             }
551:             z := div(z, d)
552:         }
```
['[559](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L559-L563)']
```solidity
559:         assembly { // <= FOUND
560:             z := mul(x, y)
561:             
562:             if iszero(mul(or(iszero(x), eq(div(z, x), y)), d)) {
563:                 mstore(0x00, 0xad251c27)  // <= FOUND
564:                 revert(0x1c, 0x04)
565:             }
566:             z := add(iszero(iszero(mod(z, d))), div(z, d))
567:         }
```
['[578](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L578-L580)']
```solidity
578:         assembly { // <= FOUND
579:             if iszero(d) {
580:                 mstore(0x00, 0x65244e4e)  // <= FOUND
581:                 revert(0x1c, 0x04)
582:             }
583:             z := add(iszero(iszero(mod(x, d))), div(x, d))
584:         }
```
['[607](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L607-L630)']
```solidity
607:         assembly { // <= FOUND
608:             z := mul(b, iszero(y)) 
609:             if x {
610:                 z := xor(b, mul(xor(b, x), and(y, 1))) 
611:                 let half := shr(1, b) 
612:                 
613:                 for { y := shr(1, y) } y { y := shr(1, y) } {
614:                     let xx := mul(x, x) 
615:                     let xxRound := add(xx, half) 
616:                     
617:                     if or(lt(xxRound, xx), shr(128, x)) {
618:                         mstore(0x00, 0x49f7642b)  // <= FOUND
619:                         revert(0x1c, 0x04)
620:                     }
621:                     x := div(xxRound, b) 
622:                     
623:                     if and(y, 1) {
624:                         let zx := mul(z, x) 
625:                         let zxRound := add(zx, half) 
626:                         
627:                         if or(xor(div(zx, x), z), lt(zxRound, zx)) {
628:                             
629:                             if x {
630:                                 mstore(0x00, 0x49f7642b)  // <= FOUND
631:                                 revert(0x1c, 0x04)
632:                             }
633:                         }
634:                         z := div(zxRound, b) 
635:                     }
636:                 }
637:             }
638:         }
```
['[768](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L768-L771)']
```solidity
768:         assembly { // <= FOUND
769:             result := 1
770:             if iszero(lt(x, 58)) {
771:                 mstore(0x00, 0xaba0f2a2)  // <= FOUND
772:                 revert(0x1c, 0x04)
773:             }
774:             for {} x { x := sub(x, 1) } { result := mul(result, x) }
775:         }
```
['[913](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L913-L915)']
```solidity
913:         assembly { // <= FOUND
914:             if shr(249, x) {
915:                 mstore(0x00, 0xce30380c)  // <= FOUND
916:                 revert(0x1c, 0x04)
917:             }
918:             packed := or(shl(7, x), packed)
919:         }
```
['[209](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L209-L213)']
```solidity
209:             assembly { // <= FOUND
210:                 
211:                 
212:                 if iszero(slt(x, 135305999368893231589)) {
213:                     mstore(0x00, 0xa37bfec9)  // <= FOUND
214:                     revert(0x1c, 0x04)
215:                 }
216:             }
```


</details>

## [Low-14] Empty receive functions can cause gas issues

### Resolution 
In Solidity, functions that receive Ether without corresponding functionality to utilize or withdraw these funds can inadvertently lead to a permanent loss of value. This is because if someone sends Ether to the contract, they may be unable to retrieve it. To avoid this, functions receiving Ether should be accompanied by additional methods that process or allow the withdrawal of these funds. If the intent is to use the received Ether, it should trigger a separate function; if not, it should revert the transaction (for instance, via `require(msg.sender == address(weth))`). Access control checks can also prevent unintended Ether transfers, despite the slight gas cost they entail. If concerns over gas costs persist, at minimum, include a rescue function to recover unused Ether. Missteps in handling Ether in smart contracts can lead to irreversible financial losses, hence these precautions are crucial.

Num of instances: 1

### Findings 


<details><summary>Click to show findings</summary>

['[247](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L247-L247)']
```solidity
247:     receive() external payable {}
```


</details>

## [Low-15] Upgradable contracts should have a __gap variable

### Resolution 
This is to ensure the team can add new state variables without compromising compatability.

Num of instances: 5

### Findings 


<details><summary>Click to show findings</summary>

['[18](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L18-L18)']
```solidity
18: contract KuruAMMVault is IKuruAMMVault, ERC20, Initializable, UUPSUpgradeable, ReentrancyGuardTransient 
```
['[16](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruForwarder.sol#L16-L16)']
```solidity
16: contract KuruForwarder is EIP712, Initializable, Ownable, UUPSUpgradeable 
```
['[17](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L17-L17)']
```solidity
17: contract MarginAccount is IMarginAccount, ERC2771Context, Ownable, Initializable, UUPSUpgradeable 
```
['[20](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L20-L20)']
```solidity
20: contract OrderBook is Initializable, UUPSUpgradeable, ERC2771Context, AbstractAMM 
```
['[23](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L23-L23)']
```solidity
23: contract Router is IRouter, Ownable, Initializable, UUPSUpgradeable 
```


</details>

## [Low-16] The call tx.origin should not be used in any case besides in functionality to determine if a sender account is a EOA account or not as it's value can be manipulated to break access control

### Resolution 
Msg.sender should be used in place of tx.origin in Solidity contracts to ensure security and prevent potential attacks. While tx.origin refers to the original sender of a transaction, msg.sender refers to the immediate sender, which could be a smart contract. Using tx.origin exposes a contract to potential reentrancy attacks, as a malicious contract can masquerade as the original user and exploit vulnerabilities in the target contract. By utilizing msg.sender, developers can accurately identify the immediate sender and implement access control mechanisms, thereby mitigating risks and ensuring a more secure and reliable smart contract execution.

Num of instances: 1

### Findings 


<details><summary>Click to show findings</summary>

['[1217](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L1217-L1217)']
```solidity
1217:         emit Trade(orderId, makerAddress, isBuy, price, updatedSize, _msgSender(), tx.origin, filledSize); // <= FOUND
```


</details>

## [Low-17] Token supply should not be centralised at deployment

### Resolution 
Avoid minting tokens to a single address on deployment, rather have them distributed as intended within the constructor (i.e liquidity pools)

Num of instances: 1

### Findings 


<details><summary>Click to show findings</summary>

['[12](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/periphery/ERC20.sol#L12-L16)']
```solidity
12:     constructor(string memory name_, string memory symbol_, uint256 initialSupply_, address mintRecipient_) {
13:         _name = name_;
14:         _symbol = symbol_;
15:         
16:         _mint(mintRecipient_, initialSupply_); // <= FOUND
17:     }
```


</details>

## [Low-18] Use SafeCast to safely downcast variables

### Resolution 
Downcasting int/uints in Solidity can be unsafe due to the potential for data loss and unintended behavior. When downcasting a larger integer type to a smaller one (e.g., uint256 to uint128), the value may exceed the range of the target type, leading to truncation and loss of significant digits. This data loss can result in unexpected state changes, incorrect calculations, or other contract vulnerabilities, ultimately compromising the contracts functionality and reliability. To prevent these risks, developers should carefully consider the range of values their variables may hold and ensure that proper checks are in place to prevent out-of-range values before performing downcasting. Also consider using OZ SafeCast functionality.

Num of instances: 2

### Findings 


<details><summary>Click to show findings</summary>

['[108](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/TreeMath.sol#L108-L112)']
```solidity
108:     function findFirstRight(TreeUint32 storage tree, uint32 id) internal view returns (uint32) { // <= FOUND
109:         bytes32 leaves;
110: 
111:         bytes32 key3 = bytes32(uint256(id) >> 8);
112:         uint8 bit = uint8(id & type(uint8).max); // <= FOUND
113: 
114:         if (bit != 0) {
115:             leaves = tree.level3[key3];
116:             uint256 closestBit = _closestBitRight(leaves, bit);
117: 
118:             if (closestBit != type(uint256).max) return uint32((uint256(key3) << 8) | closestBit);
119:         }
120: 
121:         bytes32 key2 = key3 >> 8;
122:         bit = uint8(uint256(key3) & type(uint8).max);
123: 
124:         if (bit != 0) {
125:             leaves = tree.level2[key2];
126:             uint256 closestBit = _closestBitRight(leaves, bit);
127: 
128:             if (closestBit != type(uint256).max) {
129:                 key3 = bytes32((uint256(key2) << 8) | closestBit);
130:                 leaves = tree.level3[key3];
131: 
132:                 return uint32((uint256(key3) << 8) | uint256(leaves).mostSignificantBit());
133:             }
134:         }
135: 
136:         bytes32 key1 = key2 >> 8;
137:         bit = uint8(uint256(key2) & type(uint8).max);
138: 
139:         if (bit != 0) {
140:             leaves = tree.level1[key1];
141:             uint256 closestBit = _closestBitRight(leaves, bit);
142: 
143:             if (closestBit != type(uint256).max) {
144:                 key2 = bytes32((uint256(key1) << 8) | closestBit);
145:                 leaves = tree.level2[key2];
146: 
147:                 key3 = bytes32((uint256(key2) << 8) | uint256(leaves).mostSignificantBit());
148:                 leaves = tree.level3[key3];
149: 
150:                 return uint32((uint256(key3) << 8) | uint256(leaves).mostSignificantBit());
151:             }
152:         }
153: 
154:         bit = uint8(uint256(key1) & type(uint8).max);
155: 
156:         if (bit != 0) {
157:             leaves = tree.level0;
158:             uint256 closestBit = _closestBitRight(leaves, bit);
159: 
160:             if (closestBit != type(uint256).max) {
161:                 key1 = bytes32(closestBit);
162:                 leaves = tree.level1[key1];
163: 
164:                 key2 = bytes32((uint256(key1) << 8) | uint256(leaves).mostSignificantBit());
165:                 leaves = tree.level2[key2];
166: 
167:                 key3 = bytes32((uint256(key2) << 8) | uint256(leaves).mostSignificantBit());
168:                 leaves = tree.level3[key3];
169: 
170:                 return uint32((uint256(key3) << 8) | uint256(leaves).mostSignificantBit());
171:             }
172:         }
173: 
174:         return type(uint32).max;
175:     }
```
['[184](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/TreeMath.sol#L184-L188)']
```solidity
184:     function findFirstLeft(TreeUint32 storage tree, uint32 id) internal view returns (uint32) { // <= FOUND
185:         bytes32 leaves;
186: 
187:         bytes32 key3 = bytes32(uint256(id) >> 8);
188:         uint8 bit = uint8(id & type(uint8).max); // <= FOUND
189: 
190:         if (bit != type(uint8).max) {
191:             leaves = tree.level3[key3];
192:             uint256 closestBit = _closestBitLeft(leaves, bit);
193: 
194:             if (closestBit != type(uint256).max) return uint32((uint256(key3) << 8) | closestBit);
195:         }
196: 
197:         bytes32 key2 = key3 >> 8;
198:         bit = uint8(uint256(key3) & type(uint8).max);
199: 
200:         if (bit != type(uint8).max) {
201:             leaves = tree.level2[key2];
202:             uint256 closestBit = _closestBitLeft(leaves, bit);
203: 
204:             if (closestBit != type(uint256).max) {
205:                 key3 = bytes32((uint256(key2) << 8) | closestBit);
206:                 leaves = tree.level3[key3];
207: 
208:                 return uint32((uint256(key3) << 8) | uint256(leaves).leastSignificantBit());
209:             }
210:         }
211: 
212:         bytes32 key1 = key2 >> 8;
213:         bit = uint8(uint256(key2) & type(uint8).max);
214: 
215:         if (bit != type(uint8).max) {
216:             leaves = tree.level1[key1];
217:             uint256 closestBit = _closestBitLeft(leaves, bit);
218: 
219:             if (closestBit != type(uint256).max) {
220:                 key2 = bytes32((uint256(key1) << 8) | closestBit);
221:                 leaves = tree.level2[key2];
222: 
223:                 key3 = bytes32((uint256(key2) << 8) | uint256(leaves).leastSignificantBit());
224:                 leaves = tree.level3[key3];
225: 
226:                 return uint32((uint256(key3) << 8) | uint256(leaves).leastSignificantBit());
227:             }
228:         }
229: 
230:         bit = uint8(uint256(key1) & type(uint8).max);
231: 
232:         if (bit != type(uint8).max) {
233:             leaves = tree.level0;
234:             uint256 closestBit = _closestBitLeft(leaves, bit);
235: 
236:             if (closestBit != type(uint256).max) {
237:                 key1 = bytes32(closestBit);
238:                 leaves = tree.level1[key1];
239: 
240:                 key2 = bytes32((uint256(key1) << 8) | uint256(leaves).leastSignificantBit());
241:                 leaves = tree.level2[key2];
242: 
243:                 key3 = bytes32((uint256(key2) << 8) | uint256(leaves).leastSignificantBit());
244:                 leaves = tree.level3[key3];
245: 
246:                 return uint32((uint256(key3) << 8) | uint256(leaves).leastSignificantBit());
247:             }
248:         }
249: 
250:         return 0;
251:     }
```


</details>

## [Low-19] The nonReentrant modifier should be first in a function declaration

### Resolution 
In Solidity, the `nonReentrant` modifier is essential for securing smart contracts against reentrancy attacks. It should be positioned first in a function declaration. This placement is critical because it ensures that the modifier's protection is applied before any other code or modifiers in the function. If placed later, other modifiers could potentially be executed in a reentrant manner before `nonReentrant` has a chance to lock the function, leaving the contract vulnerable. Thus, prioritizing `nonReentrant` as the first modifier is a best practice for robust smart contract security, effectively guarding against unintended reentries and related exploits.

Num of instances: 8

### Findings 


<details><summary>Click to show findings</summary>

['[300](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/AbstractAMM.sol#L300-L306)']
```solidity
300:     function updateVaultOrdSz(
301:         uint96 _vaultAskOrderSize,
302:         uint96 _vaultBidOrderSize,
303:         uint256 _askPrice,
304:         uint256 _bidPrice,
305:         bool _nullifyPartialFills
306:     ) external onlyVault nonReentrant marketNotHardPaused { // <= FOUND
307:         vaultBidOrderSize = _vaultBidOrderSize;
308:         vaultAskOrderSize = _vaultAskOrderSize;
309: 
310:         if (_nullifyPartialFills) {
311:             askPartiallyFilledSize = 0;
312:             bidPartiallyFilledSize = 0;
313:         }
314: 
315:         if (vaultBestAsk == type(uint256).max) {
316:             vaultBestAsk = _askPrice;
317:         }
318:         if (vaultBestBid == 0) {
319:             vaultBestBid = _bidPrice;
320:         }
321:         emit VaultParamsUpdated(
322:             _vaultAskOrderSize,
323:             askPartiallyFilledSize,
324:             _vaultBidOrderSize,
325:             bidPartiallyFilledSize,
326:             vaultBestAsk,
327:             vaultBestBid
328:         );
329:     }
```
['[169](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L169-L169)']
```solidity
169:     function addBuyOrder(uint32 _price, uint96 size, bool _postOnly) public marketActive nonReentrant { // <= FOUND
170:         require(_price > 0 && _price < type(uint32).max, OrderBookErrors.PriceError());
171:         require(size > minSize, OrderBookErrors.SizeError());
172:         require(size < maxSize, OrderBookErrors.SizeError());
173:         require(_price % tickSize == 0, OrderBookErrors.TickSizeError());
174: 
175:         
176:         (uint96 _remainingSize, uint96 _consumedFunds) = _matchAggressiveBuyWithCap(uint256(_price), size);
177: 
178:         _consumedFunds += _quoteAmountRoundedUp(_price, _remainingSize);
179: 
180:         _consumeFunds(quoteAsset, (((_consumedFunds) * quoteDecimalMultiplier) / pricePrecision), _msgSender());
181:         if (_postOnly) {
182:             require(size == _remainingSize, OrderBookErrors.PostOnlyError());
183:         }
184:         if (_remainingSize == 0) {
185:             return;
186:         } else {
187:             uint40 _orderId = s_orderIdCounter + 1;
188:             s_orderIdCounter = _orderId;
189: 
190:             
191:             uint40 _prevOrderId = OrderLinkedList.insertAtTail(s_buyPricePoints[_price], _orderId);
192: 
193:             _addOrder(_price, _remainingSize, _orderId, true, _prevOrderId);
194:         }
195:     }
```
['[205](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L205-L208)']
```solidity
205:     function addFlipBuyOrder(uint32 _price, uint32 _flippedPrice, uint96 _size, bool _provisionOrRevert)
206:         public
207:         marketActive
208:         nonReentrant // <= FOUND
209:     {
210:         require(_price > 0 && _flippedPrice > 0 && _flippedPrice < type(uint32).max, OrderBookErrors.PriceError());
211:         require(_price % tickSize == 0 && _flippedPrice % tickSize == 0, OrderBookErrors.TickSizeError());
212:         require(_price < _flippedPrice, OrderBookErrors.PriceError());
213:         require(_size > minSize && _size < maxSize, OrderBookErrors.SizeError());
214: 
215:         {
216:             (, uint256 _bestAsk) = bestAsk();
217:             if ((uint256(_price) * vaultPricePrecision / pricePrecision) >= _bestAsk && _bestAsk != 0) {
218:                 if (_provisionOrRevert) {
219:                     revert OrderBookErrors.ProvisionError();
220:                 } else {
221:                     return;
222:                 }
223:             }
224:         }
225:         _consumeFunds(
226:             quoteAsset, _quoteAmountRoundedUp(_price, _size) * quoteDecimalMultiplier / pricePrecision, _msgSender()
227:         );
228: 
229:         uint40 _orderId = s_orderIdCounter + 1;
230:         s_orderIdCounter = _orderId;
231:         uint40 _prevOrderId = OrderLinkedList.insertAtTail(s_buyPricePoints[_price], _orderId);
232:         _addFlipOrder(_price, _flippedPrice, _size, _msgSender(), _orderId, OrderLinkedList.NULL, true, _prevOrderId);
233:     }
```
['[241](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L241-L241)']
```solidity
241:     function addSellOrder(uint32 _price, uint96 _size, bool _postOnly) public marketActive nonReentrant { // <= FOUND
242:         require(_size > minSize, OrderBookErrors.SizeError());
243:         require(_size < maxSize, OrderBookErrors.SizeError());
244:         require(_price % tickSize == 0, OrderBookErrors.TickSizeError());
245:         require(_price > 0 && _price < type(uint32).max, OrderBookErrors.PriceError());
246: 
247:         _consumeFunds(baseAsset, ((_size * baseDecimalMultiplier) / sizePrecision), _msgSender());
248: 
249:         
250:         
251:         (uint96 _remainingSize,) = _matchAggressiveSell(uint256(_price), _size, true);
252:         if (_postOnly) {
253:             require(_remainingSize == _size, OrderBookErrors.PostOnlyError());
254:         }
255: 
256:         if (_remainingSize == 0) {
257:             return;
258:         } else {
259:             uint40 _orderId = s_orderIdCounter + 1;
260:             s_orderIdCounter = _orderId;
261:             
262:             uint40 _prevOrderId = OrderLinkedList.insertAtTail(s_sellPricePoints[_price], _orderId);
263:             _addOrder(_price, _remainingSize, _orderId, false, _prevOrderId);
264:         }
265:     }
```
['[275](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L275-L278)']
```solidity
275:     function addFlipSellOrder(uint32 _price, uint32 _flippedPrice, uint96 _size, bool _provisionOrRevert)
276:         public
277:         marketActive
278:         nonReentrant // <= FOUND
279:     {
280:         require(_price > 0 && _flippedPrice > 0 && _price < type(uint32).max, OrderBookErrors.PriceError());
281:         require(_price % tickSize == 0 && _flippedPrice % tickSize == 0, OrderBookErrors.TickSizeError());
282:         require(_price > _flippedPrice, OrderBookErrors.PriceError());
283:         require(_size > minSize && _size < maxSize, OrderBookErrors.SizeError());
284: 
285:         {
286:             (, uint256 _bestBid) = bestBid();
287:             if ((uint256(_price) * vaultPricePrecision / pricePrecision) <= _bestBid && _bestBid != type(uint256).max) {
288:                 if (_provisionOrRevert) {
289:                     revert OrderBookErrors.ProvisionError();
290:                 } else {
291:                     return;
292:                 }
293:             }
294:         }
295: 
296:         _consumeFunds(baseAsset, _size * baseDecimalMultiplier / sizePrecision, _msgSender());
297:         uint40 _orderId = s_orderIdCounter + 1;
298:         s_orderIdCounter = _orderId;
299:         uint40 _prevOrderId = OrderLinkedList.insertAtTail(s_sellPricePoints[_price], _orderId);
300:         _addFlipOrder(_price, _flippedPrice, _size, _msgSender(), _orderId, OrderLinkedList.NULL, false, _prevOrderId);
301:     }
```
['[311](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L311-L314)']
```solidity
311:     function addPairedLiquidity(uint32 _bidPrice, uint32 _askPrice, uint96 _bidSize, uint96 _askSize)
312:         public
313:         marketActive
314:         nonReentrant // <= FOUND
315:     {
316:         require(_bidPrice > 0 && _askPrice > _bidPrice && _askPrice < type(uint32).max, OrderBookErrors.PriceError());
317:         require(_bidPrice % tickSize == 0 && _askPrice % tickSize == 0, OrderBookErrors.TickSizeError());
318:         require(_bidSize > minSize && _bidSize < maxSize, OrderBookErrors.SizeError());
319:         require(_askSize > minSize && _askSize < maxSize, OrderBookErrors.SizeError());
320:         {
321:             (, uint256 _bestBid) = bestBid();
322:             (, uint256 _bestAsk) = bestAsk();
323:             require(
324:                 ((uint256(_bidPrice) * vaultPricePrecision / pricePrecision) < _bestAsk) || (_bestAsk == 0),
325:                 OrderBookErrors.ProvisionError()
326:             );
327:             require(
328:                 ((uint256(_askPrice) * vaultPricePrecision / pricePrecision) > _bestBid)
329:                     || (_bestBid == type(uint256).max),
330:                 OrderBookErrors.ProvisionError()
331:             );
332:         }
333: 
334:         _consumeFunds(
335:             quoteAsset,
336:             _quoteAmountRoundedUp(_bidPrice, _bidSize) * quoteDecimalMultiplier / pricePrecision,
337:             _msgSender()
338:         );
339:         _consumeFunds(baseAsset, _askSize * baseDecimalMultiplier / sizePrecision, _msgSender());
340: 
341:         uint40 _bidOrderId = s_orderIdCounter + 1;
342:         uint40 _askOrderId = _bidOrderId + 1;
343:         s_orderIdCounter = _askOrderId;
344: 
345:         uint40 _bidPrevOrderId = OrderLinkedList.insertAtTail(s_buyPricePoints[_bidPrice], _bidOrderId);
346:         uint40 _askPrevOrderId = OrderLinkedList.insertAtTail(s_sellPricePoints[_askPrice], _askOrderId);
347:         _addFlipOrder(_bidPrice, _askPrice, _bidSize, _msgSender(), _bidOrderId, _askOrderId, true, _bidPrevOrderId);
348:         _addFlipOrder(_askPrice, _bidPrice, _askSize, _msgSender(), _askOrderId, _bidOrderId, false, _askPrevOrderId);
349:     }
```
['[728](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L728-L733)']
```solidity
728:     function placeAndExecuteMarketBuy(uint96 _quoteSize, uint256 _minAmountOut, bool _isMargin, bool _isFillOrKill)
729:         public
730:         payable
731:         override
732:         marketActive
733:         nonReentrant // <= FOUND
734:         returns (uint256)
735:     {
736:         OrderBookType _type = orderBookType;
737: 
738:         if (_type == OrderBookType.NATIVE_IN_QUOTE && !_isMargin && (msg.sender != address(0))) {
739:             require(
740:                 msg.value >= _pricePrecisionToQuoteAssetPrecision(_quoteSize), OrderBookErrors.NativeAssetInsufficient()
741:             );
742:             require(
743:                 msg.value < _pricePrecisionToQuoteAssetPrecision(_quoteSize + 1), OrderBookErrors.NativeAssetSurplus()
744:             );
745:         } else if (msg.sender != address(0)) {
746:             require(msg.value == 0, OrderBookErrors.NativeAssetNotRequired());
747:             _isMargin
748:                 ? marginAccount.debitUser(_msgSender(), quoteAsset, _pricePrecisionToQuoteAssetPrecision(_quoteSize))
749:                 : quoteAsset.safeTransferFrom(
750:                     _msgSender(), address(marginAccount), _pricePrecisionToQuoteAssetPrecision(_quoteSize)
751:                 );
752:         }
753: 
754:         uint256 _baseTokensCredited;
755:         (_quoteSize, _baseTokensCredited) = _marketBuyMatch(_quoteSize, _isMargin);
756:         if (msg.sender == address(0)) {
757:             return _baseTokensCredited;
758:         }
759:         if (_quoteSize > 0) {
760:             require(!_isFillOrKill, OrderBookErrors.InsufficientLiquidity());
761:             if (_type == OrderBookType.NATIVE_IN_QUOTE && !_isMargin) {
762:                 
763:                 uint256 _refund = _pricePrecisionToQuoteAssetPrecision(_quoteSize);
764:                 _handleNativeMarketRefundTransfer(_refund);
765:             } else {
766:                 marginAccount.creditUser(
767:                     _msgSender(), quoteAsset, _pricePrecisionToQuoteAssetPrecision(_quoteSize), _isMargin
768:                 );
769:             }
770:         } else if (_type == OrderBookType.NATIVE_IN_QUOTE) {
771:             address(marginAccount).safeTransferETH(msg.value);
772:         }
773:         require(_baseTokensCredited >= _minAmountOut, OrderBookErrors.SlippageExceeded());
774: 
775:         return _baseTokensCredited;
776:     }
```
['[786](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L786-L790)']
```solidity
786:     function placeAndExecuteMarketSell(uint96 _size, uint256 _minAmountOut, bool _isMargin, bool _isFillOrKill)
787:         public
788:         payable
789:         marketActive
790:         nonReentrant // <= FOUND
791:         returns (uint256)
792:     {
793:         OrderBookType _type = orderBookType;
794:         if (_type == OrderBookType.NATIVE_IN_BASE && !_isMargin && (msg.sender != address(0))) {
795:             require(msg.value >= _sizePrecisionToBaseAssetPrecision(_size), OrderBookErrors.NativeAssetInsufficient());
796:             require(msg.value < _sizePrecisionToBaseAssetPrecision(_size + 1), OrderBookErrors.NativeAssetSurplus());
797:         } else if (msg.sender != address(0)) {
798:             require(msg.value == 0, OrderBookErrors.NativeAssetNotRequired());
799:             _isMargin
800:                 ? marginAccount.debitUser(_msgSender(), baseAsset, _sizePrecisionToBaseAssetPrecision(_size))
801:                 : baseAsset.safeTransferFrom(
802:                     _msgSender(), address(marginAccount), _sizePrecisionToBaseAssetPrecision(_size)
803:                 );
804:         }
805: 
806:         uint256 _quoteCredited;
807:         (_size, _quoteCredited) = _matchAggressiveSell(0, _size, _isMargin);
808:         if (msg.sender == address(0)) {
809:             return _quoteCredited;
810:         }
811:         if (_size > 0) {
812:             require(!_isFillOrKill, OrderBookErrors.InsufficientLiquidity());
813:             if (_type == OrderBookType.NATIVE_IN_BASE && !_isMargin) {
814:                 uint256 _refund = _sizePrecisionToBaseAssetPrecision(_size);
815:                 _handleNativeMarketRefundTransfer(_refund);
816:             } else {
817:                 marginAccount.creditUser(_msgSender(), baseAsset, _sizePrecisionToBaseAssetPrecision(_size), _isMargin);
818:             }
819:         } else if (_type == OrderBookType.NATIVE_IN_BASE) {
820:             address(marginAccount).safeTransferETH(msg.value);
821:         }
822:         require(_quoteCredited >= _minAmountOut, OrderBookErrors.SlippageExceeded());
823:         return _quoteCredited;
824:     }
```


</details>

## [Low-20] Initializer function can be front run

### Resolution 
In Solidity contract deployment, not making the initialize() function call atomic with the contract creation can leave a vulnerability window. A malicious actor could exploit this time gap and call initialize() before the intended initialization. This action could disrupt the contract's setup, potentially necessitating a full contract re-deployment to ensure proper initialization. To mitigate such risks, it's advised to use a factory contract. This factory contract can be programmed to deploy and initialize a new contract in a single atomic transaction, closing the window of vulnerability and ensuring correct and secure contract initialization.

Num of instances: 5

### Findings 


<details><summary>Click to show findings</summary>

['[45](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L45-L52)']
```solidity
45:     function initialize(
46:         address _owner,
47:         address token1_,
48:         address token2_,
49:         address _marginAccount,
50:         address _market,
51:         uint96 _spreadConstant
52:     ) public initializer  // <= FOUND
```
['[96](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruForwarder.sol#L96-L96)']
```solidity
96:     function initialize(address _owner, bytes4[] memory _allowedInterfaces) public initializer  // <= FOUND
```
[]
```solidity
76:     function initialize(address _owner, address _router, address _feeCollector, address _trustedForwarder)
77:         public
78:         initializer
79:     
```
['[85](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L85-L103)']
```solidity
85:     function initialize(
86:         address _owner,
87:         OrderBookType _type,
88:         address _baseAssetAddress,
89:         uint256 _baseAssetDecimals,
90:         address _quoteAssetAddress,
91:         uint256 _quoteAssetDecimals,
92:         address _marginAccountAddress,
93:         uint96 _sizePrecision,
94:         uint32 _pricePrecision,
95:         uint32 _tickSize,
96:         uint96 _minSize,
97:         uint96 _maxSize,
98:         uint256 _takerFeeBps,
99:         uint256 _makerFeeBps,
100:         address _kuruAmmVault,
101:         uint96 _kuruAmmSpread,
102:         address __trustedForwarder
103:     ) public initializer  // <= FOUND
```
['[45](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L45-L51)']
```solidity
45:     function initialize(
46:         address _owner,
47:         address _marginAccount,
48:         address _orderbookImplementation,
49:         address _kuruAmmVaultImplementation,
50:         address _trustedForwarder
51:     ) public initializer  // <= FOUND
```


</details>

## [Low-21] The function decimals() is not part of the ERC20 standard

### Resolution 
The `decimals()` function in an ERC20 token contract is used to specify how many decimal places the token can be divided into. However, it should be used with caution because not all ERC20 token contracts implement `decimals()`, and the function isn't required by the ERC20 standard. Calling `decimals()` on a contract that doesn't implement it will result in a runtime error. Moreover, even when implemented, the returned value can be manipulated or artificially set, which may cause unexpected behavior. Therefore, always verify the decimal count independently if precision is crucial for your contract logic. When interacting with other ERC20 tokens, consider implementing safeguards or checks to handle potential errors from calling `decimals()`.

Num of instances: 4

### Findings 


<details><summary>Click to show findings</summary>

['[55](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L55-L55)']
```solidity
55:         token1Decimals = token1_ != address(0) ? ERC20(token1_).decimals() : 18; // <= FOUND
```
['[57](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L57-L57)']
```solidity
57:         token2Decimals = token2_ != address(0) ? ERC20(token2_).decimals() : 18; // <= FOUND
```
['[101](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L101-L102)']
```solidity
101:         uint256 _baseAssetDecimals =
102:             _type == IOrderBook.OrderBookType.NATIVE_IN_BASE ? 18 : IERC20Metadata(_baseAssetAddress).decimals(); // <= FOUND
```
['[103](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L103-L104)']
```solidity
103:         uint256 _quoteAssetDecimals =
104:             _type == IOrderBook.OrderBookType.NATIVE_IN_QUOTE ? 18 : IERC20Metadata(_quoteAssetAddress).decimals(); // <= FOUND
```


</details>

## [Low-22] No limits when setting fees

### Resolution 
When settings fees state variables, ensure there a require checks in place to prevent incorrect values from being set. This is particularly important when dealing with fee values as without checks fees can be set to 100%

Num of instances: 1

### Findings 


<details><summary>Click to show findings</summary>

['[113](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/periphery/MonadDeployer.sol#L113-L113)']
```solidity
113:     function setKuruCollectiveFee(uint256 _kuruCollectiveFee) external onlyOwner {
114:         kuruCollectiveFee = _kuruCollectiveFee;
115:     }
```


</details>

## [Low-23] Loss of precision

### Resolution 
Dividing by large numbers in Solidity can cause a loss of precision due to the language's inherent integer division behavior. Solidity does not support floating-point arithmetic, and as a result, division between integers yields an integer result, truncating any fractional part. When dividing by a large number, the resulting value may become significantly smaller, leading to a loss of precision, as the fractional part is discarded.

Num of instances: 7

### Findings 


<details><summary>Click to show findings</summary>

['[431](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L431-L433)']
```solidity
431:     function _getVaultSizesForBaseAmount(uint256 _baseAmount) internal view returns (uint96, uint96) { // <= FOUND
432:         MarketParams memory _marketParams = marketParams;
433:         uint96 _newAskSize = toU96( // <= FOUND
434:             (SPREAD_CONSTANT * _baseAmount * _marketParams.sizePrecision)
435:                 / ((DOUBLE_BPS_MULTIPLIER + SPREAD_CONSTANT) * 10 ** _marketParams.baseAssetDecimals)
436:         );
437:         uint96 _newBidSize = toU96(
438:             (SPREAD_CONSTANT * _baseAmount * _marketParams.sizePrecision)
439:                 / (DOUBLE_BPS_MULTIPLIER * 10 ** _marketParams.baseAssetDecimals)
440:         );
441:         return (_newAskSize, _newBidSize);
442:     }
```
['[444](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L444-L450)']
```solidity
444:     function _returnVirtuallyRebalancedTotalAssets(uint256 _reserve1, uint256 _reserve2, uint256 _vaultPrice) // <= FOUND
445:         internal
446:         view
447:         returns (uint256, uint256)
448:     {
449:         MarketParams memory _marketParams = marketParams;
450:         uint256 _halfTotalValuationInQuote = ( // <= FOUND
451:             (_reserve1 * _vaultPrice * 10 ** _marketParams.quoteAssetDecimals)
452:                 / (10 ** _marketParams.baseAssetDecimals * vaultPricePrecision) + _reserve2
453:         ) / 2;
454:         uint256 _rebalancedBaseAsset = (
455:             _halfTotalValuationInQuote * vaultPricePrecision * 10 ** _marketParams.baseAssetDecimals
456:         ) / (10 ** _marketParams.quoteAssetDecimals * _vaultPrice);
457:         return (_rebalancedBaseAsset, _halfTotalValuationInQuote);
458:     }
```
['[531](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L531-L569)']
```solidity
531:     function _executeCancel(uint40 _orderId, Order memory _order) internal { // <= FOUND
532:         
533:         if (_order.prev != OrderLinkedList.NULL) {
534:             s_orders[_order.prev].next = _order.next;
535:         }
536:         if (_order.next != OrderLinkedList.NULL) {
537:             s_orders[_order.next].prev = _order.prev;
538:         }
539: 
540:         if (_order.isBuy) {
541:             
542:             if (_orderId == s_buyPricePoints[_order.price].head) {
543:                 OrderLinkedList.updateHead(s_buyPricePoints[_order.price], _order.next);
544:                 if (_order.next == OrderLinkedList.NULL) {
545:                     
546:                     TreeMath.remove(s_buyTree, _order.price);
547:                 }
548:             } else {
549:                 OrderLinkedList.adjustForTail(s_buyPricePoints[_order.price], _order.prev, _order.next);
550:             }
551: 
552:             marginAccount.creditUser( // <= FOUND
553:                 _order.ownerAddress,
554:                 quoteAsset,
555:                 (((toU96((_order.size * _order.price) / sizePrecision) * quoteDecimalMultiplier) / pricePrecision)),
556:                 true
557:             );
558:         } else {
559:             if (_orderId == s_sellPricePoints[_order.price].head) {
560:                 OrderLinkedList.updateHead(s_sellPricePoints[_order.price], _order.next);
561:                 if (_order.next == OrderLinkedList.NULL) {
562:                     
563:                     TreeMath.remove(s_sellTree, _order.price);
564:                 }
565:             } else {
566:                 OrderLinkedList.adjustForTail(s_sellPricePoints[_order.price], _order.prev, _order.next);
567:             }
568: 
569:             marginAccount.creditUser( // <= FOUND
570:                 _order.ownerAddress, baseAsset, ((_order.size * baseDecimalMultiplier) / sizePrecision), true
571:             );
572:         }
573: 
574:         emit OrderCanceled(_orderId, _order.ownerAddress, _order.price, _order.size, _order.isBuy);
575:     }
```
['[835](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L835-L836)']
```solidity
835:     function _pricePrecisionToQuoteAssetPrecision(uint96 _quote) internal view returns (uint256) { // <= FOUND
836:         return (uint256(_quote) * quoteDecimalMultiplier) / pricePrecision; // <= FOUND
837:     }
```
['[839](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L839-L840)']
```solidity
839:     function _sizePrecisionToBaseAssetPrecision(uint96 _size) internal view returns (uint256) { // <= FOUND
840:         return (uint256(_size) * baseDecimalMultiplier) / sizePrecision; // <= FOUND
841:     }
```
['[1269](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L1269-L1270)']
```solidity
1269:     function _quoteAmountRoundedDown(uint256 _size, uint32 _price) internal view returns (uint256) { // <= FOUND
1270:         return ((_price * _size) / sizePrecision) * quoteDecimalMultiplier / pricePrecision; // <= FOUND
1271:     }
```
['[1345](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L1345-L1348)']
```solidity
1345:     function _getOBBid() internal view returns (uint256) { // <= FOUND
1346:         uint32 firstRight = TreeMath.findFirstRight(s_buyTree, type(uint32).max);
1347:         if (firstRight != type(uint32).max) {
1348:             return firstRight * vaultPricePrecision / pricePrecision; // <= FOUND
1349:         }
1350:         return 0;
1351:     }
```


</details>

## [Low-24] Missing zero address check in constructor

### Resolution 
In Solidity, constructors often take address parameters to initialize important components of a contract, such as owner or linked contracts. However, without a check, there's a risk that an address parameter could be mistakenly set to the zero address (0x0). This could occur due to a mistake or oversight during contract deployment. A zero address in a crucial role can cause serious issues, as it cannot perform actions like a normal address, and any funds sent to it are irretrievable. Therefore, it's crucial to include a zero address check in constructors to prevent such potential problems. If a zero address is detected, the constructor should revert the transaction.

Num of instances: 2

### Findings 


<details><summary>Click to show findings</summary>

['[12](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/periphery/ERC20.sol#L12-L12)']
```solidity
12:     constructor(string memory name_, string memory symbol_, uint256 initialSupply_, address mintRecipient_) { // <= FOUND
13:         _name = name_;
14:         _symbol = symbol_;
15:         
16:         _mint(mintRecipient_, initialSupply_);
17:     }
```
['[49](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/periphery/MonadDeployer.sol#L49-L53)']
```solidity
49:     constructor(
50:         IRouter _router,
51:         address _owner, // <= FOUND
52:         address _marginAccount, // <= FOUND
53:         address _kuruCollective, // <= FOUND
54:         uint96 _kuruAmmSpread,
55:         uint256 _kuruCollectiveFee
56:     ) {
57:         _initializeOwner(_owner);
58:         router = _router;
59:         marginAccount = IMarginAccount(_marginAccount);
60:         kuruAmmSpread = _kuruAmmSpread;
61:         kuruCollective = _kuruCollective;
62:         kuruCollectiveFee = _kuruCollectiveFee;
63:     }
```


</details>

## [Low-25] Return values of transfer()/transferFrom() not checked

### Resolution 
In Solidity, it's crucial to check the return value of `.transfer` and `.transferFrom` methods because not all ERC20 and ERC721 token implementations revert on failure. Notably, If these methods fail silently and the contract doesn't verify their return value, the contract might continue execution as if the tokens were transferred successfully, leading to incorrect balances, loss of funds, or other unexpected behaviors. Therefore, the return values of these methods should always be checked, ensuring a failed token transfer operation correctly halts the execution of the contract.

Num of instances: 1

### Findings 


<details><summary>Click to show findings</summary>

['[65](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/periphery/MonadDeployer.sol#L65-L93)']
```solidity
65:     function deployTokenAndMarket( // <= FOUND
66:         TokenParams memory tokenParams,
67:         MarketParams memory marketParams,
68:         bytes calldata metadata
69:     ) external payable returns (address market) {
70:         KuruERC20 token = new KuruERC20(tokenParams.name, tokenParams.symbol, tokenParams.initialSupply, address(this));
71:         market = router.deployProxy(
72:             IOrderBook.OrderBookType.NATIVE_IN_QUOTE,
73:             address(token),
74:             address(0),
75:             marketParams.sizePrecision,
76:             marketParams.pricePrecision,
77:             marketParams.tickSize,
78:             marketParams.minSize,
79:             marketParams.maxSize,
80:             marketParams.takerFeeBps,
81:             marketParams.makerFeeBps,
82:             kuruAmmSpread
83:         );
84:         if (msg.value != (marketParams.nativeTokenAmount + kuruCollectiveFee)) {
85:             revert InsufficientAssets(marketParams.nativeTokenAmount + kuruCollectiveFee, msg.value);
86:         }
87:         (address vault,,,,,,,) = IOrderBook(market).getVaultParams();
88:         uint256 _supplyToVault = tokenParams.initialSupply * (10 ** 4 - tokenParams.supplyToDev) / 10 ** 4;
89:         token.approve(vault, _supplyToVault);
90:         IKuruAMMVault(vault).deposit{value: marketParams.nativeTokenAmount}(
91:             _supplyToVault, marketParams.nativeTokenAmount, address(this)
92:         );
93:         token.transfer(tokenParams.dev, tokenParams.initialSupply - _supplyToVault); // <= FOUND
94:         marginAccount.deposit{value: kuruCollectiveFee}(kuruCollective, address(0), kuruCollectiveFee);
95:         emit PumpingTime(
96:             address(token),
97:             tokenParams.tokenURI,
98:             tokenParams.dev,
99:             tokenParams.initialSupply - _supplyToVault,
100:             market,
101:             metadata
102:         );
103:     }
```


</details>

## [Low-26] Use of onlyOwner functions can be lost

### Resolution 
In Solidity, renouncing ownership of a contract essentially transfers ownership to the zero address. This is an irreversible operation and has considerable security implications. If the renounceOwnership function is used, the contract will lose the ability to perform any operations that are limited to the owner. This can be problematic if there are any bugs, flaws, or unexpected events that require owner intervention to resolve. Therefore, in some instances, it is better to disable or omit the renounceOwnership function, and instead implement a secure transferOwnership function. This way, if necessary, ownership can be transferred to a new, trusted party without losing the potential for administrative intervention.

Num of instances: 4

### Findings 


<details><summary>Click to show findings</summary>

['[12](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/periphery/MonadDeployer.sol#L12-L12)']
```solidity
12: contract MonadDeployer is Ownable  // <= FOUND
```
['[16](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruForwarder.sol#L16-L16)']
```solidity
16: contract KuruForwarder is EIP712, Initializable, Ownable, UUPSUpgradeable  // <= FOUND
```
['[17](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L17-L17)']
```solidity
17: contract MarginAccount is IMarginAccount, ERC2771Context, Ownable, Initializable, UUPSUpgradeable  // <= FOUND
```
['[23](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L23-L23)']
```solidity
23: contract Router is IRouter, Ownable, Initializable, UUPSUpgradeable  // <= FOUND
```


</details>

## [Low-27] Off-by-one timestamp error

### Resolution 
In Solidity, using `>=` or `<=` to compare against `block.timestamp` (alias `now`) may introduce off-by-one errors due to the fact that `block.timestamp` is only updated once per block and its value remains constant throughout the block's execution. If an operation happens at the exact second when `block.timestamp` changes, it could result in unexpected behavior. To avoid this, it's safer to use strict inequality operators (`>` or `<`). For instance, if a condition should only be met after a certain time, use `block.timestamp > time` rather than `block.timestamp >= time`. This way, potential off-by-one errors due to the exact timing of block mining are mitigated, leading to safer, more predictable contract behavior.

Num of instances: 4

### Findings 


<details><summary>Click to show findings</summary>

['[130](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruForwarder.sol#L130-L130)']
```solidity
130:     function verify(ForwardRequest calldata req, bytes calldata signature) public view returns (bool) { // <= FOUND
131:         require(block.timestamp <= req.deadline, DeadlineExpired());
132:         address signer = _hashTypedData(
133:             keccak256(
134:                 abi.encode(
135:                     _FORWARD_TYPEHASH,
136:                     req.from,
137:                     req.market,
138:                     req.value,
139:                     req.nonce,
140:                     req.deadline,
141:                     req.selector,
142:                     keccak256(req.data)
143:                 )
144:             )
145:         ).recoverCalldata(signature);
146:         return req.nonce >= _nonces[req.from] && signer == req.from;
147:     }
```
['[151](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruForwarder.sol#L151-L151)']
```solidity
151:     function verifyPriceDependent(PriceDependentRequest calldata req, bytes calldata signature) // <= FOUND
152:         public
153:         view
154:         returns (bool)
155:     {
156:         require(block.timestamp <= req.deadline, DeadlineExpired());
157:         address signer = _hashTypedData(
158:             keccak256(
159:                 abi.encode(
160:                     _PRICE_DEPENDENT_TYPEHASH,
161:                     req.from,
162:                     req.market,
163:                     req.price,
164:                     req.value,
165:                     req.nonce,
166:                     req.deadline,
167:                     req.isBelowPrice,
168:                     req.selector,
169:                     keccak256(req.data)
170:                 )
171:             )
172:         ).recoverCalldata(signature);
173:         require(
174:             !executedPriceDependentRequest[keccak256(abi.encodePacked(req.from, req.nonce))],
175:             KuruForwarderErrors.NonceAlreadyUsed()
176:         );
177:         return signer == req.from;
178:     }
```
['[180](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruForwarder.sol#L180-L180)']
```solidity
180:     function verifyCancelPriceDependent(CancelPriceDependentRequest calldata req, bytes calldata signature) // <= FOUND
181:         public
182:         view
183:         returns (bool)
184:     {
185:         require(block.timestamp <= req.deadline, DeadlineExpired());
186:         address signer = _hashTypedData(
187:             keccak256(abi.encode(_CANCEL_PRICE_DEPENDENT_TYPEHASH, req.from, req.nonce, req.deadline))
188:         ).recoverCalldata(signature);
189:         require(
190:             !executedPriceDependentRequest[keccak256(abi.encodePacked(req.from, req.nonce))],
191:             KuruForwarderErrors.NonceAlreadyUsed()
192:         );
193:         return signer == req.from;
194:     }
```
['[196](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruForwarder.sol#L196-L196)']
```solidity
196:     function verifyMarginAccountRequest(MarginAccountRequest calldata req, bytes calldata signature) // <= FOUND
197:         public
198:         view
199:         returns (bool)
200:     {
201:         require(block.timestamp <= req.deadline, DeadlineExpired());
202:         address signer = _hashTypedData(
203:             keccak256(
204:                 abi.encode(
205:                     _MARGIN_ACCOUNT_REQUEST_TYPEHASH,
206:                     req.from,
207:                     req.marginAccount,
208:                     req.value,
209:                     req.nonce,
210:                     req.deadline,
211:                     req.selector,
212:                     keccak256(req.data)
213:                 )
214:             )
215:         ).recoverCalldata(signature);
216:         return req.nonce >= _nonces[req.from] && signer == req.from;
217:     }
```


</details>

## [Low-28] approve()/safeApprove() may revert if the current approval is not zero

### Resolution 
Reason: ERC20 token standard has an inherent race condition problem in its `approve` function. This issue particularly arises when you try to change an existing non-zero allowance. For tokens like USDT, which enforce anti-race condition checks, trying to change a non-zero allowance directly might fail.

Resolution: Always set the allowance to zero before setting a new value. By approving the spender to 0 first, it mitigates the risk of the race condition. This ensures you have a consistent allowance setup and prevent any potential transaction failure or mishap due to tokens enforcing anti-race condition checks.

Num of instances: 7

### Findings 


<details><summary>Click to show findings</summary>

['[65](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/periphery/MonadDeployer.sol#L65-L89)']
```solidity
65:     function deployTokenAndMarket(
66:         TokenParams memory tokenParams,
67:         MarketParams memory marketParams,
68:         bytes calldata metadata
69:     ) external payable returns (address market) {
70:         KuruERC20 token = new KuruERC20(tokenParams.name, tokenParams.symbol, tokenParams.initialSupply, address(this));
71:         market = router.deployProxy(
72:             IOrderBook.OrderBookType.NATIVE_IN_QUOTE,
73:             address(token),
74:             address(0),
75:             marketParams.sizePrecision,
76:             marketParams.pricePrecision,
77:             marketParams.tickSize,
78:             marketParams.minSize,
79:             marketParams.maxSize,
80:             marketParams.takerFeeBps,
81:             marketParams.makerFeeBps,
82:             kuruAmmSpread
83:         );
84:         if (msg.value != (marketParams.nativeTokenAmount + kuruCollectiveFee)) {
85:             revert InsufficientAssets(marketParams.nativeTokenAmount + kuruCollectiveFee, msg.value);
86:         }
87:         (address vault,,,,,,,) = IOrderBook(market).getVaultParams();
88:         uint256 _supplyToVault = tokenParams.initialSupply * (10 ** 4 - tokenParams.supplyToDev) / 10 ** 4;
89:         token.approve(vault, _supplyToVault); // <= FOUND
90:         IKuruAMMVault(vault).deposit{value: marketParams.nativeTokenAmount}(
91:             _supplyToVault, marketParams.nativeTokenAmount, address(this)
92:         );
93:         token.transfer(tokenParams.dev, tokenParams.initialSupply - _supplyToVault);
94:         marginAccount.deposit{value: kuruCollectiveFee}(kuruCollective, address(0), kuruCollectiveFee);
95:         emit PumpingTime(
96:             address(token),
97:             tokenParams.tokenURI,
98:             tokenParams.dev,
99:             tokenParams.initialSupply - _supplyToVault,
100:             market,
101:             metadata
102:         );
103:     }
```
['[45](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L45-L66)']
```solidity
45:     function initialize(
46:         address _owner,
47:         address token1_,
48:         address token2_,
49:         address _marginAccount,
50:         address _market,
51:         uint96 _spreadConstant
52:     ) public initializer {
53:         owner = _owner;
54:         token1 = token1_;
55:         token1Decimals = token1_ != address(0) ? ERC20(token1_).decimals() : 18;
56:         token2 = token2_;
57:         token2Decimals = token2_ != address(0) ? ERC20(token2_).decimals() : 18;
58:         marginAccount = IMarginAccount(_marginAccount);
59:         market = IOrderBook(_market);
60:         SPREAD_CONSTANT = _spreadConstant;
61:         setMarketParams();
62:         if (token1_ != address(0)) {
63:             token1_.safeApprove(_marginAccount, type(uint256).max); // <= FOUND
64:         }
65:         if (token2_ != address(0)) {
66:             token2_.safeApprove(_marginAccount, type(uint256).max); // <= FOUND
67:         }
68:         string memory token1Symbol;
69:         string memory token2Symbol;
70:         if (token1_ != address(0)) {
71:             token1Symbol = ERC20(token1_).symbol();
72:         } else {
73:             token1Symbol = "MON";
74:         }
75:         if (token2_ != address(0)) {
76:             token2Symbol = ERC20(token2_).symbol();
77:         } else {
78:             token2Symbol = "MON";
79:         }
80:         _name = string.concat(token1Symbol, "-", token2Symbol, "-", "KURU-AMM-VAULT");
81:     }
```
['[304](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L304-L316)']
```solidity
304:     function _setApprovalsForMarket(
305:         address _baseAsset,
306:         address _quoteAsset,
307:         address _marketAddress,
308:         IOrderBook.OrderBookType _type
309:     ) internal {
310:         if (_type == IOrderBook.OrderBookType.NATIVE_IN_BASE) {
311:             _quoteAsset.safeApprove(_marketAddress, type(uint256).max); // <= FOUND
312:         } else if (_type == IOrderBook.OrderBookType.NATIVE_IN_QUOTE) {
313:             _baseAsset.safeApprove(_marketAddress, type(uint256).max); // <= FOUND
314:         } else {
315:             _baseAsset.safeApprove(_marketAddress, type(uint256).max); // <= FOUND
316:             _quoteAsset.safeApprove(_marketAddress, type(uint256).max); // <= FOUND
317:         }
318:     }
```
['[65](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/periphery/MonadDeployer.sol#L65-L89)']
```solidity
65:     function deployTokenAndMarket(
66:         TokenParams memory tokenParams,
67:         MarketParams memory marketParams,
68:         bytes calldata metadata
69:     ) external payable returns (address market) {
70:         KuruERC20 token = new KuruERC20(tokenParams.name, tokenParams.symbol, tokenParams.initialSupply, address(this));
71:         market = router.deployProxy(
72:             IOrderBook.OrderBookType.NATIVE_IN_QUOTE,
73:             address(token),
74:             address(0),
75:             marketParams.sizePrecision,
76:             marketParams.pricePrecision,
77:             marketParams.tickSize,
78:             marketParams.minSize,
79:             marketParams.maxSize,
80:             marketParams.takerFeeBps,
81:             marketParams.makerFeeBps,
82:             kuruAmmSpread
83:         );
84:         if (msg.value != (marketParams.nativeTokenAmount + kuruCollectiveFee)) {
85:             revert InsufficientAssets(marketParams.nativeTokenAmount + kuruCollectiveFee, msg.value);
86:         }
87:         (address vault,,,,,,,) = IOrderBook(market).getVaultParams();
88:         uint256 _supplyToVault = tokenParams.initialSupply * (10 ** 4 - tokenParams.supplyToDev) / 10 ** 4;
89:         token.approve(vault, _supplyToVault); // <= FOUND
90:         IKuruAMMVault(vault).deposit{value: marketParams.nativeTokenAmount}(
91:             _supplyToVault, marketParams.nativeTokenAmount, address(this)
92:         );
93:         token.transfer(tokenParams.dev, tokenParams.initialSupply - _supplyToVault);
94:         marginAccount.deposit{value: kuruCollectiveFee}(kuruCollective, address(0), kuruCollectiveFee);
95:         emit PumpingTime(
96:             address(token),
97:             tokenParams.tokenURI,
98:             tokenParams.dev,
99:             tokenParams.initialSupply - _supplyToVault,
100:             market,
101:             metadata
102:         );
103:     }
```
['[45](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L45-L66)']
```solidity
45:     function initialize(
46:         address _owner,
47:         address token1_,
48:         address token2_,
49:         address _marginAccount,
50:         address _market,
51:         uint96 _spreadConstant
52:     ) public initializer {
53:         owner = _owner;
54:         token1 = token1_;
55:         token1Decimals = token1_ != address(0) ? ERC20(token1_).decimals() : 18;
56:         token2 = token2_;
57:         token2Decimals = token2_ != address(0) ? ERC20(token2_).decimals() : 18;
58:         marginAccount = IMarginAccount(_marginAccount);
59:         market = IOrderBook(_market);
60:         SPREAD_CONSTANT = _spreadConstant;
61:         setMarketParams();
62:         if (token1_ != address(0)) {
63:             token1_.safeApprove(_marginAccount, type(uint256).max); // <= FOUND
64:         }
65:         if (token2_ != address(0)) {
66:             token2_.safeApprove(_marginAccount, type(uint256).max); // <= FOUND
67:         }
68:         string memory token1Symbol;
69:         string memory token2Symbol;
70:         if (token1_ != address(0)) {
71:             token1Symbol = ERC20(token1_).symbol();
72:         } else {
73:             token1Symbol = "MON";
74:         }
75:         if (token2_ != address(0)) {
76:             token2Symbol = ERC20(token2_).symbol();
77:         } else {
78:             token2Symbol = "MON";
79:         }
80:         _name = string.concat(token1Symbol, "-", token2Symbol, "-", "KURU-AMM-VAULT");
81:     }
```
['[74](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L74-L74)']
```solidity
74:     function deployProxy(
75:         IOrderBook.OrderBookType _type,
76:         address _baseAssetAddress,
77:         address _quoteAssetAddress,
78:         uint96 _sizePrecision,
79:         uint32 _pricePrecision,
80:         uint32 _tickSize,
81:         uint96 _minSize,
82:         uint96 _maxSize,
83:         uint256 _takerFeeBps,
84:         uint256 _makerFeeBps,
85:         uint96 _kuruAmmSpread
86:     ) public returns (address proxy) {
87:         if (_type == IOrderBook.OrderBookType.NATIVE_IN_BASE) {
88:             require(_baseAssetAddress == address(0), RouterErrors.MarketTypeMismatch());
89:             require(_quoteAssetAddress != address(0), RouterErrors.MarketTypeMismatch());
90:         } else if (_type == IOrderBook.OrderBookType.NATIVE_IN_QUOTE) {
91:             require(_baseAssetAddress != address(0), RouterErrors.MarketTypeMismatch());
92:             require(_quoteAssetAddress == address(0), RouterErrors.MarketTypeMismatch());
93:         } else {
94:             require(_baseAssetAddress != address(0), RouterErrors.MarketTypeMismatch());
95:             require(_quoteAssetAddress != address(0), RouterErrors.MarketTypeMismatch());
96:             require(_baseAssetAddress != _quoteAssetAddress, RouterErrors.BaseAndQuoteAssetSame());
97:         }
98:         require(_tickSize > 0, RouterErrors.InvalidTickSize());
99:         require(10 ** Math.log10(_sizePrecision) == _sizePrecision, RouterErrors.InvalidSizePrecision());
100:         require(10 ** Math.log10(_pricePrecision) == _pricePrecision, RouterErrors.InvalidPricePrecision());
101:         uint256 _baseAssetDecimals =
102:             _type == IOrderBook.OrderBookType.NATIVE_IN_BASE ? 18 : IERC20Metadata(_baseAssetAddress).decimals();
103:         uint256 _quoteAssetDecimals =
104:             _type == IOrderBook.OrderBookType.NATIVE_IN_QUOTE ? 18 : IERC20Metadata(_quoteAssetAddress).decimals();
105:         {
106:             bytes32 _salt = _getSalt(
107:                 _baseAssetAddress,
108:                 _quoteAssetAddress,
109:                 _sizePrecision,
110:                 _pricePrecision,
111:                 _tickSize,
112:                 _minSize,
113:                 _maxSize,
114:                 _takerFeeBps,
115:                 _makerFeeBps,
116:                 _kuruAmmSpread
117:             );
118:             proxy = Create2.deploy(
119:                 0,
120:                 _salt,
121:                 abi.encodePacked(type(ERC1967Proxy).creationCode, abi.encode(orderBookImplementation, bytes("")))
122:             );
123:         }
124:         IKuruAMMVault _kuruAmmVault = IKuruAMMVault(
125:             Create2.deploy(
126:                 0,
127:                 keccak256(abi.encode(proxy)),
128:                 abi.encodePacked(type(ERC1967Proxy).creationCode, abi.encode(kuruAmmVaultImplementation, bytes("")))
129:             )
130:         );
131: 
132:         verifiedMarket[proxy] = MarketParams(
133:             _pricePrecision,
134:             _sizePrecision,
135:             _baseAssetAddress,
136:             _baseAssetDecimals,
137:             _quoteAssetAddress,
138:             _quoteAssetDecimals,
139:             _tickSize,
140:             _minSize,
141:             _maxSize,
142:             _takerFeeBps,
143:             _makerFeeBps
144:         );
145:         IMarginAccount(marginAccountAddress).updateMarkets(proxy);
146:         {
147:             IOrderBook(proxy).initialize(
148:                 address(this),
149:                 _type,
150:                 _baseAssetAddress,
151:                 _baseAssetDecimals,
152:                 _quoteAssetAddress,
153:                 _quoteAssetDecimals,
154:                 marginAccountAddress,
155:                 _sizePrecision,
156:                 _pricePrecision,
157:                 _tickSize,
158:                 _minSize,
159:                 _maxSize,
160:                 _takerFeeBps,
161:                 _makerFeeBps,
162:                 address(_kuruAmmVault),
163:                 _kuruAmmSpread,
164:                 TRUSTED_FORWARDER
165:             );
166:         }
167: 
168:         _kuruAmmVault.initialize(
169:             address(this), _baseAssetAddress, _quoteAssetAddress, marginAccountAddress, proxy, _kuruAmmSpread
170:         );
171: 
172:         _setApprovalsForMarket(_baseAssetAddress, _quoteAssetAddress, proxy, _type);
173: 
174:         emit MarketRegistered(
175:             _baseAssetAddress,
176:             _quoteAssetAddress,
177:             proxy,
178:             address(_kuruAmmVault),
179:             _pricePrecision,
180:             _sizePrecision,
181:             _tickSize,
182:             _minSize,
183:             _maxSize,
184:             _takerFeeBps,
185:             _makerFeeBps,
186:             _kuruAmmSpread
187:         );
188: 
189:         return proxy;
190:     }
```
['[304](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L304-L316)']
```solidity
304:     function _setApprovalsForMarket(
305:         address _baseAsset,
306:         address _quoteAsset,
307:         address _marketAddress,
308:         IOrderBook.OrderBookType _type
309:     ) internal {
310:         if (_type == IOrderBook.OrderBookType.NATIVE_IN_BASE) {
311:             _quoteAsset.safeApprove(_marketAddress, type(uint256).max); // <= FOUND
312:         } else if (_type == IOrderBook.OrderBookType.NATIVE_IN_QUOTE) {
313:             _baseAsset.safeApprove(_marketAddress, type(uint256).max); // <= FOUND
314:         } else {
315:             _baseAsset.safeApprove(_marketAddress, type(uint256).max); // <= FOUND
316:             _quoteAsset.safeApprove(_marketAddress, type(uint256).max); // <= FOUND
317:         }
318:     }
```


</details>

## [Low-29] safeApprove is deprecated

### Resolution 
The use of safeApprove has been deprecated in favour of safeIncreaseAllowance and safeDecreaseAllowance. Transition to these to ensure compatibility and functionality (if a bug is found) for the future.

Num of instances: 4

### Findings 


<details><summary>Click to show findings</summary>

['[63](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L63-L63)']
```solidity
63:             token1_.safeApprove(_marginAccount, type(uint256).max); // <= FOUND
```
['[66](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L66-L66)']
```solidity
66:             token2_.safeApprove(_marginAccount, type(uint256).max); // <= FOUND
```
['[311](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L311-L311)']
```solidity
311:             _quoteAsset.safeApprove(_marketAddress, type(uint256).max); // <= FOUND
```
['[313](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L313-L313)']
```solidity
313:             _baseAsset.safeApprove(_marketAddress, type(uint256).max); // <= FOUND
```


</details>

## [Low-30] Remaining eth may not be refunded to users

### Resolution 
When a contract function accepts Ethereum and executes a `.call()` or similar function that also forwards Ethereum value, it's important to check for and refund any remaining balance. This is because some of the supplied value may not be used during the call execution due to gas constraints, a revert in the called contract, or simply because not all the value was needed.

If you do not account for this remaining balance, it can become "locked" in the contract. It's crucial to either return the remaining balance to the sender or handle it in a way that ensures it is not permanently stuck. Neglecting to do so can lead to loss of funds and degradation of the contract's reliability. Furthermore, it's good practice to ensure fairness and trust with your users by returning unused funds.

Num of instances: 4

### Findings 


<details><summary>Click to show findings</summary>

['[219](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruForwarder.sol#L219-L221)']
```solidity
219:     function executeMarginAccountRequest(MarginAccountRequest calldata req, bytes calldata signature)
220:         public
221:         payable // <= FOUND
222:         returns (bytes memory)
223:     {
224:         require(verifyMarginAccountRequest(req, signature), KuruForwarderErrors.SignatureMismatch());
225:         require(msg.value >= req.value, KuruForwarderErrors.InsufficientValue());
226:         require(allowedInterface[req.selector], KuruForwarderErrors.InterfaceNotAllowed());
227: 
228:         _nonces[req.from] = req.nonce + 1;
229: 
230:         (bool success, bytes memory returndata) =
231:             req.marginAccount.call{value: req.value}(abi.encodePacked(req.selector, req.data, req.from)); // <= FOUND
232: 
233:         if (!success) {
234:             revert ExecutionFailed(returndata);
235:         }
236: 
237:         return returndata;
238:     }
```
['[240](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruForwarder.sol#L240-L240)']
```solidity
240:     function execute(ForwardRequest calldata req, bytes calldata signature) public payable returns (bytes memory) { // <= FOUND
241:         require(verify(req, signature), KuruForwarderErrors.SignatureMismatch());
242:         require(msg.value >= req.value, KuruForwarderErrors.InsufficientValue());
243:         require(allowedInterface[req.selector], KuruForwarderErrors.InterfaceNotAllowed());
244: 
245:         _nonces[req.from] = req.nonce + 1;
246: 
247:         (bool success, bytes memory returndata) =
248:             req.market.call{value: req.value}(abi.encodePacked(req.selector, req.data, req.from)); // <= FOUND
249: 
250:         if (!success) {
251:             revert ExecutionFailed(returndata);
252:         }
253: 
254:         return returndata;
255:     }
```
['[257](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruForwarder.sol#L257-L259)']
```solidity
257:     function executePriceDependent(PriceDependentRequest calldata req, bytes calldata signature)
258:         public
259:         payable // <= FOUND
260:         returns (bytes memory)
261:     {
262:         require(verifyPriceDependent(req, signature), KuruForwarderErrors.SignatureMismatch());
263:         require(msg.value >= req.value, KuruForwarderErrors.InsufficientValue());
264:         require(allowedInterface[req.selector], KuruForwarderErrors.InterfaceNotAllowed());
265:         executedPriceDependentRequest[keccak256(abi.encodePacked(req.from, req.nonce))] = true;
266: 
267:         (uint256 _currentBidPrice,) = IOrderBook(req.market).bestBidAsk();
268:         require(
269:             (req.isBelowPrice && req.price < _currentBidPrice) || (!req.isBelowPrice && req.price > _currentBidPrice),
270:             PriceDependentRequestFailed(_currentBidPrice, req.price)
271:         );
272:         (bool success, bytes memory returndata) =
273:             req.market.call{value: req.value}(abi.encodePacked(req.selector, req.data, req.from)); // <= FOUND
274: 
275:         if (!success) {
276:             revert ExecutionFailed(returndata);
277:         }
278: 
279:         return returndata;
280:     }
```
['[331](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L331-L339)']
```solidity
331:     function anyToAnySwap(
332:         address[] calldata _marketAddresses,
333:         bool[] calldata _isBuy,
334:         bool[] calldata _nativeSend,
335:         address _debitToken,
336:         address _creditToken,
337:         uint256 _amount,
338:         uint256 _minAmountOut
339:     ) external payable returns (uint256 _amountOut) { // <= FOUND
340:         require(_marketAddresses.length >= 1, RouterErrors.NoMarketsPassed());
341:         require(_isBuy.length == _marketAddresses.length, RouterErrors.LengthMismatch());
342:         require(_nativeSend.length == _marketAddresses.length, RouterErrors.LengthMismatch());
343:         if (_nativeSend[0] == false) {
344:             _debitToken.safeTransferFrom(msg.sender, address(this), _amount);
345:         }
346:         uint256 _cachedAmountIn = _amount;
347: 
348:         for (uint256 i = 0; i < _marketAddresses.length; i++) {
349:             address _currentMarket = _marketAddresses[i];
350:             MarketParams memory _marketParams = verifiedMarket[_currentMarket];
351:             require(_marketParams.pricePrecision > 0, RouterErrors.InvalidMarket());
352:             IOrderBook market = IOrderBook(_currentMarket);
353:             uint256 _value = _nativeSend[i] ? _amount : 0;
354:             _amountOut = _isBuy[i]
355:                 ? (
356:                     market.placeAndExecuteMarketBuy{value: _value}( // <= FOUND
357:                         toU96(_amount * _marketParams.pricePrecision / 10 ** _marketParams.quoteAssetDecimals),
358:                         0,
359:                         false,
360:                         true
361:                     )
362:                 )
363:                 : market.placeAndExecuteMarketSell{value: _value}( // <= FOUND
364:                     toU96(_amount * _marketParams.sizePrecision / 10 ** _marketParams.baseAssetDecimals), 0, false, true
365:                 );
366: 
367:             _amount = _amountOut;
368:         }
369:         require(_amountOut >= _minAmountOut, RouterErrors.SlippageExceeded());
370:         emit KuruRouterSwap(msg.sender, _debitToken, _creditToken, _cachedAmountIn, _amountOut);
371:         if (_creditToken != address(0)) {
372:             _creditToken.safeTransfer(msg.sender, _amountOut);
373:         } else {
374:             msg.sender.safeTransferETH(_amountOut);
375:         }
376:     }
```


</details>

## [Low-31] Constant decimal values

### Resolution 
The use of fixed decimal values such as 1e18 or 1e8 in Solidity contracts can lead to inaccuracies, bugs, and vulnerabilities, particularly when interacting with tokens having different decimal configurations. Not all ERC20 tokens follow the standard 18 decimal places, and assumptions about decimal places can lead to miscalculations.

Resolution: Always retrieve and use the `decimals()` function from the token contract itself when performing calculations involving token amounts. This ensures that your contract correctly handles tokens with any number of decimal places, mitigating the risk of numerical errors or under/overflows that could jeopardize contract integrity and user funds.

Num of instances: 1

### Findings 


<details><summary>Click to show findings</summary>

['[57](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L57-L62)']
```solidity
57:     
62:     uint256 internal constant WAD = 1e18; // <= FOUND
```


</details>

## [Low-32] Function which returns data from a call has no validation for said data

### Resolution 
In Solidity, when `call` or `delegatecall` is used to interact with another contract, it's possible that the called contract function doesn't return any data. This could be due to various reasons, such as the function is not implemented, or the function encountered an error. If the calling contract then tries to directly access elements in the returned data without first checking the length of the returned data, it could lead to a runtime error, or in some cases, incorrect logic execution.

Therefore, it's advisable to have a length check and revert the transaction if `results.length` is 0. This ensures the function doesn't proceed with potentially unsafe or invalid data. It also provides a clear error message to the caller, indicating that the called function did not return any data, which assists in troubleshooting.

Num of instances: 3

### Findings 


<details><summary>Click to show findings</summary>

['[219](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruForwarder.sol#L219-L237)']
```solidity
219:     function executeMarginAccountRequest(MarginAccountRequest calldata req, bytes calldata signature) // <= FOUND
220:         public
221:         payable
222:         returns (bytes memory)
223:     {
224:         require(verifyMarginAccountRequest(req, signature), KuruForwarderErrors.SignatureMismatch());
225:         require(msg.value >= req.value, KuruForwarderErrors.InsufficientValue());
226:         require(allowedInterface[req.selector], KuruForwarderErrors.InterfaceNotAllowed());
227: 
228:         _nonces[req.from] = req.nonce + 1;
229: 
230:         (bool success, bytes memory returndata) =
231:             req.marginAccount.call{value: req.value}(abi.encodePacked(req.selector, req.data, req.from));
232: 
233:         if (!success) {
234:             revert ExecutionFailed(returndata);
235:         }
236: 
237:         return returndata; // <= FOUND
238:     }
```
['[240](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruForwarder.sol#L240-L254)']
```solidity
240:     function execute(ForwardRequest calldata req, bytes calldata signature) public payable returns (bytes memory) { // <= FOUND
241:         require(verify(req, signature), KuruForwarderErrors.SignatureMismatch());
242:         require(msg.value >= req.value, KuruForwarderErrors.InsufficientValue());
243:         require(allowedInterface[req.selector], KuruForwarderErrors.InterfaceNotAllowed());
244: 
245:         _nonces[req.from] = req.nonce + 1;
246: 
247:         (bool success, bytes memory returndata) =
248:             req.market.call{value: req.value}(abi.encodePacked(req.selector, req.data, req.from));
249: 
250:         if (!success) {
251:             revert ExecutionFailed(returndata);
252:         }
253: 
254:         return returndata; // <= FOUND
255:     }
```
['[257](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruForwarder.sol#L257-L279)']
```solidity
257:     function executePriceDependent(PriceDependentRequest calldata req, bytes calldata signature) // <= FOUND
258:         public
259:         payable
260:         returns (bytes memory)
261:     {
262:         require(verifyPriceDependent(req, signature), KuruForwarderErrors.SignatureMismatch());
263:         require(msg.value >= req.value, KuruForwarderErrors.InsufficientValue());
264:         require(allowedInterface[req.selector], KuruForwarderErrors.InterfaceNotAllowed());
265:         executedPriceDependentRequest[keccak256(abi.encodePacked(req.from, req.nonce))] = true;
266: 
267:         (uint256 _currentBidPrice,) = IOrderBook(req.market).bestBidAsk();
268:         require(
269:             (req.isBelowPrice && req.price < _currentBidPrice) || (!req.isBelowPrice && req.price > _currentBidPrice),
270:             PriceDependentRequestFailed(_currentBidPrice, req.price)
271:         );
272:         (bool success, bytes memory returndata) =
273:             req.market.call{value: req.value}(abi.encodePacked(req.selector, req.data, req.from));
274: 
275:         if (!success) {
276:             revert ExecutionFailed(returndata);
277:         }
278: 
279:         return returndata; // <= FOUND
280:     }
```


</details>

## [Low-33] Sending tokens in a for loop

### Resolution 
Performing token transfers in a loop in a Solidity contract is generally not recommended due to various reasons. One of these reasons is the "Fail-Silently" issue.

In a Solidity loop, if one transfer operation fails, it causes the entire transaction to fail. This issue can be particularly troublesome when you're dealing with multiple transfers in one transaction. For instance, if you're looping through an array of recipients to distribute dividends or rewards, a single failed transfer will prevent all the subsequent recipients from receiving their transfers. This could be due to the recipient contract throwing an exception or due to other issues like a gas limit being exceeded.

Moreover, such a design could also inadvertently lead to a situation where a malicious contract intentionally causes a failure when receiving Ether to prevent other participants from getting their rightful transfers. This could open up avenues for griefing attacks in the system.

Resolution: To mitigate this problem, it's typically recommended to follow the "withdraw pattern" in your contracts instead of pushing payments. In this model, each recipient would be responsible for triggering their own payment. This separates each transfer operation, so a failure in one doesn't impact the others. Additionally, it greatly reduces the chance of malicious interference as the control over fund withdrawal lies with the intended recipient and not with an external loop operation.

Num of instances: 2

### Findings 


<details><summary>Click to show findings</summary>

['[179](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L179-L186)']
```solidity
179:        for (uint256 i = 0; i < _tokens.length; i++) {
180:             _balance = balances[_accountKey(_msgSender(), _tokens[i])];
181:             balances[_accountKey(_msgSender(), _tokens[i])] = 0;
182:             if (_balance > 0) {
183:                 if (_tokens[i] == NATIVE) {
184:                     _msgSender().safeTransferETH(_balance);
185:                 } else {
186:                     _tokens[i].safeTransfer(_msgSender(), _balance); // <= FOUND
187:                 }
188:             }
189:         }
```
['[179](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L179-L186)']
```solidity
179:         for (uint256 i = 0; i < _tokens.length; i++) {
180:             _balance = balances[_accountKey(_msgSender(), _tokens[i])];
181:             balances[_accountKey(_msgSender(), _tokens[i])] = 0;
182:             if (_balance > 0) {
183:                 if (_tokens[i] == NATIVE) {
184:                     _msgSender().safeTransferETH(_balance);
185:                 } else {
186:                     _tokens[i].safeTransfer(_msgSender(), _balance); // <= FOUND
187:                 }
188:             }
189:         }
```


</details>

## [Low-34] Large approvals such as type(uint256).max may not work with some tokens

### Resolution 
The `approve` function in ERC-20 tokens allows a user to permit another user or contract to spend tokens on their behalf. Setting the approval to `type(uint256).max` is often used as a way to grant an indefinite approval, as this value is the maximum possible value of a `uint256` variable in Solidity. 

However, some tokens may not function as expected when `type(uint256).max` is used. These tokens may have an atypical implementation of the `transferFrom` function, which is used in combination with `approve`. This function might behave differently when confronted with such a high allowance, possibly due to custom logic in the contract that wasn't designed to handle these edge cases. 

Moreover, tokens that have a built-in burning or fees mechanism could behave unpredictably when the maximum allowance is set. This can lead to potential vulnerabilities or misinterpretations of contract behavior.

Resolution: It's advisable to be conservative with the `approve` function and only approve the specific amount of tokens that need to be spent for the specific operation you're performing. If you need to provide an extensive allowance, ensure you've thoroughly analyzed the token contract to understand how it behaves with high allowances. Alternatively, consider implementing a mechanism in your contract to handle token allowances in a more dynamic way, adjusting them as needed for each operation, rather than relying on a single indefinite approval.

Num of instances: 4

### Findings 


<details><summary>Click to show findings</summary>

['[63](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L63-L63)']
```solidity
63:             token1_.safeApprove(_marginAccount, type(uint256).max); // <= FOUND
```
['[66](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L66-L66)']
```solidity
66:             token2_.safeApprove(_marginAccount, type(uint256).max); // <= FOUND
```
['[311](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L311-L311)']
```solidity
311:             _quoteAsset.safeApprove(_marketAddress, type(uint256).max); // <= FOUND
```
['[313](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L313-L313)']
```solidity
313:             _baseAsset.safeApprove(_marketAddress, type(uint256).max); // <= FOUND
```


</details>

## [Low-35] Revert on Transfer to the Zero Address

### Resolution 
Many ERC-20 and ERC-721 token contracts implement a safeguard that reverts transactions which attempt to transfer tokens to the zero address. This is because such transfers are often the result of programming errors. The OpenZeppelin library, a popular choice for implementing these standards, includes this safeguard. For token contract developers who want to avoid unintentional transfers to the zero address, it's good practice to include a condition that reverts the transaction if the recipient's address is the zero address. 

Num of instances: 3

### Findings 


<details><summary>Click to show findings</summary>

['[177](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L177-L185)']
```solidity
177:     function batchWithdrawMaxTokens(address[] calldata _tokens) external protocolActive { // <= FOUND
178:         uint256 _balance;
179:         for (uint256 i = 0; i < _tokens.length; i++) {
180:             _balance = balances[_accountKey(_msgSender(), _tokens[i])];
181:             balances[_accountKey(_msgSender(), _tokens[i])] = 0;
182:             if (_balance > 0) {
183:                 if (_tokens[i] == NATIVE) {
184:                     _msgSender().safeTransferETH(_balance);
185:                 } else { // <= FOUND
186:                     _tokens[i].safeTransfer(_msgSender(), _balance);
187:                 }
188:             }
189:         }
190:     }
```
['[217](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L217-L222)']
```solidity
217:     function withdraw(uint256 _amount, address _token) external protocolActive { // <= FOUND
218:         require(_amount <= balances[_accountKey(_msgSender(), _token)], MarginAccountErrors.InsufficientBalance());
219:         balances[_accountKey(_msgSender(), _token)] -= _amount;
220:         if (_token == NATIVE) {
221:             _msgSender().safeTransferETH(_amount);
222:         } else { // <= FOUND
223:             _token.safeTransfer(_msgSender(), _amount);
224:         }
225: 
226:         emit Withdrawal(_msgSender(), _token, _amount);
227:     }
```
['[65](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/periphery/MonadDeployer.sol#L65-L91)']
```solidity
65:     function deployTokenAndMarket( // <= FOUND
66:         TokenParams memory tokenParams,
67:         MarketParams memory marketParams,
68:         bytes calldata metadata
69:     ) external payable returns (address market) {
70:         KuruERC20 token = new KuruERC20(tokenParams.name, tokenParams.symbol, tokenParams.initialSupply, address(this));
71:         market = router.deployProxy(
72:             IOrderBook.OrderBookType.NATIVE_IN_QUOTE,
73:             address(token),
74:             address(0),
75:             marketParams.sizePrecision,
76:             marketParams.pricePrecision,
77:             marketParams.tickSize,
78:             marketParams.minSize,
79:             marketParams.maxSize,
80:             marketParams.takerFeeBps,
81:             marketParams.makerFeeBps,
82:             kuruAmmSpread
83:         );
84:         if (msg.value != (marketParams.nativeTokenAmount + kuruCollectiveFee)) {
85:             revert InsufficientAssets(marketParams.nativeTokenAmount + kuruCollectiveFee, msg.value);
86:         }
87:         (address vault,,,,,,,) = IOrderBook(market).getVaultParams();
88:         uint256 _supplyToVault = tokenParams.initialSupply * (10 ** 4 - tokenParams.supplyToDev) / 10 ** 4;
89:         token.approve(vault, _supplyToVault);
90:         IKuruAMMVault(vault).deposit{value: marketParams.nativeTokenAmount}(
91:             _supplyToVault, marketParams.nativeTokenAmount, address(this) // <= FOUND
92:         );
93:         token.transfer(tokenParams.dev, tokenParams.initialSupply - _supplyToVault);
94:         marginAccount.deposit{value: kuruCollectiveFee}(kuruCollective, address(0), kuruCollectiveFee);
95:         emit PumpingTime(
96:             address(token),
97:             tokenParams.tokenURI,
98:             tokenParams.dev,
99:             tokenParams.initialSupply - _supplyToVault,
100:             market,
101:             metadata
102:         );
103:     }
```


</details>

## [Low-36] Return values not checked for approve()

### Resolution 
The ERC-20 token standard does not dictate that the approve function must return a value. The function signature in the ERC-20 standard is function approve(address spender, uint tokens) public returns (bool success);. However, a well-implemented ERC-20 token contract will typically have approve return a boolean value indicating whether or not the operation was successful.

It's crucial to note that not all token contracts follow this practice. Some might not return a value, or they might return a value in a non-standard way. This inconsistency among token contracts is one reason why it's important to handle token interactions carefully in your smart contracts and to check the return value of approve when possible.

Num of instances: 1

### Findings 


<details><summary>Click to show findings</summary>

['[89](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/periphery/MonadDeployer.sol#L89-L89)']
```solidity
89:         token.approve(vault, _supplyToVault); // <= FOUND
```


</details>

## [Low-37] Consider adding a time delay to upgrade implementation functions

### Resolution 
It's often considered a good practice to use a timelock on sensitive functions such as upgrading a contract, especially when these contracts handle user funds or critical system states.

A timelock is a delay period that must pass between when an action (like an upgrade) is scheduled and when it can be executed. This provides a window of time for users or governance participants to observe the proposed change and potentially respond if they disagree with the action.

Num of instances: 4

### Findings 


<details><summary>Click to show findings</summary>

['[250](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L250-L250)']
```solidity
250:     function upgradeOrderBookImplementation(address newImplementation) external onlyOwner { // <= FOUND
251:         require(newImplementation != orderBookImplementation);
252:         emit OBImplementationUpdated(orderBookImplementation, newImplementation);
253:         orderBookImplementation = newImplementation;
254:     }
```
['[260](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L260-L260)']
```solidity
260:     function upgradeVaultImplementation(address newImplementation) external onlyOwner { // <= FOUND
261:         require(newImplementation != kuruAmmVaultImplementation);
262:         emit VaultImplementationUpdated(kuruAmmVaultImplementation, newImplementation);
263:         kuruAmmVaultImplementation = newImplementation;
264:     }
```
['[281](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L281-L281)']
```solidity
281:     function upgradeMultipleOrderBookProxies(address[] memory proxies, bytes[] memory data) public onlyOwner { // <= FOUND
282:         for (uint256 i = 0; i < proxies.length; i++) {
283:             UUPSUpgradeable(proxies[i]).upgradeToAndCall(orderBookImplementation, data[i]);
284:         }
285:     }
```
['[287](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L287-L287)']
```solidity
287:     function upgradeMultipleVaultProxies(address[] memory proxies, bytes[] memory data) public onlyOwner { // <= FOUND
288:         for (uint256 i = 0; i < proxies.length; i++) {
289:             UUPSUpgradeable(proxies[i]).upgradeToAndCall(kuruAmmVaultImplementation, data[i]);
290:         }
291:     }
```


</details>

## [Low-38] The function symbol() is not part of the ERC20 standard

### Resolution 
Assuming that the `symbol()` function is always present in an ERC20 contract can lead to unexpected issues, as not all ERC20 tokens implement it. Some tokens may omit this function or use a non-standard implementation. If your contract makes an external call to `symbol()` on a token that does not implement this function, it will result in a runtime error, possibly breaking your contract's functionality. The recommended solution is to use try/catch statements when calling `symbol()`. This way, your contract can handle cases where the function is missing or implemented differently, ensuring robust interaction with any ERC20 token.

Num of instances: 2

### Findings 


<details><summary>Click to show findings</summary>

['[71](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L71-L71)']
```solidity
71:             token1Symbol = ERC20(token1_).symbol(); // <= FOUND
```
['[76](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L76-L76)']
```solidity
76:             token2Symbol = ERC20(token2_).symbol(); // <= FOUND
```


</details>

## [Low-39] No access control on receive/payable fallback

### Resolution 
Without access control on receive/payable fallback functions in a contract, anyone can send Ether (ETH) to the contract's address. If there's no way to withdraw those funds defined within the contract, any Ether sent, whether intentionally or by mistake, will be permanently stuck. This could lead to unintended loss of funds. Implementing proper access control ensures that only authorized addresses can interact with these functions. Resolution could involve adding access control mechanisms, like Ownable or specific permission requirements, or creating a withdrawal function accessible only to the contract's owner, thus preventing unintentional loss of funds.

Num of instances: 1

### Findings 


<details><summary>Click to show findings</summary>

['[247](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L247-L247)']
```solidity
247:     receive() external payable {} // <= FOUND
```


</details>

## [Low-40] External call recipient may consume all transaction gas

### Resolution 
When making external calls, the called contract can intentionally or unintentionally consume all provided gas, leading to unintended transaction reversion. To mitigate this risk, it's crucial to specify a gas limit when making the call. By using `addr.call{gas: <amount>}("")`, you allocate a specific amount of gas to the external call, ensuring the parent transaction has gas left for post-call operations. This approach safeguards against malevolent contracts aiming to exhaust gas and provides greater control over transaction execution.

Num of instances: 2

### Findings 


<details><summary>Click to show findings</summary>

['[230](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruForwarder.sol#L230-L231)']
```solidity
230:         (bool success, bytes memory returndata) =
231:             req.marginAccount.call{value: req.value}(abi.encodePacked(req.selector, req.data, req.from)); // <= FOUND
```
['[230](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruForwarder.sol#L230-L231)']
```solidity
230:         (bool success, bytes memory returndata) =
231:             req.market.call{value: req.value}(abi.encodePacked(req.selector, req.data, req.from)); // <= FOUND
```


</details>

## [Low-41] Events may be emitted out of order due to code not follow the best practice of check-effects-interaction

### Resolution 
The "check-effects-interaction" pattern also impacts event ordering. When a contract doesn't adhere to this pattern, events might be emitted in a sequence that doesn't reflect the actual logical flow of operations. This can cause confusion during event tracking, potentially leading to erroneous off-chain interpretations. To rectify this, always ensure that checks are performed first, state modifications come next, and interactions with external contracts or addresses are done last. This will ensure events are emitted in a logical, consistent manner, providing a clear and accurate chronological record of on-chain actions for off-chain systems and observers.

Num of instances: 4

### Findings 


<details><summary>Click to show findings</summary>


['[198](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L198-L209)']
```solidity
198:     function deposit(address _user, address _token, uint256 _amount) external payable protocolActive { // <= FOUND
199:         require(_user != address(0), MarginAccountErrors.ZeroAddressNotAllowed());
200:         if (_token == NATIVE) {
201:             require(msg.value == _amount, MarginAccountErrors.NativeAssetMismatch());
202:             balances[_accountKey(_user, NATIVE)] += _amount;
203:         } else {
204:             require(msg.value == 0, MarginAccountErrors.NativeAssetMismatch());
205:             balances[_accountKey(_user, _token)] += _amount;
206:             _token.safeTransferFrom(_msgSender(), address(this), _amount); // <= FOUND
207:         }
208: 
209:         emit Deposit(_user, _token, _amount); // <= FOUND
210:     }
```
['[217](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L217-L226)']
```solidity
217:     function withdraw(uint256 _amount, address _token) external protocolActive { // <= FOUND
218:         require(_amount <= balances[_accountKey(_msgSender(), _token)], MarginAccountErrors.InsufficientBalance());
219:         balances[_accountKey(_msgSender(), _token)] -= _amount;
220:         if (_token == NATIVE) {
221:             _msgSender().safeTransferETH(_amount);
222:         } else {
223:             _token.safeTransfer(_msgSender(), _amount); // <= FOUND
224:         }
225: 
226:         emit Withdrawal(_msgSender(), _token, _amount); // <= FOUND
227:     }
```
['[331](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L331-L370)']
```solidity
331:     function anyToAnySwap( // <= FOUND
332:         address[] calldata _marketAddresses,
333:         bool[] calldata _isBuy,
334:         bool[] calldata _nativeSend,
335:         address _debitToken,
336:         address _creditToken,
337:         uint256 _amount,
338:         uint256 _minAmountOut
339:     ) external payable returns (uint256 _amountOut) {
340:         require(_marketAddresses.length >= 1, RouterErrors.NoMarketsPassed());
341:         require(_isBuy.length == _marketAddresses.length, RouterErrors.LengthMismatch());
342:         require(_nativeSend.length == _marketAddresses.length, RouterErrors.LengthMismatch());
343:         if (_nativeSend[0] == false) {
344:             _debitToken.safeTransferFrom(msg.sender, address(this), _amount); // <= FOUND
345:         }
346:         uint256 _cachedAmountIn = _amount;
347: 
348:         for (uint256 i = 0; i < _marketAddresses.length; i++) {
349:             address _currentMarket = _marketAddresses[i];
350:             MarketParams memory _marketParams = verifiedMarket[_currentMarket];
351:             require(_marketParams.pricePrecision > 0, RouterErrors.InvalidMarket());
352:             IOrderBook market = IOrderBook(_currentMarket);
353:             uint256 _value = _nativeSend[i] ? _amount : 0;
354:             _amountOut = _isBuy[i]
355:                 ? (
356:                     market.placeAndExecuteMarketBuy{value: _value}(
357:                         toU96(_amount * _marketParams.pricePrecision / 10 ** _marketParams.quoteAssetDecimals),
358:                         0,
359:                         false,
360:                         true
361:                     )
362:                 )
363:                 : market.placeAndExecuteMarketSell{value: _value}(
364:                     toU96(_amount * _marketParams.sizePrecision / 10 ** _marketParams.baseAssetDecimals), 0, false, true
365:                 );
366: 
367:             _amount = _amountOut;
368:         }
369:         require(_amountOut >= _minAmountOut, RouterErrors.SlippageExceeded());
370:         emit KuruRouterSwap(msg.sender, _debitToken, _creditToken, _cachedAmountIn, _amountOut); // <= FOUND
371:         if (_creditToken != address(0)) {
372:             _creditToken.safeTransfer(msg.sender, _amountOut);
373:         } else {
374:             msg.sender.safeTransferETH(_amountOut);
375:         }
376:     }
```
['[74](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L74-L174)']
```solidity
74:     function deployProxy( // <= FOUND
75:         IOrderBook.OrderBookType _type,
76:         address _baseAssetAddress,
77:         address _quoteAssetAddress,
78:         uint96 _sizePrecision,
79:         uint32 _pricePrecision,
80:         uint32 _tickSize,
81:         uint96 _minSize,
82:         uint96 _maxSize,
83:         uint256 _takerFeeBps,
84:         uint256 _makerFeeBps,
85:         uint96 _kuruAmmSpread
86:     ) public returns (address proxy) {
87:         if (_type == IOrderBook.OrderBookType.NATIVE_IN_BASE) {
88:             require(_baseAssetAddress == address(0), RouterErrors.MarketTypeMismatch());
89:             require(_quoteAssetAddress != address(0), RouterErrors.MarketTypeMismatch());
90:         } else if (_type == IOrderBook.OrderBookType.NATIVE_IN_QUOTE) {
91:             require(_baseAssetAddress != address(0), RouterErrors.MarketTypeMismatch());
92:             require(_quoteAssetAddress == address(0), RouterErrors.MarketTypeMismatch());
93:         } else {
94:             require(_baseAssetAddress != address(0), RouterErrors.MarketTypeMismatch());
95:             require(_quoteAssetAddress != address(0), RouterErrors.MarketTypeMismatch());
96:             require(_baseAssetAddress != _quoteAssetAddress, RouterErrors.BaseAndQuoteAssetSame());
97:         }
98:         require(_tickSize > 0, RouterErrors.InvalidTickSize());
99:         require(10 ** Math.log10(_sizePrecision) == _sizePrecision, RouterErrors.InvalidSizePrecision());
100:         require(10 ** Math.log10(_pricePrecision) == _pricePrecision, RouterErrors.InvalidPricePrecision());
101:         uint256 _baseAssetDecimals =
102:             _type == IOrderBook.OrderBookType.NATIVE_IN_BASE ? 18 : IERC20Metadata(_baseAssetAddress).decimals(); // <= FOUND
103:         uint256 _quoteAssetDecimals =
104:             _type == IOrderBook.OrderBookType.NATIVE_IN_QUOTE ? 18 : IERC20Metadata(_quoteAssetAddress).decimals();
105:         {
106:             bytes32 _salt = _getSalt(
107:                 _baseAssetAddress,
108:                 _quoteAssetAddress,
109:                 _sizePrecision,
110:                 _pricePrecision,
111:                 _tickSize,
112:                 _minSize,
113:                 _maxSize,
114:                 _takerFeeBps,
115:                 _makerFeeBps,
116:                 _kuruAmmSpread
117:             );
118:             proxy = Create2.deploy(
119:                 0,
120:                 _salt,
121:                 abi.encodePacked(type(ERC1967Proxy).creationCode, abi.encode(orderBookImplementation, bytes("")))
122:             );
123:         }
124:         IKuruAMMVault _kuruAmmVault = IKuruAMMVault(
125:             Create2.deploy(
126:                 0,
127:                 keccak256(abi.encode(proxy)),
128:                 abi.encodePacked(type(ERC1967Proxy).creationCode, abi.encode(kuruAmmVaultImplementation, bytes("")))
129:             )
130:         );
131: 
132:         verifiedMarket[proxy] = MarketParams(
133:             _pricePrecision,
134:             _sizePrecision,
135:             _baseAssetAddress,
136:             _baseAssetDecimals,
137:             _quoteAssetAddress,
138:             _quoteAssetDecimals,
139:             _tickSize,
140:             _minSize,
141:             _maxSize,
142:             _takerFeeBps,
143:             _makerFeeBps
144:         );
145:         IMarginAccount(marginAccountAddress).updateMarkets(proxy);
146:         {
147:             IOrderBook(proxy).initialize(
148:                 address(this),
149:                 _type,
150:                 _baseAssetAddress,
151:                 _baseAssetDecimals,
152:                 _quoteAssetAddress,
153:                 _quoteAssetDecimals,
154:                 marginAccountAddress,
155:                 _sizePrecision,
156:                 _pricePrecision,
157:                 _tickSize,
158:                 _minSize,
159:                 _maxSize,
160:                 _takerFeeBps,
161:                 _makerFeeBps,
162:                 address(_kuruAmmVault),
163:                 _kuruAmmSpread,
164:                 TRUSTED_FORWARDER
165:             );
166:         }
167: 
168:         _kuruAmmVault.initialize(
169:             address(this), _baseAssetAddress, _quoteAssetAddress, marginAccountAddress, proxy, _kuruAmmSpread
170:         );
171: 
172:         _setApprovalsForMarket(_baseAssetAddress, _quoteAssetAddress, proxy, _type);
173: 
174:         emit MarketRegistered( // <= FOUND
175:             _baseAssetAddress,
176:             _quoteAssetAddress,
177:             proxy,
178:             address(_kuruAmmVault),
179:             _pricePrecision,
180:             _sizePrecision,
181:             _tickSize,
182:             _minSize,
183:             _maxSize,
184:             _takerFeeBps,
185:             _makerFeeBps,
186:             _kuruAmmSpread
187:         );
188: 
189:         return proxy;
190:     }
```


</details>

## [Low-42] Missing zero address check in initializer

### Resolution 
Initializer functions in contracts often set important parameters or addresses. Failing to check for the zero address (0x0000000000000000000000000000000000000000) in initializers can lead to unintended behavior, as this address typically signifies an unset or default value. Transfers to or interactions with the zero address can result in permanent loss of assets or broken functionality. It's crucial to add checks using `require(targetAddress != address(0), "Address cannot be zero")` in initializers to prevent accidentally setting important state variables or parameters to this address, ensuring the system's integrity and user asset safety.

Num of instances: 4

### Findings 


<details><summary>Click to show findings</summary>

['[96](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruForwarder.sol#L96-L96)']
```solidity
96:     function initialize(address _owner, bytes4[] memory _allowedInterfaces) public initializer {
97:         _initializeOwner(_owner);
98:         for (uint256 i = 0; i < _allowedInterfaces.length; i++) {
99:             allowedInterface[_allowedInterfaces[i]] = true;
100:         }
101:     }
```
['[76](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L76-L76)']
```solidity
76:     function initialize(address _owner, address _router, address _feeCollector, address _trustedForwarder)
77:         public
78:         initializer
79:     {
80:         _initializeOwner(_owner);
81:         routerContractAddress = _router;
82:         feeCollector = _feeCollector;
83:         trustedForwarder = _trustedForwarder;
84:     }
```
['[85](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L85-L85)']
```solidity
85:     function initialize(
86:         address _owner,
87:         OrderBookType _type,
88:         address _baseAssetAddress,
89:         uint256 _baseAssetDecimals,
90:         address _quoteAssetAddress,
91:         uint256 _quoteAssetDecimals,
92:         address _marginAccountAddress,
93:         uint96 _sizePrecision,
94:         uint32 _pricePrecision,
95:         uint32 _tickSize,
96:         uint96 _minSize,
97:         uint96 _maxSize,
98:         uint256 _takerFeeBps,
99:         uint256 _makerFeeBps,
100:         address _kuruAmmVault,
101:         uint96 _kuruAmmSpread,
102:         address __trustedForwarder
103:     ) public initializer {
104:         owner = _owner;
105: 
106:         require(_makerFeeBps <= _takerFeeBps && _takerFeeBps < BPS_MULTIPLIER, OrderBookErrors.MarketFeeError());
107:         require(_kuruAmmSpread % 10 == 0 && _kuruAmmSpread > 0 && _kuruAmmSpread < 500, OrderBookErrors.InvalidSpread());
108:         require(_minSize > 0 && _maxSize > _minSize, OrderBookErrors.MarketSizeError());
109:         orderBookType = _type;
110:         baseAsset = _baseAssetAddress;
111:         quoteAsset = _quoteAssetAddress;
112: 
113:         baseAssetDecimals = _baseAssetDecimals;
114:         baseDecimalMultiplier = 10 ** _baseAssetDecimals;
115:         quoteAssetDecimals = _quoteAssetDecimals;
116:         quoteDecimalMultiplier = 10 ** _quoteAssetDecimals;
117: 
118:         marginAccount = IMarginAccount(payable(_marginAccountAddress));
119:         
120:         sizePrecision = _sizePrecision;
121:         pricePrecision = _pricePrecision;
122:         tickSize = _tickSize;
123:         minSize = _minSize;
124:         maxSize = _maxSize;
125:         takerFeeBps = _takerFeeBps;
126:         makerFeeBps = _makerFeeBps;
127:         kuruAmmVault = _kuruAmmVault;
128:         SPREAD_CONSTANT = _kuruAmmSpread;
129:         vaultBestAsk = type(uint256).max;
130:         _trustedForwarder = __trustedForwarder;
131:     }
```
['[45](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L45-L45)']
```solidity
45:     function initialize(
46:         address _owner,
47:         address _marginAccount,
48:         address _orderbookImplementation,
49:         address _kuruAmmVaultImplementation,
50:         address _trustedForwarder
51:     ) public initializer {
52:         _initializeOwner(_owner);
53:         marginAccountAddress = _marginAccount;
54:         orderBookImplementation = _orderbookImplementation;
55:         kuruAmmVaultImplementation = _kuruAmmVaultImplementation;
56:         TRUSTED_FORWARDER = _trustedForwarder;
57:     }
```


</details>

## [Low-43] Critical functions should have a timelock

### Resolution 
Critical functions, especially those affecting protocol parameters or user funds, are potential points of failure or exploitation. To mitigate risks, incorporating a timelock on such functions can be beneficial. A timelock requires a waiting period between the time an action is initiated and when it's executed, giving stakeholders time to react, potentially vetoing malicious or erroneous changes. To implement, integrate a smart contract like OpenZeppelin's `TimelockController` or build a custom mechanism. This ensures governance decisions or administrative changes are transparent and allows for community or multi-signature interventions, enhancing protocol security and trustworthiness.

Num of instances: 5

### Findings 


<details><summary>Click to show findings</summary>

['[105](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruForwarder.sol#L105-L105)']
```solidity
105:     function setAllowedInterfaces(bytes4[] memory _allowedInterfaces) external onlyOwner  // <= FOUND
```
['[44](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L44-L44)']
```solidity
44:     function setFeeCollector(address _feeCollector) external onlyOwner  // <= FOUND
```
['[105](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/periphery/MonadDeployer.sol#L105-L105)']
```solidity
105:     function setKuruAmmSpread(uint96 _kuruAmmSpread) external onlyOwner  // <= FOUND
```
['[109](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/periphery/MonadDeployer.sol#L109-L109)']
```solidity
109:     function setKuruCollective(address _kuruCollective) external onlyOwner  // <= FOUND
```
['[113](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/periphery/MonadDeployer.sol#L113-L113)']
```solidity
113:     function setKuruCollectiveFee(uint256 _kuruCollectiveFee) external onlyOwner  // <= FOUND
```


</details>

## [Low-44] Unbounded loop may run out of gas

### Resolution 
Unbounded loops in smart contracts pose a risk because they iterate over an unknown number of elements, potentially consuming all available gas for a transaction. This can result in unintended transaction failures. Gas consumption increases linearly with the number of iterations, and if it surpasses the gas limit, the transaction reverts, wasting the gas spent. To mitigate this, developers should either set a maximum limit on loop iterations.

Num of instances: 12

### Findings 


<details><summary>Click to show findings</summary>

['[96](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruForwarder.sol#L96-L98)']
```solidity
96:     function initialize(address _owner, bytes4[] memory _allowedInterfaces) public initializer { // <= FOUND
97:         _initializeOwner(_owner);
98:         for (uint256 i = 0; i < _allowedInterfaces.length; i++) { // <= FOUND
99:             allowedInterface[_allowedInterfaces[i]] = true;
100:         }
101:     }
```
['[105](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruForwarder.sol#L105-L106)']
```solidity
105:     function setAllowedInterfaces(bytes4[] memory _allowedInterfaces) external onlyOwner { // <= FOUND
106:         for (uint256 i = 0; i < _allowedInterfaces.length; i++) { // <= FOUND
107:             allowedInterface[_allowedInterfaces[i]] = true;
108:         }
109:     }
```
['[111](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruForwarder.sol#L111-L112)']
```solidity
111:     function removeAllowedInterfaces(bytes4[] memory _allowedInterfaces) external onlyOwner { // <= FOUND
112:         for (uint256 i = 0; i < _allowedInterfaces.length; i++) { // <= FOUND
113:             allowedInterface[_allowedInterfaces[i]] = false;
114:         }
115:     }
```
['[177](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L177-L179)']
```solidity
177:     function batchWithdrawMaxTokens(address[] calldata _tokens) external protocolActive { // <= FOUND
178:         uint256 _balance;
179:         for (uint256 i = 0; i < _tokens.length; i++) { // <= FOUND
180:             _balance = balances[_accountKey(_msgSender(), _tokens[i])];
181:             balances[_accountKey(_msgSender(), _tokens[i])] = 0;
182:             if (_balance > 0) {
183:                 if (_tokens[i] == NATIVE) {
184:                     _msgSender().safeTransferETH(_balance);
185:                 } else {
186:                     _tokens[i].safeTransfer(_msgSender(), _balance);
187:                 }
188:             }
189:         }
190:     }
```
['[452](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L452-L453)']
```solidity
452:     function batchCancelFlipOrders(uint40[] calldata _orderIds) external marketNotHardPaused { // <= FOUND
453:         for (uint256 i = 0; i < _orderIds.length; i++) { // <= FOUND
454:             _cancelFlipOrder(_orderIds[i]);
455:         }
456: 
457:         emit FlipOrdersCanceled(_orderIds, _msgSender());
458:     }
```
['[465](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L465-L466)']
```solidity
465:     function batchCancelOrders(uint40[] calldata _orderIds) external marketNotHardPaused { // <= FOUND
466:         for (uint256 i = 0; i < _orderIds.length; i++) { // <= FOUND
467:             _cancelOrder(_orderIds[i], true);
468:         }
469: 
470:         emit OrdersCanceled(_orderIds, _msgSender());
471:     }
```
['[478](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L478-L480)']
```solidity
478:     function batchCancelOrdersNoRevert(uint40[] calldata _orderIds) external marketNotHardPaused { // <= FOUND
479:         uint40[] memory _orderIdsCanceled = new uint40[](_orderIds.length);
480:         for (uint256 i = 0; i < _orderIds.length; i++) { // <= FOUND
481:             bool _isCanceled = _cancelOrder(_orderIds[i], false);
482:             if (_isCanceled) {
483:                 _orderIdsCanceled[i] = _orderIds[i];
484:             } else {
485:                 _orderIdsCanceled[i] = 0;
486:             }
487:         }
488: 
489:         emit OrdersCanceled(_orderIdsCanceled, _msgSender());
490:     }
```
['[628](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L628-L637)']
```solidity
628:     function batchAddPairedLiquidity( // <= FOUND
629:         uint32[] calldata bidPrices,
630:         uint32[] calldata askPrices,
631:         uint96[] calldata bidSizes,
632:         uint96[] calldata askSizes
633:     ) external {
634:         require(
635:             bidPrices.length == bidSizes.length && askPrices.length == askSizes.length, OrderBookErrors.LengthMismatch()
636:         );
637:         for (uint256 i = 0; i < bidPrices.length; i++) { // <= FOUND
638:             addPairedLiquidity(bidPrices[i], askPrices[i], bidSizes[i], askSizes[i]);
639:         }
640:     }
```
['[271](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L271-L272)']
```solidity
271:     function toggleMarkets(address[] memory markets, IOrderBook.MarketState state) external onlyOwner { // <= FOUND
272:         for (uint256 i = 0; i < markets.length; i++) { // <= FOUND
273:             IOrderBook(markets[i]).toggleMarket(state);
274:         }
275:     }
```
['[281](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L281-L282)']
```solidity
281:     function upgradeMultipleOrderBookProxies(address[] memory proxies, bytes[] memory data) public onlyOwner { // <= FOUND
282:         for (uint256 i = 0; i < proxies.length; i++) { // <= FOUND
283:             UUPSUpgradeable(proxies[i]).upgradeToAndCall(orderBookImplementation, data[i]);
284:         }
285:     }
```
['[287](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L287-L288)']
```solidity
287:     function upgradeMultipleVaultProxies(address[] memory proxies, bytes[] memory data) public onlyOwner { // <= FOUND
288:         for (uint256 i = 0; i < proxies.length; i++) { // <= FOUND
289:             UUPSUpgradeable(proxies[i]).upgradeToAndCall(kuruAmmVaultImplementation, data[i]);
290:         }
291:     }
```
['[298](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L298-L299)']
```solidity
298:     function transferOwnershipForContracts(address[] memory contracts, address _newOwner) external onlyOwner { // <= FOUND
299:         for (uint256 i = 0; i < contracts.length; i++) { // <= FOUND
300:             Ownable(contracts[i]).transferOwnership(_newOwner);
301:         }
302:     }
```


</details>

## [Low-45] Consider implementing two-step procedure for updating protocol addresses

### Resolution 
Implementing a two-step procedure for updating protocol addresses adds an extra layer of security. In such a system, the first step initiates the change, and the second step, after a predefined delay, confirms and finalizes it. This delay allows stakeholders or monitoring tools to observe and react to unintended or malicious changes. If an unauthorized change is detected, corrective actions can be taken before the change is finalized. To achieve this, introduce a "proposed address" state variable and a "delay period". Upon an update request, set the "proposed address". After the delay, if not contested, the main protocol address can be updated.

Num of instances: 2

### Findings 


<details><summary>Click to show findings</summary>

['[44](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L44-L44)']
```solidity
44:     function setFeeCollector(address _feeCollector) external onlyOwner { // <= FOUND
45:         require(feeCollector != _feeCollector, MarginAccountErrors.FeeCollectorNotChanged());
46:         feeCollector = _feeCollector;
47:         emit FeeCollectorUpdated(_feeCollector);
48:     }
```
['[109](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/periphery/MonadDeployer.sol#L109-L109)']
```solidity
109:     function setKuruCollective(address _kuruCollective) external onlyOwner { // <= FOUND
110:         kuruCollective = _kuruCollective;
111:     }
```


</details>

## [Low-46] SafeTransferLib does not ensure that the token contract exists

### Resolution 
SafeTransferLib as similarly named function as OpenZepelins SafeERC20 module however it's functions such as safeTransferFrom don't check if the contract exists which can result in silent failures when performing such operations. As such it is recommended to perform a contract existence check beforehand. 

Num of instances: 1

### Findings 


<details><summary>Click to show findings</summary>

['[5](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L5-L5)']
```solidity
5: import {SafeTransferLib} from "solady/src/utils/SafeTransferLib.sol"; // <= FOUND
```


</details>

## [Low-47] Don't assume specific ETH balance

### Resolution 
ETH balances can change due to gas costs, miner reordering, or unexpected transactions. Directly comparing an expected balance with `==` or `!=` can lead to unpredictable results. Instead, use range checks or require a minimum balance. For instance, instead of requiring an exact balance, check if an account's balance is within an acceptable range or above a certain threshold. This provides flexibility and accounts for slight variations that might occur due to the dynamic nature of blockchain transactions and fees. By avoiding exact balance checks, smart contracts can avoid unintentional failures and enhance robustness.

Num of instances: 2

### Findings 


<details><summary>Click to show findings</summary>

['[201](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L201-L201)']
```solidity
201:             require(msg.value == _amount, MarginAccountErrors.NativeAssetMismatch()); // <= FOUND
```
['[84](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/periphery/MonadDeployer.sol#L84-L84)']
```solidity
84:         if (msg.value != (marketParams.nativeTokenAmount + kuruCollectiveFee)) { // <= FOUND
```


</details>

## [Low-48] Avoid mutating function parameters

### Resolution 
Function parameters in Solidity are passed by value, meaning they are essentially local copies. Mutating them can lead to confusion and errors because the changes don't persist outside the function. By keeping function parameters immutable, you ensure clarity in code behavior, preventing unintended side-effects. If you need to modify a value based on a parameter, use a local variable inside the function, leaving the original parameter unaltered. By adhering to this practice, you maintain a clear distinction between input data and the internal processing logic, improving code readability and reducing the potential for bugs.

Num of instances: 10

### Findings 


<details><summary>Click to show findings</summary>

['[175](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L175-L187)']
```solidity
175:     function _mintAndDeposit(uint256 baseDeposit, uint256 quoteDeposit, address receiver) internal returns (uint256) { // <= FOUND
176:         (uint256 _baseAmount, uint256 _currentAskPrice) = _returnNormalizedAmountAndPrice(true);
177:         uint256 _shares;
178:         if (totalSupply() != 0) {
179:             uint256 _expectedQuoteAmount = (
180:                 (
181:                     FixedPointMathLib.mulDivUp(baseDeposit, _currentAskPrice, vaultPricePrecision)
182:                         * 10 ** marketParams.quoteAssetDecimals
183:                 )
184:             ) / 10 ** marketParams.baseAssetDecimals;
185:             require(_expectedQuoteAmount <= quoteDeposit, KuruAMMVaultErrors.InsufficientQuoteToken());
186:             _shares = _convertToShares(baseDeposit, _expectedQuoteAmount, _currentAskPrice);
187:             quoteDeposit = _expectedQuoteAmount; // <= FOUND
188:             _mint(receiver, _shares);
189:         } else {
190:             _shares = FixedPointMathLib.sqrt(baseDeposit * quoteDeposit);
191:             _mint(address(marginAccount), MIN_LIQUIDITY);
192:             _shares -= MIN_LIQUIDITY;
193:             _mint(receiver, _shares);
194:             _currentAskPrice = (
195:                 ((quoteDeposit * 10 ** marketParams.baseAssetDecimals)) * vaultPricePrecision
196:                     / 10 ** marketParams.quoteAssetDecimals
197:             ) / (baseDeposit);
198:         }
199:         require(_shares > 0, KuruAMMVaultErrors.InsufficientLiquidityMinted());
200:         (uint96 _newAskSize, uint96 _newBidSize) = _getVaultSizesForBaseAmount(_baseAmount + baseDeposit);
201:         market.updateVaultOrdSz(
202:             _newAskSize,
203:             _newBidSize,
204:             _currentAskPrice,
205:             FixedPointMathLib.mulDivRound(_currentAskPrice, BPS_MULTIPLIER, BPS_MULTIPLIER + SPREAD_CONSTANT),
206:             false
207:         );
208:         address _token1 = token1;
209:         address _token2 = token2;
210:         _depositAmountsToMarginAccount(_token1, _token2, baseDeposit, quoteDeposit);
211:         uint256 _nativeRefund =
212:             _token1 == address(0) ? (msg.value - baseDeposit) : (_token2 == address(0) ? (msg.value - quoteDeposit) : 0);
213:         if (_nativeRefund > 0) {
214:             msg.sender.safeTransferETH(_nativeRefund);
215:         }
216:         emit KuruVaultDeposit(baseDeposit, quoteDeposit, _shares, receiver);
217:         return _shares;
218:     }
```
['[202](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L202-L202)']
```solidity
202:     function expWad(int256 x) internal pure returns (int256 r) { // <= FOUND
203:         unchecked {
204:             
205:             
206:             if (x <= -41446531673892822313) return r;
207: 
208:             
209:             assembly {
210:                 
211:                 
212:                 if iszero(slt(x, 135305999368893231589)) {
213:                     mstore(0x00, 0xa37bfec9) 
214:                     revert(0x1c, 0x04)
215:                 }
216:             }
217: 
218:             
219:             
220:             
221:             x = (x << 78) / 5 ** 18;
222: 
223:             
224:             
225:             
226:             int256 k = ((x << 96) / 54916777467707473351141471128 + 2 ** 95) >> 96;
227:             x = x - k * 54916777467707473351141471128;
228: 
229:             
230: 
231:             
232:             
233:             int256 y = x + 1346386616545796478920950773328;
234:             y = ((y * x) >> 96) + 57155421227552351082224309758442;
235:             int256 p = y + x - 94201549194550492254356042504812;
236:             p = ((p * y) >> 96) + 28719021644029726153956944680412240;
237:             p = p * x + (4385272521454847904659076985693276 << 96);
238: 
239:             
240:             int256 q = x - 2855989394907223263936484059900;
241:             q = ((q * x) >> 96) + 50020603652535783019961831881945;
242:             q = ((q * x) >> 96) - 533845033583426703283633433725380;
243:             q = ((q * x) >> 96) + 3604857256930695427073651918091429;
244:             q = ((q * x) >> 96) - 14423608567350463180887372962807573;
245:             q = ((q * x) >> 96) + 26449188498355588339934803723976023;
246: 
247:             
248:             assembly {
249:                 
250:                 
251:                 
252:                 r := sdiv(p, q)
253:             }
254: 
255:             
256: 
257:             
258:             
259:             
260:             
261:             
262:             
263:             r = int256((uint256(r) * 3822833074963236453042738258902158003155416615667) >> uint256(195 - k));
264:         }
265:     }
```
['[346](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L346-L346)']
```solidity
346:     function lambertW0Wad(int256 x) internal pure returns (int256 w) { // <= FOUND
347:         
348:         unchecked {
349:             if ((w = x) <= -367879441171442322) revert OutOfDomain(); 
350:             int256 wad = int256(WAD);
351:             int256 p = x;
352:             uint256 c; 
353:             uint256 i = 4; 
354:             if (w <= 0x1ffffffffffff) {
355:                 if (-0x4000000000000 <= w) {
356:                     i = 1; 
357:                 } else if (w <= -0x3ffffffffffffff) {
358:                     i = 32; 
359:                 }
360:             } else if (uint256(w >> 63) == uint256(0)) {
361:                 
362:                 assembly {
363:                     
364:                     let v := shr(49, w)
365:                     let l := shl(3, lt(0xff, v))
366:                     l := add(or(l, byte(and(0x1f, shr(shr(l, v), 0x8421084210842108cc6318c6db6d54be)),
367:                         0x0706060506020504060203020504030106050205030304010505030400000000)), 49)
368:                     w := sdiv(shl(l, 7), byte(sub(l, 31), 0x0303030303030303040506080c13))
369:                     c := gt(l, 60)
370:                     i := add(2, add(gt(l, 53), c))
371:                 }
372:             } else {
373:                 int256 ll = lnWad(w = lnWad(w));
374:                 
375:                 assembly {
376:                     
377:                     w := add(sdiv(mul(ll, 1023715080943847266), w), sub(w, ll))
378:                     i := add(3, iszero(shr(68, x)))
379:                     c := iszero(shr(143, x))
380:                 }
381:                 if (c == uint256(0)) {
382:                     do { 
383:                         int256 e = expWad(w);
384:                         
385:                         assembly {
386:                             let t := mul(w, div(e, wad))
387:                             w := sub(w, sdiv(sub(t, x), div(add(e, t), wad)))
388:                         }
389:                         if (p <= w) break;
390:                         p = w;
391:                     } while (--i != uint256(0));
392:                     
393:                     assembly {
394:                         w := sub(w, sgt(w, 2))
395:                     }
396:                     return w;
397:                 }
398:             }
399:             do { 
400:                 int256 e = expWad(w);
401:                 
402:                 assembly {
403:                     let t := add(w, wad)
404:                     let s := sub(mul(w, e), mul(x, wad))
405:                     w := sub(w, sdiv(mul(s, wad), sub(mul(e, t), sdiv(mul(add(t, wad), s), add(t, t)))))
406:                 }
407:                 if (p <= w) break;
408:                 p = w;
409:             } while (--i != c);
410:             
411:             assembly {
412:                 w := sub(w, sgt(w, 2))
413:             }
414:             
415:             
416:             if (c == uint256(0)) return w;
417:             int256 t = w | 1;
418:             
419:             assembly {
420:                 x := sdiv(mul(x, wad), t)
421:             }
422:             x = (t * (wad + lnWad(x)));
423:             
424:             assembly {
425:                 w := sdiv(x, add(wad, t))
426:             }
427:         }
428:     }
```
['[1033](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L1033-L1033)']
```solidity
1033:     function lerp(uint256 a, uint256 b, uint256 t, uint256 begin, uint256 end) internal pure returns (uint256) { // <= FOUND
1034:         if (begin > end) {
1035:             t = ~t;
1036:             begin = ~begin;
1037:             end = ~end;
1038:         }
1039:         if (t <= begin) return a;
1040:         if (t >= end) return b;
1041:         unchecked {
1042:             if (b >= a) return a + fullMulDiv(b - a, t - begin, end - begin);
1043:             return a - fullMulDiv(a - b, t - begin, end - begin);
1044:         }
1045:     }
```
['[1051](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L1051-L1051)']
```solidity
1051:     function lerp(int256 a, int256 b, int256 t, int256 begin, int256 end) internal pure returns (int256) { // <= FOUND
1052:         if (begin > end) {
1053:             t = int256(~uint256(t));
1054:             begin = int256(~uint256(begin));
1055:             end = int256(~uint256(end));
1056:         }
1057:         if (t <= begin) return a;
1058:         if (t >= end) return b;
1059:         
1060:         unchecked {
1061:             if (b >= a) return int256(uint256(a) + fullMulDiv(uint256(b) - uint256(a),
1062:                 uint256(t) - uint256(begin), uint256(end) - uint256(begin)));
1063:             return int256(uint256(a) - fullMulDiv(uint256(a) - uint256(b),
1064:                 uint256(t) - uint256(begin), uint256(end) - uint256(begin)));
1065:         }
1066:     }
```
['[855](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L855-L865)']
```solidity
855:     function _matchAggressiveBuyWithCap(uint256 _limitPrice, uint96 _sizeToBeFilled) // <= FOUND
856:         internal
857:         returns (uint96, uint96)
858:     {
859:         uint96 sizeToCreditTaker;
860:         uint96 sizeToCreditViaVault;
861:         uint96 fundsConsumed;
862:         bytes memory makerCredits;
863:         (bool _isVaultFill, uint256 _bestAsk) = bestAsk();
864:         uint32 _pricePrecision = pricePrecision;
865:         _limitPrice = _limitPrice * vaultPricePrecision / _pricePrecision; // <= FOUND
866: 
867:         while (_sizeToBeFilled > 0 && _bestAsk <= _limitPrice && _bestAsk != 0) {
868:             uint96 sizeToBeFilledBefore = _sizeToBeFilled; 
869:             bytes memory priceUpdate;
870: 
871:             if (_isVaultFill) {
872:                 uint96 _vaultFundsConsumed;
873:                 (_sizeToBeFilled, _vaultFundsConsumed, priceUpdate) =
874:                     _fillVaultForBuy(_getOBAsk() > _limitPrice ? _limitPrice + 1 : _getOBAsk(), _sizeToBeFilled);
875:                 fundsConsumed += _vaultFundsConsumed;
876:             } else {
877:                 (_sizeToBeFilled, priceUpdate) = _fillSizeForPrice(
878:                     s_sellTree,
879:                     toU32(_bestAsk * _pricePrecision / vaultPricePrecision),
880:                     s_sellPricePoints[_bestAsk * _pricePrecision / vaultPricePrecision],
881:                     _sizeToBeFilled
882:                 );
883:             }
884: 
885:             uint96 sizeFilled = sizeToBeFilledBefore - _sizeToBeFilled;
886:             sizeToCreditTaker += sizeFilled;
887:             if (_isVaultFill) {
888:                 sizeToCreditViaVault += sizeFilled;
889:             } else {
890:                 fundsConsumed += _quoteAmountRoundedUp(
891:                     toU32(FixedPointMathLib.mulDivUp(_bestAsk, _pricePrecision, vaultPricePrecision)), sizeFilled
892:                 );
893:             }
894:             makerCredits = bytes.concat(makerCredits, priceUpdate);
895: 
896:             (_isVaultFill, _bestAsk) = bestAsk();
897:         }
898: 
899:         if (sizeToCreditTaker == 0) {
900:             return (_sizeToBeFilled, 0);
901:         }
902:         {
903:             uint96 _sizePrecision = sizePrecision;
904:             uint256 _baseDecimalMultiplier = baseDecimalMultiplier;
905:             uint256 _tokenCredit = (sizeToCreditTaker * _baseDecimalMultiplier) / _sizePrecision;
906:             if (sizeToCreditViaVault > 0) {
907:                 marginAccount.debitUser(
908:                     kuruAmmVault, baseAsset, (sizeToCreditViaVault * _baseDecimalMultiplier) / _sizePrecision
909:                 );
910:             }
911:             uint256 _takerFeeBps = takerFeeBps;
912:             if (_takerFeeBps > 0) {
913:                 uint256 _feeDebit = FixedPointMathLib.mulDivUp(_tokenCredit, _takerFeeBps, BPS_MULTIPLIER);
914:                 _tokenCredit -= _feeDebit;
915:                 
916:                 baseFeeCollected += ((_feeDebit * (_takerFeeBps - makerFeeBps)) / _takerFeeBps);
917:             }
918:             marginAccount.creditUsersEncoded(
919:                 bytes.concat(makerCredits, abi.encode(_msgSender(), baseAsset, _tokenCredit, true))
920:             );
921:         }
922: 
923:         return (_sizeToBeFilled, fundsConsumed);
924:     }
```
['[930](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L930-L958)']
```solidity
930:     function _marketBuyMatch(uint96 _quoteSize, bool _isMargin) internal returns (uint96, uint256) { // <= FOUND
931:         uint96 sizeToCreditTaker;
932:         uint96 sizeToCreditViaVault;
933:         bytes memory makerCredits;
934:         uint32 _pricePrecision = pricePrecision;
935:         uint96 _sizePrecision = sizePrecision;
936: 
937:         (bool _isVaultFill, uint256 _bestAsk) = bestAsk();
938: 
939:         while (_quoteSize > 0 && _bestAsk != 0) {
940:             bytes memory priceUpdate;
941:             if (_isVaultFill) {
942:                 uint96 _sizeFilled;
943:                 (_quoteSize, _sizeFilled, priceUpdate) = _fillVaultBuyMatch(_getOBAsk(), _quoteSize);
944:                 sizeToCreditViaVault += _sizeFilled;
945:                 sizeToCreditTaker += _sizeFilled;
946:             } else {
947:                 
948:                 uint96 _sizeFillableAtPriceLeft =
949:                     toU96(_quoteSize * _sizePrecision * vaultPricePrecision / (_bestAsk * _pricePrecision));
950:                 uint96 _sizeFillableAtPriceBefore = _sizeFillableAtPriceLeft; 
951:                 (_sizeFillableAtPriceLeft, priceUpdate) = _fillSizeForPrice(
952:                     s_sellTree,
953:                     toU32(_bestAsk * _pricePrecision / vaultPricePrecision),
954:                     s_sellPricePoints[(_bestAsk * _pricePrecision / vaultPricePrecision)],
955:                     _sizeFillableAtPriceLeft
956:                 );
957:                 sizeToCreditTaker += (_sizeFillableAtPriceBefore - _sizeFillableAtPriceLeft);
958:                 _quoteSize = toU96( // <= FOUND
959:                     FixedPointMathLib.mulDiv(
960:                         _bestAsk * _pricePrecision, _sizeFillableAtPriceLeft, _sizePrecision * vaultPricePrecision
961:                     )
962:                 );
963:             }
964:             makerCredits = bytes.concat(makerCredits, priceUpdate);
965: 
966:             (_isVaultFill, _bestAsk) = bestAsk();
967:         }
968: 
969:         if (sizeToCreditTaker == 0) {
970:             return (_quoteSize, 0);
971:         }
972: 
973:         {
974:             uint256 _baseDecimalMultiplier = baseDecimalMultiplier;
975:             uint256 _tokenCredit = (sizeToCreditTaker * _baseDecimalMultiplier) / _sizePrecision;
976:             if (sizeToCreditViaVault > 0 && msg.sender != address(0)) {
977:                 marginAccount.debitUser(
978:                     kuruAmmVault, baseAsset, (sizeToCreditViaVault * _baseDecimalMultiplier) / _sizePrecision
979:                 );
980:             }
981:             uint256 _takerFeeBps = takerFeeBps;
982:             if (_takerFeeBps > 0) {
983:                 uint256 _feeDebit = FixedPointMathLib.mulDivUp(_tokenCredit, _takerFeeBps, BPS_MULTIPLIER);
984:                 _tokenCredit -= _feeDebit;
985:                 
986:                 baseFeeCollected += ((_feeDebit * (_takerFeeBps - makerFeeBps)) / _takerFeeBps);
987:             }
988:             if (msg.sender != address(0)) {
989:                 marginAccount.creditUsersEncoded(
990:                     bytes.concat(makerCredits, abi.encode(_msgSender(), baseAsset, _tokenCredit, _isMargin))
991:                 );
992:             }
993:             return (_quoteSize, _tokenCredit);
994:         }
995:     }
```
['[1003](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L1003-L1013)']
```solidity
1003:     function _matchAggressiveSell(uint256 _limitPrice, uint96 _sizeToBeFilledLeft, bool _useMargin) // <= FOUND
1004:         internal
1005:         returns (uint96, uint256)
1006:     {
1007:         uint96 quoteCreditTaker;
1008:         uint256 quoteCreditVaultTaker;
1009:         uint256 tokenCredit;
1010:         (bool _isVaultFill, uint256 _bestBid) = bestBid();
1011:         bytes memory makerCredits;
1012:         uint32 _pricePrecision = pricePrecision;
1013:         _limitPrice = _limitPrice * vaultPricePrecision / _pricePrecision; // <= FOUND
1014:         while (_sizeToBeFilledLeft > 0 && _bestBid >= _limitPrice && _bestBid != type(uint256).max) {
1015:             uint96 _sizeToBeFilledBefore = _sizeToBeFilledLeft; 
1016: 
1017:             bytes memory priceUpdate;
1018: 
1019:             if (_isVaultFill) {
1020:                 uint256 _quoteToTaker;
1021:                 (_sizeToBeFilledLeft, _quoteToTaker, priceUpdate) =
1022:                     _fillVaultForSell(_getOBBid() >= _limitPrice ? _getOBBid() : _limitPrice - 1, _sizeToBeFilledLeft);
1023:                 quoteCreditVaultTaker += _quoteToTaker;
1024:             } else {
1025:                 (_sizeToBeFilledLeft, priceUpdate) = _fillSizeForPrice(
1026:                     s_buyTree,
1027:                     toU32(_bestBid * _pricePrecision / vaultPricePrecision),
1028:                     s_buyPricePoints[_bestBid * _pricePrecision / vaultPricePrecision],
1029:                     _sizeToBeFilledLeft
1030:                 );
1031:                 quoteCreditTaker += toU96(
1032:                     FixedPointMathLib.mulDiv(
1033:                         _sizeToBeFilledBefore - _sizeToBeFilledLeft,
1034:                         toU32(_bestBid * _pricePrecision / vaultPricePrecision),
1035:                         sizePrecision
1036:                     )
1037:                 );
1038:             }
1039:             makerCredits = bytes.concat(makerCredits, priceUpdate);
1040: 
1041:             (_isVaultFill, _bestBid) = bestBid();
1042:         }
1043: 
1044:         if (quoteCreditTaker == 0 && quoteCreditVaultTaker == 0) {
1045:             return (_sizeToBeFilledLeft, 0);
1046:         }
1047:         {
1048:             uint256 _quoteDecimalMultiplier = quoteDecimalMultiplier;
1049:             tokenCredit = ((quoteCreditTaker) * _quoteDecimalMultiplier) / _pricePrecision
1050:                 + (quoteCreditVaultTaker * _quoteDecimalMultiplier) / vaultPricePrecision;
1051:             if (quoteCreditVaultTaker > 0 && msg.sender != address(0)) {
1052:                 marginAccount.debitUser(
1053:                     kuruAmmVault, quoteAsset, (quoteCreditVaultTaker * _quoteDecimalMultiplier) / vaultPricePrecision
1054:                 );
1055:             }
1056:             uint256 _takerFeeBps = takerFeeBps;
1057:             if (_takerFeeBps > 0) {
1058:                 uint256 _feeDebit = FixedPointMathLib.mulDivUp(tokenCredit, _takerFeeBps, BPS_MULTIPLIER);
1059:                 tokenCredit -= _feeDebit;
1060:                 
1061:                 quoteFeeCollected += ((_feeDebit * (_takerFeeBps - makerFeeBps)) / _takerFeeBps);
1062:             }
1063:             if (msg.sender != address(0)) {
1064:                 marginAccount.creditUsersEncoded(
1065:                     bytes.concat(makerCredits, abi.encode(_msgSender(), quoteAsset, tokenCredit, _useMargin))
1066:                 );
1067:             }
1068:         }
1069: 
1070:         return (_sizeToBeFilledLeft, tokenCredit);
1071:     }
```
['[1166](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L1166-L1175)']
```solidity
1166:     function _handleFlipOrderUpdate(uint40 _orderId, uint96 _size, bool nullify) internal { // <= FOUND
1167:         
1168:         if (s_orders[_orderId].flippedId == OrderLinkedList.NULL) {
1169:             Order memory _filledOrder = s_orders[_orderId];
1170:             
1171:             uint40 _flipOrderId = s_orderIdCounter + 1;
1172:             s_orderIdCounter = _flipOrderId;
1173:             uint40 _prevOrderId;
1174:             if (!s_orders[_orderId].isBuy) {
1175:                 _size = toU96(FixedPointMathLib.mulDiv(_size, _filledOrder.price, _filledOrder.flippedPrice)); // <= FOUND
1176:                 _prevOrderId = OrderLinkedList.insertAtTail(s_buyPricePoints[_filledOrder.flippedPrice], _flipOrderId);
1177:             } else {
1178:                 _prevOrderId = OrderLinkedList.insertAtTail(s_sellPricePoints[_filledOrder.flippedPrice], _flipOrderId);
1179:             }
1180:             if (!nullify) {
1181:                 s_orders[_orderId].flippedId = _flipOrderId;
1182:             }
1183:             _addFlippedOrder(
1184:                 _filledOrder.flippedPrice,
1185:                 _filledOrder.price,
1186:                 _size,
1187:                 _filledOrder.ownerAddress,
1188:                 _flipOrderId,
1189:                 nullify ? OrderLinkedList.NULL : _orderId,
1190:                 !_filledOrder.isBuy,
1191:                 _prevOrderId
1192:             );
1193:         } else {
1194:             
1195:             uint40 _flipOrderId = s_orders[_orderId].flippedId;
1196:             if (!s_orders[_orderId].isBuy) {
1197:                 _size =
1198:                     toU96(FixedPointMathLib.mulDiv(_size, s_orders[_orderId].price, s_orders[_orderId].flippedPrice));
1199:             }
1200:             uint96 _updatedSize = s_orders[_flipOrderId].size + _size;
1201:             s_orders[_flipOrderId].size = _updatedSize;
1202:             emit FlipOrderUpdated(_flipOrderId, _updatedSize);
1203:             if (nullify) {
1204:                 s_orders[_flipOrderId].flippedId = OrderLinkedList.NULL;
1205:             }
1206:         }
1207:     }
```
['[331](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L331-L367)']
```solidity
331:     function anyToAnySwap( // <= FOUND
332:         address[] calldata _marketAddresses,
333:         bool[] calldata _isBuy,
334:         bool[] calldata _nativeSend,
335:         address _debitToken,
336:         address _creditToken,
337:         uint256 _amount,
338:         uint256 _minAmountOut
339:     ) external payable returns (uint256 _amountOut) {
340:         require(_marketAddresses.length >= 1, RouterErrors.NoMarketsPassed());
341:         require(_isBuy.length == _marketAddresses.length, RouterErrors.LengthMismatch());
342:         require(_nativeSend.length == _marketAddresses.length, RouterErrors.LengthMismatch());
343:         if (_nativeSend[0] == false) {
344:             _debitToken.safeTransferFrom(msg.sender, address(this), _amount);
345:         }
346:         uint256 _cachedAmountIn = _amount;
347: 
348:         for (uint256 i = 0; i < _marketAddresses.length; i++) {
349:             address _currentMarket = _marketAddresses[i];
350:             MarketParams memory _marketParams = verifiedMarket[_currentMarket];
351:             require(_marketParams.pricePrecision > 0, RouterErrors.InvalidMarket());
352:             IOrderBook market = IOrderBook(_currentMarket);
353:             uint256 _value = _nativeSend[i] ? _amount : 0;
354:             _amountOut = _isBuy[i]
355:                 ? (
356:                     market.placeAndExecuteMarketBuy{value: _value}(
357:                         toU96(_amount * _marketParams.pricePrecision / 10 ** _marketParams.quoteAssetDecimals),
358:                         0,
359:                         false,
360:                         true
361:                     )
362:                 )
363:                 : market.placeAndExecuteMarketSell{value: _value}(
364:                     toU96(_amount * _marketParams.sizePrecision / 10 ** _marketParams.baseAssetDecimals), 0, false, true
365:                 );
366: 
367:             _amount = _amountOut; // <= FOUND
368:         }
369:         require(_amountOut >= _minAmountOut, RouterErrors.SlippageExceeded());
370:         emit KuruRouterSwap(msg.sender, _debitToken, _creditToken, _cachedAmountIn, _amountOut);
371:         if (_creditToken != address(0)) {
372:             _creditToken.safeTransfer(msg.sender, _amountOut);
373:         } else {
374:             msg.sender.safeTransferETH(_amountOut);
375:         }
376:     }
```


</details>

## [Low-49] Create methods are suspicious of the reorg attack

### Resolution 
"Create" methods, which deploy contracts via " = new <contract>", are at risk from re-org attacks since the derived contract address is solely based on the Factory's nonce. Re-orgs, chain reorganizations, can occur across all EVM chains. The vulnerability amplifies when deploying contracts on EVM-compatible L2 solutions like Arbitrum and Polygon, which are notably susceptible to re-org attacks. Ethereum, a primary deployment target, has already experienced re-org events.

To bolster security against re-org threats, developers are advised to use the `create2` method for contract deployments instead of the basic `create`. By using `create2` with a salt that includes `msg.sender`, the contract's address derivation becomes more predictable and less prone to unexpected changes due to re-orgs. This strategy not only provides a more consistent deployment pattern but also minimizes risks associated with potential blockchain reorganizations.

Num of instances: 1

### Findings 


<details><summary>Click to show findings</summary>

['[65](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/periphery/MonadDeployer.sol#L65-L70)']
```solidity
65:     function deployTokenAndMarket(
66:         TokenParams memory tokenParams,
67:         MarketParams memory marketParams,
68:         bytes calldata metadata
69:     ) external payable returns (address market) {
70:         KuruERC20 token = new KuruERC20(tokenParams.name, tokenParams.symbol, tokenParams.initialSupply, address(this)); // <= FOUND
71:         market = router.deployProxy(
72:             IOrderBook.OrderBookType.NATIVE_IN_QUOTE,
73:             address(token),
74:             address(0),
75:             marketParams.sizePrecision,
76:             marketParams.pricePrecision,
77:             marketParams.tickSize,
78:             marketParams.minSize,
79:             marketParams.maxSize,
80:             marketParams.takerFeeBps,
81:             marketParams.makerFeeBps,
82:             kuruAmmSpread
83:         );
84:         if (msg.value != (marketParams.nativeTokenAmount + kuruCollectiveFee)) {
85:             revert InsufficientAssets(marketParams.nativeTokenAmount + kuruCollectiveFee, msg.value);
86:         }
87:         (address vault,,,,,,,) = IOrderBook(market).getVaultParams();
88:         uint256 _supplyToVault = tokenParams.initialSupply * (10 ** 4 - tokenParams.supplyToDev) / 10 ** 4;
89:         token.approve(vault, _supplyToVault);
90:         IKuruAMMVault(vault).deposit{value: marketParams.nativeTokenAmount}(
91:             _supplyToVault, marketParams.nativeTokenAmount, address(this)
92:         );
93:         token.transfer(tokenParams.dev, tokenParams.initialSupply - _supplyToVault);
94:         marginAccount.deposit{value: kuruCollectiveFee}(kuruCollective, address(0), kuruCollectiveFee);
95:         emit PumpingTime(
96:             address(token),
97:             tokenParams.tokenURI,
98:             tokenParams.dev,
99:             tokenParams.initialSupply - _supplyToVault,
100:             market,
101:             metadata
102:         );
103:     }
```


</details>

## [Low-50] Missing contract-existence checks before low-level calls

### Resolution 
Low-level calls in Solidity, when made to addresses without contract code, don't fail but return a successful status. This behavior can be misleading, leading to unintended consequences in dApps. Ignoring this can potentially mean acting on false positive results. To address this, apart from the conventional zero-address check, developers should verify the existence of contract code at the target address by ensuring that the code length at the specified address (`<address>.code.length`) is greater than zero. By doing so, it provides a more robust validation before executing low-level calls, safeguarding against unintentional interactions with empty addresses.

Num of instances: 3

### Findings 


<details><summary>Click to show findings</summary>

['[219](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruForwarder.sol#L219-L231)']
```solidity
219:     function executeMarginAccountRequest(MarginAccountRequest calldata req, bytes calldata signature)
220:         public
221:         payable
222:         returns (bytes memory)
223:     {
224:         require(verifyMarginAccountRequest(req, signature), KuruForwarderErrors.SignatureMismatch());
225:         require(msg.value >= req.value, KuruForwarderErrors.InsufficientValue());
226:         require(allowedInterface[req.selector], KuruForwarderErrors.InterfaceNotAllowed());
227: 
228:         _nonces[req.from] = req.nonce + 1;
229: 
230:         (bool success, bytes memory returndata) =
231:             req.marginAccount.call{value: req.value}(abi.encodePacked(req.selector, req.data, req.from)); // <= FOUND
232: 
233:         if (!success) {
234:             revert ExecutionFailed(returndata);
235:         }
236: 
237:         return returndata;
238:     }
```
['[240](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruForwarder.sol#L240-L248)']
```solidity
240:     function execute(ForwardRequest calldata req, bytes calldata signature) public payable returns (bytes memory) {
241:         require(verify(req, signature), KuruForwarderErrors.SignatureMismatch());
242:         require(msg.value >= req.value, KuruForwarderErrors.InsufficientValue());
243:         require(allowedInterface[req.selector], KuruForwarderErrors.InterfaceNotAllowed());
244: 
245:         _nonces[req.from] = req.nonce + 1;
246: 
247:         (bool success, bytes memory returndata) =
248:             req.market.call{value: req.value}(abi.encodePacked(req.selector, req.data, req.from)); // <= FOUND
249: 
250:         if (!success) {
251:             revert ExecutionFailed(returndata);
252:         }
253: 
254:         return returndata;
255:     }
```
['[257](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruForwarder.sol#L257-L273)']
```solidity
257:     function executePriceDependent(PriceDependentRequest calldata req, bytes calldata signature)
258:         public
259:         payable
260:         returns (bytes memory)
261:     {
262:         require(verifyPriceDependent(req, signature), KuruForwarderErrors.SignatureMismatch());
263:         require(msg.value >= req.value, KuruForwarderErrors.InsufficientValue());
264:         require(allowedInterface[req.selector], KuruForwarderErrors.InterfaceNotAllowed());
265:         executedPriceDependentRequest[keccak256(abi.encodePacked(req.from, req.nonce))] = true;
266: 
267:         (uint256 _currentBidPrice,) = IOrderBook(req.market).bestBidAsk();
268:         require(
269:             (req.isBelowPrice && req.price < _currentBidPrice) || (!req.isBelowPrice && req.price > _currentBidPrice),
270:             PriceDependentRequestFailed(_currentBidPrice, req.price)
271:         );
272:         (bool success, bytes memory returndata) =
273:             req.market.call{value: req.value}(abi.encodePacked(req.selector, req.data, req.from)); // <= FOUND
274: 
275:         if (!success) {
276:             revert ExecutionFailed(returndata);
277:         }
278: 
279:         return returndata;
280:     }
```


</details>

## [Low-51] No limits when setting price amounts

### Resolution 
When settings price state variables, ensure there a require checks in place to prevent incorrect values from being set. This is especially true for price values which directly influence users.

Num of instances: 1

### Findings 


<details><summary>Click to show findings</summary>

['[300](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/AbstractAMM.sol#L300-L319)']
```solidity
300:     function updateVaultOrdSz( // <= FOUND
301:         uint96 _vaultAskOrderSize,
302:         uint96 _vaultBidOrderSize,
303:         uint256 _askPrice, // <= FOUND
304:         uint256 _bidPrice, // <= FOUND
305:         bool _nullifyPartialFills
306:     ) external onlyVault nonReentrant marketNotHardPaused {
307:         vaultBidOrderSize = _vaultBidOrderSize;
308:         vaultAskOrderSize = _vaultAskOrderSize;
309: 
310:         if (_nullifyPartialFills) {
311:             askPartiallyFilledSize = 0;
312:             bidPartiallyFilledSize = 0;
313:         }
314: 
315:         if (vaultBestAsk == type(uint256).max) {
316:             vaultBestAsk = _askPrice; // <= FOUND
317:         }
318:         if (vaultBestBid == 0) {
319:             vaultBestBid = _bidPrice; // <= FOUND
320:         }
321:         emit VaultParamsUpdated(
322:             _vaultAskOrderSize,
323:             askPartiallyFilledSize,
324:             _vaultBidOrderSize,
325:             bidPartiallyFilledSize,
326:             vaultBestAsk,
327:             vaultBestBid
328:         );
329:     }
```


</details>

## [Low-52] Constructors missing validation

### Resolution 
In Solidity, when values are being assigned in constructors to unsigned or integer variables, it's crucial to ensure the provided values adhere to the protocol's specific operational boundaries as laid out in the project specifications and documentation. If the constructors lack appropriate validation checks, there's a risk of setting state variables with values that could cause unexpected and potentially detrimental behavior within the contract's operations, violating the intended logic of the protocol. This can compromise the contract's security and impact the maintainability and reliability of the system. In order to avoid such issues, it is recommended to incorporate rigorous validation checks in constructors. These checks should align with the project's defined rules and constraints, making use of Solidity's built-in require function to enforce these conditions. If the validation checks fail, the require function will cause the transaction to revert, ensuring the integrity and adherence to the protocol's expected behavior.

Num of instances: 2

### Findings 


<details><summary>Click to show findings</summary>

['[12](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/periphery/ERC20.sol#L12-L13)']
```solidity
12:     constructor(string memory name_, string memory symbol_, uint256 initialSupply_, address mintRecipient_) {
13:         _name = name_; // <= FOUND
14:         _symbol = symbol_;
15:         
16:         _mint(mintRecipient_, initialSupply_);
17:     }
```
['[49](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/periphery/MonadDeployer.sol#L49-L58)']
```solidity
49:     constructor(
50:         IRouter _router,
51:         address _owner,
52:         address _marginAccount,
53:         address _kuruCollective,
54:         uint96 _kuruAmmSpread,
55:         uint256 _kuruCollectiveFee
56:     ) {
57:         _initializeOwner(_owner);
58:         router = _router; // <= FOUND
59:         marginAccount = IMarginAccount(_marginAccount);
60:         kuruAmmSpread = _kuruAmmSpread;
61:         kuruCollective = _kuruCollective;
62:         kuruCollectiveFee = _kuruCollectiveFee;
63:     }
```


</details>

## [Low-53] Inconsistent use of _msgSender() and msg.sender in contract

### Resolution 
For the sake of consistency, stick to using only one of these values throughout the contract. Not doing so in this case can be quite harmful as _msgSender and msg.sender do have some differences, one being that msgSender cannot be used to determine if an account is a EOA but msg.sender can. Differences like these can introduce vulnerabilities is they are not properly acknowledged by the dev team.

Num of instances: 2

### Findings 


<details><summary>Click to show findings</summary>

['[17](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L17-L165)']
```solidity
17: contract MarginAccount is IMarginAccount, ERC2771Context, Ownable, Initializable, UUPSUpgradeable {
18:     using SafeTransferLib for address;
61:         require(msg.sender == routerContractAddress, MarginAccountErrors.OnlyRouterAllowed()); // <= FOUND


105:         require(verifiedMarket[msg.sender], MarginAccountErrors.OnlyVerifiedMarketsAllowed()); // <= FOUND


119:         require(verifiedMarket[msg.sender], MarginAccountErrors.OnlyVerifiedMarketsAllowed()); // <= FOUND


137:         require(verifiedMarket[msg.sender], MarginAccountErrors.OnlyVerifiedMarketsAllowed()); // <= FOUND


165:         require(verifiedMarket[msg.sender], MarginAccountErrors.OnlyVerifiedMarketsAllowed()); // <= FOUND


180:             _balance = balances[_accountKey(_msgSender(), _tokens[i])]; // <= FOUND


181:             balances[_accountKey(_msgSender(), _tokens[i])] = 0; // <= FOUND


184:                     _msgSender().safeTransferETH(_balance); // <= FOUND


186:                     _tokens[i].safeTransfer(_msgSender(), _balance); // <= FOUND


206:             _token.safeTransferFrom(_msgSender(), address(this), _amount); // <= FOUND


218:         require(_amount <= balances[_accountKey(_msgSender(), _token)], MarginAccountErrors.InsufficientBalance()); // <= FOUND


219:         balances[_accountKey(_msgSender(), _token)] -= _amount; // <= FOUND


221:             _msgSender().safeTransferETH(_amount); // <= FOUND


223:             _token.safeTransfer(_msgSender(), _amount); // <= FOUND


226:         emit Withdrawal(_msgSender(), _token, _amount); // <= FOUND


```
['[20](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L20-L1063)']
```solidity
20: contract OrderBook is Initializable, UUPSUpgradeable, ERC2771Context, AbstractAMM {
21:     OrderBookType orderBookType;
134:         require(msg.sender == owner, OrderBookErrors.Unauthorized()); // <= FOUND


180:         _consumeFunds(quoteAsset, (((_consumedFunds) * quoteDecimalMultiplier) / pricePrecision), _msgSender()); // <= FOUND


226:             quoteAsset, _quoteAmountRoundedUp(_price, _size) * quoteDecimalMultiplier / pricePrecision, _msgSender() // <= FOUND


232:         _addFlipOrder(_price, _flippedPrice, _size, _msgSender(), _orderId, OrderLinkedList.NULL, true, _prevOrderId); // <= FOUND


247:         _consumeFunds(baseAsset, ((_size * baseDecimalMultiplier) / sizePrecision), _msgSender()); // <= FOUND


296:         _consumeFunds(baseAsset, _size * baseDecimalMultiplier / sizePrecision, _msgSender()); // <= FOUND


300:         _addFlipOrder(_price, _flippedPrice, _size, _msgSender(), _orderId, OrderLinkedList.NULL, false, _prevOrderId); // <= FOUND


337:             _msgSender() // <= FOUND


339:         _consumeFunds(baseAsset, _askSize * baseDecimalMultiplier / sizePrecision, _msgSender()); // <= FOUND


347:         _addFlipOrder(_bidPrice, _askPrice, _bidSize, _msgSender(), _bidOrderId, _askOrderId, true, _bidPrevOrderId); // <= FOUND


348:         _addFlipOrder(_askPrice, _bidPrice, _askSize, _msgSender(), _askOrderId, _bidOrderId, false, _askPrevOrderId); // <= FOUND


366:             Order(_msgSender(), _size, _prevOrderId, OrderLinkedList.NULL, OrderLinkedList.NULL, _price, 0, _isBuy); // <= FOUND


370:         emit OrderCreated(_orderId, _msgSender(), _size, _price, _isBuy); // <= FOUND


457:         emit FlipOrdersCanceled(_orderIds, _msgSender()); // <= FOUND


470:         emit OrdersCanceled(_orderIds, _msgSender()); // <= FOUND


489:         emit OrdersCanceled(_orderIdsCanceled, _msgSender()); // <= FOUND


499:         require(_msgSender() == _order.ownerAddress, OrderBookErrors.OnlyOwnerAllowedError()); // <= FOUND


513:         require(_msgSender() == _order.ownerAddress, OrderBookErrors.OnlyOwnerAllowedError()); // <= FOUND


716:             emit OrdersCanceled(orderIdsCanceled, _msgSender()); // <= FOUND


738:         if (_type == OrderBookType.NATIVE_IN_QUOTE && !_isMargin && (msg.sender != address(0))) { // <= FOUND


745:         } else if (msg.sender != address(0)) { // <= FOUND


748:                 ? marginAccount.debitUser(_msgSender(), quoteAsset, _pricePrecisionToQuoteAssetPrecision(_quoteSize)) // <= FOUND


750:                     _msgSender(), address(marginAccount), _pricePrecisionToQuoteAssetPrecision(_quoteSize) // <= FOUND


756:         if (msg.sender == address(0)) { // <= FOUND


767:                     _msgSender(), quoteAsset, _pricePrecisionToQuoteAssetPrecision(_quoteSize), _isMargin // <= FOUND


794:         if (_type == OrderBookType.NATIVE_IN_BASE && !_isMargin && (msg.sender != address(0))) { // <= FOUND


797:         } else if (msg.sender != address(0)) { // <= FOUND


800:                 ? marginAccount.debitUser(_msgSender(), baseAsset, _sizePrecisionToBaseAssetPrecision(_size)) // <= FOUND


802:                     _msgSender(), address(marginAccount), _sizePrecisionToBaseAssetPrecision(_size) // <= FOUND


808:         if (msg.sender == address(0)) { // <= FOUND


817:                 marginAccount.creditUser(_msgSender(), baseAsset, _sizePrecisionToBaseAssetPrecision(_size), _isMargin); // <= FOUND


832:         _msgSender().safeTransferETH(_refund); // <= FOUND


919:                 bytes.concat(makerCredits, abi.encode(_msgSender(), baseAsset, _tokenCredit, true)) // <= FOUND


976:             if (sizeToCreditViaVault > 0 && msg.sender != address(0)) { // <= FOUND


988:             if (msg.sender != address(0)) { // <= FOUND


990:                     bytes.concat(makerCredits, abi.encode(_msgSender(), baseAsset, _tokenCredit, _isMargin)) // <= FOUND


1051:             if (quoteCreditVaultTaker > 0 && msg.sender != address(0)) { // <= FOUND


1063:             if (msg.sender != address(0)) { // <= FOUND


1065:                     bytes.concat(makerCredits, abi.encode(_msgSender(), quoteAsset, tokenCredit, _useMargin)) // <= FOUND


1217:         emit Trade(orderId, makerAddress, isBuy, price, updatedSize, _msgSender(), tx.origin, filledSize); // <= FOUND


```


</details>

## [Low-54] Division in comparison

### Resolution 
To ensure accuracy in comparisons within programming, especially when dealing with integers, it's often more efficient to use multiplication rather than division. This approach stems from the fact that division operations are generally slower and more complex than multiplication. And in the context of solidity they can cause precision errors.

Suppose you want to compare if a/b is greater than c/d (where a, b, c, and d are integers). Instead of performing division, which is prone to precision errors, you can cross-multiply to avoid division. The comparison a/b > c/d is equivalent to a*d > b*c. This way, you only use multiplication, which is faster and avoids potential inaccuracies or complexities associated with division.

Num of instances: 5

### Findings 


<details><summary>Click to show findings</summary>

['[327](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L327-L327)']
```solidity
327:             require(
328:                 ((uint256(_askPrice) * vaultPricePrecision / pricePrecision) > _bestBid)
329:                     || (_bestBid == type(uint256).max),
330:                 OrderBookErrors.ProvisionError()
331:             );
```
['[726](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L726-L726)']
```solidity
726:             if (x <= type(uint256).max / 10 ** 18) return sqrt(x * 10 ** 18);
```
['[741](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L741-L741)']
```solidity
741:             if (x <= type(uint256).max / 10 ** 36) return cbrt(x * 10 ** 36);
```
['[287](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L287-L287)']
```solidity
287:             if ((uint256(_price) * vaultPricePrecision / pricePrecision) <= _bestBid && _bestBid != type(uint256).max) {
```
['[1371](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L1371-L1371)']
```solidity
1371:         if (firstRight != type(uint32).max * vaultPricePrecision / pricePrecision) {
```


</details>

## [Low-55] Contract contains payable functions but no withdraw/sweep function

### Resolution 
In smart contract development, particularly for Ethereum, having payable functions without a corresponding withdraw or sweep function can lead to potential issues. Payable functions allow the contract to receive Ether, but without a mechanism to withdraw these funds, the Ether can become locked within the contract indefinitely. This situation might be intentional in some cases (like a burn function), but generally, it’s a design oversight. A withdraw or sweep function is necessary to transfer Ether out of the contract to a specific address, typically the owner's or a designated recipient. Without this, the contract lacks flexibility in managing its funds, potentially leading to lost or inaccessible Ether.

Num of instances: 4

### Findings 


<details><summary>Click to show findings</summary>

['[16](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruForwarder.sol#L16-L16)']
```solidity
16: contract KuruForwarder is EIP712, Initializable, Ownable, UUPSUpgradeable 
```
['[12](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/periphery/MonadDeployer.sol#L12-L12)']
```solidity
12: contract MonadDeployer is Ownable 
```
['[23](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L23-L23)']
```solidity
23: contract Router is IRouter, Ownable, Initializable, UUPSUpgradeable 
```
['[20](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L20-L20)']
```solidity
20: contract OrderBook is Initializable, UUPSUpgradeable, ERC2771Context, AbstractAMM 
```


</details>

## [Low-56] State variables not capped at reasonable values

### Resolution 
Setting boundaries on state variables in smart contracts is essential for maintaining system integrity and user protection. Without caps on values, variables could reach extremes that exploit or disrupt contract functionality, leading to potential loss or unintended consequences for users. Implementing checks for minimum and maximum permissible values can prevent such issues, ensuring variables remain within a safe and reasonable range. This practice guards against attacks aimed at destabilizing the contract, such as griefing, where attackers intentionally cause distress by exploiting vulnerabilities. Proper validation promotes contract reliability, user trust, and a healthier ecosystem by mitigating risks associated with unbounded state changes.

Num of instances: 2

### Findings 


<details><summary>Click to show findings</summary>

['[105](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/periphery/MonadDeployer.sol#L105-L106)']
```solidity
105:     function setKuruAmmSpread(uint96 _kuruAmmSpread) external onlyOwner {
106:         kuruAmmSpread = _kuruAmmSpread; // <= FOUND
107:     }
```
['[113](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/periphery/MonadDeployer.sol#L113-L114)']
```solidity
113:     function setKuruCollectiveFee(uint256 _kuruCollectiveFee) external onlyOwner {
114:         kuruCollectiveFee = _kuruCollectiveFee; // <= FOUND
115:     }
```


</details>

## [Low-57] Use forceApprove in place of approve

### Resolution 
The forceApprove function is a specialized solution addressing the issues that arise with non-standard ERC-20 tokens, such as USDT, which exhibit non-standard behavior in their approve function. These tokens may necessitate setting the allowance to 0 before changing it, may not return a boolean value from approve calls, or may return false instead of reverting on failure. OpenZeppelin's SafeERC20 library includes a forceApprove method to safely handle these peculiarities, ensuring that smart contracts can interact with such tokens without transaction failures. It rectifies inconsistencies by ensuring that all token interactions, including approvals, adhere to expected standards, even when the underlying tokens do not. 

Num of instances: 1

### Findings 


<details><summary>Click to show findings</summary>

['[89](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/periphery/MonadDeployer.sol#L89-L89)']
```solidity
89:         token.approve(vault, _supplyToVault); // <= FOUND
```


</details>

## [Low-58] Lack of support for rebasing tokens

### Resolution 
Rebasing tokens, such as Aave's Tokens, dynamically adjust their holders' balances over time, meaning that the token balance in a user's account increases periodically. This rebase feature poses a challenge when these tokens are held in contracts since any rewards generated accrue directly to the contract, preventing the original depositor from withdrawing them.\n\nTo solve this issue, a viable approach is to maintain a system of 'shares' corresponding to each deposit. These shares denote the proportion of the total contract balance attributable to each depositor. When a withdrawal is initiated, these shares can be redeemed, ensuring each user receives their fair portion of the current balance at the time of withdrawal. This strategy effectively enables the original depositor to benefit from the accrued rewards, despite the rebasing nature of the tokens.

Num of instances: 4

### Findings 


<details><summary>Click to show findings</summary>

['[118](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L118-L125)']
```solidity
118:     function creditUser(address _user, address _token, uint256 _amount, bool _useMargin) external protocolActive { // <= FOUND
119:         require(verifiedMarket[msg.sender], MarginAccountErrors.OnlyVerifiedMarketsAllowed());
120: 
121:         if (_useMargin) {
122:             balances[_accountKey(_user, _token)] += _amount;
123:         } else {
124:             if (_token != NATIVE) {
125:                 _token.safeTransfer(_user, _amount); // <= FOUND
126:             } else {
127:                 _user.safeTransferETH(_amount);
128:             }
129:         }
130:     }
```
['[198](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L198-L206)']
```solidity
198:     function deposit(address _user, address _token, uint256 _amount) external payable protocolActive { // <= FOUND
199:         require(_user != address(0), MarginAccountErrors.ZeroAddressNotAllowed());
200:         if (_token == NATIVE) {
201:             require(msg.value == _amount, MarginAccountErrors.NativeAssetMismatch());
202:             balances[_accountKey(_user, NATIVE)] += _amount;
203:         } else {
204:             require(msg.value == 0, MarginAccountErrors.NativeAssetMismatch());
205:             balances[_accountKey(_user, _token)] += _amount;
206:             _token.safeTransferFrom(_msgSender(), address(this), _amount); // <= FOUND
207:         }
208: 
209:         emit Deposit(_user, _token, _amount);
210:     }
```
['[217](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L217-L223)']
```solidity
217:     function withdraw(uint256 _amount, address _token) external protocolActive { // <= FOUND
218:         require(_amount <= balances[_accountKey(_msgSender(), _token)], MarginAccountErrors.InsufficientBalance());
219:         balances[_accountKey(_msgSender(), _token)] -= _amount;
220:         if (_token == NATIVE) {
221:             _msgSender().safeTransferETH(_amount);
222:         } else {
223:             _token.safeTransfer(_msgSender(), _amount); // <= FOUND
224:         }
225: 
226:         emit Withdrawal(_msgSender(), _token, _amount);
227:     }
```
['[331](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L331-L344)']
```solidity
331:     function anyToAnySwap( // <= FOUND
332:         address[] calldata _marketAddresses,
333:         bool[] calldata _isBuy,
334:         bool[] calldata _nativeSend,
335:         address _debitToken,
336:         address _creditToken,
337:         uint256 _amount,
338:         uint256 _minAmountOut
339:     ) external payable returns (uint256 _amountOut) {
340:         require(_marketAddresses.length >= 1, RouterErrors.NoMarketsPassed());
341:         require(_isBuy.length == _marketAddresses.length, RouterErrors.LengthMismatch());
342:         require(_nativeSend.length == _marketAddresses.length, RouterErrors.LengthMismatch());
343:         if (_nativeSend[0] == false) {
344:             _debitToken.safeTransferFrom(msg.sender, address(this), _amount); // <= FOUND
345:         }
346:         uint256 _cachedAmountIn = _amount;
347: 
348:         for (uint256 i = 0; i < _marketAddresses.length; i++) {
349:             address _currentMarket = _marketAddresses[i];
350:             MarketParams memory _marketParams = verifiedMarket[_currentMarket];
351:             require(_marketParams.pricePrecision > 0, RouterErrors.InvalidMarket());
352:             IOrderBook market = IOrderBook(_currentMarket);
353:             uint256 _value = _nativeSend[i] ? _amount : 0;
354:             _amountOut = _isBuy[i]
355:                 ? (
356:                     market.placeAndExecuteMarketBuy{value: _value}(
357:                         toU96(_amount * _marketParams.pricePrecision / 10 ** _marketParams.quoteAssetDecimals),
358:                         0,
359:                         false,
360:                         true
361:                     )
362:                 )
363:                 : market.placeAndExecuteMarketSell{value: _value}(
364:                     toU96(_amount * _marketParams.sizePrecision / 10 ** _marketParams.baseAssetDecimals), 0, false, true
365:                 );
366: 
367:             _amount = _amountOut;
368:         }
369:         require(_amountOut >= _minAmountOut, RouterErrors.SlippageExceeded());
370:         emit KuruRouterSwap(msg.sender, _debitToken, _creditToken, _cachedAmountIn, _amountOut);
371:         if (_creditToken != address(0)) {
372:             _creditToken.safeTransfer(msg.sender, _amountOut);
373:         } else {
374:             msg.sender.safeTransferETH(_amountOut);
375:         }
376:     }
```


</details>

## [Low-59] Constructor doesn't set initial owner

### Resolution 
In recent versions of the OpenZeppelin Ownable library, ownership has to be initialized within the constructor by adding Ownable(<owner_address>) to the constructor declaration. This is only a LOW issue as in older versions of OZ lib this will not cause an issue as the Ownable constructor automatically sets the owner to msg.sender.

Num of instances: 1

### Findings 


<details><summary>Click to show findings</summary>

['[33](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L33-L33)']
```solidity
33:     constructor() {
34:         _disableInitializers();
35:     }
```


</details>

## [Low-60] Functions calling contracts/addresses with transfer hooks are missing reentrancy guards

### Resolution 
While adherence to the check-effects-interaction pattern is commendable, the absence of a reentrancy guard in functions, especially where transfer hooks might be present, can expose the protocol users to risks of read-only reentrancies. Such reentrancy vulnerabilities can be exploited to execute malicious actions even without altering the contract state. Without a reentrancy guard, the only potential mitigation would be to blocklist the entire protocol - an extreme and disruptive measure. Therefore, incorporating a reentrancy guard into these functions is vital to bolster security, as it helps protect against both traditional reentrancy attacks and read-only reentrancies, ensuring robust and safe protocol operations.

Num of instances: 14

### Findings 


<details><summary>Click to show findings</summary>

['[294](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L294-L297)']
```solidity
294:     function _transferTokensToUser(uint256 amount, address token, address receiver) internal { // <= FOUND
295:         if (token == address(0)) {
296:             receiver.safeTransferETH(amount);
297:         } else { // <= FOUND
298:             token.safeTransfer(receiver, amount);
299:         }
300:     }
```
['[118](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L118-L124)']
```solidity
118:     function creditUser(address _user, address _token, uint256 _amount, bool _useMargin) external protocolActive { // <= FOUND
119:         require(verifiedMarket[msg.sender], MarginAccountErrors.OnlyVerifiedMarketsAllowed());
120: 
121:         if (_useMargin) {
122:             balances[_accountKey(_user, _token)] += _amount;
123:         } else {
124:             if (_token != NATIVE) { // <= FOUND
125:                 _token.safeTransfer(_user, _amount);
126:             } else {
127:                 _user.safeTransferETH(_amount);
128:             }
129:         }
130:     }
```
['[136](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L136-L148)']
```solidity
136:     function creditUsersEncoded(bytes calldata _encodedData) external protocolActive { // <= FOUND
137:         require(verifiedMarket[msg.sender], MarginAccountErrors.OnlyVerifiedMarketsAllowed());
138: 
139:         uint256 offset = 0;
140:         while (offset < _encodedData.length) {
141:             (address _user, address _token, uint256 _amount, bool _useMargin) =
142:                 abi.decode(_encodedData[offset:offset + 128], (address, address, uint256, bool));
143:             offset += 128;
144: 
145:             if (_useMargin) {
146:                 balances[_accountKey(_user, _token)] += _amount;
147:             } else {
148:                 if (_token != NATIVE) { // <= FOUND
149:                     _token.safeTransfer(_user, _amount);
150:                 } else {
151:                     _user.safeTransferETH(_amount);
152:                 }
153:             }
154:         }
155:     }
```
['[177](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L177-L185)']
```solidity
177:     function batchWithdrawMaxTokens(address[] calldata _tokens) external protocolActive { // <= FOUND
178:         uint256 _balance;
179:         for (uint256 i = 0; i < _tokens.length; i++) {
180:             _balance = balances[_accountKey(_msgSender(), _tokens[i])];
181:             balances[_accountKey(_msgSender(), _tokens[i])] = 0;
182:             if (_balance > 0) {
183:                 if (_tokens[i] == NATIVE) {
184:                     _msgSender().safeTransferETH(_balance);
185:                 } else { // <= FOUND
186:                     _tokens[i].safeTransfer(_msgSender(), _balance);
187:                 }
188:             }
189:         }
190:     }
```
['[217](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L217-L222)']
```solidity
217:     function withdraw(uint256 _amount, address _token) external protocolActive { // <= FOUND
218:         require(_amount <= balances[_accountKey(_msgSender(), _token)], MarginAccountErrors.InsufficientBalance());
219:         balances[_accountKey(_msgSender(), _token)] -= _amount;
220:         if (_token == NATIVE) {
221:             _msgSender().safeTransferETH(_amount);
222:         } else { // <= FOUND
223:             _token.safeTransfer(_msgSender(), _amount);
224:         }
225: 
226:         emit Withdrawal(_msgSender(), _token, _amount);
227:     }
```
['[65](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/periphery/MonadDeployer.sol#L65-L91)']
```solidity
65:     function deployTokenAndMarket( // <= FOUND
66:         TokenParams memory tokenParams,
67:         MarketParams memory marketParams,
68:         bytes calldata metadata
69:     ) external payable returns (address market) {
70:         KuruERC20 token = new KuruERC20(tokenParams.name, tokenParams.symbol, tokenParams.initialSupply, address(this));
71:         market = router.deployProxy(
72:             IOrderBook.OrderBookType.NATIVE_IN_QUOTE,
73:             address(token),
74:             address(0),
75:             marketParams.sizePrecision,
76:             marketParams.pricePrecision,
77:             marketParams.tickSize,
78:             marketParams.minSize,
79:             marketParams.maxSize,
80:             marketParams.takerFeeBps,
81:             marketParams.makerFeeBps,
82:             kuruAmmSpread
83:         );
84:         if (msg.value != (marketParams.nativeTokenAmount + kuruCollectiveFee)) {
85:             revert InsufficientAssets(marketParams.nativeTokenAmount + kuruCollectiveFee, msg.value);
86:         }
87:         (address vault,,,,,,,) = IOrderBook(market).getVaultParams();
88:         uint256 _supplyToVault = tokenParams.initialSupply * (10 ** 4 - tokenParams.supplyToDev) / 10 ** 4;
89:         token.approve(vault, _supplyToVault);
90:         IKuruAMMVault(vault).deposit{value: marketParams.nativeTokenAmount}(
91:             _supplyToVault, marketParams.nativeTokenAmount, address(this) // <= FOUND
92:         );
93:         token.transfer(tokenParams.dev, tokenParams.initialSupply - _supplyToVault);
94:         marginAccount.deposit{value: kuruCollectiveFee}(kuruCollective, address(0), kuruCollectiveFee);
95:         emit PumpingTime(
96:             address(token),
97:             tokenParams.tokenURI,
98:             tokenParams.dev,
99:             tokenParams.initialSupply - _supplyToVault,
100:             market,
101:             metadata
102:         );
103:     }
```
['[331](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L331-L371)']
```solidity
331:     function anyToAnySwap( // <= FOUND
332:         address[] calldata _marketAddresses,
333:         bool[] calldata _isBuy,
334:         bool[] calldata _nativeSend,
335:         address _debitToken,
336:         address _creditToken,
337:         uint256 _amount,
338:         uint256 _minAmountOut
339:     ) external payable returns (uint256 _amountOut) {
340:         require(_marketAddresses.length >= 1, RouterErrors.NoMarketsPassed());
341:         require(_isBuy.length == _marketAddresses.length, RouterErrors.LengthMismatch());
342:         require(_nativeSend.length == _marketAddresses.length, RouterErrors.LengthMismatch());
343:         if (_nativeSend[0] == false) {
344:             _debitToken.safeTransferFrom(msg.sender, address(this), _amount);
345:         }
346:         uint256 _cachedAmountIn = _amount;
347: 
348:         for (uint256 i = 0; i < _marketAddresses.length; i++) {
349:             address _currentMarket = _marketAddresses[i];
350:             MarketParams memory _marketParams = verifiedMarket[_currentMarket];
351:             require(_marketParams.pricePrecision > 0, RouterErrors.InvalidMarket());
352:             IOrderBook market = IOrderBook(_currentMarket);
353:             uint256 _value = _nativeSend[i] ? _amount : 0;
354:             _amountOut = _isBuy[i]
355:                 ? (
356:                     market.placeAndExecuteMarketBuy{value: _value}(
357:                         toU96(_amount * _marketParams.pricePrecision / 10 ** _marketParams.quoteAssetDecimals),
358:                         0,
359:                         false,
360:                         true
361:                     )
362:                 )
363:                 : market.placeAndExecuteMarketSell{value: _value}(
364:                     toU96(_amount * _marketParams.sizePrecision / 10 ** _marketParams.baseAssetDecimals), 0, false, true
365:                 );
366: 
367:             _amount = _amountOut;
368:         }
369:         require(_amountOut >= _minAmountOut, RouterErrors.SlippageExceeded());
370:         emit KuruRouterSwap(msg.sender, _debitToken, _creditToken, _cachedAmountIn, _amountOut);
371:         if (_creditToken != address(0)) { // <= FOUND
372:             _creditToken.safeTransfer(msg.sender, _amountOut);
373:         } else {
374:             msg.sender.safeTransferETH(_amountOut);
375:         }
376:     }
```
['[65](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/periphery/MonadDeployer.sol#L65-L93)']
```solidity
65:     function deployTokenAndMarket(
66:         TokenParams memory tokenParams,
67:         MarketParams memory marketParams,
68:         bytes calldata metadata
69:     ) external payable returns (address market) {
70:         KuruERC20 token = new KuruERC20(tokenParams.name, tokenParams.symbol, tokenParams.initialSupply, address(this));
71:         market = router.deployProxy(
72:             IOrderBook.OrderBookType.NATIVE_IN_QUOTE,
73:             address(token),
74:             address(0),
75:             marketParams.sizePrecision,
76:             marketParams.pricePrecision,
77:             marketParams.tickSize,
78:             marketParams.minSize,
79:             marketParams.maxSize,
80:             marketParams.takerFeeBps,
81:             marketParams.makerFeeBps,
82:             kuruAmmSpread
83:         );
84:         if (msg.value != (marketParams.nativeTokenAmount + kuruCollectiveFee)) {
85:             revert InsufficientAssets(marketParams.nativeTokenAmount + kuruCollectiveFee, msg.value);
86:         }
87:         (address vault,,,,,,,) = IOrderBook(market).getVaultParams();
88:         uint256 _supplyToVault = tokenParams.initialSupply * (10 ** 4 - tokenParams.supplyToDev) / 10 ** 4;
89:         token.approve(vault, _supplyToVault);
90:         IKuruAMMVault(vault).deposit{value: marketParams.nativeTokenAmount}(
91:             _supplyToVault, marketParams.nativeTokenAmount, address(this)
92:         );
93:         token.transfer(tokenParams.dev, tokenParams.initialSupply - _supplyToVault); // <= FOUND
94:         marginAccount.deposit{value: kuruCollectiveFee}(kuruCollective, address(0), kuruCollectiveFee);
95:         emit PumpingTime(
96:             address(token),
97:             tokenParams.tokenURI,
98:             tokenParams.dev,
99:             tokenParams.initialSupply - _supplyToVault,
100:             market,
101:             metadata
102:         );
103:     }
```
['[294](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L294-L298)']
```solidity
294:     function _transferTokensToUser(uint256 amount, address token, address receiver) internal {
295:         if (token == address(0)) {
296:             receiver.safeTransferETH(amount);
297:         } else {
298:             token.safeTransfer(receiver, amount); // <= FOUND
299:         }
300:     }
```
['[118](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L118-L125)']
```solidity
118:     function creditUser(address _user, address _token, uint256 _amount, bool _useMargin) external protocolActive {
119:         require(verifiedMarket[msg.sender], MarginAccountErrors.OnlyVerifiedMarketsAllowed());
120: 
121:         if (_useMargin) {
122:             balances[_accountKey(_user, _token)] += _amount;
123:         } else {
124:             if (_token != NATIVE) {
125:                 _token.safeTransfer(_user, _amount); // <= FOUND
126:             } else {
127:                 _user.safeTransferETH(_amount);
128:             }
129:         }
130:     }
```
['[136](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L136-L149)']
```solidity
136:     function creditUsersEncoded(bytes calldata _encodedData) external protocolActive {
137:         require(verifiedMarket[msg.sender], MarginAccountErrors.OnlyVerifiedMarketsAllowed());
138: 
139:         uint256 offset = 0;
140:         while (offset < _encodedData.length) {
141:             (address _user, address _token, uint256 _amount, bool _useMargin) =
142:                 abi.decode(_encodedData[offset:offset + 128], (address, address, uint256, bool));
143:             offset += 128;
144: 
145:             if (_useMargin) {
146:                 balances[_accountKey(_user, _token)] += _amount;
147:             } else {
148:                 if (_token != NATIVE) {
149:                     _token.safeTransfer(_user, _amount); // <= FOUND
150:                 } else {
151:                     _user.safeTransferETH(_amount);
152:                 }
153:             }
154:         }
155:     }
```
['[177](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L177-L186)']
```solidity
177:     function batchWithdrawMaxTokens(address[] calldata _tokens) external protocolActive {
178:         uint256 _balance;
179:         for (uint256 i = 0; i < _tokens.length; i++) {
180:             _balance = balances[_accountKey(_msgSender(), _tokens[i])];
181:             balances[_accountKey(_msgSender(), _tokens[i])] = 0;
182:             if (_balance > 0) {
183:                 if (_tokens[i] == NATIVE) {
184:                     _msgSender().safeTransferETH(_balance);
185:                 } else {
186:                     _tokens[i].safeTransfer(_msgSender(), _balance); // <= FOUND
187:                 }
188:             }
189:         }
190:     }
```
['[217](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L217-L223)']
```solidity
217:     function withdraw(uint256 _amount, address _token) external protocolActive {
218:         require(_amount <= balances[_accountKey(_msgSender(), _token)], MarginAccountErrors.InsufficientBalance());
219:         balances[_accountKey(_msgSender(), _token)] -= _amount;
220:         if (_token == NATIVE) {
221:             _msgSender().safeTransferETH(_amount);
222:         } else {
223:             _token.safeTransfer(_msgSender(), _amount); // <= FOUND
224:         }
225: 
226:         emit Withdrawal(_msgSender(), _token, _amount);
227:     }
```
['[331](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L331-L372)']
```solidity
331:     function anyToAnySwap(
332:         address[] calldata _marketAddresses,
333:         bool[] calldata _isBuy,
334:         bool[] calldata _nativeSend,
335:         address _debitToken,
336:         address _creditToken,
337:         uint256 _amount,
338:         uint256 _minAmountOut
339:     ) external payable returns (uint256 _amountOut) {
340:         require(_marketAddresses.length >= 1, RouterErrors.NoMarketsPassed());
341:         require(_isBuy.length == _marketAddresses.length, RouterErrors.LengthMismatch());
342:         require(_nativeSend.length == _marketAddresses.length, RouterErrors.LengthMismatch());
343:         if (_nativeSend[0] == false) {
344:             _debitToken.safeTransferFrom(msg.sender, address(this), _amount);
345:         }
346:         uint256 _cachedAmountIn = _amount;
347: 
348:         for (uint256 i = 0; i < _marketAddresses.length; i++) {
349:             address _currentMarket = _marketAddresses[i];
350:             MarketParams memory _marketParams = verifiedMarket[_currentMarket];
351:             require(_marketParams.pricePrecision > 0, RouterErrors.InvalidMarket());
352:             IOrderBook market = IOrderBook(_currentMarket);
353:             uint256 _value = _nativeSend[i] ? _amount : 0;
354:             _amountOut = _isBuy[i]
355:                 ? (
356:                     market.placeAndExecuteMarketBuy{value: _value}(
357:                         toU96(_amount * _marketParams.pricePrecision / 10 ** _marketParams.quoteAssetDecimals),
358:                         0,
359:                         false,
360:                         true
361:                     )
362:                 )
363:                 : market.placeAndExecuteMarketSell{value: _value}(
364:                     toU96(_amount * _marketParams.sizePrecision / 10 ** _marketParams.baseAssetDecimals), 0, false, true
365:                 );
366: 
367:             _amount = _amountOut;
368:         }
369:         require(_amountOut >= _minAmountOut, RouterErrors.SlippageExceeded());
370:         emit KuruRouterSwap(msg.sender, _debitToken, _creditToken, _cachedAmountIn, _amountOut);
371:         if (_creditToken != address(0)) {
372:             _creditToken.safeTransfer(msg.sender, _amountOut); // <= FOUND
373:         } else {
374:             msg.sender.safeTransferETH(_amountOut);
375:         }
376:     }
```


</details>

## [Low-61] Solidity version 0.8.20 won't work on all chains due to PUSH0

### Resolution 
Solidity version 0.8.20 uses the new Shanghai EVM which introduces the PUSH0 opcode, this may not be implemented on all chains and L2 thus reducing the portability and compatability of the code. Consider using a earlier solidity version.

Num of instances: 3

### Findings 


<details><summary>Click to show findings</summary>

['[2](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L2-L2)']
```solidity
2: pragma solidity ^0.8.20; // <= FOUND
```
['[3](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/TreeMath.sol#L3-L3)']
```solidity
3: pragma solidity ^0.8.10; // <= FOUND
```
['[2](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L2-L2)']
```solidity
2: pragma solidity ^0.8.4; // <= FOUND
```


</details>

## [Low-62] Bps variable not checked that they are below 1e4

### Resolution 
When handling basis points (bps) in smart contracts, it's essential to validate that their values do not exceed 10,000, as 1 bps equals 0.01%, and 10,000 bps equate to 100%. Failing to check that bps values stay within this range can lead to calculations that mistakenly exceed intended limits, causing issues such as excessive fees or incorrect interest rates. Implementing a simple validation check to ensure bps do not surpass 10,000 will safeguard against such errors, maintaining the integrity of financial computations and preventing potential overcharges or contract misbehaviors.

Num of instances: 7

### Findings 


<details><summary>Click to show findings</summary>

['[85](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L85-L125)']
```solidity
85:     function initialize( // <= FOUND
86:         address _owner,
87:         OrderBookType _type,
88:         address _baseAssetAddress,
89:         uint256 _baseAssetDecimals,
90:         address _quoteAssetAddress,
91:         uint256 _quoteAssetDecimals,
92:         address _marginAccountAddress,
93:         uint96 _sizePrecision,
94:         uint32 _pricePrecision,
95:         uint32 _tickSize,
96:         uint96 _minSize,
97:         uint96 _maxSize,
98:         uint256 _takerFeeBps, // <= FOUND
99:         uint256 _makerFeeBps,
100:         address _kuruAmmVault,
101:         uint96 _kuruAmmSpread,
102:         address __trustedForwarder
103:     ) public initializer {
104:         owner = _owner;
105: 
106:         require(_makerFeeBps <= _takerFeeBps && _takerFeeBps < BPS_MULTIPLIER, OrderBookErrors.MarketFeeError()); // <= FOUND
107:         require(_kuruAmmSpread % 10 == 0 && _kuruAmmSpread > 0 && _kuruAmmSpread < 500, OrderBookErrors.InvalidSpread());
108:         require(_minSize > 0 && _maxSize > _minSize, OrderBookErrors.MarketSizeError());
109:         orderBookType = _type;
110:         baseAsset = _baseAssetAddress;
111:         quoteAsset = _quoteAssetAddress;
112: 
113:         baseAssetDecimals = _baseAssetDecimals;
114:         baseDecimalMultiplier = 10 ** _baseAssetDecimals;
115:         quoteAssetDecimals = _quoteAssetDecimals;
116:         quoteDecimalMultiplier = 10 ** _quoteAssetDecimals;
117: 
118:         marginAccount = IMarginAccount(payable(_marginAccountAddress));
119:         
120:         sizePrecision = _sizePrecision;
121:         pricePrecision = _pricePrecision;
122:         tickSize = _tickSize;
123:         minSize = _minSize;
124:         maxSize = _maxSize;
125:         takerFeeBps = _takerFeeBps; // <= FOUND
126:         makerFeeBps = _makerFeeBps;
127:         kuruAmmVault = _kuruAmmVault;
128:         SPREAD_CONSTANT = _kuruAmmSpread;
129:         vaultBestAsk = type(uint256).max;
130:         _trustedForwarder = __trustedForwarder;
131:     }
```
['[855](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L855-L916)']
```solidity
855:     function _matchAggressiveBuyWithCap(uint256 _limitPrice, uint96 _sizeToBeFilled) // <= FOUND
856:         internal
857:         returns (uint96, uint96)
858:     {
859:         uint96 sizeToCreditTaker;
860:         uint96 sizeToCreditViaVault;
861:         uint96 fundsConsumed;
862:         bytes memory makerCredits;
863:         (bool _isVaultFill, uint256 _bestAsk) = bestAsk();
864:         uint32 _pricePrecision = pricePrecision;
865:         _limitPrice = _limitPrice * vaultPricePrecision / _pricePrecision;
866: 
867:         while (_sizeToBeFilled > 0 && _bestAsk <= _limitPrice && _bestAsk != 0) {
868:             uint96 sizeToBeFilledBefore = _sizeToBeFilled; 
869:             bytes memory priceUpdate;
870: 
871:             if (_isVaultFill) {
872:                 uint96 _vaultFundsConsumed;
873:                 (_sizeToBeFilled, _vaultFundsConsumed, priceUpdate) =
874:                     _fillVaultForBuy(_getOBAsk() > _limitPrice ? _limitPrice + 1 : _getOBAsk(), _sizeToBeFilled);
875:                 fundsConsumed += _vaultFundsConsumed;
876:             } else {
877:                 (_sizeToBeFilled, priceUpdate) = _fillSizeForPrice(
878:                     s_sellTree,
879:                     toU32(_bestAsk * _pricePrecision / vaultPricePrecision),
880:                     s_sellPricePoints[_bestAsk * _pricePrecision / vaultPricePrecision],
881:                     _sizeToBeFilled
882:                 );
883:             }
884: 
885:             uint96 sizeFilled = sizeToBeFilledBefore - _sizeToBeFilled;
886:             sizeToCreditTaker += sizeFilled;
887:             if (_isVaultFill) {
888:                 sizeToCreditViaVault += sizeFilled;
889:             } else {
890:                 fundsConsumed += _quoteAmountRoundedUp(
891:                     toU32(FixedPointMathLib.mulDivUp(_bestAsk, _pricePrecision, vaultPricePrecision)), sizeFilled
892:                 );
893:             }
894:             makerCredits = bytes.concat(makerCredits, priceUpdate);
895: 
896:             (_isVaultFill, _bestAsk) = bestAsk();
897:         }
898: 
899:         if (sizeToCreditTaker == 0) {
900:             return (_sizeToBeFilled, 0);
901:         }
902:         {
903:             uint96 _sizePrecision = sizePrecision;
904:             uint256 _baseDecimalMultiplier = baseDecimalMultiplier;
905:             uint256 _tokenCredit = (sizeToCreditTaker * _baseDecimalMultiplier) / _sizePrecision;
906:             if (sizeToCreditViaVault > 0) {
907:                 marginAccount.debitUser(
908:                     kuruAmmVault, baseAsset, (sizeToCreditViaVault * _baseDecimalMultiplier) / _sizePrecision
909:                 );
910:             }
911:             uint256 _takerFeeBps = takerFeeBps; // <= FOUND
912:             if (_takerFeeBps > 0) { // <= FOUND
913:                 uint256 _feeDebit = FixedPointMathLib.mulDivUp(_tokenCredit, _takerFeeBps, BPS_MULTIPLIER); // <= FOUND
914:                 _tokenCredit -= _feeDebit;
915:                 
916:                 baseFeeCollected += ((_feeDebit * (_takerFeeBps - makerFeeBps)) / _takerFeeBps); // <= FOUND
917:             }
918:             marginAccount.creditUsersEncoded(
919:                 bytes.concat(makerCredits, abi.encode(_msgSender(), baseAsset, _tokenCredit, true))
920:             );
921:         }
922: 
923:         return (_sizeToBeFilled, fundsConsumed);
924:     }
```
['[930](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L930-L986)']
```solidity
930:     function _marketBuyMatch(uint96 _quoteSize, bool _isMargin) internal returns (uint96, uint256) { // <= FOUND
931:         uint96 sizeToCreditTaker;
932:         uint96 sizeToCreditViaVault;
933:         bytes memory makerCredits;
934:         uint32 _pricePrecision = pricePrecision;
935:         uint96 _sizePrecision = sizePrecision;
936: 
937:         (bool _isVaultFill, uint256 _bestAsk) = bestAsk();
938: 
939:         while (_quoteSize > 0 && _bestAsk != 0) {
940:             bytes memory priceUpdate;
941:             if (_isVaultFill) {
942:                 uint96 _sizeFilled;
943:                 (_quoteSize, _sizeFilled, priceUpdate) = _fillVaultBuyMatch(_getOBAsk(), _quoteSize);
944:                 sizeToCreditViaVault += _sizeFilled;
945:                 sizeToCreditTaker += _sizeFilled;
946:             } else {
947:                 
948:                 uint96 _sizeFillableAtPriceLeft =
949:                     toU96(_quoteSize * _sizePrecision * vaultPricePrecision / (_bestAsk * _pricePrecision));
950:                 uint96 _sizeFillableAtPriceBefore = _sizeFillableAtPriceLeft; 
951:                 (_sizeFillableAtPriceLeft, priceUpdate) = _fillSizeForPrice(
952:                     s_sellTree,
953:                     toU32(_bestAsk * _pricePrecision / vaultPricePrecision),
954:                     s_sellPricePoints[(_bestAsk * _pricePrecision / vaultPricePrecision)],
955:                     _sizeFillableAtPriceLeft
956:                 );
957:                 sizeToCreditTaker += (_sizeFillableAtPriceBefore - _sizeFillableAtPriceLeft);
958:                 _quoteSize = toU96(
959:                     FixedPointMathLib.mulDiv(
960:                         _bestAsk * _pricePrecision, _sizeFillableAtPriceLeft, _sizePrecision * vaultPricePrecision
961:                     )
962:                 );
963:             }
964:             makerCredits = bytes.concat(makerCredits, priceUpdate);
965: 
966:             (_isVaultFill, _bestAsk) = bestAsk();
967:         }
968: 
969:         if (sizeToCreditTaker == 0) {
970:             return (_quoteSize, 0);
971:         }
972: 
973:         {
974:             uint256 _baseDecimalMultiplier = baseDecimalMultiplier;
975:             uint256 _tokenCredit = (sizeToCreditTaker * _baseDecimalMultiplier) / _sizePrecision;
976:             if (sizeToCreditViaVault > 0 && msg.sender != address(0)) {
977:                 marginAccount.debitUser(
978:                     kuruAmmVault, baseAsset, (sizeToCreditViaVault * _baseDecimalMultiplier) / _sizePrecision
979:                 );
980:             }
981:             uint256 _takerFeeBps = takerFeeBps; // <= FOUND
982:             if (_takerFeeBps > 0) { // <= FOUND
983:                 uint256 _feeDebit = FixedPointMathLib.mulDivUp(_tokenCredit, _takerFeeBps, BPS_MULTIPLIER); // <= FOUND
984:                 _tokenCredit -= _feeDebit;
985:                 
986:                 baseFeeCollected += ((_feeDebit * (_takerFeeBps - makerFeeBps)) / _takerFeeBps); // <= FOUND
987:             }
988:             if (msg.sender != address(0)) {
989:                 marginAccount.creditUsersEncoded(
990:                     bytes.concat(makerCredits, abi.encode(_msgSender(), baseAsset, _tokenCredit, _isMargin))
991:                 );
992:             }
993:             return (_quoteSize, _tokenCredit);
994:         }
995:     }
```
['[1003](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L1003-L1061)']
```solidity
1003:     function _matchAggressiveSell(uint256 _limitPrice, uint96 _sizeToBeFilledLeft, bool _useMargin) // <= FOUND
1004:         internal
1005:         returns (uint96, uint256)
1006:     {
1007:         uint96 quoteCreditTaker;
1008:         uint256 quoteCreditVaultTaker;
1009:         uint256 tokenCredit;
1010:         (bool _isVaultFill, uint256 _bestBid) = bestBid();
1011:         bytes memory makerCredits;
1012:         uint32 _pricePrecision = pricePrecision;
1013:         _limitPrice = _limitPrice * vaultPricePrecision / _pricePrecision;
1014:         while (_sizeToBeFilledLeft > 0 && _bestBid >= _limitPrice && _bestBid != type(uint256).max) {
1015:             uint96 _sizeToBeFilledBefore = _sizeToBeFilledLeft; 
1016: 
1017:             bytes memory priceUpdate;
1018: 
1019:             if (_isVaultFill) {
1020:                 uint256 _quoteToTaker;
1021:                 (_sizeToBeFilledLeft, _quoteToTaker, priceUpdate) =
1022:                     _fillVaultForSell(_getOBBid() >= _limitPrice ? _getOBBid() : _limitPrice - 1, _sizeToBeFilledLeft);
1023:                 quoteCreditVaultTaker += _quoteToTaker;
1024:             } else {
1025:                 (_sizeToBeFilledLeft, priceUpdate) = _fillSizeForPrice(
1026:                     s_buyTree,
1027:                     toU32(_bestBid * _pricePrecision / vaultPricePrecision),
1028:                     s_buyPricePoints[_bestBid * _pricePrecision / vaultPricePrecision],
1029:                     _sizeToBeFilledLeft
1030:                 );
1031:                 quoteCreditTaker += toU96(
1032:                     FixedPointMathLib.mulDiv(
1033:                         _sizeToBeFilledBefore - _sizeToBeFilledLeft,
1034:                         toU32(_bestBid * _pricePrecision / vaultPricePrecision),
1035:                         sizePrecision
1036:                     )
1037:                 );
1038:             }
1039:             makerCredits = bytes.concat(makerCredits, priceUpdate);
1040: 
1041:             (_isVaultFill, _bestBid) = bestBid();
1042:         }
1043: 
1044:         if (quoteCreditTaker == 0 && quoteCreditVaultTaker == 0) {
1045:             return (_sizeToBeFilledLeft, 0);
1046:         }
1047:         {
1048:             uint256 _quoteDecimalMultiplier = quoteDecimalMultiplier;
1049:             tokenCredit = ((quoteCreditTaker) * _quoteDecimalMultiplier) / _pricePrecision
1050:                 + (quoteCreditVaultTaker * _quoteDecimalMultiplier) / vaultPricePrecision;
1051:             if (quoteCreditVaultTaker > 0 && msg.sender != address(0)) {
1052:                 marginAccount.debitUser(
1053:                     kuruAmmVault, quoteAsset, (quoteCreditVaultTaker * _quoteDecimalMultiplier) / vaultPricePrecision
1054:                 );
1055:             }
1056:             uint256 _takerFeeBps = takerFeeBps; // <= FOUND
1057:             if (_takerFeeBps > 0) { // <= FOUND
1058:                 uint256 _feeDebit = FixedPointMathLib.mulDivUp(tokenCredit, _takerFeeBps, BPS_MULTIPLIER); // <= FOUND
1059:                 tokenCredit -= _feeDebit;
1060:                 
1061:                 quoteFeeCollected += ((_feeDebit * (_takerFeeBps - makerFeeBps)) / _takerFeeBps); // <= FOUND
1062:             }
1063:             if (msg.sender != address(0)) {
1064:                 marginAccount.creditUsersEncoded(
1065:                     bytes.concat(makerCredits, abi.encode(_msgSender(), quoteAsset, tokenCredit, _useMargin))
1066:                 );
1067:             }
1068:         }
1069: 
1070:         return (_sizeToBeFilledLeft, tokenCredit);
1071:     }
```
['[74](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L74-L184)']
```solidity
74:     function deployProxy( // <= FOUND
75:         IOrderBook.OrderBookType _type,
76:         address _baseAssetAddress,
77:         address _quoteAssetAddress,
78:         uint96 _sizePrecision,
79:         uint32 _pricePrecision,
80:         uint32 _tickSize,
81:         uint96 _minSize,
82:         uint96 _maxSize,
83:         uint256 _takerFeeBps, // <= FOUND
84:         uint256 _makerFeeBps,
85:         uint96 _kuruAmmSpread
86:     ) public returns (address proxy) {
87:         if (_type == IOrderBook.OrderBookType.NATIVE_IN_BASE) {
88:             require(_baseAssetAddress == address(0), RouterErrors.MarketTypeMismatch());
89:             require(_quoteAssetAddress != address(0), RouterErrors.MarketTypeMismatch());
90:         } else if (_type == IOrderBook.OrderBookType.NATIVE_IN_QUOTE) {
91:             require(_baseAssetAddress != address(0), RouterErrors.MarketTypeMismatch());
92:             require(_quoteAssetAddress == address(0), RouterErrors.MarketTypeMismatch());
93:         } else {
94:             require(_baseAssetAddress != address(0), RouterErrors.MarketTypeMismatch());
95:             require(_quoteAssetAddress != address(0), RouterErrors.MarketTypeMismatch());
96:             require(_baseAssetAddress != _quoteAssetAddress, RouterErrors.BaseAndQuoteAssetSame());
97:         }
98:         require(_tickSize > 0, RouterErrors.InvalidTickSize());
99:         require(10 ** Math.log10(_sizePrecision) == _sizePrecision, RouterErrors.InvalidSizePrecision());
100:         require(10 ** Math.log10(_pricePrecision) == _pricePrecision, RouterErrors.InvalidPricePrecision());
101:         uint256 _baseAssetDecimals =
102:             _type == IOrderBook.OrderBookType.NATIVE_IN_BASE ? 18 : IERC20Metadata(_baseAssetAddress).decimals();
103:         uint256 _quoteAssetDecimals =
104:             _type == IOrderBook.OrderBookType.NATIVE_IN_QUOTE ? 18 : IERC20Metadata(_quoteAssetAddress).decimals();
105:         {
106:             bytes32 _salt = _getSalt(
107:                 _baseAssetAddress,
108:                 _quoteAssetAddress,
109:                 _sizePrecision,
110:                 _pricePrecision,
111:                 _tickSize,
112:                 _minSize,
113:                 _maxSize,
114:                 _takerFeeBps, // <= FOUND
115:                 _makerFeeBps,
116:                 _kuruAmmSpread
117:             );
118:             proxy = Create2.deploy(
119:                 0,
120:                 _salt,
121:                 abi.encodePacked(type(ERC1967Proxy).creationCode, abi.encode(orderBookImplementation, bytes("")))
122:             );
123:         }
124:         IKuruAMMVault _kuruAmmVault = IKuruAMMVault(
125:             Create2.deploy(
126:                 0,
127:                 keccak256(abi.encode(proxy)),
128:                 abi.encodePacked(type(ERC1967Proxy).creationCode, abi.encode(kuruAmmVaultImplementation, bytes("")))
129:             )
130:         );
131: 
132:         verifiedMarket[proxy] = MarketParams(
133:             _pricePrecision,
134:             _sizePrecision,
135:             _baseAssetAddress,
136:             _baseAssetDecimals,
137:             _quoteAssetAddress,
138:             _quoteAssetDecimals,
139:             _tickSize,
140:             _minSize,
141:             _maxSize,
142:             _takerFeeBps, // <= FOUND
143:             _makerFeeBps
144:         );
145:         IMarginAccount(marginAccountAddress).updateMarkets(proxy);
146:         {
147:             IOrderBook(proxy).initialize(
148:                 address(this),
149:                 _type,
150:                 _baseAssetAddress,
151:                 _baseAssetDecimals,
152:                 _quoteAssetAddress,
153:                 _quoteAssetDecimals,
154:                 marginAccountAddress,
155:                 _sizePrecision,
156:                 _pricePrecision,
157:                 _tickSize,
158:                 _minSize,
159:                 _maxSize,
160:                 _takerFeeBps, // <= FOUND
161:                 _makerFeeBps,
162:                 address(_kuruAmmVault),
163:                 _kuruAmmSpread,
164:                 TRUSTED_FORWARDER
165:             );
166:         }
167: 
168:         _kuruAmmVault.initialize(
169:             address(this), _baseAssetAddress, _quoteAssetAddress, marginAccountAddress, proxy, _kuruAmmSpread
170:         );
171: 
172:         _setApprovalsForMarket(_baseAssetAddress, _quoteAssetAddress, proxy, _type);
173: 
174:         emit MarketRegistered(
175:             _baseAssetAddress,
176:             _quoteAssetAddress,
177:             proxy,
178:             address(_kuruAmmVault),
179:             _pricePrecision,
180:             _sizePrecision,
181:             _tickSize,
182:             _minSize,
183:             _maxSize,
184:             _takerFeeBps, // <= FOUND
185:             _makerFeeBps,
186:             _kuruAmmSpread
187:         );
188: 
189:         return proxy;
190:     }
```
['[192](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L192-L214)']
```solidity
192:     function computeAddress( // <= FOUND
193:         address _baseAssetAddress,
194:         address _quoteAssetAddress,
195:         uint96 _sizePrecision,
196:         uint32 _pricePrecision,
197:         uint32 _tickSize,
198:         uint96 _minSize,
199:         uint96 _maxSize,
200:         uint256 _takerFeeBps, // <= FOUND
201:         uint256 _makerFeeBps,
202:         uint96 _kuruAmmSpread,
203:         address oldImplementation,
204:         bool old
205:     ) public view returns (address proxy) {
206:         bytes32 _salt = _getSalt(
207:             _baseAssetAddress,
208:             _quoteAssetAddress,
209:             _sizePrecision,
210:             _pricePrecision,
211:             _tickSize,
212:             _minSize,
213:             _maxSize,
214:             _takerFeeBps, // <= FOUND
215:             _makerFeeBps,
216:             _kuruAmmSpread
217:         );
218:         proxy = Create2.computeAddress(
219:             _salt,
220:             keccak256(
221:                 abi.encodePacked(
222:                     type(ERC1967Proxy).creationCode,
223:                     abi.encode(old ? oldImplementation : orderBookImplementation, bytes(""))
224:                 )
225:             )
226:         );
227:     }
```
['[392](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L392-L413)']
```solidity
392:     function _getSalt( // <= FOUND
393:         address _baseAssetAddress,
394:         address _quoteAssetAddress,
395:         uint96 _sizePrecision,
396:         uint32 _pricePrecision,
397:         uint32 _tickSize,
398:         uint96 _minSize,
399:         uint96 _maxSize,
400:         uint256 _takerFeeBps, // <= FOUND
401:         uint256 _makerFeeBps,
402:         uint96 _kuruAmmSpread
403:     ) internal pure returns (bytes32) {
404:         return keccak256(
405:             abi.encodePacked(
406:                 _baseAssetAddress,
407:                 _quoteAssetAddress,
408:                 _sizePrecision,
409:                 _pricePrecision,
410:                 _tickSize,
411:                 _minSize,
412:                 _maxSize,
413:                 _takerFeeBps, // <= FOUND
414:                 _makerFeeBps,
415:                 _kuruAmmSpread
416:             )
417:         );
418:     }
```


</details>

## [Low-63] Missing events in functions that are either setters, privileged or voting related

### Resolution 
Sensitive setter functions in smart contracts often alter critical state variables. Without events emitted in these functions, external observers or dApps cannot easily track or react to these state changes. Missing events can obscure contract activity, hampering transparency and making integration more challenging. To resolve this, incorporate appropriate event emissions within these functions. Events offer an efficient way to log crucial changes, aiding in real-time tracking and post-transaction verification.

Num of instances: 22

### Findings 


<details><summary>Click to show findings</summary>

['[108](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L108-L108)']
```solidity
108:     function setMarketParams() public 
```
['[105](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruForwarder.sol#L105-L105)']
```solidity
105:     function setAllowedInterfaces(bytes4[] memory _allowedInterfaces) external onlyOwner 
```
['[105](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/periphery/MonadDeployer.sol#L105-L105)']
```solidity
105:     function setKuruAmmSpread(uint96 _kuruAmmSpread) external onlyOwner 
```
['[109](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/periphery/MonadDeployer.sol#L109-L109)']
```solidity
109:     function setKuruCollective(address _kuruCollective) external onlyOwner 
```
['[113](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/periphery/MonadDeployer.sol#L113-L113)']
```solidity
113:     function setKuruCollectiveFee(uint256 _kuruCollectiveFee) external onlyOwner 
```
['[304](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L304-L304)']
```solidity
304:     function _setApprovalsForMarket(
305:         address _baseAsset,
306:         address _quoteAsset,
307:         address _marketAddress,
308:         IOrderBook.OrderBookType _type
309:     ) internal 
```
['[46](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/OrderLinkedList.sol#L46-L46)']
```solidity
46:     function updateHead(PricePoint storage point, uint40 orderId) internal 
```
['[92](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L92-L92)']
```solidity
92:     function updateMarkets(address _marketAddress) external onlyRouter protocolActive 
```
['[111](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruForwarder.sol#L111-L111)']
```solidity
111:     function removeAllowedInterfaces(bytes4[] memory _allowedInterfaces) external onlyOwner 
```
['[281](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L281-L281)']
```solidity
281:     function upgradeMultipleOrderBookProxies(address[] memory proxies, bytes[] memory data) public onlyOwner 
```
['[287](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L287-L287)']
```solidity
287:     function upgradeMultipleVaultProxies(address[] memory proxies, bytes[] memory data) public onlyOwner 
```
['[298](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L298-L298)']
```solidity
298:     function transferOwnershipForContracts(address[] memory contracts, address _newOwner) external onlyOwner 
```
['[84](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L84-L84)']
```solidity
84:     function transferOwnership(address _newOwner) external 
```
['[56](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L56-L56)']
```solidity
56:     function _authorizeUpgrade(address) internal view override 
```
['[108](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L108-L108)']
```solidity
108:     function setMarketParams() public { // <= FOUND
109:         (
110:             marketParams.pricePrecision,
111:             marketParams.sizePrecision,
112:             marketParams.baseAssetAddress,
113:             marketParams.baseAssetDecimals,
114:             marketParams.quoteAssetAddress,
115:             marketParams.quoteAssetDecimals,
116:             marketParams.tickSize,
117:             marketParams.minSize,
118:             marketParams.maxSize,
119:             marketParams.takerFeeBps,
120:             marketParams.makerFeeBps
121:         ) = market.getMarketParams();
122:     }
```
['[105](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruForwarder.sol#L105-L105)']
```solidity
105:     function setAllowedInterfaces(bytes4[] memory _allowedInterfaces) external onlyOwner { // <= FOUND
106:         for (uint256 i = 0; i < _allowedInterfaces.length; i++) {
107:             allowedInterface[_allowedInterfaces[i]] = true;
108:         }
109:     }
```
['[105](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/periphery/MonadDeployer.sol#L105-L105)']
```solidity
105:     function setKuruAmmSpread(uint96 _kuruAmmSpread) external onlyOwner { // <= FOUND
106:         kuruAmmSpread = _kuruAmmSpread;
107:     }
```
['[109](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/periphery/MonadDeployer.sol#L109-L109)']
```solidity
109:     function setKuruCollective(address _kuruCollective) external onlyOwner { // <= FOUND
110:         kuruCollective = _kuruCollective;
111:     }
```
['[113](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/periphery/MonadDeployer.sol#L113-L113)']
```solidity
113:     function setKuruCollectiveFee(uint256 _kuruCollectiveFee) external onlyOwner { // <= FOUND
114:         kuruCollectiveFee = _kuruCollectiveFee;
115:     }
```
['[304](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L304-L304)']
```solidity
304:     function _setApprovalsForMarket( // <= FOUND
305:         address _baseAsset,
306:         address _quoteAsset,
307:         address _marketAddress,
308:         IOrderBook.OrderBookType _type
309:     ) internal {
310:         if (_type == IOrderBook.OrderBookType.NATIVE_IN_BASE) {
311:             _quoteAsset.safeApprove(_marketAddress, type(uint256).max);
312:         } else if (_type == IOrderBook.OrderBookType.NATIVE_IN_QUOTE) {
313:             _baseAsset.safeApprove(_marketAddress, type(uint256).max);
314:         } else {
315:             _baseAsset.safeApprove(_marketAddress, type(uint256).max);
316:             _quoteAsset.safeApprove(_marketAddress, type(uint256).max);
317:         }
318:     }
```
['[46](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/OrderLinkedList.sol#L46-L46)']
```solidity
46:     function updateHead(PricePoint storage point, uint40 orderId) internal { // <= FOUND
47:         if (orderId == NULL) {
48:             point.head = NULL;
49:             point.tail = NULL;
50:         }
51: 
52:         point.head = orderId;
53:     }
```
['[92](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L92-L92)']
```solidity
92:     function updateMarkets(address _marketAddress) external onlyRouter protocolActive { // <= FOUND
93:         verifiedMarket[_marketAddress] = true;
94:     }
```


</details>

## [Low-64] Unsafe use of transfer()/transferFrom() with IERC20

### Resolution 
SafeTransfer should be used in place of Transfer for Solidity contracts to ensure robust security and error handling. Unlike the basic Transfer function, SafeTransfer incorporates safeguards against potential smart contract vulnerabilities, such as reentrancy attacks and unexpected token loss. By automatically validating the recipient's ability to receive tokens and reverting transactions in case of failures, 

Num of instances: 1

### Findings 


<details><summary>Click to show findings</summary>

['[65](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/periphery/MonadDeployer.sol#L65-L93)']
```solidity
65:     function deployTokenAndMarket( // <= FOUND
66:         TokenParams memory tokenParams,
67:         MarketParams memory marketParams,
68:         bytes calldata metadata
69:     ) external payable returns (address market) {
70:         KuruERC20 token = new KuruERC20(tokenParams.name, tokenParams.symbol, tokenParams.initialSupply, address(this));
71:         market = router.deployProxy(
72:             IOrderBook.OrderBookType.NATIVE_IN_QUOTE,
73:             address(token),
74:             address(0),
75:             marketParams.sizePrecision,
76:             marketParams.pricePrecision,
77:             marketParams.tickSize,
78:             marketParams.minSize,
79:             marketParams.maxSize,
80:             marketParams.takerFeeBps,
81:             marketParams.makerFeeBps,
82:             kuruAmmSpread
83:         );
84:         if (msg.value != (marketParams.nativeTokenAmount + kuruCollectiveFee)) {
85:             revert InsufficientAssets(marketParams.nativeTokenAmount + kuruCollectiveFee, msg.value);
86:         }
87:         (address vault,,,,,,,) = IOrderBook(market).getVaultParams();
88:         uint256 _supplyToVault = tokenParams.initialSupply * (10 ** 4 - tokenParams.supplyToDev) / 10 ** 4;
89:         token.approve(vault, _supplyToVault);
90:         IKuruAMMVault(vault).deposit{value: marketParams.nativeTokenAmount}(
91:             _supplyToVault, marketParams.nativeTokenAmount, address(this)
92:         );
93:         token.transfer(tokenParams.dev, tokenParams.initialSupply - _supplyToVault); // <= FOUND
94:         marginAccount.deposit{value: kuruCollectiveFee}(kuruCollective, address(0), kuruCollectiveFee);
95:         emit PumpingTime(
96:             address(token),
97:             tokenParams.tokenURI,
98:             tokenParams.dev,
99:             tokenParams.initialSupply - _supplyToVault,
100:             market,
101:             metadata
102:         );
103:     }
```


</details>

## [Low-65] Avoid floating pragma in non interface/library files

### Resolution 
Avoid using floating pragmas in non-interface and non-library files to ensure contract compatibility and security. Floating pragmas like `pragma solidity ^0.8.0;` allow any compiler version that matches the specified range. While this can provide flexibility, it risks introducing unexpected behavior or vulnerabilities from future compiler versions. Instead, specify a fixed pragma version, such as `pragma solidity 0.8.0;`, to guarantee consistent behavior and security across deployments. This practice ensures that your contracts are tested and verified against a specific compiler version, reducing the risk of unforeseen issues and maintaining code reliability.

Num of instances: 9

### Findings 


<details><summary>Click to show findings</summary>

[]
```solidity
18: contract KuruAMMVault is IKuruAMMVault, ERC20, Initializable, UUPSUpgradeable, ReentrancyGuardTransient 
```
[]
```solidity
16: contract KuruForwarder is EIP712, Initializable, Ownable, UUPSUpgradeable 
```
[]
```solidity
17: contract MarginAccount is IMarginAccount, ERC2771Context, Ownable, Initializable, UUPSUpgradeable 
```
[]
```solidity
20: contract OrderBook is Initializable, UUPSUpgradeable, ERC2771Context, AbstractAMM 
```
[]
```solidity
6: contract KuruERC20 is ERC20 
```
[]
```solidity
12: contract MonadDeployer is Ownable 
```
[]
```solidity
23: contract Router is IRouter, Ownable, Initializable, UUPSUpgradeable 
```
[]
```solidity
17: abstract contract AbstractAMM is IOrderBook, ReentrancyGuardTransient 
```
[]
```solidity
12: abstract contract ERC2771Context 
```


</details>

## [Low-66] Read only reentrancy risk detected

### Resolution 
A **read-only reentrancy** vulnerability arises when a contract's `view` or `pure` function is re-entered during its execution, potentially leading to inconsistent state readings or unintended behaviors. Although these functions don't modify the contract's state, they can still be exploited if they depend on external calls that may re-enter the contract. This can result in the function returning outdated or manipulated data, which, when relied upon by other contracts or systems, can cause incorrect operations or financial discrepancies.

To mitigate this risk, it's essential to implement reentrancy guards even in read-only functions, especially when they involve external calls. Additionally, adhering to the checks-effects-interactions pattern and minimizing external calls within view functions can further reduce the potential for such vulnerabilities. Regular security audits and thorough testing are also crucial to identify and address any reentrancy issues before deployment.

Num of instances: 20

### Findings 


<details><summary>Click to show findings</summary>

['[376](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L376-L400)']
```solidity
376:     function _convertToAssetsWithNewSize(uint256 shares)
377:         internal
378:         view
379:         returns (uint256, uint256, uint96, uint96, bool)
380:     {
381:         (uint256 _baseAmount,) = _returnNormalizedAmountAndPrice(false);
382:         uint256 _baseAmountAfterRemoval = _baseAmount - FixedPointMathLib.mulDiv(shares, _baseAmount, totalSupply()); // <= FOUND
383:         (uint96 _newAskSize, uint96 _newBidSize) = _getVaultSizesForBaseAmount(_baseAmountAfterRemoval);
384:         (
385:             ,
386:             uint256 _vaultBestBid,
387:             uint96 _partiallyFilledBidSize,
388:             uint256 _vaultBestAsk,
389:             uint96 _partiallyFilledAskSize,
390:             ,
391:             ,
392:         ) = market.getVaultParams(); // <= FOUND
393:         MarketParams memory _marketParams = marketParams;
394:         (uint256 _reserveBase, uint256 _reserveQuote) = totalAssets();
395:         if (_partiallyFilledAskSize > _newAskSize || _partiallyFilledBidSize > _newBidSize) {
396:             int256 _baseOwedToVault = (
397:                 int256(uint256(_partiallyFilledAskSize)) - int256(uint256(_partiallyFilledBidSize))
398:             ) * int256(10 ** _marketParams.baseAssetDecimals) / int256(uint256(_marketParams.sizePrecision));
399:             int256 _quoteOwedToVault = (
400:                 int256(FixedPointMathLib.mulDivUp(_partiallyFilledBidSize, _vaultBestBid, _marketParams.sizePrecision)) // <= FOUND
401:                     - int256(FixedPointMathLib.mulDiv(_partiallyFilledAskSize, _vaultBestAsk, _marketParams.sizePrecision)) // <= FOUND
402:             ) * int256(10 ** _marketParams.quoteAssetDecimals) / int256(vaultPricePrecision);
403:             uint256 _baseOwedToUser;
404:             uint256 _quoteOwedToUser;
405:             if (_baseOwedToVault < 0) {
406:                 _reserveBase = _reserveBase - (uint256(-1 * _baseOwedToVault));
407:                 _baseOwedToUser =
408:                     FixedPointMathLib.mulDiv(shares, _reserveBase, totalSupply()) + uint256(-1 * _baseOwedToVault); // <= FOUND
409:             } else {
410:                 _reserveBase = _reserveBase + (uint256(_baseOwedToVault));
411:                 _baseOwedToUser =
412:                     FixedPointMathLib.mulDiv(shares, _reserveBase, totalSupply()) - uint256(_baseOwedToVault); // <= FOUND
413:             }
414:             if (_quoteOwedToVault < 0) {
415:                 _reserveQuote = _reserveQuote - (uint256(-1 * _quoteOwedToVault));
416:                 _quoteOwedToUser =
417:                     FixedPointMathLib.mulDiv(shares, _reserveQuote, totalSupply()) + uint256(-1 * _quoteOwedToVault); // <= FOUND
418:             } else {
419:                 _reserveQuote = _reserveQuote + (uint256(_quoteOwedToVault));
420:                 _quoteOwedToUser =
421:                     FixedPointMathLib.mulDiv(shares, _reserveQuote, totalSupply()) - uint256(_quoteOwedToVault); // <= FOUND
422:             }
423:             return (_baseOwedToUser, _quoteOwedToUser, _newAskSize, _newBidSize, true);
424:         } else {
425:             uint256 _baseOwedToUser = FixedPointMathLib.mulDiv(shares, _reserveBase, totalSupply()); // <= FOUND
426:             uint256 _quoteOwedToUser = FixedPointMathLib.mulDiv(shares, _reserveQuote, totalSupply()); // <= FOUND
427:             return (_baseOwedToUser, _quoteOwedToUser, _newAskSize, _newBidSize, false);
428:         }
429:     }
```
['[65](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/periphery/MonadDeployer.sol#L65-L87)']
```solidity
65:     function deployTokenAndMarket(
66:         TokenParams memory tokenParams,
67:         MarketParams memory marketParams,
68:         bytes calldata metadata
69:     ) external payable returns (address market) {
70:         KuruERC20 token = new KuruERC20(tokenParams.name, tokenParams.symbol, tokenParams.initialSupply, address(this));
71:         market = router.deployProxy(
72:             IOrderBook.OrderBookType.NATIVE_IN_QUOTE,
73:             address(token),
74:             address(0),
75:             marketParams.sizePrecision,
76:             marketParams.pricePrecision,
77:             marketParams.tickSize,
78:             marketParams.minSize,
79:             marketParams.maxSize,
80:             marketParams.takerFeeBps,
81:             marketParams.makerFeeBps,
82:             kuruAmmSpread
83:         );
84:         if (msg.value != (marketParams.nativeTokenAmount + kuruCollectiveFee)) {
85:             revert InsufficientAssets(marketParams.nativeTokenAmount + kuruCollectiveFee, msg.value);
86:         }
87:         (address vault,,,,,,,) = IOrderBook(market).getVaultParams(); // <= FOUND
88:         uint256 _supplyToVault = tokenParams.initialSupply * (10 ** 4 - tokenParams.supplyToDev) / 10 ** 4;
89:         token.approve(vault, _supplyToVault);
90:         IKuruAMMVault(vault).deposit{value: marketParams.nativeTokenAmount}(
91:             _supplyToVault, marketParams.nativeTokenAmount, address(this)
92:         );
93:         token.transfer(tokenParams.dev, tokenParams.initialSupply - _supplyToVault);
94:         marginAccount.deposit{value: kuruCollectiveFee}(kuruCollective, address(0), kuruCollectiveFee);
95:         emit PumpingTime(
96:             address(token),
97:             tokenParams.tokenURI,
98:             tokenParams.dev,
99:             tokenParams.initialSupply - _supplyToVault,
100:             market,
101:             metadata
102:         );
103:     }
```
['[45](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L45-L76)']
```solidity
45:     function initialize(
46:         address _owner,
47:         address token1_,
48:         address token2_,
49:         address _marginAccount,
50:         address _market,
51:         uint96 _spreadConstant
52:     ) public initializer {
53:         owner = _owner;
54:         token1 = token1_;
55:         token1Decimals = token1_ != address(0) ? ERC20(token1_).decimals() : 18;
56:         token2 = token2_;
57:         token2Decimals = token2_ != address(0) ? ERC20(token2_).decimals() : 18;
58:         marginAccount = IMarginAccount(_marginAccount);
59:         market = IOrderBook(_market);
60:         SPREAD_CONSTANT = _spreadConstant;
61:         setMarketParams();
62:         if (token1_ != address(0)) {
63:             token1_.safeApprove(_marginAccount, type(uint256).max);
64:         }
65:         if (token2_ != address(0)) {
66:             token2_.safeApprove(_marginAccount, type(uint256).max);
67:         }
68:         string memory token1Symbol;
69:         string memory token2Symbol;
70:         if (token1_ != address(0)) {
71:             token1Symbol = ERC20(token1_).symbol(); // <= FOUND
72:         } else {
73:             token1Symbol = "MON";
74:         }
75:         if (token2_ != address(0)) {
76:             token2Symbol = ERC20(token2_).symbol(); // <= FOUND
77:         } else {
78:             token2Symbol = "MON";
79:         }
80:         _name = string.concat(token1Symbol, "-", token2Symbol, "-", "KURU-AMM-VAULT");
81:     }
```
['[1399](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L1399-L1437)']
```solidity
1399:     function getL2Book(uint32 _bidPricePoints, uint32 _askPricePoints) public view returns (bytes memory data) {
1400:         uint256 dataStart;
1401:         uint256 lastFree;
1402: 
1403:         assembly ("memory-safe") {
1404:             dataStart := mload(0x40)
1405:             lastFree := add(dataStart, 32)
1406:             mstore(lastFree, number()) 
1407:             lastFree := add(lastFree, 32)
1408:             mstore(0x40, lastFree)
1409:         }
1410: 
1411:         
1412:         uint32 price = TreeMath.findFirstRight(s_buyTree, type(uint32).max); // <= FOUND
1413:         while (price != type(uint32).max && price != 0 && _bidPricePoints != 0) {
1414:             uint40 orderId = s_buyPricePoints[price].head;
1415:             uint96 size = 0;
1416:             while (orderId != 0) {
1417:                 size += s_orders[orderId].size;
1418:                 orderId = s_orders[orderId].next;
1419:             }
1420:             assembly ("memory-safe") {
1421:                 let curFree := mload(0x40)
1422:                 if iszero(eq(curFree, lastFree)) {
1423:                     
1424:                     let producedLen := sub(lastFree, dataStart)
1425:                     for { let offset := 0 } lt(offset, producedLen) { offset := add(offset, 32) } {
1426:                         mstore(add(curFree, offset), mload(add(dataStart, offset)))
1427:                     }
1428:                     dataStart := curFree
1429:                     lastFree := add(curFree, producedLen)
1430:                 }
1431: 
1432:                 mstore(lastFree, price)
1433:                 mstore(add(lastFree, 32), size)
1434:                 lastFree := add(lastFree, 64)
1435:                 mstore(0x40, lastFree)
1436:             }
1437:             price = TreeMath.findFirstRight(s_buyTree, price); // <= FOUND
1438:             --_bidPricePoints;
1439:         }
1440: 
1441:         assembly ("memory-safe") {
1442:             let curFree := mload(0x40)
1443:             if iszero(eq(curFree, lastFree)) {
1444:                 let producedLen := sub(lastFree, dataStart)
1445:                 for { let offset := 0 } lt(offset, producedLen) { offset := add(offset, 32) } {
1446:                     mstore(add(curFree, offset), mload(add(dataStart, offset)))
1447:                 }
1448:                 dataStart := curFree
1449:                 lastFree := add(curFree, producedLen)
1450:             }
1451: 
1452:             mstore(lastFree, 0)
1453:             lastFree := add(lastFree, 32)
1454:             mstore(0x40, lastFree)
1455:         }
1456: 
1457:         price = TreeMath.findFirstLeft(s_sellTree, 0);
1458:         while (price != type(uint32).max && price != 0 && _askPricePoints != 0) {
1459:             uint40 orderId = s_sellPricePoints[price].head;
1460:             uint96 size = 0;
1461:             while (orderId != 0) {
1462:                 size += s_orders[orderId].size;
1463:                 orderId = s_orders[orderId].next;
1464:             }
1465:             assembly ("memory-safe") {
1466:                 let curFree := mload(0x40)
1467:                 if iszero(eq(curFree, lastFree)) {
1468:                     
1469:                     let producedLen := sub(lastFree, dataStart)
1470:                     for { let offset := 0 } lt(offset, producedLen) { offset := add(offset, 32) } {
1471:                         mstore(add(curFree, offset), mload(add(dataStart, offset)))
1472:                     }
1473:                     dataStart := curFree
1474:                     lastFree := add(curFree, producedLen)
1475:                 }
1476: 
1477:                 mstore(lastFree, price)
1478:                 mstore(add(lastFree, 32), size)
1479:                 lastFree := add(lastFree, 64)
1480:                 mstore(0x40, lastFree)
1481:             }
1482:             price = TreeMath.findFirstLeft(s_sellTree, price);
1483:             --_askPricePoints;
1484:         }
1485: 
1486:         assembly ("memory-safe") {
1487:             mstore(dataStart, sub(lastFree, add(dataStart, 32)))
1488:             data := dataStart
1489:         }
1490:     }
```
['[175](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L175-L181)']
```solidity
175:     function _mintAndDeposit(uint256 baseDeposit, uint256 quoteDeposit, address receiver) internal returns (uint256) {
176:         (uint256 _baseAmount, uint256 _currentAskPrice) = _returnNormalizedAmountAndPrice(true);
177:         uint256 _shares;
178:         if (totalSupply() != 0) {
179:             uint256 _expectedQuoteAmount = (
180:                 (
181:                     FixedPointMathLib.mulDivUp(baseDeposit, _currentAskPrice, vaultPricePrecision) // <= FOUND
182:                         * 10 ** marketParams.quoteAssetDecimals
183:                 )
184:             ) / 10 ** marketParams.baseAssetDecimals;
185:             require(_expectedQuoteAmount <= quoteDeposit, KuruAMMVaultErrors.InsufficientQuoteToken());
186:             _shares = _convertToShares(baseDeposit, _expectedQuoteAmount, _currentAskPrice);
187:             quoteDeposit = _expectedQuoteAmount;
188:             _mint(receiver, _shares);
189:         } else {
190:             _shares = FixedPointMathLib.sqrt(baseDeposit * quoteDeposit);
191:             _mint(address(marginAccount), MIN_LIQUIDITY);
192:             _shares -= MIN_LIQUIDITY;
193:             _mint(receiver, _shares);
194:             _currentAskPrice = (
195:                 ((quoteDeposit * 10 ** marketParams.baseAssetDecimals)) * vaultPricePrecision
196:                     / 10 ** marketParams.quoteAssetDecimals
197:             ) / (baseDeposit);
198:         }
199:         require(_shares > 0, KuruAMMVaultErrors.InsufficientLiquidityMinted());
200:         (uint96 _newAskSize, uint96 _newBidSize) = _getVaultSizesForBaseAmount(_baseAmount + baseDeposit);
201:         market.updateVaultOrdSz( // <= FOUND
202:             _newAskSize,
203:             _newBidSize,
204:             _currentAskPrice,
205:             FixedPointMathLib.mulDivRound(_currentAskPrice, BPS_MULTIPLIER, BPS_MULTIPLIER + SPREAD_CONSTANT),
206:             false
207:         );
208:         address _token1 = token1;
209:         address _token2 = token2;
210:         _depositAmountsToMarginAccount(_token1, _token2, baseDeposit, quoteDeposit);
211:         uint256 _nativeRefund =
212:             _token1 == address(0) ? (msg.value - baseDeposit) : (_token2 == address(0) ? (msg.value - quoteDeposit) : 0);
213:         if (_nativeRefund > 0) {
214:             msg.sender.safeTransferETH(_nativeRefund);
215:         }
216:         emit KuruVaultDeposit(baseDeposit, quoteDeposit, _shares, receiver);
217:         return _shares;
218:     }
```
['[108](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/TreeMath.sol#L108-L170)']
```solidity
108:     function findFirstRight(TreeUint32 storage tree, uint32 id) internal view returns (uint32) {
109:         bytes32 leaves;
110: 
111:         bytes32 key3 = bytes32(uint256(id) >> 8);
112:         uint8 bit = uint8(id & type(uint8).max);
113: 
114:         if (bit != 0) {
115:             leaves = tree.level3[key3];
116:             uint256 closestBit = _closestBitRight(leaves, bit);
117: 
118:             if (closestBit != type(uint256).max) return uint32((uint256(key3) << 8) | closestBit);
119:         }
120: 
121:         bytes32 key2 = key3 >> 8;
122:         bit = uint8(uint256(key3) & type(uint8).max);
123: 
124:         if (bit != 0) {
125:             leaves = tree.level2[key2];
126:             uint256 closestBit = _closestBitRight(leaves, bit);
127: 
128:             if (closestBit != type(uint256).max) {
129:                 key3 = bytes32((uint256(key2) << 8) | closestBit);
130:                 leaves = tree.level3[key3];
131: 
132:                 return uint32((uint256(key3) << 8) | uint256(leaves).mostSignificantBit()); // <= FOUND
133:             }
134:         }
135: 
136:         bytes32 key1 = key2 >> 8;
137:         bit = uint8(uint256(key2) & type(uint8).max);
138: 
139:         if (bit != 0) {
140:             leaves = tree.level1[key1];
141:             uint256 closestBit = _closestBitRight(leaves, bit);
142: 
143:             if (closestBit != type(uint256).max) {
144:                 key2 = bytes32((uint256(key1) << 8) | closestBit);
145:                 leaves = tree.level2[key2];
146: 
147:                 key3 = bytes32((uint256(key2) << 8) | uint256(leaves).mostSignificantBit()); // <= FOUND
148:                 leaves = tree.level3[key3];
149: 
150:                 return uint32((uint256(key3) << 8) | uint256(leaves).mostSignificantBit()); // <= FOUND
151:             }
152:         }
153: 
154:         bit = uint8(uint256(key1) & type(uint8).max);
155: 
156:         if (bit != 0) {
157:             leaves = tree.level0;
158:             uint256 closestBit = _closestBitRight(leaves, bit);
159: 
160:             if (closestBit != type(uint256).max) {
161:                 key1 = bytes32(closestBit);
162:                 leaves = tree.level1[key1];
163: 
164:                 key2 = bytes32((uint256(key1) << 8) | uint256(leaves).mostSignificantBit()); // <= FOUND
165:                 leaves = tree.level2[key2];
166: 
167:                 key3 = bytes32((uint256(key2) << 8) | uint256(leaves).mostSignificantBit()); // <= FOUND
168:                 leaves = tree.level3[key3];
169: 
170:                 return uint32((uint256(key3) << 8) | uint256(leaves).mostSignificantBit()); // <= FOUND
171:             }
172:         }
173: 
174:         return type(uint32).max;
175:     }
```
['[184](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/TreeMath.sol#L184-L246)']
```solidity
184:     function findFirstLeft(TreeUint32 storage tree, uint32 id) internal view returns (uint32) {
185:         bytes32 leaves;
186: 
187:         bytes32 key3 = bytes32(uint256(id) >> 8);
188:         uint8 bit = uint8(id & type(uint8).max);
189: 
190:         if (bit != type(uint8).max) {
191:             leaves = tree.level3[key3];
192:             uint256 closestBit = _closestBitLeft(leaves, bit);
193: 
194:             if (closestBit != type(uint256).max) return uint32((uint256(key3) << 8) | closestBit);
195:         }
196: 
197:         bytes32 key2 = key3 >> 8;
198:         bit = uint8(uint256(key3) & type(uint8).max);
199: 
200:         if (bit != type(uint8).max) {
201:             leaves = tree.level2[key2];
202:             uint256 closestBit = _closestBitLeft(leaves, bit);
203: 
204:             if (closestBit != type(uint256).max) {
205:                 key3 = bytes32((uint256(key2) << 8) | closestBit);
206:                 leaves = tree.level3[key3];
207: 
208:                 return uint32((uint256(key3) << 8) | uint256(leaves).leastSignificantBit()); // <= FOUND
209:             }
210:         }
211: 
212:         bytes32 key1 = key2 >> 8;
213:         bit = uint8(uint256(key2) & type(uint8).max);
214: 
215:         if (bit != type(uint8).max) {
216:             leaves = tree.level1[key1];
217:             uint256 closestBit = _closestBitLeft(leaves, bit);
218: 
219:             if (closestBit != type(uint256).max) {
220:                 key2 = bytes32((uint256(key1) << 8) | closestBit);
221:                 leaves = tree.level2[key2];
222: 
223:                 key3 = bytes32((uint256(key2) << 8) | uint256(leaves).leastSignificantBit()); // <= FOUND
224:                 leaves = tree.level3[key3];
225: 
226:                 return uint32((uint256(key3) << 8) | uint256(leaves).leastSignificantBit()); // <= FOUND
227:             }
228:         }
229: 
230:         bit = uint8(uint256(key1) & type(uint8).max);
231: 
232:         if (bit != type(uint8).max) {
233:             leaves = tree.level0;
234:             uint256 closestBit = _closestBitLeft(leaves, bit);
235: 
236:             if (closestBit != type(uint256).max) {
237:                 key1 = bytes32(closestBit);
238:                 leaves = tree.level1[key1];
239: 
240:                 key2 = bytes32((uint256(key1) << 8) | uint256(leaves).leastSignificantBit()); // <= FOUND
241:                 leaves = tree.level2[key2];
242: 
243:                 key3 = bytes32((uint256(key2) << 8) | uint256(leaves).leastSignificantBit()); // <= FOUND
244:                 leaves = tree.level3[key3];
245: 
246:                 return uint32((uint256(key3) << 8) | uint256(leaves).leastSignificantBit()); // <= FOUND
247:             }
248:         }
249: 
250:         return 0;
251:     }
```
['[59](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/AbstractAMM.sol#L59-L74)']
```solidity
59:     function _fillVaultBuyMatch(uint256 _breakPoint, uint96 _quoteSize)
60:         internal
61:         returns (uint96 quoteLeft, uint96 sizeFilled, bytes memory makerCredits)
62:     {
63:         uint256 _price = vaultBestAsk;
64:         uint256 _quoteInput = _quoteSize * vaultPricePrecision / _getPricePrecision();
65:         uint96 _cachedLastVaultSize = vaultAskOrderSize;
66:         uint96 _cachedPartiallyFilledBid = bidPartiallyFilledSize;
67:         uint96 _availableSize = _cachedLastVaultSize - askPartiallyFilledSize;
68:         
69:         if (_quoteInput >= FixedPointMathLib.mulDivUp(_price, _availableSize, _getSizePrecision())) { // <= FOUND
70:             askPartiallyFilledSize = 0;
71:         }
72: 
73:         while (_price < _breakPoint && _quoteInput > 0) {
74:             uint256 _quoteNeededForFill = FixedPointMathLib.mulDivUp(_price, _availableSize, _getSizePrecision()); // <= FOUND
75:             if (_quoteNeededForFill > _quoteInput) {
76:                 uint96 _sizeFilledAtPrice = toU96(_quoteInput * _getSizePrecision() / _price);
77:                 sizeFilled += _sizeFilledAtPrice;
78:                 askPartiallyFilledSize += _sizeFilledAtPrice;
79:                 _emitTrade(0, kuruAmmVault, true, _price, _availableSize - _sizeFilledAtPrice, _sizeFilledAtPrice);
80:                 _quoteInput = 0;
81:                 break;
82:             } else {
83:                 sizeFilled += _availableSize;
84:                 _quoteInput -= _quoteNeededForFill;
85:                 _cachedLastVaultSize = toU96(
86:                     FixedPointMathLib.mulDiv( // <= FOUND
87:                         _cachedLastVaultSize, DOUBLE_BPS_MULTIPLIER, DOUBLE_BPS_MULTIPLIER + SPREAD_CONSTANT
88:                     )
89:                 );
90:                 _emitTrade(0, kuruAmmVault, true, _price, 0, _availableSize);
91:                 _availableSize = _cachedLastVaultSize;
92:                 _price = FixedPointMathLib.mulDivRound(_price, BPS_MULTIPLIER + SPREAD_CONSTANT, BPS_MULTIPLIER);
93:                 _cachedPartiallyFilledBid = toU96(
94:                     FixedPointMathLib.mulDiv( // <= FOUND
95:                         _cachedPartiallyFilledBid, BPS_MULTIPLIER, BPS_MULTIPLIER + SPREAD_CONSTANT
96:                     )
97:                 );
98:             }
99:         }
100:         if (_price != vaultBestAsk) {
101:             vaultBestAsk = _price;
102:             vaultBestBid = FixedPointMathLib.mulDivRound(_price, BPS_MULTIPLIER, BPS_MULTIPLIER + SPREAD_CONSTANT);
103:             vaultAskOrderSize = _cachedLastVaultSize;
104:             vaultBidOrderSize = toU96(
105:                 FixedPointMathLib.mulDiv( // <= FOUND
106:                     _cachedLastVaultSize, DOUBLE_BPS_MULTIPLIER + SPREAD_CONSTANT, DOUBLE_BPS_MULTIPLIER
107:                 )
108:             );
109:         }
110:         bidPartiallyFilledSize = _cachedPartiallyFilledBid;
111:         quoteLeft = toU96(FixedPointMathLib.mulDiv(_quoteInput, _getPricePrecision(), vaultPricePrecision)); // <= FOUND
112:         makerCredits =
113:             _creditVaultOnMarketBuy(sizeFilled, (_quoteSize * vaultPricePrecision / _getPricePrecision() - _quoteInput));
114:     }
```
['[124](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/AbstractAMM.sol#L124-L175)']
```solidity
124:     function _fillVaultForBuy(uint256 _breakPoint, uint96 _size)
125:         internal
126:         returns (uint96 sizeLeft, uint96 fundsConsumed, bytes memory makerCredits)
127:     {
128:         uint256 _price = vaultBestAsk;
129:         sizeLeft = _size;
130: 
131:         uint96 _cachedLastVaultSize = vaultAskOrderSize;
132:         uint96 _cachedPartiallyFilledBid = bidPartiallyFilledSize;
133:         
134:         uint256 _consumedQuote;
135:         uint96 _availableSize = _cachedLastVaultSize - askPartiallyFilledSize;
136:         if (_availableSize <= sizeLeft) {
137:             askPartiallyFilledSize = 0;
138:         }
139:         while (_price < _breakPoint && sizeLeft > 0) {
140:             if (_availableSize > sizeLeft) {
141:                 askPartiallyFilledSize += sizeLeft;
142:                 _consumedQuote += FixedPointMathLib.mulDivUp(sizeLeft, _price, _getSizePrecision()); // <= FOUND
143:                 _emitTrade(0, kuruAmmVault, true, _price, _availableSize - sizeLeft, sizeLeft);
144:                 sizeLeft = 0;
145:                 break;
146:             } else {
147:                 sizeLeft -= _availableSize;
148:                 _consumedQuote += FixedPointMathLib.mulDivUp(_availableSize, _price, _getSizePrecision()); // <= FOUND
149:                 _cachedLastVaultSize = toU96(
150:                     FixedPointMathLib.mulDiv( // <= FOUND
151:                         _cachedLastVaultSize, DOUBLE_BPS_MULTIPLIER, DOUBLE_BPS_MULTIPLIER + SPREAD_CONSTANT
152:                     )
153:                 );
154:                 _emitTrade(0, kuruAmmVault, true, _price, 0, _availableSize);
155:                 _availableSize = _cachedLastVaultSize;
156:                 _price = FixedPointMathLib.mulDivRound(_price, BPS_MULTIPLIER + SPREAD_CONSTANT, BPS_MULTIPLIER);
157:                 _cachedPartiallyFilledBid = toU96(
158:                     FixedPointMathLib.mulDiv( // <= FOUND
159:                         _cachedPartiallyFilledBid, BPS_MULTIPLIER, BPS_MULTIPLIER + SPREAD_CONSTANT
160:                     )
161:                 );
162:             }
163:         }
164:         if (_price != vaultBestAsk) {
165:             vaultBestAsk = _price;
166:             vaultBestBid = FixedPointMathLib.mulDivRound(_price, BPS_MULTIPLIER, BPS_MULTIPLIER + SPREAD_CONSTANT);
167:             vaultAskOrderSize = _cachedLastVaultSize;
168:             vaultBidOrderSize = toU96(
169:                 FixedPointMathLib.mulDiv( // <= FOUND
170:                     _cachedLastVaultSize, DOUBLE_BPS_MULTIPLIER + SPREAD_CONSTANT, DOUBLE_BPS_MULTIPLIER
171:                 )
172:             );
173:         }
174:         bidPartiallyFilledSize = _cachedPartiallyFilledBid;
175:         fundsConsumed = toU96(FixedPointMathLib.mulDivUp(_consumedQuote, _getPricePrecision(), vaultPricePrecision)); // <= FOUND
176:         makerCredits = _creditVaultOnMarketBuy(_size - sizeLeft, _consumedQuote);
177:     }
```
['[187](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/AbstractAMM.sol#L187-L224)']
```solidity
187:     function _fillVaultForSell(uint256 _breakPoint, uint96 _size)
188:         internal
189:         returns (uint96 sizeLeft, uint256 quoteOwedToUser, bytes memory makerCredits)
190:     {
191:         uint256 _price = vaultBestBid;
192:         uint96 _availableSize = vaultBidOrderSize - bidPartiallyFilledSize;
193:         uint96 _cachedLastVaultSize = vaultBidOrderSize;
194:         sizeLeft = _size;
195:         if (sizeLeft >= _availableSize) {
196:             bidPartiallyFilledSize = 0;
197:         }
198: 
199:         while (_price > _breakPoint && sizeLeft > 0) {
200:             if (_availableSize > sizeLeft) {
201:                 bidPartiallyFilledSize += sizeLeft;
202:                 quoteOwedToUser += FixedPointMathLib.mulDiv(_price, sizeLeft, _getSizePrecision()); // <= FOUND
203:                 _emitTrade(0, kuruAmmVault, false, _price, _availableSize - sizeLeft, sizeLeft);
204:                 sizeLeft = 0;
205:                 break;
206:             } else {
207:                 sizeLeft -= _availableSize;
208:                 quoteOwedToUser += FixedPointMathLib.mulDiv(_price, _availableSize, _getSizePrecision()); // <= FOUND
209:                 _cachedLastVaultSize = toU96(
210:                     FixedPointMathLib.mulDiv( // <= FOUND
211:                         _cachedLastVaultSize, DOUBLE_BPS_MULTIPLIER + SPREAD_CONSTANT, DOUBLE_BPS_MULTIPLIER
212:                     )
213:                 );
214:                 _emitTrade(0, kuruAmmVault, false, _price, 0, _availableSize);
215:                 _availableSize = _cachedLastVaultSize;
216:                 _price = FixedPointMathLib.mulDivRound(_price, BPS_MULTIPLIER, BPS_MULTIPLIER + SPREAD_CONSTANT);
217:             }
218:         }
219:         if (_price != vaultBestBid) {
220:             vaultBestBid = _price;
221:             vaultBestAsk = FixedPointMathLib.mulDivRound(_price, BPS_MULTIPLIER + SPREAD_CONSTANT, BPS_MULTIPLIER);
222:             vaultBidOrderSize = _cachedLastVaultSize;
223:             vaultAskOrderSize = toU96(
224:                 FixedPointMathLib.mulDiv( // <= FOUND
225:                     _cachedLastVaultSize, DOUBLE_BPS_MULTIPLIER, DOUBLE_BPS_MULTIPLIER + SPREAD_CONSTANT
226:                 )
227:             );
228:         }
229:         makerCredits = _creditVaultOnMarketSell(_size - sizeLeft, quoteOwedToUser);
230:     }
```
['[316](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L316-L321)']
```solidity
316:     function _returnNormalizedAmountAndPrice(bool roundUp) internal view returns (uint256, uint256) {
317:         
318:         
319:         uint96 _normalizedBaseAmount = roundUp
320:             ? toU96(
321:                 FixedPointMathLib.mulDivUp( // <= FOUND
322:                     market.vaultAskOrderSize(), DOUBLE_BPS_MULTIPLIER + SPREAD_CONSTANT, SPREAD_CONSTANT
323:                 )
324:             )
325:             : toU96(
326:                 FixedPointMathLib.mulDiv( // <= FOUND
327:                     market.vaultAskOrderSize(), DOUBLE_BPS_MULTIPLIER + SPREAD_CONSTANT, SPREAD_CONSTANT
328:                 )
329:             );
330:         uint256 _price = market.vaultBestAsk();
331:         return ((_normalizedBaseAmount * 10 ** marketParams.baseAssetDecimals) / marketParams.sizePrecision, _price);
332:     }
```
['[350](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L350-L366)']
```solidity
350:     function _convertToAssets(uint256 shares, bool isDeposit)
351:         internal
352:         view
353:         returns (uint256 _baseAmount, uint256 _quoteAmount)
354:     {
355:         if (isDeposit) {
356:             if (totalSupply() == 0) {
357:                 return (0, 0);
358:             }
359:             (uint256 _baseReserve, uint256 _quoteReserve) = totalAssets();
360:             (, uint256 _currentAskPrice) = _returnNormalizedAmountAndPrice(true);
361:             (_baseReserve, _quoteReserve) =
362:                 _returnVirtuallyRebalancedTotalAssets(_baseReserve, _quoteReserve, _currentAskPrice);
363:             _baseAmount = FixedPointMathLib.mulDiv(shares, _baseReserve, totalSupply()); // <= FOUND
364:             _quoteAmount = (
365:                 (
366:                     FixedPointMathLib.mulDivUp(_baseAmount, _currentAskPrice, vaultPricePrecision) // <= FOUND
367:                         * 10 ** marketParams.quoteAssetDecimals
368:                 )
369:             ) / 10 ** marketParams.baseAssetDecimals;
370:             return (_baseAmount, _quoteAmount);
371:         } else {
372:             (_baseAmount, _quoteAmount,,,) = _convertToAssetsWithNewSize(shares);
373:         }
374:     }
```
['[930](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L930-L983)']
```solidity
930:     function _marketBuyMatch(uint96 _quoteSize, bool _isMargin) internal returns (uint96, uint256) {
931:         uint96 sizeToCreditTaker;
932:         uint96 sizeToCreditViaVault;
933:         bytes memory makerCredits;
934:         uint32 _pricePrecision = pricePrecision;
935:         uint96 _sizePrecision = sizePrecision;
936: 
937:         (bool _isVaultFill, uint256 _bestAsk) = bestAsk();
938: 
939:         while (_quoteSize > 0 && _bestAsk != 0) {
940:             bytes memory priceUpdate;
941:             if (_isVaultFill) {
942:                 uint96 _sizeFilled;
943:                 (_quoteSize, _sizeFilled, priceUpdate) = _fillVaultBuyMatch(_getOBAsk(), _quoteSize);
944:                 sizeToCreditViaVault += _sizeFilled;
945:                 sizeToCreditTaker += _sizeFilled;
946:             } else {
947:                 
948:                 uint96 _sizeFillableAtPriceLeft =
949:                     toU96(_quoteSize * _sizePrecision * vaultPricePrecision / (_bestAsk * _pricePrecision));
950:                 uint96 _sizeFillableAtPriceBefore = _sizeFillableAtPriceLeft; 
951:                 (_sizeFillableAtPriceLeft, priceUpdate) = _fillSizeForPrice(
952:                     s_sellTree,
953:                     toU32(_bestAsk * _pricePrecision / vaultPricePrecision),
954:                     s_sellPricePoints[(_bestAsk * _pricePrecision / vaultPricePrecision)],
955:                     _sizeFillableAtPriceLeft
956:                 );
957:                 sizeToCreditTaker += (_sizeFillableAtPriceBefore - _sizeFillableAtPriceLeft);
958:                 _quoteSize = toU96(
959:                     FixedPointMathLib.mulDiv( // <= FOUND
960:                         _bestAsk * _pricePrecision, _sizeFillableAtPriceLeft, _sizePrecision * vaultPricePrecision
961:                     )
962:                 );
963:             }
964:             makerCredits = bytes.concat(makerCredits, priceUpdate);
965: 
966:             (_isVaultFill, _bestAsk) = bestAsk();
967:         }
968: 
969:         if (sizeToCreditTaker == 0) {
970:             return (_quoteSize, 0);
971:         }
972: 
973:         {
974:             uint256 _baseDecimalMultiplier = baseDecimalMultiplier;
975:             uint256 _tokenCredit = (sizeToCreditTaker * _baseDecimalMultiplier) / _sizePrecision;
976:             if (sizeToCreditViaVault > 0 && msg.sender != address(0)) {
977:                 marginAccount.debitUser(
978:                     kuruAmmVault, baseAsset, (sizeToCreditViaVault * _baseDecimalMultiplier) / _sizePrecision
979:                 );
980:             }
981:             uint256 _takerFeeBps = takerFeeBps;
982:             if (_takerFeeBps > 0) {
983:                 uint256 _feeDebit = FixedPointMathLib.mulDivUp(_tokenCredit, _takerFeeBps, BPS_MULTIPLIER); // <= FOUND
984:                 _tokenCredit -= _feeDebit;
985:                 
986:                 baseFeeCollected += ((_feeDebit * (_takerFeeBps - makerFeeBps)) / _takerFeeBps);
987:             }
988:             if (msg.sender != address(0)) {
989:                 marginAccount.creditUsersEncoded(
990:                     bytes.concat(makerCredits, abi.encode(_msgSender(), baseAsset, _tokenCredit, _isMargin))
991:                 );
992:             }
993:             return (_quoteSize, _tokenCredit);
994:         }
995:     }
```
['[1003](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L1003-L1058)']
```solidity
1003:     function _matchAggressiveSell(uint256 _limitPrice, uint96 _sizeToBeFilledLeft, bool _useMargin)
1004:         internal
1005:         returns (uint96, uint256)
1006:     {
1007:         uint96 quoteCreditTaker;
1008:         uint256 quoteCreditVaultTaker;
1009:         uint256 tokenCredit;
1010:         (bool _isVaultFill, uint256 _bestBid) = bestBid();
1011:         bytes memory makerCredits;
1012:         uint32 _pricePrecision = pricePrecision;
1013:         _limitPrice = _limitPrice * vaultPricePrecision / _pricePrecision;
1014:         while (_sizeToBeFilledLeft > 0 && _bestBid >= _limitPrice && _bestBid != type(uint256).max) {
1015:             uint96 _sizeToBeFilledBefore = _sizeToBeFilledLeft; 
1016: 
1017:             bytes memory priceUpdate;
1018: 
1019:             if (_isVaultFill) {
1020:                 uint256 _quoteToTaker;
1021:                 (_sizeToBeFilledLeft, _quoteToTaker, priceUpdate) =
1022:                     _fillVaultForSell(_getOBBid() >= _limitPrice ? _getOBBid() : _limitPrice - 1, _sizeToBeFilledLeft);
1023:                 quoteCreditVaultTaker += _quoteToTaker;
1024:             } else {
1025:                 (_sizeToBeFilledLeft, priceUpdate) = _fillSizeForPrice(
1026:                     s_buyTree,
1027:                     toU32(_bestBid * _pricePrecision / vaultPricePrecision),
1028:                     s_buyPricePoints[_bestBid * _pricePrecision / vaultPricePrecision],
1029:                     _sizeToBeFilledLeft
1030:                 );
1031:                 quoteCreditTaker += toU96(
1032:                     FixedPointMathLib.mulDiv( // <= FOUND
1033:                         _sizeToBeFilledBefore - _sizeToBeFilledLeft,
1034:                         toU32(_bestBid * _pricePrecision / vaultPricePrecision),
1035:                         sizePrecision
1036:                     )
1037:                 );
1038:             }
1039:             makerCredits = bytes.concat(makerCredits, priceUpdate);
1040: 
1041:             (_isVaultFill, _bestBid) = bestBid();
1042:         }
1043: 
1044:         if (quoteCreditTaker == 0 && quoteCreditVaultTaker == 0) {
1045:             return (_sizeToBeFilledLeft, 0);
1046:         }
1047:         {
1048:             uint256 _quoteDecimalMultiplier = quoteDecimalMultiplier;
1049:             tokenCredit = ((quoteCreditTaker) * _quoteDecimalMultiplier) / _pricePrecision
1050:                 + (quoteCreditVaultTaker * _quoteDecimalMultiplier) / vaultPricePrecision;
1051:             if (quoteCreditVaultTaker > 0 && msg.sender != address(0)) {
1052:                 marginAccount.debitUser(
1053:                     kuruAmmVault, quoteAsset, (quoteCreditVaultTaker * _quoteDecimalMultiplier) / vaultPricePrecision
1054:                 );
1055:             }
1056:             uint256 _takerFeeBps = takerFeeBps;
1057:             if (_takerFeeBps > 0) {
1058:                 uint256 _feeDebit = FixedPointMathLib.mulDivUp(tokenCredit, _takerFeeBps, BPS_MULTIPLIER); // <= FOUND
1059:                 tokenCredit -= _feeDebit;
1060:                 
1061:                 quoteFeeCollected += ((_feeDebit * (_takerFeeBps - makerFeeBps)) / _takerFeeBps);
1062:             }
1063:             if (msg.sender != address(0)) {
1064:                 marginAccount.creditUsersEncoded(
1065:                     bytes.concat(makerCredits, abi.encode(_msgSender(), quoteAsset, tokenCredit, _useMargin))
1066:                 );
1067:             }
1068:         }
1069: 
1070:         return (_sizeToBeFilledLeft, tokenCredit);
1071:     }
```
['[1166](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L1166-L1198)']
```solidity
1166:     function _handleFlipOrderUpdate(uint40 _orderId, uint96 _size, bool nullify) internal {
1167:         
1168:         if (s_orders[_orderId].flippedId == OrderLinkedList.NULL) {
1169:             Order memory _filledOrder = s_orders[_orderId];
1170:             
1171:             uint40 _flipOrderId = s_orderIdCounter + 1;
1172:             s_orderIdCounter = _flipOrderId;
1173:             uint40 _prevOrderId;
1174:             if (!s_orders[_orderId].isBuy) {
1175:                 _size = toU96(FixedPointMathLib.mulDiv(_size, _filledOrder.price, _filledOrder.flippedPrice)); // <= FOUND
1176:                 _prevOrderId = OrderLinkedList.insertAtTail(s_buyPricePoints[_filledOrder.flippedPrice], _flipOrderId);
1177:             } else {
1178:                 _prevOrderId = OrderLinkedList.insertAtTail(s_sellPricePoints[_filledOrder.flippedPrice], _flipOrderId);
1179:             }
1180:             if (!nullify) {
1181:                 s_orders[_orderId].flippedId = _flipOrderId;
1182:             }
1183:             _addFlippedOrder(
1184:                 _filledOrder.flippedPrice,
1185:                 _filledOrder.price,
1186:                 _size,
1187:                 _filledOrder.ownerAddress,
1188:                 _flipOrderId,
1189:                 nullify ? OrderLinkedList.NULL : _orderId,
1190:                 !_filledOrder.isBuy,
1191:                 _prevOrderId
1192:             );
1193:         } else {
1194:             
1195:             uint40 _flipOrderId = s_orders[_orderId].flippedId;
1196:             if (!s_orders[_orderId].isBuy) {
1197:                 _size =
1198:                     toU96(FixedPointMathLib.mulDiv(_size, s_orders[_orderId].price, s_orders[_orderId].flippedPrice)); // <= FOUND
1199:             }
1200:             uint96 _updatedSize = s_orders[_flipOrderId].size + _size;
1201:             s_orders[_flipOrderId].size = _updatedSize;
1202:             emit FlipOrderUpdated(_flipOrderId, _updatedSize);
1203:             if (nullify) {
1204:                 s_orders[_flipOrderId].flippedId = OrderLinkedList.NULL;
1205:             }
1206:         }
1207:     }
```
['[855](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L855-L913)']
```solidity
855:     function _matchAggressiveBuyWithCap(uint256 _limitPrice, uint96 _sizeToBeFilled)
856:         internal
857:         returns (uint96, uint96)
858:     {
859:         uint96 sizeToCreditTaker;
860:         uint96 sizeToCreditViaVault;
861:         uint96 fundsConsumed;
862:         bytes memory makerCredits;
863:         (bool _isVaultFill, uint256 _bestAsk) = bestAsk();
864:         uint32 _pricePrecision = pricePrecision;
865:         _limitPrice = _limitPrice * vaultPricePrecision / _pricePrecision;
866: 
867:         while (_sizeToBeFilled > 0 && _bestAsk <= _limitPrice && _bestAsk != 0) {
868:             uint96 sizeToBeFilledBefore = _sizeToBeFilled; 
869:             bytes memory priceUpdate;
870: 
871:             if (_isVaultFill) {
872:                 uint96 _vaultFundsConsumed;
873:                 (_sizeToBeFilled, _vaultFundsConsumed, priceUpdate) =
874:                     _fillVaultForBuy(_getOBAsk() > _limitPrice ? _limitPrice + 1 : _getOBAsk(), _sizeToBeFilled);
875:                 fundsConsumed += _vaultFundsConsumed;
876:             } else {
877:                 (_sizeToBeFilled, priceUpdate) = _fillSizeForPrice(
878:                     s_sellTree,
879:                     toU32(_bestAsk * _pricePrecision / vaultPricePrecision),
880:                     s_sellPricePoints[_bestAsk * _pricePrecision / vaultPricePrecision],
881:                     _sizeToBeFilled
882:                 );
883:             }
884: 
885:             uint96 sizeFilled = sizeToBeFilledBefore - _sizeToBeFilled;
886:             sizeToCreditTaker += sizeFilled;
887:             if (_isVaultFill) {
888:                 sizeToCreditViaVault += sizeFilled;
889:             } else {
890:                 fundsConsumed += _quoteAmountRoundedUp(
891:                     toU32(FixedPointMathLib.mulDivUp(_bestAsk, _pricePrecision, vaultPricePrecision)), sizeFilled // <= FOUND
892:                 );
893:             }
894:             makerCredits = bytes.concat(makerCredits, priceUpdate);
895: 
896:             (_isVaultFill, _bestAsk) = bestAsk();
897:         }
898: 
899:         if (sizeToCreditTaker == 0) {
900:             return (_sizeToBeFilled, 0);
901:         }
902:         {
903:             uint96 _sizePrecision = sizePrecision;
904:             uint256 _baseDecimalMultiplier = baseDecimalMultiplier;
905:             uint256 _tokenCredit = (sizeToCreditTaker * _baseDecimalMultiplier) / _sizePrecision;
906:             if (sizeToCreditViaVault > 0) {
907:                 marginAccount.debitUser(
908:                     kuruAmmVault, baseAsset, (sizeToCreditViaVault * _baseDecimalMultiplier) / _sizePrecision
909:                 );
910:             }
911:             uint256 _takerFeeBps = takerFeeBps;
912:             if (_takerFeeBps > 0) {
913:                 uint256 _feeDebit = FixedPointMathLib.mulDivUp(_tokenCredit, _takerFeeBps, BPS_MULTIPLIER); // <= FOUND
914:                 _tokenCredit -= _feeDebit;
915:                 
916:                 baseFeeCollected += ((_feeDebit * (_takerFeeBps - makerFeeBps)) / _takerFeeBps);
917:             }
918:             marginAccount.creditUsersEncoded(
919:                 bytes.concat(makerCredits, abi.encode(_msgSender(), baseAsset, _tokenCredit, true))
920:             );
921:         }
922: 
923:         return (_sizeToBeFilled, fundsConsumed);
924:     }
```
['[74](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L74-L100)']
```solidity
74:     function deployProxy(
75:         IOrderBook.OrderBookType _type,
76:         address _baseAssetAddress,
77:         address _quoteAssetAddress,
78:         uint96 _sizePrecision,
79:         uint32 _pricePrecision,
80:         uint32 _tickSize,
81:         uint96 _minSize,
82:         uint96 _maxSize,
83:         uint256 _takerFeeBps,
84:         uint256 _makerFeeBps,
85:         uint96 _kuruAmmSpread
86:     ) public returns (address proxy) {
87:         if (_type == IOrderBook.OrderBookType.NATIVE_IN_BASE) {
88:             require(_baseAssetAddress == address(0), RouterErrors.MarketTypeMismatch());
89:             require(_quoteAssetAddress != address(0), RouterErrors.MarketTypeMismatch());
90:         } else if (_type == IOrderBook.OrderBookType.NATIVE_IN_QUOTE) {
91:             require(_baseAssetAddress != address(0), RouterErrors.MarketTypeMismatch());
92:             require(_quoteAssetAddress == address(0), RouterErrors.MarketTypeMismatch());
93:         } else {
94:             require(_baseAssetAddress != address(0), RouterErrors.MarketTypeMismatch());
95:             require(_quoteAssetAddress != address(0), RouterErrors.MarketTypeMismatch());
96:             require(_baseAssetAddress != _quoteAssetAddress, RouterErrors.BaseAndQuoteAssetSame());
97:         }
98:         require(_tickSize > 0, RouterErrors.InvalidTickSize());
99:         require(10 ** Math.log10(_sizePrecision) == _sizePrecision, RouterErrors.InvalidSizePrecision()); // <= FOUND
100:         require(10 ** Math.log10(_pricePrecision) == _pricePrecision, RouterErrors.InvalidPricePrecision()); // <= FOUND
101:         uint256 _baseAssetDecimals =
102:             _type == IOrderBook.OrderBookType.NATIVE_IN_BASE ? 18 : IERC20Metadata(_baseAssetAddress).decimals();
103:         uint256 _quoteAssetDecimals =
104:             _type == IOrderBook.OrderBookType.NATIVE_IN_QUOTE ? 18 : IERC20Metadata(_quoteAssetAddress).decimals();
105:         {
106:             bytes32 _salt = _getSalt(
107:                 _baseAssetAddress,
108:                 _quoteAssetAddress,
109:                 _sizePrecision,
110:                 _pricePrecision,
111:                 _tickSize,
112:                 _minSize,
113:                 _maxSize,
114:                 _takerFeeBps,
115:                 _makerFeeBps,
116:                 _kuruAmmSpread
117:             );
118:             proxy = Create2.deploy(
119:                 0,
120:                 _salt,
121:                 abi.encodePacked(type(ERC1967Proxy).creationCode, abi.encode(orderBookImplementation, bytes("")))
122:             );
123:         }
124:         IKuruAMMVault _kuruAmmVault = IKuruAMMVault(
125:             Create2.deploy(
126:                 0,
127:                 keccak256(abi.encode(proxy)),
128:                 abi.encodePacked(type(ERC1967Proxy).creationCode, abi.encode(kuruAmmVaultImplementation, bytes("")))
129:             )
130:         );
131: 
132:         verifiedMarket[proxy] = MarketParams(
133:             _pricePrecision,
134:             _sizePrecision,
135:             _baseAssetAddress,
136:             _baseAssetDecimals,
137:             _quoteAssetAddress,
138:             _quoteAssetDecimals,
139:             _tickSize,
140:             _minSize,
141:             _maxSize,
142:             _takerFeeBps,
143:             _makerFeeBps
144:         );
145:         IMarginAccount(marginAccountAddress).updateMarkets(proxy);
146:         {
147:             IOrderBook(proxy).initialize(
148:                 address(this),
149:                 _type,
150:                 _baseAssetAddress,
151:                 _baseAssetDecimals,
152:                 _quoteAssetAddress,
153:                 _quoteAssetDecimals,
154:                 marginAccountAddress,
155:                 _sizePrecision,
156:                 _pricePrecision,
157:                 _tickSize,
158:                 _minSize,
159:                 _maxSize,
160:                 _takerFeeBps,
161:                 _makerFeeBps,
162:                 address(_kuruAmmVault),
163:                 _kuruAmmSpread,
164:                 TRUSTED_FORWARDER
165:             );
166:         }
167: 
168:         _kuruAmmVault.initialize(
169:             address(this), _baseAssetAddress, _quoteAssetAddress, marginAccountAddress, proxy, _kuruAmmSpread
170:         );
171: 
172:         _setApprovalsForMarket(_baseAssetAddress, _quoteAssetAddress, proxy, _type);
173: 
174:         emit MarketRegistered(
175:             _baseAssetAddress,
176:             _quoteAssetAddress,
177:             proxy,
178:             address(_kuruAmmVault),
179:             _pricePrecision,
180:             _sizePrecision,
181:             _tickSize,
182:             _minSize,
183:             _maxSize,
184:             _takerFeeBps,
185:             _makerFeeBps,
186:             _kuruAmmSpread
187:         );
188: 
189:         return proxy;
190:     }
```
['[359](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L359-L363)']
```solidity
359:     function _addOrder(uint32 _price, uint96 _size, uint40 _orderId, bool _isBuy, uint40 _prevOrderId) internal {
360:         if (_isBuy) {
361:             TreeMath.add(s_buyTree, _price); // <= FOUND
362:         } else {
363:             TreeMath.add(s_sellTree, _price); // <= FOUND
364:         }
365:         s_orders[_orderId] =
366:             Order(_msgSender(), _size, _prevOrderId, OrderLinkedList.NULL, OrderLinkedList.NULL, _price, 0, _isBuy);
367:         if (_prevOrderId != OrderLinkedList.NULL) {
368:             s_orders[_prevOrderId].next = _orderId;
369:         }
370:         emit OrderCreated(_orderId, _msgSender(), _size, _price, _isBuy);
371:     }
```
['[384](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L384-L397)']
```solidity
384:     function _addFlipOrder(
385:         uint32 _price,
386:         uint32 _flippedPrice,
387:         uint96 _size,
388:         address _owner,
389:         uint40 _orderId,
390:         uint40 _flippedId,
391:         bool _isBuy,
392:         uint40 _prevOrderId
393:     ) internal {
394:         if (_isBuy) {
395:             TreeMath.add(s_buyTree, _price); // <= FOUND
396:         } else {
397:             TreeMath.add(s_sellTree, _price); // <= FOUND
398:         }
399:         s_orders[_orderId] =
400:             Order(_owner, _size, _prevOrderId, OrderLinkedList.NULL, _flippedId, _price, _flippedPrice, _isBuy);
401:         s_orders[_prevOrderId].next = _orderId;
402:         emit FlipOrderCreated(_orderId, _flippedId, _owner, _size, _price, _flippedPrice, _isBuy);
403:     }
```
['[416](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L416-L429)']
```solidity
416:     function _addFlippedOrder(
417:         uint32 _price,
418:         uint32 _flippedPrice,
419:         uint96 _size,
420:         address _owner,
421:         uint40 _orderId,
422:         uint40 _flippedId,
423:         bool _isBuy,
424:         uint40 _prevOrderId
425:     ) internal {
426:         if (_isBuy) {
427:             TreeMath.add(s_buyTree, _price); // <= FOUND
428:         } else {
429:             TreeMath.add(s_sellTree, _price); // <= FOUND
430:         }
431:         s_orders[_orderId] =
432:             Order(_owner, _size, _prevOrderId, OrderLinkedList.NULL, _flippedId, _price, _flippedPrice, _isBuy);
433:         s_orders[_prevOrderId].next = _orderId;
434:         emit FlippedOrderCreated(_orderId, _flippedId, _owner, _size, _price, _flippedPrice, _isBuy);
435:     }
```


</details>

## [Low-67] Common tokens such as `WETH9` work differently on chains such a `Blast` which isn't taken into account during transfer calls.

### Resolution 
There is a difference on chains such as Blast on how WETH9 is implemented. On most chains the WETH9 contract contains handling for the case where src == msg.sender, however on chains such as Blast, Arbitrum and Fantom. This isn’t the case. Failing to take this discrepancy into account can results in the protocol not functioning as intended on these chains which can have drastic results. Particularly in cases where the contract interacts with it’s own WETH allowance through transferFrom calls, in such cases these can fail if the contract fails to approve itself to use it’s WETH balance which normally isn't done as most WETH contracts do not require approval for instances where src is msg.sender. 

Num of instances: 3

### Findings 


<details><summary>Click to show findings</summary>

['[220](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L220-L226)']
```solidity
220:     function _depositAmountsToMarginAccount(address _token1, address _token2, uint256 baseDeposit, uint256 quoteDeposit) // <= FOUND
221:         internal
222:     {
223:         if (_token1 == address(0)) {
224:             marginAccount.deposit{value: baseDeposit}(address(this), _token1, baseDeposit);
225:         } else {
226:             _token1.safeTransferFrom(msg.sender, address(this), baseDeposit); // <= FOUND
227:             marginAccount.deposit(address(this), _token1, baseDeposit);
228:         }
229: 
230:         if (_token2 == address(0)) {
231:             marginAccount.deposit{value: quoteDeposit}(address(this), _token2, quoteDeposit);
232:         } else {
233:             _token2.safeTransferFrom(msg.sender, address(this), quoteDeposit);
234:             marginAccount.deposit(address(this), _token2, quoteDeposit);
235:         }
236:     }
```
['[198](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L198-L206)']
```solidity
198:     function deposit(address _user, address _token, uint256 _amount) external payable protocolActive { // <= FOUND
199:         require(_user != address(0), MarginAccountErrors.ZeroAddressNotAllowed());
200:         if (_token == NATIVE) {
201:             require(msg.value == _amount, MarginAccountErrors.NativeAssetMismatch());
202:             balances[_accountKey(_user, NATIVE)] += _amount;
203:         } else {
204:             require(msg.value == 0, MarginAccountErrors.NativeAssetMismatch());
205:             balances[_accountKey(_user, _token)] += _amount;
206:             _token.safeTransferFrom(_msgSender(), address(this), _amount); // <= FOUND
207:         }
208: 
209:         emit Deposit(_user, _token, _amount);
210:     }
```
['[331](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L331-L344)']
```solidity
331:     function anyToAnySwap( // <= FOUND
332:         address[] calldata _marketAddresses,
333:         bool[] calldata _isBuy,
334:         bool[] calldata _nativeSend,
335:         address _debitToken,
336:         address _creditToken,
337:         uint256 _amount,
338:         uint256 _minAmountOut
339:     ) external payable returns (uint256 _amountOut) {
340:         require(_marketAddresses.length >= 1, RouterErrors.NoMarketsPassed());
341:         require(_isBuy.length == _marketAddresses.length, RouterErrors.LengthMismatch());
342:         require(_nativeSend.length == _marketAddresses.length, RouterErrors.LengthMismatch());
343:         if (_nativeSend[0] == false) {
344:             _debitToken.safeTransferFrom(msg.sender, address(this), _amount); // <= FOUND
345:         }
346:         uint256 _cachedAmountIn = _amount;
347: 
348:         for (uint256 i = 0; i < _marketAddresses.length; i++) {
349:             address _currentMarket = _marketAddresses[i];
350:             MarketParams memory _marketParams = verifiedMarket[_currentMarket];
351:             require(_marketParams.pricePrecision > 0, RouterErrors.InvalidMarket());
352:             IOrderBook market = IOrderBook(_currentMarket);
353:             uint256 _value = _nativeSend[i] ? _amount : 0;
354:             _amountOut = _isBuy[i]
355:                 ? (
356:                     market.placeAndExecuteMarketBuy{value: _value}(
357:                         toU96(_amount * _marketParams.pricePrecision / 10 ** _marketParams.quoteAssetDecimals),
358:                         0,
359:                         false,
360:                         true
361:                     )
362:                 )
363:                 : market.placeAndExecuteMarketSell{value: _value}(
364:                     toU96(_amount * _marketParams.sizePrecision / 10 ** _marketParams.baseAssetDecimals), 0, false, true
365:                 );
366: 
367:             _amount = _amountOut;
368:         }
369:         require(_amountOut >= _minAmountOut, RouterErrors.SlippageExceeded());
370:         emit KuruRouterSwap(msg.sender, _debitToken, _creditToken, _cachedAmountIn, _amountOut);
371:         if (_creditToken != address(0)) {
372:             _creditToken.safeTransfer(msg.sender, _amountOut);
373:         } else {
374:             msg.sender.safeTransferETH(_amountOut);
375:         }
376:     }
```


</details>

## [Low-68] Function with `bool` return is called within another function without capturing or checking it's `bool` return value to verify success

### Resolution 
Calling a function with a `bool` return value without capturing or checking its result is a significant oversight, as it fails to verify whether the function executed successfully. Ignoring this return value can lead to logical errors, as subsequent operations may unknowingly proceed based on a failed or incomplete function execution. This is particularly risky in critical operations such as token transfers (`transfer`, `transferFrom`), where unchecked failures could lead to fund mismanagement or unintended behavior.

To address this, always capture and validate the `bool` return value with explicit checks. For example:

```solidity
require(functionCall(), "Operation failed");
```

This ensures the contract halts execution if the function fails, maintaining security and logical integrity.

Num of instances: 1

### Findings 


<details><summary>Click to show findings</summary>

['[465](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L465-L467)']
```solidity
465:     function batchCancelOrders(uint40[] calldata _orderIds) external marketNotHardPaused { // <= FOUND
466:         for (uint256 i = 0; i < _orderIds.length; i++) {
467:             _cancelOrder(_orderIds[i], true); // <= FOUND
468:         }
469: 
470:         emit OrdersCanceled(_orderIds, _msgSender());
471:     }
```


</details>

## [Low-69] Function which utilizes Solady's `SafeTransferLib` fails to first check if a token exists before making `safeTransfer`/`safeTransferFrom` calls against it

### Resolution 
SafeTransferLib as similarly named function as OpenZepelins SafeERC20 module however it's functions such as safeTransferFrom don't check if the contract exists which can result in silent failures when performing such operations. As such it is recommended to perform a contract existence check beforehand.

Num of instances: 18

### Findings 


<details><summary>Click to show findings</summary>

['[220](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L220-L233)']
```solidity
220:     function _depositAmountsToMarginAccount(address _token1, address _token2, uint256 baseDeposit, uint256 quoteDeposit)
221:         internal
222:     {
223:         if (_token1 == address(0)) {
224:             marginAccount.deposit{value: baseDeposit}(address(this), _token1, baseDeposit);
225:         } else {
226:             _token1.safeTransferFrom(msg.sender, address(this), baseDeposit); // <= FOUND
227:             marginAccount.deposit(address(this), _token1, baseDeposit);
228:         }
229: 
230:         if (_token2 == address(0)) {
231:             marginAccount.deposit{value: quoteDeposit}(address(this), _token2, quoteDeposit);
232:         } else {
233:             _token2.safeTransferFrom(msg.sender, address(this), quoteDeposit); // <= FOUND
234:             marginAccount.deposit(address(this), _token2, quoteDeposit);
235:         }
236:     }
```
['[198](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L198-L206)']
```solidity
198:     function deposit(address _user, address _token, uint256 _amount) external payable protocolActive {
199:         require(_user != address(0), MarginAccountErrors.ZeroAddressNotAllowed());
200:         if (_token == NATIVE) {
201:             require(msg.value == _amount, MarginAccountErrors.NativeAssetMismatch());
202:             balances[_accountKey(_user, NATIVE)] += _amount;
203:         } else {
204:             require(msg.value == 0, MarginAccountErrors.NativeAssetMismatch());
205:             balances[_accountKey(_user, _token)] += _amount;
206:             _token.safeTransferFrom(_msgSender(), address(this), _amount); // <= FOUND
207:         }
208: 
209:         emit Deposit(_user, _token, _amount);
210:     }
```
['[175](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L175-L214)']
```solidity
175:     function _mintAndDeposit(uint256 baseDeposit, uint256 quoteDeposit, address receiver) internal returns (uint256) {
176:         (uint256 _baseAmount, uint256 _currentAskPrice) = _returnNormalizedAmountAndPrice(true);
177:         uint256 _shares;
178:         if (totalSupply() != 0) {
179:             uint256 _expectedQuoteAmount = (
180:                 (
181:                     FixedPointMathLib.mulDivUp(baseDeposit, _currentAskPrice, vaultPricePrecision)
182:                         * 10 ** marketParams.quoteAssetDecimals
183:                 )
184:             ) / 10 ** marketParams.baseAssetDecimals;
185:             require(_expectedQuoteAmount <= quoteDeposit, KuruAMMVaultErrors.InsufficientQuoteToken());
186:             _shares = _convertToShares(baseDeposit, _expectedQuoteAmount, _currentAskPrice);
187:             quoteDeposit = _expectedQuoteAmount;
188:             _mint(receiver, _shares);
189:         } else {
190:             _shares = FixedPointMathLib.sqrt(baseDeposit * quoteDeposit);
191:             _mint(address(marginAccount), MIN_LIQUIDITY);
192:             _shares -= MIN_LIQUIDITY;
193:             _mint(receiver, _shares);
194:             _currentAskPrice = (
195:                 ((quoteDeposit * 10 ** marketParams.baseAssetDecimals)) * vaultPricePrecision
196:                     / 10 ** marketParams.quoteAssetDecimals
197:             ) / (baseDeposit);
198:         }
199:         require(_shares > 0, KuruAMMVaultErrors.InsufficientLiquidityMinted());
200:         (uint96 _newAskSize, uint96 _newBidSize) = _getVaultSizesForBaseAmount(_baseAmount + baseDeposit);
201:         market.updateVaultOrdSz(
202:             _newAskSize,
203:             _newBidSize,
204:             _currentAskPrice,
205:             FixedPointMathLib.mulDivRound(_currentAskPrice, BPS_MULTIPLIER, BPS_MULTIPLIER + SPREAD_CONSTANT),
206:             false
207:         );
208:         address _token1 = token1;
209:         address _token2 = token2;
210:         _depositAmountsToMarginAccount(_token1, _token2, baseDeposit, quoteDeposit);
211:         uint256 _nativeRefund =
212:             _token1 == address(0) ? (msg.value - baseDeposit) : (_token2 == address(0) ? (msg.value - quoteDeposit) : 0);
213:         if (_nativeRefund > 0) {
214:             msg.sender.safeTransferETH(_nativeRefund); // <= FOUND
215:         }
216:         emit KuruVaultDeposit(baseDeposit, quoteDeposit, _shares, receiver);
217:         return _shares;
218:     }
```
['[294](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L294-L296)']
```solidity
294:     function _transferTokensToUser(uint256 amount, address token, address receiver) internal {
295:         if (token == address(0)) {
296:             receiver.safeTransferETH(amount); // <= FOUND
297:         } else {
298:             token.safeTransfer(receiver, amount);
299:         }
300:     }
```
['[118](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L118-L127)']
```solidity
118:     function creditUser(address _user, address _token, uint256 _amount, bool _useMargin) external protocolActive {
119:         require(verifiedMarket[msg.sender], MarginAccountErrors.OnlyVerifiedMarketsAllowed());
120: 
121:         if (_useMargin) {
122:             balances[_accountKey(_user, _token)] += _amount;
123:         } else {
124:             if (_token != NATIVE) {
125:                 _token.safeTransfer(_user, _amount);
126:             } else {
127:                 _user.safeTransferETH(_amount); // <= FOUND
128:             }
129:         }
130:     }
```
['[136](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L136-L151)']
```solidity
136:     function creditUsersEncoded(bytes calldata _encodedData) external protocolActive {
137:         require(verifiedMarket[msg.sender], MarginAccountErrors.OnlyVerifiedMarketsAllowed());
138: 
139:         uint256 offset = 0;
140:         while (offset < _encodedData.length) {
141:             (address _user, address _token, uint256 _amount, bool _useMargin) =
142:                 abi.decode(_encodedData[offset:offset + 128], (address, address, uint256, bool));
143:             offset += 128;
144: 
145:             if (_useMargin) {
146:                 balances[_accountKey(_user, _token)] += _amount;
147:             } else {
148:                 if (_token != NATIVE) {
149:                     _token.safeTransfer(_user, _amount);
150:                 } else {
151:                     _user.safeTransferETH(_amount); // <= FOUND
152:                 }
153:             }
154:         }
155:     }
```
['[177](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L177-L184)']
```solidity
177:     function batchWithdrawMaxTokens(address[] calldata _tokens) external protocolActive {
178:         uint256 _balance;
179:         for (uint256 i = 0; i < _tokens.length; i++) {
180:             _balance = balances[_accountKey(_msgSender(), _tokens[i])];
181:             balances[_accountKey(_msgSender(), _tokens[i])] = 0;
182:             if (_balance > 0) {
183:                 if (_tokens[i] == NATIVE) {
184:                     _msgSender().safeTransferETH(_balance); // <= FOUND
185:                 } else {
186:                     _tokens[i].safeTransfer(_msgSender(), _balance);
187:                 }
188:             }
189:         }
190:     }
```
['[217](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L217-L221)']
```solidity
217:     function withdraw(uint256 _amount, address _token) external protocolActive {
218:         require(_amount <= balances[_accountKey(_msgSender(), _token)], MarginAccountErrors.InsufficientBalance());
219:         balances[_accountKey(_msgSender(), _token)] -= _amount;
220:         if (_token == NATIVE) {
221:             _msgSender().safeTransferETH(_amount); // <= FOUND
222:         } else {
223:             _token.safeTransfer(_msgSender(), _amount);
224:         }
225: 
226:         emit Withdrawal(_msgSender(), _token, _amount);
227:     }
```
['[728](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L728-L749)']
```solidity
728:     function placeAndExecuteMarketBuy(uint96 _quoteSize, uint256 _minAmountOut, bool _isMargin, bool _isFillOrKill)
729:         public
730:         payable
731:         override
732:         marketActive
733:         nonReentrant
734:         returns (uint256)
735:     {
736:         OrderBookType _type = orderBookType;
737: 
738:         if (_type == OrderBookType.NATIVE_IN_QUOTE && !_isMargin && (msg.sender != address(0))) {
739:             require(
740:                 msg.value >= _pricePrecisionToQuoteAssetPrecision(_quoteSize), OrderBookErrors.NativeAssetInsufficient()
741:             );
742:             require(
743:                 msg.value < _pricePrecisionToQuoteAssetPrecision(_quoteSize + 1), OrderBookErrors.NativeAssetSurplus()
744:             );
745:         } else if (msg.sender != address(0)) {
746:             require(msg.value == 0, OrderBookErrors.NativeAssetNotRequired());
747:             _isMargin
748:                 ? marginAccount.debitUser(_msgSender(), quoteAsset, _pricePrecisionToQuoteAssetPrecision(_quoteSize))
749:                 : quoteAsset.safeTransferFrom( // <= FOUND
750:                     _msgSender(), address(marginAccount), _pricePrecisionToQuoteAssetPrecision(_quoteSize)
751:                 );
752:         }
753: 
754:         uint256 _baseTokensCredited;
755:         (_quoteSize, _baseTokensCredited) = _marketBuyMatch(_quoteSize, _isMargin);
756:         if (msg.sender == address(0)) {
757:             return _baseTokensCredited;
758:         }
759:         if (_quoteSize > 0) {
760:             require(!_isFillOrKill, OrderBookErrors.InsufficientLiquidity());
761:             if (_type == OrderBookType.NATIVE_IN_QUOTE && !_isMargin) {
762:                 
763:                 uint256 _refund = _pricePrecisionToQuoteAssetPrecision(_quoteSize);
764:                 _handleNativeMarketRefundTransfer(_refund);
765:             } else {
766:                 marginAccount.creditUser(
767:                     _msgSender(), quoteAsset, _pricePrecisionToQuoteAssetPrecision(_quoteSize), _isMargin
768:                 );
769:             }
770:         } else if (_type == OrderBookType.NATIVE_IN_QUOTE) {
771:             address(marginAccount).safeTransferETH(msg.value); // <= FOUND
772:         }
773:         require(_baseTokensCredited >= _minAmountOut, OrderBookErrors.SlippageExceeded());
774: 
775:         return _baseTokensCredited;
776:     }
```
['[786](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L786-L801)']
```solidity
786:     function placeAndExecuteMarketSell(uint96 _size, uint256 _minAmountOut, bool _isMargin, bool _isFillOrKill)
787:         public
788:         payable
789:         marketActive
790:         nonReentrant
791:         returns (uint256)
792:     {
793:         OrderBookType _type = orderBookType;
794:         if (_type == OrderBookType.NATIVE_IN_BASE && !_isMargin && (msg.sender != address(0))) {
795:             require(msg.value >= _sizePrecisionToBaseAssetPrecision(_size), OrderBookErrors.NativeAssetInsufficient());
796:             require(msg.value < _sizePrecisionToBaseAssetPrecision(_size + 1), OrderBookErrors.NativeAssetSurplus());
797:         } else if (msg.sender != address(0)) {
798:             require(msg.value == 0, OrderBookErrors.NativeAssetNotRequired());
799:             _isMargin
800:                 ? marginAccount.debitUser(_msgSender(), baseAsset, _sizePrecisionToBaseAssetPrecision(_size))
801:                 : baseAsset.safeTransferFrom( // <= FOUND
802:                     _msgSender(), address(marginAccount), _sizePrecisionToBaseAssetPrecision(_size)
803:                 );
804:         }
805: 
806:         uint256 _quoteCredited;
807:         (_size, _quoteCredited) = _matchAggressiveSell(0, _size, _isMargin);
808:         if (msg.sender == address(0)) {
809:             return _quoteCredited;
810:         }
811:         if (_size > 0) {
812:             require(!_isFillOrKill, OrderBookErrors.InsufficientLiquidity());
813:             if (_type == OrderBookType.NATIVE_IN_BASE && !_isMargin) {
814:                 uint256 _refund = _sizePrecisionToBaseAssetPrecision(_size);
815:                 _handleNativeMarketRefundTransfer(_refund);
816:             } else {
817:                 marginAccount.creditUser(_msgSender(), baseAsset, _sizePrecisionToBaseAssetPrecision(_size), _isMargin);
818:             }
819:         } else if (_type == OrderBookType.NATIVE_IN_BASE) {
820:             address(marginAccount).safeTransferETH(msg.value); // <= FOUND
821:         }
822:         require(_quoteCredited >= _minAmountOut, OrderBookErrors.SlippageExceeded());
823:         return _quoteCredited;
824:     }
```
['[830](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L830-L832)']
```solidity
830:     function _handleNativeMarketRefundTransfer(uint256 _refund) internal {
831:         address(marginAccount).safeTransferETH(msg.value - _refund); // <= FOUND
832:         _msgSender().safeTransferETH(_refund); // <= FOUND
833:     }
```
['[331](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L331-L344)']
```solidity
331:     function anyToAnySwap(
332:         address[] calldata _marketAddresses,
333:         bool[] calldata _isBuy,
334:         bool[] calldata _nativeSend,
335:         address _debitToken,
336:         address _creditToken,
337:         uint256 _amount,
338:         uint256 _minAmountOut
339:     ) external payable returns (uint256 _amountOut) {
340:         require(_marketAddresses.length >= 1, RouterErrors.NoMarketsPassed());
341:         require(_isBuy.length == _marketAddresses.length, RouterErrors.LengthMismatch());
342:         require(_nativeSend.length == _marketAddresses.length, RouterErrors.LengthMismatch());
343:         if (_nativeSend[0] == false) {
344:             _debitToken.safeTransferFrom(msg.sender, address(this), _amount); // <= FOUND
345:         }
346:         uint256 _cachedAmountIn = _amount;
347: 
348:         for (uint256 i = 0; i < _marketAddresses.length; i++) {
349:             address _currentMarket = _marketAddresses[i];
350:             MarketParams memory _marketParams = verifiedMarket[_currentMarket];
351:             require(_marketParams.pricePrecision > 0, RouterErrors.InvalidMarket());
352:             IOrderBook market = IOrderBook(_currentMarket);
353:             uint256 _value = _nativeSend[i] ? _amount : 0;
354:             _amountOut = _isBuy[i]
355:                 ? (
356:                     market.placeAndExecuteMarketBuy{value: _value}(
357:                         toU96(_amount * _marketParams.pricePrecision / 10 ** _marketParams.quoteAssetDecimals),
358:                         0,
359:                         false,
360:                         true
361:                     )
362:                 )
363:                 : market.placeAndExecuteMarketSell{value: _value}(
364:                     toU96(_amount * _marketParams.sizePrecision / 10 ** _marketParams.baseAssetDecimals), 0, false, true
365:                 );
366: 
367:             _amount = _amountOut;
368:         }
369:         require(_amountOut >= _minAmountOut, RouterErrors.SlippageExceeded());
370:         emit KuruRouterSwap(msg.sender, _debitToken, _creditToken, _cachedAmountIn, _amountOut);
371:         if (_creditToken != address(0)) {
372:             _creditToken.safeTransfer(msg.sender, _amountOut);
373:         } else {
374:             msg.sender.safeTransferETH(_amountOut); // <= FOUND
375:         }
376:     }
```
['[220](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L220-L233)']
```solidity
220:     function _depositAmountsToMarginAccount(address _token1, address _token2, uint256 baseDeposit, uint256 quoteDeposit)
221:         internal
222:     {
223:         if (_token1 == address(0)) {
224:             marginAccount.deposit{value: baseDeposit}(address(this), _token1, baseDeposit);
225:         } else {
226:             _token1.safeTransferFrom(msg.sender, address(this), baseDeposit); // <= FOUND
227:             marginAccount.deposit(address(this), _token1, baseDeposit);
228:         }
229: 
230:         if (_token2 == address(0)) {
231:             marginAccount.deposit{value: quoteDeposit}(address(this), _token2, quoteDeposit);
232:         } else {
233:             _token2.safeTransferFrom(msg.sender, address(this), quoteDeposit); // <= FOUND
234:             marginAccount.deposit(address(this), _token2, quoteDeposit);
235:         }
236:     }
```
['[198](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L198-L206)']
```solidity
198:     function deposit(address _user, address _token, uint256 _amount) external payable protocolActive {
199:         require(_user != address(0), MarginAccountErrors.ZeroAddressNotAllowed());
200:         if (_token == NATIVE) {
201:             require(msg.value == _amount, MarginAccountErrors.NativeAssetMismatch());
202:             balances[_accountKey(_user, NATIVE)] += _amount;
203:         } else {
204:             require(msg.value == 0, MarginAccountErrors.NativeAssetMismatch());
205:             balances[_accountKey(_user, _token)] += _amount;
206:             _token.safeTransferFrom(_msgSender(), address(this), _amount); // <= FOUND
207:         }
208: 
209:         emit Deposit(_user, _token, _amount);
210:     }
```
['[45](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L45-L66)']
```solidity
45:     function initialize(
46:         address _owner,
47:         address token1_,
48:         address token2_,
49:         address _marginAccount,
50:         address _market,
51:         uint96 _spreadConstant
52:     ) public initializer {
53:         owner = _owner;
54:         token1 = token1_;
55:         token1Decimals = token1_ != address(0) ? ERC20(token1_).decimals() : 18;
56:         token2 = token2_;
57:         token2Decimals = token2_ != address(0) ? ERC20(token2_).decimals() : 18;
58:         marginAccount = IMarginAccount(_marginAccount);
59:         market = IOrderBook(_market);
60:         SPREAD_CONSTANT = _spreadConstant;
61:         setMarketParams();
62:         if (token1_ != address(0)) {
63:             token1_.safeApprove(_marginAccount, type(uint256).max); // <= FOUND
64:         }
65:         if (token2_ != address(0)) {
66:             token2_.safeApprove(_marginAccount, type(uint256).max); // <= FOUND
67:         }
68:         string memory token1Symbol;
69:         string memory token2Symbol;
70:         if (token1_ != address(0)) {
71:             token1Symbol = ERC20(token1_).symbol();
72:         } else {
73:             token1Symbol = "MON";
74:         }
75:         if (token2_ != address(0)) {
76:             token2Symbol = ERC20(token2_).symbol();
77:         } else {
78:             token2Symbol = "MON";
79:         }
80:         _name = string.concat(token1Symbol, "-", token2Symbol, "-", "KURU-AMM-VAULT");
81:     }
```
['[304](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L304-L316)']
```solidity
304:     function _setApprovalsForMarket(
305:         address _baseAsset,
306:         address _quoteAsset,
307:         address _marketAddress,
308:         IOrderBook.OrderBookType _type
309:     ) internal {
310:         if (_type == IOrderBook.OrderBookType.NATIVE_IN_BASE) {
311:             _quoteAsset.safeApprove(_marketAddress, type(uint256).max); // <= FOUND
312:         } else if (_type == IOrderBook.OrderBookType.NATIVE_IN_QUOTE) {
313:             _baseAsset.safeApprove(_marketAddress, type(uint256).max); // <= FOUND
314:         } else {
315:             _baseAsset.safeApprove(_marketAddress, type(uint256).max); // <= FOUND
316:             _quoteAsset.safeApprove(_marketAddress, type(uint256).max); // <= FOUND
317:         }
318:     }
```
['[241](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L241-L246)']
```solidity
241:     function withdraw(uint256 _shares, address _receiver, address _owner)
242:         public
243:         nonReentrant
244:         returns (uint256, uint256)
245:     {
246:         require(_shares <= balanceOf(_owner), KuruAMMVaultErrors.InsufficientBalance()); // <= FOUND
247: 
248:         if (msg.sender != _owner) {
249:             _spendAllowance(_owner, msg.sender, _shares);
250:         }
251: 
252:         return _burnAndWithdraw(_shares, _receiver, _owner);
253:     }
```
['[5](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L5-L5)']
```solidity
5: import {SafeTransferLib} from "solady/src/utils/SafeTransferLib.sol"; // <= FOUND
```


</details>

## [Low-70] Deposit mechanism can be DOS'd with dust deposits due to lack of minAmount checks against deposit amount

### Resolution 
A contract's deposit mechanism can be vulnerable to a Denial-of-Service (DoS) attack if malicious users spam it with "dust deposits" (very small amounts of tokens or ETH). This attack exploits the fact that deposit mechanisms often update internal accounting, emit events, or execute additional logic for every deposit. By making numerous small deposits, a malicious actor can congest the contract, cause storage bloat, or inflate gas costs, making it prohibitively expensive or inefficient for legitimate users to interact with the contract.
For example, if a contract tracks user balances in a mapping, each tiny deposit might unnecessarily create or update entries. This attack could flood on-chain logs with events, increasing monitoring difficulties for off-chain systems. It could also fragment balances, leading to operational inefficiencies and rounding issues during future withdrawals.
To prevent this, introducing a minimum deposit threshold is common, such as:
require(amount >= MIN_DEPOSIT, "Deposit amount too small");
However, this safeguard can unintentionally prevent legitimate deposits if a user’s intended deposit is below the threshold. For instance, smaller investors or users testing the contract with small amounts may find themselves excluded.
To address this, implement reasonable thresholds while considering user accessibility. Additionally, periodic aggregation or batching mechanisms can mitigate spam without deterring legitimate participation, balancing security with inclusivity.

Num of instances: 2

### Findings 


<details><summary>Click to show findings</summary>

['[156](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L156-L156)']
```solidity
156:     function deposit(uint256 baseDeposit, uint256 quoteDeposit, address receiver) // <= FOUND
157:         public
158:         payable
159:         nonReentrant
160:         returns (uint256)
161:     {
162:         require(
163:             (token1 == address(0) || token2 == address(0))
164:                 ? msg.value >= (token1 == address(0) ? baseDeposit : quoteDeposit)
165:                 : msg.value == 0,
166:             KuruAMMVaultErrors.NativeAssetMismatch()
167:         );
168: 
169:         return _mintAndDeposit(baseDeposit, quoteDeposit, receiver);
170:     }
```
['[198](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L198-L198)']
```solidity
198:     function deposit(address _user, address _token, uint256 _amount) external payable protocolActive { // <= FOUND
199:         require(_user != address(0), MarginAccountErrors.ZeroAddressNotAllowed());
200:         if (_token == NATIVE) {
201:             require(msg.value == _amount, MarginAccountErrors.NativeAssetMismatch());
202:             balances[_accountKey(_user, NATIVE)] += _amount;
203:         } else {
204:             require(msg.value == 0, MarginAccountErrors.NativeAssetMismatch());
205:             balances[_accountKey(_user, _token)] += _amount;
206:             _token.safeTransferFrom(_msgSender(), address(this), _amount);
207:         }
208: 
209:         emit Deposit(_user, _token, _amount);
210:     }
```


</details>

## [NonCritical-1] Subtraction may underflow if multiplication is too large 

### Resolution 
In arithmetic operations involving subtraction and multiplication, an underflow may occur if a subtraction result is negative, or if a multiplication result exceeds the maximum value representable in the data type. For instance, if a large multiplication precedes a subtraction, it may create a value too large to subtract from, causing an underflow. This could lead to unexpected and incorrect results in the calculation.

Num of instances: 2

### Findings 


<details><summary>Click to show findings</summary>

['[376](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L376-L406)']
```solidity
376:     function _convertToAssetsWithNewSize(uint256 shares) // <= FOUND
377:         internal
378:         view
379:         returns (uint256, uint256, uint96, uint96, bool)
380:     {
381:         (uint256 _baseAmount,) = _returnNormalizedAmountAndPrice(false);
382:         uint256 _baseAmountAfterRemoval = _baseAmount - FixedPointMathLib.mulDiv(shares, _baseAmount, totalSupply());
383:         (uint96 _newAskSize, uint96 _newBidSize) = _getVaultSizesForBaseAmount(_baseAmountAfterRemoval);
384:         (
385:             ,
386:             uint256 _vaultBestBid,
387:             uint96 _partiallyFilledBidSize,
388:             uint256 _vaultBestAsk,
389:             uint96 _partiallyFilledAskSize,
390:             ,
391:             ,
392:         ) = market.getVaultParams();
393:         MarketParams memory _marketParams = marketParams;
394:         (uint256 _reserveBase, uint256 _reserveQuote) = totalAssets();
395:         if (_partiallyFilledAskSize > _newAskSize || _partiallyFilledBidSize > _newBidSize) {
396:             int256 _baseOwedToVault = (
397:                 int256(uint256(_partiallyFilledAskSize)) - int256(uint256(_partiallyFilledBidSize))
398:             ) * int256(10 ** _marketParams.baseAssetDecimals) / int256(uint256(_marketParams.sizePrecision));
399:             int256 _quoteOwedToVault = (
400:                 int256(FixedPointMathLib.mulDivUp(_partiallyFilledBidSize, _vaultBestBid, _marketParams.sizePrecision))
401:                     - int256(FixedPointMathLib.mulDiv(_partiallyFilledAskSize, _vaultBestAsk, _marketParams.sizePrecision))
402:             ) * int256(10 ** _marketParams.quoteAssetDecimals) / int256(vaultPricePrecision);
403:             uint256 _baseOwedToUser;
404:             uint256 _quoteOwedToUser;
405:             if (_baseOwedToVault < 0) {
406:                 _reserveBase = _reserveBase - (uint256(-1 * _baseOwedToVault)); // <= FOUND
407:                 _baseOwedToUser =
408:                     FixedPointMathLib.mulDiv(shares, _reserveBase, totalSupply()) + uint256(-1 * _baseOwedToVault);
409:             } else {
410:                 _reserveBase = _reserveBase + (uint256(_baseOwedToVault));
411:                 _baseOwedToUser =
412:                     FixedPointMathLib.mulDiv(shares, _reserveBase, totalSupply()) - uint256(_baseOwedToVault);
413:             }
414:             if (_quoteOwedToVault < 0) {
415:                 _reserveQuote = _reserveQuote - (uint256(-1 * _quoteOwedToVault));
416:                 _quoteOwedToUser =
417:                     FixedPointMathLib.mulDiv(shares, _reserveQuote, totalSupply()) + uint256(-1 * _quoteOwedToVault);
418:             } else {
419:                 _reserveQuote = _reserveQuote + (uint256(_quoteOwedToVault));
420:                 _quoteOwedToUser =
421:                     FixedPointMathLib.mulDiv(shares, _reserveQuote, totalSupply()) - uint256(_quoteOwedToVault);
422:             }
423:             return (_baseOwedToUser, _quoteOwedToUser, _newAskSize, _newBidSize, true);
424:         } else {
425:             uint256 _baseOwedToUser = FixedPointMathLib.mulDiv(shares, _reserveBase, totalSupply());
426:             uint256 _quoteOwedToUser = FixedPointMathLib.mulDiv(shares, _reserveQuote, totalSupply());
427:             return (_baseOwedToUser, _quoteOwedToUser, _newAskSize, _newBidSize, false);
428:         }
429:     }
```
['[202](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L202-L227)']
```solidity
202:     function expWad(int256 x) internal pure returns (int256 r) { // <= FOUND
203:         unchecked {
204:             
205:             
206:             if (x <= -41446531673892822313) return r;
207: 
208:             
209:             assembly {
210:                 
211:                 
212:                 if iszero(slt(x, 135305999368893231589)) {
213:                     mstore(0x00, 0xa37bfec9) 
214:                     revert(0x1c, 0x04)
215:                 }
216:             }
217: 
218:             
219:             
220:             
221:             x = (x << 78) / 5 ** 18;
222: 
223:             
224:             
225:             
226:             int256 k = ((x << 96) / 54916777467707473351141471128 + 2 ** 95) >> 96;
227:             x = x - k * 54916777467707473351141471128; // <= FOUND
228: 
229:             
230: 
231:             
232:             
233:             int256 y = x + 1346386616545796478920950773328;
234:             y = ((y * x) >> 96) + 57155421227552351082224309758442;
235:             int256 p = y + x - 94201549194550492254356042504812;
236:             p = ((p * y) >> 96) + 28719021644029726153956944680412240;
237:             p = p * x + (4385272521454847904659076985693276 << 96);
238: 
239:             
240:             int256 q = x - 2855989394907223263936484059900;
241:             q = ((q * x) >> 96) + 50020603652535783019961831881945;
242:             q = ((q * x) >> 96) - 533845033583426703283633433725380;
243:             q = ((q * x) >> 96) + 3604857256930695427073651918091429;
244:             q = ((q * x) >> 96) - 14423608567350463180887372962807573;
245:             q = ((q * x) >> 96) + 26449188498355588339934803723976023;
246: 
247:             
248:             assembly {
249:                 
250:                 
251:                 
252:                 r := sdiv(p, q)
253:             }
254: 
255:             
256: 
257:             
258:             
259:             
260:             
261:             
262:             
263:             r = int256((uint256(r) * 3822833074963236453042738258902158003155416615667) >> uint256(195 - k));
264:         }
265:     }
```


</details>

## [NonCritical-2] Using abi.encodePacked can result in hash collision when used in hashing functions 

### Resolution 
Consider using abi.encode as this pads data to 32 byte segments

Num of instances: 7

### Findings 


<details><summary>Click to show findings</summary>

['[173](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruForwarder.sol#L173-L173)']
```solidity
173:         require(
174:             !executedPriceDependentRequest[keccak256(abi.encodePacked(req.from, req.nonce))],
175:             KuruForwarderErrors.NonceAlreadyUsed()
176:         );
```
['[265](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruForwarder.sol#L265-L265)']
```solidity
265:         executedPriceDependentRequest[keccak256(abi.encodePacked(req.from, req.nonce))] = true;
```
['[244](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L244-L244)']
```solidity
244:         return keccak256(abi.encodePacked(_user, _token));
```
['[124](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L124-L124)']
```solidity
124:         IKuruAMMVault _kuruAmmVault = IKuruAMMVault(
125:             Create2.deploy(
126:                 0,
127:                 keccak256(abi.encode(proxy)),
128:                 abi.encodePacked(type(ERC1967Proxy).creationCode, abi.encode(kuruAmmVaultImplementation, bytes("")))
129:             )
130:         );
```
['[218](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L218-L218)']
```solidity
218:         proxy = Create2.computeAddress(
219:             _salt,
220:             keccak256(
221:                 abi.encodePacked(
222:                     type(ERC1967Proxy).creationCode,
223:                     abi.encode(old ? oldImplementation : orderBookImplementation, bytes(""))
224:                 )
225:             )
226:         );
```
['[235](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L235-L235)']
```solidity
235:         return Create2.computeAddress(
236:             _salt,
237:             keccak256(
238:                 abi.encodePacked(
239:                     type(ERC1967Proxy).creationCode,
240:                     abi.encode(old ? oldImplementation : kuruAmmVaultImplementation, bytes(""))
241:                 )
242:             )
243:         );
```
['[404](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L404-L404)']
```solidity
404:         return keccak256(
405:             abi.encodePacked(
406:                 _baseAssetAddress,
407:                 _quoteAssetAddress,
408:                 _sizePrecision,
409:                 _pricePrecision,
410:                 _tickSize,
411:                 _minSize,
412:                 _maxSize,
413:                 _takerFeeBps,
414:                 _makerFeeBps,
415:                 _kuruAmmSpread
416:             )
417:         );
```


</details>

## [NonCritical-3] Unchecked blocks with subtractions may underflow 

### Resolution 
Within unchecked blocks in Solidity, arithmetic operations bypass overflow and underflow checks. When subtractions occur without proper bounds validation, they may underflow. An underflow in an unsigned integer subtraction can wrap the value around to its maximum, leading to unintended contract behavior or potential vulnerabilities. To prevent such scenarios, developers should either avoid unchecked blocks for subtraction operations or manually implement checks to ensure operands' validity before subtraction. 

Num of instances: 2

### Findings 


<details><summary>Click to show findings</summary>

['[1088](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L1088-L1088)']
```solidity
1088:        unchecked {
1089:             z = x - y;
1090:         }
```
['[261](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/TreeMath.sol#L261-L261)']
```solidity
261:        unchecked {
262:             return uint256(leaves).closestBitRight(bit - 1);
263:         }
```


</details>

## [NonCritical-4] Getting a bool return value does not confirm the existence of a function in an external call 

### Resolution 
External calls to contracts using `address.call()` might return a boolean indicating success or failure. However, this boolean doesn't guarantee the existence of a called function. If a function isn't present, the call won't revert but will simply return `false`. This behavior might lead developers into mistakenly believing they're interacting with a legitimate or expected function, whereas it might not exist at all—a scenario sometimes termed as "phantom functions". Resolution: Instead of solely relying on the boolean, further validate the contract you're interacting with, or use interfaces or abstract contracts to enforce the existence of expected functions.

Num of instances: 3

### Findings 


<details><summary>Click to show findings</summary>

['[219](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruForwarder.sol#L219-L230)']
```solidity
219:     function executeMarginAccountRequest(MarginAccountRequest calldata req, bytes calldata signature) // <= FOUND
220:         public
221:         payable
222:         returns (bytes memory)
223:     {
224:         require(verifyMarginAccountRequest(req, signature), KuruForwarderErrors.SignatureMismatch());
225:         require(msg.value >= req.value, KuruForwarderErrors.InsufficientValue());
226:         require(allowedInterface[req.selector], KuruForwarderErrors.InterfaceNotAllowed());
227: 
228:         _nonces[req.from] = req.nonce + 1;
229: 
230:         (bool success, bytes memory returndata) = // <= FOUND
231:             req.marginAccount.call{value: req.value}(abi.encodePacked(req.selector, req.data, req.from));
232: 
233:         if (!success) {
234:             revert ExecutionFailed(returndata);
235:         }
236: 
237:         return returndata;
238:     }
```
['[240](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruForwarder.sol#L240-L247)']
```solidity
240:     function execute(ForwardRequest calldata req, bytes calldata signature) public payable returns (bytes memory) { // <= FOUND
241:         require(verify(req, signature), KuruForwarderErrors.SignatureMismatch());
242:         require(msg.value >= req.value, KuruForwarderErrors.InsufficientValue());
243:         require(allowedInterface[req.selector], KuruForwarderErrors.InterfaceNotAllowed());
244: 
245:         _nonces[req.from] = req.nonce + 1;
246: 
247:         (bool success, bytes memory returndata) = // <= FOUND
248:             req.market.call{value: req.value}(abi.encodePacked(req.selector, req.data, req.from));
249: 
250:         if (!success) {
251:             revert ExecutionFailed(returndata);
252:         }
253: 
254:         return returndata;
255:     }
```
['[257](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruForwarder.sol#L257-L272)']
```solidity
257:     function executePriceDependent(PriceDependentRequest calldata req, bytes calldata signature) // <= FOUND
258:         public
259:         payable
260:         returns (bytes memory)
261:     {
262:         require(verifyPriceDependent(req, signature), KuruForwarderErrors.SignatureMismatch());
263:         require(msg.value >= req.value, KuruForwarderErrors.InsufficientValue());
264:         require(allowedInterface[req.selector], KuruForwarderErrors.InterfaceNotAllowed());
265:         executedPriceDependentRequest[keccak256(abi.encodePacked(req.from, req.nonce))] = true;
266: 
267:         (uint256 _currentBidPrice,) = IOrderBook(req.market).bestBidAsk();
268:         require(
269:             (req.isBelowPrice && req.price < _currentBidPrice) || (!req.isBelowPrice && req.price > _currentBidPrice),
270:             PriceDependentRequestFailed(_currentBidPrice, req.price)
271:         );
272:         (bool success, bytes memory returndata) = // <= FOUND
273:             req.market.call{value: req.value}(abi.encodePacked(req.selector, req.data, req.from));
274: 
275:         if (!success) {
276:             revert ExecutionFailed(returndata);
277:         }
278: 
279:         return returndata;
280:     }
```


</details>

## [NonCritical-5] Address function parameter is compared against a state variable. This check can be bypassed for tokens with multiple addresses (proxy tokens)

### Resolution 
Comparing an address function parameter directly against a state variable can be problematic, especially for proxy tokens or tokens with multiple addresses. Proxy tokens often use a fixed proxy address with a separate implementation contract address. If a function relies solely on comparing the caller's address with a state variable, it might fail to recognize legitimate calls from a token's proxy address. This oversight can lead to bypassing security checks, as the actual implementation logic resides elsewhere. To address this, consider verifying against the token's intended logic, such as using a designated interface or an authorized registry, ensuring all valid instances are accounted for.

Num of instances: 4

### Findings 


<details><summary>Click to show findings</summary>

['[118](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L118-L124)']
```solidity
118:     function creditUser(address _user, address _token, uint256 _amount, bool _useMargin) external protocolActive { // <= FOUND
119:         require(verifiedMarket[msg.sender], MarginAccountErrors.OnlyVerifiedMarketsAllowed());
120: 
121:         if (_useMargin) {
122:             balances[_accountKey(_user, _token)] += _amount;
123:         } else {
124:             if (_token != NATIVE) { // <= FOUND
125:                 _token.safeTransfer(_user, _amount);
126:             } else {
127:                 _user.safeTransferETH(_amount);
128:             }
129:         }
130:     }
```
['[250](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L250-L251)']
```solidity
250:     function upgradeOrderBookImplementation(address newImplementation) external onlyOwner { // <= FOUND
251:         require(newImplementation != orderBookImplementation); // <= FOUND
252:         emit OBImplementationUpdated(orderBookImplementation, newImplementation);
253:         orderBookImplementation = newImplementation;
254:     }
```
['[260](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L260-L261)']
```solidity
260:     function upgradeVaultImplementation(address newImplementation) external onlyOwner { // <= FOUND
261:         require(newImplementation != kuruAmmVaultImplementation); // <= FOUND
262:         emit VaultImplementationUpdated(kuruAmmVaultImplementation, newImplementation);
263:         kuruAmmVaultImplementation = newImplementation;
264:     }
```
['[44](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L44-L45)']
```solidity
44:     function setFeeCollector(address _feeCollector) external onlyOwner { // <= FOUND
45:         require(feeCollector != _feeCollector, MarginAccountErrors.FeeCollectorNotChanged()); // <= FOUND
46:         feeCollector = _feeCollector;
47:         emit FeeCollectorUpdated(_feeCollector);
48:     }
```


</details>

## [NonCritical-6] Contract's `initialization` function can fail due to out of GAS error on certain chains due to iteration which can prevent accurate intended deployment

### Resolution 
Initialization functions that rely on gas-heavy operations, such as iterating over large arrays, risk exceeding the block gas limit. This can make deployment or initialization of the contract impossible, particularly when handling large datasets. For example, if an initialization function processes a lengthy array for setup, the operation could consume more gas than allowed, causing the transaction to revert. This effectively prevents the contract from being deployed or initialized successfully. To mitigate this, consider splitting heavy initialization tasks into smaller, manageable batches or leveraging external scripts for pre-processing. This ensures gas efficiency while maintaining the contract's functionality and deployability.

Num of instances: 1

### Findings 


<details><summary>Click to show findings</summary>

['[96](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruForwarder.sol#L96-L98)']
```solidity
96:     function initialize(address _owner, bytes4[] memory _allowedInterfaces) public initializer {
97:         _initializeOwner(_owner);
98:         for (uint256 i = 0; i < _allowedInterfaces.length; i++) { // <= FOUND
99:             allowedInterface[_allowedInterfaces[i]] = true;
100:         }
101:     }
```


</details>

## [NonCritical-7] Floating pragma should be avoided

Num of instances: 3

### Findings 


<details><summary>Click to show findings</summary>

['[2](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L2-L2)']
```solidity
2: pragma solidity ^0.8.20; // <= FOUND
```
['[3](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/TreeMath.sol#L3-L3)']
```solidity
3: pragma solidity ^0.8.10; // <= FOUND
```
['[2](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L2-L2)']
```solidity
2: pragma solidity ^0.8.4; // <= FOUND
```


</details>

## [NonCritical-8] Require statements should have error string

### Resolution 
Adding error strings to require statements in Solidity contracts, although not mandatory, enhances error handling, debugging, and overall contract maintainability. Providing a descriptive error message with each require statement helps identify the specific reason for a transaction failure, making it easier for developers to troubleshoot issues and for users to understand the cause of a revert. Including error strings improves code readability and fosters transparency, as the logic and conditions behind each requirement are clearly communicated

Num of instances: 2

### Findings 


<details><summary>Click to show findings</summary>

['[251](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L251-L251)']
```solidity
251: require(newImplementation != orderBookImplementation);
```
['[261](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L261-L261)']
```solidity
261: require(newImplementation != kuruAmmVaultImplementation);
```


</details>

## [NonCritical-9] In functions which accept an address as a parameter, there should be a zero address check to prevent bugs

### Resolution 
In smart contract development, especially with Solidity, it's crucial to validate inputs to functions. When a function accepts an Ethereum address as a parameter, implementing a zero address check (i.e., ensuring the address is not `0x0`) is a best practice to prevent potential bugs and vulnerabilities. The zero address (`0x0`) is a default value and generally indicates an uninitialized or invalid state. Passing the zero address to certain functions can lead to unintended behaviors, like funds getting locked permanently or transactions failing silently. By checking for and rejecting the zero address, developers can ensure that the function operates as intended and interacts only with valid Ethereum addresses. This check enhances the contract's robustness and security.

Num of instances: 37

### Findings 


<details><summary>Click to show findings</summary>

['[84](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L84-L84)']
```solidity
84:     function transferOwnership(address _newOwner) external 
```
['[56](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L56-L56)']
```solidity
56:     function _authorizeUpgrade(address) internal view override 
```
['[241](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L241-L241)']
```solidity
241:     function withdraw(uint256 _shares, address _receiver, address _owner)
242:         public
243:         nonReentrant
244:         returns (uint256, uint256)
245:     
```
['[258](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L258-L258)']
```solidity
258:     function _burnAndWithdraw(uint256 _shares, address _receiver, address _owner) internal returns (uint256, uint256) 
```
['[96](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruForwarder.sol#L96-L96)']
```solidity
96:     function initialize(address _owner, bytes4[] memory _allowedInterfaces) public initializer 
```
['[126](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruForwarder.sol#L126-L126)']
```solidity
126:     function getNonce(address from) public view returns (uint256) 
```
['[13](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/ERC2771Context.sol#L13-L13)']
```solidity
13:     function isTrustedForwarder(address) public view virtual returns (bool) 
```
['[44](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L44-L44)']
```solidity
44:     function setFeeCollector(address _feeCollector) external onlyOwner 
```
['[70](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L70-L70)']
```solidity
70:     function isTrustedForwarder(address forwarder) public view override returns (bool) 
```
['[76](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L76-L76)']
```solidity
76:     function initialize(address _owner, address _router, address _feeCollector, address _trustedForwarder)
77:         public
78:         initializer
79:     
```
['[92](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L92-L92)']
```solidity
92:     function updateMarkets(address _marketAddress) external onlyRouter protocolActive 
```
['[104](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L104-L104)']
```solidity
104:     function debitUser(address _user, address _token, uint256 _amount) external protocolActive 
```
['[118](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L118-L118)']
```solidity
118:     function creditUser(address _user, address _token, uint256 _amount, bool _useMargin) external protocolActive 
```
['[164](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L164-L164)']
```solidity
164:     function creditFee(address _assetA, uint256 _feeA, address _assetB, uint256 _feeB) external protocolActive 
```
['[177](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L177-L177)']
```solidity
177:     function batchWithdrawMaxTokens(address[] calldata _tokens) external protocolActive 
```
['[217](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L217-L217)']
```solidity
217:     function withdraw(uint256 _amount, address _token) external protocolActive 
```
['[234](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L234-L234)']
```solidity
234:     function getBalance(address _user, address _token) external view returns (uint256) 
```
['[243](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L243-L243)']
```solidity
243:     function _accountKey(address _user, address _token) internal pure returns (bytes32) 
```
['[74](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L74-L74)']
```solidity
74:     function isTrustedForwarder(address forwarder) public view virtual override returns (bool) 
```
['[85](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L85-L85)']
```solidity
85:     function initialize(
86:         address _owner,
87:         OrderBookType _type,
88:         address _baseAssetAddress,
89:         uint256 _baseAssetDecimals,
90:         address _quoteAssetAddress,
91:         uint256 _quoteAssetDecimals,
92:         address _marginAccountAddress,
93:         uint96 _sizePrecision,
94:         uint32 _pricePrecision,
95:         uint32 _tickSize,
96:         uint96 _minSize,
97:         uint96 _maxSize,
98:         uint256 _takerFeeBps,
99:         uint256 _makerFeeBps,
100:         address _kuruAmmVault,
101:         uint96 _kuruAmmSpread,
102:         address __trustedForwarder
103:     ) public initializer 
```
['[384](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L384-L384)']
```solidity
384:     function _addFlipOrder(
385:         uint32 _price,
386:         uint32 _flippedPrice,
387:         uint96 _size,
388:         address _owner,
389:         uint40 _orderId,
390:         uint40 _flippedId,
391:         bool _isBuy,
392:         uint40 _prevOrderId
393:     ) internal 
```
['[416](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L416-L416)']
```solidity
416:     function _addFlippedOrder(
417:         uint32 _price,
418:         uint32 _flippedPrice,
419:         uint96 _size,
420:         address _owner,
421:         uint40 _orderId,
422:         uint40 _flippedId,
423:         bool _isBuy,
424:         uint40 _prevOrderId
425:     ) internal 
```
['[443](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L443-L443)']
```solidity
443:     function _consumeFunds(address _consumableAsset, uint256 _amount, address _userAddress) internal 
```
['[1209](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L1209-L1209)']
```solidity
1209:     function _emitTrade(
1210:         uint40 orderId,
1211:         address makerAddress,
1212:         bool isBuy,
1213:         uint256 price,
1214:         uint96 updatedSize,
1215:         uint96 filledSize
1216:     ) internal override 
```
['[1238](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L1238-L1238)']
```solidity
1238:     function _creditMaker(bool _isMarketBuy, address _ownerAddress, uint96 _size, uint32 _price)
1239:         internal
1240:         view
1241:         returns (bytes memory)
1242:     
```
['[109](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/periphery/MonadDeployer.sol#L109-L109)']
```solidity
109:     function setKuruCollective(address _kuruCollective) external onlyOwner 
```
['[45](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L45-L45)']
```solidity
45:     function initialize(
46:         address _owner,
47:         address _marginAccount,
48:         address _orderbookImplementation,
49:         address _kuruAmmVaultImplementation,
50:         address _trustedForwarder
51:     ) public initializer 
```
['[192](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L192-L192)']
```solidity
192:     function computeAddress(
193:         address _baseAssetAddress,
194:         address _quoteAssetAddress,
195:         uint96 _sizePrecision,
196:         uint32 _pricePrecision,
197:         uint32 _tickSize,
198:         uint96 _minSize,
199:         uint96 _maxSize,
200:         uint256 _takerFeeBps,
201:         uint256 _makerFeeBps,
202:         uint96 _kuruAmmSpread,
203:         address oldImplementation,
204:         bool old
205:     ) public view returns (address proxy) 
```
['[229](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L229-L229)']
```solidity
229:     function computeVaultAddress(address _marketAddress, address oldImplementation, bool old)
230:         public
231:         view
232:         returns (address)
233:     
```
['[250](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L250-L250)']
```solidity
250:     function upgradeOrderBookImplementation(address newImplementation) external onlyOwner 
```
['[260](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L260-L260)']
```solidity
260:     function upgradeVaultImplementation(address newImplementation) external onlyOwner 
```
['[271](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L271-L271)']
```solidity
271:     function toggleMarkets(address[] memory markets, IOrderBook.MarketState state) external onlyOwner 
```
['[281](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L281-L281)']
```solidity
281:     function upgradeMultipleOrderBookProxies(address[] memory proxies, bytes[] memory data) public onlyOwner 
```
['[287](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L287-L287)']
```solidity
287:     function upgradeMultipleVaultProxies(address[] memory proxies, bytes[] memory data) public onlyOwner 
```
['[298](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L298-L298)']
```solidity
298:     function transferOwnershipForContracts(address[] memory contracts, address _newOwner) external onlyOwner 
```
['[304](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L304-L304)']
```solidity
304:     function _setApprovalsForMarket(
305:         address _baseAsset,
306:         address _quoteAsset,
307:         address _marketAddress,
308:         IOrderBook.OrderBookType _type
309:     ) internal 
```
['[392](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L392-L392)']
```solidity
392:     function _getSalt(
393:         address _baseAssetAddress,
394:         address _quoteAssetAddress,
395:         uint96 _sizePrecision,
396:         uint32 _pricePrecision,
397:         uint32 _tickSize,
398:         uint96 _minSize,
399:         uint96 _maxSize,
400:         uint256 _takerFeeBps,
401:         uint256 _makerFeeBps,
402:         uint96 _kuruAmmSpread
403:     ) internal pure returns (bytes32) 
```


</details>

## [NonCritical-10] Enum values should be used in place of constant array indexes

### Resolution 
Create a commented enum value to use in place of constant array indexes, this makes the code far easier to understand

Num of instances: 1

### Findings 


<details><summary>Click to show findings</summary>

['[343](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L343-L343)']
```solidity
343:         if (_nativeSend[0] == false) { // <= FOUND
```


</details>

## [NonCritical-11] Use safeTransferOwnership instead of transferOwnership

### Resolution 
SafeTransferOwnership should be used in place of transferOwner in Solidity contracts to enhance security and error handling. Unlike the basic transferOwner function, SafeTransferOwnership incorporates checks to validate the new owner's address and ensures that the transfer is executed only after receiving the new owner's confirmation. This additional layer of protection prevents accidental ownership transfers and mitigates the risk of locking a contract due to an invalid or unintended address assignment.

Num of instances: 2

### Findings 


<details><summary>Click to show findings</summary>

['[84](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L84-L84)']
```solidity
84:     function transferOwnership(address _newOwner) external  // <= FOUND
```
['[298](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L298-L298)']
```solidity
298:     function transferOwnershipForContracts(address[] memory contracts, address _newOwner) external onlyOwner  // <= FOUND
```


</details>

## [NonCritical-12] Default int values are manually set

### Resolution 
In instances where a new variable is defined, there is no need to set it to it's default value.

Num of instances: 15

### Findings 


<details><summary>Click to show findings</summary>

['[15](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/OrderLinkedList.sol#L15-L16)']
```solidity
15:     
16:     uint40 constant NULL = 0; // <= FOUND
```
['[139](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L139-L139)']
```solidity
139:         uint256 offset = 0; // <= FOUND
```
['[1415](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L1415-L1415)']
```solidity
1415:             uint96 size = 0; // <= FOUND
```
['[98](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruForwarder.sol#L98-L98)']
```solidity
98:         for (uint256 i = 0; i < _allowedInterfaces.length; i++) { // <= FOUND
```
['[179](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L179-L179)']
```solidity
179:         for (uint256 i = 0; i < _tokens.length; i++) { // <= FOUND
```
['[453](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L453-L453)']
```solidity
453:         for (uint256 i = 0; i < _orderIds.length; i++) { // <= FOUND
```
['[637](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L637-L637)']
```solidity
637:         for (uint256 i = 0; i < bidPrices.length; i++) { // <= FOUND
```
['[661](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L661-L661)']
```solidity
661:         for (uint256 i = 0; i < prices.length; i++) { // <= FOUND
```
['[695](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L695-L696)']
```solidity
695:         
696:         for (uint256 i = 0; i < orderIdsToCancel.length; i++) { // <= FOUND
```
['[705](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L705-L706)']
```solidity
705:         
706:         for (uint256 i = 0; i < buyPrices.length; i++) { // <= FOUND
```
['[710](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L710-L711)']
```solidity
710:         
711:         for (uint256 i = 0; i < sellPrices.length; i++) { // <= FOUND
```
['[272](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L272-L272)']
```solidity
272:         for (uint256 i = 0; i < markets.length; i++) { // <= FOUND
```
['[282](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L282-L282)']
```solidity
282:         for (uint256 i = 0; i < proxies.length; i++) { // <= FOUND
```
['[299](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L299-L299)']
```solidity
299:         for (uint256 i = 0; i < contracts.length; i++) { // <= FOUND
```
['[348](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L348-L348)']
```solidity
348:         for (uint256 i = 0; i < _marketAddresses.length; i++) { // <= FOUND
```


</details>

## [NonCritical-13] Ownable2Step should be used in place of Ownable

### Resolution 
Ownable2Step further prevents risks posed by centralised privileges as there is a smaller likelihood of the owner being wrongfully changed

Num of instances: 4

### Findings 


<details><summary>Click to show findings</summary>

['[12](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/periphery/MonadDeployer.sol#L12-L12)']
```solidity
12: contract MonadDeployer is Ownable  // <= FOUND
```
['[16](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruForwarder.sol#L16-L16)']
```solidity
16: contract KuruForwarder is EIP712, Initializable, Ownable, UUPSUpgradeable  // <= FOUND
```
['[17](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L17-L17)']
```solidity
17: contract MarginAccount is IMarginAccount, ERC2771Context, Ownable, Initializable, UUPSUpgradeable  // <= FOUND
```
['[23](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L23-L23)']
```solidity
23: contract Router is IRouter, Ownable, Initializable, UUPSUpgradeable  // <= FOUND
```


</details>

## [NonCritical-14] Revert statements within external and public functions can be used to perform DOS attacks

### Resolution 
In Solidity, 'revert' statements are used to undo changes and throw an exception when certain conditions are not met. However, in public and external functions, improper use of `revert` can be exploited for Denial of Service (DoS) attacks. An attacker can intentionally trigger these 'revert' conditions, causing legitimate transactions to consistently fail. For example, if a function relies on specific conditions from user input or contract state, an attacker could manipulate these to continually force reverts, blocking the function's execution. Therefore, it's crucial to design contract logic to handle exceptions properly and avoid scenarios where `revert` can be predictably triggered by malicious actors. This includes careful input validation and considering alternative design patterns that are less susceptible to such abuses.

Num of instances: 6

### Findings 


<details><summary>Click to show findings</summary>

['[65](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/periphery/MonadDeployer.sol#L65-L85)']
```solidity
65:     function deployTokenAndMarket(
66:         TokenParams memory tokenParams,
67:         MarketParams memory marketParams,
68:         bytes calldata metadata
69:     ) external payable returns (address market) {
70:         KuruERC20 token = new KuruERC20(tokenParams.name, tokenParams.symbol, tokenParams.initialSupply, address(this));
71:         market = router.deployProxy(
72:             IOrderBook.OrderBookType.NATIVE_IN_QUOTE,
73:             address(token),
74:             address(0),
75:             marketParams.sizePrecision,
76:             marketParams.pricePrecision,
77:             marketParams.tickSize,
78:             marketParams.minSize,
79:             marketParams.maxSize,
80:             marketParams.takerFeeBps,
81:             marketParams.makerFeeBps,
82:             kuruAmmSpread
83:         );
84:         if (msg.value != (marketParams.nativeTokenAmount + kuruCollectiveFee)) {
85:             revert InsufficientAssets(marketParams.nativeTokenAmount + kuruCollectiveFee, msg.value); // <= FOUND
86:         }
87:         (address vault,,,,,,,) = IOrderBook(market).getVaultParams();
88:         uint256 _supplyToVault = tokenParams.initialSupply * (10 ** 4 - tokenParams.supplyToDev) / 10 ** 4;
89:         token.approve(vault, _supplyToVault);
90:         IKuruAMMVault(vault).deposit{value: marketParams.nativeTokenAmount}(
91:             _supplyToVault, marketParams.nativeTokenAmount, address(this)
92:         );
93:         token.transfer(tokenParams.dev, tokenParams.initialSupply - _supplyToVault);
94:         marginAccount.deposit{value: kuruCollectiveFee}(kuruCollective, address(0), kuruCollectiveFee);
95:         emit PumpingTime(
96:             address(token),
97:             tokenParams.tokenURI,
98:             tokenParams.dev,
99:             tokenParams.initialSupply - _supplyToVault,
100:             market,
101:             metadata
102:         );
103:     }
```
['[219](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruForwarder.sol#L219-L234)']
```solidity
219:     function executeMarginAccountRequest(MarginAccountRequest calldata req, bytes calldata signature)
220:         public
221:         payable
222:         returns (bytes memory)
223:     {
224:         require(verifyMarginAccountRequest(req, signature), KuruForwarderErrors.SignatureMismatch());
225:         require(msg.value >= req.value, KuruForwarderErrors.InsufficientValue());
226:         require(allowedInterface[req.selector], KuruForwarderErrors.InterfaceNotAllowed());
227: 
228:         _nonces[req.from] = req.nonce + 1;
229: 
230:         (bool success, bytes memory returndata) =
231:             req.marginAccount.call{value: req.value}(abi.encodePacked(req.selector, req.data, req.from));
232: 
233:         if (!success) {
234:             revert ExecutionFailed(returndata); // <= FOUND
235:         }
236: 
237:         return returndata;
238:     }
```
['[240](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruForwarder.sol#L240-L251)']
```solidity
240:     function execute(ForwardRequest calldata req, bytes calldata signature) public payable returns (bytes memory) {
241:         require(verify(req, signature), KuruForwarderErrors.SignatureMismatch());
242:         require(msg.value >= req.value, KuruForwarderErrors.InsufficientValue());
243:         require(allowedInterface[req.selector], KuruForwarderErrors.InterfaceNotAllowed());
244: 
245:         _nonces[req.from] = req.nonce + 1;
246: 
247:         (bool success, bytes memory returndata) =
248:             req.market.call{value: req.value}(abi.encodePacked(req.selector, req.data, req.from));
249: 
250:         if (!success) {
251:             revert ExecutionFailed(returndata); // <= FOUND
252:         }
253: 
254:         return returndata;
255:     }
```
['[257](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruForwarder.sol#L257-L276)']
```solidity
257:     function executePriceDependent(PriceDependentRequest calldata req, bytes calldata signature)
258:         public
259:         payable
260:         returns (bytes memory)
261:     {
262:         require(verifyPriceDependent(req, signature), KuruForwarderErrors.SignatureMismatch());
263:         require(msg.value >= req.value, KuruForwarderErrors.InsufficientValue());
264:         require(allowedInterface[req.selector], KuruForwarderErrors.InterfaceNotAllowed());
265:         executedPriceDependentRequest[keccak256(abi.encodePacked(req.from, req.nonce))] = true;
266: 
267:         (uint256 _currentBidPrice,) = IOrderBook(req.market).bestBidAsk();
268:         require(
269:             (req.isBelowPrice && req.price < _currentBidPrice) || (!req.isBelowPrice && req.price > _currentBidPrice),
270:             PriceDependentRequestFailed(_currentBidPrice, req.price)
271:         );
272:         (bool success, bytes memory returndata) =
273:             req.market.call{value: req.value}(abi.encodePacked(req.selector, req.data, req.from));
274: 
275:         if (!success) {
276:             revert ExecutionFailed(returndata); // <= FOUND
277:         }
278: 
279:         return returndata;
280:     }
```
['[205](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L205-L219)']
```solidity
205:     function addFlipBuyOrder(uint32 _price, uint32 _flippedPrice, uint96 _size, bool _provisionOrRevert)
206:         public
207:         marketActive
208:         nonReentrant
209:     {
210:         require(_price > 0 && _flippedPrice > 0 && _flippedPrice < type(uint32).max, OrderBookErrors.PriceError());
211:         require(_price % tickSize == 0 && _flippedPrice % tickSize == 0, OrderBookErrors.TickSizeError());
212:         require(_price < _flippedPrice, OrderBookErrors.PriceError());
213:         require(_size > minSize && _size < maxSize, OrderBookErrors.SizeError());
214: 
215:         {
216:             (, uint256 _bestAsk) = bestAsk();
217:             if ((uint256(_price) * vaultPricePrecision / pricePrecision) >= _bestAsk && _bestAsk != 0) {
218:                 if (_provisionOrRevert) {
219:                     revert OrderBookErrors.ProvisionError(); // <= FOUND
220:                 } else {
221:                     return;
222:                 }
223:             }
224:         }
225:         _consumeFunds(
226:             quoteAsset, _quoteAmountRoundedUp(_price, _size) * quoteDecimalMultiplier / pricePrecision, _msgSender()
227:         );
228: 
229:         uint40 _orderId = s_orderIdCounter + 1;
230:         s_orderIdCounter = _orderId;
231:         uint40 _prevOrderId = OrderLinkedList.insertAtTail(s_buyPricePoints[_price], _orderId);
232:         _addFlipOrder(_price, _flippedPrice, _size, _msgSender(), _orderId, OrderLinkedList.NULL, true, _prevOrderId);
233:     }
```
['[275](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L275-L289)']
```solidity
275:     function addFlipSellOrder(uint32 _price, uint32 _flippedPrice, uint96 _size, bool _provisionOrRevert)
276:         public
277:         marketActive
278:         nonReentrant
279:     {
280:         require(_price > 0 && _flippedPrice > 0 && _price < type(uint32).max, OrderBookErrors.PriceError());
281:         require(_price % tickSize == 0 && _flippedPrice % tickSize == 0, OrderBookErrors.TickSizeError());
282:         require(_price > _flippedPrice, OrderBookErrors.PriceError());
283:         require(_size > minSize && _size < maxSize, OrderBookErrors.SizeError());
284: 
285:         {
286:             (, uint256 _bestBid) = bestBid();
287:             if ((uint256(_price) * vaultPricePrecision / pricePrecision) <= _bestBid && _bestBid != type(uint256).max) {
288:                 if (_provisionOrRevert) {
289:                     revert OrderBookErrors.ProvisionError(); // <= FOUND
290:                 } else {
291:                     return;
292:                 }
293:             }
294:         }
295: 
296:         _consumeFunds(baseAsset, _size * baseDecimalMultiplier / sizePrecision, _msgSender());
297:         uint40 _orderId = s_orderIdCounter + 1;
298:         s_orderIdCounter = _orderId;
299:         uint40 _prevOrderId = OrderLinkedList.insertAtTail(s_sellPricePoints[_price], _orderId);
300:         _addFlipOrder(_price, _flippedPrice, _size, _msgSender(), _orderId, OrderLinkedList.NULL, false, _prevOrderId);
301:     }
```


</details>

## [NonCritical-15] Functions which are either private or internal should have a preceding _ in their name

### Resolution 
Add a preceding underscore to the function name, take care to refactor where there functions are called

Num of instances: 79

### Findings 


<details><summary>Click to show findings</summary>

['[331](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/AbstractAMM.sol#L331-L331)']
```solidity
331:     function toU32(uint256 _from) internal pure returns (uint32 _to) 
```
['[335](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/AbstractAMM.sol#L335-L335)']
```solidity
335:     function toU96(uint256 _from) internal pure returns (uint96 _to) 
```
['[335](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/AbstractAMM.sol#L335-L335)']
```solidity
335:     function toU96(uint256 _from) internal pure returns (uint96 _to) 
```
['[64](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L64-L64)']
```solidity
64:     function mulWad(uint256 x, uint256 y) internal pure returns (uint256 z) 
```
['[77](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L77-L77)']
```solidity
77:     function sMulWad(int256 x, int256 y) internal pure returns (int256 z) 
```
['[91](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L91-L91)']
```solidity
91:     function rawMulWad(uint256 x, uint256 y) internal pure returns (uint256 z) 
```
['[99](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L99-L99)']
```solidity
99:     function rawSMulWad(int256 x, int256 y) internal pure returns (int256 z) 
```
['[107](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L107-L107)']
```solidity
107:     function mulWadUp(uint256 x, uint256 y) internal pure returns (uint256 z) 
```
['[120](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L120-L120)']
```solidity
120:     function rawMulWadUp(uint256 x, uint256 y) internal pure returns (uint256 z) 
```
['[128](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L128-L128)']
```solidity
128:     function divWad(uint256 x, uint256 y) internal pure returns (uint256 z) 
```
['[141](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L141-L141)']
```solidity
141:     function sDivWad(int256 x, int256 y) internal pure returns (int256 z) 
```
['[155](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L155-L155)']
```solidity
155:     function rawDivWad(uint256 x, uint256 y) internal pure returns (uint256 z) 
```
['[163](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L163-L163)']
```solidity
163:     function rawSDivWad(int256 x, int256 y) internal pure returns (int256 z) 
```
['[171](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L171-L171)']
```solidity
171:     function divWadUp(uint256 x, uint256 y) internal pure returns (uint256 z) 
```
['[184](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L184-L184)']
```solidity
184:     function rawDivWadUp(uint256 x, uint256 y) internal pure returns (uint256 z) 
```
['[194](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L194-L194)']
```solidity
194:     function powWad(int256 x, int256 y) internal pure returns (int256) 
```
['[202](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L202-L202)']
```solidity
202:     function expWad(int256 x) internal pure returns (int256 r) 
```
['[270](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L270-L270)']
```solidity
270:     function lnWad(int256 x) internal pure returns (int256 r) 
```
['[346](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L346-L346)']
```solidity
346:     function lambertW0Wad(int256 x) internal pure returns (int256 w) 
```
['[437](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L437-L437)']
```solidity
437:     function fullMulDiv(uint256 x, uint256 y, uint256 d) internal pure returns (uint256 result) 
```
['[499](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L499-L499)']
```solidity
499:     function fullMulDivUnchecked(uint256 x, uint256 y, uint256 d) internal pure returns (uint256 result) 
```
['[526](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L526-L526)']
```solidity
526:     function fullMulDivUp(uint256 x, uint256 y, uint256 d) internal pure returns (uint256 result) 
```
['[542](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L542-L542)']
```solidity
542:     function mulDiv(uint256 x, uint256 y, uint256 d) internal pure returns (uint256 z) 
```
['[557](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L557-L557)']
```solidity
557:     function mulDivUp(uint256 x, uint256 y, uint256 d) internal pure returns (uint256 z) 
```
['[570](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L570-L570)']
```solidity
570:     function mulDivRound(uint256 value, uint256 multiplier, uint256 divisor) internal pure returns (uint256) 
```
['[576](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L576-L576)']
```solidity
576:     function divUp(uint256 x, uint256 d) internal pure returns (uint256 z) 
```
['[588](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L588-L588)']
```solidity
588:     function zeroFloorSub(uint256 x, uint256 y) internal pure returns (uint256 z) 
```
['[596](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L596-L596)']
```solidity
596:     function ternary(bool condition, uint256 x, uint256 y) internal pure returns (uint256 result) 
```
['[605](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L605-L605)']
```solidity
605:     function rpow(uint256 x, uint256 y, uint256 b) internal pure returns (uint256 z) 
```
['[642](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L642-L642)']
```solidity
642:     function sqrt(uint256 x) internal pure returns (uint256 z) 
```
['[700](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L700-L700)']
```solidity
700:     function cbrt(uint256 x) internal pure returns (uint256 z) 
```
['[724](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L724-L724)']
```solidity
724:     function sqrtWad(uint256 x) internal pure returns (uint256 z) 
```
['[739](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L739-L739)']
```solidity
739:     function cbrtWad(uint256 x) internal pure returns (uint256 z) 
```
['[766](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L766-L766)']
```solidity
766:     function factorial(uint256 x) internal pure returns (uint256 result) 
```
['[781](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L781-L781)']
```solidity
781:     function log2(uint256 x) internal pure returns (uint256 r) 
```
['[797](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L797-L797)']
```solidity
797:     function log2Up(uint256 x) internal pure returns (uint256 r) 
```
['[807](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L807-L807)']
```solidity
807:     function log10(uint256 x) internal pure returns (uint256 r) 
```
['[832](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L832-L832)']
```solidity
832:     function log10Up(uint256 x) internal pure returns (uint256 r) 
```
['[842](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L842-L842)']
```solidity
842:     function log256(uint256 x) internal pure returns (uint256 r) 
```
['[855](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L855-L855)']
```solidity
855:     function log256Up(uint256 x) internal pure returns (uint256 r) 
```
['[865](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L865-L865)']
```solidity
865:     function sci(uint256 x) internal pure returns (uint256 mantissa, uint256 exponent) 
```
['[910](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L910-L910)']
```solidity
910:     function packSci(uint256 x) internal pure returns (uint256 packed) 
```
['[923](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L923-L923)']
```solidity
923:     function unpackSci(uint256 packed) internal pure returns (uint256 unpacked) 
```
['[930](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L930-L930)']
```solidity
930:     function avg(uint256 x, uint256 y) internal pure returns (uint256 z) 
```
['[937](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L937-L937)']
```solidity
937:     function avg(int256 x, int256 y) internal pure returns (int256 z) 
```
['[944](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L944-L944)']
```solidity
944:     function abs(int256 x) internal pure returns (uint256 z) 
```
['[952](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L952-L952)']
```solidity
952:     function dist(uint256 x, uint256 y) internal pure returns (uint256 z) 
```
['[960](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L960-L960)']
```solidity
960:     function dist(int256 x, int256 y) internal pure returns (uint256 z) 
```
['[968](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L968-L968)']
```solidity
968:     function min(uint256 x, uint256 y) internal pure returns (uint256 z) 
```
['[976](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L976-L976)']
```solidity
976:     function min(int256 x, int256 y) internal pure returns (int256 z) 
```
['[984](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L984-L984)']
```solidity
984:     function max(uint256 x, uint256 y) internal pure returns (uint256 z) 
```
['[992](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L992-L992)']
```solidity
992:     function max(int256 x, int256 y) internal pure returns (int256 z) 
```
['[1000](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L1000-L1000)']
```solidity
1000:     function clamp(uint256 x, uint256 minValue, uint256 maxValue) internal pure returns (uint256 z) 
```
['[1009](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L1009-L1009)']
```solidity
1009:     function clamp(int256 x, int256 minValue, int256 maxValue) internal pure returns (int256 z) 
```
['[1018](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L1018-L1018)']
```solidity
1018:     function gcd(uint256 x, uint256 y) internal pure returns (uint256 z) 
```
['[1033](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L1033-L1033)']
```solidity
1033:     function lerp(uint256 a, uint256 b, uint256 t, uint256 begin, uint256 end) internal pure returns (uint256) 
```
['[1051](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L1051-L1051)']
```solidity
1051:     function lerp(int256 a, int256 b, int256 t, int256 begin, int256 end) internal pure returns (int256) 
```
['[1073](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L1073-L1073)']
```solidity
1073:     function rawAdd(uint256 x, uint256 y) internal pure returns (uint256 z) 
```
['[1080](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L1080-L1080)']
```solidity
1080:     function rawAdd(int256 x, int256 y) internal pure returns (int256 z) 
```
['[1087](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L1087-L1087)']
```solidity
1087:     function rawSub(uint256 x, uint256 y) internal pure returns (uint256 z) 
```
['[1094](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L1094-L1094)']
```solidity
1094:     function rawSub(int256 x, int256 y) internal pure returns (int256 z) 
```
['[1101](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L1101-L1101)']
```solidity
1101:     function rawMul(uint256 x, uint256 y) internal pure returns (uint256 z) 
```
['[1108](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L1108-L1108)']
```solidity
1108:     function rawMul(int256 x, int256 y) internal pure returns (int256 z) 
```
['[1115](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L1115-L1115)']
```solidity
1115:     function rawDiv(uint256 x, uint256 y) internal pure returns (uint256 z) 
```
['[1123](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L1123-L1123)']
```solidity
1123:     function rawSDiv(int256 x, int256 y) internal pure returns (int256 z) 
```
['[1131](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L1131-L1131)']
```solidity
1131:     function rawMod(uint256 x, uint256 y) internal pure returns (uint256 z) 
```
['[1139](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L1139-L1139)']
```solidity
1139:     function rawSMod(int256 x, int256 y) internal pure returns (int256 z) 
```
['[1147](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L1147-L1147)']
```solidity
1147:     function rawAddMod(uint256 x, uint256 y, uint256 d) internal pure returns (uint256 z) 
```
['[1155](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L1155-L1155)']
```solidity
1155:     function rawMulMod(uint256 x, uint256 y, uint256 d) internal pure returns (uint256 z) 
```
['[22](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/OrderLinkedList.sol#L22-L22)']
```solidity
22:     function insertAtTail(PricePoint storage point, uint40 orderId) internal returns (uint40) 
```
['[35](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/OrderLinkedList.sol#L35-L35)']
```solidity
35:     function adjustForTail(PricePoint storage point, uint40 prev, uint40 next) internal 
```
['[46](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/OrderLinkedList.sol#L46-L46)']
```solidity
46:     function updateHead(PricePoint storage point, uint40 orderId) internal 
```
['[28](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/TreeMath.sol#L28-L28)']
```solidity
28:     function add(TreeUint32 storage tree, uint32 id) internal returns (bool) 
```
['[68](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/TreeMath.sol#L68-L68)']
```solidity
68:     function remove(TreeUint32 storage tree, uint32 id) internal returns (bool) 
```
['[108](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/TreeMath.sol#L108-L108)']
```solidity
108:     function findFirstRight(TreeUint32 storage tree, uint32 id) internal view returns (uint32) 
```
['[184](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/TreeMath.sol#L184-L184)']
```solidity
184:     function findFirstLeft(TreeUint32 storage tree, uint32 id) internal view returns (uint32) 
```
['[1353](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L1353-L1353)']
```solidity
1353:     function bestAsk() internal view returns (bool, uint256) 
```
['[1369](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L1369-L1369)']
```solidity
1369:     function bestBid() internal view returns (bool, uint256) 
```
['[335](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/AbstractAMM.sol#L335-L335)']
```solidity
335:     function toU96(uint256 _from) internal pure returns (uint96 _to) 
```


</details>

## [NonCritical-16] Private and internal state variables should have a preceding _ in their name unless they are constants

### Resolution 
Add a preceding underscore to the state variable name, take care to refactor where there variables are read/wrote

Num of instances: 30

### Findings 


<details><summary>Click to show findings</summary>

['[29](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L29-L29)']
```solidity
29:  uint256 private token1Decimals; // <= FOUND
```
['[32](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L32-L32)']
```solidity
32:  uint256 private token2Decimals; // <= FOUND
```
['[36](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L36-L36)']
```solidity
36:  uint96 internal sizePrecision; // <= FOUND
```
['[37](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L37-L37)']
```solidity
37:  uint32 internal pricePrecision; // <= FOUND
```
['[38](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L38-L38)']
```solidity
38:  uint256 internal takerFeeBps; // <= FOUND
```
['[39](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L39-L39)']
```solidity
39:  uint256 internal makerFeeBps; // <= FOUND
```
['[41](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L41-L41)']
```solidity
41:  uint256 internal baseAssetDecimals; // <= FOUND
```
['[42](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L42-L42)']
```solidity
42:  uint256 internal baseDecimalMultiplier; // <= FOUND
```
['[43](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L43-L43)']
```solidity
43:  uint256 internal quoteAssetDecimals; // <= FOUND
```
['[44](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L44-L44)']
```solidity
44:  uint256 internal quoteDecimalMultiplier; // <= FOUND
```
['[45](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L45-L45)']
```solidity
45:  address internal baseAsset; // <= FOUND
```
['[46](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L46-L46)']
```solidity
46:  address internal quoteAsset; // <= FOUND
```
['[21](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/AbstractAMM.sol#L21-L21)']
```solidity
21:  uint256 internal vaultBestBid; // <= FOUND
```
['[23](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/AbstractAMM.sol#L23-L23)']
```solidity
23:  uint96 internal bidPartiallyFilledSize; // <= FOUND
```
['[25](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/AbstractAMM.sol#L25-L25)']
```solidity
25:  uint96 internal askPartiallyFilledSize; // <= FOUND
```
['[27](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/AbstractAMM.sol#L27-L27)']
```solidity
27:  uint96 internal vaultBidOrderSize; // <= FOUND
```
['[20](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L20-L20)']
```solidity
20:  address trustedForwarder;
```
['[22](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L22-L22)']
```solidity
22:  bool protocolPaused;
```
['[28](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L28-L28)']
```solidity
28:  address routerContractAddress;
```
['[29](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L29-L29)']
```solidity
29:  address feeCollector;
```
['[21](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L21-L21)']
```solidity
21:  OrderBookType orderBookType;
```
['[22](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L22-L22)']
```solidity
22:  address owner;
```
['[26](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/periphery/MonadDeployer.sol#L26-L26)']
```solidity
26:  uint32 tickSize;
```
['[27](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/periphery/MonadDeployer.sol#L27-L27)']
```solidity
27:  uint96 minSize;
```
['[28](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/periphery/MonadDeployer.sol#L28-L28)']
```solidity
28:  uint96 maxSize;
```
['[52](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L52-L52)']
```solidity
52:  uint256 quoteFeeCollected;
```
['[53](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L53-L53)']
```solidity
53:  uint256 baseFeeCollected;
```
['[55](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L55-L55)']
```solidity
55:  IMarginAccount marginAccount;
```
['[34](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/periphery/MonadDeployer.sol#L34-L34)']
```solidity
34:  IRouter immutable router;
```
['[38](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/periphery/MonadDeployer.sol#L38-L38)']
```solidity
38:  IMarginAccount immutable marginAccount;
```


</details>

## [NonCritical-17] Contract lines should not be longer than 120 characters for readability

### Resolution 
Consider spreading these lines over multiple lines to aid in readability and the support of VIM users everywhere.

Num of instances: 19

### Findings 


<details><summary>Click to show findings</summary>

['[65](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruForwarder.sol#L65-L65)']
```solidity
65:         "ForwardRequest(address from,address market,uint256 value,uint256 nonce,uint256 deadline,bytes4 selector,bytes data)" // <= FOUND
```
['[69](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruForwarder.sol#L69-L69)']
```solidity
69:         "PriceDependentRequest(address from,address market,uint256 price,uint256 value,uint256 nonce,uint256 deadline,bool isBelowPrice,bytes4 selector,bytes data)" // <= FOUND
```
['[76](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruForwarder.sol#L76-L76)']
```solidity
76:         "MarginAccountRequest(address from,address marginAccount,uint256 value,uint256 nonce,uint256 deadline,bytes4 selector,bytes data)" // <= FOUND
```
['[52](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/AbstractAMM.sol#L52-L52)']
```solidity
52:      * @dev Iteratively match discretized AMM orders until a given price point is reached for a particular quote size for market buys // <= FOUND
```
['[113](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/AbstractAMM.sol#L113-L113)']
```solidity
113:             _creditVaultOnMarketBuy(sizeFilled, (_quoteSize * vaultPricePrecision / _getPricePrecision() - _quoteInput)); // <= FOUND
```
['[117](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/AbstractAMM.sol#L117-L117)']
```solidity
117:      * @dev Iteratively match discretized AMM orders until a given price point is reached for a particular quote size for limit order buys // <= FOUND
```
['[180](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/AbstractAMM.sol#L180-L180)']
```solidity
180:      * @dev Iteratively match discretized AMM orders until a given price point is reached for a particular base size for limit/market sells // <= FOUND
```
['[212](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L212-L212)']
```solidity
212:             _token1 == address(0) ? (msg.value - baseDeposit) : (_token2 == address(0) ? (msg.value - quoteDeposit) : 0); // <= FOUND
```
['[401](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L401-L401)']
```solidity
401:                     - int256(FixedPointMathLib.mulDiv(_partiallyFilledAskSize, _vaultBestAsk, _marketParams.sizePrecision)) // <= FOUND
```
['[10](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/Errors.sol#L10-L10)']
```solidity
10:      * @dev Thrown when a market is paused and a user tries to execute an action or if the owner passes an already existing market state for toggling // <= FOUND
```
['[46](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/Errors.sol#L46-L46)']
```solidity
46:      * @dev Thrown when a non-owner tries to execute a privileged function, i.e, if non owner tries to pause/unpause a market or // <= FOUND
```
['[107](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L107-L107)']
```solidity
107:         require(_kuruAmmSpread % 10 == 0 && _kuruAmmSpread > 0 && _kuruAmmSpread < 500, OrderBookErrors.InvalidSpread()); // <= FOUND
```
['[305](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L305-L305)']
```solidity
305:      * @dev Adds a paired liquidity order to the order book. This function will revert if the order matches against the book. // <= FOUND
```
['[406](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L406-L406)']
```solidity
406:      * @dev Internal function to add a flipped order to the order book. This function is called when a flip order is filled for the first time // <= FOUND
```
['[448](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L448-L448)']
```solidity
448:      * @notice If you cancel a flip order, both sides of the order pair will be cancelled. You cannot cancel one side of the order pair alone. // <= FOUND
```
['[449](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L449-L449)']
```solidity
449:      * @dev Cancels multiple flip orders in a batch. For a flip order pair, you only need to input ID of one of the orders. // <= FOUND
```
['[592](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L592-L592)']
```solidity
592:                 //Since all orders are filled FCFS in each price point, if head > order id, it means order id was already filled // <= FOUND
```
['[1106](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L1106-L1106)']
```solidity
1106:      * 1. everything remains same except we need to transfer size and change flip order id param of the order's flip order to null // <= FOUND
```
['[1370](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L1370-L1370)']
```solidity
1370:         uint256 firstRight = TreeMath.findFirstRight(s_buyTree, type(uint32).max) * vaultPricePrecision / pricePrecision; // <= FOUND
```


</details>

## [NonCritical-18] Avoid updating storage when the value hasn't changed

### Resolution 
In Solidity, manipulating contract storage comes with significant gas costs. One can optimize gas usage by preventing unnecessary storage updates when the new value is the same as the existing one. If an existing value is the same as the new one, not reassigning it to the storage could potentially save substantial amounts of gas, notably 2900 gas for a 'Gsreset'. This saving may come at the expense of a cold storage load operation ('Gcoldsload'), which costs 2100 gas, or a warm storage access operation ('Gwarmaccess'), which costs 100 gas. Therefore, the gas efficiency of your contract can be significantly improved by adding a check that compares the new value with the current one before any storage update operation. If the values are the same, you can bypass the storage operation, thereby saving gas.

Num of instances: 4

### Findings 


<details><summary>Click to show findings</summary>

['[105](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruForwarder.sol#L105-L105)']
```solidity
105:     function setAllowedInterfaces(bytes4[] memory _allowedInterfaces) external onlyOwner {
106:         for (uint256 i = 0; i < _allowedInterfaces.length; i++) {
107:             allowedInterface[_allowedInterfaces[i]] = true;
108:         }
109:     }
```
['[105](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/periphery/MonadDeployer.sol#L105-L105)']
```solidity
105:     function setKuruAmmSpread(uint96 _kuruAmmSpread) external onlyOwner {
106:         kuruAmmSpread = _kuruAmmSpread;
107:     }
```
['[109](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/periphery/MonadDeployer.sol#L109-L109)']
```solidity
109:     function setKuruCollective(address _kuruCollective) external onlyOwner {
110:         kuruCollective = _kuruCollective;
111:     }
```
['[113](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/periphery/MonadDeployer.sol#L113-L113)']
```solidity
113:     function setKuruCollectiveFee(uint256 _kuruCollectiveFee) external onlyOwner {
114:         kuruCollectiveFee = _kuruCollectiveFee;
115:     }
```


</details>

## [NonCritical-19] Old Solidity version

### Resolution 
Using outdated Solidity versions can lead to security risks and inefficiencies. It's recommended to adopt newer versions, ideally the latest, which as of now is 0.8.24. This ensures access to the latest bug fixes, features, and optimizations, particularly crucial for Layer 2 deployments. Regular updates to versions like 0.8.19 or later, up to 0.8.24, enhance contract security and performance.

Num of instances: 2

### Findings 


<details><summary>Click to show findings</summary>

['[3](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/TreeMath.sol#L3-L3)']
```solidity
3: pragma solidity ^0.8.10;
```
['[2](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L2-L2)']
```solidity
2: pragma solidity ^0.8.4;
```


</details>

## [NonCritical-20] Not all event definitions are utilizing indexed variables.

### Resolution 
Try to index as much as three variables in event declarations as this is more gas efficient when done on value type variables (uint, address etc) however not for bytes and string variables 

Num of instances: 1

### Findings 


<details><summary>Click to show findings</summary>

['[41](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/periphery/MonadDeployer.sol#L41-L41)']
```solidity
41: event PumpingTime( // <= FOUND
42:         address indexed token, string tokenURI, address dev, uint256 supplyToDev, address market, bytes metadata
43:     );
```


</details>

## [NonCritical-21] Explicitly define visibility of state variables to prevent misconceptions on what can access the variable

### Resolution 
Such state variables should be marked as private as this is the default visibility

Num of instances: 16

### Findings 


<details><summary>Click to show findings</summary>

['[18](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/AbstractAMM.sol#L18-L18)']
```solidity
18:  uint256 constant vaultPricePrecision = 10 ** 18; // <= FOUND
```
['[23](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L23-L23)']
```solidity
23:  uint256 constant MIN_LIQUIDITY = 10 ** 3; // <= FOUND
```
['[20](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/AbstractAMM.sol#L20-L20)']
```solidity
20:  uint256 constant BPS_MULTIPLIER = 10000; // <= FOUND
```
['[19](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/AbstractAMM.sol#L19-L19)']
```solidity
19:  uint256 constant DOUBLE_BPS_MULTIPLIER = 20000; // <= FOUND
```
['[26](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/periphery/MonadDeployer.sol#L26-L26)']
```solidity
26:  uint32 tickSize; // <= FOUND
```
['[27](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/periphery/MonadDeployer.sol#L27-L27)']
```solidity
27:  uint96 minSize; // <= FOUND
```
['[28](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/periphery/MonadDeployer.sol#L28-L28)']
```solidity
28:  uint96 maxSize; // <= FOUND
```
['[52](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L52-L52)']
```solidity
52:  uint256 quoteFeeCollected; // <= FOUND
```
['[53](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L53-L53)']
```solidity
53:  uint256 baseFeeCollected; // <= FOUND
```
['[15](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/OrderLinkedList.sol#L15-L15)']
```solidity
15:  uint40 constant NULL = 0; // <= FOUND
```
['[22](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L22-L22)']
```solidity
22:  bool protocolPaused; // <= FOUND
```
['[20](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L20-L20)']
```solidity
20:  address trustedForwarder; // <= FOUND
```
['[28](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L28-L28)']
```solidity
28:  address routerContractAddress; // <= FOUND
```
['[29](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L29-L29)']
```solidity
29:  address feeCollector; // <= FOUND
```
['[22](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L22-L22)']
```solidity
22:  address owner; // <= FOUND
```
['[23](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L23-L23)']
```solidity
23:  address _trustedForwarder; // <= FOUND
```


</details>

## [NonCritical-22] Contracts should have all public/external functions exposed by interfaces

### Resolution 
Contracts should expose all public and external functions through interfaces. This practice ensures a clear and consistent definition of how the contract can be interacted with, promoting better transparency and integration.

Num of instances: 67

### Findings 


<details><summary>Click to show findings</summary>

['[275](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/AbstractAMM.sol#L275-L275)']
```solidity
275:     function getVaultParams()
276:         external
277:         view
278:         returns (address, uint256, uint96, uint256, uint96, uint96, uint96, uint96)
279:     
```
['[300](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/AbstractAMM.sol#L300-L300)']
```solidity
300:     function updateVaultOrdSz(
301:         uint96 _vaultAskOrderSize,
302:         uint96 _vaultBidOrderSize,
303:         uint256 _askPrice,
304:         uint256 _bidPrice,
305:         bool _nullifyPartialFills
306:     ) external onlyVault nonReentrant marketNotHardPaused 
```
['[84](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L84-L84)']
```solidity
84:     function transferOwnership(address _newOwner) external 
```
['[105](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruForwarder.sol#L105-L105)']
```solidity
105:     function setAllowedInterfaces(bytes4[] memory _allowedInterfaces) external onlyOwner 
```
['[111](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruForwarder.sol#L111-L111)']
```solidity
111:     function removeAllowedInterfaces(bytes4[] memory _allowedInterfaces) external onlyOwner 
```
['[38](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L38-L38)']
```solidity
38:     function toggleProtocolState(bool _state) external onlyOwner 
```
['[44](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L44-L44)']
```solidity
44:     function setFeeCollector(address _feeCollector) external onlyOwner 
```
['[92](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L92-L92)']
```solidity
92:     function updateMarkets(address _marketAddress) external onlyRouter protocolActive 
```
['[104](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L104-L104)']
```solidity
104:     function debitUser(address _user, address _token, uint256 _amount) external protocolActive 
```
['[118](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L118-L118)']
```solidity
118:     function creditUser(address _user, address _token, uint256 _amount, bool _useMargin) external protocolActive 
```
['[136](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L136-L136)']
```solidity
136:     function creditUsersEncoded(bytes calldata _encodedData) external protocolActive 
```
['[164](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L164-L164)']
```solidity
164:     function creditFee(address _assetA, uint256 _feeA, address _assetB, uint256 _feeB) external protocolActive 
```
['[177](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L177-L177)']
```solidity
177:     function batchWithdrawMaxTokens(address[] calldata _tokens) external protocolActive 
```
['[198](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L198-L198)']
```solidity
198:     function deposit(address _user, address _token, uint256 _amount) external payable protocolActive 
```
['[217](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L217-L217)']
```solidity
217:     function withdraw(uint256 _amount, address _token) external protocolActive 
```
['[234](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L234-L234)']
```solidity
234:     function getBalance(address _user, address _token) external view returns (uint256) 
```
['[147](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L147-L147)']
```solidity
147:     function toggleMarket(MarketState _state) external 
```
['[452](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L452-L452)']
```solidity
452:     function batchCancelFlipOrders(uint40[] calldata _orderIds) external marketNotHardPaused 
```
['[465](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L465-L465)']
```solidity
465:     function batchCancelOrders(uint40[] calldata _orderIds) external marketNotHardPaused 
```
['[478](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L478-L478)']
```solidity
478:     function batchCancelOrdersNoRevert(uint40[] calldata _orderIds) external marketNotHardPaused 
```
['[628](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L628-L628)']
```solidity
628:     function batchAddPairedLiquidity(
629:         uint32[] calldata bidPrices,
630:         uint32[] calldata askPrices,
631:         uint96[] calldata bidSizes,
632:         uint96[] calldata askSizes
633:     ) external 
```
['[651](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L651-L651)']
```solidity
651:     function batchProvisionLiquidity(
652:         uint32[] calldata prices,
653:         uint32[] calldata flipPrices,
654:         uint96[] calldata sizes,
655:         bool[] calldata isBuy,
656:         bool _provisionOrRevert
657:     ) external 
```
['[679](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L679-L679)']
```solidity
679:     function batchUpdate(
680:         uint32[] calldata buyPrices,
681:         uint96[] calldata buySizes,
682:         uint32[] calldata sellPrices,
683:         uint96[] calldata sellSizes,
684:         uint40[] calldata orderIdsToCancel,
685:         bool postOnly
686:     ) external marketNotHardPaused 
```
['[847](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L847-L847)']
```solidity
847:     function collectFees() external 
```
['[195](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/interfaces/IOrderBook.sol#L195-L195)']
```solidity
195:     function getMarketParams()
196:         external
197:         view
198:         returns (uint32, uint96, address, uint256, address, uint256, uint32, uint96, uint96, uint256, uint256)
199:     
```
['[1331](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L1331-L1331)']
```solidity
1331:     function bestBidAsk() external view returns (uint256, uint256) 
```
['[1390](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L1390-L1390)']
```solidity
1390:     function getL2Book() external view returns (bytes memory) 
```
['[65](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/periphery/MonadDeployer.sol#L65-L65)']
```solidity
65:     function deployTokenAndMarket(
66:         TokenParams memory tokenParams,
67:         MarketParams memory marketParams,
68:         bytes calldata metadata
69:     ) external payable returns (address market) 
```
['[105](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/periphery/MonadDeployer.sol#L105-L105)']
```solidity
105:     function setKuruAmmSpread(uint96 _kuruAmmSpread) external onlyOwner 
```
['[109](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/periphery/MonadDeployer.sol#L109-L109)']
```solidity
109:     function setKuruCollective(address _kuruCollective) external onlyOwner 
```
['[113](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/periphery/MonadDeployer.sol#L113-L113)']
```solidity
113:     function setKuruCollectiveFee(uint256 _kuruCollectiveFee) external onlyOwner 
```
['[250](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L250-L250)']
```solidity
250:     function upgradeOrderBookImplementation(address newImplementation) external onlyOwner 
```
['[260](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L260-L260)']
```solidity
260:     function upgradeVaultImplementation(address newImplementation) external onlyOwner 
```
['[271](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L271-L271)']
```solidity
271:     function toggleMarkets(address[] memory markets, IOrderBook.MarketState state) external onlyOwner 
```
['[298](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L298-L298)']
```solidity
298:     function transferOwnershipForContracts(address[] memory contracts, address _newOwner) external onlyOwner 
```
['[331](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L331-L331)']
```solidity
331:     function anyToAnySwap(
332:         address[] calldata _marketAddresses,
333:         bool[] calldata _isBuy,
334:         bool[] calldata _nativeSend,
335:         address _debitToken,
336:         address _creditToken,
337:         uint256 _amount,
338:         uint256 _minAmountOut
339:     ) external payable returns (uint256 _amountOut) 
```
['[45](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L45-L45)']
```solidity
45:     function initialize(
46:         address _owner,
47:         address token1_,
48:         address token2_,
49:         address _marginAccount,
50:         address _market,
51:         uint96 _spreadConstant
52:     ) public initializer 
```
['[108](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L108-L108)']
```solidity
108:     function setMarketParams() public 
```
['[149](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L149-L149)']
```solidity
149:     function totalAssets() public view returns (uint256, uint256) 
```
['[156](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L156-L156)']
```solidity
156:     function deposit(uint256 baseDeposit, uint256 quoteDeposit, address receiver)
157:         public
158:         payable
159:         nonReentrant
160:         returns (uint256)
161:     
```
['[241](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L241-L241)']
```solidity
241:     function withdraw(uint256 _shares, address _receiver, address _owner)
242:         public
243:         nonReentrant
244:         returns (uint256, uint256)
245:     
```
['[305](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L305-L305)']
```solidity
305:     function mint(uint256 shares, address receiver) public payable returns (uint256, uint256) 
```
['[96](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruForwarder.sol#L96-L96)']
```solidity
96:     function initialize(address _owner, bytes4[] memory _allowedInterfaces) public initializer 
```
['[126](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruForwarder.sol#L126-L126)']
```solidity
126:     function getNonce(address from) public view returns (uint256) 
```
['[130](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruForwarder.sol#L130-L130)']
```solidity
130:     function verify(ForwardRequest calldata req, bytes calldata signature) public view returns (bool) 
```
['[151](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruForwarder.sol#L151-L151)']
```solidity
151:     function verifyPriceDependent(PriceDependentRequest calldata req, bytes calldata signature)
152:         public
153:         view
154:         returns (bool)
155:     
```
['[180](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruForwarder.sol#L180-L180)']
```solidity
180:     function verifyCancelPriceDependent(CancelPriceDependentRequest calldata req, bytes calldata signature)
181:         public
182:         view
183:         returns (bool)
184:     
```
['[196](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruForwarder.sol#L196-L196)']
```solidity
196:     function verifyMarginAccountRequest(MarginAccountRequest calldata req, bytes calldata signature)
197:         public
198:         view
199:         returns (bool)
200:     
```
['[219](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruForwarder.sol#L219-L219)']
```solidity
219:     function executeMarginAccountRequest(MarginAccountRequest calldata req, bytes calldata signature)
220:         public
221:         payable
222:         returns (bytes memory)
223:     
```
['[240](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruForwarder.sol#L240-L240)']
```solidity
240:     function execute(ForwardRequest calldata req, bytes calldata signature) public payable returns (bytes memory) 
```
['[257](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruForwarder.sol#L257-L257)']
```solidity
257:     function executePriceDependent(PriceDependentRequest calldata req, bytes calldata signature)
258:         public
259:         payable
260:         returns (bytes memory)
261:     
```
['[282](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruForwarder.sol#L282-L282)']
```solidity
282:     function cancelPriceDependent(CancelPriceDependentRequest calldata req, bytes calldata signature) public 
```
['[76](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L76-L76)']
```solidity
76:     function initialize(address _owner, address _router, address _feeCollector, address _trustedForwarder)
77:         public
78:         initializer
79:     
```
['[85](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L85-L85)']
```solidity
85:     function initialize(
86:         address _owner,
87:         OrderBookType _type,
88:         address _baseAssetAddress,
89:         uint256 _baseAssetDecimals,
90:         address _quoteAssetAddress,
91:         uint256 _quoteAssetDecimals,
92:         address _marginAccountAddress,
93:         uint96 _sizePrecision,
94:         uint32 _pricePrecision,
95:         uint32 _tickSize,
96:         uint96 _minSize,
97:         uint96 _maxSize,
98:         uint256 _takerFeeBps,
99:         uint256 _makerFeeBps,
100:         address _kuruAmmVault,
101:         uint96 _kuruAmmSpread,
102:         address __trustedForwarder
103:     ) public initializer 
```
['[169](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L169-L169)']
```solidity
169:     function addBuyOrder(uint32 _price, uint96 size, bool _postOnly) public marketActive nonReentrant 
```
['[205](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L205-L205)']
```solidity
205:     function addFlipBuyOrder(uint32 _price, uint32 _flippedPrice, uint96 _size, bool _provisionOrRevert)
206:         public
207:         marketActive
208:         nonReentrant
209:     
```
['[241](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L241-L241)']
```solidity
241:     function addSellOrder(uint32 _price, uint96 _size, bool _postOnly) public marketActive nonReentrant 
```
['[275](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L275-L275)']
```solidity
275:     function addFlipSellOrder(uint32 _price, uint32 _flippedPrice, uint96 _size, bool _provisionOrRevert)
276:         public
277:         marketActive
278:         nonReentrant
279:     
```
['[311](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L311-L311)']
```solidity
311:     function addPairedLiquidity(uint32 _bidPrice, uint32 _askPrice, uint96 _bidSize, uint96 _askSize)
312:         public
313:         marketActive
314:         nonReentrant
315:     
```
['[786](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L786-L786)']
```solidity
786:     function placeAndExecuteMarketSell(uint96 _size, uint256 _minAmountOut, bool _isMargin, bool _isFillOrKill)
787:         public
788:         payable
789:         marketActive
790:         nonReentrant
791:         returns (uint256)
792:     
```
['[1399](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L1399-L1399)']
```solidity
1399:     function getL2Book(uint32 _bidPricePoints, uint32 _askPricePoints) public view returns (bytes memory data) 
```
['[45](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L45-L45)']
```solidity
45:     function initialize(
46:         address _owner,
47:         address _marginAccount,
48:         address _orderbookImplementation,
49:         address _kuruAmmVaultImplementation,
50:         address _trustedForwarder
51:     ) public initializer 
```
['[74](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L74-L74)']
```solidity
74:     function deployProxy(
75:         IOrderBook.OrderBookType _type,
76:         address _baseAssetAddress,
77:         address _quoteAssetAddress,
78:         uint96 _sizePrecision,
79:         uint32 _pricePrecision,
80:         uint32 _tickSize,
81:         uint96 _minSize,
82:         uint96 _maxSize,
83:         uint256 _takerFeeBps,
84:         uint256 _makerFeeBps,
85:         uint96 _kuruAmmSpread
86:     ) public returns (address proxy) 
```
['[192](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L192-L192)']
```solidity
192:     function computeAddress(
193:         address _baseAssetAddress,
194:         address _quoteAssetAddress,
195:         uint96 _sizePrecision,
196:         uint32 _pricePrecision,
197:         uint32 _tickSize,
198:         uint96 _minSize,
199:         uint96 _maxSize,
200:         uint256 _takerFeeBps,
201:         uint256 _makerFeeBps,
202:         uint96 _kuruAmmSpread,
203:         address oldImplementation,
204:         bool old
205:     ) public view returns (address proxy) 
```
['[229](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L229-L229)']
```solidity
229:     function computeVaultAddress(address _marketAddress, address oldImplementation, bool old)
230:         public
231:         view
232:         returns (address)
233:     
```
['[281](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L281-L281)']
```solidity
281:     function upgradeMultipleOrderBookProxies(address[] memory proxies, bytes[] memory data) public onlyOwner 
```
['[287](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L287-L287)']
```solidity
287:     function upgradeMultipleVaultProxies(address[] memory proxies, bytes[] memory data) public onlyOwner 
```


</details>

## [NonCritical-23] Functions within contracts are not ordered according to the solidity style guide

### Resolution 
The following order should be used within contracts

constructor

receive function (if exists)

fallback function (if exists)

external

public

internal

private

Rearrange the contract functions and contructors to fit this ordering

Num of instances: 5

### Findings 


<details><summary>Click to show findings</summary>

['[18](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L18-L18)']
```solidity
18: contract KuruAMMVault is IKuruAMMVault, ERC20, Initializable, UUPSUpgradeable, ReentrancyGuardTransient  // <= FOUND
```
['[16](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruForwarder.sol#L16-L16)']
```solidity
16: contract KuruForwarder is EIP712, Initializable, Ownable, UUPSUpgradeable  // <= FOUND
```
['[17](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L17-L17)']
```solidity
17: contract MarginAccount is IMarginAccount, ERC2771Context, Ownable, Initializable, UUPSUpgradeable  // <= FOUND
```
['[20](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L20-L20)']
```solidity
20: contract OrderBook is Initializable, UUPSUpgradeable, ERC2771Context, AbstractAMM  // <= FOUND
```
['[23](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L23-L23)']
```solidity
23: contract Router is IRouter, Ownable, Initializable, UUPSUpgradeable  // <= FOUND
```


</details>

## [NonCritical-24] Double type casts create complexity within the code

### Resolution 
Double type casting should be avoided in Solidity contracts to prevent unintended consequences and ensure accurate data representation. Performing multiple type casts in succession can lead to unexpected truncation, rounding errors, or loss of precision, potentially compromising the contract's functionality and reliability. Furthermore, double type casting can make the code less readable and harder to maintain, increasing the likelihood of errors and misunderstandings during development and debugging. To ensure precise and consistent data handling, developers should use appropriate data types and avoid unnecessary or excessive type casting, promoting a more robust and dependable contract execution.

Num of instances: 13

### Findings 


<details><summary>Click to show findings</summary>

['[29](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/TreeMath.sol#L29-L29)']
```solidity
29:         bytes32 key3 = bytes32(uint256(id) >> 8); // <= FOUND
```
['[118](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/TreeMath.sol#L118-L118)']
```solidity
118:             if (closestBit != type(uint256).max) return uint32((uint256(key3) << 8) | closestBit); // <= FOUND
```
['[122](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/TreeMath.sol#L122-L122)']
```solidity
122:         bit = uint8(uint256(key3) & type(uint8).max); // <= FOUND
```
['[129](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/TreeMath.sol#L129-L129)']
```solidity
129:                 key3 = bytes32((uint256(key2) << 8) | closestBit); // <= FOUND
```
['[132](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/TreeMath.sol#L132-L132)']
```solidity
132:                 return uint32((uint256(key3) << 8) | uint256(leaves).mostSignificantBit()); // <= FOUND
```
['[137](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/TreeMath.sol#L137-L137)']
```solidity
137:         bit = uint8(uint256(key2) & type(uint8).max); // <= FOUND
```
['[144](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/TreeMath.sol#L144-L144)']
```solidity
144:                 key2 = bytes32((uint256(key1) << 8) | closestBit); // <= FOUND
```
['[147](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/TreeMath.sol#L147-L147)']
```solidity
147:                 key3 = bytes32((uint256(key2) << 8) | uint256(leaves).mostSignificantBit()); // <= FOUND
```
['[154](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/TreeMath.sol#L154-L154)']
```solidity
154:         bit = uint8(uint256(key1) & type(uint8).max); // <= FOUND
```
['[164](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/TreeMath.sol#L164-L164)']
```solidity
164:                 key2 = bytes32((uint256(key1) << 8) | uint256(leaves).mostSignificantBit()); // <= FOUND
```
['[208](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/TreeMath.sol#L208-L208)']
```solidity
208:                 return uint32((uint256(key3) << 8) | uint256(leaves).leastSignificantBit()); // <= FOUND
```
['[223](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/TreeMath.sol#L223-L223)']
```solidity
223:                 key3 = bytes32((uint256(key2) << 8) | uint256(leaves).leastSignificantBit()); // <= FOUND
```
['[240](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/TreeMath.sol#L240-L240)']
```solidity
240:                 key2 = bytes32((uint256(key1) << 8) | uint256(leaves).leastSignificantBit()); // <= FOUND
```


</details>

## [NonCritical-25] Emits without msg.sender parameter

### Resolution 
In Solidity, when `msg.sender` plays a crucial role in a function's logic, it's important for transparency and auditability that any events emitted by this function include `msg.sender` as a parameter. This practice enhances the traceability and accountability of transactions, allowing users and external observers to easily track who initiated a particular action. Including `msg.sender` in event logs helps in creating a clear and verifiable record of interactions with the contract, thereby increasing user trust and facilitating easier debugging and analysis of contract behavior. It's a key aspect of writing clear, transparent, and user-friendly smart contracts.

Num of instances: 1

### Findings 


<details><summary>Click to show findings</summary>

['[175](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L175-L214)']
```solidity
175:     function _mintAndDeposit(uint256 baseDeposit, uint256 quoteDeposit, address receiver) internal returns (uint256) {
176:         (uint256 _baseAmount, uint256 _currentAskPrice) = _returnNormalizedAmountAndPrice(true);
177:         uint256 _shares;
178:         if (totalSupply() != 0) {
179:             uint256 _expectedQuoteAmount = (
180:                 (
181:                     FixedPointMathLib.mulDivUp(baseDeposit, _currentAskPrice, vaultPricePrecision)
182:                         * 10 ** marketParams.quoteAssetDecimals
183:                 )
184:             ) / 10 ** marketParams.baseAssetDecimals;
185:             require(_expectedQuoteAmount <= quoteDeposit, KuruAMMVaultErrors.InsufficientQuoteToken());
186:             _shares = _convertToShares(baseDeposit, _expectedQuoteAmount, _currentAskPrice);
187:             quoteDeposit = _expectedQuoteAmount;
188:             _mint(receiver, _shares);
189:         } else {
190:             _shares = FixedPointMathLib.sqrt(baseDeposit * quoteDeposit);
191:             _mint(address(marginAccount), MIN_LIQUIDITY);
192:             _shares -= MIN_LIQUIDITY;
193:             _mint(receiver, _shares);
194:             _currentAskPrice = (
195:                 ((quoteDeposit * 10 ** marketParams.baseAssetDecimals)) * vaultPricePrecision
196:                     / 10 ** marketParams.quoteAssetDecimals
197:             ) / (baseDeposit);
198:         }
199:         require(_shares > 0, KuruAMMVaultErrors.InsufficientLiquidityMinted());
200:         (uint96 _newAskSize, uint96 _newBidSize) = _getVaultSizesForBaseAmount(_baseAmount + baseDeposit);
201:         market.updateVaultOrdSz(
202:             _newAskSize,
203:             _newBidSize,
204:             _currentAskPrice,
205:             FixedPointMathLib.mulDivRound(_currentAskPrice, BPS_MULTIPLIER, BPS_MULTIPLIER + SPREAD_CONSTANT),
206:             false
207:         );
208:         address _token1 = token1;
209:         address _token2 = token2;
210:         _depositAmountsToMarginAccount(_token1, _token2, baseDeposit, quoteDeposit);
211:         uint256 _nativeRefund =
212:             _token1 == address(0) ? (msg.value - baseDeposit) : (_token2 == address(0) ? (msg.value - quoteDeposit) : 0);
213:         if (_nativeRefund > 0) {
214:             msg.sender.safeTransferETH(_nativeRefund); // <= FOUND
215:         }
216:         emit KuruVaultDeposit(baseDeposit, quoteDeposit, _shares, receiver);
217:         return _shares;
218:     }
```


</details>

## [NonCritical-26] A function which defines named returns in it's declaration doesn't need to use return

### Resolution 
Refacter the code to assign to the named return variables rather than using a return statement

Num of instances: 7

### Findings 


<details><summary>Click to show findings</summary>

['[350](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L350-L370)']
```solidity
350:     function _convertToAssets(uint256 shares, bool isDeposit)
351:         internal
352:         view
353:         returns (uint256 _baseAmount, uint256 _quoteAmount)
354:     {
355:         if (isDeposit) {
356:             if (totalSupply() == 0) {
357:                 return (0, 0); // <= FOUND
358:             }
359:             (uint256 _baseReserve, uint256 _quoteReserve) = totalAssets();
360:             (, uint256 _currentAskPrice) = _returnNormalizedAmountAndPrice(true);
361:             (_baseReserve, _quoteReserve) =
362:                 _returnVirtuallyRebalancedTotalAssets(_baseReserve, _quoteReserve, _currentAskPrice);
363:             _baseAmount = FixedPointMathLib.mulDiv(shares, _baseReserve, totalSupply());
364:             _quoteAmount = (
365:                 (
366:                     FixedPointMathLib.mulDivUp(_baseAmount, _currentAskPrice, vaultPricePrecision)
367:                         * 10 ** marketParams.quoteAssetDecimals
368:                 )
369:             ) / 10 ** marketParams.baseAssetDecimals;
370:             return (_baseAmount, _quoteAmount); // <= FOUND
371:         } else {
372:             (_baseAmount, _quoteAmount,,,) = _convertToAssetsWithNewSize(shares);
373:         }
374:     }
```
['[117](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruForwarder.sol#L117-L118)']
```solidity
117:     function _domainNameAndVersionMayChange() internal pure override returns (bool result) {
118:         return true; // <= FOUND
119:     }
```
['[202](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L202-L206)']
```solidity
202:     function expWad(int256 x) internal pure returns (int256 r) {
203:         unchecked {
204:             
205:             
206:             if (x <= -41446531673892822313) return r; // <= FOUND
207: 
208:             
209:             assembly {
210:                 
211:                 
212:                 if iszero(slt(x, 135305999368893231589)) {
213:                     mstore(0x00, 0xa37bfec9) 
214:                     revert(0x1c, 0x04)
215:                 }
216:             }
217: 
218:             
219:             
220:             
221:             x = (x << 78) / 5 ** 18;
222: 
223:             
224:             
225:             
226:             int256 k = ((x << 96) / 54916777467707473351141471128 + 2 ** 95) >> 96;
227:             x = x - k * 54916777467707473351141471128;
228: 
229:             
230: 
231:             
232:             
233:             int256 y = x + 1346386616545796478920950773328;
234:             y = ((y * x) >> 96) + 57155421227552351082224309758442;
235:             int256 p = y + x - 94201549194550492254356042504812;
236:             p = ((p * y) >> 96) + 28719021644029726153956944680412240;
237:             p = p * x + (4385272521454847904659076985693276 << 96);
238: 
239:             
240:             int256 q = x - 2855989394907223263936484059900;
241:             q = ((q * x) >> 96) + 50020603652535783019961831881945;
242:             q = ((q * x) >> 96) - 533845033583426703283633433725380;
243:             q = ((q * x) >> 96) + 3604857256930695427073651918091429;
244:             q = ((q * x) >> 96) - 14423608567350463180887372962807573;
245:             q = ((q * x) >> 96) + 26449188498355588339934803723976023;
246: 
247:             
248:             assembly {
249:                 
250:                 
251:                 
252:                 r := sdiv(p, q)
253:             }
254: 
255:             
256: 
257:             
258:             
259:             
260:             
261:             
262:             
263:             r = int256((uint256(r) * 3822833074963236453042738258902158003155416615667) >> uint256(195 - k));
264:         }
265:     }
```
['[346](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L346-L416)']
```solidity
346:     function lambertW0Wad(int256 x) internal pure returns (int256 w) {
347:         
348:         unchecked {
349:             if ((w = x) <= -367879441171442322) revert OutOfDomain(); 
350:             int256 wad = int256(WAD);
351:             int256 p = x;
352:             uint256 c; 
353:             uint256 i = 4; 
354:             if (w <= 0x1ffffffffffff) {
355:                 if (-0x4000000000000 <= w) {
356:                     i = 1; 
357:                 } else if (w <= -0x3ffffffffffffff) {
358:                     i = 32; 
359:                 }
360:             } else if (uint256(w >> 63) == uint256(0)) {
361:                 
362:                 assembly {
363:                     
364:                     let v := shr(49, w)
365:                     let l := shl(3, lt(0xff, v))
366:                     l := add(or(l, byte(and(0x1f, shr(shr(l, v), 0x8421084210842108cc6318c6db6d54be)),
367:                         0x0706060506020504060203020504030106050205030304010505030400000000)), 49)
368:                     w := sdiv(shl(l, 7), byte(sub(l, 31), 0x0303030303030303040506080c13))
369:                     c := gt(l, 60)
370:                     i := add(2, add(gt(l, 53), c))
371:                 }
372:             } else {
373:                 int256 ll = lnWad(w = lnWad(w));
374:                 
375:                 assembly {
376:                     
377:                     w := add(sdiv(mul(ll, 1023715080943847266), w), sub(w, ll))
378:                     i := add(3, iszero(shr(68, x)))
379:                     c := iszero(shr(143, x))
380:                 }
381:                 if (c == uint256(0)) {
382:                     do { 
383:                         int256 e = expWad(w);
384:                         
385:                         assembly {
386:                             let t := mul(w, div(e, wad))
387:                             w := sub(w, sdiv(sub(t, x), div(add(e, t), wad)))
388:                         }
389:                         if (p <= w) break;
390:                         p = w;
391:                     } while (--i != uint256(0));
392:                     
393:                     assembly {
394:                         w := sub(w, sgt(w, 2))
395:                     }
396:                     return w; // <= FOUND
397:                 }
398:             }
399:             do { 
400:                 int256 e = expWad(w);
401:                 
402:                 assembly {
403:                     let t := add(w, wad)
404:                     let s := sub(mul(w, e), mul(x, wad))
405:                     w := sub(w, sdiv(mul(s, wad), sub(mul(e, t), sdiv(mul(add(t, wad), s), add(t, t)))))
406:                 }
407:                 if (p <= w) break;
408:                 p = w;
409:             } while (--i != c);
410:             
411:             assembly {
412:                 w := sub(w, sgt(w, 2))
413:             }
414:             
415:             
416:             if (c == uint256(0)) return w; // <= FOUND
417:             int256 t = w | 1;
418:             
419:             assembly {
420:                 x := sdiv(mul(x, wad), t)
421:             }
422:             x = (t * (wad + lnWad(x)));
423:             
424:             assembly {
425:                 w := sdiv(x, add(wad, t))
426:             }
427:         }
428:     }
```
['[724](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L724-L726)']
```solidity
724:     function sqrtWad(uint256 x) internal pure returns (uint256 z) {
725:         unchecked {
726:             if (x <= type(uint256).max / 10 ** 18) return sqrt(x * 10 ** 18); // <= FOUND
727:             z = (1 + sqrt(x)) * 10 ** 9;
728:             z = (fullMulDivUnchecked(x, 10 ** 18, z) + z) >> 1;
729:         }
730:         
731:         assembly {
732:             z := sub(z, gt(999999999999999999, sub(mulmod(z, z, x), 1))) 
733:         }
734:     }
```
['[739](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L739-L741)']
```solidity
739:     function cbrtWad(uint256 x) internal pure returns (uint256 z) {
740:         unchecked {
741:             if (x <= type(uint256).max / 10 ** 36) return cbrt(x * 10 ** 36); // <= FOUND
742:             z = (1 + cbrt(x)) * 10 ** 12;
743:             z = (fullMulDivUnchecked(x, 10 ** 36, z * z) + z + z) / 3;
744:         }
745:         
746:         assembly {
747:             let p := x
748:             for {} 1 {} {
749:                 if iszero(shr(229, p)) {
750:                     if iszero(shr(199, p)) {
751:                         p := mul(p, 100000000000000000) 
752:                         break
753:                     }
754:                     p := mul(p, 100000000) 
755:                     break
756:                 }
757:                 if iszero(shr(249, p)) { p := mul(p, 100) }
758:                 break
759:             }
760:             let t := mulmod(mul(z, z), z, p)
761:             z := sub(z, gt(lt(t, shr(1, p)), iszero(t))) 
762:         }
763:     }
```
['[74](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L74-L189)']
```solidity
74:     function deployProxy(
75:         IOrderBook.OrderBookType _type,
76:         address _baseAssetAddress,
77:         address _quoteAssetAddress,
78:         uint96 _sizePrecision,
79:         uint32 _pricePrecision,
80:         uint32 _tickSize,
81:         uint96 _minSize,
82:         uint96 _maxSize,
83:         uint256 _takerFeeBps,
84:         uint256 _makerFeeBps,
85:         uint96 _kuruAmmSpread
86:     ) public returns (address proxy) {
87:         if (_type == IOrderBook.OrderBookType.NATIVE_IN_BASE) {
88:             require(_baseAssetAddress == address(0), RouterErrors.MarketTypeMismatch());
89:             require(_quoteAssetAddress != address(0), RouterErrors.MarketTypeMismatch());
90:         } else if (_type == IOrderBook.OrderBookType.NATIVE_IN_QUOTE) {
91:             require(_baseAssetAddress != address(0), RouterErrors.MarketTypeMismatch());
92:             require(_quoteAssetAddress == address(0), RouterErrors.MarketTypeMismatch());
93:         } else {
94:             require(_baseAssetAddress != address(0), RouterErrors.MarketTypeMismatch());
95:             require(_quoteAssetAddress != address(0), RouterErrors.MarketTypeMismatch());
96:             require(_baseAssetAddress != _quoteAssetAddress, RouterErrors.BaseAndQuoteAssetSame());
97:         }
98:         require(_tickSize > 0, RouterErrors.InvalidTickSize());
99:         require(10 ** Math.log10(_sizePrecision) == _sizePrecision, RouterErrors.InvalidSizePrecision());
100:         require(10 ** Math.log10(_pricePrecision) == _pricePrecision, RouterErrors.InvalidPricePrecision());
101:         uint256 _baseAssetDecimals =
102:             _type == IOrderBook.OrderBookType.NATIVE_IN_BASE ? 18 : IERC20Metadata(_baseAssetAddress).decimals();
103:         uint256 _quoteAssetDecimals =
104:             _type == IOrderBook.OrderBookType.NATIVE_IN_QUOTE ? 18 : IERC20Metadata(_quoteAssetAddress).decimals();
105:         {
106:             bytes32 _salt = _getSalt(
107:                 _baseAssetAddress,
108:                 _quoteAssetAddress,
109:                 _sizePrecision,
110:                 _pricePrecision,
111:                 _tickSize,
112:                 _minSize,
113:                 _maxSize,
114:                 _takerFeeBps,
115:                 _makerFeeBps,
116:                 _kuruAmmSpread
117:             );
118:             proxy = Create2.deploy(
119:                 0,
120:                 _salt,
121:                 abi.encodePacked(type(ERC1967Proxy).creationCode, abi.encode(orderBookImplementation, bytes("")))
122:             );
123:         }
124:         IKuruAMMVault _kuruAmmVault = IKuruAMMVault(
125:             Create2.deploy(
126:                 0,
127:                 keccak256(abi.encode(proxy)),
128:                 abi.encodePacked(type(ERC1967Proxy).creationCode, abi.encode(kuruAmmVaultImplementation, bytes("")))
129:             )
130:         );
131: 
132:         verifiedMarket[proxy] = MarketParams(
133:             _pricePrecision,
134:             _sizePrecision,
135:             _baseAssetAddress,
136:             _baseAssetDecimals,
137:             _quoteAssetAddress,
138:             _quoteAssetDecimals,
139:             _tickSize,
140:             _minSize,
141:             _maxSize,
142:             _takerFeeBps,
143:             _makerFeeBps
144:         );
145:         IMarginAccount(marginAccountAddress).updateMarkets(proxy);
146:         {
147:             IOrderBook(proxy).initialize(
148:                 address(this),
149:                 _type,
150:                 _baseAssetAddress,
151:                 _baseAssetDecimals,
152:                 _quoteAssetAddress,
153:                 _quoteAssetDecimals,
154:                 marginAccountAddress,
155:                 _sizePrecision,
156:                 _pricePrecision,
157:                 _tickSize,
158:                 _minSize,
159:                 _maxSize,
160:                 _takerFeeBps,
161:                 _makerFeeBps,
162:                 address(_kuruAmmVault),
163:                 _kuruAmmSpread,
164:                 TRUSTED_FORWARDER
165:             );
166:         }
167: 
168:         _kuruAmmVault.initialize(
169:             address(this), _baseAssetAddress, _quoteAssetAddress, marginAccountAddress, proxy, _kuruAmmSpread
170:         );
171: 
172:         _setApprovalsForMarket(_baseAssetAddress, _quoteAssetAddress, proxy, _type);
173: 
174:         emit MarketRegistered(
175:             _baseAssetAddress,
176:             _quoteAssetAddress,
177:             proxy,
178:             address(_kuruAmmVault),
179:             _pricePrecision,
180:             _sizePrecision,
181:             _tickSize,
182:             _minSize,
183:             _maxSize,
184:             _takerFeeBps,
185:             _makerFeeBps,
186:             _kuruAmmSpread
187:         );
188: 
189:         return proxy; // <= FOUND
190:     }
```


</details>

## [NonCritical-27] Constants should be on the left side of the comparison

### Resolution 
Putting constants on the left side of a comparison operator like `==` or `<` is a best practice known as "Yoda conditions", which can help prevent accidental assignment instead of comparison. In some programming languages, if a variable is mistakenly put on the left with a single `=` instead of `==`, it assigns the constant's value to the variable without any compiler error. However, doing this with the constant on the left would generate an error, as constants cannot be assigned values. Although Solidity's static typing system prevents accidental assignments within conditionals, adopting this practice enhances code readability and consistency, especially when developers are working across multiple languages that support this convention.

Num of instances: 39

### Findings 


<details><summary>Click to show findings</summary>

['[318](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/AbstractAMM.sol#L318-L318)']
```solidity
318:         if (vaultBestBid == 0)  // <= FOUND
```
['[178](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L178-L178)']
```solidity
178:         if (totalSupply() != 0)  // <= FOUND
```
['[114](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/TreeMath.sol#L114-L114)']
```solidity
114:         if (bit != 0)  // <= FOUND
```
['[184](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L184-L184)']
```solidity
184:         if (_remainingSize == 0)  // <= FOUND
```
['[899](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L899-L899)']
```solidity
899:         if (sizeToCreditTaker == 0)  // <= FOUND
```
['[899](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L899-L899)']
```solidity
899:         if (sizeToCreditTaker == 0)  // <= FOUND
```
['[1044](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L1044-L1044)']
```solidity
1044:         if (quoteCreditTaker == 0 && quoteCreditVaultTaker == 0)  // <= FOUND
```
['[1128](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L1128-L1128)']
```solidity
1128:         if (incomingOrderRemainingSize == 0)  // <= FOUND
```
['[1132](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L1132-L1132)']
```solidity
1132:         if (s_orders[_orderId].flippedPrice == 0)  // <= FOUND
```
['[1142](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L1142-L1142)']
```solidity
1142:            if (_preExistingOrderUpdatedSize != 0)  // <= FOUND
```
['[1148](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L1148-L1148)']
```solidity
1148:         if (s_orders[_orderId].flippedPrice != 0)  // <= FOUND
```
['[1339](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L1339-L1339)']
```solidity
1339:         if (firstLeft != 0)  // <= FOUND
```
['[1339](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L1339-L1339)']
```solidity
1339:         if (firstLeft != 0)  // <= FOUND
```
['[356](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L356-L356)']
```solidity
356:           if (totalSupply() == 0)  // <= FOUND
```
['[354](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L354-L354)']
```solidity
354:             if (w <= 0x1ffffffffffff)  // <= FOUND
```
['[37](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/TreeMath.sol#L37-L37)']
```solidity
37:            if (leaves == 0)  // <= FOUND
```
['[77](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/TreeMath.sol#L77-L77)']
```solidity
77:            if (newLeaves == 0)  // <= FOUND
```
['[114](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/TreeMath.sol#L114-L114)']
```solidity
114:         if (bit != 0)  // <= FOUND
```
['[114](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/TreeMath.sol#L114-L114)']
```solidity
114:         if (bit != 0)  // <= FOUND
```
['[114](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/TreeMath.sol#L114-L114)']
```solidity
114:         if (bit != 0)  // <= FOUND
```
['[217](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L217-L217)']
```solidity
217:            if ((uint256(_price) * vaultPricePrecision / pricePrecision) >= _bestAsk && _bestAsk != 0)  // <= FOUND
```
['[1128](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L1128-L1128)']
```solidity
1128:         if (incomingOrderRemainingSize == 0)  // <= FOUND
```
['[1372](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L1372-L1372)']
```solidity
1372:           if (vaultBestBid != 0)  // <= FOUND
```
['[43](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/TreeMath.sol#L43-L43)']
```solidity
43:               if (leaves == 0)  // <= FOUND
```
['[83](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/TreeMath.sol#L83-L83)']
```solidity
83:               if (newLeaves == 0)  // <= FOUND
```
['[248](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/AbstractAMM.sol#L248-L248)']
```solidity
248:         if (feeRebate > 0)  // <= FOUND
```
['[248](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/AbstractAMM.sol#L248-L248)']
```solidity
248:         if (feeRebate > 0)  // <= FOUND
```
['[213](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L213-L213)']
```solidity
213:         if (_nativeRefund > 0)  // <= FOUND
```
['[715](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L715-L715)']
```solidity
715:         if (orderIdsCanceled.length > 0)  // <= FOUND
```
['[906](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L906-L906)']
```solidity
906:             if (sizeToCreditViaVault > 0)  // <= FOUND
```
['[976](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L976-L976)']
```solidity
976:             if (sizeToCreditViaVault > 0 && msg.sender != address(0))  // <= FOUND
```
['[1051](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L1051-L1051)']
```solidity
1051:             if (quoteCreditVaultTaker > 0 && msg.sender != address(0))  // <= FOUND
```
['[248](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/AbstractAMM.sol#L248-L248)']
```solidity
248:         if (feeRebate > 0)  // <= FOUND
```
['[759](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L759-L759)']
```solidity
759:         if (_quoteSize > 0)  // <= FOUND
```
['[811](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L811-L811)']
```solidity
811:         if (_size > 0)  // <= FOUND
```
['[912](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L912-L912)']
```solidity
912:             if (_takerFeeBps > 0)  // <= FOUND
```
['[912](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L912-L912)']
```solidity
912:             if (_takerFeeBps > 0)  // <= FOUND
```
['[405](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L405-L405)']
```solidity
405:            if (_baseOwedToVault < 0)  // <= FOUND
```
['[414](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L414-L414)']
```solidity
414:             if (_quoteOwedToVault < 0)  // <= FOUND
```


</details>

## [NonCritical-28] Defined named returns not used within function 

### Resolution 
Such instances can be replaced with unnamed returns

Num of instances: 1

### Findings 


<details><summary>Click to show findings</summary>

['[117](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruForwarder.sol#L117-L117)']
```solidity
117:     function _domainNameAndVersionMayChange() internal pure override returns (bool result) { // <= FOUND
118:         return true;
119:     }
```


</details>

## [NonCritical-29] Initialize functions do not emit an event

### Resolution 
Emitting an event within initializer functions in Solidity is a best practice for providing transparency and traceability. Initializer functions set the initial state and values of an upgradeable contract. Emitting an event during initialization allows anyone to verify and audit the initial state of the contract via the transaction logs. This can be particularly useful for verifying the parameters set during initialization, tracking the contract's deployment, and troubleshooting or debugging. Therefore, developers should include an event emission in their initializer functions, providing a clear record of the contract's initialization and enhancing the contract's transparency and security.

Num of instances: 5

### Findings 


<details><summary>Click to show findings</summary>

['[45](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L45-L45)']
```solidity
45:     function initialize( // <= FOUND
46:         address _owner,
47:         address token1_,
48:         address token2_,
49:         address _marginAccount,
50:         address _market,
51:         uint96 _spreadConstant
52:     ) public initializer {
53:         owner = _owner;
54:         token1 = token1_;
55:         token1Decimals = token1_ != address(0) ? ERC20(token1_).decimals() : 18;
56:         token2 = token2_;
57:         token2Decimals = token2_ != address(0) ? ERC20(token2_).decimals() : 18;
58:         marginAccount = IMarginAccount(_marginAccount);
59:         market = IOrderBook(_market);
60:         SPREAD_CONSTANT = _spreadConstant;
61:         setMarketParams();
62:         if (token1_ != address(0)) {
63:             token1_.safeApprove(_marginAccount, type(uint256).max);
64:         }
65:         if (token2_ != address(0)) {
66:             token2_.safeApprove(_marginAccount, type(uint256).max);
67:         }
68:         string memory token1Symbol;
69:         string memory token2Symbol;
70:         if (token1_ != address(0)) {
71:             token1Symbol = ERC20(token1_).symbol();
72:         } else {
73:             token1Symbol = "MON";
74:         }
75:         if (token2_ != address(0)) {
76:             token2Symbol = ERC20(token2_).symbol();
77:         } else {
78:             token2Symbol = "MON";
79:         }
80:         _name = string.concat(token1Symbol, "-", token2Symbol, "-", "KURU-AMM-VAULT");
81:     }
```
['[96](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruForwarder.sol#L96-L96)']
```solidity
96:     function initialize(address _owner, bytes4[] memory _allowedInterfaces) public initializer { // <= FOUND
97:         _initializeOwner(_owner);
98:         for (uint256 i = 0; i < _allowedInterfaces.length; i++) {
99:             allowedInterface[_allowedInterfaces[i]] = true;
100:         }
101:     }
```
['[76](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L76-L76)']
```solidity
76:     function initialize(address _owner, address _router, address _feeCollector, address _trustedForwarder) // <= FOUND
77:         public
78:         initializer
79:     {
80:         _initializeOwner(_owner);
81:         routerContractAddress = _router;
82:         feeCollector = _feeCollector;
83:         trustedForwarder = _trustedForwarder;
84:     }
```
['[85](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L85-L85)']
```solidity
85:     function initialize( // <= FOUND
86:         address _owner,
87:         OrderBookType _type,
88:         address _baseAssetAddress,
89:         uint256 _baseAssetDecimals,
90:         address _quoteAssetAddress,
91:         uint256 _quoteAssetDecimals,
92:         address _marginAccountAddress,
93:         uint96 _sizePrecision,
94:         uint32 _pricePrecision,
95:         uint32 _tickSize,
96:         uint96 _minSize,
97:         uint96 _maxSize,
98:         uint256 _takerFeeBps,
99:         uint256 _makerFeeBps,
100:         address _kuruAmmVault,
101:         uint96 _kuruAmmSpread,
102:         address __trustedForwarder
103:     ) public initializer {
104:         owner = _owner;
105: 
106:         require(_makerFeeBps <= _takerFeeBps && _takerFeeBps < BPS_MULTIPLIER, OrderBookErrors.MarketFeeError());
107:         require(_kuruAmmSpread % 10 == 0 && _kuruAmmSpread > 0 && _kuruAmmSpread < 500, OrderBookErrors.InvalidSpread());
108:         require(_minSize > 0 && _maxSize > _minSize, OrderBookErrors.MarketSizeError());
109:         orderBookType = _type;
110:         baseAsset = _baseAssetAddress;
111:         quoteAsset = _quoteAssetAddress;
112: 
113:         baseAssetDecimals = _baseAssetDecimals;
114:         baseDecimalMultiplier = 10 ** _baseAssetDecimals;
115:         quoteAssetDecimals = _quoteAssetDecimals;
116:         quoteDecimalMultiplier = 10 ** _quoteAssetDecimals;
117: 
118:         marginAccount = IMarginAccount(payable(_marginAccountAddress));
119:         
120:         sizePrecision = _sizePrecision;
121:         pricePrecision = _pricePrecision;
122:         tickSize = _tickSize;
123:         minSize = _minSize;
124:         maxSize = _maxSize;
125:         takerFeeBps = _takerFeeBps;
126:         makerFeeBps = _makerFeeBps;
127:         kuruAmmVault = _kuruAmmVault;
128:         SPREAD_CONSTANT = _kuruAmmSpread;
129:         vaultBestAsk = type(uint256).max;
130:         _trustedForwarder = __trustedForwarder;
131:     }
```
['[45](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L45-L45)']
```solidity
45:     function initialize( // <= FOUND
46:         address _owner,
47:         address _marginAccount,
48:         address _orderbookImplementation,
49:         address _kuruAmmVaultImplementation,
50:         address _trustedForwarder
51:     ) public initializer {
52:         _initializeOwner(_owner);
53:         marginAccountAddress = _marginAccount;
54:         orderBookImplementation = _orderbookImplementation;
55:         kuruAmmVaultImplementation = _kuruAmmVaultImplementation;
56:         TRUSTED_FORWARDER = _trustedForwarder;
57:     }
```


</details>

## [NonCritical-30] Both immutable and constant state variables should be CONSTANT_CASE

### Resolution 
Make found instants CAPITAL_CASE

Num of instances: 3

### Findings 


<details><summary>Click to show findings</summary>

['[18](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/AbstractAMM.sol#L18-L18)']
```solidity
18: uint256 constant vaultPricePrecision = 10 ** 18; // <= FOUND
```
['[38](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/periphery/MonadDeployer.sol#L38-L38)']
```solidity
38: IMarginAccount immutable marginAccount; // <= FOUND
```
['[34](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/periphery/MonadDeployer.sol#L34-L34)']
```solidity
34: IRouter immutable router; // <= FOUND
```


</details>

## [NonCritical-31] Overly complicated arithmetic

### Resolution 
To maintain readability in code, particularly in Solidity which can involve complex mathematical operations, it is often recommended to limit the number of arithmetic operations to a maximum of 2-3 per line. Too many operations in a single line can make the code difficult to read and understand, increase the likelihood of mistakes, and complicate the process of debugging and reviewing the code. Consider splitting such operations over more than one line, take special care when dealing with division however. Try to limit the number of arithmetic operations to a maximum of 3 per line.

Num of instances: 19

### Findings 


<details><summary>Click to show findings</summary>

['[246](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/AbstractAMM.sol#L246-L247)']
```solidity
246:         uint256 feeRebate =
247:             ((_sizeFilled * 10 ** _getBaseAssetDecimals() / _getSizePrecision()) * _getMakerFeeBps()) / BPS_MULTIPLIER; // <= FOUND
```
['[267](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/AbstractAMM.sol#L267-L268)']
```solidity
267:         uint256 feeRebate = (
268:             (_fundsOwedToUser * 10 ** _getQuoteAssetDecimals() / vaultPricePrecision) * _getMakerFeeBps() // <= FOUND
269:         ) / BPS_MULTIPLIER;
```
['[433](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L433-L435)']
```solidity
433:         uint96 _newAskSize = toU96(
434:             (SPREAD_CONSTANT * _baseAmount * _marketParams.sizePrecision)
435:                 / ((DOUBLE_BPS_MULTIPLIER + SPREAD_CONSTANT) * 10 ** _marketParams.baseAssetDecimals) // <= FOUND
436:         );
```
['[450](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L450-L452)']
```solidity
450:         uint256 _halfTotalValuationInQuote = (
451:             (_reserve1 * _vaultPrice * 10 ** _marketParams.quoteAssetDecimals)
452:                 / (10 ** _marketParams.baseAssetDecimals * vaultPricePrecision) + _reserve2 // <= FOUND
453:         ) / 2;
```
['[226](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L226-L229)']
```solidity
226:             
227:             
228:             
229:             int256 k = ((x << 96) / 54916777467707473351141471128 + 2 ** 95) >> 96; // <= FOUND
```
['[571](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L571-L571)']
```solidity
571:         return (value * multiplier + divisor / 2) / divisor; // <= FOUND
```
['[726](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L726-L726)']
```solidity
726:             if (x <= type(uint256).max / 10 ** 18) return sqrt(x * 10 ** 18); // <= FOUND
```
['[741](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L741-L741)']
```solidity
741:             if (x <= type(uint256).max / 10 ** 36) return cbrt(x * 10 ** 36); // <= FOUND
```
['[743](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L743-L743)']
```solidity
743:             z = (fullMulDivUnchecked(x, 10 ** 36, z * z) + z + z) / 3; // <= FOUND
```
['[939](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L939-L939)']
```solidity
939:             z = (x >> 1) + (y >> 1) + (x & y & 1); // <= FOUND
```
['[1042](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L1042-L1042)']
```solidity
1042:             if (b >= a) return a + fullMulDiv(b - a, t - begin, end - begin); // <= FOUND
```
['[1043](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L1043-L1043)']
```solidity
1043:             return a - fullMulDiv(a - b, t - begin, end - begin); // <= FOUND
```
['[552](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L552-L555)']
```solidity
552:             marginAccount.creditUser(
553:                 _order.ownerAddress,
554:                 quoteAsset,
555:                 (((toU96((_order.size * _order.price) / sizePrecision) * quoteDecimalMultiplier) / pricePrecision)), // <= FOUND
556:                 true
557:             );
```
['[916](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L916-L917)']
```solidity
916:                 
917:                 baseFeeCollected += ((_feeDebit * (_takerFeeBps - makerFeeBps)) / _takerFeeBps); // <= FOUND
```
['[948](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L948-L950)']
```solidity
948:                 
949:                 uint96 _sizeFillableAtPriceLeft =
950:                     toU96(_quoteSize * _sizePrecision * vaultPricePrecision / (_bestAsk * _pricePrecision)); // <= FOUND
```
['[1061](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L1061-L1062)']
```solidity
1061:                 
1062:                 quoteFeeCollected += ((_feeDebit * (_takerFeeBps - makerFeeBps)) / _takerFeeBps); // <= FOUND
```
['[1251](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L1251-L1251)']
```solidity
1251:             feeRebate = (((_size * baseDecimalMultiplier) / sizePrecision) * makerFeeBps) / BPS_MULTIPLIER; // <= FOUND
```
['[1270](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L1270-L1270)']
```solidity
1270:         return ((_price * _size) / sizePrecision) * quoteDecimalMultiplier / pricePrecision; // <= FOUND
```
['[88](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/periphery/MonadDeployer.sol#L88-L88)']
```solidity
88:         uint256 _supplyToVault = tokenParams.initialSupply * (10 ** 4 - tokenParams.supplyToDev) / 10 ** 4; // <= FOUND
```


</details>

## [NonCritical-32] Using zero as a parameter

### Resolution 
Taking 0 as a valid argument in Solidity without checks can lead to severe security issues. A historical example is the infamous 0x0 address bug where numerous tokens were lost. This happens because '0' can be interpreted as an uninitialized address, leading to transfers to the '0x0' address, effectively burning tokens. Moreover, 0 as a denominator in division operations would cause a runtime exception. It's also often indicative of a logical error in the caller's code. It's important to always validate input and handle edge cases like 0 appropriately. Use `require()` statements to enforce conditions and provide clear error messages to facilitate debugging and safer code.

Num of instances: 8

### Findings 


<details><summary>Click to show findings</summary>

['[258](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L258-L271)']
```solidity
258:     function _burnAndWithdraw(uint256 _shares, address _receiver, address _owner) internal returns (uint256, uint256) { // <= FOUND
259:         (
260:             uint256 _baseOwedToUser,
261:             uint256 _quoteOwedToUser,
262:             uint96 _newAskSize,
263:             uint96 _newBidSize,
264:             bool _nullifyPartialFills
265:         ) = _convertToAssetsWithNewSize(_shares);
266: 
267:         _burn(_owner, _shares);
268: 
269:         
270:         
271:         market.updateVaultOrdSz(_newAskSize, _newBidSize, 0, 0, _nullifyPartialFills); // <= FOUND
272: 
273:         _withdrawFromMarginAccount(_baseOwedToUser, _quoteOwedToUser, _receiver);
274: 
275:         emit KuruVaultWithdraw(_baseOwedToUser, _quoteOwedToUser, _shares, _owner);
276: 
277:         return (_baseOwedToUser, _quoteOwedToUser);
278:     }
```
['[359](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L359-L365)']
```solidity
359:     function _addOrder(uint32 _price, uint96 _size, uint40 _orderId, bool _isBuy, uint40 _prevOrderId) internal { // <= FOUND
360:         if (_isBuy) {
361:             TreeMath.add(s_buyTree, _price);
362:         } else {
363:             TreeMath.add(s_sellTree, _price);
364:         }
365:         s_orders[_orderId] = // <= FOUND
366:             Order(_msgSender(), _size, _prevOrderId, OrderLinkedList.NULL, OrderLinkedList.NULL, _price, 0, _isBuy);
367:         if (_prevOrderId != OrderLinkedList.NULL) {
368:             s_orders[_prevOrderId].next = _orderId;
369:         }
370:         emit OrderCreated(_orderId, _msgSender(), _size, _price, _isBuy);
371:     }
```
['[786](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L786-L807)']
```solidity
786:     function placeAndExecuteMarketSell(uint96 _size, uint256 _minAmountOut, bool _isMargin, bool _isFillOrKill) // <= FOUND
787:         public
788:         payable
789:         marketActive
790:         nonReentrant
791:         returns (uint256)
792:     {
793:         OrderBookType _type = orderBookType;
794:         if (_type == OrderBookType.NATIVE_IN_BASE && !_isMargin && (msg.sender != address(0))) {
795:             require(msg.value >= _sizePrecisionToBaseAssetPrecision(_size), OrderBookErrors.NativeAssetInsufficient());
796:             require(msg.value < _sizePrecisionToBaseAssetPrecision(_size + 1), OrderBookErrors.NativeAssetSurplus());
797:         } else if (msg.sender != address(0)) {
798:             require(msg.value == 0, OrderBookErrors.NativeAssetNotRequired());
799:             _isMargin
800:                 ? marginAccount.debitUser(_msgSender(), baseAsset, _sizePrecisionToBaseAssetPrecision(_size))
801:                 : baseAsset.safeTransferFrom(
802:                     _msgSender(), address(marginAccount), _sizePrecisionToBaseAssetPrecision(_size)
803:                 );
804:         }
805: 
806:         uint256 _quoteCredited;
807:         (_size, _quoteCredited) = _matchAggressiveSell(0, _size, _isMargin); // <= FOUND
808:         if (msg.sender == address(0)) {
809:             return _quoteCredited;
810:         }
811:         if (_size > 0) {
812:             require(!_isFillOrKill, OrderBookErrors.InsufficientLiquidity());
813:             if (_type == OrderBookType.NATIVE_IN_BASE && !_isMargin) {
814:                 uint256 _refund = _sizePrecisionToBaseAssetPrecision(_size);
815:                 _handleNativeMarketRefundTransfer(_refund);
816:             } else {
817:                 marginAccount.creditUser(_msgSender(), baseAsset, _sizePrecisionToBaseAssetPrecision(_size), _isMargin);
818:             }
819:         } else if (_type == OrderBookType.NATIVE_IN_BASE) {
820:             address(marginAccount).safeTransferETH(msg.value);
821:         }
822:         require(_quoteCredited >= _minAmountOut, OrderBookErrors.SlippageExceeded());
823:         return _quoteCredited;
824:     }
```
['[1337](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L1337-L1338)']
```solidity
1337:     function _getOBAsk() internal view returns (uint256) { // <= FOUND
1338:         uint32 firstLeft = TreeMath.findFirstLeft(s_sellTree, 0); // <= FOUND
1339:         if (firstLeft != 0) {
1340:             return firstLeft * vaultPricePrecision / pricePrecision;
1341:         }
1342:         return type(uint256).max;
1343:     }
```
['[1353](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L1353-L1354)']
```solidity
1353:     function bestAsk() internal view returns (bool, uint256) { // <= FOUND
1354:         uint256 firstLeft = TreeMath.findFirstLeft(s_sellTree, 0) * vaultPricePrecision / pricePrecision; // <= FOUND
1355:         if (firstLeft != 0) {
1356:             if (vaultBestAsk != type(uint256).max) {
1357:                 if (firstLeft == vaultBestAsk) {
1358:                     return (false, firstLeft);
1359:                 }
1360:                 return (FixedPointMathLib.min(firstLeft, vaultBestAsk)) == vaultBestAsk
1361:                     ? (true, vaultBestAsk)
1362:                     : (false, firstLeft);
1363:             }
1364:             return (false, firstLeft);
1365:         }
1366:         return (vaultBestAsk != type(uint256).max) ? (true, vaultBestAsk) : (false, 0);
1367:     }
```
['[65](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/periphery/MonadDeployer.sol#L65-L94)']
```solidity
65:     function deployTokenAndMarket( // <= FOUND
66:         TokenParams memory tokenParams,
67:         MarketParams memory marketParams,
68:         bytes calldata metadata
69:     ) external payable returns (address market) {
70:         KuruERC20 token = new KuruERC20(tokenParams.name, tokenParams.symbol, tokenParams.initialSupply, address(this));
71:         market = router.deployProxy(
72:             IOrderBook.OrderBookType.NATIVE_IN_QUOTE,
73:             address(token),
74:             address(0),
75:             marketParams.sizePrecision,
76:             marketParams.pricePrecision,
77:             marketParams.tickSize,
78:             marketParams.minSize,
79:             marketParams.maxSize,
80:             marketParams.takerFeeBps,
81:             marketParams.makerFeeBps,
82:             kuruAmmSpread
83:         );
84:         if (msg.value != (marketParams.nativeTokenAmount + kuruCollectiveFee)) {
85:             revert InsufficientAssets(marketParams.nativeTokenAmount + kuruCollectiveFee, msg.value);
86:         }
87:         (address vault,,,,,,,) = IOrderBook(market).getVaultParams();
88:         uint256 _supplyToVault = tokenParams.initialSupply * (10 ** 4 - tokenParams.supplyToDev) / 10 ** 4;
89:         token.approve(vault, _supplyToVault);
90:         IKuruAMMVault(vault).deposit{value: marketParams.nativeTokenAmount}(
91:             _supplyToVault, marketParams.nativeTokenAmount, address(this)
92:         );
93:         token.transfer(tokenParams.dev, tokenParams.initialSupply - _supplyToVault);
94:         marginAccount.deposit{value: kuruCollectiveFee}(kuruCollective, address(0), kuruCollectiveFee); // <= FOUND
95:         emit PumpingTime(
96:             address(token),
97:             tokenParams.tokenURI,
98:             tokenParams.dev,
99:             tokenParams.initialSupply - _supplyToVault,
100:             market,
101:             metadata
102:         );
103:     }
```
['[74](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L74-L118)']
```solidity
74:     function deployProxy( // <= FOUND
75:         IOrderBook.OrderBookType _type,
76:         address _baseAssetAddress,
77:         address _quoteAssetAddress,
78:         uint96 _sizePrecision,
79:         uint32 _pricePrecision,
80:         uint32 _tickSize,
81:         uint96 _minSize,
82:         uint96 _maxSize,
83:         uint256 _takerFeeBps,
84:         uint256 _makerFeeBps,
85:         uint96 _kuruAmmSpread
86:     ) public returns (address proxy) {
87:         if (_type == IOrderBook.OrderBookType.NATIVE_IN_BASE) {
88:             require(_baseAssetAddress == address(0), RouterErrors.MarketTypeMismatch());
89:             require(_quoteAssetAddress != address(0), RouterErrors.MarketTypeMismatch());
90:         } else if (_type == IOrderBook.OrderBookType.NATIVE_IN_QUOTE) {
91:             require(_baseAssetAddress != address(0), RouterErrors.MarketTypeMismatch());
92:             require(_quoteAssetAddress == address(0), RouterErrors.MarketTypeMismatch());
93:         } else {
94:             require(_baseAssetAddress != address(0), RouterErrors.MarketTypeMismatch());
95:             require(_quoteAssetAddress != address(0), RouterErrors.MarketTypeMismatch());
96:             require(_baseAssetAddress != _quoteAssetAddress, RouterErrors.BaseAndQuoteAssetSame());
97:         }
98:         require(_tickSize > 0, RouterErrors.InvalidTickSize());
99:         require(10 ** Math.log10(_sizePrecision) == _sizePrecision, RouterErrors.InvalidSizePrecision());
100:         require(10 ** Math.log10(_pricePrecision) == _pricePrecision, RouterErrors.InvalidPricePrecision());
101:         uint256 _baseAssetDecimals =
102:             _type == IOrderBook.OrderBookType.NATIVE_IN_BASE ? 18 : IERC20Metadata(_baseAssetAddress).decimals();
103:         uint256 _quoteAssetDecimals =
104:             _type == IOrderBook.OrderBookType.NATIVE_IN_QUOTE ? 18 : IERC20Metadata(_quoteAssetAddress).decimals();
105:         {
106:             bytes32 _salt = _getSalt(
107:                 _baseAssetAddress,
108:                 _quoteAssetAddress,
109:                 _sizePrecision,
110:                 _pricePrecision,
111:                 _tickSize,
112:                 _minSize,
113:                 _maxSize,
114:                 _takerFeeBps,
115:                 _makerFeeBps,
116:                 _kuruAmmSpread
117:             );
118:             proxy = Create2.deploy( // <= FOUND
119:                 0,
120:                 _salt,
121:                 abi.encodePacked(type(ERC1967Proxy).creationCode, abi.encode(orderBookImplementation, bytes("")))
122:             );
123:         }
124:         IKuruAMMVault _kuruAmmVault = IKuruAMMVault(
125:             Create2.deploy(
126:                 0,
127:                 keccak256(abi.encode(proxy)),
128:                 abi.encodePacked(type(ERC1967Proxy).creationCode, abi.encode(kuruAmmVaultImplementation, bytes("")))
129:             )
130:         );
131: 
132:         verifiedMarket[proxy] = MarketParams(
133:             _pricePrecision,
134:             _sizePrecision,
135:             _baseAssetAddress,
136:             _baseAssetDecimals,
137:             _quoteAssetAddress,
138:             _quoteAssetDecimals,
139:             _tickSize,
140:             _minSize,
141:             _maxSize,
142:             _takerFeeBps,
143:             _makerFeeBps
144:         );
145:         IMarginAccount(marginAccountAddress).updateMarkets(proxy);
146:         {
147:             IOrderBook(proxy).initialize(
148:                 address(this),
149:                 _type,
150:                 _baseAssetAddress,
151:                 _baseAssetDecimals,
152:                 _quoteAssetAddress,
153:                 _quoteAssetDecimals,
154:                 marginAccountAddress,
155:                 _sizePrecision,
156:                 _pricePrecision,
157:                 _tickSize,
158:                 _minSize,
159:                 _maxSize,
160:                 _takerFeeBps,
161:                 _makerFeeBps,
162:                 address(_kuruAmmVault),
163:                 _kuruAmmSpread,
164:                 TRUSTED_FORWARDER
165:             );
166:         }
167: 
168:         _kuruAmmVault.initialize(
169:             address(this), _baseAssetAddress, _quoteAssetAddress, marginAccountAddress, proxy, _kuruAmmSpread
170:         );
171: 
172:         _setApprovalsForMarket(_baseAssetAddress, _quoteAssetAddress, proxy, _type);
173: 
174:         emit MarketRegistered(
175:             _baseAssetAddress,
176:             _quoteAssetAddress,
177:             proxy,
178:             address(_kuruAmmVault),
179:             _pricePrecision,
180:             _sizePrecision,
181:             _tickSize,
182:             _minSize,
183:             _maxSize,
184:             _takerFeeBps,
185:             _makerFeeBps,
186:             _kuruAmmSpread
187:         );
188: 
189:         return proxy;
190:     }
```
['[331](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L331-L357)']
```solidity
331:     function anyToAnySwap( // <= FOUND
332:         address[] calldata _marketAddresses,
333:         bool[] calldata _isBuy,
334:         bool[] calldata _nativeSend,
335:         address _debitToken,
336:         address _creditToken,
337:         uint256 _amount,
338:         uint256 _minAmountOut
339:     ) external payable returns (uint256 _amountOut) {
340:         require(_marketAddresses.length >= 1, RouterErrors.NoMarketsPassed());
341:         require(_isBuy.length == _marketAddresses.length, RouterErrors.LengthMismatch());
342:         require(_nativeSend.length == _marketAddresses.length, RouterErrors.LengthMismatch());
343:         if (_nativeSend[0] == false) {
344:             _debitToken.safeTransferFrom(msg.sender, address(this), _amount);
345:         }
346:         uint256 _cachedAmountIn = _amount;
347: 
348:         for (uint256 i = 0; i < _marketAddresses.length; i++) {
349:             address _currentMarket = _marketAddresses[i];
350:             MarketParams memory _marketParams = verifiedMarket[_currentMarket];
351:             require(_marketParams.pricePrecision > 0, RouterErrors.InvalidMarket());
352:             IOrderBook market = IOrderBook(_currentMarket);
353:             uint256 _value = _nativeSend[i] ? _amount : 0;
354:             _amountOut = _isBuy[i]
355:                 ? (
356:                     market.placeAndExecuteMarketBuy{value: _value}(
357:                         toU96(_amount * _marketParams.pricePrecision / 10 ** _marketParams.quoteAssetDecimals), // <= FOUND
358:                         0,
359:                         false,
360:                         true
361:                     )
362:                 )
363:                 : market.placeAndExecuteMarketSell{value: _value}(
364:                     toU96(_amount * _marketParams.sizePrecision / 10 ** _marketParams.baseAssetDecimals), 0, false, true
365:                 );
366: 
367:             _amount = _amountOut;
368:         }
369:         require(_amountOut >= _minAmountOut, RouterErrors.SlippageExceeded());
370:         emit KuruRouterSwap(msg.sender, _debitToken, _creditToken, _cachedAmountIn, _amountOut);
371:         if (_creditToken != address(0)) {
372:             _creditToken.safeTransfer(msg.sender, _amountOut);
373:         } else {
374:             msg.sender.safeTransferETH(_amountOut);
375:         }
376:     }
```


</details>

## [NonCritical-33] Use of non-named numeric constants

### Resolution 
Magic numbers should be avoided in Solidity code to enhance readability, maintainability, and reduce the likelihood of errors. Magic numbers are hard-coded values with no clear meaning or context, which can create confusion and make the code harder to understand for developers. Using well-defined constants or variables with descriptive names instead of magic numbers not only clarifies the purpose and significance of the value but also simplifies code updates and modifications.

Num of instances: 71

### Findings 


<details><summary>Click to show findings</summary>

['[243](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/AbstractAMM.sol#L243-L243)']
```solidity
243:         returnData = abi.encode(
244:             kuruAmmVault, _getQuoteAsset(), _fundsOwed * 10 ** _getQuoteAssetDecimals() / vaultPricePrecision, true
245:         );
```
['[246](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/AbstractAMM.sol#L246-L246)']
```solidity
246:         uint256 feeRebate =
247:             ((_sizeFilled * 10 ** _getBaseAssetDecimals() / _getSizePrecision()) * _getMakerFeeBps()) / BPS_MULTIPLIER;
```
['[264](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/AbstractAMM.sol#L264-L264)']
```solidity
264:         returnData = abi.encode(
265:             kuruAmmVault, _getBaseAsset(), _sizeOwedToVault * 10 ** _getBaseAssetDecimals() / _getSizePrecision(), true
266:         );
```
['[267](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/AbstractAMM.sol#L267-L267)']
```solidity
267:         uint256 feeRebate = (
268:             (_fundsOwedToUser * 10 ** _getQuoteAssetDecimals() / vaultPricePrecision) * _getMakerFeeBps()
269:         ) / BPS_MULTIPLIER;
```
['[55](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L55-L55)']
```solidity
55:         token1Decimals = token1_ != address(0) ? ERC20(token1_).decimals() : 18;
```
['[57](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L57-L57)']
```solidity
57:         token2Decimals = token2_ != address(0) ? ERC20(token2_).decimals() : 18;
```
['[179](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L179-L179)']
```solidity
179:             uint256 _expectedQuoteAmount = (
180:                 (
181:                     FixedPointMathLib.mulDivUp(baseDeposit, _currentAskPrice, vaultPricePrecision)
182:                         * 10 ** marketParams.quoteAssetDecimals
183:                 )
184:             ) / 10 ** marketParams.baseAssetDecimals;
```
['[194](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L194-L194)']
```solidity
194:             _currentAskPrice = (
195:                 ((quoteDeposit * 10 ** marketParams.baseAssetDecimals)) * vaultPricePrecision
196:                     / 10 ** marketParams.quoteAssetDecimals
197:             ) / (baseDeposit);
```
['[331](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L331-L331)']
```solidity
331:         return ((_normalizedBaseAmount * 10 ** marketParams.baseAssetDecimals) / marketParams.sizePrecision, _price);
```
['[364](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L364-L364)']
```solidity
364:             _quoteAmount = (
365:                 (
366:                     FixedPointMathLib.mulDivUp(_baseAmount, _currentAskPrice, vaultPricePrecision)
367:                         * 10 ** marketParams.quoteAssetDecimals
368:                 )
369:             ) / 10 ** marketParams.baseAssetDecimals;
```
['[433](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L433-L433)']
```solidity
433:         uint96 _newAskSize = toU96(
434:             (SPREAD_CONSTANT * _baseAmount * _marketParams.sizePrecision)
435:                 / ((DOUBLE_BPS_MULTIPLIER + SPREAD_CONSTANT) * 10 ** _marketParams.baseAssetDecimals)
436:         );
```
['[437](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L437-L437)']
```solidity
437:         uint96 _newBidSize = toU96(
438:             (SPREAD_CONSTANT * _baseAmount * _marketParams.sizePrecision)
439:                 / (DOUBLE_BPS_MULTIPLIER * 10 ** _marketParams.baseAssetDecimals)
440:         );
```
['[450](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L450-L450)']
```solidity
450:         uint256 _halfTotalValuationInQuote = (
451:             (_reserve1 * _vaultPrice * 10 ** _marketParams.quoteAssetDecimals)
452:                 / (10 ** _marketParams.baseAssetDecimals * vaultPricePrecision) + _reserve2
453:         ) / 2;
```
['[454](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L454-L454)']
```solidity
454:         uint256 _rebalancedBaseAsset = (
455:             _halfTotalValuationInQuote * vaultPricePrecision * 10 ** _marketParams.baseAssetDecimals
456:         ) / (10 ** _marketParams.quoteAssetDecimals * _vaultPrice);
```
['[212](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L212-L212)']
```solidity
212:                 
213:                 
214:                 if iszero(slt(x, 135305999368893231589)) {
```
['[221](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L221-L221)']
```solidity
221:             
222:             
223:             
224:             x = (x << 78) / 5 ** 18;
```
['[233](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L233-L233)']
```solidity
233:             
234: 
235:             
236:             
237:             int256 y = x + 1346386616545796478920950773328;
```
['[244](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L244-L244)']
```solidity
244:             q = ((q * x) >> 96) - 14423608567350463180887372962807573;
```
['[726](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L726-L726)']
```solidity
726:             if (x <= type(uint256).max / 10 ** 18) return sqrt(x * 10 ** 18);
```
['[727](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L727-L727)']
```solidity
727:             z = (1 + sqrt(x)) * 10 ** 9;
```
['[741](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L741-L741)']
```solidity
741:             if (x <= type(uint256).max / 10 ** 36) return cbrt(x * 10 ** 36);
```
['[742](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L742-L742)']
```solidity
742:             z = (1 + cbrt(x)) * 10 ** 12;
```
['[743](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L743-L743)']
```solidity
743:             z = (fullMulDivUnchecked(x, 10 ** 36, z * z) + z + z) / 3;
```
['[810](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L810-L810)']
```solidity
810:             if iszero(lt(x, 100000000000000000000000000000000000000)) {
```
['[814](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L814-L814)']
```solidity
814:             if iszero(lt(x, 100000000000000000000)) {
```
['[818](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L818-L818)']
```solidity
818:             if iszero(lt(x, 10000000000)) {
```
['[822](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L822-L822)']
```solidity
822:             if iszero(lt(x, 100000)) {
```
['[870](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L870-L870)']
```solidity
870:                 if iszero(mod(mantissa, 1000000000000000000000000000000000)) {
```
['[874](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L874-L874)']
```solidity
874:                 if iszero(mod(mantissa, 10000000000000000000)) {
```
['[878](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L878-L878)']
```solidity
878:                 if iszero(mod(mantissa, 1000000000000)) {
```
['[882](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L882-L882)']
```solidity
882:                 if iszero(mod(mantissa, 1000000)) {
```
['[886](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L886-L886)']
```solidity
886:                 if iszero(mod(mantissa, 10000)) {
```
['[890](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L890-L890)']
```solidity
890:                 if iszero(mod(mantissa, 100)) {
```
['[894](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L894-L894)']
```solidity
894:                 if iszero(mod(mantissa, 10)) {
```
['[925](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L925-L925)']
```solidity
925:             unpacked = (packed >> 7) * 10 ** (packed & 0x7f);
```
['[141](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L141-L141)']
```solidity
141:             (address _user, address _token, uint256 _amount, bool _useMargin) =
142:                 abi.decode(_encodedData[offset:offset + 128], (address, address, uint256, bool));
```
['[143](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L143-L143)']
```solidity
143:             offset += 128;
```
['[107](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L107-L107)']
```solidity
107:         require(_kuruAmmSpread % 10 == 0 && _kuruAmmSpread > 0 && _kuruAmmSpread < 500, OrderBookErrors.InvalidSpread());
```
['[88](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/periphery/MonadDeployer.sol#L88-L88)']
```solidity
88:         uint256 _supplyToVault = tokenParams.initialSupply * (10 ** 4 - tokenParams.supplyToDev) / 10 ** 4;
```
['[101](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L101-L101)']
```solidity
101:         uint256 _baseAssetDecimals =
102:             _type == IOrderBook.OrderBookType.NATIVE_IN_BASE ? 18 : IERC20Metadata(_baseAssetAddress).decimals();
```
['[103](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L103-L103)']
```solidity
103:         uint256 _quoteAssetDecimals =
104:             _type == IOrderBook.OrderBookType.NATIVE_IN_QUOTE ? 18 : IERC20Metadata(_quoteAssetAddress).decimals();
```
['[354](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L354-L354)']
```solidity
354:             _amountOut = _isBuy[i]
355:                 ? (
356:                     market.placeAndExecuteMarketBuy{value: _value}(
357:                         toU96(_amount * _marketParams.pricePrecision / 10 ** _marketParams.quoteAssetDecimals),
358:                         0,
359:                         false,
360:                         true
361:                     )
362:                 )
363:                 : market.placeAndExecuteMarketSell{value: _value}(
364:                     toU96(_amount * _marketParams.sizePrecision / 10 ** _marketParams.baseAssetDecimals), 0, false, true
365:                 );
```
['[39](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/ERC2771Context.sol#L39-L39)']
```solidity
39:         return 20;
```
['[226](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L226-L226)']
```solidity
226:             
227:             
228:             
229:             int256 k = ((x << 96) / 54916777467707473351141471128 + 2 ** 95) >> 96;
```
['[236](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L236-L236)']
```solidity
236:             p = ((p * y) >> 96) + 28719021644029726153956944680412240;
```
['[240](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L240-L240)']
```solidity
240:             
241:             int256 q = x - 2855989394907223263936484059900;
```
['[245](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L245-L245)']
```solidity
245:             q = ((q * x) >> 96) + 26449188498355588339934803723976023;
```
['[571](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L571-L571)']
```solidity
571:         return (value * multiplier + divisor / 2) / divisor;
```
['[243](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L243-L243)']
```solidity
243:             q = ((q * x) >> 96) + 3604857256930695427073651918091429;
```
['[263](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L263-L263)']
```solidity
263:             
264: 
265:             
266:             
267:             
268:             
269:             
270:             
271:             r = int256((uint256(r) * 3822833074963236453042738258902158003155416615667) >> uint256(195 - k));
```
['[227](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L227-L227)']
```solidity
227:             x = x - k * 54916777467707473351141471128;
```
['[234](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L234-L234)']
```solidity
234:             y = ((y * x) >> 96) + 57155421227552351082224309758442;
```
['[241](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L241-L241)']
```solidity
241:             q = ((q * x) >> 96) + 50020603652535783019961831881945;
```
['[242](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L242-L242)']
```solidity
242:             q = ((q * x) >> 96) - 533845033583426703283633433725380;
```
['[360](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L360-L360)']
```solidity
360:             } else if (uint256(w >> 63) == uint256(0)) {
```
['[29](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/TreeMath.sol#L29-L29)']
```solidity
29:         bytes32 key3 = bytes32(uint256(id) >> 8);
```
['[38](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/TreeMath.sol#L38-L38)']
```solidity
38:                 bytes32 key2 = key3 >> 8;
```
['[44](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/TreeMath.sol#L44-L44)']
```solidity
44:                     bytes32 key1 = key2 >> 8;
```
['[118](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/TreeMath.sol#L118-L118)']
```solidity
118:             if (closestBit != type(uint256).max) return uint32((uint256(key3) << 8) | closestBit);
```
['[38](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/TreeMath.sol#L38-L38)']
```solidity
38:         bytes32 key2 = key3 >> 8;
```
['[129](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/TreeMath.sol#L129-L129)']
```solidity
129:                 key3 = bytes32((uint256(key2) << 8) | closestBit);
```
['[132](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/TreeMath.sol#L132-L132)']
```solidity
132:                 return uint32((uint256(key3) << 8) | uint256(leaves).mostSignificantBit());
```
['[44](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/TreeMath.sol#L44-L44)']
```solidity
44:         bytes32 key1 = key2 >> 8;
```
['[144](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/TreeMath.sol#L144-L144)']
```solidity
144:                 key2 = bytes32((uint256(key1) << 8) | closestBit);
```
['[147](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/TreeMath.sol#L147-L147)']
```solidity
147:                 key3 = bytes32((uint256(key2) << 8) | uint256(leaves).mostSignificantBit());
```
['[164](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/TreeMath.sol#L164-L164)']
```solidity
164:                 key2 = bytes32((uint256(key1) << 8) | uint256(leaves).mostSignificantBit());
```
['[208](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/TreeMath.sol#L208-L208)']
```solidity
208:                 return uint32((uint256(key3) << 8) | uint256(leaves).leastSignificantBit());
```
['[223](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/TreeMath.sol#L223-L223)']
```solidity
223:                 key3 = bytes32((uint256(key2) << 8) | uint256(leaves).leastSignificantBit());
```
['[240](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/TreeMath.sol#L240-L240)']
```solidity
240:                 key2 = bytes32((uint256(key1) << 8) | uint256(leaves).leastSignificantBit());
```
['[235](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L235-L235)']
```solidity
235:             int256 p = y + x - 94201549194550492254356042504812;
```
['[237](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L237-L237)']
```solidity
237:             p = p * x + (4385272521454847904659076985693276 << 96);
```


</details>

## [NonCritical-34] Long powers of ten should use scientific notation 1eX

### Resolution 
A large number such as 1000000 is far more readable as 1e6, this will help prevent unintended bugs in the code

Num of instances: 21

### Findings 


<details><summary>Click to show findings</summary>

['[20](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/AbstractAMM.sol#L20-L20)']
```solidity
20:     uint256 constant BPS_MULTIPLIER = 10000; // <= FOUND
```
['[751](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L751-L751)']
```solidity
751:                         p := mul(p, 100000000000000000)  // <= FOUND
752:                         break
753:                     }
```
['[754](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L754-L754)']
```solidity
754:                     p := mul(p, 100000000)  // <= FOUND
755:                     break
756:                 }
```
['[810](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L810-L810)']
```solidity
810:             if iszero(lt(x, 100000000000000000000000000000000000000)) { // <= FOUND
```
['[811](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L811-L811)']
```solidity
811:                 x := div(x, 100000000000000000000000000000000000000) // <= FOUND
812:                 r := 38
813:             }
```
['[814](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L814-L814)']
```solidity
814:             if iszero(lt(x, 100000000000000000000)) { // <= FOUND
```
['[815](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L815-L815)']
```solidity
815:                 x := div(x, 100000000000000000000) // <= FOUND
816:                 r := add(r, 20)
817:             }
```
['[818](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L818-L818)']
```solidity
818:             if iszero(lt(x, 10000000000)) { // <= FOUND
```
['[819](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L819-L819)']
```solidity
819:                 x := div(x, 10000000000) // <= FOUND
820:                 r := add(r, 10)
821:             }
```
['[822](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L822-L822)']
```solidity
822:             if iszero(lt(x, 100000)) { // <= FOUND
```
['[823](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L823-L823)']
```solidity
823:                 x := div(x, 100000) // <= FOUND
824:                 r := add(r, 5)
825:             }
```
['[870](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L870-L870)']
```solidity
870:                 if iszero(mod(mantissa, 1000000000000000000000000000000000)) { // <= FOUND
```
['[871](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L871-L871)']
```solidity
871:                     mantissa := div(mantissa, 1000000000000000000000000000000000) // <= FOUND
872:                     exponent := 33
873:                 }
```
['[874](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L874-L874)']
```solidity
874:                 if iszero(mod(mantissa, 10000000000000000000)) { // <= FOUND
```
['[875](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L875-L875)']
```solidity
875:                     mantissa := div(mantissa, 10000000000000000000) // <= FOUND
876:                     exponent := add(exponent, 19)
877:                 }
```
['[878](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L878-L878)']
```solidity
878:                 if iszero(mod(mantissa, 1000000000000)) { // <= FOUND
```
['[879](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L879-L879)']
```solidity
879:                     mantissa := div(mantissa, 1000000000000) // <= FOUND
880:                     exponent := add(exponent, 12)
881:                 }
```
['[882](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L882-L882)']
```solidity
882:                 if iszero(mod(mantissa, 1000000)) { // <= FOUND
```
['[883](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L883-L883)']
```solidity
883:                     mantissa := div(mantissa, 1000000) // <= FOUND
884:                     exponent := add(exponent, 6)
885:                 }
```
['[886](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L886-L886)']
```solidity
886:                 if iszero(mod(mantissa, 10000)) { // <= FOUND
```
['[887](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L887-L887)']
```solidity
887:                     mantissa := div(mantissa, 10000) // <= FOUND
888:                     exponent := add(exponent, 4)
889:                 }
```


</details>

## [NonCritical-35] Redundant else statement

Num of instances: 7

### Findings 


<details><summary>Click to show findings</summary>

[]
```solidity
350:     function _convertToAssets(uint256 shares, bool isDeposit)
351:         internal
352:         view
353:         returns (uint256 _baseAmount, uint256 _quoteAmount)
354:     {
355:         if (isDeposit) {
356:             if (totalSupply() == 0) {
357:                 return (0, 0);
358:             }
359:             (uint256 _baseReserve, uint256 _quoteReserve) = totalAssets();
360:             (, uint256 _currentAskPrice) = _returnNormalizedAmountAndPrice(true);
361:             (_baseReserve, _quoteReserve) =
362:                 _returnVirtuallyRebalancedTotalAssets(_baseReserve, _quoteReserve, _currentAskPrice);
363:             _baseAmount = FixedPointMathLib.mulDiv(shares, _baseReserve, totalSupply());
364:             _quoteAmount = (
365:                 (
366:                     FixedPointMathLib.mulDivUp(_baseAmount, _currentAskPrice, vaultPricePrecision)
367:                         * 10 ** marketParams.quoteAssetDecimals
368:                 )
369:             ) / 10 ** marketParams.baseAssetDecimals;
370:             return (_baseAmount, _quoteAmount);
371:         } else {
372:             (_baseAmount, _quoteAmount,,,) = _convertToAssetsWithNewSize(shares);
373:         }
374:     }
```
[]
```solidity
376:     function _convertToAssetsWithNewSize(uint256 shares)
377:         internal
378:         view
379:         returns (uint256, uint256, uint96, uint96, bool)
380:     {
381:         (uint256 _baseAmount,) = _returnNormalizedAmountAndPrice(false);
382:         uint256 _baseAmountAfterRemoval = _baseAmount - FixedPointMathLib.mulDiv(shares, _baseAmount, totalSupply());
383:         (uint96 _newAskSize, uint96 _newBidSize) = _getVaultSizesForBaseAmount(_baseAmountAfterRemoval);
384:         (
385:             ,
386:             uint256 _vaultBestBid,
387:             uint96 _partiallyFilledBidSize,
388:             uint256 _vaultBestAsk,
389:             uint96 _partiallyFilledAskSize,
390:             ,
391:             ,
392:         ) = market.getVaultParams();
393:         MarketParams memory _marketParams = marketParams;
394:         (uint256 _reserveBase, uint256 _reserveQuote) = totalAssets();
395:         if (_partiallyFilledAskSize > _newAskSize || _partiallyFilledBidSize > _newBidSize) {
396:             int256 _baseOwedToVault = (
397:                 int256(uint256(_partiallyFilledAskSize)) - int256(uint256(_partiallyFilledBidSize))
398:             ) * int256(10 ** _marketParams.baseAssetDecimals) / int256(uint256(_marketParams.sizePrecision));
399:             int256 _quoteOwedToVault = (
400:                 int256(FixedPointMathLib.mulDivUp(_partiallyFilledBidSize, _vaultBestBid, _marketParams.sizePrecision))
401:                     - int256(FixedPointMathLib.mulDiv(_partiallyFilledAskSize, _vaultBestAsk, _marketParams.sizePrecision))
402:             ) * int256(10 ** _marketParams.quoteAssetDecimals) / int256(vaultPricePrecision);
403:             uint256 _baseOwedToUser;
404:             uint256 _quoteOwedToUser;
405:             if (_baseOwedToVault < 0) {
406:                 _reserveBase = _reserveBase - (uint256(-1 * _baseOwedToVault));
407:                 _baseOwedToUser =
408:                     FixedPointMathLib.mulDiv(shares, _reserveBase, totalSupply()) + uint256(-1 * _baseOwedToVault);
409:             } else {
410:                 _reserveBase = _reserveBase + (uint256(_baseOwedToVault));
411:                 _baseOwedToUser =
412:                     FixedPointMathLib.mulDiv(shares, _reserveBase, totalSupply()) - uint256(_baseOwedToVault);
413:             }
414:             if (_quoteOwedToVault < 0) {
415:                 _reserveQuote = _reserveQuote - (uint256(-1 * _quoteOwedToVault));
416:                 _quoteOwedToUser =
417:                     FixedPointMathLib.mulDiv(shares, _reserveQuote, totalSupply()) + uint256(-1 * _quoteOwedToVault);
418:             } else {
419:                 _reserveQuote = _reserveQuote + (uint256(_quoteOwedToVault));
420:                 _quoteOwedToUser =
421:                     FixedPointMathLib.mulDiv(shares, _reserveQuote, totalSupply()) - uint256(_quoteOwedToVault);
422:             }
423:             return (_baseOwedToUser, _quoteOwedToUser, _newAskSize, _newBidSize, true);
424:         } else {
425:             uint256 _baseOwedToUser = FixedPointMathLib.mulDiv(shares, _reserveBase, totalSupply());
426:             uint256 _quoteOwedToUser = FixedPointMathLib.mulDiv(shares, _reserveQuote, totalSupply());
427:             return (_baseOwedToUser, _quoteOwedToUser, _newAskSize, _newBidSize, false);
428:         }
429:     }
```
['[15](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/ERC2771Context.sol#L15-L15)']
```solidity
15:     function _msgData() internal view returns (bytes calldata) { // <= FOUND
16:         uint256 calldataLength = msg.data.length;
17:         uint256 contextSuffixLength = _contextSuffixLength();
18:         if (isTrustedForwarder(msg.sender) && calldataLength >= contextSuffixLength) {
19:             return msg.data[:calldataLength - contextSuffixLength];
20:         } else {
21:             return msg.data;
22:         }
23:     }
```
['[25](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/ERC2771Context.sol#L25-L25)']
```solidity
25:     function _msgSender() internal view returns (address) { // <= FOUND
26:         uint256 calldataLength = msg.data.length;
27:         uint256 contextSuffixLength = _contextSuffixLength();
28:         if (isTrustedForwarder(msg.sender) && calldataLength >= contextSuffixLength) {
29:             return address(bytes20(msg.data[calldataLength - contextSuffixLength:]));
30:         } else {
31:             return msg.sender;
32:         }
33:     }
```
['[586](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L586-L586)']
```solidity
586:     function _checkIfCancelledOrFilled(uint40 _orderId, Order memory _order) internal view returns (bool) { // <= FOUND
587:         if (_order.prev != OrderLinkedList.NULL) {
588:             if (s_orders[_order.prev].next != _orderId) {
589:                 return true;
590:             }
591:             if (_order.isBuy) {
592:                 
593:                 uint40 _head = s_buyPricePoints[_order.price].head;
594:                 if (_head > _orderId || _head == OrderLinkedList.NULL) {
595:                     return true;
596:                 }
597:                 return false;
598:             } else {
599:                 uint40 _head = s_sellPricePoints[_order.price].head;
600:                 if (_head > _orderId || _head == OrderLinkedList.NULL) {
601:                     return true;
602:                 }
603:                 return false;
604:             }
605:         } else {
606:             if (_order.isBuy) {
607:                 if (s_buyPricePoints[_order.price].head != _orderId) {
608:                     return true;
609:                 }
610:                 return false;
611:             } else {
612:                 if (s_sellPricePoints[_order.price].head != _orderId) {
613:                     return true;
614:                 }
615:                 return false;
616:             }
617:         }
618:     }
```
[]
```solidity
728:     function placeAndExecuteMarketBuy(uint96 _quoteSize, uint256 _minAmountOut, bool _isMargin, bool _isFillOrKill)
729:         public
730:         payable
731:         override
732:         marketActive
733:         nonReentrant
734:         returns (uint256)
735:     {
736:         OrderBookType _type = orderBookType;
737: 
738:         if (_type == OrderBookType.NATIVE_IN_QUOTE && !_isMargin && (msg.sender != address(0))) {
739:             require(
740:                 msg.value >= _pricePrecisionToQuoteAssetPrecision(_quoteSize), OrderBookErrors.NativeAssetInsufficient()
741:             );
742:             require(
743:                 msg.value < _pricePrecisionToQuoteAssetPrecision(_quoteSize + 1), OrderBookErrors.NativeAssetSurplus()
744:             );
745:         } else if (msg.sender != address(0)) {
746:             require(msg.value == 0, OrderBookErrors.NativeAssetNotRequired());
747:             _isMargin
748:                 ? marginAccount.debitUser(_msgSender(), quoteAsset, _pricePrecisionToQuoteAssetPrecision(_quoteSize))
749:                 : quoteAsset.safeTransferFrom(
750:                     _msgSender(), address(marginAccount), _pricePrecisionToQuoteAssetPrecision(_quoteSize)
751:                 );
752:         }
753: 
754:         uint256 _baseTokensCredited;
755:         (_quoteSize, _baseTokensCredited) = _marketBuyMatch(_quoteSize, _isMargin);
756:         if (msg.sender == address(0)) {
757:             return _baseTokensCredited;
758:         }
759:         if (_quoteSize > 0) {
760:             require(!_isFillOrKill, OrderBookErrors.InsufficientLiquidity());
761:             if (_type == OrderBookType.NATIVE_IN_QUOTE && !_isMargin) {
762:                 
763:                 uint256 _refund = _pricePrecisionToQuoteAssetPrecision(_quoteSize);
764:                 _handleNativeMarketRefundTransfer(_refund);
765:             } else {
766:                 marginAccount.creditUser(
767:                     _msgSender(), quoteAsset, _pricePrecisionToQuoteAssetPrecision(_quoteSize), _isMargin
768:                 );
769:             }
770:         } else if (_type == OrderBookType.NATIVE_IN_QUOTE) {
771:             address(marginAccount).safeTransferETH(msg.value);
772:         }
773:         require(_baseTokensCredited >= _minAmountOut, OrderBookErrors.SlippageExceeded());
774: 
775:         return _baseTokensCredited;
776:     }
```
[]
```solidity
786:     function placeAndExecuteMarketSell(uint96 _size, uint256 _minAmountOut, bool _isMargin, bool _isFillOrKill)
787:         public
788:         payable
789:         marketActive
790:         nonReentrant
791:         returns (uint256)
792:     {
793:         OrderBookType _type = orderBookType;
794:         if (_type == OrderBookType.NATIVE_IN_BASE && !_isMargin && (msg.sender != address(0))) {
795:             require(msg.value >= _sizePrecisionToBaseAssetPrecision(_size), OrderBookErrors.NativeAssetInsufficient());
796:             require(msg.value < _sizePrecisionToBaseAssetPrecision(_size + 1), OrderBookErrors.NativeAssetSurplus());
797:         } else if (msg.sender != address(0)) {
798:             require(msg.value == 0, OrderBookErrors.NativeAssetNotRequired());
799:             _isMargin
800:                 ? marginAccount.debitUser(_msgSender(), baseAsset, _sizePrecisionToBaseAssetPrecision(_size))
801:                 : baseAsset.safeTransferFrom(
802:                     _msgSender(), address(marginAccount), _sizePrecisionToBaseAssetPrecision(_size)
803:                 );
804:         }
805: 
806:         uint256 _quoteCredited;
807:         (_size, _quoteCredited) = _matchAggressiveSell(0, _size, _isMargin);
808:         if (msg.sender == address(0)) {
809:             return _quoteCredited;
810:         }
811:         if (_size > 0) {
812:             require(!_isFillOrKill, OrderBookErrors.InsufficientLiquidity());
813:             if (_type == OrderBookType.NATIVE_IN_BASE && !_isMargin) {
814:                 uint256 _refund = _sizePrecisionToBaseAssetPrecision(_size);
815:                 _handleNativeMarketRefundTransfer(_refund);
816:             } else {
817:                 marginAccount.creditUser(_msgSender(), baseAsset, _sizePrecisionToBaseAssetPrecision(_size), _isMargin);
818:             }
819:         } else if (_type == OrderBookType.NATIVE_IN_BASE) {
820:             address(marginAccount).safeTransferETH(msg.value);
821:         }
822:         require(_quoteCredited >= _minAmountOut, OrderBookErrors.SlippageExceeded());
823:         return _quoteCredited;
824:     }
```


</details>

## [NonCritical-36] Use immutable not constant for keccak state variables

### Resolution 
It's crucial to leverage the right features for the appropriate contexts in Solidity, despite the compiler's ability to correct common developer mistakes. Both `constant` and `immutable` variables have distinct uses. `Constant` variables are best suited for hard-coded, literal values within your contract, where the value doesn't need to be computed or modified. 

On the other hand, `immutable` variables are ideal for situations where the value might be the result of an expression or received from a constructor. While both serve to define unchanging variables, they function differently and their proper utilization contributes to clearer, more efficient code. Remember, even if the compiler can correct certain mistakes, best practices dictate using the correct feature for the task at hand.

Num of instances: 4

### Findings 


<details><summary>Click to show findings</summary>

[]
```solidity
bytes32 private constant _FORWARD_TYPEHASH = keccak256( "ForwardRequest(address from,address market,uint256 value,uint256 nonce,uint256 deadline,bytes4 selector,bytes data)" ); // <= FOUND
```
[]
```solidity
bytes32 private constant _PRICE_DEPENDENT_TYPEHASH = keccak256( "PriceDependentRequest(address from,address market,uint256 price,uint256 value,uint256 nonce,uint256 deadline,bool isBelowPrice,bytes4 selector,bytes data)" ); // <= FOUND
```
[]
```solidity
bytes32 private constant _CANCEL_PRICE_DEPENDENT_TYPEHASH = keccak256("CancelPriceDependentRequest(address from,uint256 nonce,uint256 deadline)"); // <= FOUND
```
[]
```solidity
bytes32 private constant _MARGIN_ACCOUNT_REQUEST_TYPEHASH = keccak256( "MarginAccountRequest(address from,address marginAccount,uint256 value,uint256 nonce,uint256 deadline,bytes4 selector,bytes data)" ); // <= FOUND
```


</details>

## [NonCritical-37] Two or more functions contain the exact same code

### Resolution 
In Solidity programming, duplicate code in multiple functions introduces potential security risks and maintainability issues. It magnifies the impact of any bugs or vulnerabilities, since developers must fix these in every location where the code is replicated. Overlooking any instance of replicated code could leave vulnerabilities intact. Furthermore, code duplication leads to contract bloating, diminishing the readability and manageability of the code. Future logic changes would need to be applied in every location where the code is replicated, increasing the complexity of updates. To resolve this, it is recommended to consolidate duplicate code into a single internal function, and replace the duplicate instances with calls to this new function. This approach streamlines the code, reducing the attack surface and making it easier to maintain and update.

Num of instances: 1

### Findings 


<details><summary>Click to show findings</summary>

['[105](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruForwarder.sol#L105-L106)']
```solidity
105:     function setAllowedInterfaces(bytes4[] memory _allowedInterfaces) external onlyOwner {
106:         for (uint256 i = 0; i < _allowedInterfaces.length; i++) { // <= FOUND
107:             allowedInterface[_allowedInterfaces[i]] = true;
108:         }
109:     }
```


</details>

## [NonCritical-38] Empty bytes check is missing

### Resolution 
When developing smart contracts in Solidity, it's crucial to validate the inputs of your functions. This includes ensuring that the bytes parameters are not empty, especially when they represent crucial data such as addresses, identifiers, or raw data that the contract needs to process.

Missing empty bytes checks can lead to unexpected behaviour in your contract. For instance, certain operations might fail, produce incorrect results, or consume unnecessary gas when performed with empty bytes. Moreover, missing input validation can potentially expose your contract to malicious activity, including exploitation of unhandled edge cases.

To mitigate these issues, always validate that bytes parameters are not empty when the logic of your contract requires it.

Num of instances: 11

### Findings 


<details><summary>Click to show findings</summary>

['[130](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruForwarder.sol#L130-L130)']
```solidity
130:     function verify(ForwardRequest calldata req, bytes calldata signature) public view returns (bool) {
131:         require(block.timestamp <= req.deadline, DeadlineExpired());
132:         address signer = _hashTypedData(
133:             keccak256(
134:                 abi.encode(
135:                     _FORWARD_TYPEHASH,
136:                     req.from,
137:                     req.market,
138:                     req.value,
139:                     req.nonce,
140:                     req.deadline,
141:                     req.selector,
142:                     keccak256(req.data)
143:                 )
144:             )
145:         ).recoverCalldata(signature);
146:         return req.nonce >= _nonces[req.from] && signer == req.from;
147:     }
```
['[151](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruForwarder.sol#L151-L151)']
```solidity
151:     function verifyPriceDependent(PriceDependentRequest calldata req, bytes calldata signature)
152:         public
153:         view
154:         returns (bool)
155:     {
156:         require(block.timestamp <= req.deadline, DeadlineExpired());
157:         address signer = _hashTypedData(
158:             keccak256(
159:                 abi.encode(
160:                     _PRICE_DEPENDENT_TYPEHASH,
161:                     req.from,
162:                     req.market,
163:                     req.price,
164:                     req.value,
165:                     req.nonce,
166:                     req.deadline,
167:                     req.isBelowPrice,
168:                     req.selector,
169:                     keccak256(req.data)
170:                 )
171:             )
172:         ).recoverCalldata(signature);
173:         require(
174:             !executedPriceDependentRequest[keccak256(abi.encodePacked(req.from, req.nonce))],
175:             KuruForwarderErrors.NonceAlreadyUsed()
176:         );
177:         return signer == req.from;
178:     }
```
['[180](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruForwarder.sol#L180-L180)']
```solidity
180:     function verifyCancelPriceDependent(CancelPriceDependentRequest calldata req, bytes calldata signature)
181:         public
182:         view
183:         returns (bool)
184:     {
185:         require(block.timestamp <= req.deadline, DeadlineExpired());
186:         address signer = _hashTypedData(
187:             keccak256(abi.encode(_CANCEL_PRICE_DEPENDENT_TYPEHASH, req.from, req.nonce, req.deadline))
188:         ).recoverCalldata(signature);
189:         require(
190:             !executedPriceDependentRequest[keccak256(abi.encodePacked(req.from, req.nonce))],
191:             KuruForwarderErrors.NonceAlreadyUsed()
192:         );
193:         return signer == req.from;
194:     }
```
['[196](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruForwarder.sol#L196-L196)']
```solidity
196:     function verifyMarginAccountRequest(MarginAccountRequest calldata req, bytes calldata signature)
197:         public
198:         view
199:         returns (bool)
200:     {
201:         require(block.timestamp <= req.deadline, DeadlineExpired());
202:         address signer = _hashTypedData(
203:             keccak256(
204:                 abi.encode(
205:                     _MARGIN_ACCOUNT_REQUEST_TYPEHASH,
206:                     req.from,
207:                     req.marginAccount,
208:                     req.value,
209:                     req.nonce,
210:                     req.deadline,
211:                     req.selector,
212:                     keccak256(req.data)
213:                 )
214:             )
215:         ).recoverCalldata(signature);
216:         return req.nonce >= _nonces[req.from] && signer == req.from;
217:     }
```
['[219](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruForwarder.sol#L219-L219)']
```solidity
219:     function executeMarginAccountRequest(MarginAccountRequest calldata req, bytes calldata signature)
220:         public
221:         payable
222:         returns (bytes memory)
223:     {
224:         require(verifyMarginAccountRequest(req, signature), KuruForwarderErrors.SignatureMismatch());
225:         require(msg.value >= req.value, KuruForwarderErrors.InsufficientValue());
226:         require(allowedInterface[req.selector], KuruForwarderErrors.InterfaceNotAllowed());
227: 
228:         _nonces[req.from] = req.nonce + 1;
229: 
230:         (bool success, bytes memory returndata) =
231:             req.marginAccount.call{value: req.value}(abi.encodePacked(req.selector, req.data, req.from));
232: 
233:         if (!success) {
234:             revert ExecutionFailed(returndata);
235:         }
236: 
237:         return returndata;
238:     }
```
['[240](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruForwarder.sol#L240-L240)']
```solidity
240:     function execute(ForwardRequest calldata req, bytes calldata signature) public payable returns (bytes memory) {
241:         require(verify(req, signature), KuruForwarderErrors.SignatureMismatch());
242:         require(msg.value >= req.value, KuruForwarderErrors.InsufficientValue());
243:         require(allowedInterface[req.selector], KuruForwarderErrors.InterfaceNotAllowed());
244: 
245:         _nonces[req.from] = req.nonce + 1;
246: 
247:         (bool success, bytes memory returndata) =
248:             req.market.call{value: req.value}(abi.encodePacked(req.selector, req.data, req.from));
249: 
250:         if (!success) {
251:             revert ExecutionFailed(returndata);
252:         }
253: 
254:         return returndata;
255:     }
```
['[257](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruForwarder.sol#L257-L257)']
```solidity
257:     function executePriceDependent(PriceDependentRequest calldata req, bytes calldata signature)
258:         public
259:         payable
260:         returns (bytes memory)
261:     {
262:         require(verifyPriceDependent(req, signature), KuruForwarderErrors.SignatureMismatch());
263:         require(msg.value >= req.value, KuruForwarderErrors.InsufficientValue());
264:         require(allowedInterface[req.selector], KuruForwarderErrors.InterfaceNotAllowed());
265:         executedPriceDependentRequest[keccak256(abi.encodePacked(req.from, req.nonce))] = true;
266: 
267:         (uint256 _currentBidPrice,) = IOrderBook(req.market).bestBidAsk();
268:         require(
269:             (req.isBelowPrice && req.price < _currentBidPrice) || (!req.isBelowPrice && req.price > _currentBidPrice),
270:             PriceDependentRequestFailed(_currentBidPrice, req.price)
271:         );
272:         (bool success, bytes memory returndata) =
273:             req.market.call{value: req.value}(abi.encodePacked(req.selector, req.data, req.from));
274: 
275:         if (!success) {
276:             revert ExecutionFailed(returndata);
277:         }
278: 
279:         return returndata;
280:     }
```
['[282](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruForwarder.sol#L282-L282)']
```solidity
282:     function cancelPriceDependent(CancelPriceDependentRequest calldata req, bytes calldata signature) public {
283:         require(verifyCancelPriceDependent(req, signature), KuruForwarderErrors.SignatureMismatch());
284: 
285:         executedPriceDependentRequest[keccak256(abi.encodePacked(req.from, req.nonce))] = true;
286:     }
```
['[260](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/TreeMath.sol#L260-L260)']
```solidity
260:     function _closestBitRight(bytes32 leaves, uint8 bit) private pure returns (uint256) {
261:         unchecked {
262:             return uint256(leaves).closestBitRight(bit - 1);
263:         }
264:     }
```
['[273](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/TreeMath.sol#L273-L273)']
```solidity
273:     function _closestBitLeft(bytes32 leaves, uint8 bit) private pure returns (uint256) {
274:         unchecked {
275:             return uint256(leaves).closestBitLeft(bit + 1);
276:         }
277:     }
```
['[65](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/periphery/MonadDeployer.sol#L65-L65)']
```solidity
65:     function deployTokenAndMarket(
66:         TokenParams memory tokenParams,
67:         MarketParams memory marketParams,
68:         bytes calldata metadata
69:     ) external payable returns (address market) {
70:         KuruERC20 token = new KuruERC20(tokenParams.name, tokenParams.symbol, tokenParams.initialSupply, address(this));
71:         market = router.deployProxy(
72:             IOrderBook.OrderBookType.NATIVE_IN_QUOTE,
73:             address(token),
74:             address(0),
75:             marketParams.sizePrecision,
76:             marketParams.pricePrecision,
77:             marketParams.tickSize,
78:             marketParams.minSize,
79:             marketParams.maxSize,
80:             marketParams.takerFeeBps,
81:             marketParams.makerFeeBps,
82:             kuruAmmSpread
83:         );
84:         if (msg.value != (marketParams.nativeTokenAmount + kuruCollectiveFee)) {
85:             revert InsufficientAssets(marketParams.nativeTokenAmount + kuruCollectiveFee, msg.value);
86:         }
87:         (address vault,,,,,,,) = IOrderBook(market).getVaultParams();
88:         uint256 _supplyToVault = tokenParams.initialSupply * (10 ** 4 - tokenParams.supplyToDev) / 10 ** 4;
89:         token.approve(vault, _supplyToVault);
90:         IKuruAMMVault(vault).deposit{value: marketParams.nativeTokenAmount}(
91:             _supplyToVault, marketParams.nativeTokenAmount, address(this)
92:         );
93:         token.transfer(tokenParams.dev, tokenParams.initialSupply - _supplyToVault);
94:         marginAccount.deposit{value: kuruCollectiveFee}(kuruCollective, address(0), kuruCollectiveFee);
95:         emit PumpingTime(
96:             address(token),
97:             tokenParams.tokenURI,
98:             tokenParams.dev,
99:             tokenParams.initialSupply - _supplyToVault,
100:             market,
101:             metadata
102:         );
103:     }
```


</details>

## [NonCritical-39] Use max instead of 0xfff...

### Resolution 
In Solidity, it's common to use a maximum value to indicate "unlimited" or "all," especially when dealing with token allowances in the context of ERC20 tokens. However, using a manually inserted large value such as 0xfff... is prone to errors and decreases the readability and maintainability of the code.

A better approach is to use a predefined maximum value constant. In Solidity, the type(uint256).max constant represents the largest number a uint256 can hold. This constant clearly communicates the intention of representing the maximum possible value, and is less prone to errors than typing out a long series of fs.

Num of instances: 5

### Findings 


<details><summary>Click to show findings</summary>

['[270](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L270-L281)']
```solidity
270:     function lnWad(int256 x) internal pure returns (int256 r) {
271:         
272:         assembly {
273:             
274:             
275:             
276:             
277: 
278:             
279:             r := shl(7, lt(0xffffffffffffffffffffffffffffffff, x)) // <= FOUND
280:             r := or(r, shl(6, lt(0xffffffffffffffff, shr(r, x)))) // <= FOUND
281:             r := or(r, shl(5, lt(0xffffffff, shr(r, x)))) // <= FOUND
282:             r := or(r, shl(4, lt(0xffff, shr(r, x))))
283:             r := or(r, shl(3, lt(0xff, shr(r, x))))
284:             
285:             if iszero(sgt(x, 0)) {
286:                 mstore(0x00, 0x1615e638) 
287:                 revert(0x1c, 0x04)
288:             }
289:             
290:             r := xor(r, byte(and(0x1f, shr(shr(r, x), 0x8421084210842108cc6318c6db6d54be)),
291:                 0xf8f9f9faf9fdfafbf9fdfcfdfafbfcfef9fafdfafcfcfbfefafafcfbffffffff))
292: 
293:             
294:             
295:             x := shr(159, shl(r, x))
296: 
297:             
298:             
299:             
300:             let p := sub( 
301:                 sar(96, mul(add(43456485725739037958740375743393,
302:                 sar(96, mul(add(24828157081833163892658089445524,
303:                 sar(96, mul(add(3273285459638523848632254066296,
304:                     x), x))), x))), x)), 11111509109440967052023855526967)
305:             p := sub(sar(96, mul(p, x)), 45023709667254063763336534515857)
306:             p := sub(sar(96, mul(p, x)), 14706773417378608786704636184526)
307:             p := sub(mul(p, x), shl(96, 795164235651350426258249787498))
308:             
309: 
310:             
311:             let q := add(5573035233440673466300451813936, x)
312:             q := add(71694874799317883764090561454958, sar(96, mul(x, q)))
313:             q := add(283447036172924575727196451306956, sar(96, mul(x, q)))
314:             q := add(401686690394027663651624208769553, sar(96, mul(x, q)))
315:             q := add(204048457590392012362485061816622, sar(96, mul(x, q)))
316:             q := add(31853899698501571402653359427138, sar(96, mul(x, q)))
317:             q := add(909429971244387300277376558375, sar(96, mul(x, q)))
318: 
319:             
320: 
321:             
322:             
323:             
324:             
325:             
326: 
327:             
328:             
329:             p := sdiv(p, q)
330:             
331:             p := mul(1677202110996718588342820967067443963516166, p)
332:             
333:             
334:             p := add(mul(16597577552685614221487285958193947469193820559219878177908093499208371, sub(159, r)), p)
335:             
336:             p := add(600920179829731861736702779321621459595472258049074101567377883020018308, p)
337:             
338:             r := sar(174, p)
339:         }
340:     }
```
['[642](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L642-L655)']
```solidity
642:     function sqrt(uint256 x) internal pure returns (uint256 z) {
643:         
644:         assembly {
645:             
646:             z := 181 
647: 
648:             
649:             
650: 
651:             
652:             
653:             let r := shl(7, lt(0xffffffffffffffffffffffffffffffffff, x)) // <= FOUND
654:             r := or(r, shl(6, lt(0xffffffffffffffffff, shr(r, x)))) // <= FOUND
655:             r := or(r, shl(5, lt(0xffffffffff, shr(r, x)))) // <= FOUND
656:             r := or(r, shl(4, lt(0xffffff, shr(r, x))))
657:             z := shl(shr(1, r), z)
658: 
659:             
660:             
661:             
662:             
663: 
664:             
665:             
666:             
667: 
668:             
669:             
670:             
671: 
672:             
673:             
674:             
675: 
676:             
677:             z := shr(18, mul(z, add(shr(r, x), 65536))) 
678: 
679:             
680:             z := shr(1, add(z, div(x, z)))
681:             z := shr(1, add(z, div(x, z)))
682:             z := shr(1, add(z, div(x, z)))
683:             z := shr(1, add(z, div(x, z)))
684:             z := shr(1, add(z, div(x, z)))
685:             z := shr(1, add(z, div(x, z)))
686:             z := shr(1, add(z, div(x, z)))
687: 
688:             
689:             
690:             
691:             z := sub(z, lt(div(x, z), z))
692:         }
693:     }
```
['[700](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L700-L705)']
```solidity
700:     function cbrt(uint256 x) internal pure returns (uint256 z) {
701:         
702:         assembly {
703:             let r := shl(7, lt(0xffffffffffffffffffffffffffffffff, x)) // <= FOUND
704:             r := or(r, shl(6, lt(0xffffffffffffffff, shr(r, x)))) // <= FOUND
705:             r := or(r, shl(5, lt(0xffffffff, shr(r, x)))) // <= FOUND
706:             r := or(r, shl(4, lt(0xffff, shr(r, x))))
707:             r := or(r, shl(3, lt(0xff, shr(r, x))))
708:             
709:             z := div(shl(div(r, 3), shl(lt(0xf, shr(r, x)), 0xf)), xor(7, mod(r, 3)))
710:             
711:             z := div(add(add(div(x, mul(z, z)), z), z), 3)
712:             z := div(add(add(div(x, mul(z, z)), z), z), 3)
713:             z := div(add(add(div(x, mul(z, z)), z), z), 3)
714:             z := div(add(add(div(x, mul(z, z)), z), z), 3)
715:             z := div(add(add(div(x, mul(z, z)), z), z), 3)
716:             z := div(add(add(div(x, mul(z, z)), z), z), 3)
717:             z := div(add(add(div(x, mul(z, z)), z), z), 3)
718:             
719:             z := sub(z, lt(div(x, mul(z, z)), z))
720:         }
721:     }
```
['[781](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L781-L786)']
```solidity
781:     function log2(uint256 x) internal pure returns (uint256 r) {
782:         
783:         assembly {
784:             r := shl(7, lt(0xffffffffffffffffffffffffffffffff, x)) // <= FOUND
785:             r := or(r, shl(6, lt(0xffffffffffffffff, shr(r, x)))) // <= FOUND
786:             r := or(r, shl(5, lt(0xffffffff, shr(r, x)))) // <= FOUND
787:             r := or(r, shl(4, lt(0xffff, shr(r, x))))
788:             r := or(r, shl(3, lt(0xff, shr(r, x))))
789:             
790:             r := or(r, byte(and(0x1f, shr(shr(r, x), 0x8421084210842108cc6318c6db6d54be)),
791:                 0x0706060506020504060203020504030106050205030304010505030400000000))
792:         }
793:     }
```
['[842](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L842-L847)']
```solidity
842:     function log256(uint256 x) internal pure returns (uint256 r) {
843:         
844:         assembly {
845:             r := shl(7, lt(0xffffffffffffffffffffffffffffffff, x)) // <= FOUND
846:             r := or(r, shl(6, lt(0xffffffffffffffff, shr(r, x)))) // <= FOUND
847:             r := or(r, shl(5, lt(0xffffffff, shr(r, x)))) // <= FOUND
848:             r := or(r, shl(4, lt(0xffff, shr(r, x))))
849:             r := or(shr(3, r), lt(0xff, shr(r, x)))
850:         }
851:     }
```


</details>

## [NonCritical-40] Return bool not explicit

### Resolution 
In Solidity, when designing functions that return boolean values, it's crucial for clarity and maintainability to explicitly handle both `true` and `false` return scenarios. If a function is intended to return `true` under certain conditions, it should also explicitly return `false` when these conditions are not met, and vice versa. This approach eliminates ambiguity and makes the code's intent more transparent. Explicitly handling all possible outcomes of a boolean function ensures that future modifications or extensions of the contract do not unintentionally alter its logic. It contributes to better readability, easier debugging, and reduces the risk of bugs related to unintended fall-through cases.

Num of instances: 1

### Findings 


<details><summary>Click to show findings</summary>

['[117](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruForwarder.sol#L117-L118)']
```solidity
117:     function _domainNameAndVersionMayChange() internal pure override returns (bool result) {
118:         return true; // <= FOUND
119:     }
```


</details>

## [NonCritical-41] Assembly block creates dirty bits

### Resolution 
Manipulating data directly at the free memory pointer location without subsequently adjusting the pointer can lead to unwanted data remnants, or "dirty bits", in that memory spot. This can cause challenges for the Solidity optimizer, making it difficult to determine if memory cleaning is required before reuse, potentially resulting in less efficient optimization. To mitigate this issue, it's advised to always update the free memory pointer following any data write operation. Furthermore, using the `assembly ("memory-safe") { ... }` annotation will clearly indicate to the optimizer the sections of your code that are memory-safe, improving code efficiency and reducing the potential for errors.

Num of instances: 2

### Findings 


<details><summary>Click to show findings</summary>

['[1403](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L1403-L1404)']
```solidity
1403:         assembly ("memory-safe") {
1404:             dataStart := mload(0x40) // <= FOUND
1405:             lastFree := add(dataStart, 32)
1406:             mstore(lastFree, number()) 
1407:             lastFree := add(lastFree, 32)
1408:             mstore(0x40, lastFree)
1409:         }
```
['[1441](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L1441-L1442)']
```solidity
1441:         assembly ("memory-safe") {
1442:             let curFree := mload(0x40) // <= FOUND
1443:             if iszero(eq(curFree, lastFree)) {
1444:                 let producedLen := sub(lastFree, dataStart)
1445:                 for { let offset := 0 }
```


</details>

## [NonCritical-42] call bypasses function existence check, type checking and argument packing

### Resolution 
Using the `.call` method in Solidity enables direct communication with an address, bypassing function existence checks, type checking, and argument packing. While this can save gas and provide flexibility, it can also introduce security risks and potential errors. The absence of these checks can lead to unexpected behavior if the callee contract's interface changes or if the input parameters are not crafted with care. The resolution to these issues is to use Solidity's high-level interface for calling functions when possible, as it automatically manages these aspects. If using `.call` is necessary, ensure that the inputs are carefully validated and that awareness of the called contract's behavior is maintained.

Num of instances: 2

### Findings 


<details><summary>Click to show findings</summary>

['[230](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruForwarder.sol#L230-L231)']
```solidity
230:         (bool success, bytes memory returndata) =
231:             req.marginAccount.call{value: req.value}(abi.encodePacked(req.selector, req.data, req.from)); // <= FOUND
```
['[230](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruForwarder.sol#L230-L231)']
```solidity
230:         (bool success, bytes memory returndata) =
231:             req.market.call{value: req.value}(abi.encodePacked(req.selector, req.data, req.from)); // <= FOUND
```


</details>

## [NonCritical-43] Cyclomatic complexity in functions

### Resolution 
Cyclomatic complexity is a software metric used to measure the complexity of a program. It quantifies the number of linearly independent paths through a program's source code, giving an idea of how complex the control flow is. High cyclomatic complexity may indicate a higher risk of defects and can make the code harder to understand, test, and maintain. It often suggests that a function or method is trying to do too much, and a refactor might be needed. By breaking down complex functions into smaller, more focused pieces, you can improve readability, ease of testing, and overall maintainability.

Num of instances: 27

### Findings 


<details><summary>Click to show findings</summary>

[]
```solidity
59:     function _fillVaultBuyMatch(uint256 _breakPoint, uint96 _quoteSize)
60:         internal
61:         returns (uint96 quoteLeft, uint96 sizeFilled, bytes memory makerCredits)
62:     {
63:         uint256 _price = vaultBestAsk;
64:         uint256 _quoteInput = _quoteSize * vaultPricePrecision / _getPricePrecision();
65:         uint96 _cachedLastVaultSize = vaultAskOrderSize;
66:         uint96 _cachedPartiallyFilledBid = bidPartiallyFilledSize;
67:         uint96 _availableSize = _cachedLastVaultSize - askPartiallyFilledSize;
68:         
69:         if (_quoteInput >= FixedPointMathLib.mulDivUp(_price, _availableSize, _getSizePrecision())) {
70:             askPartiallyFilledSize = 0;
71:         }
72: 
73:         while (_price < _breakPoint && _quoteInput > 0) {
74:             uint256 _quoteNeededForFill = FixedPointMathLib.mulDivUp(_price, _availableSize, _getSizePrecision());
75:             if (_quoteNeededForFill > _quoteInput) {
76:                 uint96 _sizeFilledAtPrice = toU96(_quoteInput * _getSizePrecision() / _price);
77:                 sizeFilled += _sizeFilledAtPrice;
78:                 askPartiallyFilledSize += _sizeFilledAtPrice;
79:                 _emitTrade(0, kuruAmmVault, true, _price, _availableSize - _sizeFilledAtPrice, _sizeFilledAtPrice);
80:                 _quoteInput = 0;
81:                 break;
82:             } else {
83:                 sizeFilled += _availableSize;
84:                 _quoteInput -= _quoteNeededForFill;
85:                 _cachedLastVaultSize = toU96(
86:                     FixedPointMathLib.mulDiv(
87:                         _cachedLastVaultSize, DOUBLE_BPS_MULTIPLIER, DOUBLE_BPS_MULTIPLIER + SPREAD_CONSTANT
88:                     )
89:                 );
90:                 _emitTrade(0, kuruAmmVault, true, _price, 0, _availableSize);
91:                 _availableSize = _cachedLastVaultSize;
92:                 _price = FixedPointMathLib.mulDivRound(_price, BPS_MULTIPLIER + SPREAD_CONSTANT, BPS_MULTIPLIER);
93:                 _cachedPartiallyFilledBid = toU96(
94:                     FixedPointMathLib.mulDiv(
95:                         _cachedPartiallyFilledBid, BPS_MULTIPLIER, BPS_MULTIPLIER + SPREAD_CONSTANT
96:                     )
97:                 );
98:             }
99:         }
100:         if (_price != vaultBestAsk) {
101:             vaultBestAsk = _price;
102:             vaultBestBid = FixedPointMathLib.mulDivRound(_price, BPS_MULTIPLIER, BPS_MULTIPLIER + SPREAD_CONSTANT);
103:             vaultAskOrderSize = _cachedLastVaultSize;
104:             vaultBidOrderSize = toU96(
105:                 FixedPointMathLib.mulDiv(
106:                     _cachedLastVaultSize, DOUBLE_BPS_MULTIPLIER + SPREAD_CONSTANT, DOUBLE_BPS_MULTIPLIER
107:                 )
108:             );
109:         }
110:         bidPartiallyFilledSize = _cachedPartiallyFilledBid;
111:         quoteLeft = toU96(FixedPointMathLib.mulDiv(_quoteInput, _getPricePrecision(), vaultPricePrecision));
112:         makerCredits =
113:             _creditVaultOnMarketBuy(sizeFilled, (_quoteSize * vaultPricePrecision / _getPricePrecision() - _quoteInput));
114:     }
```
[]
```solidity
124:     function _fillVaultForBuy(uint256 _breakPoint, uint96 _size)
125:         internal
126:         returns (uint96 sizeLeft, uint96 fundsConsumed, bytes memory makerCredits)
127:     {
128:         uint256 _price = vaultBestAsk;
129:         sizeLeft = _size;
130: 
131:         uint96 _cachedLastVaultSize = vaultAskOrderSize;
132:         uint96 _cachedPartiallyFilledBid = bidPartiallyFilledSize;
133:         
134:         uint256 _consumedQuote;
135:         uint96 _availableSize = _cachedLastVaultSize - askPartiallyFilledSize;
136:         if (_availableSize <= sizeLeft) {
137:             askPartiallyFilledSize = 0;
138:         }
139:         while (_price < _breakPoint && sizeLeft > 0) {
140:             if (_availableSize > sizeLeft) {
141:                 askPartiallyFilledSize += sizeLeft;
142:                 _consumedQuote += FixedPointMathLib.mulDivUp(sizeLeft, _price, _getSizePrecision());
143:                 _emitTrade(0, kuruAmmVault, true, _price, _availableSize - sizeLeft, sizeLeft);
144:                 sizeLeft = 0;
145:                 break;
146:             } else {
147:                 sizeLeft -= _availableSize;
148:                 _consumedQuote += FixedPointMathLib.mulDivUp(_availableSize, _price, _getSizePrecision());
149:                 _cachedLastVaultSize = toU96(
150:                     FixedPointMathLib.mulDiv(
151:                         _cachedLastVaultSize, DOUBLE_BPS_MULTIPLIER, DOUBLE_BPS_MULTIPLIER + SPREAD_CONSTANT
152:                     )
153:                 );
154:                 _emitTrade(0, kuruAmmVault, true, _price, 0, _availableSize);
155:                 _availableSize = _cachedLastVaultSize;
156:                 _price = FixedPointMathLib.mulDivRound(_price, BPS_MULTIPLIER + SPREAD_CONSTANT, BPS_MULTIPLIER);
157:                 _cachedPartiallyFilledBid = toU96(
158:                     FixedPointMathLib.mulDiv(
159:                         _cachedPartiallyFilledBid, BPS_MULTIPLIER, BPS_MULTIPLIER + SPREAD_CONSTANT
160:                     )
161:                 );
162:             }
163:         }
164:         if (_price != vaultBestAsk) {
165:             vaultBestAsk = _price;
166:             vaultBestBid = FixedPointMathLib.mulDivRound(_price, BPS_MULTIPLIER, BPS_MULTIPLIER + SPREAD_CONSTANT);
167:             vaultAskOrderSize = _cachedLastVaultSize;
168:             vaultBidOrderSize = toU96(
169:                 FixedPointMathLib.mulDiv(
170:                     _cachedLastVaultSize, DOUBLE_BPS_MULTIPLIER + SPREAD_CONSTANT, DOUBLE_BPS_MULTIPLIER
171:                 )
172:             );
173:         }
174:         bidPartiallyFilledSize = _cachedPartiallyFilledBid;
175:         fundsConsumed = toU96(FixedPointMathLib.mulDivUp(_consumedQuote, _getPricePrecision(), vaultPricePrecision));
176:         makerCredits = _creditVaultOnMarketBuy(_size - sizeLeft, _consumedQuote);
177:     }
```
[]
```solidity
187:     function _fillVaultForSell(uint256 _breakPoint, uint96 _size)
188:         internal
189:         returns (uint96 sizeLeft, uint256 quoteOwedToUser, bytes memory makerCredits)
190:     {
191:         uint256 _price = vaultBestBid;
192:         uint96 _availableSize = vaultBidOrderSize - bidPartiallyFilledSize;
193:         uint96 _cachedLastVaultSize = vaultBidOrderSize;
194:         sizeLeft = _size;
195:         if (sizeLeft >= _availableSize) {
196:             bidPartiallyFilledSize = 0;
197:         }
198: 
199:         while (_price > _breakPoint && sizeLeft > 0) {
200:             if (_availableSize > sizeLeft) {
201:                 bidPartiallyFilledSize += sizeLeft;
202:                 quoteOwedToUser += FixedPointMathLib.mulDiv(_price, sizeLeft, _getSizePrecision());
203:                 _emitTrade(0, kuruAmmVault, false, _price, _availableSize - sizeLeft, sizeLeft);
204:                 sizeLeft = 0;
205:                 break;
206:             } else {
207:                 sizeLeft -= _availableSize;
208:                 quoteOwedToUser += FixedPointMathLib.mulDiv(_price, _availableSize, _getSizePrecision());
209:                 _cachedLastVaultSize = toU96(
210:                     FixedPointMathLib.mulDiv(
211:                         _cachedLastVaultSize, DOUBLE_BPS_MULTIPLIER + SPREAD_CONSTANT, DOUBLE_BPS_MULTIPLIER
212:                     )
213:                 );
214:                 _emitTrade(0, kuruAmmVault, false, _price, 0, _availableSize);
215:                 _availableSize = _cachedLastVaultSize;
216:                 _price = FixedPointMathLib.mulDivRound(_price, BPS_MULTIPLIER, BPS_MULTIPLIER + SPREAD_CONSTANT);
217:             }
218:         }
219:         if (_price != vaultBestBid) {
220:             vaultBestBid = _price;
221:             vaultBestAsk = FixedPointMathLib.mulDivRound(_price, BPS_MULTIPLIER + SPREAD_CONSTANT, BPS_MULTIPLIER);
222:             vaultBidOrderSize = _cachedLastVaultSize;
223:             vaultAskOrderSize = toU96(
224:                 FixedPointMathLib.mulDiv(
225:                     _cachedLastVaultSize, DOUBLE_BPS_MULTIPLIER, DOUBLE_BPS_MULTIPLIER + SPREAD_CONSTANT
226:                 )
227:             );
228:         }
229:         makerCredits = _creditVaultOnMarketSell(_size - sizeLeft, quoteOwedToUser);
230:     }
```
[]
```solidity
300:     function updateVaultOrdSz(
301:         uint96 _vaultAskOrderSize,
302:         uint96 _vaultBidOrderSize,
303:         uint256 _askPrice,
304:         uint256 _bidPrice,
305:         bool _nullifyPartialFills
306:     ) external onlyVault nonReentrant marketNotHardPaused {
307:         vaultBidOrderSize = _vaultBidOrderSize;
308:         vaultAskOrderSize = _vaultAskOrderSize;
309: 
310:         if (_nullifyPartialFills) {
311:             askPartiallyFilledSize = 0;
312:             bidPartiallyFilledSize = 0;
313:         }
314: 
315:         if (vaultBestAsk == type(uint256).max) {
316:             vaultBestAsk = _askPrice;
317:         }
318:         if (vaultBestBid == 0) {
319:             vaultBestBid = _bidPrice;
320:         }
321:         emit VaultParamsUpdated(
322:             _vaultAskOrderSize,
323:             askPartiallyFilledSize,
324:             _vaultBidOrderSize,
325:             bidPartiallyFilledSize,
326:             vaultBestAsk,
327:             vaultBestBid
328:         );
329:     }
```
[]
```solidity
45:     function initialize(
46:         address _owner,
47:         address token1_,
48:         address token2_,
49:         address _marginAccount,
50:         address _market,
51:         uint96 _spreadConstant
52:     ) public initializer {
53:         owner = _owner;
54:         token1 = token1_;
55:         token1Decimals = token1_ != address(0) ? ERC20(token1_).decimals() : 18;
56:         token2 = token2_;
57:         token2Decimals = token2_ != address(0) ? ERC20(token2_).decimals() : 18;
58:         marginAccount = IMarginAccount(_marginAccount);
59:         market = IOrderBook(_market);
60:         SPREAD_CONSTANT = _spreadConstant;
61:         setMarketParams();
62:         if (token1_ != address(0)) {
63:             token1_.safeApprove(_marginAccount, type(uint256).max);
64:         }
65:         if (token2_ != address(0)) {
66:             token2_.safeApprove(_marginAccount, type(uint256).max);
67:         }
68:         string memory token1Symbol;
69:         string memory token2Symbol;
70:         if (token1_ != address(0)) {
71:             token1Symbol = ERC20(token1_).symbol();
72:         } else {
73:             token1Symbol = "MON";
74:         }
75:         if (token2_ != address(0)) {
76:             token2Symbol = ERC20(token2_).symbol();
77:         } else {
78:             token2Symbol = "MON";
79:         }
80:         _name = string.concat(token1Symbol, "-", token2Symbol, "-", "KURU-AMM-VAULT");
81:     }
```
[]
```solidity
376:     function _convertToAssetsWithNewSize(uint256 shares)
377:         internal
378:         view
379:         returns (uint256, uint256, uint96, uint96, bool)
380:     {
381:         (uint256 _baseAmount,) = _returnNormalizedAmountAndPrice(false);
382:         uint256 _baseAmountAfterRemoval = _baseAmount - FixedPointMathLib.mulDiv(shares, _baseAmount, totalSupply());
383:         (uint96 _newAskSize, uint96 _newBidSize) = _getVaultSizesForBaseAmount(_baseAmountAfterRemoval);
384:         (
385:             ,
386:             uint256 _vaultBestBid,
387:             uint96 _partiallyFilledBidSize,
388:             uint256 _vaultBestAsk,
389:             uint96 _partiallyFilledAskSize,
390:             ,
391:             ,
392:         ) = market.getVaultParams();
393:         MarketParams memory _marketParams = marketParams;
394:         (uint256 _reserveBase, uint256 _reserveQuote) = totalAssets();
395:         if (_partiallyFilledAskSize > _newAskSize || _partiallyFilledBidSize > _newBidSize) {
396:             int256 _baseOwedToVault = (
397:                 int256(uint256(_partiallyFilledAskSize)) - int256(uint256(_partiallyFilledBidSize))
398:             ) * int256(10 ** _marketParams.baseAssetDecimals) / int256(uint256(_marketParams.sizePrecision));
399:             int256 _quoteOwedToVault = (
400:                 int256(FixedPointMathLib.mulDivUp(_partiallyFilledBidSize, _vaultBestBid, _marketParams.sizePrecision))
401:                     - int256(FixedPointMathLib.mulDiv(_partiallyFilledAskSize, _vaultBestAsk, _marketParams.sizePrecision))
402:             ) * int256(10 ** _marketParams.quoteAssetDecimals) / int256(vaultPricePrecision);
403:             uint256 _baseOwedToUser;
404:             uint256 _quoteOwedToUser;
405:             if (_baseOwedToVault < 0) {
406:                 _reserveBase = _reserveBase - (uint256(-1 * _baseOwedToVault));
407:                 _baseOwedToUser =
408:                     FixedPointMathLib.mulDiv(shares, _reserveBase, totalSupply()) + uint256(-1 * _baseOwedToVault);
409:             } else {
410:                 _reserveBase = _reserveBase + (uint256(_baseOwedToVault));
411:                 _baseOwedToUser =
412:                     FixedPointMathLib.mulDiv(shares, _reserveBase, totalSupply()) - uint256(_baseOwedToVault);
413:             }
414:             if (_quoteOwedToVault < 0) {
415:                 _reserveQuote = _reserveQuote - (uint256(-1 * _quoteOwedToVault));
416:                 _quoteOwedToUser =
417:                     FixedPointMathLib.mulDiv(shares, _reserveQuote, totalSupply()) + uint256(-1 * _quoteOwedToVault);
418:             } else {
419:                 _reserveQuote = _reserveQuote + (uint256(_quoteOwedToVault));
420:                 _quoteOwedToUser =
421:                     FixedPointMathLib.mulDiv(shares, _reserveQuote, totalSupply()) - uint256(_quoteOwedToVault);
422:             }
423:             return (_baseOwedToUser, _quoteOwedToUser, _newAskSize, _newBidSize, true);
424:         } else {
425:             uint256 _baseOwedToUser = FixedPointMathLib.mulDiv(shares, _reserveBase, totalSupply());
426:             uint256 _quoteOwedToUser = FixedPointMathLib.mulDiv(shares, _reserveQuote, totalSupply());
427:             return (_baseOwedToUser, _quoteOwedToUser, _newAskSize, _newBidSize, false);
428:         }
429:     }
```
['[346](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L346-L346)']
```solidity
346:     function lambertW0Wad(int256 x) internal pure returns (int256 w) { // <= FOUND
347:         
348:         unchecked {
349:             if ((w = x) <= -367879441171442322) revert OutOfDomain(); 
350:             int256 wad = int256(WAD);
351:             int256 p = x;
352:             uint256 c; 
353:             uint256 i = 4; 
354:             if (w <= 0x1ffffffffffff) {
355:                 if (-0x4000000000000 <= w) {
356:                     i = 1; 
357:                 } else if (w <= -0x3ffffffffffffff) {
358:                     i = 32; 
359:                 }
360:             } else if (uint256(w >> 63) == uint256(0)) {
361:                 
362:                 assembly {
363:                     
364:                     let v := shr(49, w)
365:                     let l := shl(3, lt(0xff, v))
366:                     l := add(or(l, byte(and(0x1f, shr(shr(l, v), 0x8421084210842108cc6318c6db6d54be)),
367:                         0x0706060506020504060203020504030106050205030304010505030400000000)), 49)
368:                     w := sdiv(shl(l, 7), byte(sub(l, 31), 0x0303030303030303040506080c13))
369:                     c := gt(l, 60)
370:                     i := add(2, add(gt(l, 53), c))
371:                 }
372:             } else {
373:                 int256 ll = lnWad(w = lnWad(w));
374:                 
375:                 assembly {
376:                     
377:                     w := add(sdiv(mul(ll, 1023715080943847266), w), sub(w, ll))
378:                     i := add(3, iszero(shr(68, x)))
379:                     c := iszero(shr(143, x))
380:                 }
381:                 if (c == uint256(0)) {
382:                     do { 
383:                         int256 e = expWad(w);
384:                         
385:                         assembly {
386:                             let t := mul(w, div(e, wad))
387:                             w := sub(w, sdiv(sub(t, x), div(add(e, t), wad)))
388:                         }
389:                         if (p <= w) break;
390:                         p = w;
391:                     } while (--i != uint256(0));
392:                     
393:                     assembly {
394:                         w := sub(w, sgt(w, 2))
395:                     }
396:                     return w;
397:                 }
398:             }
399:             do { 
400:                 int256 e = expWad(w);
401:                 
402:                 assembly {
403:                     let t := add(w, wad)
404:                     let s := sub(mul(w, e), mul(x, wad))
405:                     w := sub(w, sdiv(mul(s, wad), sub(mul(e, t), sdiv(mul(add(t, wad), s), add(t, t)))))
406:                 }
407:                 if (p <= w) break;
408:                 p = w;
409:             } while (--i != c);
410:             
411:             assembly {
412:                 w := sub(w, sgt(w, 2))
413:             }
414:             
415:             
416:             if (c == uint256(0)) return w;
417:             int256 t = w | 1;
418:             
419:             assembly {
420:                 x := sdiv(mul(x, wad), t)
421:             }
422:             x = (t * (wad + lnWad(x)));
423:             
424:             assembly {
425:                 w := sdiv(x, add(wad, t))
426:             }
427:         }
428:     }
```
['[605](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L605-L605)']
```solidity
605:     function rpow(uint256 x, uint256 y, uint256 b) internal pure returns (uint256 z) { // <= FOUND
606:         
607:         assembly {
608:             z := mul(b, iszero(y)) 
609:             if x {
610:                 z := xor(b, mul(xor(b, x), and(y, 1))) 
611:                 let half := shr(1, b) 
612:                 
613:                 for { y := shr(1, y) } y { y := shr(1, y) } {
614:                     let xx := mul(x, x) 
615:                     let xxRound := add(xx, half) 
616:                     
617:                     if or(lt(xxRound, xx), shr(128, x)) {
618:                         mstore(0x00, 0x49f7642b) 
619:                         revert(0x1c, 0x04)
620:                     }
621:                     x := div(xxRound, b) 
622:                     
623:                     if and(y, 1) {
624:                         let zx := mul(z, x) 
625:                         let zxRound := add(zx, half) 
626:                         
627:                         if or(xor(div(zx, x), z), lt(zxRound, zx)) {
628:                             
629:                             if x {
630:                                 mstore(0x00, 0x49f7642b) 
631:                                 revert(0x1c, 0x04)
632:                             }
633:                         }
634:                         z := div(zxRound, b) 
635:                     }
636:                 }
637:             }
638:         }
639:     }
```
['[739](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L739-L739)']
```solidity
739:     function cbrtWad(uint256 x) internal pure returns (uint256 z) { // <= FOUND
740:         unchecked {
741:             if (x <= type(uint256).max / 10 ** 36) return cbrt(x * 10 ** 36);
742:             z = (1 + cbrt(x)) * 10 ** 12;
743:             z = (fullMulDivUnchecked(x, 10 ** 36, z * z) + z + z) / 3;
744:         }
745:         
746:         assembly {
747:             let p := x
748:             for {} 1 {} {
749:                 if iszero(shr(229, p)) {
750:                     if iszero(shr(199, p)) {
751:                         p := mul(p, 100000000000000000) 
752:                         break
753:                     }
754:                     p := mul(p, 100000000) 
755:                     break
756:                 }
757:                 if iszero(shr(249, p)) { p := mul(p, 100) }
758:                 break
759:             }
760:             let t := mulmod(mul(z, z), z, p)
761:             z := sub(z, gt(lt(t, shr(1, p)), iszero(t))) 
762:         }
763:     }
```
['[807](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L807-L807)']
```solidity
807:     function log10(uint256 x) internal pure returns (uint256 r) { // <= FOUND
808:         
809:         assembly {
810:             if iszero(lt(x, 100000000000000000000000000000000000000)) {
811:                 x := div(x, 100000000000000000000000000000000000000)
812:                 r := 38
813:             }
814:             if iszero(lt(x, 100000000000000000000)) {
815:                 x := div(x, 100000000000000000000)
816:                 r := add(r, 20)
817:             }
818:             if iszero(lt(x, 10000000000)) {
819:                 x := div(x, 10000000000)
820:                 r := add(r, 10)
821:             }
822:             if iszero(lt(x, 100000)) {
823:                 x := div(x, 100000)
824:                 r := add(r, 5)
825:             }
826:             r := add(r, add(gt(x, 9), add(gt(x, 99), add(gt(x, 999), gt(x, 9999)))))
827:         }
828:     }
```
['[865](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L865-L865)']
```solidity
865:     function sci(uint256 x) internal pure returns (uint256 mantissa, uint256 exponent) { // <= FOUND
866:         
867:         assembly {
868:             mantissa := x
869:             if mantissa {
870:                 if iszero(mod(mantissa, 1000000000000000000000000000000000)) {
871:                     mantissa := div(mantissa, 1000000000000000000000000000000000)
872:                     exponent := 33
873:                 }
874:                 if iszero(mod(mantissa, 10000000000000000000)) {
875:                     mantissa := div(mantissa, 10000000000000000000)
876:                     exponent := add(exponent, 19)
877:                 }
878:                 if iszero(mod(mantissa, 1000000000000)) {
879:                     mantissa := div(mantissa, 1000000000000)
880:                     exponent := add(exponent, 12)
881:                 }
882:                 if iszero(mod(mantissa, 1000000)) {
883:                     mantissa := div(mantissa, 1000000)
884:                     exponent := add(exponent, 6)
885:                 }
886:                 if iszero(mod(mantissa, 10000)) {
887:                     mantissa := div(mantissa, 10000)
888:                     exponent := add(exponent, 4)
889:                 }
890:                 if iszero(mod(mantissa, 100)) {
891:                     mantissa := div(mantissa, 100)
892:                     exponent := add(exponent, 2)
893:                 }
894:                 if iszero(mod(mantissa, 10)) {
895:                     mantissa := div(mantissa, 10)
896:                     exponent := add(exponent, 1)
897:                 }
898:             }
899:         }
900:     }
```
['[28](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/TreeMath.sol#L28-L28)']
```solidity
28:     function add(TreeUint32 storage tree, uint32 id) internal returns (bool) { // <= FOUND
29:         bytes32 key3 = bytes32(uint256(id) >> 8);
30: 
31:         bytes32 leaves = tree.level3[key3];
32:         bytes32 newLeaves = leaves | bytes32(1 << (id & type(uint8).max));
33: 
34:         if (leaves != newLeaves) {
35:             tree.level3[key3] = newLeaves;
36: 
37:             if (leaves == 0) {
38:                 bytes32 key2 = key3 >> 8;
39:                 leaves = tree.level2[key2];
40: 
41:                 tree.level2[key2] = leaves | bytes32(1 << (uint256(key3) & type(uint8).max));
42: 
43:                 if (leaves == 0) {
44:                     bytes32 key1 = key2 >> 8;
45:                     leaves = tree.level1[key1];
46: 
47:                     tree.level1[key1] = leaves | bytes32(1 << (uint256(key2) & type(uint8).max));
48: 
49:                     if (leaves == 0) {
50:                         tree.level0 |= bytes32(1 << (uint256(key1) & type(uint8).max));
51:                     }
52:                 }
53:             }
54: 
55:             return true;
56:         }
57: 
58:         return false;
59:     }
```
['[68](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/TreeMath.sol#L68-L68)']
```solidity
68:     function remove(TreeUint32 storage tree, uint32 id) internal returns (bool) { // <= FOUND
69:         bytes32 key3 = bytes32(uint256(id) >> 8);
70: 
71:         bytes32 leaves = tree.level3[key3];
72:         bytes32 newLeaves = leaves & ~bytes32(1 << (id & type(uint8).max));
73: 
74:         if (leaves != newLeaves) {
75:             tree.level3[key3] = newLeaves;
76: 
77:             if (newLeaves == 0) {
78:                 bytes32 key2 = key3 >> 8;
79:                 newLeaves = tree.level2[key2] & ~bytes32(1 << (uint256(key3) & type(uint8).max));
80: 
81:                 tree.level2[key2] = newLeaves;
82: 
83:                 if (newLeaves == 0) {
84:                     bytes32 key1 = key2 >> 8;
85:                     newLeaves = tree.level1[key1] & ~bytes32(1 << (uint256(key2) & type(uint8).max));
86: 
87:                     tree.level1[key1] = newLeaves;
88: 
89:                     if (newLeaves == 0) {
90:                         tree.level0 &= ~bytes32(1 << (uint256(key1) & type(uint8).max));
91:                     }
92:                 }
93:             }
94: 
95:             return true;
96:         }
97: 
98:         return false;
99:     }
```
['[108](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/TreeMath.sol#L108-L108)']
```solidity
108:     function findFirstRight(TreeUint32 storage tree, uint32 id) internal view returns (uint32) { // <= FOUND
109:         bytes32 leaves;
110: 
111:         bytes32 key3 = bytes32(uint256(id) >> 8);
112:         uint8 bit = uint8(id & type(uint8).max);
113: 
114:         if (bit != 0) {
115:             leaves = tree.level3[key3];
116:             uint256 closestBit = _closestBitRight(leaves, bit);
117: 
118:             if (closestBit != type(uint256).max) return uint32((uint256(key3) << 8) | closestBit);
119:         }
120: 
121:         bytes32 key2 = key3 >> 8;
122:         bit = uint8(uint256(key3) & type(uint8).max);
123: 
124:         if (bit != 0) {
125:             leaves = tree.level2[key2];
126:             uint256 closestBit = _closestBitRight(leaves, bit);
127: 
128:             if (closestBit != type(uint256).max) {
129:                 key3 = bytes32((uint256(key2) << 8) | closestBit);
130:                 leaves = tree.level3[key3];
131: 
132:                 return uint32((uint256(key3) << 8) | uint256(leaves).mostSignificantBit());
133:             }
134:         }
135: 
136:         bytes32 key1 = key2 >> 8;
137:         bit = uint8(uint256(key2) & type(uint8).max);
138: 
139:         if (bit != 0) {
140:             leaves = tree.level1[key1];
141:             uint256 closestBit = _closestBitRight(leaves, bit);
142: 
143:             if (closestBit != type(uint256).max) {
144:                 key2 = bytes32((uint256(key1) << 8) | closestBit);
145:                 leaves = tree.level2[key2];
146: 
147:                 key3 = bytes32((uint256(key2) << 8) | uint256(leaves).mostSignificantBit());
148:                 leaves = tree.level3[key3];
149: 
150:                 return uint32((uint256(key3) << 8) | uint256(leaves).mostSignificantBit());
151:             }
152:         }
153: 
154:         bit = uint8(uint256(key1) & type(uint8).max);
155: 
156:         if (bit != 0) {
157:             leaves = tree.level0;
158:             uint256 closestBit = _closestBitRight(leaves, bit);
159: 
160:             if (closestBit != type(uint256).max) {
161:                 key1 = bytes32(closestBit);
162:                 leaves = tree.level1[key1];
163: 
164:                 key2 = bytes32((uint256(key1) << 8) | uint256(leaves).mostSignificantBit());
165:                 leaves = tree.level2[key2];
166: 
167:                 key3 = bytes32((uint256(key2) << 8) | uint256(leaves).mostSignificantBit());
168:                 leaves = tree.level3[key3];
169: 
170:                 return uint32((uint256(key3) << 8) | uint256(leaves).mostSignificantBit());
171:             }
172:         }
173: 
174:         return type(uint32).max;
175:     }
```
['[184](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/TreeMath.sol#L184-L184)']
```solidity
184:     function findFirstLeft(TreeUint32 storage tree, uint32 id) internal view returns (uint32) { // <= FOUND
185:         bytes32 leaves;
186: 
187:         bytes32 key3 = bytes32(uint256(id) >> 8);
188:         uint8 bit = uint8(id & type(uint8).max);
189: 
190:         if (bit != type(uint8).max) {
191:             leaves = tree.level3[key3];
192:             uint256 closestBit = _closestBitLeft(leaves, bit);
193: 
194:             if (closestBit != type(uint256).max) return uint32((uint256(key3) << 8) | closestBit);
195:         }
196: 
197:         bytes32 key2 = key3 >> 8;
198:         bit = uint8(uint256(key3) & type(uint8).max);
199: 
200:         if (bit != type(uint8).max) {
201:             leaves = tree.level2[key2];
202:             uint256 closestBit = _closestBitLeft(leaves, bit);
203: 
204:             if (closestBit != type(uint256).max) {
205:                 key3 = bytes32((uint256(key2) << 8) | closestBit);
206:                 leaves = tree.level3[key3];
207: 
208:                 return uint32((uint256(key3) << 8) | uint256(leaves).leastSignificantBit());
209:             }
210:         }
211: 
212:         bytes32 key1 = key2 >> 8;
213:         bit = uint8(uint256(key2) & type(uint8).max);
214: 
215:         if (bit != type(uint8).max) {
216:             leaves = tree.level1[key1];
217:             uint256 closestBit = _closestBitLeft(leaves, bit);
218: 
219:             if (closestBit != type(uint256).max) {
220:                 key2 = bytes32((uint256(key1) << 8) | closestBit);
221:                 leaves = tree.level2[key2];
222: 
223:                 key3 = bytes32((uint256(key2) << 8) | uint256(leaves).leastSignificantBit());
224:                 leaves = tree.level3[key3];
225: 
226:                 return uint32((uint256(key3) << 8) | uint256(leaves).leastSignificantBit());
227:             }
228:         }
229: 
230:         bit = uint8(uint256(key1) & type(uint8).max);
231: 
232:         if (bit != type(uint8).max) {
233:             leaves = tree.level0;
234:             uint256 closestBit = _closestBitLeft(leaves, bit);
235: 
236:             if (closestBit != type(uint256).max) {
237:                 key1 = bytes32(closestBit);
238:                 leaves = tree.level1[key1];
239: 
240:                 key2 = bytes32((uint256(key1) << 8) | uint256(leaves).leastSignificantBit());
241:                 leaves = tree.level2[key2];
242: 
243:                 key3 = bytes32((uint256(key2) << 8) | uint256(leaves).leastSignificantBit());
244:                 leaves = tree.level3[key3];
245: 
246:                 return uint32((uint256(key3) << 8) | uint256(leaves).leastSignificantBit());
247:             }
248:         }
249: 
250:         return 0;
251:     }
```
['[531](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L531-L531)']
```solidity
531:     function _executeCancel(uint40 _orderId, Order memory _order) internal { // <= FOUND
532:         
533:         if (_order.prev != OrderLinkedList.NULL) {
534:             s_orders[_order.prev].next = _order.next;
535:         }
536:         if (_order.next != OrderLinkedList.NULL) {
537:             s_orders[_order.next].prev = _order.prev;
538:         }
539: 
540:         if (_order.isBuy) {
541:             
542:             if (_orderId == s_buyPricePoints[_order.price].head) {
543:                 OrderLinkedList.updateHead(s_buyPricePoints[_order.price], _order.next);
544:                 if (_order.next == OrderLinkedList.NULL) {
545:                     
546:                     TreeMath.remove(s_buyTree, _order.price);
547:                 }
548:             } else {
549:                 OrderLinkedList.adjustForTail(s_buyPricePoints[_order.price], _order.prev, _order.next);
550:             }
551: 
552:             marginAccount.creditUser(
553:                 _order.ownerAddress,
554:                 quoteAsset,
555:                 (((toU96((_order.size * _order.price) / sizePrecision) * quoteDecimalMultiplier) / pricePrecision)),
556:                 true
557:             );
558:         } else {
559:             if (_orderId == s_sellPricePoints[_order.price].head) {
560:                 OrderLinkedList.updateHead(s_sellPricePoints[_order.price], _order.next);
561:                 if (_order.next == OrderLinkedList.NULL) {
562:                     
563:                     TreeMath.remove(s_sellTree, _order.price);
564:                 }
565:             } else {
566:                 OrderLinkedList.adjustForTail(s_sellPricePoints[_order.price], _order.prev, _order.next);
567:             }
568: 
569:             marginAccount.creditUser(
570:                 _order.ownerAddress, baseAsset, ((_order.size * baseDecimalMultiplier) / sizePrecision), true
571:             );
572:         }
573: 
574:         emit OrderCanceled(_orderId, _order.ownerAddress, _order.price, _order.size, _order.isBuy);
575:     }
```
['[586](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L586-L586)']
```solidity
586:     function _checkIfCancelledOrFilled(uint40 _orderId, Order memory _order) internal view returns (bool) { // <= FOUND
587:         if (_order.prev != OrderLinkedList.NULL) {
588:             if (s_orders[_order.prev].next != _orderId) {
589:                 return true;
590:             }
591:             if (_order.isBuy) {
592:                 
593:                 uint40 _head = s_buyPricePoints[_order.price].head;
594:                 if (_head > _orderId || _head == OrderLinkedList.NULL) {
595:                     return true;
596:                 }
597:                 return false;
598:             } else {
599:                 uint40 _head = s_sellPricePoints[_order.price].head;
600:                 if (_head > _orderId || _head == OrderLinkedList.NULL) {
601:                     return true;
602:                 }
603:                 return false;
604:             }
605:         } else {
606:             if (_order.isBuy) {
607:                 if (s_buyPricePoints[_order.price].head != _orderId) {
608:                     return true;
609:                 }
610:                 return false;
611:             } else {
612:                 if (s_sellPricePoints[_order.price].head != _orderId) {
613:                     return true;
614:                 }
615:                 return false;
616:             }
617:         }
618:     }
```
[]
```solidity
728:     function placeAndExecuteMarketBuy(uint96 _quoteSize, uint256 _minAmountOut, bool _isMargin, bool _isFillOrKill)
729:         public
730:         payable
731:         override
732:         marketActive
733:         nonReentrant
734:         returns (uint256)
735:     {
736:         OrderBookType _type = orderBookType;
737: 
738:         if (_type == OrderBookType.NATIVE_IN_QUOTE && !_isMargin && (msg.sender != address(0))) {
739:             require(
740:                 msg.value >= _pricePrecisionToQuoteAssetPrecision(_quoteSize), OrderBookErrors.NativeAssetInsufficient()
741:             );
742:             require(
743:                 msg.value < _pricePrecisionToQuoteAssetPrecision(_quoteSize + 1), OrderBookErrors.NativeAssetSurplus()
744:             );
745:         } else if (msg.sender != address(0)) {
746:             require(msg.value == 0, OrderBookErrors.NativeAssetNotRequired());
747:             _isMargin
748:                 ? marginAccount.debitUser(_msgSender(), quoteAsset, _pricePrecisionToQuoteAssetPrecision(_quoteSize))
749:                 : quoteAsset.safeTransferFrom(
750:                     _msgSender(), address(marginAccount), _pricePrecisionToQuoteAssetPrecision(_quoteSize)
751:                 );
752:         }
753: 
754:         uint256 _baseTokensCredited;
755:         (_quoteSize, _baseTokensCredited) = _marketBuyMatch(_quoteSize, _isMargin);
756:         if (msg.sender == address(0)) {
757:             return _baseTokensCredited;
758:         }
759:         if (_quoteSize > 0) {
760:             require(!_isFillOrKill, OrderBookErrors.InsufficientLiquidity());
761:             if (_type == OrderBookType.NATIVE_IN_QUOTE && !_isMargin) {
762:                 
763:                 uint256 _refund = _pricePrecisionToQuoteAssetPrecision(_quoteSize);
764:                 _handleNativeMarketRefundTransfer(_refund);
765:             } else {
766:                 marginAccount.creditUser(
767:                     _msgSender(), quoteAsset, _pricePrecisionToQuoteAssetPrecision(_quoteSize), _isMargin
768:                 );
769:             }
770:         } else if (_type == OrderBookType.NATIVE_IN_QUOTE) {
771:             address(marginAccount).safeTransferETH(msg.value);
772:         }
773:         require(_baseTokensCredited >= _minAmountOut, OrderBookErrors.SlippageExceeded());
774: 
775:         return _baseTokensCredited;
776:     }
```
[]
```solidity
786:     function placeAndExecuteMarketSell(uint96 _size, uint256 _minAmountOut, bool _isMargin, bool _isFillOrKill)
787:         public
788:         payable
789:         marketActive
790:         nonReentrant
791:         returns (uint256)
792:     {
793:         OrderBookType _type = orderBookType;
794:         if (_type == OrderBookType.NATIVE_IN_BASE && !_isMargin && (msg.sender != address(0))) {
795:             require(msg.value >= _sizePrecisionToBaseAssetPrecision(_size), OrderBookErrors.NativeAssetInsufficient());
796:             require(msg.value < _sizePrecisionToBaseAssetPrecision(_size + 1), OrderBookErrors.NativeAssetSurplus());
797:         } else if (msg.sender != address(0)) {
798:             require(msg.value == 0, OrderBookErrors.NativeAssetNotRequired());
799:             _isMargin
800:                 ? marginAccount.debitUser(_msgSender(), baseAsset, _sizePrecisionToBaseAssetPrecision(_size))
801:                 : baseAsset.safeTransferFrom(
802:                     _msgSender(), address(marginAccount), _sizePrecisionToBaseAssetPrecision(_size)
803:                 );
804:         }
805: 
806:         uint256 _quoteCredited;
807:         (_size, _quoteCredited) = _matchAggressiveSell(0, _size, _isMargin);
808:         if (msg.sender == address(0)) {
809:             return _quoteCredited;
810:         }
811:         if (_size > 0) {
812:             require(!_isFillOrKill, OrderBookErrors.InsufficientLiquidity());
813:             if (_type == OrderBookType.NATIVE_IN_BASE && !_isMargin) {
814:                 uint256 _refund = _sizePrecisionToBaseAssetPrecision(_size);
815:                 _handleNativeMarketRefundTransfer(_refund);
816:             } else {
817:                 marginAccount.creditUser(_msgSender(), baseAsset, _sizePrecisionToBaseAssetPrecision(_size), _isMargin);
818:             }
819:         } else if (_type == OrderBookType.NATIVE_IN_BASE) {
820:             address(marginAccount).safeTransferETH(msg.value);
821:         }
822:         require(_quoteCredited >= _minAmountOut, OrderBookErrors.SlippageExceeded());
823:         return _quoteCredited;
824:     }
```
[]
```solidity
855:     function _matchAggressiveBuyWithCap(uint256 _limitPrice, uint96 _sizeToBeFilled)
856:         internal
857:         returns (uint96, uint96)
858:     {
859:         uint96 sizeToCreditTaker;
860:         uint96 sizeToCreditViaVault;
861:         uint96 fundsConsumed;
862:         bytes memory makerCredits;
863:         (bool _isVaultFill, uint256 _bestAsk) = bestAsk();
864:         uint32 _pricePrecision = pricePrecision;
865:         _limitPrice = _limitPrice * vaultPricePrecision / _pricePrecision;
866: 
867:         while (_sizeToBeFilled > 0 && _bestAsk <= _limitPrice && _bestAsk != 0) {
868:             uint96 sizeToBeFilledBefore = _sizeToBeFilled; 
869:             bytes memory priceUpdate;
870: 
871:             if (_isVaultFill) {
872:                 uint96 _vaultFundsConsumed;
873:                 (_sizeToBeFilled, _vaultFundsConsumed, priceUpdate) =
874:                     _fillVaultForBuy(_getOBAsk() > _limitPrice ? _limitPrice + 1 : _getOBAsk(), _sizeToBeFilled);
875:                 fundsConsumed += _vaultFundsConsumed;
876:             } else {
877:                 (_sizeToBeFilled, priceUpdate) = _fillSizeForPrice(
878:                     s_sellTree,
879:                     toU32(_bestAsk * _pricePrecision / vaultPricePrecision),
880:                     s_sellPricePoints[_bestAsk * _pricePrecision / vaultPricePrecision],
881:                     _sizeToBeFilled
882:                 );
883:             }
884: 
885:             uint96 sizeFilled = sizeToBeFilledBefore - _sizeToBeFilled;
886:             sizeToCreditTaker += sizeFilled;
887:             if (_isVaultFill) {
888:                 sizeToCreditViaVault += sizeFilled;
889:             } else {
890:                 fundsConsumed += _quoteAmountRoundedUp(
891:                     toU32(FixedPointMathLib.mulDivUp(_bestAsk, _pricePrecision, vaultPricePrecision)), sizeFilled
892:                 );
893:             }
894:             makerCredits = bytes.concat(makerCredits, priceUpdate);
895: 
896:             (_isVaultFill, _bestAsk) = bestAsk();
897:         }
898: 
899:         if (sizeToCreditTaker == 0) {
900:             return (_sizeToBeFilled, 0);
901:         }
902:         {
903:             uint96 _sizePrecision = sizePrecision;
904:             uint256 _baseDecimalMultiplier = baseDecimalMultiplier;
905:             uint256 _tokenCredit = (sizeToCreditTaker * _baseDecimalMultiplier) / _sizePrecision;
906:             if (sizeToCreditViaVault > 0) {
907:                 marginAccount.debitUser(
908:                     kuruAmmVault, baseAsset, (sizeToCreditViaVault * _baseDecimalMultiplier) / _sizePrecision
909:                 );
910:             }
911:             uint256 _takerFeeBps = takerFeeBps;
912:             if (_takerFeeBps > 0) {
913:                 uint256 _feeDebit = FixedPointMathLib.mulDivUp(_tokenCredit, _takerFeeBps, BPS_MULTIPLIER);
914:                 _tokenCredit -= _feeDebit;
915:                 
916:                 baseFeeCollected += ((_feeDebit * (_takerFeeBps - makerFeeBps)) / _takerFeeBps);
917:             }
918:             marginAccount.creditUsersEncoded(
919:                 bytes.concat(makerCredits, abi.encode(_msgSender(), baseAsset, _tokenCredit, true))
920:             );
921:         }
922: 
923:         return (_sizeToBeFilled, fundsConsumed);
924:     }
```
['[930](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L930-L930)']
```solidity
930:     function _marketBuyMatch(uint96 _quoteSize, bool _isMargin) internal returns (uint96, uint256) { // <= FOUND
931:         uint96 sizeToCreditTaker;
932:         uint96 sizeToCreditViaVault;
933:         bytes memory makerCredits;
934:         uint32 _pricePrecision = pricePrecision;
935:         uint96 _sizePrecision = sizePrecision;
936: 
937:         (bool _isVaultFill, uint256 _bestAsk) = bestAsk();
938: 
939:         while (_quoteSize > 0 && _bestAsk != 0) {
940:             bytes memory priceUpdate;
941:             if (_isVaultFill) {
942:                 uint96 _sizeFilled;
943:                 (_quoteSize, _sizeFilled, priceUpdate) = _fillVaultBuyMatch(_getOBAsk(), _quoteSize);
944:                 sizeToCreditViaVault += _sizeFilled;
945:                 sizeToCreditTaker += _sizeFilled;
946:             } else {
947:                 
948:                 uint96 _sizeFillableAtPriceLeft =
949:                     toU96(_quoteSize * _sizePrecision * vaultPricePrecision / (_bestAsk * _pricePrecision));
950:                 uint96 _sizeFillableAtPriceBefore = _sizeFillableAtPriceLeft; 
951:                 (_sizeFillableAtPriceLeft, priceUpdate) = _fillSizeForPrice(
952:                     s_sellTree,
953:                     toU32(_bestAsk * _pricePrecision / vaultPricePrecision),
954:                     s_sellPricePoints[(_bestAsk * _pricePrecision / vaultPricePrecision)],
955:                     _sizeFillableAtPriceLeft
956:                 );
957:                 sizeToCreditTaker += (_sizeFillableAtPriceBefore - _sizeFillableAtPriceLeft);
958:                 _quoteSize = toU96(
959:                     FixedPointMathLib.mulDiv(
960:                         _bestAsk * _pricePrecision, _sizeFillableAtPriceLeft, _sizePrecision * vaultPricePrecision
961:                     )
962:                 );
963:             }
964:             makerCredits = bytes.concat(makerCredits, priceUpdate);
965: 
966:             (_isVaultFill, _bestAsk) = bestAsk();
967:         }
968: 
969:         if (sizeToCreditTaker == 0) {
970:             return (_quoteSize, 0);
971:         }
972: 
973:         {
974:             uint256 _baseDecimalMultiplier = baseDecimalMultiplier;
975:             uint256 _tokenCredit = (sizeToCreditTaker * _baseDecimalMultiplier) / _sizePrecision;
976:             if (sizeToCreditViaVault > 0 && msg.sender != address(0)) {
977:                 marginAccount.debitUser(
978:                     kuruAmmVault, baseAsset, (sizeToCreditViaVault * _baseDecimalMultiplier) / _sizePrecision
979:                 );
980:             }
981:             uint256 _takerFeeBps = takerFeeBps;
982:             if (_takerFeeBps > 0) {
983:                 uint256 _feeDebit = FixedPointMathLib.mulDivUp(_tokenCredit, _takerFeeBps, BPS_MULTIPLIER);
984:                 _tokenCredit -= _feeDebit;
985:                 
986:                 baseFeeCollected += ((_feeDebit * (_takerFeeBps - makerFeeBps)) / _takerFeeBps);
987:             }
988:             if (msg.sender != address(0)) {
989:                 marginAccount.creditUsersEncoded(
990:                     bytes.concat(makerCredits, abi.encode(_msgSender(), baseAsset, _tokenCredit, _isMargin))
991:                 );
992:             }
993:             return (_quoteSize, _tokenCredit);
994:         }
995:     }
```
[]
```solidity
1003:     function _matchAggressiveSell(uint256 _limitPrice, uint96 _sizeToBeFilledLeft, bool _useMargin)
1004:         internal
1005:         returns (uint96, uint256)
1006:     {
1007:         uint96 quoteCreditTaker;
1008:         uint256 quoteCreditVaultTaker;
1009:         uint256 tokenCredit;
1010:         (bool _isVaultFill, uint256 _bestBid) = bestBid();
1011:         bytes memory makerCredits;
1012:         uint32 _pricePrecision = pricePrecision;
1013:         _limitPrice = _limitPrice * vaultPricePrecision / _pricePrecision;
1014:         while (_sizeToBeFilledLeft > 0 && _bestBid >= _limitPrice && _bestBid != type(uint256).max) {
1015:             uint96 _sizeToBeFilledBefore = _sizeToBeFilledLeft; 
1016: 
1017:             bytes memory priceUpdate;
1018: 
1019:             if (_isVaultFill) {
1020:                 uint256 _quoteToTaker;
1021:                 (_sizeToBeFilledLeft, _quoteToTaker, priceUpdate) =
1022:                     _fillVaultForSell(_getOBBid() >= _limitPrice ? _getOBBid() : _limitPrice - 1, _sizeToBeFilledLeft);
1023:                 quoteCreditVaultTaker += _quoteToTaker;
1024:             } else {
1025:                 (_sizeToBeFilledLeft, priceUpdate) = _fillSizeForPrice(
1026:                     s_buyTree,
1027:                     toU32(_bestBid * _pricePrecision / vaultPricePrecision),
1028:                     s_buyPricePoints[_bestBid * _pricePrecision / vaultPricePrecision],
1029:                     _sizeToBeFilledLeft
1030:                 );
1031:                 quoteCreditTaker += toU96(
1032:                     FixedPointMathLib.mulDiv(
1033:                         _sizeToBeFilledBefore - _sizeToBeFilledLeft,
1034:                         toU32(_bestBid * _pricePrecision / vaultPricePrecision),
1035:                         sizePrecision
1036:                     )
1037:                 );
1038:             }
1039:             makerCredits = bytes.concat(makerCredits, priceUpdate);
1040: 
1041:             (_isVaultFill, _bestBid) = bestBid();
1042:         }
1043: 
1044:         if (quoteCreditTaker == 0 && quoteCreditVaultTaker == 0) {
1045:             return (_sizeToBeFilledLeft, 0);
1046:         }
1047:         {
1048:             uint256 _quoteDecimalMultiplier = quoteDecimalMultiplier;
1049:             tokenCredit = ((quoteCreditTaker) * _quoteDecimalMultiplier) / _pricePrecision
1050:                 + (quoteCreditVaultTaker * _quoteDecimalMultiplier) / vaultPricePrecision;
1051:             if (quoteCreditVaultTaker > 0 && msg.sender != address(0)) {
1052:                 marginAccount.debitUser(
1053:                     kuruAmmVault, quoteAsset, (quoteCreditVaultTaker * _quoteDecimalMultiplier) / vaultPricePrecision
1054:                 );
1055:             }
1056:             uint256 _takerFeeBps = takerFeeBps;
1057:             if (_takerFeeBps > 0) {
1058:                 uint256 _feeDebit = FixedPointMathLib.mulDivUp(tokenCredit, _takerFeeBps, BPS_MULTIPLIER);
1059:                 tokenCredit -= _feeDebit;
1060:                 
1061:                 quoteFeeCollected += ((_feeDebit * (_takerFeeBps - makerFeeBps)) / _takerFeeBps);
1062:             }
1063:             if (msg.sender != address(0)) {
1064:                 marginAccount.creditUsersEncoded(
1065:                     bytes.concat(makerCredits, abi.encode(_msgSender(), quoteAsset, tokenCredit, _useMargin))
1066:                 );
1067:             }
1068:         }
1069: 
1070:         return (_sizeToBeFilledLeft, tokenCredit);
1071:     }
```
[]
```solidity
1118:     function _fillOrder(uint40 _orderId, uint96 _incomingSizeToBeFilled)
1119:         internal
1120:         returns (uint96 incomingOrderRemainingSize, uint40 _nextHead, bytes memory _orderUpdate)
1121:     {
1122:         _nextHead = s_orders[_orderId].next;
1123:         uint96 _preExistingOrderSize = s_orders[_orderId].size;
1124:         
1125:         incomingOrderRemainingSize =
1126:             (_incomingSizeToBeFilled > _preExistingOrderSize) ? (_incomingSizeToBeFilled - _preExistingOrderSize) : 0;
1127:         uint96 _preExistingOrderUpdatedSize;
1128:         if (incomingOrderRemainingSize == 0) {
1129:             
1130:             _preExistingOrderUpdatedSize = _preExistingOrderSize - _incomingSizeToBeFilled;
1131:         }
1132:         if (s_orders[_orderId].flippedPrice == 0) {
1133:             _orderUpdate = _creditMaker(
1134:                 !s_orders[_orderId].isBuy,
1135:                 s_orders[_orderId].ownerAddress,
1136:                 (incomingOrderRemainingSize == 0) ? _incomingSizeToBeFilled : s_orders[_orderId].size,
1137:                 s_orders[_orderId].price
1138:             );
1139:         }
1140: 
1141:         if (incomingOrderRemainingSize == 0) {
1142:             if (_preExistingOrderUpdatedSize != 0) {
1143:                 _nextHead = _orderId;
1144:             }
1145:             s_orders[_orderId].size = _preExistingOrderUpdatedSize;
1146:         }
1147: 
1148:         if (s_orders[_orderId].flippedPrice != 0) {
1149:             _handleFlipOrderUpdate(
1150:                 _orderId,
1151:                 _incomingSizeToBeFilled - incomingOrderRemainingSize,
1152:                 _preExistingOrderUpdatedSize == 0 ? true : false
1153:             );
1154:         }
1155:         
1156:         _emitTrade(
1157:             _orderId,
1158:             s_orders[_orderId].ownerAddress,
1159:             !s_orders[_orderId].isBuy,
1160:             (s_orders[_orderId].price * vaultPricePrecision) / pricePrecision,
1161:             _preExistingOrderUpdatedSize,
1162:             _incomingSizeToBeFilled - incomingOrderRemainingSize
1163:         );
1164:     }
```
['[1166](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L1166-L1166)']
```solidity
1166:     function _handleFlipOrderUpdate(uint40 _orderId, uint96 _size, bool nullify) internal { // <= FOUND
1167:         
1168:         if (s_orders[_orderId].flippedId == OrderLinkedList.NULL) {
1169:             Order memory _filledOrder = s_orders[_orderId];
1170:             
1171:             uint40 _flipOrderId = s_orderIdCounter + 1;
1172:             s_orderIdCounter = _flipOrderId;
1173:             uint40 _prevOrderId;
1174:             if (!s_orders[_orderId].isBuy) {
1175:                 _size = toU96(FixedPointMathLib.mulDiv(_size, _filledOrder.price, _filledOrder.flippedPrice));
1176:                 _prevOrderId = OrderLinkedList.insertAtTail(s_buyPricePoints[_filledOrder.flippedPrice], _flipOrderId);
1177:             } else {
1178:                 _prevOrderId = OrderLinkedList.insertAtTail(s_sellPricePoints[_filledOrder.flippedPrice], _flipOrderId);
1179:             }
1180:             if (!nullify) {
1181:                 s_orders[_orderId].flippedId = _flipOrderId;
1182:             }
1183:             _addFlippedOrder(
1184:                 _filledOrder.flippedPrice,
1185:                 _filledOrder.price,
1186:                 _size,
1187:                 _filledOrder.ownerAddress,
1188:                 _flipOrderId,
1189:                 nullify ? OrderLinkedList.NULL : _orderId,
1190:                 !_filledOrder.isBuy,
1191:                 _prevOrderId
1192:             );
1193:         } else {
1194:             
1195:             uint40 _flipOrderId = s_orders[_orderId].flippedId;
1196:             if (!s_orders[_orderId].isBuy) {
1197:                 _size =
1198:                     toU96(FixedPointMathLib.mulDiv(_size, s_orders[_orderId].price, s_orders[_orderId].flippedPrice));
1199:             }
1200:             uint96 _updatedSize = s_orders[_flipOrderId].size + _size;
1201:             s_orders[_flipOrderId].size = _updatedSize;
1202:             emit FlipOrderUpdated(_flipOrderId, _updatedSize);
1203:             if (nullify) {
1204:                 s_orders[_flipOrderId].flippedId = OrderLinkedList.NULL;
1205:             }
1206:         }
1207:     }
```
['[1353](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L1353-L1353)']
```solidity
1353:     function bestAsk() internal view returns (bool, uint256) { // <= FOUND
1354:         uint256 firstLeft = TreeMath.findFirstLeft(s_sellTree, 0) * vaultPricePrecision / pricePrecision;
1355:         if (firstLeft != 0) {
1356:             if (vaultBestAsk != type(uint256).max) {
1357:                 if (firstLeft == vaultBestAsk) {
1358:                     return (false, firstLeft);
1359:                 }
1360:                 return (FixedPointMathLib.min(firstLeft, vaultBestAsk)) == vaultBestAsk
1361:                     ? (true, vaultBestAsk)
1362:                     : (false, firstLeft);
1363:             }
1364:             return (false, firstLeft);
1365:         }
1366:         return (vaultBestAsk != type(uint256).max) ? (true, vaultBestAsk) : (false, 0);
1367:     }
```
['[1369](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L1369-L1369)']
```solidity
1369:     function bestBid() internal view returns (bool, uint256) { // <= FOUND
1370:         uint256 firstRight = TreeMath.findFirstRight(s_buyTree, type(uint32).max) * vaultPricePrecision / pricePrecision;
1371:         if (firstRight != type(uint32).max * vaultPricePrecision / pricePrecision) {
1372:             if (vaultBestBid != 0) {
1373:                 if (firstRight == vaultBestBid) {
1374:                     return (false, firstRight);
1375:                 }
1376:                 return (FixedPointMathLib.max(firstRight, vaultBestBid)) == vaultBestBid
1377:                     ? (true, vaultBestBid)
1378:                     : (false, firstRight);
1379:             }
1380:             return (false, firstRight);
1381:         }
1382:         return vaultBestBid != 0 ? (true, vaultBestBid) : (false, type(uint256).max);
1383:     }
```
['[1399](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L1399-L1399)']
```solidity
1399:     function getL2Book(uint32 _bidPricePoints, uint32 _askPricePoints) public view returns (bytes memory data) { // <= FOUND
1400:         uint256 dataStart;
1401:         uint256 lastFree;
1402: 
1403:         assembly ("memory-safe") {
1404:             dataStart := mload(0x40)
1405:             lastFree := add(dataStart, 32)
1406:             mstore(lastFree, number()) 
1407:             lastFree := add(lastFree, 32)
1408:             mstore(0x40, lastFree)
1409:         }
1410: 
1411:         
1412:         uint32 price = TreeMath.findFirstRight(s_buyTree, type(uint32).max);
1413:         while (price != type(uint32).max && price != 0 && _bidPricePoints != 0) {
1414:             uint40 orderId = s_buyPricePoints[price].head;
1415:             uint96 size = 0;
1416:             while (orderId != 0) {
1417:                 size += s_orders[orderId].size;
1418:                 orderId = s_orders[orderId].next;
1419:             }
1420:             assembly ("memory-safe") {
1421:                 let curFree := mload(0x40)
1422:                 if iszero(eq(curFree, lastFree)) {
1423:                     
1424:                     let producedLen := sub(lastFree, dataStart)
1425:                     for { let offset := 0 } lt(offset, producedLen) { offset := add(offset, 32) } {
1426:                         mstore(add(curFree, offset), mload(add(dataStart, offset)))
1427:                     }
1428:                     dataStart := curFree
1429:                     lastFree := add(curFree, producedLen)
1430:                 }
1431: 
1432:                 mstore(lastFree, price)
1433:                 mstore(add(lastFree, 32), size)
1434:                 lastFree := add(lastFree, 64)
1435:                 mstore(0x40, lastFree)
1436:             }
1437:             price = TreeMath.findFirstRight(s_buyTree, price);
1438:             --_bidPricePoints;
1439:         }
1440: 
1441:         assembly ("memory-safe") {
1442:             let curFree := mload(0x40)
1443:             if iszero(eq(curFree, lastFree)) {
1444:                 let producedLen := sub(lastFree, dataStart)
1445:                 for { let offset := 0 } lt(offset, producedLen) { offset := add(offset, 32) } {
1446:                     mstore(add(curFree, offset), mload(add(dataStart, offset)))
1447:                 }
1448:                 dataStart := curFree
1449:                 lastFree := add(curFree, producedLen)
1450:             }
1451: 
1452:             mstore(lastFree, 0)
1453:             lastFree := add(lastFree, 32)
1454:             mstore(0x40, lastFree)
1455:         }
1456: 
1457:         price = TreeMath.findFirstLeft(s_sellTree, 0);
1458:         while (price != type(uint32).max && price != 0 && _askPricePoints != 0) {
1459:             uint40 orderId = s_sellPricePoints[price].head;
1460:             uint96 size = 0;
1461:             while (orderId != 0) {
1462:                 size += s_orders[orderId].size;
1463:                 orderId = s_orders[orderId].next;
1464:             }
1465:             assembly ("memory-safe") {
1466:                 let curFree := mload(0x40)
1467:                 if iszero(eq(curFree, lastFree)) {
1468:                     
1469:                     let producedLen := sub(lastFree, dataStart)
1470:                     for { let offset := 0 } lt(offset, producedLen) { offset := add(offset, 32) } {
1471:                         mstore(add(curFree, offset), mload(add(dataStart, offset)))
1472:                     }
1473:                     dataStart := curFree
1474:                     lastFree := add(curFree, producedLen)
1475:                 }
1476: 
1477:                 mstore(lastFree, price)
1478:                 mstore(add(lastFree, 32), size)
1479:                 lastFree := add(lastFree, 64)
1480:                 mstore(0x40, lastFree)
1481:             }
1482:             price = TreeMath.findFirstLeft(s_sellTree, price);
1483:             --_askPricePoints;
1484:         }
1485: 
1486:         assembly ("memory-safe") {
1487:             mstore(dataStart, sub(lastFree, add(dataStart, 32)))
1488:             data := dataStart
1489:         }
1490:     }
```


</details>

## [NonCritical-44] Incorrect withdraw declaration

### Resolution 
In Solidity, it's essential for clarity and interoperability to correctly specify return types in function declarations. If the `withdraw` function is expected to return a `bool` to indicate success or failure, its omission could lead to ambiguity or unexpected behavior when interacting with or calling this function from other contracts or off-chain systems. Missing return values can mislead developers and potentially lead to contract integrations built on incorrect assumptions. To resolve this, the function declaration for `withdraw` should be modified to explicitly include the `bool` return type, ensuring clarity and correctness in contract interactions.

Num of instances: 1

### Findings 


<details><summary>Click to show findings</summary>

['[217](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L217-L217)']
```solidity
217:     function withdraw(uint256 _amount, address _token) external protocolActive  // <= FOUND
```


</details>

## [NonCritical-45] Contract does not follow the Solidity style guide's suggested layout ordering

### Resolution 
Contracts should define structs before modifiers and modifiers before functions.

Num of instances: 1

### Findings 


<details><summary>Click to show findings</summary>

['[17](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L17-L17)']
```solidity
17: contract MarginAccount is IMarginAccount, ERC2771Context, Ownable, Initializable, UUPSUpgradeable  // <= FOUND
```


</details>

## [NonCritical-46] Don't only depend on Solidity's arithmetic ordering.

### Resolution 
Relying on Solidity's default arithmetic operator precedence can lead to misunderstood or overlooked nuances in code execution. Misinterpretation risks can be significant, especially when different developers or auditors review the code. To ensure clarity and minimize potential errors, it's recommended to use parentheses. These not only override the default precedence when needed but also emphasize the intended order of operations. By deliberately showing the intended calculation sequence using parentheses, developers make the code's logic explicit, reducing the risk of unintended behaviors and making the codebase more maintainable and understandable for all stakeholders.

Num of instances: 4

### Findings 


<details><summary>Click to show findings</summary>

['[227](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L227-L227)']
```solidity
227:             x = x - k * 54916777467707473351141471128;
```
['[865](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L865-L865)']
```solidity
865:         _limitPrice = _limitPrice * vaultPricePrecision / _pricePrecision;
```
['[1340](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L1340-L1340)']
```solidity
1340:             return firstLeft * vaultPricePrecision / pricePrecision;
```
['[1348](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L1348-L1348)']
```solidity
1348:             return firstRight * vaultPricePrecision / pricePrecision;
```


</details>

## [NonCritical-47] A event should be emitted if a non immutable state variable is set in a constructor

Num of instances: 2

### Findings 


<details><summary>Click to show findings</summary>

['[49](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/periphery/MonadDeployer.sol#L49-L59)']
```solidity
49:     constructor(
50:         IRouter _router,
51:         address _owner,
52:         address _marginAccount,
53:         address _kuruCollective,
54:         uint96 _kuruAmmSpread,
55:         uint256 _kuruCollectiveFee
56:     ) {
57:         _initializeOwner(_owner);
58:         router = _router;
59:         marginAccount = IMarginAccount(_marginAccount); // <= FOUND
60:         kuruAmmSpread = _kuruAmmSpread;
61:         kuruCollective = _kuruCollective;
62:         kuruCollectiveFee = _kuruCollectiveFee;
63:     }
```
['[12](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/periphery/ERC20.sol#L12-L13)']
```solidity
12:     constructor(string memory name_, string memory symbol_, uint256 initialSupply_, address mintRecipient_) {
13:         _name = name_; // <= FOUND
14:         _symbol = symbol_;
15:         
16:         _mint(mintRecipient_, initialSupply_);
17:     }
```


</details>

## [NonCritical-48] Non constant/immutable state variables are missing a setter post deployment

### Resolution 
Non-constant or non-immutable state variables lacking a setter function can create inflexibility in contract operations. If there's no way to update these variables post-deployment, the contract might not adapt to changing conditions or requirements, which can be a significant drawback, especially in upgradable or long-lived contracts. To resolve this, implement setter functions guarded by appropriate access controls, like `onlyOwner` or similar modifiers, so that these variables can be updated as required while maintaining security. This enables smoother contract maintenance and feature upgrades.

Num of instances: 2

### Findings 


<details><summary>Click to show findings</summary>

['[30](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L30-L30)']
```solidity
30:  TreeMath.TreeUint32 public s_buyTree;
```
['[31](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L31-L31)']
```solidity
31:  TreeMath.TreeUint32 public s_sellTree;
```


</details>

## [NonCritical-49] Addition/multiplication in unchecked block is unsafe

Num of instances: 5

### Findings 


<details><summary>Click to show findings</summary>

['[203](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L203-L226)']
```solidity
203:        unchecked { // <= FOUND
204:             
205:             
206:             if (x <= -41446531673892822313) return r;
207: 
208:             
209:             assembly {
210:                 
211:                 
212:                 if iszero(slt(x, 135305999368893231589)) {
213:                     mstore(0x00, 0xa37bfec9) 
214:                     revert(0x1c, 0x04)
215:                 }
216:             }
217: 
218:             
219:             
220:             
221:             x = (x << 78) / 5 ** 18;
222: 
223:             
224:             
225:             
226:             int256 k = ((x << 96) / 54916777467707473351141471128 + 2 ** 95) >> 96; // <= FOUND
227:             x = x - k * 54916777467707473351141471128;
228: 
229:             
230: 
231:             
232:             
233:             int256 y = x + 1346386616545796478920950773328;
234:             y = ((y * x) >> 96) + 57155421227552351082224309758442;
235:             int256 p = y + x - 94201549194550492254356042504812;
236:             p = ((p * y) >> 96) + 28719021644029726153956944680412240;
237:             p = p * x + (4385272521454847904659076985693276 << 96);
238: 
239:             
240:             int256 q = x - 2855989394907223263936484059900;
241:             q = ((q * x) >> 96) + 50020603652535783019961831881945;
242:             q = ((q * x) >> 96) - 533845033583426703283633433725380;
243:             q = ((q * x) >> 96) + 3604857256930695427073651918091429;
244:             q = ((q * x) >> 96) - 14423608567350463180887372962807573;
245:             q = ((q * x) >> 96) + 26449188498355588339934803723976023;
246: 
247:             
248:             assembly {
249:                 
250:                 
251:                 
252:                 r := sdiv(p, q)
253:             }
254: 
255:             
256: 
257:             
258:             
259:             
260:             
261:             
262:             
263:             r = int256((uint256(r) * 3822833074963236453042738258902158003155416615667) >> uint256(195 - k));
264:         }
```
['[725](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L725-L726)']
```solidity
725:        unchecked { // <= FOUND
726:             if (x <= type(uint256).max / 10 ** 18) return sqrt(x * 10 ** 18); // <= FOUND
727:             z = (1 + sqrt(x)) * 10 ** 9;
728:             z = (fullMulDivUnchecked(x, 10 ** 18, z) + z) >> 1;
729:         }
```
['[740](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L740-L741)']
```solidity
740:        unchecked { // <= FOUND
741:             if (x <= type(uint256).max / 10 ** 36) return cbrt(x * 10 ** 36); // <= FOUND
742:             z = (1 + cbrt(x)) * 10 ** 12;
743:             z = (fullMulDivUnchecked(x, 10 ** 36, z * z) + z + z) / 3;
744:         }
```
['[1060](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L1060-L1061)']
```solidity
1060:         unchecked { // <= FOUND
1061:             if (b >= a) return int256(uint256(a) + fullMulDiv(uint256(b) - uint256(a), // <= FOUND
1062:                 uint256(t) - uint256(begin), uint256(end) - uint256(begin)));
1063:             return int256(uint256(a) - fullMulDiv(uint256(a) - uint256(b),
1064:                 uint256(t) - uint256(begin), uint256(end) - uint256(begin)));
1065:         }
```
['[274](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/TreeMath.sol#L274-L275)']
```solidity
274:        unchecked { // <= FOUND
275:             return uint256(leaves).closestBitLeft(bit + 1); // <= FOUND
276:         }
```


</details>

## [NonCritical-50] Long numbers should include underscores to improve readability and prevent typos

### Resolution 
A large number such as 2000000 is far more readable as 2_000_000, this will help prevent unintended bugs in the code

Num of instances: 43

### Findings 


<details><summary>Click to show findings</summary>

['[19](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/AbstractAMM.sol#L19-L19)']
```solidity
19:     uint256 constant DOUBLE_BPS_MULTIPLIER = 20000; // <= FOUND
```
['[20](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/AbstractAMM.sol#L20-L20)']
```solidity
20:     uint256 constant BPS_MULTIPLIER = 10000; // <= FOUND
```
['[206](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L206-L208)']
```solidity
206:             
207:             
208:             if (x <= -41446531673892822313) return r; // <= FOUND
```
['[212](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L212-L214)']
```solidity
212:                 
213:                 
214:                 if iszero(slt(x, 135305999368893231589)) { // <= FOUND
```
['[226](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L226-L229)']
```solidity
226:             
227:             
228:             
229:             int256 k = ((x << 96) / 54916777467707473351141471128 + 2 ** 95) >> 96; // <= FOUND
```
['[227](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L227-L227)']
```solidity
227:             x = x - k * 54916777467707473351141471128; // <= FOUND
```
['[233](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L233-L237)']
```solidity
233:             
234: 
235:             
236:             
237:             int256 y = x + 1346386616545796478920950773328; // <= FOUND
```
['[234](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L234-L234)']
```solidity
234:             y = ((y * x) >> 96) + 57155421227552351082224309758442; // <= FOUND
```
['[235](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L235-L235)']
```solidity
235:             int256 p = y + x - 94201549194550492254356042504812; // <= FOUND
```
['[236](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L236-L236)']
```solidity
236:             p = ((p * y) >> 96) + 28719021644029726153956944680412240; // <= FOUND
```
['[237](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L237-L237)']
```solidity
237:             p = p * x + (4385272521454847904659076985693276 << 96); // <= FOUND
```
['[240](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L240-L241)']
```solidity
240:             
241:             int256 q = x - 2855989394907223263936484059900; // <= FOUND
```
['[241](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L241-L241)']
```solidity
241:             q = ((q * x) >> 96) + 50020603652535783019961831881945; // <= FOUND
```
['[242](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L242-L242)']
```solidity
242:             q = ((q * x) >> 96) - 533845033583426703283633433725380; // <= FOUND
```
['[243](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L243-L243)']
```solidity
243:             q = ((q * x) >> 96) + 3604857256930695427073651918091429; // <= FOUND
```
['[244](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L244-L244)']
```solidity
244:             q = ((q * x) >> 96) - 14423608567350463180887372962807573; // <= FOUND
```
['[245](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L245-L245)']
```solidity
245:             q = ((q * x) >> 96) + 26449188498355588339934803723976023; // <= FOUND
```
['[263](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L263-L271)']
```solidity
263:             
264: 
265:             
266:             
267:             
268:             
269:             
270:             
271:             r = int256((uint256(r) * 3822833074963236453042738258902158003155416615667) >> uint256(195 - k)); // <= FOUND
```
['[290](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L290-L302)']
```solidity
290:             
291:             r := xor(r, byte(and(0x1f, shr(shr(r, x), 0x8421084210842108cc6318c6db6d54be)),
292:                 0xf8f9f9faf9fdfafbf9fdfcfdfafbfcfef9fafdfafcfcfbfefafafcfbffffffff))
293: 
294:             
295:             
296:             x := shr(159, shl(r, x))
297: 
298:             
299:             
300:             
301:             let p := sub( 
302:                 sar(96, mul(add(43456485725739037958740375743393, // <= FOUND
303:                 sar(96, mul(add(24828157081833163892658089445524,
304:                 sar(96, mul(add(3273285459638523848632254066296,
305:                     x), x))), x))), x)), 11111509109440967052023855526967)
306:             p := sub(sar(96, mul(p, x)), 45023709667254063763336534515857)
307:             p := sub(sar(96, mul(p, x)), 14706773417378608786704636184526)
308:             p := sub(mul(p, x), shl(96, 795164235651350426258249787498))
309:             
310: 
311:             
312:             let q := add(5573035233440673466300451813936, x)
313:             q := add(71694874799317883764090561454958, sar(96, mul(x, q)))
314:             q := add(283447036172924575727196451306956, sar(96, mul(x, q)))
315:             q := add(401686690394027663651624208769553, sar(96, mul(x, q)))
316:             q := add(204048457590392012362485061816622, sar(96, mul(x, q)))
317:             q := add(31853899698501571402653359427138, sar(96, mul(x, q)))
318:             q := add(909429971244387300277376558375, sar(96, mul(x, q)))
319: 
320:             
321: 
322:             
323:             
324:             
325:             
326:             
327: 
328:             
329:             
330:             p := sdiv(p, q)
331:             
332:             p := mul(1677202110996718588342820967067443963516166, p)
333:             
334:             
335:             p := add(mul(16597577552685614221487285958193947469193820559219878177908093499208371, sub(159, r)), p)
336:             
337:             p := add(600920179829731861736702779321621459595472258049074101567377883020018308, p)
338:             
339:             r := sar(174, p)
340:         }
```
['[349](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L349-L349)']
```solidity
349:             if ((w = x) <= -367879441171442322) revert OutOfDomain();  // <= FOUND
```
['[377](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L377-L378)']
```solidity
377:                     
378:                     w := add(sdiv(mul(ll, 1023715080943847266), w), sub(w, ll)) // <= FOUND
379:                     i := add(3, iszero(shr(68, x)))
380:                     c := iszero(shr(143, x))
381:                 }
```
['[646](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L646-L678)']
```solidity
646:             
647:             z := 181 
648: 
649:             
650:             
651: 
652:             
653:             
654:             let r := shl(7, lt(0xffffffffffffffffffffffffffffffffff, x))
655:             r := or(r, shl(6, lt(0xffffffffffffffffff, shr(r, x))))
656:             r := or(r, shl(5, lt(0xffffffffff, shr(r, x))))
657:             r := or(r, shl(4, lt(0xffffff, shr(r, x))))
658:             z := shl(shr(1, r), z)
659: 
660:             
661:             
662:             
663:             
664: 
665:             
666:             
667:             
668: 
669:             
670:             
671:             
672: 
673:             
674:             
675:             
676: 
677:             
678:             z := shr(18, mul(z, add(shr(r, x), 65536)))  // <= FOUND
679: 
680:             
681:             z := shr(1, add(z, div(x, z)))
682:             z := shr(1, add(z, div(x, z)))
683:             z := shr(1, add(z, div(x, z)))
684:             z := shr(1, add(z, div(x, z)))
685:             z := shr(1, add(z, div(x, z)))
686:             z := shr(1, add(z, div(x, z)))
687:             z := shr(1, add(z, div(x, z)))
688: 
689:             
690:             
691:             
692:             z := sub(z, lt(div(x, z), z))
693:         }
```
['[732](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L732-L732)']
```solidity
732:             z := sub(z, gt(999999999999999999, sub(mulmod(z, z, x), 1)))  // <= FOUND
733:         }
```
['[751](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L751-L751)']
```solidity
751:                         p := mul(p, 100000000000000000)  // <= FOUND
752:                         break
753:                     }
```
['[754](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L754-L754)']
```solidity
754:                     p := mul(p, 100000000)  // <= FOUND
755:                     break
756:                 }
```
['[810](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L810-L810)']
```solidity
810:             if iszero(lt(x, 100000000000000000000000000000000000000)) { // <= FOUND
```
['[811](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L811-L811)']
```solidity
811:                 x := div(x, 100000000000000000000000000000000000000) // <= FOUND
812:                 r := 38
813:             }
```
['[814](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L814-L814)']
```solidity
814:             if iszero(lt(x, 100000000000000000000)) { // <= FOUND
```
['[815](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L815-L815)']
```solidity
815:                 x := div(x, 100000000000000000000) // <= FOUND
816:                 r := add(r, 20)
817:             }
```
['[818](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L818-L818)']
```solidity
818:             if iszero(lt(x, 10000000000)) { // <= FOUND
```
['[819](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L819-L819)']
```solidity
819:                 x := div(x, 10000000000) // <= FOUND
820:                 r := add(r, 10)
821:             }
```
['[822](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L822-L822)']
```solidity
822:             if iszero(lt(x, 100000)) { // <= FOUND
```
['[823](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L823-L823)']
```solidity
823:                 x := div(x, 100000) // <= FOUND
824:                 r := add(r, 5)
825:             }
```
['[870](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L870-L870)']
```solidity
870:                 if iszero(mod(mantissa, 1000000000000000000000000000000000)) { // <= FOUND
```
['[871](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L871-L871)']
```solidity
871:                     mantissa := div(mantissa, 1000000000000000000000000000000000) // <= FOUND
872:                     exponent := 33
873:                 }
```
['[874](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L874-L874)']
```solidity
874:                 if iszero(mod(mantissa, 10000000000000000000)) { // <= FOUND
```
['[875](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L875-L875)']
```solidity
875:                     mantissa := div(mantissa, 10000000000000000000) // <= FOUND
876:                     exponent := add(exponent, 19)
877:                 }
```
['[878](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L878-L878)']
```solidity
878:                 if iszero(mod(mantissa, 1000000000000)) { // <= FOUND
```
['[879](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L879-L879)']
```solidity
879:                     mantissa := div(mantissa, 1000000000000) // <= FOUND
880:                     exponent := add(exponent, 12)
881:                 }
```
['[882](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L882-L882)']
```solidity
882:                 if iszero(mod(mantissa, 1000000)) { // <= FOUND
```
['[883](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L883-L883)']
```solidity
883:                     mantissa := div(mantissa, 1000000) // <= FOUND
884:                     exponent := add(exponent, 6)
885:                 }
```
['[886](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L886-L886)']
```solidity
886:                 if iszero(mod(mantissa, 10000)) { // <= FOUND
```
['[887](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L887-L887)']
```solidity
887:                     mantissa := div(mantissa, 10000) // <= FOUND
888:                     exponent := add(exponent, 4)
889:                 }
```


</details>

## [NonCritical-51] Use 'using' keyword when using specific imports rather than calling the specific import directly

### Resolution 
In Solidity, the `using` keyword can streamline the use of library functions for specific types. Instead of calling library functions directly with their full import paths, you can declare a library once with `using` for a specific type. This approach makes your code more readable and concise. For example, instead of `LibraryName.functionName(variable)`, you would first declare `using LibraryName for TypeName;` at the contract level. After this, you can call library functions directly on variables of `TypeName` like `variable.functionName()`. This method not only enhances code clarity but also promotes cleaner and more organized code, especially when multiple functions from the same library are used frequently.

Num of instances: 161

### Findings 


<details><summary>Click to show findings</summary>

['[69](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/AbstractAMM.sol#L69-L70)']
```solidity
69:         
70:         if (_quoteInput >= FixedPointMathLib.mulDivUp(_price, _availableSize, _getSizePrecision())) { // <= FOUND 'FixedPointMathLib.'
```
['[74](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/AbstractAMM.sol#L74-L74)']
```solidity
74:             uint256 _quoteNeededForFill = FixedPointMathLib.mulDivUp(_price, _availableSize, _getSizePrecision()); // <= FOUND 'FixedPointMathLib.'
```
['[85](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/AbstractAMM.sol#L85-L86)']
```solidity
85:                 _cachedLastVaultSize = toU96(
86:                     FixedPointMathLib.mulDiv( // <= FOUND 'FixedPointMathLib.'
87:                         _cachedLastVaultSize, DOUBLE_BPS_MULTIPLIER, DOUBLE_BPS_MULTIPLIER + SPREAD_CONSTANT
88:                     )
89:                 );
```
['[92](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/AbstractAMM.sol#L92-L92)']
```solidity
92:                 _price = FixedPointMathLib.mulDivRound(_price, BPS_MULTIPLIER + SPREAD_CONSTANT, BPS_MULTIPLIER); // <= FOUND 'FixedPointMathLib.'
```
['[93](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/AbstractAMM.sol#L93-L94)']
```solidity
93:                 _cachedPartiallyFilledBid = toU96(
94:                     FixedPointMathLib.mulDiv( // <= FOUND 'FixedPointMathLib.'
95:                         _cachedPartiallyFilledBid, BPS_MULTIPLIER, BPS_MULTIPLIER + SPREAD_CONSTANT
96:                     )
97:                 );
```
['[102](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/AbstractAMM.sol#L102-L102)']
```solidity
102:             vaultBestBid = FixedPointMathLib.mulDivRound(_price, BPS_MULTIPLIER, BPS_MULTIPLIER + SPREAD_CONSTANT); // <= FOUND 'FixedPointMathLib.'
```
['[104](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/AbstractAMM.sol#L104-L105)']
```solidity
104:             vaultBidOrderSize = toU96(
105:                 FixedPointMathLib.mulDiv( // <= FOUND 'FixedPointMathLib.'
106:                     _cachedLastVaultSize, DOUBLE_BPS_MULTIPLIER + SPREAD_CONSTANT, DOUBLE_BPS_MULTIPLIER
107:                 )
108:             );
```
['[111](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/AbstractAMM.sol#L111-L111)']
```solidity
111:         quoteLeft = toU96(FixedPointMathLib.mulDiv(_quoteInput, _getPricePrecision(), vaultPricePrecision)); // <= FOUND 'FixedPointMathLib.'
```
['[142](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/AbstractAMM.sol#L142-L142)']
```solidity
142:                 _consumedQuote += FixedPointMathLib.mulDivUp(sizeLeft, _price, _getSizePrecision()); // <= FOUND 'FixedPointMathLib.'
```
['[148](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/AbstractAMM.sol#L148-L148)']
```solidity
148:                 _consumedQuote += FixedPointMathLib.mulDivUp(_availableSize, _price, _getSizePrecision()); // <= FOUND 'FixedPointMathLib.'
```
['[175](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/AbstractAMM.sol#L175-L175)']
```solidity
175:         fundsConsumed = toU96(FixedPointMathLib.mulDivUp(_consumedQuote, _getPricePrecision(), vaultPricePrecision)); // <= FOUND 'FixedPointMathLib.'
```
['[202](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/AbstractAMM.sol#L202-L202)']
```solidity
202:                 quoteOwedToUser += FixedPointMathLib.mulDiv(_price, sizeLeft, _getSizePrecision()); // <= FOUND 'FixedPointMathLib.'
```
['[208](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/AbstractAMM.sol#L208-L208)']
```solidity
208:                 quoteOwedToUser += FixedPointMathLib.mulDiv(_price, _availableSize, _getSizePrecision()); // <= FOUND 'FixedPointMathLib.'
```
['[209](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/AbstractAMM.sol#L209-L210)']
```solidity
209:                 _cachedLastVaultSize = toU96(
210:                     FixedPointMathLib.mulDiv( // <= FOUND 'FixedPointMathLib.'
211:                         _cachedLastVaultSize, DOUBLE_BPS_MULTIPLIER + SPREAD_CONSTANT, DOUBLE_BPS_MULTIPLIER
212:                     )
213:                 );
```
['[216](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/AbstractAMM.sol#L216-L216)']
```solidity
216:                 _price = FixedPointMathLib.mulDivRound(_price, BPS_MULTIPLIER, BPS_MULTIPLIER + SPREAD_CONSTANT); // <= FOUND 'FixedPointMathLib.'
```
['[221](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/AbstractAMM.sol#L221-L221)']
```solidity
221:             vaultBestAsk = FixedPointMathLib.mulDivRound(_price, BPS_MULTIPLIER + SPREAD_CONSTANT, BPS_MULTIPLIER); // <= FOUND 'FixedPointMathLib.'
```
['[223](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/AbstractAMM.sol#L223-L224)']
```solidity
223:             vaultAskOrderSize = toU96(
224:                 FixedPointMathLib.mulDiv( // <= FOUND 'FixedPointMathLib.'
225:                     _cachedLastVaultSize, DOUBLE_BPS_MULTIPLIER, DOUBLE_BPS_MULTIPLIER + SPREAD_CONSTANT
226:                 )
227:             );
```
['[179](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L179-L181)']
```solidity
179:             uint256 _expectedQuoteAmount = (
180:                 (
181:                     FixedPointMathLib.mulDivUp(baseDeposit, _currentAskPrice, vaultPricePrecision) // <= FOUND 'FixedPointMathLib.'
182:                         * 10 ** marketParams.quoteAssetDecimals
183:                 )
184:             ) / 10 ** marketParams.baseAssetDecimals;
```
['[190](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L190-L190)']
```solidity
190:             _shares = FixedPointMathLib.sqrt(baseDeposit * quoteDeposit); // <= FOUND 'FixedPointMathLib.'
```
['[201](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L201-L205)']
```solidity
201:         market.updateVaultOrdSz(
202:             _newAskSize,
203:             _newBidSize,
204:             _currentAskPrice,
205:             FixedPointMathLib.mulDivRound(_currentAskPrice, BPS_MULTIPLIER, BPS_MULTIPLIER + SPREAD_CONSTANT), // <= FOUND 'FixedPointMathLib.'
206:             false
207:         );
```
['[319](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L319-L328)']
```solidity
319:         
320:         
321:         uint96 _normalizedBaseAmount = roundUp
322:             ? toU96(
323:                 FixedPointMathLib.mulDivUp( // <= FOUND 'FixedPointMathLib.'
324:                     market.vaultAskOrderSize(), DOUBLE_BPS_MULTIPLIER + SPREAD_CONSTANT, SPREAD_CONSTANT
325:                 )
326:             )
327:             : toU96(
328:                 FixedPointMathLib.mulDiv( // <= FOUND 'FixedPointMathLib.'
329:                     market.vaultAskOrderSize(), DOUBLE_BPS_MULTIPLIER + SPREAD_CONSTANT, SPREAD_CONSTANT
330:                 )
331:             );
```
['[344](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L344-L346)']
```solidity
344:         return FixedPointMathLib.min( // <= FOUND 'FixedPointMathLib.'
345:             FixedPointMathLib.mulDiv(baseAmount, totalSupply(), _reserve1), // <= FOUND 'FixedPointMathLib.'
346:             FixedPointMathLib.mulDiv(quoteAmount, totalSupply(), _reserve2) // <= FOUND 'FixedPointMathLib.'
347:         );
```
['[363](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L363-L363)']
```solidity
363:             _baseAmount = FixedPointMathLib.mulDiv(shares, _baseReserve, totalSupply()); // <= FOUND 'FixedPointMathLib.'
```
['[364](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L364-L366)']
```solidity
364:             _quoteAmount = (
365:                 (
366:                     FixedPointMathLib.mulDivUp(_baseAmount, _currentAskPrice, vaultPricePrecision) // <= FOUND 'FixedPointMathLib.'
367:                         * 10 ** marketParams.quoteAssetDecimals
368:                 )
369:             ) / 10 ** marketParams.baseAssetDecimals;
```
['[382](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L382-L382)']
```solidity
382:         uint256 _baseAmountAfterRemoval = _baseAmount - FixedPointMathLib.mulDiv(shares, _baseAmount, totalSupply()); // <= FOUND 'FixedPointMathLib.'
```
['[399](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L399-L401)']
```solidity
399:             int256 _quoteOwedToVault = (
400:                 int256(FixedPointMathLib.mulDivUp(_partiallyFilledBidSize, _vaultBestBid, _marketParams.sizePrecision)) // <= FOUND 'FixedPointMathLib.'
401:                     - int256(FixedPointMathLib.mulDiv(_partiallyFilledAskSize, _vaultBestAsk, _marketParams.sizePrecision)) // <= FOUND 'FixedPointMathLib.'
402:             ) * int256(10 ** _marketParams.quoteAssetDecimals) / int256(vaultPricePrecision);
```
['[407](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L407-L408)']
```solidity
407:                 _baseOwedToUser =
408:                     FixedPointMathLib.mulDiv(shares, _reserveBase, totalSupply()) + uint256(-1 * _baseOwedToVault); // <= FOUND 'FixedPointMathLib.'
```
['[411](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L411-L412)']
```solidity
411:                 _baseOwedToUser =
412:                     FixedPointMathLib.mulDiv(shares, _reserveBase, totalSupply()) - uint256(_baseOwedToVault); // <= FOUND 'FixedPointMathLib.'
```
['[416](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L416-L417)']
```solidity
416:                 _quoteOwedToUser =
417:                     FixedPointMathLib.mulDiv(shares, _reserveQuote, totalSupply()) + uint256(-1 * _quoteOwedToVault); // <= FOUND 'FixedPointMathLib.'
```
['[420](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L420-L421)']
```solidity
420:                 _quoteOwedToUser =
421:                     FixedPointMathLib.mulDiv(shares, _reserveQuote, totalSupply()) - uint256(_quoteOwedToVault); // <= FOUND 'FixedPointMathLib.'
```
['[425](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L425-L425)']
```solidity
425:             uint256 _baseOwedToUser = FixedPointMathLib.mulDiv(shares, _reserveBase, totalSupply()); // <= FOUND 'FixedPointMathLib.'
```
['[426](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L426-L426)']
```solidity
426:             uint256 _quoteOwedToUser = FixedPointMathLib.mulDiv(shares, _reserveQuote, totalSupply()); // <= FOUND 'FixedPointMathLib.'
```
['[890](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L890-L891)']
```solidity
890:                 fundsConsumed += _quoteAmountRoundedUp(
891:                     toU32(FixedPointMathLib.mulDivUp(_bestAsk, _pricePrecision, vaultPricePrecision)), sizeFilled // <= FOUND 'FixedPointMathLib.'
892:                 );
```
['[913](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L913-L913)']
```solidity
913:                 uint256 _feeDebit = FixedPointMathLib.mulDivUp(_tokenCredit, _takerFeeBps, BPS_MULTIPLIER); // <= FOUND 'FixedPointMathLib.'
```
['[958](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L958-L959)']
```solidity
958:                 _quoteSize = toU96(
959:                     FixedPointMathLib.mulDiv( // <= FOUND 'FixedPointMathLib.'
960:                         _bestAsk * _pricePrecision, _sizeFillableAtPriceLeft, _sizePrecision * vaultPricePrecision
961:                     )
962:                 );
```
['[1031](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L1031-L1032)']
```solidity
1031:                 quoteCreditTaker += toU96(
1032:                     FixedPointMathLib.mulDiv( // <= FOUND 'FixedPointMathLib.'
1033:                         _sizeToBeFilledBefore - _sizeToBeFilledLeft,
1034:                         toU32(_bestBid * _pricePrecision / vaultPricePrecision),
1035:                         sizePrecision
1036:                     )
1037:                 );
```
['[1058](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L1058-L1058)']
```solidity
1058:                 uint256 _feeDebit = FixedPointMathLib.mulDivUp(tokenCredit, _takerFeeBps, BPS_MULTIPLIER); // <= FOUND 'FixedPointMathLib.'
```
['[1175](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L1175-L1175)']
```solidity
1175:                 _size = toU96(FixedPointMathLib.mulDiv(_size, _filledOrder.price, _filledOrder.flippedPrice)); // <= FOUND 'FixedPointMathLib.'
```
['[1197](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L1197-L1198)']
```solidity
1197:                 _size =
1198:                     toU96(FixedPointMathLib.mulDiv(_size, s_orders[_orderId].price, s_orders[_orderId].flippedPrice)); // <= FOUND 'FixedPointMathLib.'
```
['[1226](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L1226-L1226)']
```solidity
1226:         uint256 _result = FixedPointMathLib.mulDivUp(_price, _size, sizePrecision); // <= FOUND 'FixedPointMathLib.'
```
['[1360](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L1360-L1360)']
```solidity
1360:                 return (FixedPointMathLib.min(firstLeft, vaultBestAsk)) == vaultBestAsk // <= FOUND 'FixedPointMathLib.'
1361:                     ? (true, vaultBestAsk)
1362:                     : (false, firstLeft);
```
['[1376](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L1376-L1376)']
```solidity
1376:                 return (FixedPointMathLib.max(firstRight, vaultBestBid)) == vaultBestBid // <= FOUND 'FixedPointMathLib.'
1377:                     ? (true, vaultBestBid)
1378:                     : (false, firstRight);
```
['[33](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/AbstractAMM.sol#L33-L33)']
```solidity
33:             revert OrderBookErrors.OnlyVaultAllowed(); // <= FOUND 'OrderBookErrors.'
```
['[332](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/AbstractAMM.sol#L332-L332)']
```solidity
332:         require((_to = uint32(_from)) == _from, OrderBookErrors.Uint32Overflow()); // <= FOUND 'OrderBookErrors.'
```
['[336](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/AbstractAMM.sol#L336-L336)']
```solidity
336:         require((_to = uint96(_from)) == _from, OrderBookErrors.Uint96Overflow()); // <= FOUND 'OrderBookErrors.'
```
['[65](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L65-L65)']
```solidity
65:         require(marketState == MarketState.ACTIVE, OrderBookErrors.MarketStateError()); // <= FOUND 'OrderBookErrors.'
```
['[70](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L70-L70)']
```solidity
70:         require(marketState != MarketState.HARD_PAUSED, OrderBookErrors.MarketStateError()); // <= FOUND 'OrderBookErrors.'
```
['[106](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L106-L106)']
```solidity
106:         require(_makerFeeBps <= _takerFeeBps && _takerFeeBps < BPS_MULTIPLIER, OrderBookErrors.MarketFeeError()); // <= FOUND 'OrderBookErrors.'
```
['[107](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L107-L107)']
```solidity
107:         require(_kuruAmmSpread % 10 == 0 && _kuruAmmSpread > 0 && _kuruAmmSpread < 500, OrderBookErrors.InvalidSpread()); // <= FOUND 'OrderBookErrors.'
```
['[108](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L108-L108)']
```solidity
108:         require(_minSize > 0 && _maxSize > _minSize, OrderBookErrors.MarketSizeError()); // <= FOUND 'OrderBookErrors.'
```
['[134](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L134-L134)']
```solidity
134:         require(msg.sender == owner, OrderBookErrors.Unauthorized()); // <= FOUND 'OrderBookErrors.'
```
['[149](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L149-L149)']
```solidity
149:         require(_state != marketState, OrderBookErrors.MarketStateError()); // <= FOUND 'OrderBookErrors.'
```
['[170](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L170-L170)']
```solidity
170:         require(_price > 0 && _price < type(uint32).max, OrderBookErrors.PriceError()); // <= FOUND 'OrderBookErrors.'
```
['[171](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L171-L171)']
```solidity
171:         require(size > minSize, OrderBookErrors.SizeError()); // <= FOUND 'OrderBookErrors.'
```
['[172](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L172-L172)']
```solidity
172:         require(size < maxSize, OrderBookErrors.SizeError()); // <= FOUND 'OrderBookErrors.'
```
['[173](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L173-L173)']
```solidity
173:         require(_price % tickSize == 0, OrderBookErrors.TickSizeError()); // <= FOUND 'OrderBookErrors.'
```
['[182](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L182-L182)']
```solidity
182:             require(size == _remainingSize, OrderBookErrors.PostOnlyError()); // <= FOUND 'OrderBookErrors.'
```
['[210](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L210-L210)']
```solidity
210:         require(_price > 0 && _flippedPrice > 0 && _flippedPrice < type(uint32).max, OrderBookErrors.PriceError()); // <= FOUND 'OrderBookErrors.'
```
['[211](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L211-L211)']
```solidity
211:         require(_price % tickSize == 0 && _flippedPrice % tickSize == 0, OrderBookErrors.TickSizeError()); // <= FOUND 'OrderBookErrors.'
```
['[212](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L212-L212)']
```solidity
212:         require(_price < _flippedPrice, OrderBookErrors.PriceError()); // <= FOUND 'OrderBookErrors.'
```
['[213](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L213-L213)']
```solidity
213:         require(_size > minSize && _size < maxSize, OrderBookErrors.SizeError()); // <= FOUND 'OrderBookErrors.'
```
['[219](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L219-L219)']
```solidity
219:                     revert OrderBookErrors.ProvisionError(); // <= FOUND 'OrderBookErrors.'
```
['[242](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L242-L242)']
```solidity
242:         require(_size > minSize, OrderBookErrors.SizeError()); // <= FOUND 'OrderBookErrors.'
```
['[243](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L243-L243)']
```solidity
243:         require(_size < maxSize, OrderBookErrors.SizeError()); // <= FOUND 'OrderBookErrors.'
```
['[253](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L253-L253)']
```solidity
253:             require(_remainingSize == _size, OrderBookErrors.PostOnlyError()); // <= FOUND 'OrderBookErrors.'
```
['[280](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L280-L280)']
```solidity
280:         require(_price > 0 && _flippedPrice > 0 && _price < type(uint32).max, OrderBookErrors.PriceError()); // <= FOUND 'OrderBookErrors.'
```
['[282](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L282-L282)']
```solidity
282:         require(_price > _flippedPrice, OrderBookErrors.PriceError()); // <= FOUND 'OrderBookErrors.'
```
['[316](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L316-L316)']
```solidity
316:         require(_bidPrice > 0 && _askPrice > _bidPrice && _askPrice < type(uint32).max, OrderBookErrors.PriceError()); // <= FOUND 'OrderBookErrors.'
```
['[317](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L317-L317)']
```solidity
317:         require(_bidPrice % tickSize == 0 && _askPrice % tickSize == 0, OrderBookErrors.TickSizeError()); // <= FOUND 'OrderBookErrors.'
```
['[318](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L318-L318)']
```solidity
318:         require(_bidSize > minSize && _bidSize < maxSize, OrderBookErrors.SizeError()); // <= FOUND 'OrderBookErrors.'
```
['[319](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L319-L319)']
```solidity
319:         require(_askSize > minSize && _askSize < maxSize, OrderBookErrors.SizeError()); // <= FOUND 'OrderBookErrors.'
```
['[323](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L323-L325)']
```solidity
323:             require(
324:                 ((uint256(_bidPrice) * vaultPricePrecision / pricePrecision) < _bestAsk) || (_bestAsk == 0),
325:                 OrderBookErrors.ProvisionError() // <= FOUND 'OrderBookErrors.'
326:             );
```
['[327](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L327-L330)']
```solidity
327:             require(
328:                 ((uint256(_askPrice) * vaultPricePrecision / pricePrecision) > _bestBid)
329:                     || (_bestBid == type(uint256).max),
330:                 OrderBookErrors.ProvisionError() // <= FOUND 'OrderBookErrors.'
331:             );
```
['[498](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L498-L498)']
```solidity
498:         require(!_checkIfCancelledOrFilled(_orderId, _order), OrderBookErrors.OrderAlreadyFilledOrCancelled()); // <= FOUND 'OrderBookErrors.'
```
['[499](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L499-L499)']
```solidity
499:         require(_msgSender() == _order.ownerAddress, OrderBookErrors.OnlyOwnerAllowedError()); // <= FOUND 'OrderBookErrors.'
```
['[500](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L500-L500)']
```solidity
500:         require(_order.flippedPrice != 0, OrderBookErrors.WrongOrderTypeCancel()); // <= FOUND 'OrderBookErrors.'
```
['[514](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L514-L514)']
```solidity
514:         require(_order.flippedPrice == 0, OrderBookErrors.WrongOrderTypeCancel()); // <= FOUND 'OrderBookErrors.'
```
['[517](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L517-L517)']
```solidity
517:                 revert OrderBookErrors.OrderAlreadyFilledOrCancelled(); // <= FOUND 'OrderBookErrors.'
```
['[634](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L634-L635)']
```solidity
634:         require(
635:             bidPrices.length == bidSizes.length && askPrices.length == askSizes.length, OrderBookErrors.LengthMismatch() // <= FOUND 'OrderBookErrors.'
636:         );
```
['[658](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L658-L658)']
```solidity
658:         require(prices.length == flipPrices.length, OrderBookErrors.LengthMismatch()); // <= FOUND 'OrderBookErrors.'
```
['[659](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L659-L659)']
```solidity
659:         require(sizes.length == isBuy.length, OrderBookErrors.LengthMismatch()); // <= FOUND 'OrderBookErrors.'
```
['[660](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L660-L660)']
```solidity
660:         require(prices.length == sizes.length, OrderBookErrors.LengthMismatch()); // <= FOUND 'OrderBookErrors.'
```
['[688](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L688-L689)']
```solidity
688:         
689:         require(buyPrices.length == buySizes.length, OrderBookErrors.LengthMismatch()); // <= FOUND 'OrderBookErrors.'
```
['[691](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L691-L692)']
```solidity
691:         
692:         require(sellPrices.length == sellSizes.length, OrderBookErrors.LengthMismatch()); // <= FOUND 'OrderBookErrors.'
```
['[739](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L739-L740)']
```solidity
739:             require(
740:                 msg.value >= _pricePrecisionToQuoteAssetPrecision(_quoteSize), OrderBookErrors.NativeAssetInsufficient() // <= FOUND 'OrderBookErrors.'
741:             );
```
['[742](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L742-L743)']
```solidity
742:             require(
743:                 msg.value < _pricePrecisionToQuoteAssetPrecision(_quoteSize + 1), OrderBookErrors.NativeAssetSurplus() // <= FOUND 'OrderBookErrors.'
744:             );
```
['[746](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L746-L746)']
```solidity
746:             require(msg.value == 0, OrderBookErrors.NativeAssetNotRequired()); // <= FOUND 'OrderBookErrors.'
```
['[760](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L760-L760)']
```solidity
760:             require(!_isFillOrKill, OrderBookErrors.InsufficientLiquidity()); // <= FOUND 'OrderBookErrors.'
```
['[773](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L773-L773)']
```solidity
773:         require(_baseTokensCredited >= _minAmountOut, OrderBookErrors.SlippageExceeded()); // <= FOUND 'OrderBookErrors.'
```
['[795](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L795-L795)']
```solidity
795:             require(msg.value >= _sizePrecisionToBaseAssetPrecision(_size), OrderBookErrors.NativeAssetInsufficient()); // <= FOUND 'OrderBookErrors.'
```
['[796](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L796-L796)']
```solidity
796:             require(msg.value < _sizePrecisionToBaseAssetPrecision(_size + 1), OrderBookErrors.NativeAssetSurplus()); // <= FOUND 'OrderBookErrors.'
```
['[822](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L822-L822)']
```solidity
822:         require(_quoteCredited >= _minAmountOut, OrderBookErrors.SlippageExceeded()); // <= FOUND 'OrderBookErrors.'
```
['[39](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L39-L39)']
```solidity
39:         require(protocolPaused != _state, MarginAccountErrors.ProtocolStateNotChanged()); // <= FOUND 'MarginAccountErrors.'
```
['[45](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L45-L45)']
```solidity
45:         require(feeCollector != _feeCollector, MarginAccountErrors.FeeCollectorNotChanged()); // <= FOUND 'MarginAccountErrors.'
```
['[61](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L61-L61)']
```solidity
61:         require(msg.sender == routerContractAddress, MarginAccountErrors.OnlyRouterAllowed()); // <= FOUND 'MarginAccountErrors.'
```
['[66](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L66-L66)']
```solidity
66:         require(!protocolPaused, MarginAccountErrors.ProtocolPaused()); // <= FOUND 'MarginAccountErrors.'
```
['[105](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L105-L105)']
```solidity
105:         require(verifiedMarket[msg.sender], MarginAccountErrors.OnlyVerifiedMarketsAllowed()); // <= FOUND 'MarginAccountErrors.'
```
['[106](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L106-L106)']
```solidity
106:         require(balances[_accountKey(_user, _token)] >= _amount, MarginAccountErrors.InsufficientBalance()); // <= FOUND 'MarginAccountErrors.'
```
['[199](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L199-L199)']
```solidity
199:         require(_user != address(0), MarginAccountErrors.ZeroAddressNotAllowed()); // <= FOUND 'MarginAccountErrors.'
```
['[201](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L201-L201)']
```solidity
201:             require(msg.value == _amount, MarginAccountErrors.NativeAssetMismatch()); // <= FOUND 'MarginAccountErrors.'
```
['[204](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L204-L204)']
```solidity
204:             require(msg.value == 0, MarginAccountErrors.NativeAssetMismatch()); // <= FOUND 'MarginAccountErrors.'
```
['[218](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L218-L218)']
```solidity
218:         require(_amount <= balances[_accountKey(_msgSender(), _token)], MarginAccountErrors.InsufficientBalance()); // <= FOUND 'MarginAccountErrors.'
```
['[88](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L88-L88)']
```solidity
88:             require(_baseAssetAddress == address(0), RouterErrors.MarketTypeMismatch()); // <= FOUND 'RouterErrors.'
```
['[89](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L89-L89)']
```solidity
89:             require(_quoteAssetAddress != address(0), RouterErrors.MarketTypeMismatch()); // <= FOUND 'RouterErrors.'
```
['[91](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L91-L91)']
```solidity
91:             require(_baseAssetAddress != address(0), RouterErrors.MarketTypeMismatch()); // <= FOUND 'RouterErrors.'
```
['[92](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L92-L92)']
```solidity
92:             require(_quoteAssetAddress == address(0), RouterErrors.MarketTypeMismatch()); // <= FOUND 'RouterErrors.'
```
['[96](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L96-L96)']
```solidity
96:             require(_baseAssetAddress != _quoteAssetAddress, RouterErrors.BaseAndQuoteAssetSame()); // <= FOUND 'RouterErrors.'
```
['[98](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L98-L98)']
```solidity
98:         require(_tickSize > 0, RouterErrors.InvalidTickSize()); // <= FOUND 'RouterErrors.'
```
['[99](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L99-L99)']
```solidity
99:         require(10 ** Math.log10(_sizePrecision) == _sizePrecision, RouterErrors.InvalidSizePrecision()); // <= FOUND 'RouterErrors.'
```
['[100](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L100-L100)']
```solidity
100:         require(10 ** Math.log10(_pricePrecision) == _pricePrecision, RouterErrors.InvalidPricePrecision()); // <= FOUND 'RouterErrors.'
```
['[340](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L340-L340)']
```solidity
340:         require(_marketAddresses.length >= 1, RouterErrors.NoMarketsPassed()); // <= FOUND 'RouterErrors.'
```
['[341](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L341-L341)']
```solidity
341:         require(_isBuy.length == _marketAddresses.length, RouterErrors.LengthMismatch()); // <= FOUND 'RouterErrors.'
```
['[342](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L342-L342)']
```solidity
342:         require(_nativeSend.length == _marketAddresses.length, RouterErrors.LengthMismatch()); // <= FOUND 'RouterErrors.'
```
['[351](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L351-L351)']
```solidity
351:             require(_marketParams.pricePrecision > 0, RouterErrors.InvalidMarket()); // <= FOUND 'RouterErrors.'
```
['[369](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L369-L369)']
```solidity
369:         require(_amountOut >= _minAmountOut, RouterErrors.SlippageExceeded()); // <= FOUND 'RouterErrors.'
```
['[421](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L421-L421)']
```solidity
421:         require((_to = uint96(_from)) == _from, RouterErrors.Uint96Overflow()); // <= FOUND 'RouterErrors.'
```
['[90](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L90-L90)']
```solidity
90:         require(msg.sender == owner, KuruAMMVaultErrors.Unauthorized()); // <= FOUND 'KuruAMMVaultErrors.'
```
['[162](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L162-L166)']
```solidity
162:         require(
163:             (token1 == address(0) || token2 == address(0))
164:                 ? msg.value >= (token1 == address(0) ? baseDeposit : quoteDeposit)
165:                 : msg.value == 0,
166:             KuruAMMVaultErrors.NativeAssetMismatch() // <= FOUND 'KuruAMMVaultErrors.'
167:         );
```
['[185](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L185-L185)']
```solidity
185:             require(_expectedQuoteAmount <= quoteDeposit, KuruAMMVaultErrors.InsufficientQuoteToken()); // <= FOUND 'KuruAMMVaultErrors.'
```
['[199](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L199-L199)']
```solidity
199:         require(_shares > 0, KuruAMMVaultErrors.InsufficientLiquidityMinted()); // <= FOUND 'KuruAMMVaultErrors.'
```
['[246](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L246-L246)']
```solidity
246:         require(_shares <= balanceOf(_owner), KuruAMMVaultErrors.InsufficientBalance()); // <= FOUND 'KuruAMMVaultErrors.'
```
['[461](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L461-L461)']
```solidity
461:         require((_to = uint96(_from)) == _from, KuruAMMVaultErrors.Uint96Overflow()); // <= FOUND 'KuruAMMVaultErrors.'
```
['[173](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruForwarder.sol#L173-L175)']
```solidity
173:         require(
174:             !executedPriceDependentRequest[keccak256(abi.encodePacked(req.from, req.nonce))],
175:             KuruForwarderErrors.NonceAlreadyUsed() // <= FOUND 'KuruForwarderErrors.'
176:         );
```
['[224](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruForwarder.sol#L224-L224)']
```solidity
224:         require(verifyMarginAccountRequest(req, signature), KuruForwarderErrors.SignatureMismatch()); // <= FOUND 'KuruForwarderErrors.'
```
['[225](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruForwarder.sol#L225-L225)']
```solidity
225:         require(msg.value >= req.value, KuruForwarderErrors.InsufficientValue()); // <= FOUND 'KuruForwarderErrors.'
```
['[226](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruForwarder.sol#L226-L226)']
```solidity
226:         require(allowedInterface[req.selector], KuruForwarderErrors.InterfaceNotAllowed()); // <= FOUND 'KuruForwarderErrors.'
```
['[241](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruForwarder.sol#L241-L241)']
```solidity
241:         require(verify(req, signature), KuruForwarderErrors.SignatureMismatch()); // <= FOUND 'KuruForwarderErrors.'
```
['[262](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruForwarder.sol#L262-L262)']
```solidity
262:         require(verifyPriceDependent(req, signature), KuruForwarderErrors.SignatureMismatch()); // <= FOUND 'KuruForwarderErrors.'
```
['[283](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruForwarder.sol#L283-L283)']
```solidity
283:         require(verifyCancelPriceDependent(req, signature), KuruForwarderErrors.SignatureMismatch()); // <= FOUND 'KuruForwarderErrors.'
```
['[28](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L28-L28)']
```solidity
28:     mapping(uint256 => OrderLinkedList.PricePoint) public s_buyPricePoints; // <= FOUND 'OrderLinkedList.'
```
['[29](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L29-L29)']
```solidity
29:     mapping(uint256 => OrderLinkedList.PricePoint) public s_sellPricePoints; // <= FOUND 'OrderLinkedList.'
```
['[191](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L191-L192)']
```solidity
191:             
192:             uint40 _prevOrderId = OrderLinkedList.insertAtTail(s_buyPricePoints[_price], _orderId); // <= FOUND 'OrderLinkedList.'
```
['[191](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L191-L191)']
```solidity
191:         uint40 _prevOrderId = OrderLinkedList.insertAtTail(s_buyPricePoints[_price], _orderId); // <= FOUND 'OrderLinkedList.'
```
['[232](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L232-L232)']
```solidity
232:         _addFlipOrder(_price, _flippedPrice, _size, _msgSender(), _orderId, OrderLinkedList.NULL, true, _prevOrderId); // <= FOUND 'OrderLinkedList.'
```
['[262](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L262-L263)']
```solidity
262:             
263:             uint40 _prevOrderId = OrderLinkedList.insertAtTail(s_sellPricePoints[_price], _orderId); // <= FOUND 'OrderLinkedList.'
```
['[262](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L262-L262)']
```solidity
262:         uint40 _prevOrderId = OrderLinkedList.insertAtTail(s_sellPricePoints[_price], _orderId); // <= FOUND 'OrderLinkedList.'
```
['[300](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L300-L300)']
```solidity
300:         _addFlipOrder(_price, _flippedPrice, _size, _msgSender(), _orderId, OrderLinkedList.NULL, false, _prevOrderId); // <= FOUND 'OrderLinkedList.'
```
['[345](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L345-L345)']
```solidity
345:         uint40 _bidPrevOrderId = OrderLinkedList.insertAtTail(s_buyPricePoints[_bidPrice], _bidOrderId); // <= FOUND 'OrderLinkedList.'
```
['[346](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L346-L346)']
```solidity
346:         uint40 _askPrevOrderId = OrderLinkedList.insertAtTail(s_sellPricePoints[_askPrice], _askOrderId); // <= FOUND 'OrderLinkedList.'
```
['[365](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L365-L366)']
```solidity
365:         s_orders[_orderId] =
366:             Order(_msgSender(), _size, _prevOrderId, OrderLinkedList.NULL, OrderLinkedList.NULL, _price, 0, _isBuy); // <= FOUND 'OrderLinkedList.'
```
['[367](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L367-L367)']
```solidity
367:         if (_prevOrderId != OrderLinkedList.NULL) { // <= FOUND 'OrderLinkedList.'
```
['[399](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L399-L400)']
```solidity
399:         s_orders[_orderId] =
400:             Order(_owner, _size, _prevOrderId, OrderLinkedList.NULL, _flippedId, _price, _flippedPrice, _isBuy); // <= FOUND 'OrderLinkedList.'
```
['[501](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L501-L501)']
```solidity
501:         if (_order.flippedId != OrderLinkedList.NULL) { // <= FOUND 'OrderLinkedList.'
```
['[533](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L533-L534)']
```solidity
533:         
534:         if (_order.prev != OrderLinkedList.NULL) { // <= FOUND 'OrderLinkedList.'
```
['[536](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L536-L536)']
```solidity
536:         if (_order.next != OrderLinkedList.NULL) { // <= FOUND 'OrderLinkedList.'
```
['[543](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L543-L543)']
```solidity
543:                 OrderLinkedList.updateHead(s_buyPricePoints[_order.price], _order.next); // <= FOUND 'OrderLinkedList.'
```
['[544](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L544-L544)']
```solidity
544:                 if (_order.next == OrderLinkedList.NULL) { // <= FOUND 'OrderLinkedList.'
```
['[549](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L549-L549)']
```solidity
549:                 OrderLinkedList.adjustForTail(s_buyPricePoints[_order.price], _order.prev, _order.next); // <= FOUND 'OrderLinkedList.'
```
['[560](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L560-L560)']
```solidity
560:                 OrderLinkedList.updateHead(s_sellPricePoints[_order.price], _order.next); // <= FOUND 'OrderLinkedList.'
```
['[566](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L566-L566)']
```solidity
566:                 OrderLinkedList.adjustForTail(s_sellPricePoints[_order.price], _order.prev, _order.next); // <= FOUND 'OrderLinkedList.'
```
['[533](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L533-L533)']
```solidity
533:         if (_order.prev != OrderLinkedList.NULL) { // <= FOUND 'OrderLinkedList.'
```
['[594](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L594-L594)']
```solidity
594:                 if (_head > _orderId || _head == OrderLinkedList.NULL) { // <= FOUND 'OrderLinkedList.'
```
['[1080](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L1080-L1090)']
```solidity
1080:     
1087:     function _fillSizeForPrice(
1088:         TreeMath.TreeUint32 storage _tree,
1089:         uint32 _price,
1090:         OrderLinkedList.PricePoint storage _pricePoint, // <= FOUND 'OrderLinkedList.'
1091:         uint96 _size
1092:     ) internal returns (uint96, bytes memory makerCredits) {
```
['[1087](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L1087-L1087)']
```solidity
1087:         while (_size > 0 && _orderId != OrderLinkedList.NULL) { // <= FOUND 'OrderLinkedList.'
```
['[1095](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L1095-L1095)']
```solidity
1095:         OrderLinkedList.updateHead(_pricePoint, _orderId); // <= FOUND 'OrderLinkedList.'
```
['[1096](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L1096-L1096)']
```solidity
1096:         if (_orderId == OrderLinkedList.NULL) { // <= FOUND 'OrderLinkedList.'
```
['[1168](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L1168-L1169)']
```solidity
1168:         
1169:         if (s_orders[_orderId].flippedId == OrderLinkedList.NULL) { // <= FOUND 'OrderLinkedList.'
```
['[1176](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L1176-L1176)']
```solidity
1176:                 _prevOrderId = OrderLinkedList.insertAtTail(s_buyPricePoints[_filledOrder.flippedPrice], _flipOrderId); // <= FOUND 'OrderLinkedList.'
```
['[1178](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L1178-L1178)']
```solidity
1178:                 _prevOrderId = OrderLinkedList.insertAtTail(s_sellPricePoints[_filledOrder.flippedPrice], _flipOrderId); // <= FOUND 'OrderLinkedList.'
```
['[1183](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L1183-L1189)']
```solidity
1183:             _addFlippedOrder(
1184:                 _filledOrder.flippedPrice,
1185:                 _filledOrder.price,
1186:                 _size,
1187:                 _filledOrder.ownerAddress,
1188:                 _flipOrderId,
1189:                 nullify ? OrderLinkedList.NULL : _orderId, // <= FOUND 'OrderLinkedList.'
1190:                 !_filledOrder.isBuy,
1191:                 _prevOrderId
1192:             );
```
['[1204](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L1204-L1204)']
```solidity
1204:                 s_orders[_flipOrderId].flippedId = OrderLinkedList.NULL; // <= FOUND 'OrderLinkedList.'
```


</details>

## [NonCritical-52] Inconsistent checks of address params against address(0)

### Resolution 
Only some address parameters are checked against address(0), to ensure consistency ensure all address parameters are checked.

Num of instances: 6

### Findings 


<details><summary>Click to show findings</summary>

['[45](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L45-L46)']
```solidity
45:     function initialize( // <= FOUND
46:         address _owner, // <= FOUND
47:         address token1_,
48:         address token2_,
49:         address _marginAccount,
50:         address _market,
51:         uint96 _spreadConstant
52:     ) public initializer {
53:         owner = _owner;
54:         token1 = token1_;
55:         token1Decimals = token1_ != address(0) ? ERC20(token1_).decimals() : 18;
56:         token2 = token2_;
57:         token2Decimals = token2_ != address(0) ? ERC20(token2_).decimals() : 18;
58:         marginAccount = IMarginAccount(_marginAccount);
59:         market = IOrderBook(_market);
60:         SPREAD_CONSTANT = _spreadConstant;
61:         setMarketParams();
62:         if (token1_ != address(0)) {
63:             token1_.safeApprove(_marginAccount, type(uint256).max);
64:         }
65:         if (token2_ != address(0)) {
66:             token2_.safeApprove(_marginAccount, type(uint256).max);
67:         }
68:         string memory token1Symbol;
69:         string memory token2Symbol;
70:         if (token1_ != address(0)) {
71:             token1Symbol = ERC20(token1_).symbol();
72:         } else {
73:             token1Symbol = "MON";
74:         }
75:         if (token2_ != address(0)) {
76:             token2Symbol = ERC20(token2_).symbol();
77:         } else {
78:             token2Symbol = "MON";
79:         }
80:         _name = string.concat(token1Symbol, "-", token2Symbol, "-", "KURU-AMM-VAULT");
81:     }
```
['[156](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L156-L156)']
```solidity
156:     function deposit(uint256 baseDeposit, uint256 quoteDeposit, address receiver) // <= FOUND
157:         public
158:         payable
159:         nonReentrant
160:         returns (uint256)
161:     {
162:         require(
163:             (token1 == address(0) || token2 == address(0))
164:                 ? msg.value >= (token1 == address(0) ? baseDeposit : quoteDeposit)
165:                 : msg.value == 0,
166:             KuruAMMVaultErrors.NativeAssetMismatch()
167:         );
168: 
169:         return _mintAndDeposit(baseDeposit, quoteDeposit, receiver);
170:     }
```
['[175](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L175-L175)']
```solidity
175:     function _mintAndDeposit(uint256 baseDeposit, uint256 quoteDeposit, address receiver) internal returns (uint256) { // <= FOUND
176:         (uint256 _baseAmount, uint256 _currentAskPrice) = _returnNormalizedAmountAndPrice(true);
177:         uint256 _shares;
178:         if (totalSupply() != 0) {
179:             uint256 _expectedQuoteAmount = (
180:                 (
181:                     FixedPointMathLib.mulDivUp(baseDeposit, _currentAskPrice, vaultPricePrecision)
182:                         * 10 ** marketParams.quoteAssetDecimals
183:                 )
184:             ) / 10 ** marketParams.baseAssetDecimals;
185:             require(_expectedQuoteAmount <= quoteDeposit, KuruAMMVaultErrors.InsufficientQuoteToken());
186:             _shares = _convertToShares(baseDeposit, _expectedQuoteAmount, _currentAskPrice);
187:             quoteDeposit = _expectedQuoteAmount;
188:             _mint(receiver, _shares);
189:         } else {
190:             _shares = FixedPointMathLib.sqrt(baseDeposit * quoteDeposit);
191:             _mint(address(marginAccount), MIN_LIQUIDITY);
192:             _shares -= MIN_LIQUIDITY;
193:             _mint(receiver, _shares);
194:             _currentAskPrice = (
195:                 ((quoteDeposit * 10 ** marketParams.baseAssetDecimals)) * vaultPricePrecision
196:                     / 10 ** marketParams.quoteAssetDecimals
197:             ) / (baseDeposit);
198:         }
199:         require(_shares > 0, KuruAMMVaultErrors.InsufficientLiquidityMinted());
200:         (uint96 _newAskSize, uint96 _newBidSize) = _getVaultSizesForBaseAmount(_baseAmount + baseDeposit);
201:         market.updateVaultOrdSz(
202:             _newAskSize,
203:             _newBidSize,
204:             _currentAskPrice,
205:             FixedPointMathLib.mulDivRound(_currentAskPrice, BPS_MULTIPLIER, BPS_MULTIPLIER + SPREAD_CONSTANT),
206:             false
207:         );
208:         address _token1 = token1;
209:         address _token2 = token2;
210:         _depositAmountsToMarginAccount(_token1, _token2, baseDeposit, quoteDeposit);
211:         uint256 _nativeRefund =
212:             _token1 == address(0) ? (msg.value - baseDeposit) : (_token2 == address(0) ? (msg.value - quoteDeposit) : 0);
213:         if (_nativeRefund > 0) {
214:             msg.sender.safeTransferETH(_nativeRefund);
215:         }
216:         emit KuruVaultDeposit(baseDeposit, quoteDeposit, _shares, receiver);
217:         return _shares;
218:     }
```
['[294](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L294-L294)']
```solidity
294:     function _transferTokensToUser(uint256 amount, address token, address receiver) internal { // <= FOUND
295:         if (token == address(0)) {
296:             receiver.safeTransferETH(amount);
297:         } else {
298:             token.safeTransfer(receiver, amount);
299:         }
300:     }
```
['[198](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L198-L198)']
```solidity
198:     function deposit(address _user, address _token, uint256 _amount) external payable protocolActive { // <= FOUND
199:         require(_user != address(0), MarginAccountErrors.ZeroAddressNotAllowed());
200:         if (_token == NATIVE) {
201:             require(msg.value == _amount, MarginAccountErrors.NativeAssetMismatch());
202:             balances[_accountKey(_user, NATIVE)] += _amount;
203:         } else {
204:             require(msg.value == 0, MarginAccountErrors.NativeAssetMismatch());
205:             balances[_accountKey(_user, _token)] += _amount;
206:             _token.safeTransferFrom(_msgSender(), address(this), _amount);
207:         }
208: 
209:         emit Deposit(_user, _token, _amount);
210:     }
```
['[331](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L331-L335)']
```solidity
331:     function anyToAnySwap( // <= FOUND
332:         address[] calldata _marketAddresses,
333:         bool[] calldata _isBuy,
334:         bool[] calldata _nativeSend,
335:         address _debitToken, // <= FOUND
336:         address _creditToken,
337:         uint256 _amount,
338:         uint256 _minAmountOut
339:     ) external payable returns (uint256 _amountOut) {
340:         require(_marketAddresses.length >= 1, RouterErrors.NoMarketsPassed());
341:         require(_isBuy.length == _marketAddresses.length, RouterErrors.LengthMismatch());
342:         require(_nativeSend.length == _marketAddresses.length, RouterErrors.LengthMismatch());
343:         if (_nativeSend[0] == false) {
344:             _debitToken.safeTransferFrom(msg.sender, address(this), _amount);
345:         }
346:         uint256 _cachedAmountIn = _amount;
347: 
348:         for (uint256 i = 0; i < _marketAddresses.length; i++) {
349:             address _currentMarket = _marketAddresses[i];
350:             MarketParams memory _marketParams = verifiedMarket[_currentMarket];
351:             require(_marketParams.pricePrecision > 0, RouterErrors.InvalidMarket());
352:             IOrderBook market = IOrderBook(_currentMarket);
353:             uint256 _value = _nativeSend[i] ? _amount : 0;
354:             _amountOut = _isBuy[i]
355:                 ? (
356:                     market.placeAndExecuteMarketBuy{value: _value}(
357:                         toU96(_amount * _marketParams.pricePrecision / 10 ** _marketParams.quoteAssetDecimals),
358:                         0,
359:                         false,
360:                         true
361:                     )
362:                 )
363:                 : market.placeAndExecuteMarketSell{value: _value}(
364:                     toU96(_amount * _marketParams.sizePrecision / 10 ** _marketParams.baseAssetDecimals), 0, false, true
365:                 );
366: 
367:             _amount = _amountOut;
368:         }
369:         require(_amountOut >= _minAmountOut, RouterErrors.SlippageExceeded());
370:         emit KuruRouterSwap(msg.sender, _debitToken, _creditToken, _cachedAmountIn, _amountOut);
371:         if (_creditToken != address(0)) {
372:             _creditToken.safeTransfer(msg.sender, _amountOut);
373:         } else {
374:             msg.sender.safeTransferETH(_amountOut);
375:         }
376:     }
```


</details>

## [NonCritical-53] Constructors should emit an event

### Resolution 
Emitting an event in a constructor of a smart contract provides transparency and traceability in blockchain applications. This event logs the contract’s creation, aiding in monitoring and verifying contract deployment. Although constructors are executed only once, the emitted event ensures the contract's initialization is recorded on the blockchain.

Num of instances: 3

### Findings 


<details><summary>Click to show findings</summary>

['[33](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L33-L33)']
```solidity
33:     constructor() { // <= FOUND
34:         _disableInitializers();
35:     }
```
['[12](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/periphery/ERC20.sol#L12-L12)']
```solidity
12:     constructor(string memory name_, string memory symbol_, uint256 initialSupply_, address mintRecipient_) { // <= FOUND
13:         _name = name_;
14:         _symbol = symbol_;
15:         
16:         _mint(mintRecipient_, initialSupply_);
17:     }
```
['[49](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/periphery/MonadDeployer.sol#L49-L49)']
```solidity
49:     constructor( // <= FOUND
50:         IRouter _router,
51:         address _owner,
52:         address _marginAccount,
53:         address _kuruCollective,
54:         uint96 _kuruAmmSpread,
55:         uint256 _kuruCollectiveFee
56:     ) {
57:         _initializeOwner(_owner);
58:         router = _router;
59:         marginAccount = IMarginAccount(_marginAccount);
60:         kuruAmmSpread = _kuruAmmSpread;
61:         kuruCollective = _kuruCollective;
62:         kuruCollectiveFee = _kuruCollectiveFee;
63:     }
```


</details>

## [NonCritical-54] Contract and Abstract files should have a fixed compiler version

### Resolution 
Using a fixed compiler version in Solidity contract and abstract files ensures consistency and predictability in smart contract behavior. A fixed version prevents unforeseen issues arising from compiler updates, which might introduce breaking changes or new bugs. It guarantees that the contract's behavior remains stable and consistent with the version used during its development and testing.

Num of instances: 12

### Findings 


<details><summary>Click to show findings</summary>

[]
```solidity
18: contract KuruAMMVault is IKuruAMMVault, ERC20, Initializable, UUPSUpgradeable, ReentrancyGuardTransient 
```
[]
```solidity
16: contract KuruForwarder is EIP712, Initializable, Ownable, UUPSUpgradeable 
```
[]
```solidity
17: contract MarginAccount is IMarginAccount, ERC2771Context, Ownable, Initializable, UUPSUpgradeable 
```
[]
```solidity
20: contract OrderBook is Initializable, UUPSUpgradeable, ERC2771Context, AbstractAMM 
```
[]
```solidity
6: contract KuruERC20 is ERC20 
```
[]
```solidity
12: contract MonadDeployer is Ownable 
```
[]
```solidity
23: contract Router is IRouter, Ownable, Initializable, UUPSUpgradeable 
```
[]
```solidity
17: abstract contract AbstractAMM is IOrderBook, ReentrancyGuardTransient 
```
[]
```solidity
12: abstract contract ERC2771Context 
```
['[2](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L2-L2)']
```solidity
2: pragma solidity ^0.8.4; // <= FOUND
```
['[3](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/TreeMath.sol#L3-L3)']
```solidity
3: pragma solidity ^0.8.10; // <= FOUND
```
['[2](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L2-L2)']
```solidity
2: pragma solidity ^0.8.20; // <= FOUND
```


</details>

## [NonCritical-55] Function call in event emit

### Resolution 
Emits are designed to make users aware of state variable changes. As such the event declaration should be clear on what it will output, by passing in function calls this can affect the readability of a emit declaration. As such it is advisable to make function calls outside of the event emit and pass the return value into the emit instead.

Num of instances: 7

### Findings 


<details><summary>Click to show findings</summary>

['[217](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L217-L226)']
```solidity
217:     function withdraw(uint256 _amount, address _token) external protocolActive { // <= FOUND
218:         require(_amount <= balances[_accountKey(_msgSender(), _token)], MarginAccountErrors.InsufficientBalance());
219:         balances[_accountKey(_msgSender(), _token)] -= _amount;
220:         if (_token == NATIVE) {
221:             _msgSender().safeTransferETH(_amount);
222:         } else {
223:             _token.safeTransfer(_msgSender(), _amount);
224:         }
225: 
226:         emit Withdrawal(_msgSender(), _token, _amount); // <= FOUND
227:     }
```
['[359](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L359-L370)']
```solidity
359:     function _addOrder(uint32 _price, uint96 _size, uint40 _orderId, bool _isBuy, uint40 _prevOrderId) internal { // <= FOUND
360:         if (_isBuy) {
361:             TreeMath.add(s_buyTree, _price);
362:         } else {
363:             TreeMath.add(s_sellTree, _price);
364:         }
365:         s_orders[_orderId] =
366:             Order(_msgSender(), _size, _prevOrderId, OrderLinkedList.NULL, OrderLinkedList.NULL, _price, 0, _isBuy);
367:         if (_prevOrderId != OrderLinkedList.NULL) {
368:             s_orders[_prevOrderId].next = _orderId;
369:         }
370:         emit OrderCreated(_orderId, _msgSender(), _size, _price, _isBuy); // <= FOUND
371:     }
```
['[452](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L452-L457)']
```solidity
452:     function batchCancelFlipOrders(uint40[] calldata _orderIds) external marketNotHardPaused { // <= FOUND
453:         for (uint256 i = 0; i < _orderIds.length; i++) {
454:             _cancelFlipOrder(_orderIds[i]);
455:         }
456: 
457:         emit FlipOrdersCanceled(_orderIds, _msgSender()); // <= FOUND
458:     }
```
['[465](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L465-L470)']
```solidity
465:     function batchCancelOrders(uint40[] calldata _orderIds) external marketNotHardPaused { // <= FOUND
466:         for (uint256 i = 0; i < _orderIds.length; i++) {
467:             _cancelOrder(_orderIds[i], true);
468:         }
469: 
470:         emit OrdersCanceled(_orderIds, _msgSender()); // <= FOUND
471:     }
```
['[478](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L478-L489)']
```solidity
478:     function batchCancelOrdersNoRevert(uint40[] calldata _orderIds) external marketNotHardPaused { // <= FOUND
479:         uint40[] memory _orderIdsCanceled = new uint40[](_orderIds.length);
480:         for (uint256 i = 0; i < _orderIds.length; i++) {
481:             bool _isCanceled = _cancelOrder(_orderIds[i], false);
482:             if (_isCanceled) {
483:                 _orderIdsCanceled[i] = _orderIds[i];
484:             } else {
485:                 _orderIdsCanceled[i] = 0;
486:             }
487:         }
488: 
489:         emit OrdersCanceled(_orderIdsCanceled, _msgSender()); // <= FOUND
490:     }
```
['[679](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L679-L716)']
```solidity
679:     function batchUpdate( // <= FOUND
680:         uint32[] calldata buyPrices,
681:         uint96[] calldata buySizes,
682:         uint32[] calldata sellPrices,
683:         uint96[] calldata sellSizes,
684:         uint40[] calldata orderIdsToCancel,
685:         bool postOnly
686:     ) external marketNotHardPaused {
687:         
688:         require(buyPrices.length == buySizes.length, OrderBookErrors.LengthMismatch());
689: 
690:         
691:         require(sellPrices.length == sellSizes.length, OrderBookErrors.LengthMismatch());
692: 
693:         uint40[] memory orderIdsCanceled = new uint40[](orderIdsToCancel.length);
694:         
695:         for (uint256 i = 0; i < orderIdsToCancel.length; i++) {
696:             bool _isCanceled = _cancelOrder(orderIdsToCancel[i], false);
697:             if (_isCanceled) {
698:                 orderIdsCanceled[i] = orderIdsToCancel[i];
699:             } else {
700:                 orderIdsCanceled[i] = 0;
701:             }
702:         }
703: 
704:         
705:         for (uint256 i = 0; i < buyPrices.length; i++) {
706:             addBuyOrder(buyPrices[i], buySizes[i], postOnly);
707:         }
708: 
709:         
710:         for (uint256 i = 0; i < sellPrices.length; i++) {
711:             addSellOrder(sellPrices[i], sellSizes[i], postOnly);
712:         }
713: 
714:         
715:         if (orderIdsCanceled.length > 0) {
716:             emit OrdersCanceled(orderIdsCanceled, _msgSender()); // <= FOUND
717:         }
718:     }
```
['[1209](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L1209-L1217)']
```solidity
1209:     function _emitTrade( // <= FOUND
1210:         uint40 orderId,
1211:         address makerAddress,
1212:         bool isBuy,
1213:         uint256 price,
1214:         uint96 updatedSize,
1215:         uint96 filledSize
1216:     ) internal override {
1217:         emit Trade(orderId, makerAddress, isBuy, price, updatedSize, _msgSender(), tx.origin, filledSize); // <= FOUND
1218:     }
```


</details>

## [NonCritical-56] int/uint passed into abi.encodePacked without casting to a string.

### Resolution 
Not casting an integer as a string before passing it into abi.encode can result in unintended behaviour. lets say '1' being encoded as '1' it will be encoded as char(1) which is the 'start of heading' control character or id of 60 would be encoded as '<'. This is may not be intended. To rectify this, simply cast the Id as a string with string(id) or ideally use solmate's libString library (toString)

Num of instances: 1

### Findings 


<details><summary>Click to show findings</summary>

['[392](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L392-L404)']
```solidity
392:     function _getSalt( // <= FOUND
393:         address _baseAssetAddress,
394:         address _quoteAssetAddress,
395:         uint96 _sizePrecision,
396:         uint32 _pricePrecision,
397:         uint32 _tickSize,
398:         uint96 _minSize,
399:         uint96 _maxSize,
400:         uint256 _takerFeeBps,
401:         uint256 _makerFeeBps,
402:         uint96 _kuruAmmSpread
403:     ) internal pure returns (bytes32) {
404:         return keccak256( // <= FOUND
405:             abi.encodePacked(
406:                 _baseAssetAddress,
407:                 _quoteAssetAddress,
408:                 _sizePrecision,
409:                 _pricePrecision,
410:                 _tickSize,
411:                 _minSize,
412:                 _maxSize,
413:                 _takerFeeBps,
414:                 _makerFeeBps,
415:                 _kuruAmmSpread
416:             )
417:         );
418:     }
```


</details>

## [NonCritical-57] For loop iterates on arrays not indexed

### Resolution 
Ensuring matching input array lengths in functions is crucial to prevent logical errors and inconsistencies in smart contracts. Mismatched array lengths can lead to incomplete operations or incorrect data handling, particularly if one array's length is assumed to reflect another's. For instance, iterating over a shorter array than intended could result in unprocessed elements from a longer array, potentially causing unintended consequences in contract execution. Validating that all input arrays have intended lengths before performing operations helps safeguard against such errors, ensuring that all elements are appropriately processed and the contract behaves as expected.

Num of instances: 7

### Findings 


<details><summary>Click to show findings</summary>

['[480](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L480-L485)']
```solidity
480:        for (uint256 i = 0; i < _orderIds.length; i++) { // <= FOUND
481:             bool _isCanceled = _cancelOrder(_orderIds[i], false);
482:             if (_isCanceled) {
483:                 _orderIdsCanceled[i] = _orderIds[i];
484:             } else {
485:                 _orderIdsCanceled[i] = 0; // <= FOUND
486:             }
487:         }
```
['[480](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L480-L485)']
```solidity
480:         for (uint256 i = 0; i < _orderIds.length; i++) { // <= FOUND
481:             bool _isCanceled = _cancelOrder(_orderIds[i], false);
482:             if (_isCanceled) {
483:                 _orderIdsCanceled[i] = _orderIds[i];
484:             } else {
485:                 _orderIdsCanceled[i] = 0; // <= FOUND
486:             }
487:         }
```
['[661](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L661-L662)']
```solidity
661:        for (uint256 i = 0; i < prices.length; i++) { // <= FOUND
662:             if (isBuy[i]) { // <= FOUND
663:                 addFlipBuyOrder(prices[i], flipPrices[i], sizes[i], _provisionOrRevert);
664:             } else {
665:                 addFlipSellOrder(prices[i], flipPrices[i], sizes[i], _provisionOrRevert);
666:             }
667:         }
```
['[661](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L661-L662)']
```solidity
661:         for (uint256 i = 0; i < prices.length; i++) { // <= FOUND
662:             if (isBuy[i]) { // <= FOUND
663:                 addFlipBuyOrder(prices[i], flipPrices[i], sizes[i], _provisionOrRevert);
664:             } else {
665:                 addFlipSellOrder(prices[i], flipPrices[i], sizes[i], _provisionOrRevert);
666:             }
667:         }
```
['[695](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L695-L700)']
```solidity
695:        for (uint256 i = 0; i < orderIdsToCancel.length; i++) { // <= FOUND
696:             bool _isCanceled = _cancelOrder(orderIdsToCancel[i], false);
697:             if (_isCanceled) {
698:                 orderIdsCanceled[i] = orderIdsToCancel[i];
699:             } else {
700:                 orderIdsCanceled[i] = 0; // <= FOUND
701:             }
702:         }
```
['[695](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L695-L700)']
```solidity
695:         for (uint256 i = 0; i < orderIdsToCancel.length; i++) { // <= FOUND
696:             bool _isCanceled = _cancelOrder(orderIdsToCancel[i], false);
697:             if (_isCanceled) {
698:                 orderIdsCanceled[i] = orderIdsToCancel[i];
699:             } else {
700:                 orderIdsCanceled[i] = 0; // <= FOUND
701:             }
702:         }
```
['[348](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L348-L353)']
```solidity
348:         for (uint256 i = 0; i < _marketAddresses.length; i++) { // <= FOUND
349:             address _currentMarket = _marketAddresses[i];
350:             MarketParams memory _marketParams = verifiedMarket[_currentMarket];
351:             require(_marketParams.pricePrecision > 0, RouterErrors.InvalidMarket());
352:             IOrderBook market = IOrderBook(_currentMarket);
353:             uint256 _value = _nativeSend[i] ? _amount : 0; // <= FOUND
354:             _amountOut = _isBuy[i]
355:                 ? (
356:                     market.placeAndExecuteMarketBuy{value: _value}(
357:                         toU96(_amount * _marketParams.pricePrecision / 10 ** _marketParams.quoteAssetDecimals),
358:                         0,
359:                         false,
360:                         true
361:                     )
362:                 )
363:                 : market.placeAndExecuteMarketSell{value: _value}(
364:                     toU96(_amount * _marketParams.sizePrecision / 10 ** _marketParams.baseAssetDecimals), 0, false, true
365:                 );
366: 
367:             _amount = _amountOut;
368:         }
```


</details>

## [NonCritical-58] Constructor with array/string/bytes parameters has no empty array checks

### Resolution 
Failing to validate for empty array inputs in constructors can lead to vulnerabilities or logical errors in smart contracts. Constructors often initialize key contract settings, and arrays may represent crucial data like access controls, initial states, or configuration parameters. Without empty array checks, a contract might be deployed in an unintended state, lacking necessary data for its operations or security measures. 

Num of instances: 1

### Findings 


<details><summary>Click to show findings</summary>

['[12](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/periphery/ERC20.sol#L12-L12)']
```solidity
12:     constructor(string memory name_, string memory symbol_, uint256 initialSupply_, address mintRecipient_) {
13:         _name = name_;
14:         _symbol = symbol_;
15:         
16:         _mint(mintRecipient_, initialSupply_);
17:     }
```


</details>

## [NonCritical-59] Errors should have parameters

### Resolution 
In Solidity, custom errors with parameters offer a gas-efficient way to convey detailed information about issues encountered during contract execution. Unlike revert messages, which are strings consuming more gas, custom errors defined with parameters allow developers to specify types and details of errors succinctly. This method enhances debugging, provides clearer insights into contract failures, and improves the developer's and end-user's understanding of what went wrong, all while optimizing for gas usage and maintaining contract efficiency.

Num of instances: 65

### Findings 


<details><summary>Click to show findings</summary>

['[21](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruForwarder.sol#L21-L21)']
```solidity
21:     error DeadlineExpired(); // <= FOUND
```
['[8](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/Errors.sol#L8-L11)']
```solidity
8:     
11:     error Unauthorized(); // <= FOUND
```
['[12](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/Errors.sol#L12-L15)']
```solidity
12:     
15:     error MarketStateError(); // <= FOUND
```
['[16](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/Errors.sol#L16-L19)']
```solidity
16:     
19:     error MarketFeeError(); // <= FOUND
```
['[20](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/Errors.sol#L20-L23)']
```solidity
20:     
23:     error MarketSizeError(); // <= FOUND
```
['[24](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/Errors.sol#L24-L27)']
```solidity
24:     
27:     error InvalidSpread(); // <= FOUND
```
['[28](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/Errors.sol#L28-L31)']
```solidity
28:     
31:     error PriceError(); // <= FOUND
```
['[32](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/Errors.sol#L32-L35)']
```solidity
32:     
35:     error SizeError(); // <= FOUND
```
['[36](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/Errors.sol#L36-L39)']
```solidity
36:     
39:     error TickSizeError(); // <= FOUND
```
['[40](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/Errors.sol#L40-L43)']
```solidity
40:     
43:     error PostOnlyError(); // <= FOUND
```
['[44](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/Errors.sol#L44-L47)']
```solidity
44:     
47:     error ProvisionError(); // <= FOUND
```
['[49](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/Errors.sol#L49-L53)']
```solidity
49:     
53:     error OnlyOwnerAllowedError(); // <= FOUND
```
['[53](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/Errors.sol#L53-L56)']
```solidity
53:     
56:     error WrongOrderTypeCancel(); // <= FOUND
```
['[57](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/Errors.sol#L57-L60)']
```solidity
57:     
60:     error OrderAlreadyFilledOrCancelled(); // <= FOUND
```
['[61](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/Errors.sol#L61-L64)']
```solidity
61:     
64:     error LengthMismatch(); // <= FOUND
```
['[65](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/Errors.sol#L65-L68)']
```solidity
65:     
68:     error NativeAssetInsufficient(); // <= FOUND
```
['[69](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/Errors.sol#L69-L72)']
```solidity
69:     
72:     error NativeAssetSurplus(); // <= FOUND
```
['[73](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/Errors.sol#L73-L76)']
```solidity
73:     
76:     error NativeAssetNotRequired(); // <= FOUND
```
['[77](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/Errors.sol#L77-L80)']
```solidity
77:     
80:     error NativeAssetTransferFail(); // <= FOUND
```
['[81](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/Errors.sol#L81-L84)']
```solidity
81:     
84:     error InsufficientLiquidity(); // <= FOUND
```
['[85](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/Errors.sol#L85-L88)']
```solidity
85:     
88:     error SlippageExceeded(); // <= FOUND
```
['[89](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/Errors.sol#L89-L92)']
```solidity
89:     
92:     error TooMuchSizeFilled(); // <= FOUND
```
['[93](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/Errors.sol#L93-L96)']
```solidity
93:     
96:     error TransferFromFailed(); // <= FOUND
```
['[97](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/Errors.sol#L97-L100)']
```solidity
97:     
100:     error OnlyVaultAllowed(); // <= FOUND
```
['[101](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/Errors.sol#L101-L104)']
```solidity
101:     
104:     error Uint96Overflow(); // <= FOUND
```
['[105](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/Errors.sol#L105-L108)']
```solidity
105:     
108:     error Uint32Overflow(); // <= FOUND
```
['[112](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/Errors.sol#L112-L115)']
```solidity
112:     
115:     error OnlyRouterAllowed(); // <= FOUND
```
['[116](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/Errors.sol#L116-L119)']
```solidity
116:     
119:     error OnlyVerifiedMarketsAllowed(); // <= FOUND
```
['[120](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/Errors.sol#L120-L123)']
```solidity
120:     
123:     error InsufficientBalance(); // <= FOUND
```
['[128](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/Errors.sol#L128-L131)']
```solidity
128:     
131:     error NativeAssetMismatch(); // <= FOUND
```
['[132](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/Errors.sol#L132-L135)']
```solidity
132:     
135:     error ZeroAddressNotAllowed(); // <= FOUND
```
['[136](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/Errors.sol#L136-L139)']
```solidity
136:     
139:     error ProtocolPaused(); // <= FOUND
```
['[140](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/Errors.sol#L140-L143)']
```solidity
140:     
143:     error ProtocolStateNotChanged(); // <= FOUND
```
['[144](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/Errors.sol#L144-L147)']
```solidity
144:     
147:     error FeeCollectorNotChanged(); // <= FOUND
```
['[151](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/Errors.sol#L151-L154)']
```solidity
151:     
154:     error BaseAndQuoteAssetSame(); // <= FOUND
```
['[155](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/Errors.sol#L155-L158)']
```solidity
155:     
158:     error MarketTypeMismatch(); // <= FOUND
```
['[159](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/Errors.sol#L159-L162)']
```solidity
159:     
162:     error InvalidTickSize(); // <= FOUND
```
['[163](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/Errors.sol#L163-L166)']
```solidity
163:     
166:     error InvalidSizePrecision(); // <= FOUND
```
['[167](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/Errors.sol#L167-L170)']
```solidity
167:     
170:     error InvalidPricePrecision(); // <= FOUND
```
['[171](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/Errors.sol#L171-L174)']
```solidity
171:     
174:     error NoMarketsPassed(); // <= FOUND
```
['[179](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/Errors.sol#L179-L182)']
```solidity
179:     
182:     error InvalidMarket(); // <= FOUND
```
['[206](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/Errors.sol#L206-L209)']
```solidity
206:     
209:     error InsufficientQuoteToken(); // <= FOUND
```
['[210](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/Errors.sol#L210-L213)']
```solidity
210:     
213:     error InsufficientLiquidityMinted(); // <= FOUND
```
['[222](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/Errors.sol#L222-L225)']
```solidity
222:     
225:     error NewSizeExceedsPartiallyFilledSize(); // <= FOUND
```
['[226](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/Errors.sol#L226-L229)']
```solidity
226:     
229:     error VaultInitializationPriceCrossesBook(); // <= FOUND
```
['[230](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/Errors.sol#L230-L233)']
```solidity
230:     
233:     error NegativeAmountWithdrawn(); // <= FOUND
```
['[241](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/Errors.sol#L241-L244)']
```solidity
241:     
244:     error SignatureMismatch(); // <= FOUND
```
['[245](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/Errors.sol#L245-L248)']
```solidity
245:     
248:     error InterfaceNotAllowed(); // <= FOUND
```
['[249](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/Errors.sol#L249-L252)']
```solidity
249:     
252:     error ExecutionFailed(); // <= FOUND
```
['[253](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/Errors.sol#L253-L256)']
```solidity
253:     
256:     error NonceAlreadyUsed(); // <= FOUND
```
['[257](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/Errors.sol#L257-L260)']
```solidity
257:     
260:     error InsufficientValue(); // <= FOUND
```
['[13](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L13-L18)']
```solidity
13:     
18:     error ExpOverflow(); // <= FOUND
```
['[16](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L16-L17)']
```solidity
16:     
17:     error FactorialOverflow(); // <= FOUND
```
['[19](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L19-L20)']
```solidity
19:     
20:     error RPowOverflow(); // <= FOUND
```
['[22](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L22-L23)']
```solidity
22:     
23:     error MantissaOverflow(); // <= FOUND
```
['[25](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L25-L26)']
```solidity
25:     
26:     error MulWadFailed(); // <= FOUND
```
['[28](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L28-L29)']
```solidity
28:     
29:     error SMulWadFailed(); // <= FOUND
```
['[31](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L31-L32)']
```solidity
31:     
32:     error DivWadFailed(); // <= FOUND
```
['[34](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L34-L35)']
```solidity
34:     
35:     error SDivWadFailed(); // <= FOUND
```
['[37](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L37-L38)']
```solidity
37:     
38:     error MulDivFailed(); // <= FOUND
```
['[40](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L40-L41)']
```solidity
40:     
41:     error DivFailed(); // <= FOUND
```
['[44](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L44-L46)']
```solidity
44:     
46:     error FullMulDivFailed(); // <= FOUND
```
['[47](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L47-L48)']
```solidity
47:     
48:     error LnWadUndefined(); // <= FOUND
```
['[50](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L50-L51)']
```solidity
50:     
51:     error OutOfDomain(); // <= FOUND
```
['[21](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruForwarder.sol#L21-L21)']
```solidity
21: error DeadlineExpired(); // <= FOUND
```


</details>

## [NonCritical-60] Avoid using 'owner' or '_owner' as a parameter name

### Resolution 
Using 'owner' or '_owner' as a parameter name in functions, especially in contracts inheriting from or interacting with OpenZeppelin's `Ownable` contract, can lead to confusion and potential bugs. These contracts often have a state variable named `owner`, managed by the `Ownable` pattern for access control. Using the same name for function parameters may obscure the contract's `owner` state variable, complicating code readability and maintenance. Prefer alternative descriptive names for parameters to maintain clarity and prevent conflicts with established ownership patterns.

Num of instances: 5

### Findings 


<details><summary>Click to show findings</summary>

['[241](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L241-L241)']
```solidity
241:     function withdraw(uint256 _shares, address _receiver, address _owner) // <= FOUND
242:         public
243:         nonReentrant
244:         returns (uint256, uint256)
245:     
```
['[258](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L258-L258)']
```solidity
258:     function _burnAndWithdraw(uint256 _shares, address _receiver, address _owner) internal returns (uint256, uint256)  // <= FOUND
```
['[384](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L384-L388)']
```solidity
384:     function _addFlipOrder(
385:         uint32 _price,
386:         uint32 _flippedPrice,
387:         uint96 _size,
388:         address _owner, // <= FOUND
389:         uint40 _orderId,
390:         uint40 _flippedId,
391:         bool _isBuy,
392:         uint40 _prevOrderId
393:     ) internal 
```
['[416](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L416-L420)']
```solidity
416:     function _addFlippedOrder(
417:         uint32 _price,
418:         uint32 _flippedPrice,
419:         uint96 _size,
420:         address _owner, // <= FOUND
421:         uint40 _orderId,
422:         uint40 _flippedId,
423:         bool _isBuy,
424:         uint40 _prevOrderId
425:     ) internal 
```
['[1238](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L1238-L1238)']
```solidity
1238:     function _creditMaker(bool _isMarketBuy, address _ownerAddress, uint96 _size, uint32 _price) // <= FOUND
1239:         internal
1240:         view
1241:         returns (bytes memory)
1242:     
```


</details>

## [NonCritical-61] Avoid arithmetic directly within array indices

### Resolution 
Avoiding arithmetic directly within array indices, like `test[i + 2]`, is recommended to prevent errors such as index out of bounds or incorrect data access. This practice enhances code readability and maintainability. Instead, calculate the index beforehand, store it in a variable, and then use that variable to access the array element. This approach reduces mistakes, especially in complex loops or when handling dynamic data, ensuring that each access is clear and verifiable. It's about keeping code clean and understandable, minimizing potential bugs.

Num of instances: 6

### Findings 


<details><summary>Click to show findings</summary>

['[141](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L141-L141)']
```solidity
141:             (address _user, address _token, uint256 _amount, bool _useMargin) =
142:                 abi.decode(_encodedData[offset:offset + 128], (address, address, uint256, bool));
```
['[19](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/ERC2771Context.sol#L19-L19)']
```solidity
19:             return msg.data[:calldataLength - contextSuffixLength];
```
['[29](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/ERC2771Context.sol#L29-L29)']
```solidity
29:             return address(bytes20(msg.data[calldataLength - contextSuffixLength:]));
```
['[877](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L877-L877)']
```solidity
877:                 (_sizeToBeFilled, priceUpdate) = _fillSizeForPrice(
878:                     s_sellTree,
879:                     toU32(_bestAsk * _pricePrecision / vaultPricePrecision),
880:                     s_sellPricePoints[_bestAsk * _pricePrecision / vaultPricePrecision],
881:                     _sizeToBeFilled
882:                 );
```
['[951](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L951-L951)']
```solidity
951:                 (_sizeFillableAtPriceLeft, priceUpdate) = _fillSizeForPrice(
952:                     s_sellTree,
953:                     toU32(_bestAsk * _pricePrecision / vaultPricePrecision),
954:                     s_sellPricePoints[(_bestAsk * _pricePrecision / vaultPricePrecision)],
955:                     _sizeFillableAtPriceLeft
956:                 );
```
['[1025](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L1025-L1025)']
```solidity
1025:                 (_sizeToBeFilledLeft, priceUpdate) = _fillSizeForPrice(
1026:                     s_buyTree,
1027:                     toU32(_bestBid * _pricePrecision / vaultPricePrecision),
1028:                     s_buyPricePoints[_bestBid * _pricePrecision / vaultPricePrecision],
1029:                     _sizeToBeFilledLeft
1030:                 );
```


</details>

## [NonCritical-62] Memory-safe annotation missing

### Resolution 
Tagging assembly blocks as "memory safe" in Solidity helps maintainers and auditors quickly identify areas of the code less likely to introduce vulnerabilities due to improper memory access. This practice promotes safer contract development by clearly communicating assumptions about memory handling, aiding in the review process, and reducing the risk of introducing memory-related bugs. It's a part of best coding practices, enhancing code clarity and security, especially in complex, low-level operations where Solidity's safety checks are bypassed.

Num of instances: 40

### Findings 


<details><summary>Click to show findings</summary>

['[93](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L93-L93)']
```solidity
93:         assembly {
94:             z := div(mul(x, y), WAD)
95:         }
```
['[101](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L101-L101)']
```solidity
101:         assembly {
102:             z := sdiv(mul(x, y), WAD)
103:         }
```
['[122](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L122-L122)']
```solidity
122:         assembly {
123:             z := add(iszero(iszero(mod(mul(x, y), WAD))), div(mul(x, y), WAD))
124:         }
```
['[157](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L157-L157)']
```solidity
157:         assembly {
158:             z := div(mul(x, WAD), y)
159:         }
```
['[165](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L165-L165)']
```solidity
165:         assembly {
166:             z := sdiv(mul(x, WAD), y)
167:         }
```
['[186](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L186-L186)']
```solidity
186:         assembly {
187:             z := add(iszero(iszero(mod(mul(x, WAD), y))), div(mul(x, WAD), y))
188:         }
```
['[501](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L501-L501)']
```solidity
501:         assembly {
502:             result := mul(x, y)
503:             let mm := mulmod(x, y, not(0))
504:             let p1 := sub(mm, add(result, lt(mm, result)))
505:             let t := and(d, sub(0, d))
506:             let r := mulmod(x, y, d)
507:             d := div(d, t)
508:             let inv := xor(2, mul(3, d))
509:             inv := mul(inv, sub(2, mul(d, inv)))
510:             inv := mul(inv, sub(2, mul(d, inv)))
511:             inv := mul(inv, sub(2, mul(d, inv)))
512:             inv := mul(inv, sub(2, mul(d, inv)))
513:             inv := mul(inv, sub(2, mul(d, inv)))
514:             result :=
515:                 mul(
516:                     or(mul(sub(p1, gt(r, result)), add(div(sub(0, t), t), 1)), div(sub(result, r), t)),
517:                     mul(sub(2, mul(d, inv)), inv)
518:                 )
519:         }
```
['[590](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L590-L590)']
```solidity
590:         assembly {
591:             z := mul(gt(x, y), sub(x, y))
592:         }
```
['[598](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L598-L598)']
```solidity
598:         assembly {
599:             result := xor(x, mul(xor(x, y), iszero(condition)))
600:         }
```
['[644](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L644-L644)']
```solidity
644:         assembly {
645:             
646:             z := 181 
647: 
648:             
649:             
650: 
651:             
652:             
653:             let r := shl(7, lt(0xffffffffffffffffffffffffffffffffff, x))
654:             r := or(r, shl(6, lt(0xffffffffffffffffff, shr(r, x))))
655:             r := or(r, shl(5, lt(0xffffffffff, shr(r, x))))
656:             r := or(r, shl(4, lt(0xffffff, shr(r, x))))
657:             z := shl(shr(1, r), z)
658: 
659:             
660:             
661:             
662:             
663: 
664:             
665:             
666:             
667: 
668:             
669:             
670:             
671: 
672:             
673:             
674:             
675: 
676:             
677:             z := shr(18, mul(z, add(shr(r, x), 65536))) 
678: 
679:             
680:             z := shr(1, add(z, div(x, z)))
681:             z := shr(1, add(z, div(x, z)))
682:             z := shr(1, add(z, div(x, z)))
683:             z := shr(1, add(z, div(x, z)))
684:             z := shr(1, add(z, div(x, z)))
685:             z := shr(1, add(z, div(x, z)))
686:             z := shr(1, add(z, div(x, z)))
687: 
688:             
689:             
690:             
691:             z := sub(z, lt(div(x, z), z))
692:         }
```
['[702](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L702-L702)']
```solidity
702:         assembly {
703:             let r := shl(7, lt(0xffffffffffffffffffffffffffffffff, x))
704:             r := or(r, shl(6, lt(0xffffffffffffffff, shr(r, x))))
705:             r := or(r, shl(5, lt(0xffffffff, shr(r, x))))
706:             r := or(r, shl(4, lt(0xffff, shr(r, x))))
707:             r := or(r, shl(3, lt(0xff, shr(r, x))))
708:             
709:             z := div(shl(div(r, 3), shl(lt(0xf, shr(r, x)), 0xf)), xor(7, mod(r, 3)))
710:             
711:             z := div(add(add(div(x, mul(z, z)), z), z), 3)
712:             z := div(add(add(div(x, mul(z, z)), z), z), 3)
713:             z := div(add(add(div(x, mul(z, z)), z), z), 3)
714:             z := div(add(add(div(x, mul(z, z)), z), z), 3)
715:             z := div(add(add(div(x, mul(z, z)), z), z), 3)
716:             z := div(add(add(div(x, mul(z, z)), z), z), 3)
717:             z := div(add(add(div(x, mul(z, z)), z), z), 3)
718:             
719:             z := sub(z, lt(div(x, mul(z, z)), z))
720:         }
```
['[731](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L731-L731)']
```solidity
731:         assembly {
732:             z := sub(z, gt(999999999999999999, sub(mulmod(z, z, x), 1))) 
733:         }
```
['[783](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L783-L783)']
```solidity
783:         assembly {
784:             r := shl(7, lt(0xffffffffffffffffffffffffffffffff, x))
785:             r := or(r, shl(6, lt(0xffffffffffffffff, shr(r, x))))
786:             r := or(r, shl(5, lt(0xffffffff, shr(r, x))))
787:             r := or(r, shl(4, lt(0xffff, shr(r, x))))
788:             r := or(r, shl(3, lt(0xff, shr(r, x))))
789:             
790:             r := or(r, byte(and(0x1f, shr(shr(r, x), 0x8421084210842108cc6318c6db6d54be)),
791:                 0x0706060506020504060203020504030106050205030304010505030400000000))
792:         }
```
['[800](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L800-L800)']
```solidity
800:         assembly {
801:             r := add(r, lt(shl(r, 1), x))
802:         }
```
['[809](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L809-L809)']
```solidity
809:         assembly {
810:             if iszero(lt(x, 100000000000000000000000000000000000000)) {
811:                 x := div(x, 100000000000000000000000000000000000000)
812:                 r := 38
813:             }
814:             if iszero(lt(x, 100000000000000000000)) {
815:                 x := div(x, 100000000000000000000)
816:                 r := add(r, 20)
817:             }
818:             if iszero(lt(x, 10000000000)) {
819:                 x := div(x, 10000000000)
820:                 r := add(r, 10)
821:             }
822:             if iszero(lt(x, 100000)) {
823:                 x := div(x, 100000)
824:                 r := add(r, 5)
825:             }
826:             r := add(r, add(gt(x, 9), add(gt(x, 99), add(gt(x, 999), gt(x, 9999)))))
827:         }
```
['[835](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L835-L835)']
```solidity
835:         assembly {
836:             r := add(r, lt(exp(10, r), x))
837:         }
```
['[844](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L844-L844)']
```solidity
844:         assembly {
845:             r := shl(7, lt(0xffffffffffffffffffffffffffffffff, x))
846:             r := or(r, shl(6, lt(0xffffffffffffffff, shr(r, x))))
847:             r := or(r, shl(5, lt(0xffffffff, shr(r, x))))
848:             r := or(r, shl(4, lt(0xffff, shr(r, x))))
849:             r := or(shr(3, r), lt(0xff, shr(r, x)))
850:         }
```
['[858](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L858-L858)']
```solidity
858:         assembly {
859:             r := add(r, lt(shl(shl(3, r), 1), x))
860:         }
```
['[867](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L867-L867)']
```solidity
867:         assembly {
868:             mantissa := x
869:             if mantissa {
870:                 if iszero(mod(mantissa, 1000000000000000000000000000000000)) {
871:                     mantissa := div(mantissa, 1000000000000000000000000000000000)
872:                     exponent := 33
873:                 }
874:                 if iszero(mod(mantissa, 10000000000000000000)) {
875:                     mantissa := div(mantissa, 10000000000000000000)
876:                     exponent := add(exponent, 19)
877:                 }
878:                 if iszero(mod(mantissa, 1000000000000)) {
879:                     mantissa := div(mantissa, 1000000000000)
880:                     exponent := add(exponent, 12)
881:                 }
882:                 if iszero(mod(mantissa, 1000000)) {
883:                     mantissa := div(mantissa, 1000000)
884:                     exponent := add(exponent, 6)
885:                 }
886:                 if iszero(mod(mantissa, 10000)) {
887:                     mantissa := div(mantissa, 10000)
888:                     exponent := add(exponent, 4)
889:                 }
890:                 if iszero(mod(mantissa, 100)) {
891:                     mantissa := div(mantissa, 100)
892:                     exponent := add(exponent, 2)
893:                 }
894:                 if iszero(mod(mantissa, 10)) {
895:                     mantissa := div(mantissa, 10)
896:                     exponent := add(exponent, 1)
897:                 }
898:             }
899:         }
```
['[946](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L946-L946)']
```solidity
946:         assembly {
947:             z := xor(sar(255, x), add(sar(255, x), x))
948:         }
```
['[954](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L954-L954)']
```solidity
954:         assembly {
955:             z := xor(mul(xor(sub(y, x), sub(x, y)), gt(x, y)), sub(y, x))
956:         }
```
['[962](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L962-L962)']
```solidity
962:         assembly {
963:             z := xor(mul(xor(sub(y, x), sub(x, y)), sgt(x, y)), sub(y, x))
964:         }
```
['[970](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L970-L970)']
```solidity
970:         assembly {
971:             z := xor(x, mul(xor(x, y), lt(y, x)))
972:         }
```
['[978](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L978-L978)']
```solidity
978:         assembly {
979:             z := xor(x, mul(xor(x, y), slt(y, x)))
980:         }
```
['[986](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L986-L986)']
```solidity
986:         assembly {
987:             z := xor(x, mul(xor(x, y), gt(y, x)))
988:         }
```
['[994](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L994-L994)']
```solidity
994:         assembly {
995:             z := xor(x, mul(xor(x, y), sgt(y, x)))
996:         }
```
['[1002](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L1002-L1002)']
```solidity
1002:         assembly {
1003:             z := xor(x, mul(xor(x, minValue), gt(minValue, x)))
1004:             z := xor(z, mul(xor(z, maxValue), lt(maxValue, z)))
1005:         }
```
['[1011](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L1011-L1011)']
```solidity
1011:         assembly {
1012:             z := xor(x, mul(xor(x, minValue), sgt(minValue, x)))
1013:             z := xor(z, mul(xor(z, maxValue), slt(maxValue, z)))
1014:         }
```
['[1020](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L1020-L1020)']
```solidity
1020:         assembly {
1021:             for { z := x } y {} {
1022:                 let t := y
1023:                 y := mod(z, y)
1024:                 z := t
1025:             }
1026:         }
```
['[1117](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L1117-L1117)']
```solidity
1117:         assembly {
1118:             z := div(x, y)
1119:         }
```
['[1125](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L1125-L1125)']
```solidity
1125:         assembly {
1126:             z := sdiv(x, y)
1127:         }
```
['[1133](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L1133-L1133)']
```solidity
1133:         assembly {
1134:             z := mod(x, y)
1135:         }
```
['[1141](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L1141-L1141)']
```solidity
1141:         assembly {
1142:             z := smod(x, y)
1143:         }
```
['[1149](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L1149-L1149)']
```solidity
1149:         assembly {
1150:             z := addmod(x, y, d)
1151:         }
```
['[1157](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L1157-L1157)']
```solidity
1157:         assembly {
1158:             z := mulmod(x, y, d)
1159:         }
```
['[248](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L248-L248)']
```solidity
248:             assembly {
249:                 
250:                 
251:                 
252:                 r := sdiv(p, q)
253:             }
```
['[393](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L393-L393)']
```solidity
393:             assembly {
394:                 w := sub(w, sgt(w, 2))
395:             }
```
['[419](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L419-L419)']
```solidity
419:             assembly {
420:                 x := sdiv(mul(x, wad), t)
421:             }
```
['[424](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L424-L424)']
```solidity
424:             assembly {
425:                 w := sdiv(x, add(wad, t))
426:             }
```
['[746](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L746-L746)']
```solidity
746:         assembly {
747:             let p := x
748:             for {}
```


</details>

## [NonCritical-63] Constant state variables defined more than once

### Resolution 
Rather than redefining state variable constant, consider utilising a library to store all constants as this will prevent data redundancy

Num of instances: 4

### Findings 


<details><summary>Click to show findings</summary>

['[18](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/AbstractAMM.sol#L18-L18)']
```solidity
18: uint256 constant vaultPricePrecision = 10 ** 18; // <= FOUND
```
['[20](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/AbstractAMM.sol#L20-L20)']
```solidity
20: uint256 constant BPS_MULTIPLIER = 10000; // <= FOUND
```
['[19](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/AbstractAMM.sol#L19-L19)']
```solidity
19: uint256 constant DOUBLE_BPS_MULTIPLIER = 20000; // <= FOUND
```
['[31](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L31-L31)']
```solidity
31: address private constant NATIVE = 0x0000000000000000000000000000000000000000; // <= FOUND
```


</details>

## [NonCritical-64] Pure function accesses storage

### Resolution 
Pure functions by definition should not read or write to storage (state variables), however due to a bug with storage pointers this can slip past the compiler and thus a pure function can at times read storage whilst being declared as pure. Below are such instances

Num of instances: 13

### Findings 


<details><summary>Click to show findings</summary>

['[64](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L64-L72)']
```solidity
64:     function mulWad(uint256 x, uint256 y) internal pure returns (uint256 z) {
65:         
66:         assembly {
67:             
68:             if mul(y, gt(x, div(not(0), y))) {
69:                 mstore(0x00, 0xbac65e5b) 
70:                 revert(0x1c, 0x04)
71:             }
72:             z := div(mul(x, y), WAD) // <= FOUND
73:         }
74:     }
```
['[77](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L77-L86)']
```solidity
77:     function sMulWad(int256 x, int256 y) internal pure returns (int256 z) {
78:         
79:         assembly {
80:             z := mul(x, y)
81:             
82:             if iszero(gt(or(iszero(x), eq(sdiv(z, x), y)), lt(not(x), eq(y, shl(255, 1))))) {
83:                 mstore(0x00, 0xedcd4dd4) 
84:                 revert(0x1c, 0x04)
85:             }
86:             z := sdiv(z, WAD) // <= FOUND
87:         }
88:     }
```
['[91](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L91-L94)']
```solidity
91:     function rawMulWad(uint256 x, uint256 y) internal pure returns (uint256 z) {
92:         
93:         assembly {
94:             z := div(mul(x, y), WAD) // <= FOUND
95:         }
96:     }
```
['[99](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L99-L102)']
```solidity
99:     function rawSMulWad(int256 x, int256 y) internal pure returns (int256 z) {
100:         
101:         assembly {
102:             z := sdiv(mul(x, y), WAD) // <= FOUND
103:         }
104:     }
```
['[107](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L107-L115)']
```solidity
107:     function mulWadUp(uint256 x, uint256 y) internal pure returns (uint256 z) {
108:         
109:         assembly {
110:             
111:             if mul(y, gt(x, div(not(0), y))) {
112:                 mstore(0x00, 0xbac65e5b) 
113:                 revert(0x1c, 0x04)
114:             }
115:             z := add(iszero(iszero(mod(mul(x, y), WAD))), div(mul(x, y), WAD)) // <= FOUND
116:         }
117:     }
```
['[120](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L120-L123)']
```solidity
120:     function rawMulWadUp(uint256 x, uint256 y) internal pure returns (uint256 z) {
121:         
122:         assembly {
123:             z := add(iszero(iszero(mod(mul(x, y), WAD))), div(mul(x, y), WAD)) // <= FOUND
124:         }
125:     }
```
['[128](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L128-L136)']
```solidity
128:     function divWad(uint256 x, uint256 y) internal pure returns (uint256 z) {
129:         
130:         assembly {
131:             
132:             if iszero(mul(y, iszero(mul(WAD, gt(x, div(not(0), WAD)))))) { // <= FOUND
133:                 mstore(0x00, 0x7c5f487d) 
134:                 revert(0x1c, 0x04)
135:             }
136:             z := div(mul(x, WAD), y) // <= FOUND
137:         }
138:     }
```
['[141](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L141-L150)']
```solidity
141:     function sDivWad(int256 x, int256 y) internal pure returns (int256 z) {
142:         
143:         assembly {
144:             z := mul(x, WAD) // <= FOUND
145:             
146:             if iszero(and(iszero(iszero(y)), eq(sdiv(z, WAD), x))) { // <= FOUND
147:                 mstore(0x00, 0x5c43740d) 
148:                 revert(0x1c, 0x04)
149:             }
150:             z := sdiv(mul(x, WAD), y) // <= FOUND
151:         }
152:     }
```
['[155](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L155-L158)']
```solidity
155:     function rawDivWad(uint256 x, uint256 y) internal pure returns (uint256 z) {
156:         
157:         assembly {
158:             z := div(mul(x, WAD), y) // <= FOUND
159:         }
160:     }
```
['[163](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L163-L166)']
```solidity
163:     function rawSDivWad(int256 x, int256 y) internal pure returns (int256 z) {
164:         
165:         assembly {
166:             z := sdiv(mul(x, WAD), y) // <= FOUND
167:         }
168:     }
```
['[171](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L171-L179)']
```solidity
171:     function divWadUp(uint256 x, uint256 y) internal pure returns (uint256 z) {
172:         
173:         assembly {
174:             
175:             if iszero(mul(y, iszero(mul(WAD, gt(x, div(not(0), WAD)))))) { // <= FOUND
176:                 mstore(0x00, 0x7c5f487d) 
177:                 revert(0x1c, 0x04)
178:             }
179:             z := add(iszero(iszero(mod(mul(x, WAD), y))), div(mul(x, WAD), y)) // <= FOUND
180:         }
181:     }
```
['[184](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L184-L187)']
```solidity
184:     function rawDivWadUp(uint256 x, uint256 y) internal pure returns (uint256 z) {
185:         
186:         assembly {
187:             z := add(iszero(iszero(mod(mul(x, WAD), y))), div(mul(x, WAD), y)) // <= FOUND
188:         }
189:     }
```
['[346](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L346-L350)']
```solidity
346:     function lambertW0Wad(int256 x) internal pure returns (int256 w) {
347:         
348:         unchecked {
349:             if ((w = x) <= -367879441171442322) revert OutOfDomain(); 
350:             int256 wad = int256(WAD); // <= FOUND
351:             int256 p = x;
352:             uint256 c; 
353:             uint256 i = 4; 
354:             if (w <= 0x1ffffffffffff) {
355:                 if (-0x4000000000000 <= w) {
356:                     i = 1; 
357:                 } else if (w <= -0x3ffffffffffffff) {
358:                     i = 32; 
359:                 }
360:             } else if (uint256(w >> 63) == uint256(0)) {
361:                 
362:                 assembly {
363:                     
364:                     let v := shr(49, w)
365:                     let l := shl(3, lt(0xff, v))
366:                     l := add(or(l, byte(and(0x1f, shr(shr(l, v), 0x8421084210842108cc6318c6db6d54be)),
367:                         0x0706060506020504060203020504030106050205030304010505030400000000)), 49)
368:                     w := sdiv(shl(l, 7), byte(sub(l, 31), 0x0303030303030303040506080c13))
369:                     c := gt(l, 60)
370:                     i := add(2, add(gt(l, 53), c))
371:                 }
372:             } else {
373:                 int256 ll = lnWad(w = lnWad(w));
374:                 
375:                 assembly {
376:                     
377:                     w := add(sdiv(mul(ll, 1023715080943847266), w), sub(w, ll))
378:                     i := add(3, iszero(shr(68, x)))
379:                     c := iszero(shr(143, x))
380:                 }
381:                 if (c == uint256(0)) {
382:                     do { 
383:                         int256 e = expWad(w);
384:                         
385:                         assembly {
386:                             let t := mul(w, div(e, wad))
387:                             w := sub(w, sdiv(sub(t, x), div(add(e, t), wad)))
388:                         }
389:                         if (p <= w) break;
390:                         p = w;
391:                     } while (--i != uint256(0));
392:                     
393:                     assembly {
394:                         w := sub(w, sgt(w, 2))
395:                     }
396:                     return w;
397:                 }
398:             }
399:             do { 
400:                 int256 e = expWad(w);
401:                 
402:                 assembly {
403:                     let t := add(w, wad)
404:                     let s := sub(mul(w, e), mul(x, wad))
405:                     w := sub(w, sdiv(mul(s, wad), sub(mul(e, t), sdiv(mul(add(t, wad), s), add(t, t)))))
406:                 }
407:                 if (p <= w) break;
408:                 p = w;
409:             } while (--i != c);
410:             
411:             assembly {
412:                 w := sub(w, sgt(w, 2))
413:             }
414:             
415:             
416:             if (c == uint256(0)) return w;
417:             int256 t = w | 1;
418:             
419:             assembly {
420:                 x := sdiv(mul(x, wad), t)
421:             }
422:             x = (t * (wad + lnWad(x)));
423:             
424:             assembly {
425:                 w := sdiv(x, add(wad, t))
426:             }
427:         }
428:     }
```


</details>

## [NonCritical-65] Unnecessary struct attribute prefix

### Resolution 
In struct definitions, using redundant prefixes for attributes is unnecessary. For instance, in a struct named Employee, attributes like employeeName, employeeID, and employeeEmail can be simplified to name, ID, and email respectively, since they are already inherently associated with Employee. By removing these repetitive prefixes, the code becomes more concise and easier to read, maintaining its contextual clarity.

Num of instances: 3

### Findings 


<details><summary>Click to show findings</summary>

['[36](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruForwarder.sol#L36-L39)']
```solidity
36:     struct PriceDependentRequest { // <= FOUND
37:         address from;
38:         address market;
39:         uint256 price; // <= FOUND
40:         uint256 value;
41:         uint256 nonce;
42:         uint256 deadline;
43:         bool isBelowPrice;
44:         bytes4 selector;
45:         bytes data;
46:     }
```
['[54](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruForwarder.sol#L54-L56)']
```solidity
54:     struct MarginAccountRequest { // <= FOUND
55:         address from;
56:         address marginAccount; // <= FOUND
57:         uint256 value;
58:         uint256 nonce;
59:         uint256 deadline;
60:         bytes4 selector;
61:         bytes data;
62:     }
```
['[13](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/periphery/MonadDeployer.sol#L13-L16)']
```solidity
13:     struct TokenParams { // <= FOUND
14:         string name;
15:         string symbol;
16:         string tokenURI; // <= FOUND
17:         uint256 initialSupply;
18:         address dev;
19:         uint256 supplyToDev; 
20:     }
```


</details>

## [NonCritical-66] Redundant function returns constant

### Resolution 
Functions which only return a predefined constant have a similar redundancy as empty code blocks. If these blocks are not used to satisfy interface enforcements, or similar rulings, they should be removed.

Num of instances: 1

### Findings 


<details><summary>Click to show findings</summary>

['[38](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/ERC2771Context.sol#L38-L39)']
```solidity
38:     function _contextSuffixLength() internal pure returns (uint256) {
39:         return 20; // <= FOUND
40:     }
```


</details>

## [NonCritical-67] ERC777 tokens can introduce reentrancy risks

### Resolution 
ERC777 is an advanced token standard that introduces hooks, allowing operators to execute additional logic during transfers. While this feature offers greater flexibility, it also opens up the possibility of reentrancy attacks. Specifically, when tokens are sent, the receiving contract's `tokensReceived` hook gets called, and this external call can execute arbitrary code. An attacker can exploit this feature to re-enter the original function, potentially leading to double-spending or other types of financial manipulation.

To mitigate reentrancy risks with ERC777, it's crucial to adopt established security measures, such as utilizing reentrancy guards or following the check-effects-interactions pattern. Some developers opt to stick with the simpler ERC20 standard, which does not have these hooks, to minimize this risk. If you do choose to use ERC777, extreme caution and thorough auditing are advised to secure against potential reentrancy vulnerabilities.

Num of instances: 3

### Findings 


<details><summary>Click to show findings</summary>

['[220](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L220-L226)']
```solidity
220:     function _depositAmountsToMarginAccount(address _token1, address _token2, uint256 baseDeposit, uint256 quoteDeposit) // <= FOUND
221:         internal
222:     {
223:         if (_token1 == address(0)) {
224:             marginAccount.deposit{value: baseDeposit}(address(this), _token1, baseDeposit);
225:         } else {
226:             _token1.safeTransferFrom(msg.sender, address(this), baseDeposit); // <= FOUND
227:             marginAccount.deposit(address(this), _token1, baseDeposit);
228:         }
229: 
230:         if (_token2 == address(0)) {
231:             marginAccount.deposit{value: quoteDeposit}(address(this), _token2, quoteDeposit);
232:         } else {
233:             _token2.safeTransferFrom(msg.sender, address(this), quoteDeposit);
234:             marginAccount.deposit(address(this), _token2, quoteDeposit);
235:         }
236:     }
```
['[198](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L198-L206)']
```solidity
198:     function deposit(address _user, address _token, uint256 _amount) external payable protocolActive { // <= FOUND
199:         require(_user != address(0), MarginAccountErrors.ZeroAddressNotAllowed());
200:         if (_token == NATIVE) {
201:             require(msg.value == _amount, MarginAccountErrors.NativeAssetMismatch());
202:             balances[_accountKey(_user, NATIVE)] += _amount;
203:         } else {
204:             require(msg.value == 0, MarginAccountErrors.NativeAssetMismatch());
205:             balances[_accountKey(_user, _token)] += _amount;
206:             _token.safeTransferFrom(_msgSender(), address(this), _amount); // <= FOUND
207:         }
208: 
209:         emit Deposit(_user, _token, _amount);
210:     }
```
['[331](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L331-L344)']
```solidity
331:     function anyToAnySwap( // <= FOUND
332:         address[] calldata _marketAddresses,
333:         bool[] calldata _isBuy,
334:         bool[] calldata _nativeSend,
335:         address _debitToken,
336:         address _creditToken,
337:         uint256 _amount,
338:         uint256 _minAmountOut
339:     ) external payable returns (uint256 _amountOut) {
340:         require(_marketAddresses.length >= 1, RouterErrors.NoMarketsPassed());
341:         require(_isBuy.length == _marketAddresses.length, RouterErrors.LengthMismatch());
342:         require(_nativeSend.length == _marketAddresses.length, RouterErrors.LengthMismatch());
343:         if (_nativeSend[0] == false) {
344:             _debitToken.safeTransferFrom(msg.sender, address(this), _amount); // <= FOUND
345:         }
346:         uint256 _cachedAmountIn = _amount;
347: 
348:         for (uint256 i = 0; i < _marketAddresses.length; i++) {
349:             address _currentMarket = _marketAddresses[i];
350:             MarketParams memory _marketParams = verifiedMarket[_currentMarket];
351:             require(_marketParams.pricePrecision > 0, RouterErrors.InvalidMarket());
352:             IOrderBook market = IOrderBook(_currentMarket);
353:             uint256 _value = _nativeSend[i] ? _amount : 0;
354:             _amountOut = _isBuy[i]
355:                 ? (
356:                     market.placeAndExecuteMarketBuy{value: _value}(
357:                         toU96(_amount * _marketParams.pricePrecision / 10 ** _marketParams.quoteAssetDecimals),
358:                         0,
359:                         false,
360:                         true
361:                     )
362:                 )
363:                 : market.placeAndExecuteMarketSell{value: _value}(
364:                     toU96(_amount * _marketParams.sizePrecision / 10 ** _marketParams.baseAssetDecimals), 0, false, true
365:                 );
366: 
367:             _amount = _amountOut;
368:         }
369:         require(_amountOut >= _minAmountOut, RouterErrors.SlippageExceeded());
370:         emit KuruRouterSwap(msg.sender, _debitToken, _creditToken, _cachedAmountIn, _amountOut);
371:         if (_creditToken != address(0)) {
372:             _creditToken.safeTransfer(msg.sender, _amountOut);
373:         } else {
374:             msg.sender.safeTransferETH(_amountOut);
375:         }
376:     }
```


</details>

## [NonCritical-68] Avoid assembly in `view` or `pure` functions

### Resolution 
Using assembly in view or pure functions is risky because it bypasses Solidity's safeguards, potentially allowing unintended state reads or writes when interacting with storage. view and pure functions are meant to ensure no state changes occur, but improper use of assembly can violate this, leading to logical errors or undefined behavior.

For instance, directly accessing storage slots in assembly within a view function could inadvertently modify state due to mismanagement of pointers or memory allocation. This undermines the trust and guarantees associated with view and pure functions. To ensure integrity, use high-level Solidity constructs for state access, as they enforce read/write restrictions and maintain consistency.

Num of instances: 74

### Findings 


<details><summary>Click to show findings</summary>

[]
```solidity
127:     function previewDeposit(uint256 asset1, uint256 asset2) public view virtual returns (uint256) {
128:         (, uint256 _price) = _returnNormalizedAmountAndPrice(true);
129:         return _convertToShares(asset1, asset2, _price);
130:     }
```
[]
```solidity
135:     function previewMint(uint256 shares) public view virtual returns (uint256, uint256) {
136:         return _convertToAssets(shares, true);
137:     }
```
[]
```solidity
142:     function previewWithdraw(uint256 shares) public view virtual returns (uint256, uint256) {
143:         return _convertToAssets(shares, false);
144:     }
```
[]
```solidity
316:     function _returnNormalizedAmountAndPrice(bool roundUp) internal view returns (uint256, uint256) {
317:         
318:         
319:         uint96 _normalizedBaseAmount = roundUp
320:             ? toU96(
321:                 FixedPointMathLib.mulDivUp(
322:                     market.vaultAskOrderSize(), DOUBLE_BPS_MULTIPLIER + SPREAD_CONSTANT, SPREAD_CONSTANT
323:                 )
324:             )
325:             : toU96(
326:                 FixedPointMathLib.mulDiv(
327:                     market.vaultAskOrderSize(), DOUBLE_BPS_MULTIPLIER + SPREAD_CONSTANT, SPREAD_CONSTANT
328:                 )
329:             );
330:         uint256 _price = market.vaultBestAsk();
331:         return ((_normalizedBaseAmount * 10 ** marketParams.baseAssetDecimals) / marketParams.sizePrecision, _price);
332:     }
```
[]
```solidity
337:     function _convertToShares(uint256 baseAmount, uint256 quoteAmount, uint256 _currentAskPrice)
338:         internal
339:         view
340:         returns (uint256)
341:     {
342:         (uint256 _reserve1, uint256 _reserve2) = totalAssets();
343:         (_reserve1, _reserve2) = _returnVirtuallyRebalancedTotalAssets(_reserve1, _reserve2, _currentAskPrice);
344:         return FixedPointMathLib.min(
345:             FixedPointMathLib.mulDiv(baseAmount, totalSupply(), _reserve1),
346:             FixedPointMathLib.mulDiv(quoteAmount, totalSupply(), _reserve2)
347:         );
348:     }
```
[]
```solidity
350:     function _convertToAssets(uint256 shares, bool isDeposit)
351:         internal
352:         view
353:         returns (uint256 _baseAmount, uint256 _quoteAmount)
354:     {
355:         if (isDeposit) {
356:             if (totalSupply() == 0) {
357:                 return (0, 0);
358:             }
359:             (uint256 _baseReserve, uint256 _quoteReserve) = totalAssets();
360:             (, uint256 _currentAskPrice) = _returnNormalizedAmountAndPrice(true);
361:             (_baseReserve, _quoteReserve) =
362:                 _returnVirtuallyRebalancedTotalAssets(_baseReserve, _quoteReserve, _currentAskPrice);
363:             _baseAmount = FixedPointMathLib.mulDiv(shares, _baseReserve, totalSupply());
364:             _quoteAmount = (
365:                 (
366:                     FixedPointMathLib.mulDivUp(_baseAmount, _currentAskPrice, vaultPricePrecision)
367:                         * 10 ** marketParams.quoteAssetDecimals
368:                 )
369:             ) / 10 ** marketParams.baseAssetDecimals;
370:             return (_baseAmount, _quoteAmount);
371:         } else {
372:             (_baseAmount, _quoteAmount,,,) = _convertToAssetsWithNewSize(shares);
373:         }
374:     }
```
[]
```solidity
376:     function _convertToAssetsWithNewSize(uint256 shares)
377:         internal
378:         view
379:         returns (uint256, uint256, uint96, uint96, bool)
380:     {
381:         (uint256 _baseAmount,) = _returnNormalizedAmountAndPrice(false);
382:         uint256 _baseAmountAfterRemoval = _baseAmount - FixedPointMathLib.mulDiv(shares, _baseAmount, totalSupply());
383:         (uint96 _newAskSize, uint96 _newBidSize) = _getVaultSizesForBaseAmount(_baseAmountAfterRemoval);
384:         (
385:             ,
386:             uint256 _vaultBestBid,
387:             uint96 _partiallyFilledBidSize,
388:             uint256 _vaultBestAsk,
389:             uint96 _partiallyFilledAskSize,
390:             ,
391:             ,
392:         ) = market.getVaultParams();
393:         MarketParams memory _marketParams = marketParams;
394:         (uint256 _reserveBase, uint256 _reserveQuote) = totalAssets();
395:         if (_partiallyFilledAskSize > _newAskSize || _partiallyFilledBidSize > _newBidSize) {
396:             int256 _baseOwedToVault = (
397:                 int256(uint256(_partiallyFilledAskSize)) - int256(uint256(_partiallyFilledBidSize))
398:             ) * int256(10 ** _marketParams.baseAssetDecimals) / int256(uint256(_marketParams.sizePrecision));
399:             int256 _quoteOwedToVault = (
400:                 int256(FixedPointMathLib.mulDivUp(_partiallyFilledBidSize, _vaultBestBid, _marketParams.sizePrecision))
401:                     - int256(FixedPointMathLib.mulDiv(_partiallyFilledAskSize, _vaultBestAsk, _marketParams.sizePrecision))
402:             ) * int256(10 ** _marketParams.quoteAssetDecimals) / int256(vaultPricePrecision);
403:             uint256 _baseOwedToUser;
404:             uint256 _quoteOwedToUser;
405:             if (_baseOwedToVault < 0) {
406:                 _reserveBase = _reserveBase - (uint256(-1 * _baseOwedToVault));
407:                 _baseOwedToUser =
408:                     FixedPointMathLib.mulDiv(shares, _reserveBase, totalSupply()) + uint256(-1 * _baseOwedToVault);
409:             } else {
410:                 _reserveBase = _reserveBase + (uint256(_baseOwedToVault));
411:                 _baseOwedToUser =
412:                     FixedPointMathLib.mulDiv(shares, _reserveBase, totalSupply()) - uint256(_baseOwedToVault);
413:             }
414:             if (_quoteOwedToVault < 0) {
415:                 _reserveQuote = _reserveQuote - (uint256(-1 * _quoteOwedToVault));
416:                 _quoteOwedToUser =
417:                     FixedPointMathLib.mulDiv(shares, _reserveQuote, totalSupply()) + uint256(-1 * _quoteOwedToVault);
418:             } else {
419:                 _reserveQuote = _reserveQuote + (uint256(_quoteOwedToVault));
420:                 _quoteOwedToUser =
421:                     FixedPointMathLib.mulDiv(shares, _reserveQuote, totalSupply()) - uint256(_quoteOwedToVault);
422:             }
423:             return (_baseOwedToUser, _quoteOwedToUser, _newAskSize, _newBidSize, true);
424:         } else {
425:             uint256 _baseOwedToUser = FixedPointMathLib.mulDiv(shares, _reserveBase, totalSupply());
426:             uint256 _quoteOwedToUser = FixedPointMathLib.mulDiv(shares, _reserveQuote, totalSupply());
427:             return (_baseOwedToUser, _quoteOwedToUser, _newAskSize, _newBidSize, false);
428:         }
429:     }
```
[]
```solidity
108:     function findFirstRight(TreeUint32 storage tree, uint32 id) internal view returns (uint32) {
109:         bytes32 leaves;
110: 
111:         bytes32 key3 = bytes32(uint256(id) >> 8);
112:         uint8 bit = uint8(id & type(uint8).max);
113: 
114:         if (bit != 0) {
115:             leaves = tree.level3[key3];
116:             uint256 closestBit = _closestBitRight(leaves, bit);
117: 
118:             if (closestBit != type(uint256).max) return uint32((uint256(key3) << 8) | closestBit);
119:         }
120: 
121:         bytes32 key2 = key3 >> 8;
122:         bit = uint8(uint256(key3) & type(uint8).max);
123: 
124:         if (bit != 0) {
125:             leaves = tree.level2[key2];
126:             uint256 closestBit = _closestBitRight(leaves, bit);
127: 
128:             if (closestBit != type(uint256).max) {
129:                 key3 = bytes32((uint256(key2) << 8) | closestBit);
130:                 leaves = tree.level3[key3];
131: 
132:                 return uint32((uint256(key3) << 8) | uint256(leaves).mostSignificantBit());
133:             }
134:         }
135: 
136:         bytes32 key1 = key2 >> 8;
137:         bit = uint8(uint256(key2) & type(uint8).max);
138: 
139:         if (bit != 0) {
140:             leaves = tree.level1[key1];
141:             uint256 closestBit = _closestBitRight(leaves, bit);
142: 
143:             if (closestBit != type(uint256).max) {
144:                 key2 = bytes32((uint256(key1) << 8) | closestBit);
145:                 leaves = tree.level2[key2];
146: 
147:                 key3 = bytes32((uint256(key2) << 8) | uint256(leaves).mostSignificantBit());
148:                 leaves = tree.level3[key3];
149: 
150:                 return uint32((uint256(key3) << 8) | uint256(leaves).mostSignificantBit());
151:             }
152:         }
153: 
154:         bit = uint8(uint256(key1) & type(uint8).max);
155: 
156:         if (bit != 0) {
157:             leaves = tree.level0;
158:             uint256 closestBit = _closestBitRight(leaves, bit);
159: 
160:             if (closestBit != type(uint256).max) {
161:                 key1 = bytes32(closestBit);
162:                 leaves = tree.level1[key1];
163: 
164:                 key2 = bytes32((uint256(key1) << 8) | uint256(leaves).mostSignificantBit());
165:                 leaves = tree.level2[key2];
166: 
167:                 key3 = bytes32((uint256(key2) << 8) | uint256(leaves).mostSignificantBit());
168:                 leaves = tree.level3[key3];
169: 
170:                 return uint32((uint256(key3) << 8) | uint256(leaves).mostSignificantBit());
171:             }
172:         }
173: 
174:         return type(uint32).max;
175:     }
```
[]
```solidity
184:     function findFirstLeft(TreeUint32 storage tree, uint32 id) internal view returns (uint32) {
185:         bytes32 leaves;
186: 
187:         bytes32 key3 = bytes32(uint256(id) >> 8);
188:         uint8 bit = uint8(id & type(uint8).max);
189: 
190:         if (bit != type(uint8).max) {
191:             leaves = tree.level3[key3];
192:             uint256 closestBit = _closestBitLeft(leaves, bit);
193: 
194:             if (closestBit != type(uint256).max) return uint32((uint256(key3) << 8) | closestBit);
195:         }
196: 
197:         bytes32 key2 = key3 >> 8;
198:         bit = uint8(uint256(key3) & type(uint8).max);
199: 
200:         if (bit != type(uint8).max) {
201:             leaves = tree.level2[key2];
202:             uint256 closestBit = _closestBitLeft(leaves, bit);
203: 
204:             if (closestBit != type(uint256).max) {
205:                 key3 = bytes32((uint256(key2) << 8) | closestBit);
206:                 leaves = tree.level3[key3];
207: 
208:                 return uint32((uint256(key3) << 8) | uint256(leaves).leastSignificantBit());
209:             }
210:         }
211: 
212:         bytes32 key1 = key2 >> 8;
213:         bit = uint8(uint256(key2) & type(uint8).max);
214: 
215:         if (bit != type(uint8).max) {
216:             leaves = tree.level1[key1];
217:             uint256 closestBit = _closestBitLeft(leaves, bit);
218: 
219:             if (closestBit != type(uint256).max) {
220:                 key2 = bytes32((uint256(key1) << 8) | closestBit);
221:                 leaves = tree.level2[key2];
222: 
223:                 key3 = bytes32((uint256(key2) << 8) | uint256(leaves).leastSignificantBit());
224:                 leaves = tree.level3[key3];
225: 
226:                 return uint32((uint256(key3) << 8) | uint256(leaves).leastSignificantBit());
227:             }
228:         }
229: 
230:         bit = uint8(uint256(key1) & type(uint8).max);
231: 
232:         if (bit != type(uint8).max) {
233:             leaves = tree.level0;
234:             uint256 closestBit = _closestBitLeft(leaves, bit);
235: 
236:             if (closestBit != type(uint256).max) {
237:                 key1 = bytes32(closestBit);
238:                 leaves = tree.level1[key1];
239: 
240:                 key2 = bytes32((uint256(key1) << 8) | uint256(leaves).leastSignificantBit());
241:                 leaves = tree.level2[key2];
242: 
243:                 key3 = bytes32((uint256(key2) << 8) | uint256(leaves).leastSignificantBit());
244:                 leaves = tree.level3[key3];
245: 
246:                 return uint32((uint256(key3) << 8) | uint256(leaves).leastSignificantBit());
247:             }
248:         }
249: 
250:         return 0;
251:     }
```
[]
```solidity
1225:     function _quoteAmountRoundedUp(uint32 _price, uint96 _size) internal view returns (uint96) {
1226:         uint256 _result = FixedPointMathLib.mulDivUp(_price, _size, sizePrecision);
1227:         return toU96(_result);
1228:     }
```
[]
```solidity
1331:     function bestBidAsk() external view returns (uint256, uint256) {
1332:         (, uint256 _bestBid) = bestBid();
1333:         (, uint256 _bestAsk) = bestAsk();
1334:         return (_bestBid, _bestAsk);
1335:     }
```
[]
```solidity
1337:     function _getOBAsk() internal view returns (uint256) {
1338:         uint32 firstLeft = TreeMath.findFirstLeft(s_sellTree, 0);
1339:         if (firstLeft != 0) {
1340:             return firstLeft * vaultPricePrecision / pricePrecision;
1341:         }
1342:         return type(uint256).max;
1343:     }
```
[]
```solidity
1345:     function _getOBBid() internal view returns (uint256) {
1346:         uint32 firstRight = TreeMath.findFirstRight(s_buyTree, type(uint32).max);
1347:         if (firstRight != type(uint32).max) {
1348:             return firstRight * vaultPricePrecision / pricePrecision;
1349:         }
1350:         return 0;
1351:     }
```
[]
```solidity
1353:     function bestAsk() internal view returns (bool, uint256) {
1354:         uint256 firstLeft = TreeMath.findFirstLeft(s_sellTree, 0) * vaultPricePrecision / pricePrecision;
1355:         if (firstLeft != 0) {
1356:             if (vaultBestAsk != type(uint256).max) {
1357:                 if (firstLeft == vaultBestAsk) {
1358:                     return (false, firstLeft);
1359:                 }
1360:                 return (FixedPointMathLib.min(firstLeft, vaultBestAsk)) == vaultBestAsk
1361:                     ? (true, vaultBestAsk)
1362:                     : (false, firstLeft);
1363:             }
1364:             return (false, firstLeft);
1365:         }
1366:         return (vaultBestAsk != type(uint256).max) ? (true, vaultBestAsk) : (false, 0);
1367:     }
```
[]
```solidity
1369:     function bestBid() internal view returns (bool, uint256) {
1370:         uint256 firstRight = TreeMath.findFirstRight(s_buyTree, type(uint32).max) * vaultPricePrecision / pricePrecision;
1371:         if (firstRight != type(uint32).max * vaultPricePrecision / pricePrecision) {
1372:             if (vaultBestBid != 0) {
1373:                 if (firstRight == vaultBestBid) {
1374:                     return (false, firstRight);
1375:                 }
1376:                 return (FixedPointMathLib.max(firstRight, vaultBestBid)) == vaultBestBid
1377:                     ? (true, vaultBestBid)
1378:                     : (false, firstRight);
1379:             }
1380:             return (false, firstRight);
1381:         }
1382:         return vaultBestBid != 0 ? (true, vaultBestBid) : (false, type(uint256).max);
1383:     }
```
[]
```solidity
1399:     function getL2Book(uint32 _bidPricePoints, uint32 _askPricePoints) public view returns (bytes memory data) {
1400:         uint256 dataStart;
1401:         uint256 lastFree;
1402: 
1403:         assembly ("memory-safe") {
1404:             dataStart := mload(0x40)
1405:             lastFree := add(dataStart, 32)
1406:             mstore(lastFree, number()) 
1407:             lastFree := add(lastFree, 32)
1408:             mstore(0x40, lastFree)
1409:         }
1410: 
1411:         
1412:         uint32 price = TreeMath.findFirstRight(s_buyTree, type(uint32).max);
1413:         while (price != type(uint32).max && price != 0 && _bidPricePoints != 0) {
1414:             uint40 orderId = s_buyPricePoints[price].head;
1415:             uint96 size = 0;
1416:             while (orderId != 0) {
1417:                 size += s_orders[orderId].size;
1418:                 orderId = s_orders[orderId].next;
1419:             }
1420:             assembly ("memory-safe") {
1421:                 let curFree := mload(0x40)
1422:                 if iszero(eq(curFree, lastFree)) {
1423:                     
1424:                     let producedLen := sub(lastFree, dataStart)
1425:                     for { let offset := 0 } lt(offset, producedLen) { offset := add(offset, 32) } {
1426:                         mstore(add(curFree, offset), mload(add(dataStart, offset)))
1427:                     }
1428:                     dataStart := curFree
1429:                     lastFree := add(curFree, producedLen)
1430:                 }
1431: 
1432:                 mstore(lastFree, price)
1433:                 mstore(add(lastFree, 32), size)
1434:                 lastFree := add(lastFree, 64)
1435:                 mstore(0x40, lastFree)
1436:             }
1437:             price = TreeMath.findFirstRight(s_buyTree, price);
1438:             --_bidPricePoints;
1439:         }
1440: 
1441:         assembly ("memory-safe") {
1442:             let curFree := mload(0x40)
1443:             if iszero(eq(curFree, lastFree)) {
1444:                 let producedLen := sub(lastFree, dataStart)
1445:                 for { let offset := 0 } lt(offset, producedLen) { offset := add(offset, 32) } {
1446:                     mstore(add(curFree, offset), mload(add(dataStart, offset)))
1447:                 }
1448:                 dataStart := curFree
1449:                 lastFree := add(curFree, producedLen)
1450:             }
1451: 
1452:             mstore(lastFree, 0)
1453:             lastFree := add(lastFree, 32)
1454:             mstore(0x40, lastFree)
1455:         }
1456: 
1457:         price = TreeMath.findFirstLeft(s_sellTree, 0);
1458:         while (price != type(uint32).max && price != 0 && _askPricePoints != 0) {
1459:             uint40 orderId = s_sellPricePoints[price].head;
1460:             uint96 size = 0;
1461:             while (orderId != 0) {
1462:                 size += s_orders[orderId].size;
1463:                 orderId = s_orders[orderId].next;
1464:             }
1465:             assembly ("memory-safe") {
1466:                 let curFree := mload(0x40)
1467:                 if iszero(eq(curFree, lastFree)) {
1468:                     
1469:                     let producedLen := sub(lastFree, dataStart)
1470:                     for { let offset := 0 } lt(offset, producedLen) { offset := add(offset, 32) } {
1471:                         mstore(add(curFree, offset), mload(add(dataStart, offset)))
1472:                     }
1473:                     dataStart := curFree
1474:                     lastFree := add(curFree, producedLen)
1475:                 }
1476: 
1477:                 mstore(lastFree, price)
1478:                 mstore(add(lastFree, 32), size)
1479:                 lastFree := add(lastFree, 64)
1480:                 mstore(0x40, lastFree)
1481:             }
1482:             price = TreeMath.findFirstLeft(s_sellTree, price);
1483:             --_askPricePoints;
1484:         }
1485: 
1486:         assembly ("memory-safe") {
1487:             mstore(dataStart, sub(lastFree, add(dataStart, 32)))
1488:             data := dataStart
1489:         }
1490:     }
```
['[64](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L64-L66)']
```solidity
64:     function mulWad(uint256 x, uint256 y) internal pure returns (uint256 z) {
65:         
66:         assembly { // <= FOUND
67:             
68:             if mul(y, gt(x, div(not(0), y))) {
69:                 mstore(0x00, 0xbac65e5b) 
70:                 revert(0x1c, 0x04)
71:             }
72:             z := div(mul(x, y), WAD)
73:         }
74:     }
```
['[77](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L77-L79)']
```solidity
77:     function sMulWad(int256 x, int256 y) internal pure returns (int256 z) {
78:         
79:         assembly { // <= FOUND
80:             z := mul(x, y)
81:             
82:             if iszero(gt(or(iszero(x), eq(sdiv(z, x), y)), lt(not(x), eq(y, shl(255, 1))))) {
83:                 mstore(0x00, 0xedcd4dd4) 
84:                 revert(0x1c, 0x04)
85:             }
86:             z := sdiv(z, WAD)
87:         }
88:     }
```
['[91](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L91-L93)']
```solidity
91:     function rawMulWad(uint256 x, uint256 y) internal pure returns (uint256 z) {
92:         
93:         assembly { // <= FOUND
94:             z := div(mul(x, y), WAD)
95:         }
96:     }
```
['[99](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L99-L101)']
```solidity
99:     function rawSMulWad(int256 x, int256 y) internal pure returns (int256 z) {
100:         
101:         assembly { // <= FOUND
102:             z := sdiv(mul(x, y), WAD)
103:         }
104:     }
```
['[107](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L107-L109)']
```solidity
107:     function mulWadUp(uint256 x, uint256 y) internal pure returns (uint256 z) {
108:         
109:         assembly { // <= FOUND
110:             
111:             if mul(y, gt(x, div(not(0), y))) {
112:                 mstore(0x00, 0xbac65e5b) 
113:                 revert(0x1c, 0x04)
114:             }
115:             z := add(iszero(iszero(mod(mul(x, y), WAD))), div(mul(x, y), WAD))
116:         }
117:     }
```
['[120](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L120-L122)']
```solidity
120:     function rawMulWadUp(uint256 x, uint256 y) internal pure returns (uint256 z) {
121:         
122:         assembly { // <= FOUND
123:             z := add(iszero(iszero(mod(mul(x, y), WAD))), div(mul(x, y), WAD))
124:         }
125:     }
```
['[128](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L128-L130)']
```solidity
128:     function divWad(uint256 x, uint256 y) internal pure returns (uint256 z) {
129:         
130:         assembly { // <= FOUND
131:             
132:             if iszero(mul(y, iszero(mul(WAD, gt(x, div(not(0), WAD)))))) {
133:                 mstore(0x00, 0x7c5f487d) 
134:                 revert(0x1c, 0x04)
135:             }
136:             z := div(mul(x, WAD), y)
137:         }
138:     }
```
['[141](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L141-L143)']
```solidity
141:     function sDivWad(int256 x, int256 y) internal pure returns (int256 z) {
142:         
143:         assembly { // <= FOUND
144:             z := mul(x, WAD)
145:             
146:             if iszero(and(iszero(iszero(y)), eq(sdiv(z, WAD), x))) {
147:                 mstore(0x00, 0x5c43740d) 
148:                 revert(0x1c, 0x04)
149:             }
150:             z := sdiv(mul(x, WAD), y)
151:         }
152:     }
```
['[155](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L155-L157)']
```solidity
155:     function rawDivWad(uint256 x, uint256 y) internal pure returns (uint256 z) {
156:         
157:         assembly { // <= FOUND
158:             z := div(mul(x, WAD), y)
159:         }
160:     }
```
['[163](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L163-L165)']
```solidity
163:     function rawSDivWad(int256 x, int256 y) internal pure returns (int256 z) {
164:         
165:         assembly { // <= FOUND
166:             z := sdiv(mul(x, WAD), y)
167:         }
168:     }
```
['[171](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L171-L173)']
```solidity
171:     function divWadUp(uint256 x, uint256 y) internal pure returns (uint256 z) {
172:         
173:         assembly { // <= FOUND
174:             
175:             if iszero(mul(y, iszero(mul(WAD, gt(x, div(not(0), WAD)))))) {
176:                 mstore(0x00, 0x7c5f487d) 
177:                 revert(0x1c, 0x04)
178:             }
179:             z := add(iszero(iszero(mod(mul(x, WAD), y))), div(mul(x, WAD), y))
180:         }
181:     }
```
['[184](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L184-L186)']
```solidity
184:     function rawDivWadUp(uint256 x, uint256 y) internal pure returns (uint256 z) {
185:         
186:         assembly { // <= FOUND
187:             z := add(iszero(iszero(mod(mul(x, WAD), y))), div(mul(x, WAD), y))
188:         }
189:     }
```
[]
```solidity
194:     function powWad(int256 x, int256 y) internal pure returns (int256) {
195:         
196:         return expWad((lnWad(x) * y) / int256(WAD));
197:     }
```
['[202](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L202-L248)']
```solidity
202:     function expWad(int256 x) internal pure returns (int256 r) {
203:         unchecked {
204:             
205:             
206:             if (x <= -41446531673892822313) return r;
207: 
208:             
209:             assembly { // <= FOUND
210:                 
211:                 
212:                 if iszero(slt(x, 135305999368893231589)) {
213:                     mstore(0x00, 0xa37bfec9) 
214:                     revert(0x1c, 0x04)
215:                 }
216:             }
217: 
218:             
219:             
220:             
221:             x = (x << 78) / 5 ** 18;
222: 
223:             
224:             
225:             
226:             int256 k = ((x << 96) / 54916777467707473351141471128 + 2 ** 95) >> 96;
227:             x = x - k * 54916777467707473351141471128;
228: 
229:             
230: 
231:             
232:             
233:             int256 y = x + 1346386616545796478920950773328;
234:             y = ((y * x) >> 96) + 57155421227552351082224309758442;
235:             int256 p = y + x - 94201549194550492254356042504812;
236:             p = ((p * y) >> 96) + 28719021644029726153956944680412240;
237:             p = p * x + (4385272521454847904659076985693276 << 96);
238: 
239:             
240:             int256 q = x - 2855989394907223263936484059900;
241:             q = ((q * x) >> 96) + 50020603652535783019961831881945;
242:             q = ((q * x) >> 96) - 533845033583426703283633433725380;
243:             q = ((q * x) >> 96) + 3604857256930695427073651918091429;
244:             q = ((q * x) >> 96) - 14423608567350463180887372962807573;
245:             q = ((q * x) >> 96) + 26449188498355588339934803723976023;
246: 
247:             
248:             assembly { // <= FOUND
249:                 
250:                 
251:                 
252:                 r := sdiv(p, q)
253:             }
254: 
255:             
256: 
257:             
258:             
259:             
260:             
261:             
262:             
263:             r = int256((uint256(r) * 3822833074963236453042738258902158003155416615667) >> uint256(195 - k));
264:         }
265:     }
```
['[270](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L270-L272)']
```solidity
270:     function lnWad(int256 x) internal pure returns (int256 r) {
271:         
272:         assembly { // <= FOUND
273:             
274:             
275:             
276:             
277: 
278:             
279:             r := shl(7, lt(0xffffffffffffffffffffffffffffffff, x))
280:             r := or(r, shl(6, lt(0xffffffffffffffff, shr(r, x))))
281:             r := or(r, shl(5, lt(0xffffffff, shr(r, x))))
282:             r := or(r, shl(4, lt(0xffff, shr(r, x))))
283:             r := or(r, shl(3, lt(0xff, shr(r, x))))
284:             
285:             if iszero(sgt(x, 0)) {
286:                 mstore(0x00, 0x1615e638) 
287:                 revert(0x1c, 0x04)
288:             }
289:             
290:             r := xor(r, byte(and(0x1f, shr(shr(r, x), 0x8421084210842108cc6318c6db6d54be)),
291:                 0xf8f9f9faf9fdfafbf9fdfcfdfafbfcfef9fafdfafcfcfbfefafafcfbffffffff))
292: 
293:             
294:             
295:             x := shr(159, shl(r, x))
296: 
297:             
298:             
299:             
300:             let p := sub( 
301:                 sar(96, mul(add(43456485725739037958740375743393,
302:                 sar(96, mul(add(24828157081833163892658089445524,
303:                 sar(96, mul(add(3273285459638523848632254066296,
304:                     x), x))), x))), x)), 11111509109440967052023855526967)
305:             p := sub(sar(96, mul(p, x)), 45023709667254063763336534515857)
306:             p := sub(sar(96, mul(p, x)), 14706773417378608786704636184526)
307:             p := sub(mul(p, x), shl(96, 795164235651350426258249787498))
308:             
309: 
310:             
311:             let q := add(5573035233440673466300451813936, x)
312:             q := add(71694874799317883764090561454958, sar(96, mul(x, q)))
313:             q := add(283447036172924575727196451306956, sar(96, mul(x, q)))
314:             q := add(401686690394027663651624208769553, sar(96, mul(x, q)))
315:             q := add(204048457590392012362485061816622, sar(96, mul(x, q)))
316:             q := add(31853899698501571402653359427138, sar(96, mul(x, q)))
317:             q := add(909429971244387300277376558375, sar(96, mul(x, q)))
318: 
319:             
320: 
321:             
322:             
323:             
324:             
325:             
326: 
327:             
328:             
329:             p := sdiv(p, q)
330:             
331:             p := mul(1677202110996718588342820967067443963516166, p)
332:             
333:             
334:             p := add(mul(16597577552685614221487285958193947469193820559219878177908093499208371, sub(159, r)), p)
335:             
336:             p := add(600920179829731861736702779321621459595472258049074101567377883020018308, p)
337:             
338:             r := sar(174, p)
339:         }
340:     }
```
['[346](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L346-L424)']
```solidity
346:     function lambertW0Wad(int256 x) internal pure returns (int256 w) {
347:         
348:         unchecked {
349:             if ((w = x) <= -367879441171442322) revert OutOfDomain(); 
350:             int256 wad = int256(WAD);
351:             int256 p = x;
352:             uint256 c; 
353:             uint256 i = 4; 
354:             if (w <= 0x1ffffffffffff) {
355:                 if (-0x4000000000000 <= w) {
356:                     i = 1; 
357:                 } else if (w <= -0x3ffffffffffffff) {
358:                     i = 32; 
359:                 }
360:             } else if (uint256(w >> 63) == uint256(0)) {
361:                 
362:                 assembly { // <= FOUND
363:                     
364:                     let v := shr(49, w)
365:                     let l := shl(3, lt(0xff, v))
366:                     l := add(or(l, byte(and(0x1f, shr(shr(l, v), 0x8421084210842108cc6318c6db6d54be)),
367:                         0x0706060506020504060203020504030106050205030304010505030400000000)), 49)
368:                     w := sdiv(shl(l, 7), byte(sub(l, 31), 0x0303030303030303040506080c13))
369:                     c := gt(l, 60)
370:                     i := add(2, add(gt(l, 53), c))
371:                 }
372:             } else {
373:                 int256 ll = lnWad(w = lnWad(w));
374:                 
375:                 assembly { // <= FOUND
376:                     
377:                     w := add(sdiv(mul(ll, 1023715080943847266), w), sub(w, ll))
378:                     i := add(3, iszero(shr(68, x)))
379:                     c := iszero(shr(143, x))
380:                 }
381:                 if (c == uint256(0)) {
382:                     do { 
383:                         int256 e = expWad(w);
384:                         
385:                         assembly { // <= FOUND
386:                             let t := mul(w, div(e, wad))
387:                             w := sub(w, sdiv(sub(t, x), div(add(e, t), wad)))
388:                         }
389:                         if (p <= w) break;
390:                         p = w;
391:                     } while (--i != uint256(0));
392:                     
393:                     assembly { // <= FOUND
394:                         w := sub(w, sgt(w, 2))
395:                     }
396:                     return w;
397:                 }
398:             }
399:             do { 
400:                 int256 e = expWad(w);
401:                 
402:                 assembly { // <= FOUND
403:                     let t := add(w, wad)
404:                     let s := sub(mul(w, e), mul(x, wad))
405:                     w := sub(w, sdiv(mul(s, wad), sub(mul(e, t), sdiv(mul(add(t, wad), s), add(t, t)))))
406:                 }
407:                 if (p <= w) break;
408:                 p = w;
409:             } while (--i != c);
410:             
411:             assembly { // <= FOUND
412:                 w := sub(w, sgt(w, 2))
413:             }
414:             
415:             
416:             if (c == uint256(0)) return w;
417:             int256 t = w | 1;
418:             
419:             assembly { // <= FOUND
420:                 x := sdiv(mul(x, wad), t)
421:             }
422:             x = (t * (wad + lnWad(x)));
423:             
424:             assembly { // <= FOUND
425:                 w := sdiv(x, add(wad, t))
426:             }
427:         }
428:     }
```
['[437](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L437-L439)']
```solidity
437:     function fullMulDiv(uint256 x, uint256 y, uint256 d) internal pure returns (uint256 result) {
438:         
439:         assembly { // <= FOUND
440:             
441:             
442:             
443:             
444:             
445: 
446:             
447:             result := mul(x, y) 
448:             for {} 1 {} {
449:                 
450:                 if iszero(mul(or(iszero(x), eq(div(result, x), y)), d)) {
451:                     let mm := mulmod(x, y, not(0))
452:                     let p1 := sub(mm, add(result, lt(mm, result))) 
453: 
454:                     
455: 
456:                     
457:                     let r := mulmod(x, y, d) 
458:                     let t := and(d, sub(0, d)) 
459:                     
460:                     
461:                     if iszero(gt(d, p1)) {
462:                         mstore(0x00, 0xae47f702) 
463:                         revert(0x1c, 0x04)
464:                     }
465:                     d := div(d, t) 
466:                     
467:                     
468:                     
469:                     
470:                     
471:                     let inv := xor(2, mul(3, d))
472:                     
473:                     
474:                     
475:                     inv := mul(inv, sub(2, mul(d, inv))) 
476:                     inv := mul(inv, sub(2, mul(d, inv))) 
477:                     inv := mul(inv, sub(2, mul(d, inv))) 
478:                     inv := mul(inv, sub(2, mul(d, inv))) 
479:                     inv := mul(inv, sub(2, mul(d, inv))) 
480:                     result :=
481:                         mul(
482:                             
483:                             
484:                             
485:                             or(mul(sub(p1, gt(r, result)), add(div(sub(0, t), t), 1)), div(sub(result, r), t)),
486:                             mul(sub(2, mul(d, inv)), inv) 
487:                         )
488:                     break
489:                 }
490:                 result := div(result, d)
491:                 break
492:             }
493:         }
494:     }
```
['[499](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L499-L501)']
```solidity
499:     function fullMulDivUnchecked(uint256 x, uint256 y, uint256 d) internal pure returns (uint256 result) {
500:         
501:         assembly { // <= FOUND
502:             result := mul(x, y)
503:             let mm := mulmod(x, y, not(0))
504:             let p1 := sub(mm, add(result, lt(mm, result)))
505:             let t := and(d, sub(0, d))
506:             let r := mulmod(x, y, d)
507:             d := div(d, t)
508:             let inv := xor(2, mul(3, d))
509:             inv := mul(inv, sub(2, mul(d, inv)))
510:             inv := mul(inv, sub(2, mul(d, inv)))
511:             inv := mul(inv, sub(2, mul(d, inv)))
512:             inv := mul(inv, sub(2, mul(d, inv)))
513:             inv := mul(inv, sub(2, mul(d, inv)))
514:             result :=
515:                 mul(
516:                     or(mul(sub(p1, gt(r, result)), add(div(sub(0, t), t), 1)), div(sub(result, r), t)),
517:                     mul(sub(2, mul(d, inv)), inv)
518:                 )
519:         }
520:     }
```
['[526](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L526-L529)']
```solidity
526:     function fullMulDivUp(uint256 x, uint256 y, uint256 d) internal pure returns (uint256 result) {
527:         result = fullMulDiv(x, y, d);
528:         
529:         assembly { // <= FOUND
530:             if mulmod(x, y, d) {
531:                 result := add(result, 1)
532:                 if iszero(result) {
533:                     mstore(0x00, 0xae47f702) 
534:                     revert(0x1c, 0x04)
535:                 }
536:             }
537:         }
538:     }
```
['[542](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L542-L544)']
```solidity
542:     function mulDiv(uint256 x, uint256 y, uint256 d) internal pure returns (uint256 z) {
543:         
544:         assembly { // <= FOUND
545:             z := mul(x, y)
546:             
547:             if iszero(mul(or(iszero(x), eq(div(z, x), y)), d)) {
548:                 mstore(0x00, 0xad251c27) 
549:                 revert(0x1c, 0x04)
550:             }
551:             z := div(z, d)
552:         }
553:     }
```
['[557](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L557-L559)']
```solidity
557:     function mulDivUp(uint256 x, uint256 y, uint256 d) internal pure returns (uint256 z) {
558:         
559:         assembly { // <= FOUND
560:             z := mul(x, y)
561:             
562:             if iszero(mul(or(iszero(x), eq(div(z, x), y)), d)) {
563:                 mstore(0x00, 0xad251c27) 
564:                 revert(0x1c, 0x04)
565:             }
566:             z := add(iszero(iszero(mod(z, d))), div(z, d))
567:         }
568:     }
```
['[576](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L576-L578)']
```solidity
576:     function divUp(uint256 x, uint256 d) internal pure returns (uint256 z) {
577:         
578:         assembly { // <= FOUND
579:             if iszero(d) {
580:                 mstore(0x00, 0x65244e4e) 
581:                 revert(0x1c, 0x04)
582:             }
583:             z := add(iszero(iszero(mod(x, d))), div(x, d))
584:         }
585:     }
```
['[588](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L588-L590)']
```solidity
588:     function zeroFloorSub(uint256 x, uint256 y) internal pure returns (uint256 z) {
589:         
590:         assembly { // <= FOUND
591:             z := mul(gt(x, y), sub(x, y))
592:         }
593:     }
```
['[596](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L596-L598)']
```solidity
596:     function ternary(bool condition, uint256 x, uint256 y) internal pure returns (uint256 result) {
597:         
598:         assembly { // <= FOUND
599:             result := xor(x, mul(xor(x, y), iszero(condition)))
600:         }
601:     }
```
['[605](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L605-L607)']
```solidity
605:     function rpow(uint256 x, uint256 y, uint256 b) internal pure returns (uint256 z) {
606:         
607:         assembly { // <= FOUND
608:             z := mul(b, iszero(y)) 
609:             if x {
610:                 z := xor(b, mul(xor(b, x), and(y, 1))) 
611:                 let half := shr(1, b) 
612:                 
613:                 for { y := shr(1, y) } y { y := shr(1, y) } {
614:                     let xx := mul(x, x) 
615:                     let xxRound := add(xx, half) 
616:                     
617:                     if or(lt(xxRound, xx), shr(128, x)) {
618:                         mstore(0x00, 0x49f7642b) 
619:                         revert(0x1c, 0x04)
620:                     }
621:                     x := div(xxRound, b) 
622:                     
623:                     if and(y, 1) {
624:                         let zx := mul(z, x) 
625:                         let zxRound := add(zx, half) 
626:                         
627:                         if or(xor(div(zx, x), z), lt(zxRound, zx)) {
628:                             
629:                             if x {
630:                                 mstore(0x00, 0x49f7642b) 
631:                                 revert(0x1c, 0x04)
632:                             }
633:                         }
634:                         z := div(zxRound, b) 
635:                     }
636:                 }
637:             }
638:         }
639:     }
```
['[642](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L642-L644)']
```solidity
642:     function sqrt(uint256 x) internal pure returns (uint256 z) {
643:         
644:         assembly { // <= FOUND
645:             
646:             z := 181 
647: 
648:             
649:             
650: 
651:             
652:             
653:             let r := shl(7, lt(0xffffffffffffffffffffffffffffffffff, x))
654:             r := or(r, shl(6, lt(0xffffffffffffffffff, shr(r, x))))
655:             r := or(r, shl(5, lt(0xffffffffff, shr(r, x))))
656:             r := or(r, shl(4, lt(0xffffff, shr(r, x))))
657:             z := shl(shr(1, r), z)
658: 
659:             
660:             
661:             
662:             
663: 
664:             
665:             
666:             
667: 
668:             
669:             
670:             
671: 
672:             
673:             
674:             
675: 
676:             
677:             z := shr(18, mul(z, add(shr(r, x), 65536))) 
678: 
679:             
680:             z := shr(1, add(z, div(x, z)))
681:             z := shr(1, add(z, div(x, z)))
682:             z := shr(1, add(z, div(x, z)))
683:             z := shr(1, add(z, div(x, z)))
684:             z := shr(1, add(z, div(x, z)))
685:             z := shr(1, add(z, div(x, z)))
686:             z := shr(1, add(z, div(x, z)))
687: 
688:             
689:             
690:             
691:             z := sub(z, lt(div(x, z), z))
692:         }
693:     }
```
['[700](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L700-L702)']
```solidity
700:     function cbrt(uint256 x) internal pure returns (uint256 z) {
701:         
702:         assembly { // <= FOUND
703:             let r := shl(7, lt(0xffffffffffffffffffffffffffffffff, x))
704:             r := or(r, shl(6, lt(0xffffffffffffffff, shr(r, x))))
705:             r := or(r, shl(5, lt(0xffffffff, shr(r, x))))
706:             r := or(r, shl(4, lt(0xffff, shr(r, x))))
707:             r := or(r, shl(3, lt(0xff, shr(r, x))))
708:             
709:             z := div(shl(div(r, 3), shl(lt(0xf, shr(r, x)), 0xf)), xor(7, mod(r, 3)))
710:             
711:             z := div(add(add(div(x, mul(z, z)), z), z), 3)
712:             z := div(add(add(div(x, mul(z, z)), z), z), 3)
713:             z := div(add(add(div(x, mul(z, z)), z), z), 3)
714:             z := div(add(add(div(x, mul(z, z)), z), z), 3)
715:             z := div(add(add(div(x, mul(z, z)), z), z), 3)
716:             z := div(add(add(div(x, mul(z, z)), z), z), 3)
717:             z := div(add(add(div(x, mul(z, z)), z), z), 3)
718:             
719:             z := sub(z, lt(div(x, mul(z, z)), z))
720:         }
721:     }
```
['[724](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L724-L731)']
```solidity
724:     function sqrtWad(uint256 x) internal pure returns (uint256 z) {
725:         unchecked {
726:             if (x <= type(uint256).max / 10 ** 18) return sqrt(x * 10 ** 18);
727:             z = (1 + sqrt(x)) * 10 ** 9;
728:             z = (fullMulDivUnchecked(x, 10 ** 18, z) + z) >> 1;
729:         }
730:         
731:         assembly { // <= FOUND
732:             z := sub(z, gt(999999999999999999, sub(mulmod(z, z, x), 1))) 
733:         }
734:     }
```
['[739](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L739-L746)']
```solidity
739:     function cbrtWad(uint256 x) internal pure returns (uint256 z) {
740:         unchecked {
741:             if (x <= type(uint256).max / 10 ** 36) return cbrt(x * 10 ** 36);
742:             z = (1 + cbrt(x)) * 10 ** 12;
743:             z = (fullMulDivUnchecked(x, 10 ** 36, z * z) + z + z) / 3;
744:         }
745:         
746:         assembly { // <= FOUND
747:             let p := x
748:             for {} 1 {} {
749:                 if iszero(shr(229, p)) {
750:                     if iszero(shr(199, p)) {
751:                         p := mul(p, 100000000000000000) 
752:                         break
753:                     }
754:                     p := mul(p, 100000000) 
755:                     break
756:                 }
757:                 if iszero(shr(249, p)) { p := mul(p, 100) }
758:                 break
759:             }
760:             let t := mulmod(mul(z, z), z, p)
761:             z := sub(z, gt(lt(t, shr(1, p)), iszero(t))) 
762:         }
763:     }
```
['[766](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L766-L768)']
```solidity
766:     function factorial(uint256 x) internal pure returns (uint256 result) {
767:         
768:         assembly { // <= FOUND
769:             result := 1
770:             if iszero(lt(x, 58)) {
771:                 mstore(0x00, 0xaba0f2a2) 
772:                 revert(0x1c, 0x04)
773:             }
774:             for {} x { x := sub(x, 1) } { result := mul(result, x) }
775:         }
776:     }
```
['[781](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L781-L783)']
```solidity
781:     function log2(uint256 x) internal pure returns (uint256 r) {
782:         
783:         assembly { // <= FOUND
784:             r := shl(7, lt(0xffffffffffffffffffffffffffffffff, x))
785:             r := or(r, shl(6, lt(0xffffffffffffffff, shr(r, x))))
786:             r := or(r, shl(5, lt(0xffffffff, shr(r, x))))
787:             r := or(r, shl(4, lt(0xffff, shr(r, x))))
788:             r := or(r, shl(3, lt(0xff, shr(r, x))))
789:             
790:             r := or(r, byte(and(0x1f, shr(shr(r, x), 0x8421084210842108cc6318c6db6d54be)),
791:                 0x0706060506020504060203020504030106050205030304010505030400000000))
792:         }
793:     }
```
['[797](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L797-L800)']
```solidity
797:     function log2Up(uint256 x) internal pure returns (uint256 r) {
798:         r = log2(x);
799:         
800:         assembly { // <= FOUND
801:             r := add(r, lt(shl(r, 1), x))
802:         }
803:     }
```
['[807](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L807-L809)']
```solidity
807:     function log10(uint256 x) internal pure returns (uint256 r) {
808:         
809:         assembly { // <= FOUND
810:             if iszero(lt(x, 100000000000000000000000000000000000000)) {
811:                 x := div(x, 100000000000000000000000000000000000000)
812:                 r := 38
813:             }
814:             if iszero(lt(x, 100000000000000000000)) {
815:                 x := div(x, 100000000000000000000)
816:                 r := add(r, 20)
817:             }
818:             if iszero(lt(x, 10000000000)) {
819:                 x := div(x, 10000000000)
820:                 r := add(r, 10)
821:             }
822:             if iszero(lt(x, 100000)) {
823:                 x := div(x, 100000)
824:                 r := add(r, 5)
825:             }
826:             r := add(r, add(gt(x, 9), add(gt(x, 99), add(gt(x, 999), gt(x, 9999)))))
827:         }
828:     }
```
['[832](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L832-L835)']
```solidity
832:     function log10Up(uint256 x) internal pure returns (uint256 r) {
833:         r = log10(x);
834:         
835:         assembly { // <= FOUND
836:             r := add(r, lt(exp(10, r), x))
837:         }
838:     }
```
['[842](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L842-L844)']
```solidity
842:     function log256(uint256 x) internal pure returns (uint256 r) {
843:         
844:         assembly { // <= FOUND
845:             r := shl(7, lt(0xffffffffffffffffffffffffffffffff, x))
846:             r := or(r, shl(6, lt(0xffffffffffffffff, shr(r, x))))
847:             r := or(r, shl(5, lt(0xffffffff, shr(r, x))))
848:             r := or(r, shl(4, lt(0xffff, shr(r, x))))
849:             r := or(shr(3, r), lt(0xff, shr(r, x)))
850:         }
851:     }
```
['[855](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L855-L858)']
```solidity
855:     function log256Up(uint256 x) internal pure returns (uint256 r) {
856:         r = log256(x);
857:         
858:         assembly { // <= FOUND
859:             r := add(r, lt(shl(shl(3, r), 1), x))
860:         }
861:     }
```
['[865](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L865-L867)']
```solidity
865:     function sci(uint256 x) internal pure returns (uint256 mantissa, uint256 exponent) {
866:         
867:         assembly { // <= FOUND
868:             mantissa := x
869:             if mantissa {
870:                 if iszero(mod(mantissa, 1000000000000000000000000000000000)) {
871:                     mantissa := div(mantissa, 1000000000000000000000000000000000)
872:                     exponent := 33
873:                 }
874:                 if iszero(mod(mantissa, 10000000000000000000)) {
875:                     mantissa := div(mantissa, 10000000000000000000)
876:                     exponent := add(exponent, 19)
877:                 }
878:                 if iszero(mod(mantissa, 1000000000000)) {
879:                     mantissa := div(mantissa, 1000000000000)
880:                     exponent := add(exponent, 12)
881:                 }
882:                 if iszero(mod(mantissa, 1000000)) {
883:                     mantissa := div(mantissa, 1000000)
884:                     exponent := add(exponent, 6)
885:                 }
886:                 if iszero(mod(mantissa, 10000)) {
887:                     mantissa := div(mantissa, 10000)
888:                     exponent := add(exponent, 4)
889:                 }
890:                 if iszero(mod(mantissa, 100)) {
891:                     mantissa := div(mantissa, 100)
892:                     exponent := add(exponent, 2)
893:                 }
894:                 if iszero(mod(mantissa, 10)) {
895:                     mantissa := div(mantissa, 10)
896:                     exponent := add(exponent, 1)
897:                 }
898:             }
899:         }
900:     }
```
['[910](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L910-L913)']
```solidity
910:     function packSci(uint256 x) internal pure returns (uint256 packed) {
911:         (x, packed) = sci(x); 
912:         
913:         assembly { // <= FOUND
914:             if shr(249, x) {
915:                 mstore(0x00, 0xce30380c) 
916:                 revert(0x1c, 0x04)
917:             }
918:             packed := or(shl(7, x), packed)
919:         }
920:     }
```
['[944](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L944-L946)']
```solidity
944:     function abs(int256 x) internal pure returns (uint256 z) {
945:         
946:         assembly { // <= FOUND
947:             z := xor(sar(255, x), add(sar(255, x), x))
948:         }
949:     }
```
['[952](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L952-L954)']
```solidity
952:     function dist(uint256 x, uint256 y) internal pure returns (uint256 z) {
953:         
954:         assembly { // <= FOUND
955:             z := xor(mul(xor(sub(y, x), sub(x, y)), gt(x, y)), sub(y, x))
956:         }
957:     }
```
['[960](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L960-L962)']
```solidity
960:     function dist(int256 x, int256 y) internal pure returns (uint256 z) {
961:         
962:         assembly { // <= FOUND
963:             z := xor(mul(xor(sub(y, x), sub(x, y)), sgt(x, y)), sub(y, x))
964:         }
965:     }
```
['[968](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L968-L970)']
```solidity
968:     function min(uint256 x, uint256 y) internal pure returns (uint256 z) {
969:         
970:         assembly { // <= FOUND
971:             z := xor(x, mul(xor(x, y), lt(y, x)))
972:         }
973:     }
```
['[976](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L976-L978)']
```solidity
976:     function min(int256 x, int256 y) internal pure returns (int256 z) {
977:         
978:         assembly { // <= FOUND
979:             z := xor(x, mul(xor(x, y), slt(y, x)))
980:         }
981:     }
```
['[984](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L984-L986)']
```solidity
984:     function max(uint256 x, uint256 y) internal pure returns (uint256 z) {
985:         
986:         assembly { // <= FOUND
987:             z := xor(x, mul(xor(x, y), gt(y, x)))
988:         }
989:     }
```
['[992](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L992-L994)']
```solidity
992:     function max(int256 x, int256 y) internal pure returns (int256 z) {
993:         
994:         assembly { // <= FOUND
995:             z := xor(x, mul(xor(x, y), sgt(y, x)))
996:         }
997:     }
```
['[1000](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L1000-L1002)']
```solidity
1000:     function clamp(uint256 x, uint256 minValue, uint256 maxValue) internal pure returns (uint256 z) {
1001:         
1002:         assembly { // <= FOUND
1003:             z := xor(x, mul(xor(x, minValue), gt(minValue, x)))
1004:             z := xor(z, mul(xor(z, maxValue), lt(maxValue, z)))
1005:         }
1006:     }
```
['[1009](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L1009-L1011)']
```solidity
1009:     function clamp(int256 x, int256 minValue, int256 maxValue) internal pure returns (int256 z) {
1010:         
1011:         assembly { // <= FOUND
1012:             z := xor(x, mul(xor(x, minValue), sgt(minValue, x)))
1013:             z := xor(z, mul(xor(z, maxValue), slt(maxValue, z)))
1014:         }
1015:     }
```
['[1018](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L1018-L1020)']
```solidity
1018:     function gcd(uint256 x, uint256 y) internal pure returns (uint256 z) {
1019:         
1020:         assembly { // <= FOUND
1021:             for { z := x } y {} {
1022:                 let t := y
1023:                 y := mod(z, y)
1024:                 z := t
1025:             }
1026:         }
1027:     }
```
[]
```solidity
1033:     function lerp(uint256 a, uint256 b, uint256 t, uint256 begin, uint256 end) internal pure returns (uint256) {
1034:         if (begin > end) {
1035:             t = ~t;
1036:             begin = ~begin;
1037:             end = ~end;
1038:         }
1039:         if (t <= begin) return a;
1040:         if (t >= end) return b;
1041:         unchecked {
1042:             if (b >= a) return a + fullMulDiv(b - a, t - begin, end - begin);
1043:             return a - fullMulDiv(a - b, t - begin, end - begin);
1044:         }
1045:     }
```
[]
```solidity
1051:     function lerp(int256 a, int256 b, int256 t, int256 begin, int256 end) internal pure returns (int256) {
1052:         if (begin > end) {
1053:             t = int256(~uint256(t));
1054:             begin = int256(~uint256(begin));
1055:             end = int256(~uint256(end));
1056:         }
1057:         if (t <= begin) return a;
1058:         if (t >= end) return b;
1059:         
1060:         unchecked {
1061:             if (b >= a) return int256(uint256(a) + fullMulDiv(uint256(b) - uint256(a),
1062:                 uint256(t) - uint256(begin), uint256(end) - uint256(begin)));
1063:             return int256(uint256(a) - fullMulDiv(uint256(a) - uint256(b),
1064:                 uint256(t) - uint256(begin), uint256(end) - uint256(begin)));
1065:         }
1066:     }
```
['[1115](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L1115-L1117)']
```solidity
1115:     function rawDiv(uint256 x, uint256 y) internal pure returns (uint256 z) {
1116:         
1117:         assembly { // <= FOUND
1118:             z := div(x, y)
1119:         }
1120:     }
```
['[1123](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L1123-L1125)']
```solidity
1123:     function rawSDiv(int256 x, int256 y) internal pure returns (int256 z) {
1124:         
1125:         assembly { // <= FOUND
1126:             z := sdiv(x, y)
1127:         }
1128:     }
```
['[1131](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L1131-L1133)']
```solidity
1131:     function rawMod(uint256 x, uint256 y) internal pure returns (uint256 z) {
1132:         
1133:         assembly { // <= FOUND
1134:             z := mod(x, y)
1135:         }
1136:     }
```
['[1139](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L1139-L1141)']
```solidity
1139:     function rawSMod(int256 x, int256 y) internal pure returns (int256 z) {
1140:         
1141:         assembly { // <= FOUND
1142:             z := smod(x, y)
1143:         }
1144:     }
```
['[1147](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L1147-L1149)']
```solidity
1147:     function rawAddMod(uint256 x, uint256 y, uint256 d) internal pure returns (uint256 z) {
1148:         
1149:         assembly { // <= FOUND
1150:             z := addmod(x, y, d)
1151:         }
1152:     }
```
['[1155](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L1155-L1157)']
```solidity
1155:     function rawMulMod(uint256 x, uint256 y, uint256 d) internal pure returns (uint256 z) {
1156:         
1157:         assembly { // <= FOUND
1158:             z := mulmod(x, y, d)
1159:         }
1160:     }
```
[]
```solidity
260:     function _closestBitRight(bytes32 leaves, uint8 bit) private pure returns (uint256) {
261:         unchecked {
262:             return uint256(leaves).closestBitRight(bit - 1);
263:         }
264:     }
```
[]
```solidity
273:     function _closestBitLeft(bytes32 leaves, uint8 bit) private pure returns (uint256) {
274:         unchecked {
275:             return uint256(leaves).closestBitLeft(bit + 1);
276:         }
277:     }
```


</details>

## [NonCritical-69] It is best practise to initialize a local variable when they are defined

Num of instances: 16

### Findings 


<details><summary>Click to show findings</summary>

['[124](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/AbstractAMM.sol#L124-L134)']
```solidity
124:     function _fillVaultForBuy(uint256 _breakPoint, uint96 _size)
125:         internal
126:         returns (uint96 sizeLeft, uint96 fundsConsumed, bytes memory makerCredits)
127:     {
128:         uint256 _price = vaultBestAsk;
129:         sizeLeft = _size;
130: 
131:         uint96 _cachedLastVaultSize = vaultAskOrderSize;
132:         uint96 _cachedPartiallyFilledBid = bidPartiallyFilledSize;
133:         
134:         uint256 _consumedQuote; // <= FOUND
135:         uint96 _availableSize = _cachedLastVaultSize - askPartiallyFilledSize;
136:         if (_availableSize <= sizeLeft) {
137:             askPartiallyFilledSize = 0;
138:         }
139:         while (_price < _breakPoint && sizeLeft > 0) {
140:             if (_availableSize > sizeLeft) {
141:                 askPartiallyFilledSize += sizeLeft;
142:                 _consumedQuote += FixedPointMathLib.mulDivUp(sizeLeft, _price, _getSizePrecision());
143:                 _emitTrade(0, kuruAmmVault, true, _price, _availableSize - sizeLeft, sizeLeft);
144:                 sizeLeft = 0;
145:                 break;
146:             } else {
147:                 sizeLeft -= _availableSize;
148:                 _consumedQuote += FixedPointMathLib.mulDivUp(_availableSize, _price, _getSizePrecision());
149:                 _cachedLastVaultSize = toU96(
150:                     FixedPointMathLib.mulDiv(
151:                         _cachedLastVaultSize, DOUBLE_BPS_MULTIPLIER, DOUBLE_BPS_MULTIPLIER + SPREAD_CONSTANT
152:                     )
153:                 );
154:                 _emitTrade(0, kuruAmmVault, true, _price, 0, _availableSize);
155:                 _availableSize = _cachedLastVaultSize;
156:                 _price = FixedPointMathLib.mulDivRound(_price, BPS_MULTIPLIER + SPREAD_CONSTANT, BPS_MULTIPLIER);
157:                 _cachedPartiallyFilledBid = toU96(
158:                     FixedPointMathLib.mulDiv(
159:                         _cachedPartiallyFilledBid, BPS_MULTIPLIER, BPS_MULTIPLIER + SPREAD_CONSTANT
160:                     )
161:                 );
162:             }
163:         }
164:         if (_price != vaultBestAsk) {
165:             vaultBestAsk = _price;
166:             vaultBestBid = FixedPointMathLib.mulDivRound(_price, BPS_MULTIPLIER, BPS_MULTIPLIER + SPREAD_CONSTANT);
167:             vaultAskOrderSize = _cachedLastVaultSize;
168:             vaultBidOrderSize = toU96(
169:                 FixedPointMathLib.mulDiv(
170:                     _cachedLastVaultSize, DOUBLE_BPS_MULTIPLIER + SPREAD_CONSTANT, DOUBLE_BPS_MULTIPLIER
171:                 )
172:             );
173:         }
174:         bidPartiallyFilledSize = _cachedPartiallyFilledBid;
175:         fundsConsumed = toU96(FixedPointMathLib.mulDivUp(_consumedQuote, _getPricePrecision(), vaultPricePrecision));
176:         makerCredits = _creditVaultOnMarketBuy(_size - sizeLeft, _consumedQuote);
177:     }
```
['[45](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L45-L68)']
```solidity
45:     function initialize(
46:         address _owner,
47:         address token1_,
48:         address token2_,
49:         address _marginAccount,
50:         address _market,
51:         uint96 _spreadConstant
52:     ) public initializer {
53:         owner = _owner;
54:         token1 = token1_;
55:         token1Decimals = token1_ != address(0) ? ERC20(token1_).decimals() : 18;
56:         token2 = token2_;
57:         token2Decimals = token2_ != address(0) ? ERC20(token2_).decimals() : 18;
58:         marginAccount = IMarginAccount(_marginAccount);
59:         market = IOrderBook(_market);
60:         SPREAD_CONSTANT = _spreadConstant;
61:         setMarketParams();
62:         if (token1_ != address(0)) {
63:             token1_.safeApprove(_marginAccount, type(uint256).max);
64:         }
65:         if (token2_ != address(0)) {
66:             token2_.safeApprove(_marginAccount, type(uint256).max);
67:         }
68:         string memory token1Symbol; // <= FOUND
69:         string memory token2Symbol;
70:         if (token1_ != address(0)) {
71:             token1Symbol = ERC20(token1_).symbol();
72:         } else {
73:             token1Symbol = "MON";
74:         }
75:         if (token2_ != address(0)) {
76:             token2Symbol = ERC20(token2_).symbol();
77:         } else {
78:             token2Symbol = "MON";
79:         }
80:         _name = string.concat(token1Symbol, "-", token2Symbol, "-", "KURU-AMM-VAULT");
81:     }
```
['[175](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L175-L217)']
```solidity
175:     function _mintAndDeposit(uint256 baseDeposit, uint256 quoteDeposit, address receiver) internal returns (uint256) {
176:         (uint256 _baseAmount, uint256 _currentAskPrice) = _returnNormalizedAmountAndPrice(true);
177:         uint256 _shares; // <= FOUND
178:         if (totalSupply() != 0) {
179:             uint256 _expectedQuoteAmount = (
180:                 (
181:                     FixedPointMathLib.mulDivUp(baseDeposit, _currentAskPrice, vaultPricePrecision)
182:                         * 10 ** marketParams.quoteAssetDecimals
183:                 )
184:             ) / 10 ** marketParams.baseAssetDecimals;
185:             require(_expectedQuoteAmount <= quoteDeposit, KuruAMMVaultErrors.InsufficientQuoteToken());
186:             _shares = _convertToShares(baseDeposit, _expectedQuoteAmount, _currentAskPrice);
187:             quoteDeposit = _expectedQuoteAmount;
188:             _mint(receiver, _shares);
189:         } else {
190:             _shares = FixedPointMathLib.sqrt(baseDeposit * quoteDeposit);
191:             _mint(address(marginAccount), MIN_LIQUIDITY);
192:             _shares -= MIN_LIQUIDITY;
193:             _mint(receiver, _shares);
194:             _currentAskPrice = (
195:                 ((quoteDeposit * 10 ** marketParams.baseAssetDecimals)) * vaultPricePrecision
196:                     / 10 ** marketParams.quoteAssetDecimals
197:             ) / (baseDeposit);
198:         }
199:         require(_shares > 0, KuruAMMVaultErrors.InsufficientLiquidityMinted());
200:         (uint96 _newAskSize, uint96 _newBidSize) = _getVaultSizesForBaseAmount(_baseAmount + baseDeposit);
201:         market.updateVaultOrdSz(
202:             _newAskSize,
203:             _newBidSize,
204:             _currentAskPrice,
205:             FixedPointMathLib.mulDivRound(_currentAskPrice, BPS_MULTIPLIER, BPS_MULTIPLIER + SPREAD_CONSTANT),
206:             false
207:         );
208:         address _token1 = token1;
209:         address _token2 = token2;
210:         _depositAmountsToMarginAccount(_token1, _token2, baseDeposit, quoteDeposit);
211:         uint256 _nativeRefund =
212:             _token1 == address(0) ? (msg.value - baseDeposit) : (_token2 == address(0) ? (msg.value - quoteDeposit) : 0);
213:         if (_nativeRefund > 0) {
214:             msg.sender.safeTransferETH(_nativeRefund);
215:         }
216:         emit KuruVaultDeposit(baseDeposit, quoteDeposit, _shares, receiver);
217:         return _shares; // <= FOUND
218:     }
```
['[376](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L376-L403)']
```solidity
376:     function _convertToAssetsWithNewSize(uint256 shares)
377:         internal
378:         view
379:         returns (uint256, uint256, uint96, uint96, bool)
380:     {
381:         (uint256 _baseAmount,) = _returnNormalizedAmountAndPrice(false);
382:         uint256 _baseAmountAfterRemoval = _baseAmount - FixedPointMathLib.mulDiv(shares, _baseAmount, totalSupply());
383:         (uint96 _newAskSize, uint96 _newBidSize) = _getVaultSizesForBaseAmount(_baseAmountAfterRemoval);
384:         (
385:             ,
386:             uint256 _vaultBestBid,
387:             uint96 _partiallyFilledBidSize,
388:             uint256 _vaultBestAsk,
389:             uint96 _partiallyFilledAskSize,
390:             ,
391:             ,
392:         ) = market.getVaultParams();
393:         MarketParams memory _marketParams = marketParams;
394:         (uint256 _reserveBase, uint256 _reserveQuote) = totalAssets();
395:         if (_partiallyFilledAskSize > _newAskSize || _partiallyFilledBidSize > _newBidSize) {
396:             int256 _baseOwedToVault = (
397:                 int256(uint256(_partiallyFilledAskSize)) - int256(uint256(_partiallyFilledBidSize))
398:             ) * int256(10 ** _marketParams.baseAssetDecimals) / int256(uint256(_marketParams.sizePrecision));
399:             int256 _quoteOwedToVault = (
400:                 int256(FixedPointMathLib.mulDivUp(_partiallyFilledBidSize, _vaultBestBid, _marketParams.sizePrecision))
401:                     - int256(FixedPointMathLib.mulDiv(_partiallyFilledAskSize, _vaultBestAsk, _marketParams.sizePrecision))
402:             ) * int256(10 ** _marketParams.quoteAssetDecimals) / int256(vaultPricePrecision);
403:             uint256 _baseOwedToUser; // <= FOUND
404:             uint256 _quoteOwedToUser;
405:             if (_baseOwedToVault < 0) {
406:                 _reserveBase = _reserveBase - (uint256(-1 * _baseOwedToVault));
407:                 _baseOwedToUser =
408:                     FixedPointMathLib.mulDiv(shares, _reserveBase, totalSupply()) + uint256(-1 * _baseOwedToVault);
409:             } else {
410:                 _reserveBase = _reserveBase + (uint256(_baseOwedToVault));
411:                 _baseOwedToUser =
412:                     FixedPointMathLib.mulDiv(shares, _reserveBase, totalSupply()) - uint256(_baseOwedToVault);
413:             }
414:             if (_quoteOwedToVault < 0) {
415:                 _reserveQuote = _reserveQuote - (uint256(-1 * _quoteOwedToVault));
416:                 _quoteOwedToUser =
417:                     FixedPointMathLib.mulDiv(shares, _reserveQuote, totalSupply()) + uint256(-1 * _quoteOwedToVault);
418:             } else {
419:                 _reserveQuote = _reserveQuote + (uint256(_quoteOwedToVault));
420:                 _quoteOwedToUser =
421:                     FixedPointMathLib.mulDiv(shares, _reserveQuote, totalSupply()) - uint256(_quoteOwedToVault);
422:             }
423:             return (_baseOwedToUser, _quoteOwedToUser, _newAskSize, _newBidSize, true);
424:         } else {
425:             uint256 _baseOwedToUser = FixedPointMathLib.mulDiv(shares, _reserveBase, totalSupply());
426:             uint256 _quoteOwedToUser = FixedPointMathLib.mulDiv(shares, _reserveQuote, totalSupply());
427:             return (_baseOwedToUser, _quoteOwedToUser, _newAskSize, _newBidSize, false);
428:         }
429:     }
```
['[346](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L346-L346)']
```solidity
346:     function lambertW0Wad(int256 x) internal pure returns (int256 w) {
347:         
348:         unchecked {
349:             if ((w = x) <= -367879441171442322) revert OutOfDomain(); 
350:             int256 wad = int256(WAD);
351:             int256 p = x;
352:             uint256 c; 
353:             uint256 i = 4; 
354:             if (w <= 0x1ffffffffffff) {
355:                 if (-0x4000000000000 <= w) {
356:                     i = 1; 
357:                 } else if (w <= -0x3ffffffffffffff) {
358:                     i = 32; 
359:                 }
360:             } else if (uint256(w >> 63) == uint256(0)) {
361:                 
362:                 assembly {
363:                     
364:                     let v := shr(49, w)
365:                     let l := shl(3, lt(0xff, v))
366:                     l := add(or(l, byte(and(0x1f, shr(shr(l, v), 0x8421084210842108cc6318c6db6d54be)),
367:                         0x0706060506020504060203020504030106050205030304010505030400000000)), 49)
368:                     w := sdiv(shl(l, 7), byte(sub(l, 31), 0x0303030303030303040506080c13))
369:                     c := gt(l, 60)
370:                     i := add(2, add(gt(l, 53), c))
371:                 }
372:             } else {
373:                 int256 ll = lnWad(w = lnWad(w));
374:                 
375:                 assembly {
376:                     
377:                     w := add(sdiv(mul(ll, 1023715080943847266), w), sub(w, ll))
378:                     i := add(3, iszero(shr(68, x)))
379:                     c := iszero(shr(143, x))
380:                 }
381:                 if (c == uint256(0)) {
382:                     do { 
383:                         int256 e = expWad(w);
384:                         
385:                         assembly {
386:                             let t := mul(w, div(e, wad))
387:                             w := sub(w, sdiv(sub(t, x), div(add(e, t), wad)))
388:                         }
389:                         if (p <= w) break;
390:                         p = w;
391:                     } while (--i != uint256(0));
392:                     
393:                     assembly {
394:                         w := sub(w, sgt(w, 2))
395:                     }
396:                     return w;
397:                 }
398:             }
399:             do { 
400:                 int256 e = expWad(w);
401:                 
402:                 assembly {
403:                     let t := add(w, wad)
404:                     let s := sub(mul(w, e), mul(x, wad))
405:                     w := sub(w, sdiv(mul(s, wad), sub(mul(e, t), sdiv(mul(add(t, wad), s), add(t, t)))))
406:                 }
407:                 if (p <= w) break;
408:                 p = w;
409:             } while (--i != c);
410:             
411:             assembly {
412:                 w := sub(w, sgt(w, 2))
413:             }
414:             
415:             
416:             if (c == uint256(0)) return w;
417:             int256 t = w | 1;
418:             
419:             assembly {
420:                 x := sdiv(mul(x, wad), t)
421:             }
422:             x = (t * (wad + lnWad(x)));
423:             
424:             assembly {
425:                 w := sdiv(x, add(wad, t))
426:             }
427:         }
428:     }
```
['[108](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/TreeMath.sol#L108-L109)']
```solidity
108:     function findFirstRight(TreeUint32 storage tree, uint32 id) internal view returns (uint32) {
109:         bytes32 leaves; // <= FOUND
110: 
111:         bytes32 key3 = bytes32(uint256(id) >> 8);
112:         uint8 bit = uint8(id & type(uint8).max);
113: 
114:         if (bit != 0) {
115:             leaves = tree.level3[key3];
116:             uint256 closestBit = _closestBitRight(leaves, bit);
117: 
118:             if (closestBit != type(uint256).max) return uint32((uint256(key3) << 8) | closestBit);
119:         }
120: 
121:         bytes32 key2 = key3 >> 8;
122:         bit = uint8(uint256(key3) & type(uint8).max);
123: 
124:         if (bit != 0) {
125:             leaves = tree.level2[key2];
126:             uint256 closestBit = _closestBitRight(leaves, bit);
127: 
128:             if (closestBit != type(uint256).max) {
129:                 key3 = bytes32((uint256(key2) << 8) | closestBit);
130:                 leaves = tree.level3[key3];
131: 
132:                 return uint32((uint256(key3) << 8) | uint256(leaves).mostSignificantBit());
133:             }
134:         }
135: 
136:         bytes32 key1 = key2 >> 8;
137:         bit = uint8(uint256(key2) & type(uint8).max);
138: 
139:         if (bit != 0) {
140:             leaves = tree.level1[key1];
141:             uint256 closestBit = _closestBitRight(leaves, bit);
142: 
143:             if (closestBit != type(uint256).max) {
144:                 key2 = bytes32((uint256(key1) << 8) | closestBit);
145:                 leaves = tree.level2[key2];
146: 
147:                 key3 = bytes32((uint256(key2) << 8) | uint256(leaves).mostSignificantBit());
148:                 leaves = tree.level3[key3];
149: 
150:                 return uint32((uint256(key3) << 8) | uint256(leaves).mostSignificantBit());
151:             }
152:         }
153: 
154:         bit = uint8(uint256(key1) & type(uint8).max);
155: 
156:         if (bit != 0) {
157:             leaves = tree.level0;
158:             uint256 closestBit = _closestBitRight(leaves, bit);
159: 
160:             if (closestBit != type(uint256).max) {
161:                 key1 = bytes32(closestBit);
162:                 leaves = tree.level1[key1];
163: 
164:                 key2 = bytes32((uint256(key1) << 8) | uint256(leaves).mostSignificantBit());
165:                 leaves = tree.level2[key2];
166: 
167:                 key3 = bytes32((uint256(key2) << 8) | uint256(leaves).mostSignificantBit());
168:                 leaves = tree.level3[key3];
169: 
170:                 return uint32((uint256(key3) << 8) | uint256(leaves).mostSignificantBit());
171:             }
172:         }
173: 
174:         return type(uint32).max;
175:     }
```
['[184](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/TreeMath.sol#L184-L185)']
```solidity
184:     function findFirstLeft(TreeUint32 storage tree, uint32 id) internal view returns (uint32) {
185:         bytes32 leaves; // <= FOUND
186: 
187:         bytes32 key3 = bytes32(uint256(id) >> 8);
188:         uint8 bit = uint8(id & type(uint8).max);
189: 
190:         if (bit != type(uint8).max) {
191:             leaves = tree.level3[key3];
192:             uint256 closestBit = _closestBitLeft(leaves, bit);
193: 
194:             if (closestBit != type(uint256).max) return uint32((uint256(key3) << 8) | closestBit);
195:         }
196: 
197:         bytes32 key2 = key3 >> 8;
198:         bit = uint8(uint256(key3) & type(uint8).max);
199: 
200:         if (bit != type(uint8).max) {
201:             leaves = tree.level2[key2];
202:             uint256 closestBit = _closestBitLeft(leaves, bit);
203: 
204:             if (closestBit != type(uint256).max) {
205:                 key3 = bytes32((uint256(key2) << 8) | closestBit);
206:                 leaves = tree.level3[key3];
207: 
208:                 return uint32((uint256(key3) << 8) | uint256(leaves).leastSignificantBit());
209:             }
210:         }
211: 
212:         bytes32 key1 = key2 >> 8;
213:         bit = uint8(uint256(key2) & type(uint8).max);
214: 
215:         if (bit != type(uint8).max) {
216:             leaves = tree.level1[key1];
217:             uint256 closestBit = _closestBitLeft(leaves, bit);
218: 
219:             if (closestBit != type(uint256).max) {
220:                 key2 = bytes32((uint256(key1) << 8) | closestBit);
221:                 leaves = tree.level2[key2];
222: 
223:                 key3 = bytes32((uint256(key2) << 8) | uint256(leaves).leastSignificantBit());
224:                 leaves = tree.level3[key3];
225: 
226:                 return uint32((uint256(key3) << 8) | uint256(leaves).leastSignificantBit());
227:             }
228:         }
229: 
230:         bit = uint8(uint256(key1) & type(uint8).max);
231: 
232:         if (bit != type(uint8).max) {
233:             leaves = tree.level0;
234:             uint256 closestBit = _closestBitLeft(leaves, bit);
235: 
236:             if (closestBit != type(uint256).max) {
237:                 key1 = bytes32(closestBit);
238:                 leaves = tree.level1[key1];
239: 
240:                 key2 = bytes32((uint256(key1) << 8) | uint256(leaves).leastSignificantBit());
241:                 leaves = tree.level2[key2];
242: 
243:                 key3 = bytes32((uint256(key2) << 8) | uint256(leaves).leastSignificantBit());
244:                 leaves = tree.level3[key3];
245: 
246:                 return uint32((uint256(key3) << 8) | uint256(leaves).leastSignificantBit());
247:             }
248:         }
249: 
250:         return 0;
251:     }
```
['[177](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L177-L178)']
```solidity
177:     function batchWithdrawMaxTokens(address[] calldata _tokens) external protocolActive {
178:         uint256 _balance; // <= FOUND
179:         for (uint256 i = 0; i < _tokens.length; i++) {
180:             _balance = balances[_accountKey(_msgSender(), _tokens[i])];
181:             balances[_accountKey(_msgSender(), _tokens[i])] = 0;
182:             if (_balance > 0) {
183:                 if (_tokens[i] == NATIVE) {
184:                     _msgSender().safeTransferETH(_balance);
185:                 } else {
186:                     _tokens[i].safeTransfer(_msgSender(), _balance);
187:                 }
188:             }
189:         }
190:     }
```
['[728](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L728-L775)']
```solidity
728:     function placeAndExecuteMarketBuy(uint96 _quoteSize, uint256 _minAmountOut, bool _isMargin, bool _isFillOrKill)
729:         public
730:         payable
731:         override
732:         marketActive
733:         nonReentrant
734:         returns (uint256)
735:     {
736:         OrderBookType _type = orderBookType;
737: 
738:         if (_type == OrderBookType.NATIVE_IN_QUOTE && !_isMargin && (msg.sender != address(0))) {
739:             require(
740:                 msg.value >= _pricePrecisionToQuoteAssetPrecision(_quoteSize), OrderBookErrors.NativeAssetInsufficient()
741:             );
742:             require(
743:                 msg.value < _pricePrecisionToQuoteAssetPrecision(_quoteSize + 1), OrderBookErrors.NativeAssetSurplus()
744:             );
745:         } else if (msg.sender != address(0)) {
746:             require(msg.value == 0, OrderBookErrors.NativeAssetNotRequired());
747:             _isMargin
748:                 ? marginAccount.debitUser(_msgSender(), quoteAsset, _pricePrecisionToQuoteAssetPrecision(_quoteSize))
749:                 : quoteAsset.safeTransferFrom(
750:                     _msgSender(), address(marginAccount), _pricePrecisionToQuoteAssetPrecision(_quoteSize)
751:                 );
752:         }
753: 
754:         uint256 _baseTokensCredited; // <= FOUND
755:         (_quoteSize, _baseTokensCredited) = _marketBuyMatch(_quoteSize, _isMargin);
756:         if (msg.sender == address(0)) {
757:             return _baseTokensCredited; // <= FOUND
758:         }
759:         if (_quoteSize > 0) {
760:             require(!_isFillOrKill, OrderBookErrors.InsufficientLiquidity());
761:             if (_type == OrderBookType.NATIVE_IN_QUOTE && !_isMargin) {
762:                 
763:                 uint256 _refund = _pricePrecisionToQuoteAssetPrecision(_quoteSize);
764:                 _handleNativeMarketRefundTransfer(_refund);
765:             } else {
766:                 marginAccount.creditUser(
767:                     _msgSender(), quoteAsset, _pricePrecisionToQuoteAssetPrecision(_quoteSize), _isMargin
768:                 );
769:             }
770:         } else if (_type == OrderBookType.NATIVE_IN_QUOTE) {
771:             address(marginAccount).safeTransferETH(msg.value);
772:         }
773:         require(_baseTokensCredited >= _minAmountOut, OrderBookErrors.SlippageExceeded());
774: 
775:         return _baseTokensCredited; // <= FOUND
776:     }
```
['[786](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L786-L823)']
```solidity
786:     function placeAndExecuteMarketSell(uint96 _size, uint256 _minAmountOut, bool _isMargin, bool _isFillOrKill)
787:         public
788:         payable
789:         marketActive
790:         nonReentrant
791:         returns (uint256)
792:     {
793:         OrderBookType _type = orderBookType;
794:         if (_type == OrderBookType.NATIVE_IN_BASE && !_isMargin && (msg.sender != address(0))) {
795:             require(msg.value >= _sizePrecisionToBaseAssetPrecision(_size), OrderBookErrors.NativeAssetInsufficient());
796:             require(msg.value < _sizePrecisionToBaseAssetPrecision(_size + 1), OrderBookErrors.NativeAssetSurplus());
797:         } else if (msg.sender != address(0)) {
798:             require(msg.value == 0, OrderBookErrors.NativeAssetNotRequired());
799:             _isMargin
800:                 ? marginAccount.debitUser(_msgSender(), baseAsset, _sizePrecisionToBaseAssetPrecision(_size))
801:                 : baseAsset.safeTransferFrom(
802:                     _msgSender(), address(marginAccount), _sizePrecisionToBaseAssetPrecision(_size)
803:                 );
804:         }
805: 
806:         uint256 _quoteCredited; // <= FOUND
807:         (_size, _quoteCredited) = _matchAggressiveSell(0, _size, _isMargin);
808:         if (msg.sender == address(0)) {
809:             return _quoteCredited; // <= FOUND
810:         }
811:         if (_size > 0) {
812:             require(!_isFillOrKill, OrderBookErrors.InsufficientLiquidity());
813:             if (_type == OrderBookType.NATIVE_IN_BASE && !_isMargin) {
814:                 uint256 _refund = _sizePrecisionToBaseAssetPrecision(_size);
815:                 _handleNativeMarketRefundTransfer(_refund);
816:             } else {
817:                 marginAccount.creditUser(_msgSender(), baseAsset, _sizePrecisionToBaseAssetPrecision(_size), _isMargin);
818:             }
819:         } else if (_type == OrderBookType.NATIVE_IN_BASE) {
820:             address(marginAccount).safeTransferETH(msg.value);
821:         }
822:         require(_quoteCredited >= _minAmountOut, OrderBookErrors.SlippageExceeded());
823:         return _quoteCredited; // <= FOUND
824:     }
```
['[855](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L855-L862)']
```solidity
855:     function _matchAggressiveBuyWithCap(uint256 _limitPrice, uint96 _sizeToBeFilled)
856:         internal
857:         returns (uint96, uint96)
858:     {
859:         uint96 sizeToCreditTaker;
860:         uint96 sizeToCreditViaVault;
861:         uint96 fundsConsumed;
862:         bytes memory makerCredits; // <= FOUND
863:         (bool _isVaultFill, uint256 _bestAsk) = bestAsk();
864:         uint32 _pricePrecision = pricePrecision;
865:         _limitPrice = _limitPrice * vaultPricePrecision / _pricePrecision;
866: 
867:         while (_sizeToBeFilled > 0 && _bestAsk <= _limitPrice && _bestAsk != 0) {
868:             uint96 sizeToBeFilledBefore = _sizeToBeFilled; 
869:             bytes memory priceUpdate;
870: 
871:             if (_isVaultFill) {
872:                 uint96 _vaultFundsConsumed;
873:                 (_sizeToBeFilled, _vaultFundsConsumed, priceUpdate) =
874:                     _fillVaultForBuy(_getOBAsk() > _limitPrice ? _limitPrice + 1 : _getOBAsk(), _sizeToBeFilled);
875:                 fundsConsumed += _vaultFundsConsumed;
876:             } else {
877:                 (_sizeToBeFilled, priceUpdate) = _fillSizeForPrice(
878:                     s_sellTree,
879:                     toU32(_bestAsk * _pricePrecision / vaultPricePrecision),
880:                     s_sellPricePoints[_bestAsk * _pricePrecision / vaultPricePrecision],
881:                     _sizeToBeFilled
882:                 );
883:             }
884: 
885:             uint96 sizeFilled = sizeToBeFilledBefore - _sizeToBeFilled;
886:             sizeToCreditTaker += sizeFilled;
887:             if (_isVaultFill) {
888:                 sizeToCreditViaVault += sizeFilled;
889:             } else {
890:                 fundsConsumed += _quoteAmountRoundedUp(
891:                     toU32(FixedPointMathLib.mulDivUp(_bestAsk, _pricePrecision, vaultPricePrecision)), sizeFilled
892:                 );
893:             }
894:             makerCredits = bytes.concat(makerCredits, priceUpdate);
895: 
896:             (_isVaultFill, _bestAsk) = bestAsk();
897:         }
898: 
899:         if (sizeToCreditTaker == 0) {
900:             return (_sizeToBeFilled, 0);
901:         }
902:         {
903:             uint96 _sizePrecision = sizePrecision;
904:             uint256 _baseDecimalMultiplier = baseDecimalMultiplier;
905:             uint256 _tokenCredit = (sizeToCreditTaker * _baseDecimalMultiplier) / _sizePrecision;
906:             if (sizeToCreditViaVault > 0) {
907:                 marginAccount.debitUser(
908:                     kuruAmmVault, baseAsset, (sizeToCreditViaVault * _baseDecimalMultiplier) / _sizePrecision
909:                 );
910:             }
911:             uint256 _takerFeeBps = takerFeeBps;
912:             if (_takerFeeBps > 0) {
913:                 uint256 _feeDebit = FixedPointMathLib.mulDivUp(_tokenCredit, _takerFeeBps, BPS_MULTIPLIER);
914:                 _tokenCredit -= _feeDebit;
915:                 
916:                 baseFeeCollected += ((_feeDebit * (_takerFeeBps - makerFeeBps)) / _takerFeeBps);
917:             }
918:             marginAccount.creditUsersEncoded(
919:                 bytes.concat(makerCredits, abi.encode(_msgSender(), baseAsset, _tokenCredit, true))
920:             );
921:         }
922: 
923:         return (_sizeToBeFilled, fundsConsumed);
924:     }
```
['[930](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L930-L933)']
```solidity
930:     function _marketBuyMatch(uint96 _quoteSize, bool _isMargin) internal returns (uint96, uint256) {
931:         uint96 sizeToCreditTaker;
932:         uint96 sizeToCreditViaVault;
933:         bytes memory makerCredits; // <= FOUND
934:         uint32 _pricePrecision = pricePrecision;
935:         uint96 _sizePrecision = sizePrecision;
936: 
937:         (bool _isVaultFill, uint256 _bestAsk) = bestAsk();
938: 
939:         while (_quoteSize > 0 && _bestAsk != 0) {
940:             bytes memory priceUpdate;
941:             if (_isVaultFill) {
942:                 uint96 _sizeFilled;
943:                 (_quoteSize, _sizeFilled, priceUpdate) = _fillVaultBuyMatch(_getOBAsk(), _quoteSize);
944:                 sizeToCreditViaVault += _sizeFilled;
945:                 sizeToCreditTaker += _sizeFilled;
946:             } else {
947:                 
948:                 uint96 _sizeFillableAtPriceLeft =
949:                     toU96(_quoteSize * _sizePrecision * vaultPricePrecision / (_bestAsk * _pricePrecision));
950:                 uint96 _sizeFillableAtPriceBefore = _sizeFillableAtPriceLeft; 
951:                 (_sizeFillableAtPriceLeft, priceUpdate) = _fillSizeForPrice(
952:                     s_sellTree,
953:                     toU32(_bestAsk * _pricePrecision / vaultPricePrecision),
954:                     s_sellPricePoints[(_bestAsk * _pricePrecision / vaultPricePrecision)],
955:                     _sizeFillableAtPriceLeft
956:                 );
957:                 sizeToCreditTaker += (_sizeFillableAtPriceBefore - _sizeFillableAtPriceLeft);
958:                 _quoteSize = toU96(
959:                     FixedPointMathLib.mulDiv(
960:                         _bestAsk * _pricePrecision, _sizeFillableAtPriceLeft, _sizePrecision * vaultPricePrecision
961:                     )
962:                 );
963:             }
964:             makerCredits = bytes.concat(makerCredits, priceUpdate);
965: 
966:             (_isVaultFill, _bestAsk) = bestAsk();
967:         }
968: 
969:         if (sizeToCreditTaker == 0) {
970:             return (_quoteSize, 0);
971:         }
972: 
973:         {
974:             uint256 _baseDecimalMultiplier = baseDecimalMultiplier;
975:             uint256 _tokenCredit = (sizeToCreditTaker * _baseDecimalMultiplier) / _sizePrecision;
976:             if (sizeToCreditViaVault > 0 && msg.sender != address(0)) {
977:                 marginAccount.debitUser(
978:                     kuruAmmVault, baseAsset, (sizeToCreditViaVault * _baseDecimalMultiplier) / _sizePrecision
979:                 );
980:             }
981:             uint256 _takerFeeBps = takerFeeBps;
982:             if (_takerFeeBps > 0) {
983:                 uint256 _feeDebit = FixedPointMathLib.mulDivUp(_tokenCredit, _takerFeeBps, BPS_MULTIPLIER);
984:                 _tokenCredit -= _feeDebit;
985:                 
986:                 baseFeeCollected += ((_feeDebit * (_takerFeeBps - makerFeeBps)) / _takerFeeBps);
987:             }
988:             if (msg.sender != address(0)) {
989:                 marginAccount.creditUsersEncoded(
990:                     bytes.concat(makerCredits, abi.encode(_msgSender(), baseAsset, _tokenCredit, _isMargin))
991:                 );
992:             }
993:             return (_quoteSize, _tokenCredit);
994:         }
995:     }
```
['[1003](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L1003-L1008)']
```solidity
1003:     function _matchAggressiveSell(uint256 _limitPrice, uint96 _sizeToBeFilledLeft, bool _useMargin)
1004:         internal
1005:         returns (uint96, uint256)
1006:     {
1007:         uint96 quoteCreditTaker;
1008:         uint256 quoteCreditVaultTaker; // <= FOUND
1009:         uint256 tokenCredit;
1010:         (bool _isVaultFill, uint256 _bestBid) = bestBid();
1011:         bytes memory makerCredits; // <= FOUND
1012:         uint32 _pricePrecision = pricePrecision;
1013:         _limitPrice = _limitPrice * vaultPricePrecision / _pricePrecision;
1014:         while (_sizeToBeFilledLeft > 0 && _bestBid >= _limitPrice && _bestBid != type(uint256).max) {
1015:             uint96 _sizeToBeFilledBefore = _sizeToBeFilledLeft; 
1016: 
1017:             bytes memory priceUpdate;
1018: 
1019:             if (_isVaultFill) {
1020:                 uint256 _quoteToTaker;
1021:                 (_sizeToBeFilledLeft, _quoteToTaker, priceUpdate) =
1022:                     _fillVaultForSell(_getOBBid() >= _limitPrice ? _getOBBid() : _limitPrice - 1, _sizeToBeFilledLeft);
1023:                 quoteCreditVaultTaker += _quoteToTaker;
1024:             } else {
1025:                 (_sizeToBeFilledLeft, priceUpdate) = _fillSizeForPrice(
1026:                     s_buyTree,
1027:                     toU32(_bestBid * _pricePrecision / vaultPricePrecision),
1028:                     s_buyPricePoints[_bestBid * _pricePrecision / vaultPricePrecision],
1029:                     _sizeToBeFilledLeft
1030:                 );
1031:                 quoteCreditTaker += toU96(
1032:                     FixedPointMathLib.mulDiv(
1033:                         _sizeToBeFilledBefore - _sizeToBeFilledLeft,
1034:                         toU32(_bestBid * _pricePrecision / vaultPricePrecision),
1035:                         sizePrecision
1036:                     )
1037:                 );
1038:             }
1039:             makerCredits = bytes.concat(makerCredits, priceUpdate);
1040: 
1041:             (_isVaultFill, _bestBid) = bestBid();
1042:         }
1043: 
1044:         if (quoteCreditTaker == 0 && quoteCreditVaultTaker == 0) {
1045:             return (_sizeToBeFilledLeft, 0);
1046:         }
1047:         {
1048:             uint256 _quoteDecimalMultiplier = quoteDecimalMultiplier;
1049:             tokenCredit = ((quoteCreditTaker) * _quoteDecimalMultiplier) / _pricePrecision
1050:                 + (quoteCreditVaultTaker * _quoteDecimalMultiplier) / vaultPricePrecision;
1051:             if (quoteCreditVaultTaker > 0 && msg.sender != address(0)) {
1052:                 marginAccount.debitUser(
1053:                     kuruAmmVault, quoteAsset, (quoteCreditVaultTaker * _quoteDecimalMultiplier) / vaultPricePrecision
1054:                 );
1055:             }
1056:             uint256 _takerFeeBps = takerFeeBps;
1057:             if (_takerFeeBps > 0) {
1058:                 uint256 _feeDebit = FixedPointMathLib.mulDivUp(tokenCredit, _takerFeeBps, BPS_MULTIPLIER);
1059:                 tokenCredit -= _feeDebit;
1060:                 
1061:                 quoteFeeCollected += ((_feeDebit * (_takerFeeBps - makerFeeBps)) / _takerFeeBps);
1062:             }
1063:             if (msg.sender != address(0)) {
1064:                 marginAccount.creditUsersEncoded(
1065:                     bytes.concat(makerCredits, abi.encode(_msgSender(), quoteAsset, tokenCredit, _useMargin))
1066:                 );
1067:             }
1068:         }
1069: 
1070:         return (_sizeToBeFilledLeft, tokenCredit);
1071:     }
```
['[1080](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L1080-L1089)']
```solidity
1080:     function _fillSizeForPrice(
1081:         TreeMath.TreeUint32 storage _tree,
1082:         uint32 _price,
1083:         OrderLinkedList.PricePoint storage _pricePoint,
1084:         uint96 _size
1085:     ) internal returns (uint96, bytes memory makerCredits) {
1086:         uint40 _orderId = _pricePoint.head;
1087:         while (_size > 0 && _orderId != OrderLinkedList.NULL) {
1088:             
1089:             bytes memory orderUpdate; // <= FOUND
1090:             
1091:             (_size, _orderId, orderUpdate) = _fillOrder(_orderId, _size);
1092:             
1093:             makerCredits = bytes.concat(makerCredits, orderUpdate);
1094:         }
1095:         OrderLinkedList.updateHead(_pricePoint, _orderId);
1096:         if (_orderId == OrderLinkedList.NULL) {
1097:             TreeMath.remove(_tree, _price);
1098:         }
1099:         return (_size, makerCredits);
1100:     }
```
['[1238](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L1238-L1246)']
```solidity
1238:     function _creditMaker(bool _isMarketBuy, address _ownerAddress, uint96 _size, uint32 _price)
1239:         internal
1240:         view
1241:         returns (bytes memory)
1242:     {
1243:         address creditAsset = _isMarketBuy ? quoteAsset : baseAsset;
1244:         uint256 amount =
1245:             _isMarketBuy ? _quoteAmountRoundedDown(_size, _price) : ((_size * baseDecimalMultiplier) / sizePrecision);
1246:         uint256 feeRebate; // <= FOUND
1247:         address feeAsset;
1248:         bytes memory returnData;
1249:         if (_isMarketBuy) {
1250:             feeAsset = baseAsset;
1251:             feeRebate = (((_size * baseDecimalMultiplier) / sizePrecision) * makerFeeBps) / BPS_MULTIPLIER;
1252:         } else {
1253:             feeAsset = quoteAsset;
1254:             feeRebate = (_quoteAmountRoundedDown(_size, _price) * makerFeeBps) / BPS_MULTIPLIER;
1255:         }
1256:         
1257:         if (feeRebate > 0) {
1258:             returnData = abi.encode(_ownerAddress, feeAsset, feeRebate, true);
1259:         }
1260: 
1261:         return bytes.concat(returnData, abi.encode(_ownerAddress, creditAsset, amount, true));
1262:     }
```
['[1399](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L1399-L1400)']
```solidity
1399:     function getL2Book(uint32 _bidPricePoints, uint32 _askPricePoints) public view returns (bytes memory data) {
1400:         uint256 dataStart; // <= FOUND
1401:         uint256 lastFree;
1402: 
1403:         assembly ("memory-safe") {
1404:             dataStart := mload(0x40)
1405:             lastFree := add(dataStart, 32)
1406:             mstore(lastFree, number()) 
1407:             lastFree := add(lastFree, 32)
1408:             mstore(0x40, lastFree)
1409:         }
1410: 
1411:         
1412:         uint32 price = TreeMath.findFirstRight(s_buyTree, type(uint32).max);
1413:         while (price != type(uint32).max && price != 0 && _bidPricePoints != 0) {
1414:             uint40 orderId = s_buyPricePoints[price].head;
1415:             uint96 size = 0;
1416:             while (orderId != 0) {
1417:                 size += s_orders[orderId].size;
1418:                 orderId = s_orders[orderId].next;
1419:             }
1420:             assembly ("memory-safe") {
1421:                 let curFree := mload(0x40)
1422:                 if iszero(eq(curFree, lastFree)) {
1423:                     
1424:                     let producedLen := sub(lastFree, dataStart)
1425:                     for { let offset := 0 } lt(offset, producedLen) { offset := add(offset, 32) } {
1426:                         mstore(add(curFree, offset), mload(add(dataStart, offset)))
1427:                     }
1428:                     dataStart := curFree
1429:                     lastFree := add(curFree, producedLen)
1430:                 }
1431: 
1432:                 mstore(lastFree, price)
1433:                 mstore(add(lastFree, 32), size)
1434:                 lastFree := add(lastFree, 64)
1435:                 mstore(0x40, lastFree)
1436:             }
1437:             price = TreeMath.findFirstRight(s_buyTree, price);
1438:             --_bidPricePoints;
1439:         }
1440: 
1441:         assembly ("memory-safe") {
1442:             let curFree := mload(0x40)
1443:             if iszero(eq(curFree, lastFree)) {
1444:                 let producedLen := sub(lastFree, dataStart)
1445:                 for { let offset := 0 } lt(offset, producedLen) { offset := add(offset, 32) } {
1446:                     mstore(add(curFree, offset), mload(add(dataStart, offset)))
1447:                 }
1448:                 dataStart := curFree
1449:                 lastFree := add(curFree, producedLen)
1450:             }
1451: 
1452:             mstore(lastFree, 0)
1453:             lastFree := add(lastFree, 32)
1454:             mstore(0x40, lastFree)
1455:         }
1456: 
1457:         price = TreeMath.findFirstLeft(s_sellTree, 0);
1458:         while (price != type(uint32).max && price != 0 && _askPricePoints != 0) {
1459:             uint40 orderId = s_sellPricePoints[price].head;
1460:             uint96 size = 0;
1461:             while (orderId != 0) {
1462:                 size += s_orders[orderId].size;
1463:                 orderId = s_orders[orderId].next;
1464:             }
1465:             assembly ("memory-safe") {
1466:                 let curFree := mload(0x40)
1467:                 if iszero(eq(curFree, lastFree)) {
1468:                     
1469:                     let producedLen := sub(lastFree, dataStart)
1470:                     for { let offset := 0 } lt(offset, producedLen) { offset := add(offset, 32) } {
1471:                         mstore(add(curFree, offset), mload(add(dataStart, offset)))
1472:                     }
1473:                     dataStart := curFree
1474:                     lastFree := add(curFree, producedLen)
1475:                 }
1476: 
1477:                 mstore(lastFree, price)
1478:                 mstore(add(lastFree, 32), size)
1479:                 lastFree := add(lastFree, 64)
1480:                 mstore(0x40, lastFree)
1481:             }
1482:             price = TreeMath.findFirstLeft(s_sellTree, price);
1483:             --_askPricePoints;
1484:         }
1485: 
1486:         assembly ("memory-safe") {
1487:             mstore(dataStart, sub(lastFree, add(dataStart, 32)))
1488:             data := dataStart
1489:         }
1490:     }
```


</details>

## [NonCritical-70] Contract calls `disableInitializers` in it's constructor but also contains a initialization function which utilizes the `initializer` modifier.

### Resolution 
This prevents the contract from ever getting initialized if the deployment is not done by a factory contract or something similar as disableInitializers is called at deployment thus preventing initialization through a separate TX

Num of instances: 15

### Findings 


<details><summary>Click to show findings</summary>

['[18](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L18-L18)']
```solidity
18: contract KuruAMMVault is IKuruAMMVault, ERC20, Initializable, UUPSUpgradeable, ReentrancyGuardTransient  // <= FOUND
```
['[33](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L33-L33)']
```solidity
    constructor() {
        _disableInitializers();
    }
```
['[45](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L45-L45)']
```solidity
    function initialize(
        address _owner,
        address token1_,
        address token2_,
        address _marginAccount,
        address _market,
        uint96 _spreadConstant
    ) public initializer {
        owner = _owner;
        token1 = token1_;
        token1Decimals = token1_ != address(0) ? ERC20(token1_).decimals() : 18;
        token2 = token2_;
        token2Decimals = token2_ != address(0) ? ERC20(token2_).decimals() : 18;
        marginAccount = IMarginAccount(_marginAccount);
        market = IOrderBook(_market);
        SPREAD_CONSTANT = _spreadConstant;
        setMarketParams();
        if (token1_ != address(0)) {
            token1_.safeApprove(_marginAccount, type(uint256).max);
        }
        if (token2_ != address(0)) {
            token2_.safeApprove(_marginAccount, type(uint256).max);
        }
        string memory token1Symbol;
        string memory token2Symbol;
        if (token1_ != address(0)) {
            token1Symbol = ERC20(token1_).symbol();
        } else {
            token1Symbol = "MON";
        }
        if (token2_ != address(0)) {
            token2Symbol = ERC20(token2_).symbol();
        } else {
            token2Symbol = "MON";
        }
        _name = string.concat(token1Symbol, "-", token2Symbol, "-", "KURU-AMM-VAULT");
    }
```
['[16](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruForwarder.sol#L16-L16)']
```solidity
16: contract KuruForwarder is EIP712, Initializable, Ownable, UUPSUpgradeable  // <= FOUND
```
['[33](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L33-L33)']
```solidity
    constructor() {
        _disableInitializers();
    }
```
['[96](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruForwarder.sol#L96-L96)']
```solidity
    function initialize(address _owner, bytes4[] memory _allowedInterfaces) public initializer {
        _initializeOwner(_owner);
        for (uint256 i = 0; i < _allowedInterfaces.length; i++) {
            allowedInterface[_allowedInterfaces[i]] = true;
        }
    }
```
['[17](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L17-L17)']
```solidity
17: contract MarginAccount is IMarginAccount, ERC2771Context, Ownable, Initializable, UUPSUpgradeable  // <= FOUND
```
['[33](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L33-L33)']
```solidity
    constructor() {
        _disableInitializers();
    }
```
['[76](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L76-L76)']
```solidity
    function initialize(address _owner, address _router, address _feeCollector, address _trustedForwarder)
        public
        initializer
    {
        _initializeOwner(_owner);
        routerContractAddress = _router;
        feeCollector = _feeCollector;
        trustedForwarder = _trustedForwarder;
    }
```
['[20](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L20-L20)']
```solidity
20: contract OrderBook is Initializable, UUPSUpgradeable, ERC2771Context, AbstractAMM  // <= FOUND
```
['[33](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L33-L33)']
```solidity
    constructor() {
        _disableInitializers();
    }
```
['[85](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L85-L85)']
```solidity
    function initialize(
        address _owner,
        OrderBookType _type,
        address _baseAssetAddress,
        uint256 _baseAssetDecimals,
        address _quoteAssetAddress,
        uint256 _quoteAssetDecimals,
        address _marginAccountAddress,
        uint96 _sizePrecision,
        uint32 _pricePrecision,
        uint32 _tickSize,
        uint96 _minSize,
        uint96 _maxSize,
        uint256 _takerFeeBps,
        uint256 _makerFeeBps,
        address _kuruAmmVault,
        uint96 _kuruAmmSpread,
        address __trustedForwarder
    ) public initializer {
        owner = _owner;

        require(_makerFeeBps <= _takerFeeBps && _takerFeeBps < BPS_MULTIPLIER, OrderBookErrors.MarketFeeError());
        require(_kuruAmmSpread % 10 == 0 && _kuruAmmSpread > 0 && _kuruAmmSpread < 500, OrderBookErrors.InvalidSpread());
        require(_minSize > 0 && _maxSize > _minSize, OrderBookErrors.MarketSizeError());
        orderBookType = _type;
        baseAsset = _baseAssetAddress;
        quoteAsset = _quoteAssetAddress;

        baseAssetDecimals = _baseAssetDecimals;
        baseDecimalMultiplier = 10 ** _baseAssetDecimals;
        quoteAssetDecimals = _quoteAssetDecimals;
        quoteDecimalMultiplier = 10 ** _quoteAssetDecimals;

        marginAccount = IMarginAccount(payable(_marginAccountAddress));
        
        sizePrecision = _sizePrecision;
        pricePrecision = _pricePrecision;
        tickSize = _tickSize;
        minSize = _minSize;
        maxSize = _maxSize;
        takerFeeBps = _takerFeeBps;
        makerFeeBps = _makerFeeBps;
        kuruAmmVault = _kuruAmmVault;
        SPREAD_CONSTANT = _kuruAmmSpread;
        vaultBestAsk = type(uint256).max;
        _trustedForwarder = __trustedForwarder;
    }
```
['[23](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L23-L23)']
```solidity
23: contract Router is IRouter, Ownable, Initializable, UUPSUpgradeable  // <= FOUND
```
['[33](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L33-L33)']
```solidity
    constructor() {
        _disableInitializers();
    }
```
['[45](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L45-L45)']
```solidity
    function initialize(
        address _owner,
        address _marginAccount,
        address _orderbookImplementation,
        address _kuruAmmVaultImplementation,
        address _trustedForwarder
    ) public initializer {
        _initializeOwner(_owner);
        marginAccountAddress = _marginAccount;
        orderBookImplementation = _orderbookImplementation;
        kuruAmmVaultImplementation = _kuruAmmVaultImplementation;
        TRUSTED_FORWARDER = _trustedForwarder;
    }
```


</details>

## [Gas-1] State variables used within a function more than once should be cached to save gas 

### Resolution 
Cache such variables and perform operations on them, if operations include modifications to the state variable(s) then remember to equate the state variable to it's cached counterpart at the end

Num of instances: 6

### Findings 


<details><summary>Click to show findings</summary>

['[1399](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L1399-L1482)']
```solidity
1399:     function getL2Book(uint32 _bidPricePoints, uint32 _askPricePoints) public view returns (bytes memory data) { // <= FOUND 'function getL2Book'
1400:         uint256 dataStart;
1401:         uint256 lastFree;
1402: 
1403:         assembly ("memory-safe") {
1404:             dataStart := mload(0x40)
1405:             lastFree := add(dataStart, 32)
1406:             mstore(lastFree, number()) 
1407:             lastFree := add(lastFree, 32)
1408:             mstore(0x40, lastFree)
1409:         }
1410: 
1411:         
1412:         uint32 price = TreeMath.findFirstRight(s_buyTree, type(uint32).max);
1413:         while (price != type(uint32).max && price != 0 && _bidPricePoints != 0) {
1414:             uint40 orderId = s_buyPricePoints[price].head;
1415:             uint96 size = 0;
1416:             while (orderId != 0) {
1417:                 size += s_orders[orderId].size;
1418:                 orderId = s_orders[orderId].next;
1419:             }
1420:             assembly ("memory-safe") {
1421:                 let curFree := mload(0x40)
1422:                 if iszero(eq(curFree, lastFree)) {
1423:                     
1424:                     let producedLen := sub(lastFree, dataStart)
1425:                     for { let offset := 0 } lt(offset, producedLen) { offset := add(offset, 32) } {
1426:                         mstore(add(curFree, offset), mload(add(dataStart, offset)))
1427:                     }
1428:                     dataStart := curFree
1429:                     lastFree := add(curFree, producedLen)
1430:                 }
1431: 
1432:                 mstore(lastFree, price)
1433:                 mstore(add(lastFree, 32), size)
1434:                 lastFree := add(lastFree, 64)
1435:                 mstore(0x40, lastFree)
1436:             }
1437:             price = TreeMath.findFirstRight(s_buyTree, price);
1438:             --_bidPricePoints;
1439:         }
1440: 
1441:         assembly ("memory-safe") {
1442:             let curFree := mload(0x40)
1443:             if iszero(eq(curFree, lastFree)) {
1444:                 let producedLen := sub(lastFree, dataStart)
1445:                 for { let offset := 0 } lt(offset, producedLen) { offset := add(offset, 32) } {
1446:                     mstore(add(curFree, offset), mload(add(dataStart, offset)))
1447:                 }
1448:                 dataStart := curFree
1449:                 lastFree := add(curFree, producedLen)
1450:             }
1451: 
1452:             mstore(lastFree, 0)
1453:             lastFree := add(lastFree, 32)
1454:             mstore(0x40, lastFree)
1455:         }
1456: 
1457:         price = TreeMath.findFirstLeft(s_sellTree, 0); // <= FOUND 's_sellTree'
1458:         while (price != type(uint32).max && price != 0 && _askPricePoints != 0) {
1459:             uint40 orderId = s_sellPricePoints[price].head;
1460:             uint96 size = 0;
1461:             while (orderId != 0) {
1462:                 size += s_orders[orderId].size;
1463:                 orderId = s_orders[orderId].next;
1464:             }
1465:             assembly ("memory-safe") {
1466:                 let curFree := mload(0x40)
1467:                 if iszero(eq(curFree, lastFree)) {
1468:                     
1469:                     let producedLen := sub(lastFree, dataStart)
1470:                     for { let offset := 0 } lt(offset, producedLen) { offset := add(offset, 32) } {
1471:                         mstore(add(curFree, offset), mload(add(dataStart, offset)))
1472:                     }
1473:                     dataStart := curFree
1474:                     lastFree := add(curFree, producedLen)
1475:                 }
1476: 
1477:                 mstore(lastFree, price)
1478:                 mstore(add(lastFree, 32), size)
1479:                 lastFree := add(lastFree, 64)
1480:                 mstore(0x40, lastFree)
1481:             }
1482:             price = TreeMath.findFirstLeft(s_sellTree, price); // <= FOUND 's_sellTree'
1483:             --_askPricePoints;
1484:         }
1485: 
1486:         assembly ("memory-safe") {
1487:             mstore(dataStart, sub(lastFree, add(dataStart, 32)))
1488:             data := dataStart
1489:         }
1490:     }
```
['[1238](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L1238-L1251)']
```solidity
1238:     function _creditMaker(bool _isMarketBuy, address _ownerAddress, uint96 _size, uint32 _price) // <= FOUND 'function _creditMaker'
1239:         internal
1240:         view
1241:         returns (bytes memory)
1242:     {
1243:         address creditAsset = _isMarketBuy ? quoteAsset : baseAsset;
1244:         uint256 amount =
1245:             _isMarketBuy ? _quoteAmountRoundedDown(_size, _price) : ((_size * baseDecimalMultiplier) / sizePrecision); // <= FOUND 'baseDecimalMultiplier'
1246:         uint256 feeRebate;
1247:         address feeAsset;
1248:         bytes memory returnData;
1249:         if (_isMarketBuy) {
1250:             feeAsset = baseAsset;
1251:             feeRebate = (((_size * baseDecimalMultiplier) / sizePrecision) * makerFeeBps) / BPS_MULTIPLIER; // <= FOUND 'baseDecimalMultiplier'
1252:         } else {
1253:             feeAsset = quoteAsset;
1254:             feeRebate = (_quoteAmountRoundedDown(_size, _price) * makerFeeBps) / BPS_MULTIPLIER;
1255:         }
1256:         
1257:         if (feeRebate > 0) {
1258:             returnData = abi.encode(_ownerAddress, feeAsset, feeRebate, true);
1259:         }
1260: 
1261:         return bytes.concat(returnData, abi.encode(_ownerAddress, creditAsset, amount, true));
1262:     }
```
['[205](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L205-L211)']
```solidity
205:     function addFlipBuyOrder(uint32 _price, uint32 _flippedPrice, uint96 _size, bool _provisionOrRevert) // <= FOUND 'function addFlipBuyOrder'
206:         public
207:         marketActive
208:         nonReentrant
209:     {
210:         require(_price > 0 && _flippedPrice > 0 && _flippedPrice < type(uint32).max, OrderBookErrors.PriceError());
211:         require(_price % tickSize == 0 && _flippedPrice % tickSize == 0, OrderBookErrors.TickSizeError()); // <= FOUND 'tickSize'
212:         require(_price < _flippedPrice, OrderBookErrors.PriceError());
213:         require(_size > minSize && _size < maxSize, OrderBookErrors.SizeError());
214: 
215:         {
216:             (, uint256 _bestAsk) = bestAsk();
217:             if ((uint256(_price) * vaultPricePrecision / pricePrecision) >= _bestAsk && _bestAsk != 0) {
218:                 if (_provisionOrRevert) {
219:                     revert OrderBookErrors.ProvisionError();
220:                 } else {
221:                     return;
222:                 }
223:             }
224:         }
225:         _consumeFunds(
226:             quoteAsset, _quoteAmountRoundedUp(_price, _size) * quoteDecimalMultiplier / pricePrecision, _msgSender()
227:         );
228: 
229:         uint40 _orderId = s_orderIdCounter + 1;
230:         s_orderIdCounter = _orderId;
231:         uint40 _prevOrderId = OrderLinkedList.insertAtTail(s_buyPricePoints[_price], _orderId);
232:         _addFlipOrder(_price, _flippedPrice, _size, _msgSender(), _orderId, OrderLinkedList.NULL, true, _prevOrderId);
233:     }
```
['[311](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L311-L319)']
```solidity
311:     function addPairedLiquidity(uint32 _bidPrice, uint32 _askPrice, uint96 _bidSize, uint96 _askSize) // <= FOUND 'function addPairedLiquidity'
312:         public
313:         marketActive
314:         nonReentrant
315:     {
316:         require(_bidPrice > 0 && _askPrice > _bidPrice && _askPrice < type(uint32).max, OrderBookErrors.PriceError());
317:         require(_bidPrice % tickSize == 0 && _askPrice % tickSize == 0, OrderBookErrors.TickSizeError());
318:         require(_bidSize > minSize && _bidSize < maxSize, OrderBookErrors.SizeError()); // <= FOUND 'maxSize'
319:         require(_askSize > minSize && _askSize < maxSize, OrderBookErrors.SizeError()); // <= FOUND 'maxSize'
320:         {
321:             (, uint256 _bestBid) = bestBid();
322:             (, uint256 _bestAsk) = bestAsk();
323:             require(
324:                 ((uint256(_bidPrice) * vaultPricePrecision / pricePrecision) < _bestAsk) || (_bestAsk == 0),
325:                 OrderBookErrors.ProvisionError()
326:             );
327:             require(
328:                 ((uint256(_askPrice) * vaultPricePrecision / pricePrecision) > _bestBid)
329:                     || (_bestBid == type(uint256).max),
330:                 OrderBookErrors.ProvisionError()
331:             );
332:         }
333: 
334:         _consumeFunds(
335:             quoteAsset,
336:             _quoteAmountRoundedUp(_bidPrice, _bidSize) * quoteDecimalMultiplier / pricePrecision,
337:             _msgSender()
338:         );
339:         _consumeFunds(baseAsset, _askSize * baseDecimalMultiplier / sizePrecision, _msgSender());
340: 
341:         uint40 _bidOrderId = s_orderIdCounter + 1;
342:         uint40 _askOrderId = _bidOrderId + 1;
343:         s_orderIdCounter = _askOrderId;
344: 
345:         uint40 _bidPrevOrderId = OrderLinkedList.insertAtTail(s_buyPricePoints[_bidPrice], _bidOrderId);
346:         uint40 _askPrevOrderId = OrderLinkedList.insertAtTail(s_sellPricePoints[_askPrice], _askOrderId);
347:         _addFlipOrder(_bidPrice, _askPrice, _bidSize, _msgSender(), _bidOrderId, _askOrderId, true, _bidPrevOrderId);
348:         _addFlipOrder(_askPrice, _bidPrice, _askSize, _msgSender(), _askOrderId, _bidOrderId, false, _askPrevOrderId);
349:     }
```
['[149](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L149-L150)']
```solidity
149:     function totalAssets() public view returns (uint256, uint256) { // <= FOUND 'function totalAssets'
150:         return (marginAccount.getBalance(address(this), token1), marginAccount.getBalance(address(this), token2)); // <= FOUND 'marginAccount'
151:     }
```
['[59](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/AbstractAMM.sol#L59-L90)']
```solidity
59:     function _fillVaultBuyMatch(uint256 _breakPoint, uint96 _quoteSize) // <= FOUND 'function _fillVaultBuyMatch'
60:         internal
61:         returns (uint96 quoteLeft, uint96 sizeFilled, bytes memory makerCredits)
62:     {
63:         uint256 _price = vaultBestAsk;
64:         uint256 _quoteInput = _quoteSize * vaultPricePrecision / _getPricePrecision();
65:         uint96 _cachedLastVaultSize = vaultAskOrderSize;
66:         uint96 _cachedPartiallyFilledBid = bidPartiallyFilledSize;
67:         uint96 _availableSize = _cachedLastVaultSize - askPartiallyFilledSize;
68:         
69:         if (_quoteInput >= FixedPointMathLib.mulDivUp(_price, _availableSize, _getSizePrecision())) {
70:             askPartiallyFilledSize = 0;
71:         }
72: 
73:         while (_price < _breakPoint && _quoteInput > 0) {
74:             uint256 _quoteNeededForFill = FixedPointMathLib.mulDivUp(_price, _availableSize, _getSizePrecision());
75:             if (_quoteNeededForFill > _quoteInput) {
76:                 uint96 _sizeFilledAtPrice = toU96(_quoteInput * _getSizePrecision() / _price);
77:                 sizeFilled += _sizeFilledAtPrice;
78:                 askPartiallyFilledSize += _sizeFilledAtPrice;
79:                 _emitTrade(0, kuruAmmVault, true, _price, _availableSize - _sizeFilledAtPrice, _sizeFilledAtPrice); // <= FOUND 'kuruAmmVault'
80:                 _quoteInput = 0;
81:                 break;
82:             } else {
83:                 sizeFilled += _availableSize;
84:                 _quoteInput -= _quoteNeededForFill;
85:                 _cachedLastVaultSize = toU96(
86:                     FixedPointMathLib.mulDiv(
87:                         _cachedLastVaultSize, DOUBLE_BPS_MULTIPLIER, DOUBLE_BPS_MULTIPLIER + SPREAD_CONSTANT
88:                     )
89:                 );
90:                 _emitTrade(0, kuruAmmVault, true, _price, 0, _availableSize); // <= FOUND 'kuruAmmVault'
91:                 _availableSize = _cachedLastVaultSize;
92:                 _price = FixedPointMathLib.mulDivRound(_price, BPS_MULTIPLIER + SPREAD_CONSTANT, BPS_MULTIPLIER);
93:                 _cachedPartiallyFilledBid = toU96(
94:                     FixedPointMathLib.mulDiv(
95:                         _cachedPartiallyFilledBid, BPS_MULTIPLIER, BPS_MULTIPLIER + SPREAD_CONSTANT
96:                     )
97:                 );
98:             }
99:         }
100:         if (_price != vaultBestAsk) {
101:             vaultBestAsk = _price;
102:             vaultBestBid = FixedPointMathLib.mulDivRound(_price, BPS_MULTIPLIER, BPS_MULTIPLIER + SPREAD_CONSTANT);
103:             vaultAskOrderSize = _cachedLastVaultSize;
104:             vaultBidOrderSize = toU96(
105:                 FixedPointMathLib.mulDiv(
106:                     _cachedLastVaultSize, DOUBLE_BPS_MULTIPLIER + SPREAD_CONSTANT, DOUBLE_BPS_MULTIPLIER
107:                 )
108:             );
109:         }
110:         bidPartiallyFilledSize = _cachedPartiallyFilledBid;
111:         quoteLeft = toU96(FixedPointMathLib.mulDiv(_quoteInput, _getPricePrecision(), vaultPricePrecision));
112:         makerCredits =
113:             _creditVaultOnMarketBuy(sizeFilled, (_quoteSize * vaultPricePrecision / _getPricePrecision() - _quoteInput));
114:     }
```


</details>

## [Gas-2] The result of a function call should be cached rather than re-calling the function 

### Resolution 
External calls in Solidity are costly in terms of gas usage. This can significantly impact contract efficiency and cost. Functions that make repetitive calls to fetch the same data from other contracts can cause unnecessary gas expenditure. To optimize this, it's advisable to store the returned value of these function calls in a state variable, essentially caching the data. This data can be updated at regular intervals or under specific conditions instead of fetching it from the external contract on every invocation. Be sure to analyze the frequency of data change in the external contract to balance data freshness with gas efficiency when implementing caching.

Num of instances: 4

### Findings 


<details><summary>Click to show findings</summary>

['[350](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L350-L363)']
```solidity
350:     function _convertToAssets(uint256 shares, bool isDeposit)
351:         internal
352:         view
353:         returns (uint256 _baseAmount, uint256 _quoteAmount)
354:     {
355:         if (isDeposit) {
356:             if (totalSupply() == 0) { // <= FOUND
357:                 return (0, 0);
358:             }
359:             (uint256 _baseReserve, uint256 _quoteReserve) = totalAssets();
360:             (, uint256 _currentAskPrice) = _returnNormalizedAmountAndPrice(true);
361:             (_baseReserve, _quoteReserve) =
362:                 _returnVirtuallyRebalancedTotalAssets(_baseReserve, _quoteReserve, _currentAskPrice);
363:             _baseAmount = FixedPointMathLib.mulDiv(shares, _baseReserve, totalSupply()); // <= FOUND
364:             _quoteAmount = (
365:                 (
366:                     FixedPointMathLib.mulDivUp(_baseAmount, _currentAskPrice, vaultPricePrecision)
367:                         * 10 ** marketParams.quoteAssetDecimals
368:                 )
369:             ) / 10 ** marketParams.baseAssetDecimals;
370:             return (_baseAmount, _quoteAmount);
371:         } else {
372:             (_baseAmount, _quoteAmount,,,) = _convertToAssetsWithNewSize(shares);
373:         }
374:     }
```
['[855](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L855-L896)']
```solidity
855:     function _matchAggressiveBuyWithCap(uint256 _limitPrice, uint96 _sizeToBeFilled)
856:         internal
857:         returns (uint96, uint96)
858:     {
859:         uint96 sizeToCreditTaker;
860:         uint96 sizeToCreditViaVault;
861:         uint96 fundsConsumed;
862:         bytes memory makerCredits;
863:         (bool _isVaultFill, uint256 _bestAsk) = bestAsk(); // <= FOUND
864:         uint32 _pricePrecision = pricePrecision;
865:         _limitPrice = _limitPrice * vaultPricePrecision / _pricePrecision;
866: 
867:         while (_sizeToBeFilled > 0 && _bestAsk <= _limitPrice && _bestAsk != 0) {
868:             uint96 sizeToBeFilledBefore = _sizeToBeFilled; 
869:             bytes memory priceUpdate;
870: 
871:             if (_isVaultFill) {
872:                 uint96 _vaultFundsConsumed;
873:                 (_sizeToBeFilled, _vaultFundsConsumed, priceUpdate) =
874:                     _fillVaultForBuy(_getOBAsk() > _limitPrice ? _limitPrice + 1 : _getOBAsk(), _sizeToBeFilled);
875:                 fundsConsumed += _vaultFundsConsumed;
876:             } else {
877:                 (_sizeToBeFilled, priceUpdate) = _fillSizeForPrice(
878:                     s_sellTree,
879:                     toU32(_bestAsk * _pricePrecision / vaultPricePrecision),
880:                     s_sellPricePoints[_bestAsk * _pricePrecision / vaultPricePrecision],
881:                     _sizeToBeFilled
882:                 );
883:             }
884: 
885:             uint96 sizeFilled = sizeToBeFilledBefore - _sizeToBeFilled;
886:             sizeToCreditTaker += sizeFilled;
887:             if (_isVaultFill) {
888:                 sizeToCreditViaVault += sizeFilled;
889:             } else {
890:                 fundsConsumed += _quoteAmountRoundedUp(
891:                     toU32(FixedPointMathLib.mulDivUp(_bestAsk, _pricePrecision, vaultPricePrecision)), sizeFilled
892:                 );
893:             }
894:             makerCredits = bytes.concat(makerCredits, priceUpdate);
895: 
896:             (_isVaultFill, _bestAsk) = bestAsk(); // <= FOUND
897:         }
898: 
899:         if (sizeToCreditTaker == 0) {
900:             return (_sizeToBeFilled, 0);
901:         }
902:         {
903:             uint96 _sizePrecision = sizePrecision;
904:             uint256 _baseDecimalMultiplier = baseDecimalMultiplier;
905:             uint256 _tokenCredit = (sizeToCreditTaker * _baseDecimalMultiplier) / _sizePrecision;
906:             if (sizeToCreditViaVault > 0) {
907:                 marginAccount.debitUser(
908:                     kuruAmmVault, baseAsset, (sizeToCreditViaVault * _baseDecimalMultiplier) / _sizePrecision
909:                 );
910:             }
911:             uint256 _takerFeeBps = takerFeeBps;
912:             if (_takerFeeBps > 0) {
913:                 uint256 _feeDebit = FixedPointMathLib.mulDivUp(_tokenCredit, _takerFeeBps, BPS_MULTIPLIER);
914:                 _tokenCredit -= _feeDebit;
915:                 
916:                 baseFeeCollected += ((_feeDebit * (_takerFeeBps - makerFeeBps)) / _takerFeeBps);
917:             }
918:             marginAccount.creditUsersEncoded(
919:                 bytes.concat(makerCredits, abi.encode(_msgSender(), baseAsset, _tokenCredit, true))
920:             );
921:         }
922: 
923:         return (_sizeToBeFilled, fundsConsumed);
924:     }
```
['[930](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L930-L966)']
```solidity
930:     function _marketBuyMatch(uint96 _quoteSize, bool _isMargin) internal returns (uint96, uint256) {
931:         uint96 sizeToCreditTaker;
932:         uint96 sizeToCreditViaVault;
933:         bytes memory makerCredits;
934:         uint32 _pricePrecision = pricePrecision;
935:         uint96 _sizePrecision = sizePrecision;
936: 
937:         (bool _isVaultFill, uint256 _bestAsk) = bestAsk(); // <= FOUND
938: 
939:         while (_quoteSize > 0 && _bestAsk != 0) {
940:             bytes memory priceUpdate;
941:             if (_isVaultFill) {
942:                 uint96 _sizeFilled;
943:                 (_quoteSize, _sizeFilled, priceUpdate) = _fillVaultBuyMatch(_getOBAsk(), _quoteSize);
944:                 sizeToCreditViaVault += _sizeFilled;
945:                 sizeToCreditTaker += _sizeFilled;
946:             } else {
947:                 
948:                 uint96 _sizeFillableAtPriceLeft =
949:                     toU96(_quoteSize * _sizePrecision * vaultPricePrecision / (_bestAsk * _pricePrecision));
950:                 uint96 _sizeFillableAtPriceBefore = _sizeFillableAtPriceLeft; 
951:                 (_sizeFillableAtPriceLeft, priceUpdate) = _fillSizeForPrice(
952:                     s_sellTree,
953:                     toU32(_bestAsk * _pricePrecision / vaultPricePrecision),
954:                     s_sellPricePoints[(_bestAsk * _pricePrecision / vaultPricePrecision)],
955:                     _sizeFillableAtPriceLeft
956:                 );
957:                 sizeToCreditTaker += (_sizeFillableAtPriceBefore - _sizeFillableAtPriceLeft);
958:                 _quoteSize = toU96(
959:                     FixedPointMathLib.mulDiv(
960:                         _bestAsk * _pricePrecision, _sizeFillableAtPriceLeft, _sizePrecision * vaultPricePrecision
961:                     )
962:                 );
963:             }
964:             makerCredits = bytes.concat(makerCredits, priceUpdate);
965: 
966:             (_isVaultFill, _bestAsk) = bestAsk(); // <= FOUND
967:         }
968: 
969:         if (sizeToCreditTaker == 0) {
970:             return (_quoteSize, 0);
971:         }
972: 
973:         {
974:             uint256 _baseDecimalMultiplier = baseDecimalMultiplier;
975:             uint256 _tokenCredit = (sizeToCreditTaker * _baseDecimalMultiplier) / _sizePrecision;
976:             if (sizeToCreditViaVault > 0 && msg.sender != address(0)) {
977:                 marginAccount.debitUser(
978:                     kuruAmmVault, baseAsset, (sizeToCreditViaVault * _baseDecimalMultiplier) / _sizePrecision
979:                 );
980:             }
981:             uint256 _takerFeeBps = takerFeeBps;
982:             if (_takerFeeBps > 0) {
983:                 uint256 _feeDebit = FixedPointMathLib.mulDivUp(_tokenCredit, _takerFeeBps, BPS_MULTIPLIER);
984:                 _tokenCredit -= _feeDebit;
985:                 
986:                 baseFeeCollected += ((_feeDebit * (_takerFeeBps - makerFeeBps)) / _takerFeeBps);
987:             }
988:             if (msg.sender != address(0)) {
989:                 marginAccount.creditUsersEncoded(
990:                     bytes.concat(makerCredits, abi.encode(_msgSender(), baseAsset, _tokenCredit, _isMargin))
991:                 );
992:             }
993:             return (_quoteSize, _tokenCredit);
994:         }
995:     }
```
['[1003](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L1003-L1041)']
```solidity
1003:     function _matchAggressiveSell(uint256 _limitPrice, uint96 _sizeToBeFilledLeft, bool _useMargin)
1004:         internal
1005:         returns (uint96, uint256)
1006:     {
1007:         uint96 quoteCreditTaker;
1008:         uint256 quoteCreditVaultTaker;
1009:         uint256 tokenCredit;
1010:         (bool _isVaultFill, uint256 _bestBid) = bestBid(); // <= FOUND
1011:         bytes memory makerCredits;
1012:         uint32 _pricePrecision = pricePrecision;
1013:         _limitPrice = _limitPrice * vaultPricePrecision / _pricePrecision;
1014:         while (_sizeToBeFilledLeft > 0 && _bestBid >= _limitPrice && _bestBid != type(uint256).max) {
1015:             uint96 _sizeToBeFilledBefore = _sizeToBeFilledLeft; 
1016: 
1017:             bytes memory priceUpdate;
1018: 
1019:             if (_isVaultFill) {
1020:                 uint256 _quoteToTaker;
1021:                 (_sizeToBeFilledLeft, _quoteToTaker, priceUpdate) =
1022:                     _fillVaultForSell(_getOBBid() >= _limitPrice ? _getOBBid() : _limitPrice - 1, _sizeToBeFilledLeft);
1023:                 quoteCreditVaultTaker += _quoteToTaker;
1024:             } else {
1025:                 (_sizeToBeFilledLeft, priceUpdate) = _fillSizeForPrice(
1026:                     s_buyTree,
1027:                     toU32(_bestBid * _pricePrecision / vaultPricePrecision),
1028:                     s_buyPricePoints[_bestBid * _pricePrecision / vaultPricePrecision],
1029:                     _sizeToBeFilledLeft
1030:                 );
1031:                 quoteCreditTaker += toU96(
1032:                     FixedPointMathLib.mulDiv(
1033:                         _sizeToBeFilledBefore - _sizeToBeFilledLeft,
1034:                         toU32(_bestBid * _pricePrecision / vaultPricePrecision),
1035:                         sizePrecision
1036:                     )
1037:                 );
1038:             }
1039:             makerCredits = bytes.concat(makerCredits, priceUpdate);
1040: 
1041:             (_isVaultFill, _bestBid) = bestBid(); // <= FOUND
1042:         }
1043: 
1044:         if (quoteCreditTaker == 0 && quoteCreditVaultTaker == 0) {
1045:             return (_sizeToBeFilledLeft, 0);
1046:         }
1047:         {
1048:             uint256 _quoteDecimalMultiplier = quoteDecimalMultiplier;
1049:             tokenCredit = ((quoteCreditTaker) * _quoteDecimalMultiplier) / _pricePrecision
1050:                 + (quoteCreditVaultTaker * _quoteDecimalMultiplier) / vaultPricePrecision;
1051:             if (quoteCreditVaultTaker > 0 && msg.sender != address(0)) {
1052:                 marginAccount.debitUser(
1053:                     kuruAmmVault, quoteAsset, (quoteCreditVaultTaker * _quoteDecimalMultiplier) / vaultPricePrecision
1054:                 );
1055:             }
1056:             uint256 _takerFeeBps = takerFeeBps;
1057:             if (_takerFeeBps > 0) {
1058:                 uint256 _feeDebit = FixedPointMathLib.mulDivUp(tokenCredit, _takerFeeBps, BPS_MULTIPLIER);
1059:                 tokenCredit -= _feeDebit;
1060:                 
1061:                 quoteFeeCollected += ((_feeDebit * (_takerFeeBps - makerFeeBps)) / _takerFeeBps);
1062:             }
1063:             if (msg.sender != address(0)) {
1064:                 marginAccount.creditUsersEncoded(
1065:                     bytes.concat(makerCredits, abi.encode(_msgSender(), quoteAsset, tokenCredit, _useMargin))
1066:                 );
1067:             }
1068:         }
1069: 
1070:         return (_sizeToBeFilledLeft, tokenCredit);
1071:     }
```


</details>

## [Gas-3] Avoid updating storage when the value hasn't changed 

Num of instances: 7

### Findings 


<details><summary>Click to show findings</summary>

['[22](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/OrderLinkedList.sol#L22-L26)']
```solidity
22:     function insertAtTail(PricePoint storage point, uint40 orderId) internal returns (uint40) { // <= FOUND
23:         uint40 _pointTail = point.tail;
24:         if (_pointTail == NULL) {
25:             
26:             point.head = orderId; // <= FOUND
27:             point.tail = orderId;
28:         } else {
29:             point.tail = orderId;
30:         }
31: 
32:         return _pointTail;
33:     }
```
['[35](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/OrderLinkedList.sol#L35-L37)']
```solidity
35:     function adjustForTail(PricePoint storage point, uint40 prev, uint40 next) internal { // <= FOUND
36:         if (next == NULL) {
37:             point.tail = prev; // <= FOUND
38:         }
39:     }
```
['[46](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/OrderLinkedList.sol#L46-L48)']
```solidity
46:     function updateHead(PricePoint storage point, uint40 orderId) internal { // <= FOUND
47:         if (orderId == NULL) {
48:             point.head = NULL; // <= FOUND
49:             point.tail = NULL;
50:         }
51: 
52:         point.head = orderId;
53:     }
```
['[28](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/TreeMath.sol#L28-L31)']
```solidity
28:     function add(TreeUint32 storage tree, uint32 id) internal returns (bool) { // <= FOUND
29:         bytes32 key3 = bytes32(uint256(id) >> 8);
30: 
31:         bytes32 leaves = tree.level3[key3]; // <= FOUND
32:         bytes32 newLeaves = leaves | bytes32(1 << (id & type(uint8).max));
33: 
34:         if (leaves != newLeaves) {
35:             tree.level3[key3] = newLeaves;
36: 
37:             if (leaves == 0) {
38:                 bytes32 key2 = key3 >> 8;
39:                 leaves = tree.level2[key2];
40: 
41:                 tree.level2[key2] = leaves | bytes32(1 << (uint256(key3) & type(uint8).max));
42: 
43:                 if (leaves == 0) {
44:                     bytes32 key1 = key2 >> 8;
45:                     leaves = tree.level1[key1];
46: 
47:                     tree.level1[key1] = leaves | bytes32(1 << (uint256(key2) & type(uint8).max));
48: 
49:                     if (leaves == 0) {
50:                         tree.level0 |= bytes32(1 << (uint256(key1) & type(uint8).max));
51:                     }
52:                 }
53:             }
54: 
55:             return true;
56:         }
57: 
58:         return false;
59:     }
```
['[68](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/TreeMath.sol#L68-L71)']
```solidity
68:     function remove(TreeUint32 storage tree, uint32 id) internal returns (bool) { // <= FOUND
69:         bytes32 key3 = bytes32(uint256(id) >> 8);
70: 
71:         bytes32 leaves = tree.level3[key3]; // <= FOUND
72:         bytes32 newLeaves = leaves & ~bytes32(1 << (id & type(uint8).max));
73: 
74:         if (leaves != newLeaves) {
75:             tree.level3[key3] = newLeaves;
76: 
77:             if (newLeaves == 0) {
78:                 bytes32 key2 = key3 >> 8;
79:                 newLeaves = tree.level2[key2] & ~bytes32(1 << (uint256(key3) & type(uint8).max));
80: 
81:                 tree.level2[key2] = newLeaves;
82: 
83:                 if (newLeaves == 0) {
84:                     bytes32 key1 = key2 >> 8;
85:                     newLeaves = tree.level1[key1] & ~bytes32(1 << (uint256(key2) & type(uint8).max));
86: 
87:                     tree.level1[key1] = newLeaves;
88: 
89:                     if (newLeaves == 0) {
90:                         tree.level0 &= ~bytes32(1 << (uint256(key1) & type(uint8).max));
91:                     }
92:                 }
93:             }
94: 
95:             return true;
96:         }
97: 
98:         return false;
99:     }
```
['[108](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/TreeMath.sol#L108-L168)']
```solidity
108:     function findFirstRight(TreeUint32 storage tree, uint32 id) internal view returns (uint32) { // <= FOUND
109:         bytes32 leaves;
110: 
111:         bytes32 key3 = bytes32(uint256(id) >> 8);
112:         uint8 bit = uint8(id & type(uint8).max);
113: 
114:         if (bit != 0) {
115:             leaves = tree.level3[key3]; // <= FOUND
116:             uint256 closestBit = _closestBitRight(leaves, bit);
117: 
118:             if (closestBit != type(uint256).max) return uint32((uint256(key3) << 8) | closestBit);
119:         }
120: 
121:         bytes32 key2 = key3 >> 8;
122:         bit = uint8(uint256(key3) & type(uint8).max);
123: 
124:         if (bit != 0) {
125:             leaves = tree.level2[key2];
126:             uint256 closestBit = _closestBitRight(leaves, bit);
127: 
128:             if (closestBit != type(uint256).max) {
129:                 key3 = bytes32((uint256(key2) << 8) | closestBit);
130:                 leaves = tree.level3[key3]; // <= FOUND
131: 
132:                 return uint32((uint256(key3) << 8) | uint256(leaves).mostSignificantBit());
133:             }
134:         }
135: 
136:         bytes32 key1 = key2 >> 8;
137:         bit = uint8(uint256(key2) & type(uint8).max);
138: 
139:         if (bit != 0) {
140:             leaves = tree.level1[key1];
141:             uint256 closestBit = _closestBitRight(leaves, bit);
142: 
143:             if (closestBit != type(uint256).max) {
144:                 key2 = bytes32((uint256(key1) << 8) | closestBit);
145:                 leaves = tree.level2[key2];
146: 
147:                 key3 = bytes32((uint256(key2) << 8) | uint256(leaves).mostSignificantBit());
148:                 leaves = tree.level3[key3]; // <= FOUND
149: 
150:                 return uint32((uint256(key3) << 8) | uint256(leaves).mostSignificantBit());
151:             }
152:         }
153: 
154:         bit = uint8(uint256(key1) & type(uint8).max);
155: 
156:         if (bit != 0) {
157:             leaves = tree.level0;
158:             uint256 closestBit = _closestBitRight(leaves, bit);
159: 
160:             if (closestBit != type(uint256).max) {
161:                 key1 = bytes32(closestBit);
162:                 leaves = tree.level1[key1];
163: 
164:                 key2 = bytes32((uint256(key1) << 8) | uint256(leaves).mostSignificantBit());
165:                 leaves = tree.level2[key2];
166: 
167:                 key3 = bytes32((uint256(key2) << 8) | uint256(leaves).mostSignificantBit());
168:                 leaves = tree.level3[key3]; // <= FOUND
169: 
170:                 return uint32((uint256(key3) << 8) | uint256(leaves).mostSignificantBit());
171:             }
172:         }
173: 
174:         return type(uint32).max;
175:     }
```
['[184](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/TreeMath.sol#L184-L244)']
```solidity
184:     function findFirstLeft(TreeUint32 storage tree, uint32 id) internal view returns (uint32) { // <= FOUND
185:         bytes32 leaves;
186: 
187:         bytes32 key3 = bytes32(uint256(id) >> 8);
188:         uint8 bit = uint8(id & type(uint8).max);
189: 
190:         if (bit != type(uint8).max) {
191:             leaves = tree.level3[key3]; // <= FOUND
192:             uint256 closestBit = _closestBitLeft(leaves, bit);
193: 
194:             if (closestBit != type(uint256).max) return uint32((uint256(key3) << 8) | closestBit);
195:         }
196: 
197:         bytes32 key2 = key3 >> 8;
198:         bit = uint8(uint256(key3) & type(uint8).max);
199: 
200:         if (bit != type(uint8).max) {
201:             leaves = tree.level2[key2];
202:             uint256 closestBit = _closestBitLeft(leaves, bit);
203: 
204:             if (closestBit != type(uint256).max) {
205:                 key3 = bytes32((uint256(key2) << 8) | closestBit);
206:                 leaves = tree.level3[key3]; // <= FOUND
207: 
208:                 return uint32((uint256(key3) << 8) | uint256(leaves).leastSignificantBit());
209:             }
210:         }
211: 
212:         bytes32 key1 = key2 >> 8;
213:         bit = uint8(uint256(key2) & type(uint8).max);
214: 
215:         if (bit != type(uint8).max) {
216:             leaves = tree.level1[key1];
217:             uint256 closestBit = _closestBitLeft(leaves, bit);
218: 
219:             if (closestBit != type(uint256).max) {
220:                 key2 = bytes32((uint256(key1) << 8) | closestBit);
221:                 leaves = tree.level2[key2];
222: 
223:                 key3 = bytes32((uint256(key2) << 8) | uint256(leaves).leastSignificantBit());
224:                 leaves = tree.level3[key3]; // <= FOUND
225: 
226:                 return uint32((uint256(key3) << 8) | uint256(leaves).leastSignificantBit());
227:             }
228:         }
229: 
230:         bit = uint8(uint256(key1) & type(uint8).max);
231: 
232:         if (bit != type(uint8).max) {
233:             leaves = tree.level0;
234:             uint256 closestBit = _closestBitLeft(leaves, bit);
235: 
236:             if (closestBit != type(uint256).max) {
237:                 key1 = bytes32(closestBit);
238:                 leaves = tree.level1[key1];
239: 
240:                 key2 = bytes32((uint256(key1) << 8) | uint256(leaves).leastSignificantBit());
241:                 leaves = tree.level2[key2];
242: 
243:                 key3 = bytes32((uint256(key2) << 8) | uint256(leaves).leastSignificantBit());
244:                 leaves = tree.level3[key3]; // <= FOUND
245: 
246:                 return uint32((uint256(key3) << 8) | uint256(leaves).leastSignificantBit());
247:             }
248:         }
249: 
250:         return 0;
251:     }
```


</details>

## [Gas-4] Multiple accesses of the same mapping/array key/index should be cached 

### Resolution 
Caching repeated accesses to the same mapping or array key/index in smart contracts can lead to significant gas savings. In Solidity, each read operation from storage (like accessing a value in a mapping or array using a key or index) costs gas. By storing the accessed value in a local variable and reusing it within the function, you avoid multiple expensive storage read operations. This practice is particularly beneficial in loops or functions with multiple reads of the same data. Implementing this caching approach enhances efficiency and reduces transaction costs, which is crucial for optimizing smart contract performance and user experience on the blockchain.

Num of instances: 3

### Findings 


<details><summary>Click to show findings</summary>

['[531](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L531-L549)']
```solidity
531:     function _executeCancel(uint40 _orderId, Order memory _order) internal { // <= FOUND
532:         
533:         if (_order.prev != OrderLinkedList.NULL) {
534:             s_orders[_order.prev].next = _order.next;
535:         }
536:         if (_order.next != OrderLinkedList.NULL) {
537:             s_orders[_order.next].prev = _order.prev;
538:         }
539: 
540:         if (_order.isBuy) {
541:             
542:             if (_orderId == s_buyPricePoints[_order.price].head) { // <= FOUND
543:                 OrderLinkedList.updateHead(s_buyPricePoints[_order.price], _order.next); // <= FOUND
544:                 if (_order.next == OrderLinkedList.NULL) {
545:                     
546:                     TreeMath.remove(s_buyTree, _order.price);
547:                 }
548:             } else {
549:                 OrderLinkedList.adjustForTail(s_buyPricePoints[_order.price], _order.prev, _order.next); // <= FOUND
550:             }
551: 
552:             marginAccount.creditUser(
553:                 _order.ownerAddress,
554:                 quoteAsset,
555:                 (((toU96((_order.size * _order.price) / sizePrecision) * quoteDecimalMultiplier) / pricePrecision)),
556:                 true
557:             );
558:         } else {
559:             if (_orderId == s_sellPricePoints[_order.price].head) {
560:                 OrderLinkedList.updateHead(s_sellPricePoints[_order.price], _order.next);
561:                 if (_order.next == OrderLinkedList.NULL) {
562:                     
563:                     TreeMath.remove(s_sellTree, _order.price);
564:                 }
565:             } else {
566:                 OrderLinkedList.adjustForTail(s_sellPricePoints[_order.price], _order.prev, _order.next);
567:             }
568: 
569:             marginAccount.creditUser(
570:                 _order.ownerAddress, baseAsset, ((_order.size * baseDecimalMultiplier) / sizePrecision), true
571:             );
572:         }
573: 
574:         emit OrderCanceled(_orderId, _order.ownerAddress, _order.price, _order.size, _order.isBuy);
575:     }
```
['[1118](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L1118-L1145)']
```solidity
1118:     function _fillOrder(uint40 _orderId, uint96 _incomingSizeToBeFilled) // <= FOUND
1119:         internal
1120:         returns (uint96 incomingOrderRemainingSize, uint40 _nextHead, bytes memory _orderUpdate)
1121:     {
1122:         _nextHead = s_orders[_orderId].next;
1123:         uint96 _preExistingOrderSize = s_orders[_orderId].size; // <= FOUND
1124:         
1125:         incomingOrderRemainingSize =
1126:             (_incomingSizeToBeFilled > _preExistingOrderSize) ? (_incomingSizeToBeFilled - _preExistingOrderSize) : 0;
1127:         uint96 _preExistingOrderUpdatedSize;
1128:         if (incomingOrderRemainingSize == 0) {
1129:             
1130:             _preExistingOrderUpdatedSize = _preExistingOrderSize - _incomingSizeToBeFilled;
1131:         }
1132:         if (s_orders[_orderId].flippedPrice == 0) {
1133:             _orderUpdate = _creditMaker(
1134:                 !s_orders[_orderId].isBuy,
1135:                 s_orders[_orderId].ownerAddress,
1136:                 (incomingOrderRemainingSize == 0) ? _incomingSizeToBeFilled : s_orders[_orderId].size, // <= FOUND
1137:                 s_orders[_orderId].price
1138:             );
1139:         }
1140: 
1141:         if (incomingOrderRemainingSize == 0) {
1142:             if (_preExistingOrderUpdatedSize != 0) {
1143:                 _nextHead = _orderId;
1144:             }
1145:             s_orders[_orderId].size = _preExistingOrderUpdatedSize; // <= FOUND
1146:         }
1147: 
1148:         if (s_orders[_orderId].flippedPrice != 0) {
1149:             _handleFlipOrderUpdate(
1150:                 _orderId,
1151:                 _incomingSizeToBeFilled - incomingOrderRemainingSize,
1152:                 _preExistingOrderUpdatedSize == 0 ? true : false
1153:             );
1154:         }
1155:         
1156:         _emitTrade(
1157:             _orderId,
1158:             s_orders[_orderId].ownerAddress,
1159:             !s_orders[_orderId].isBuy,
1160:             (s_orders[_orderId].price * vaultPricePrecision) / pricePrecision,
1161:             _preExistingOrderUpdatedSize,
1162:             _incomingSizeToBeFilled - incomingOrderRemainingSize
1163:         );
1164:     }
```
['[1166](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L1166-L1195)']
```solidity
1166:     function _handleFlipOrderUpdate(uint40 _orderId, uint96 _size, bool nullify) internal { // <= FOUND
1167:         
1168:         if (s_orders[_orderId].flippedId == OrderLinkedList.NULL) { // <= FOUND
1169:             Order memory _filledOrder = s_orders[_orderId];
1170:             
1171:             uint40 _flipOrderId = s_orderIdCounter + 1;
1172:             s_orderIdCounter = _flipOrderId;
1173:             uint40 _prevOrderId;
1174:             if (!s_orders[_orderId].isBuy) {
1175:                 _size = toU96(FixedPointMathLib.mulDiv(_size, _filledOrder.price, _filledOrder.flippedPrice));
1176:                 _prevOrderId = OrderLinkedList.insertAtTail(s_buyPricePoints[_filledOrder.flippedPrice], _flipOrderId);
1177:             } else {
1178:                 _prevOrderId = OrderLinkedList.insertAtTail(s_sellPricePoints[_filledOrder.flippedPrice], _flipOrderId);
1179:             }
1180:             if (!nullify) {
1181:                 s_orders[_orderId].flippedId = _flipOrderId; // <= FOUND
1182:             }
1183:             _addFlippedOrder(
1184:                 _filledOrder.flippedPrice,
1185:                 _filledOrder.price,
1186:                 _size,
1187:                 _filledOrder.ownerAddress,
1188:                 _flipOrderId,
1189:                 nullify ? OrderLinkedList.NULL : _orderId,
1190:                 !_filledOrder.isBuy,
1191:                 _prevOrderId
1192:             );
1193:         } else {
1194:             
1195:             uint40 _flipOrderId = s_orders[_orderId].flippedId; // <= FOUND
1196:             if (!s_orders[_orderId].isBuy) {
1197:                 _size =
1198:                     toU96(FixedPointMathLib.mulDiv(_size, s_orders[_orderId].price, s_orders[_orderId].flippedPrice));
1199:             }
1200:             uint96 _updatedSize = s_orders[_flipOrderId].size + _size;
1201:             s_orders[_flipOrderId].size = _updatedSize;
1202:             emit FlipOrderUpdated(_flipOrderId, _updatedSize);
1203:             if (nullify) {
1204:                 s_orders[_flipOrderId].flippedId = OrderLinkedList.NULL;
1205:             }
1206:         }
1207:     }
```


</details>

## [Gas-5] Shortcircuit rules can be be used to optimize some gas usage 

### Resolution 
Reading state variables takes alot of gas to do, so if you have a conditional statement regarding a state varaible alongide others which are not related to state vars, it is advisable to have conditions which do not involve state vars be declared first in the overall conditional so unnecessary state variable lookups can be avoided.

Num of instances: 6

### Findings 


<details><summary>Click to show findings</summary>

['[217](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L217-L217)']
```solidity
217:             if ((uint256(_price) * vaultPricePrecision / pricePrecision) >= _bestAsk && _bestAsk != 0) {
```
['[287](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L287-L287)']
```solidity
287:             if ((uint256(_price) * vaultPricePrecision / pricePrecision) <= _bestBid && _bestBid != type(uint256).max) {
```
['[738](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L738-L738)']
```solidity
738:         if (_type == OrderBookType.NATIVE_IN_QUOTE && !_isMargin && (msg.sender != address(0))) {
```
['[761](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L761-L761)']
```solidity
761:             if (_type == OrderBookType.NATIVE_IN_QUOTE && !_isMargin) {
```
['[794](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L794-L794)']
```solidity
794:         if (_type == OrderBookType.NATIVE_IN_BASE && !_isMargin && (msg.sender != address(0))) {
```
['[813](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L813-L813)']
```solidity
813:             if (_type == OrderBookType.NATIVE_IN_BASE && !_isMargin) {
```


</details>

## [Gas-6] x + y is more efficient than using += for state variables (likewise for -=)

### Resolution 
In instances found where either += or -= are used against state variables use x = x + y instead

Num of instances: 6

### Findings 


<details><summary>Click to show findings</summary>

['[1003](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L1003-L1061)']
```solidity
1003:     function _matchAggressiveSell(uint256 _limitPrice, uint96 _sizeToBeFilledLeft, bool _useMargin)
1004:         internal
1005:         returns (uint96, uint256)
1006:     {
1007:         uint96 quoteCreditTaker;
1008:         uint256 quoteCreditVaultTaker;
1009:         uint256 tokenCredit;
1010:         (bool _isVaultFill, uint256 _bestBid) = bestBid();
1011:         bytes memory makerCredits;
1012:         uint32 _pricePrecision = pricePrecision;
1013:         _limitPrice = _limitPrice * vaultPricePrecision / _pricePrecision;
1014:         while (_sizeToBeFilledLeft > 0 && _bestBid >= _limitPrice && _bestBid != type(uint256).max) {
1015:             uint96 _sizeToBeFilledBefore = _sizeToBeFilledLeft; 
1016: 
1017:             bytes memory priceUpdate;
1018: 
1019:             if (_isVaultFill) {
1020:                 uint256 _quoteToTaker;
1021:                 (_sizeToBeFilledLeft, _quoteToTaker, priceUpdate) =
1022:                     _fillVaultForSell(_getOBBid() >= _limitPrice ? _getOBBid() : _limitPrice - 1, _sizeToBeFilledLeft);
1023:                 quoteCreditVaultTaker += _quoteToTaker;
1024:             } else {
1025:                 (_sizeToBeFilledLeft, priceUpdate) = _fillSizeForPrice(
1026:                     s_buyTree,
1027:                     toU32(_bestBid * _pricePrecision / vaultPricePrecision),
1028:                     s_buyPricePoints[_bestBid * _pricePrecision / vaultPricePrecision],
1029:                     _sizeToBeFilledLeft
1030:                 );
1031:                 quoteCreditTaker += toU96(
1032:                     FixedPointMathLib.mulDiv(
1033:                         _sizeToBeFilledBefore - _sizeToBeFilledLeft,
1034:                         toU32(_bestBid * _pricePrecision / vaultPricePrecision),
1035:                         sizePrecision
1036:                     )
1037:                 );
1038:             }
1039:             makerCredits = bytes.concat(makerCredits, priceUpdate);
1040: 
1041:             (_isVaultFill, _bestBid) = bestBid();
1042:         }
1043: 
1044:         if (quoteCreditTaker == 0 && quoteCreditVaultTaker == 0) {
1045:             return (_sizeToBeFilledLeft, 0);
1046:         }
1047:         {
1048:             uint256 _quoteDecimalMultiplier = quoteDecimalMultiplier;
1049:             tokenCredit = ((quoteCreditTaker) * _quoteDecimalMultiplier) / _pricePrecision
1050:                 + (quoteCreditVaultTaker * _quoteDecimalMultiplier) / vaultPricePrecision;
1051:             if (quoteCreditVaultTaker > 0 && msg.sender != address(0)) {
1052:                 marginAccount.debitUser(
1053:                     kuruAmmVault, quoteAsset, (quoteCreditVaultTaker * _quoteDecimalMultiplier) / vaultPricePrecision
1054:                 );
1055:             }
1056:             uint256 _takerFeeBps = takerFeeBps;
1057:             if (_takerFeeBps > 0) {
1058:                 uint256 _feeDebit = FixedPointMathLib.mulDivUp(tokenCredit, _takerFeeBps, BPS_MULTIPLIER);
1059:                 tokenCredit -= _feeDebit;
1060:                 
1061:                 quoteFeeCollected += ((_feeDebit * (_takerFeeBps - makerFeeBps)) / _takerFeeBps); // <= FOUND
1062:             }
1063:             if (msg.sender != address(0)) {
1064:                 marginAccount.creditUsersEncoded(
1065:                     bytes.concat(makerCredits, abi.encode(_msgSender(), quoteAsset, tokenCredit, _useMargin))
1066:                 );
1067:             }
1068:         }
1069: 
1070:         return (_sizeToBeFilledLeft, tokenCredit);
1071:     }
```
['[855](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L855-L916)']
```solidity
855:     function _matchAggressiveBuyWithCap(uint256 _limitPrice, uint96 _sizeToBeFilled)
856:         internal
857:         returns (uint96, uint96)
858:     {
859:         uint96 sizeToCreditTaker;
860:         uint96 sizeToCreditViaVault;
861:         uint96 fundsConsumed;
862:         bytes memory makerCredits;
863:         (bool _isVaultFill, uint256 _bestAsk) = bestAsk();
864:         uint32 _pricePrecision = pricePrecision;
865:         _limitPrice = _limitPrice * vaultPricePrecision / _pricePrecision;
866: 
867:         while (_sizeToBeFilled > 0 && _bestAsk <= _limitPrice && _bestAsk != 0) {
868:             uint96 sizeToBeFilledBefore = _sizeToBeFilled; 
869:             bytes memory priceUpdate;
870: 
871:             if (_isVaultFill) {
872:                 uint96 _vaultFundsConsumed;
873:                 (_sizeToBeFilled, _vaultFundsConsumed, priceUpdate) =
874:                     _fillVaultForBuy(_getOBAsk() > _limitPrice ? _limitPrice + 1 : _getOBAsk(), _sizeToBeFilled);
875:                 fundsConsumed += _vaultFundsConsumed;
876:             } else {
877:                 (_sizeToBeFilled, priceUpdate) = _fillSizeForPrice(
878:                     s_sellTree,
879:                     toU32(_bestAsk * _pricePrecision / vaultPricePrecision),
880:                     s_sellPricePoints[_bestAsk * _pricePrecision / vaultPricePrecision],
881:                     _sizeToBeFilled
882:                 );
883:             }
884: 
885:             uint96 sizeFilled = sizeToBeFilledBefore - _sizeToBeFilled;
886:             sizeToCreditTaker += sizeFilled;
887:             if (_isVaultFill) {
888:                 sizeToCreditViaVault += sizeFilled;
889:             } else {
890:                 fundsConsumed += _quoteAmountRoundedUp(
891:                     toU32(FixedPointMathLib.mulDivUp(_bestAsk, _pricePrecision, vaultPricePrecision)), sizeFilled
892:                 );
893:             }
894:             makerCredits = bytes.concat(makerCredits, priceUpdate);
895: 
896:             (_isVaultFill, _bestAsk) = bestAsk();
897:         }
898: 
899:         if (sizeToCreditTaker == 0) {
900:             return (_sizeToBeFilled, 0);
901:         }
902:         {
903:             uint96 _sizePrecision = sizePrecision;
904:             uint256 _baseDecimalMultiplier = baseDecimalMultiplier;
905:             uint256 _tokenCredit = (sizeToCreditTaker * _baseDecimalMultiplier) / _sizePrecision;
906:             if (sizeToCreditViaVault > 0) {
907:                 marginAccount.debitUser(
908:                     kuruAmmVault, baseAsset, (sizeToCreditViaVault * _baseDecimalMultiplier) / _sizePrecision
909:                 );
910:             }
911:             uint256 _takerFeeBps = takerFeeBps;
912:             if (_takerFeeBps > 0) {
913:                 uint256 _feeDebit = FixedPointMathLib.mulDivUp(_tokenCredit, _takerFeeBps, BPS_MULTIPLIER);
914:                 _tokenCredit -= _feeDebit;
915:                 
916:                 baseFeeCollected += ((_feeDebit * (_takerFeeBps - makerFeeBps)) / _takerFeeBps); // <= FOUND
917:             }
918:             marginAccount.creditUsersEncoded(
919:                 bytes.concat(makerCredits, abi.encode(_msgSender(), baseAsset, _tokenCredit, true))
920:             );
921:         }
922: 
923:         return (_sizeToBeFilled, fundsConsumed);
924:     }
```
['[930](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L930-L986)']
```solidity
930:     function _marketBuyMatch(uint96 _quoteSize, bool _isMargin) internal returns (uint96, uint256) {
931:         uint96 sizeToCreditTaker;
932:         uint96 sizeToCreditViaVault;
933:         bytes memory makerCredits;
934:         uint32 _pricePrecision = pricePrecision;
935:         uint96 _sizePrecision = sizePrecision;
936: 
937:         (bool _isVaultFill, uint256 _bestAsk) = bestAsk();
938: 
939:         while (_quoteSize > 0 && _bestAsk != 0) {
940:             bytes memory priceUpdate;
941:             if (_isVaultFill) {
942:                 uint96 _sizeFilled;
943:                 (_quoteSize, _sizeFilled, priceUpdate) = _fillVaultBuyMatch(_getOBAsk(), _quoteSize);
944:                 sizeToCreditViaVault += _sizeFilled;
945:                 sizeToCreditTaker += _sizeFilled;
946:             } else {
947:                 
948:                 uint96 _sizeFillableAtPriceLeft =
949:                     toU96(_quoteSize * _sizePrecision * vaultPricePrecision / (_bestAsk * _pricePrecision));
950:                 uint96 _sizeFillableAtPriceBefore = _sizeFillableAtPriceLeft; 
951:                 (_sizeFillableAtPriceLeft, priceUpdate) = _fillSizeForPrice(
952:                     s_sellTree,
953:                     toU32(_bestAsk * _pricePrecision / vaultPricePrecision),
954:                     s_sellPricePoints[(_bestAsk * _pricePrecision / vaultPricePrecision)],
955:                     _sizeFillableAtPriceLeft
956:                 );
957:                 sizeToCreditTaker += (_sizeFillableAtPriceBefore - _sizeFillableAtPriceLeft);
958:                 _quoteSize = toU96(
959:                     FixedPointMathLib.mulDiv(
960:                         _bestAsk * _pricePrecision, _sizeFillableAtPriceLeft, _sizePrecision * vaultPricePrecision
961:                     )
962:                 );
963:             }
964:             makerCredits = bytes.concat(makerCredits, priceUpdate);
965: 
966:             (_isVaultFill, _bestAsk) = bestAsk();
967:         }
968: 
969:         if (sizeToCreditTaker == 0) {
970:             return (_quoteSize, 0);
971:         }
972: 
973:         {
974:             uint256 _baseDecimalMultiplier = baseDecimalMultiplier;
975:             uint256 _tokenCredit = (sizeToCreditTaker * _baseDecimalMultiplier) / _sizePrecision;
976:             if (sizeToCreditViaVault > 0 && msg.sender != address(0)) {
977:                 marginAccount.debitUser(
978:                     kuruAmmVault, baseAsset, (sizeToCreditViaVault * _baseDecimalMultiplier) / _sizePrecision
979:                 );
980:             }
981:             uint256 _takerFeeBps = takerFeeBps;
982:             if (_takerFeeBps > 0) {
983:                 uint256 _feeDebit = FixedPointMathLib.mulDivUp(_tokenCredit, _takerFeeBps, BPS_MULTIPLIER);
984:                 _tokenCredit -= _feeDebit;
985:                 
986:                 baseFeeCollected += ((_feeDebit * (_takerFeeBps - makerFeeBps)) / _takerFeeBps); // <= FOUND
987:             }
988:             if (msg.sender != address(0)) {
989:                 marginAccount.creditUsersEncoded(
990:                     bytes.concat(makerCredits, abi.encode(_msgSender(), baseAsset, _tokenCredit, _isMargin))
991:                 );
992:             }
993:             return (_quoteSize, _tokenCredit);
994:         }
995:     }
```
['[187](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/AbstractAMM.sol#L187-L201)']
```solidity
187:     function _fillVaultForSell(uint256 _breakPoint, uint96 _size)
188:         internal
189:         returns (uint96 sizeLeft, uint256 quoteOwedToUser, bytes memory makerCredits)
190:     {
191:         uint256 _price = vaultBestBid;
192:         uint96 _availableSize = vaultBidOrderSize - bidPartiallyFilledSize;
193:         uint96 _cachedLastVaultSize = vaultBidOrderSize;
194:         sizeLeft = _size;
195:         if (sizeLeft >= _availableSize) {
196:             bidPartiallyFilledSize = 0;
197:         }
198: 
199:         while (_price > _breakPoint && sizeLeft > 0) {
200:             if (_availableSize > sizeLeft) {
201:                 bidPartiallyFilledSize += sizeLeft; // <= FOUND
202:                 quoteOwedToUser += FixedPointMathLib.mulDiv(_price, sizeLeft, _getSizePrecision());
203:                 _emitTrade(0, kuruAmmVault, false, _price, _availableSize - sizeLeft, sizeLeft);
204:                 sizeLeft = 0;
205:                 break;
206:             } else {
207:                 sizeLeft -= _availableSize;
208:                 quoteOwedToUser += FixedPointMathLib.mulDiv(_price, _availableSize, _getSizePrecision());
209:                 _cachedLastVaultSize = toU96(
210:                     FixedPointMathLib.mulDiv(
211:                         _cachedLastVaultSize, DOUBLE_BPS_MULTIPLIER + SPREAD_CONSTANT, DOUBLE_BPS_MULTIPLIER
212:                     )
213:                 );
214:                 _emitTrade(0, kuruAmmVault, false, _price, 0, _availableSize);
215:                 _availableSize = _cachedLastVaultSize;
216:                 _price = FixedPointMathLib.mulDivRound(_price, BPS_MULTIPLIER, BPS_MULTIPLIER + SPREAD_CONSTANT);
217:             }
218:         }
219:         if (_price != vaultBestBid) {
220:             vaultBestBid = _price;
221:             vaultBestAsk = FixedPointMathLib.mulDivRound(_price, BPS_MULTIPLIER + SPREAD_CONSTANT, BPS_MULTIPLIER);
222:             vaultBidOrderSize = _cachedLastVaultSize;
223:             vaultAskOrderSize = toU96(
224:                 FixedPointMathLib.mulDiv(
225:                     _cachedLastVaultSize, DOUBLE_BPS_MULTIPLIER, DOUBLE_BPS_MULTIPLIER + SPREAD_CONSTANT
226:                 )
227:             );
228:         }
229:         makerCredits = _creditVaultOnMarketSell(_size - sizeLeft, quoteOwedToUser);
230:     }
```
['[59](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/AbstractAMM.sol#L59-L78)']
```solidity
59:     function _fillVaultBuyMatch(uint256 _breakPoint, uint96 _quoteSize)
60:         internal
61:         returns (uint96 quoteLeft, uint96 sizeFilled, bytes memory makerCredits)
62:     {
63:         uint256 _price = vaultBestAsk;
64:         uint256 _quoteInput = _quoteSize * vaultPricePrecision / _getPricePrecision();
65:         uint96 _cachedLastVaultSize = vaultAskOrderSize;
66:         uint96 _cachedPartiallyFilledBid = bidPartiallyFilledSize;
67:         uint96 _availableSize = _cachedLastVaultSize - askPartiallyFilledSize;
68:         
69:         if (_quoteInput >= FixedPointMathLib.mulDivUp(_price, _availableSize, _getSizePrecision())) {
70:             askPartiallyFilledSize = 0;
71:         }
72: 
73:         while (_price < _breakPoint && _quoteInput > 0) {
74:             uint256 _quoteNeededForFill = FixedPointMathLib.mulDivUp(_price, _availableSize, _getSizePrecision());
75:             if (_quoteNeededForFill > _quoteInput) {
76:                 uint96 _sizeFilledAtPrice = toU96(_quoteInput * _getSizePrecision() / _price);
77:                 sizeFilled += _sizeFilledAtPrice;
78:                 askPartiallyFilledSize += _sizeFilledAtPrice; // <= FOUND
79:                 _emitTrade(0, kuruAmmVault, true, _price, _availableSize - _sizeFilledAtPrice, _sizeFilledAtPrice);
80:                 _quoteInput = 0;
81:                 break;
82:             } else {
83:                 sizeFilled += _availableSize;
84:                 _quoteInput -= _quoteNeededForFill;
85:                 _cachedLastVaultSize = toU96(
86:                     FixedPointMathLib.mulDiv(
87:                         _cachedLastVaultSize, DOUBLE_BPS_MULTIPLIER, DOUBLE_BPS_MULTIPLIER + SPREAD_CONSTANT
88:                     )
89:                 );
90:                 _emitTrade(0, kuruAmmVault, true, _price, 0, _availableSize);
91:                 _availableSize = _cachedLastVaultSize;
92:                 _price = FixedPointMathLib.mulDivRound(_price, BPS_MULTIPLIER + SPREAD_CONSTANT, BPS_MULTIPLIER);
93:                 _cachedPartiallyFilledBid = toU96(
94:                     FixedPointMathLib.mulDiv(
95:                         _cachedPartiallyFilledBid, BPS_MULTIPLIER, BPS_MULTIPLIER + SPREAD_CONSTANT
96:                     )
97:                 );
98:             }
99:         }
100:         if (_price != vaultBestAsk) {
101:             vaultBestAsk = _price;
102:             vaultBestBid = FixedPointMathLib.mulDivRound(_price, BPS_MULTIPLIER, BPS_MULTIPLIER + SPREAD_CONSTANT);
103:             vaultAskOrderSize = _cachedLastVaultSize;
104:             vaultBidOrderSize = toU96(
105:                 FixedPointMathLib.mulDiv(
106:                     _cachedLastVaultSize, DOUBLE_BPS_MULTIPLIER + SPREAD_CONSTANT, DOUBLE_BPS_MULTIPLIER
107:                 )
108:             );
109:         }
110:         bidPartiallyFilledSize = _cachedPartiallyFilledBid;
111:         quoteLeft = toU96(FixedPointMathLib.mulDiv(_quoteInput, _getPricePrecision(), vaultPricePrecision));
112:         makerCredits =
113:             _creditVaultOnMarketBuy(sizeFilled, (_quoteSize * vaultPricePrecision / _getPricePrecision() - _quoteInput));
114:     }
```
['[124](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/AbstractAMM.sol#L124-L141)']
```solidity
124:     function _fillVaultForBuy(uint256 _breakPoint, uint96 _size)
125:         internal
126:         returns (uint96 sizeLeft, uint96 fundsConsumed, bytes memory makerCredits)
127:     {
128:         uint256 _price = vaultBestAsk;
129:         sizeLeft = _size;
130: 
131:         uint96 _cachedLastVaultSize = vaultAskOrderSize;
132:         uint96 _cachedPartiallyFilledBid = bidPartiallyFilledSize;
133:         
134:         uint256 _consumedQuote;
135:         uint96 _availableSize = _cachedLastVaultSize - askPartiallyFilledSize;
136:         if (_availableSize <= sizeLeft) {
137:             askPartiallyFilledSize = 0;
138:         }
139:         while (_price < _breakPoint && sizeLeft > 0) {
140:             if (_availableSize > sizeLeft) {
141:                 askPartiallyFilledSize += sizeLeft; // <= FOUND
142:                 _consumedQuote += FixedPointMathLib.mulDivUp(sizeLeft, _price, _getSizePrecision());
143:                 _emitTrade(0, kuruAmmVault, true, _price, _availableSize - sizeLeft, sizeLeft);
144:                 sizeLeft = 0;
145:                 break;
146:             } else {
147:                 sizeLeft -= _availableSize;
148:                 _consumedQuote += FixedPointMathLib.mulDivUp(_availableSize, _price, _getSizePrecision());
149:                 _cachedLastVaultSize = toU96(
150:                     FixedPointMathLib.mulDiv(
151:                         _cachedLastVaultSize, DOUBLE_BPS_MULTIPLIER, DOUBLE_BPS_MULTIPLIER + SPREAD_CONSTANT
152:                     )
153:                 );
154:                 _emitTrade(0, kuruAmmVault, true, _price, 0, _availableSize);
155:                 _availableSize = _cachedLastVaultSize;
156:                 _price = FixedPointMathLib.mulDivRound(_price, BPS_MULTIPLIER + SPREAD_CONSTANT, BPS_MULTIPLIER);
157:                 _cachedPartiallyFilledBid = toU96(
158:                     FixedPointMathLib.mulDiv(
159:                         _cachedPartiallyFilledBid, BPS_MULTIPLIER, BPS_MULTIPLIER + SPREAD_CONSTANT
160:                     )
161:                 );
162:             }
163:         }
164:         if (_price != vaultBestAsk) {
165:             vaultBestAsk = _price;
166:             vaultBestBid = FixedPointMathLib.mulDivRound(_price, BPS_MULTIPLIER, BPS_MULTIPLIER + SPREAD_CONSTANT);
167:             vaultAskOrderSize = _cachedLastVaultSize;
168:             vaultBidOrderSize = toU96(
169:                 FixedPointMathLib.mulDiv(
170:                     _cachedLastVaultSize, DOUBLE_BPS_MULTIPLIER + SPREAD_CONSTANT, DOUBLE_BPS_MULTIPLIER
171:                 )
172:             );
173:         }
174:         bidPartiallyFilledSize = _cachedPartiallyFilledBid;
175:         fundsConsumed = toU96(FixedPointMathLib.mulDivUp(_consumedQuote, _getPricePrecision(), vaultPricePrecision));
176:         makerCredits = _creditVaultOnMarketBuy(_size - sizeLeft, _consumedQuote);
177:     }
```


</details>

## [Gas-7] Public functions not used internally can be marked as external to save gas

### Resolution 
Public functions that aren't used internally in Solidity contracts should be made external to optimize gas usage and improve contract efficiency. External functions can only be called from outside the contract, and their arguments are directly read from the calldata, which is more gas-efficient than loading them into memory, as is the case for public functions. By using external visibility, developers can reduce gas consumption for external calls and ensure that the contract operates more cost-effectively for users. Moreover, setting the appropriate visibility level for functions also enhances code readability and maintainability, promoting a more secure and well-structured contract design.

Num of instances: 10

### Findings 


<details><summary>Click to show findings</summary>

['[126](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruForwarder.sol#L126-L126)']
```solidity
126:     function getNonce(address from) public view returns (uint256) 
```
['[219](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruForwarder.sol#L219-L219)']
```solidity
219:     function executeMarginAccountRequest(MarginAccountRequest calldata req, bytes calldata signature)
220:         public
221:         payable
222:         returns (bytes memory)
223:     
```
['[240](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruForwarder.sol#L240-L240)']
```solidity
240:     function execute(ForwardRequest calldata req, bytes calldata signature) public payable returns (bytes memory) 
```
['[257](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruForwarder.sol#L257-L257)']
```solidity
257:     function executePriceDependent(PriceDependentRequest calldata req, bytes calldata signature)
258:         public
259:         payable
260:         returns (bytes memory)
261:     
```
['[282](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruForwarder.sol#L282-L282)']
```solidity
282:     function cancelPriceDependent(CancelPriceDependentRequest calldata req, bytes calldata signature) public 
```
['[728](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L728-L728)']
```solidity
728:     function placeAndExecuteMarketBuy(uint96 _quoteSize, uint256 _minAmountOut, bool _isMargin, bool _isFillOrKill)
729:         public
730:         payable
731:         override
732:         marketActive
733:         nonReentrant
734:         returns (uint256)
735:     
```
['[786](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L786-L786)']
```solidity
786:     function placeAndExecuteMarketSell(uint96 _size, uint256 _minAmountOut, bool _isMargin, bool _isFillOrKill)
787:         public
788:         payable
789:         marketActive
790:         nonReentrant
791:         returns (uint256)
792:     
```
['[229](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L229-L229)']
```solidity
229:     function computeVaultAddress(address _marketAddress, address oldImplementation, bool old)
230:         public
231:         view
232:         returns (address)
233:     
```
['[281](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L281-L281)']
```solidity
281:     function upgradeMultipleOrderBookProxies(address[] memory proxies, bytes[] memory data) public onlyOwner 
```
['[287](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L287-L287)']
```solidity
287:     function upgradeMultipleVaultProxies(address[] memory proxies, bytes[] memory data) public onlyOwner 
```


</details>

## [Gas-8] Calldata should be used in place of memory function parameters when not mutated

### Resolution 
In Solidity, `calldata` should be used in place of `memory` for function parameters when the function is `external`. This is because `calldata` is a non-modifiable, non-persistent area where function arguments are stored, and it's cheaper in terms of gas than `memory`. It's especially efficient for arrays and complex data types. `calldata` provides a gas-efficient way to pass data in external function calls, whereas `memory` is a temporary space that's erased between external function calls. This distinction is crucial for optimizing smart contracts for gas usage and performance.

Num of instances: 3

### Findings 


<details><summary>Click to show findings</summary>

['[96](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruForwarder.sol#L96-L96)']
```solidity
96:     function initialize(address _owner, bytes4[] memory _allowedInterfaces) public initializer { // <= FOUND
97:         _initializeOwner(_owner);
98:         for (uint256 i = 0; i < _allowedInterfaces.length; i++) {
99:             allowedInterface[_allowedInterfaces[i]] = true;
100:         }
101:     }
```
['[105](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruForwarder.sol#L105-L105)']
```solidity
105:     function setAllowedInterfaces(bytes4[] memory _allowedInterfaces) external onlyOwner { // <= FOUND
106:         for (uint256 i = 0; i < _allowedInterfaces.length; i++) {
107:             allowedInterface[_allowedInterfaces[i]] = true;
108:         }
109:     }
```
['[111](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruForwarder.sol#L111-L111)']
```solidity
111:     function removeAllowedInterfaces(bytes4[] memory _allowedInterfaces) external onlyOwner { // <= FOUND
112:         for (uint256 i = 0; i < _allowedInterfaces.length; i++) {
113:             allowedInterface[_allowedInterfaces[i]] = false;
114:         }
115:     }
```


</details>

## [Gas-9] Usage of smaller uint/int types causes overhead

### Resolution 
When using a smaller int/uint type it first needs to be converted to it's 256 bit counterpart to be operated, this increases the gas cost and thus should be avoided. However it does make sense to use smaller int/uint values within structs provided you pack the struct properly.

Num of instances: 171

### Findings 


<details><summary>Click to show findings</summary>

['[112](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/TreeMath.sol#L112-L112)']
```solidity
112:         uint8 bit = uint8(id & type(uint8).max); // <= FOUND
```
['[260](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/TreeMath.sol#L260-L267)']
```solidity
260:     
267:     function _closestBitRight(bytes32 leaves, uint8 bit) private pure returns (uint256) { // <= FOUND
```
['[273](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/TreeMath.sol#L273-L280)']
```solidity
273:     
280:     function _closestBitLeft(bytes32 leaves, uint8 bit) private pure returns (uint256) { // <= FOUND
```
['[331](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/AbstractAMM.sol#L331-L331)']
```solidity
331:     function toU32(uint256 _from) internal pure returns (uint32 _to) { // <= FOUND
```
['[25](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/periphery/MonadDeployer.sol#L25-L25)']
```solidity
25:         uint32 pricePrecision; // <= FOUND
```
['[26](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/periphery/MonadDeployer.sol#L26-L26)']
```solidity
26:         uint32 tickSize; // <= FOUND
```
['[24](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/interfaces/IOrderBook.sol#L24-L24)']
```solidity
24:         uint32 price; // <= FOUND
```
['[25](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/interfaces/IOrderBook.sol#L25-L25)']
```solidity
25:         uint32 flippedPrice; // <= FOUND
```
['[39](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/interfaces/IOrderBook.sol#L39-L47)']
```solidity
39:     
47:     event OrderCreated(uint40 orderId, address owner, uint96 size, uint32 price, bool isBuy); // <= FOUND
```
['[51](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/interfaces/IOrderBook.sol#L51-L62)']
```solidity
51:     
61:     event FlipOrderCreated(
62:         uint40 orderId, uint40 flippedId, address owner, uint96 size, uint32 price, uint32 flippedPrice, bool isBuy // <= FOUND
63:     );
```
['[65](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/interfaces/IOrderBook.sol#L65-L76)']
```solidity
65:     
75:     event FlippedOrderCreated(
76:         uint40 orderId, uint40 flippedId, address owner, uint96 size, uint32 price, uint32 flippedPrice, bool isBuy // <= FOUND
77:     );
```
['[92](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/interfaces/IOrderBook.sol#L92-L95)']
```solidity
92:     
95:     event OrderCanceled(uint40 orderId, address owner, uint32 price, uint96 size, bool isBuy); // <= FOUND
```
['[132](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/interfaces/IOrderBook.sol#L132-L148)']
```solidity
132:     function initialize(
133:         address _factory,
134:         OrderBookType _type,
135:         address _baseAssetAddress,
136:         uint256 _baseAssetDecimals,
137:         address _quoteAssetAddress,
138:         uint256 _quoteAssetDecimals,
139:         address _marginAccountAddress,
140:         uint96 _sizePrecision, // <= FOUND
141:         uint32 _pricePrecision, // <= FOUND
142:         uint32 _tickSize, // <= FOUND
143:         uint96 _minSize, // <= FOUND
144:         uint96 _maxSize, // <= FOUND
145:         uint256 _takerFeeBps,
146:         uint256 _makerFeeBps,
147:         address _kuruAmmVault,
148:         uint96 _kuruAmmSpread, // <= FOUND
149:         address __trustedForwarder
150:     ) external;
```
['[154](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/interfaces/IOrderBook.sol#L154-L154)']
```solidity
154:     function addBuyOrder(uint32 _price, uint96 size, bool _postOnly) external; // <= FOUND
```
['[156](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/interfaces/IOrderBook.sol#L156-L156)']
```solidity
156:     function addFlipBuyOrder(uint32 _price, uint32 _flippedPrice, uint96 _size, bool _provisionOrRevert) external; // <= FOUND
```
['[158](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/interfaces/IOrderBook.sol#L158-L158)']
```solidity
158:     function addSellOrder(uint32 _price, uint96 size, bool _postOnly) external; // <= FOUND
```
['[160](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/interfaces/IOrderBook.sol#L160-L160)']
```solidity
160:     function addFlipSellOrder(uint32 _price, uint32 _flippedPrice, uint96 _size, bool _provisionOrRevert) external; // <= FOUND
```
['[23](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/interfaces/IRouter.sol#L23-L36)']
```solidity
23:     
24:     event MarketRegistered(
25:         address baseAsset,
26:         address quoteAsset,
27:         address market,
28:         address vaultAddress,
29:         uint32 pricePrecision, // <= FOUND
30:         uint96 sizePrecision, // <= FOUND
31:         uint32 tickSize, // <= FOUND
32:         uint96 minSize, // <= FOUND
33:         uint96 maxSize, // <= FOUND
34:         uint256 takerFeeBps,
35:         uint256 makerFeeBps,
36:         uint96 kuruAmmSpread // <= FOUND
37:     );
```
['[46](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/interfaces/IRouter.sol#L46-L57)']
```solidity
46:     function deployProxy(
47:         IOrderBook.OrderBookType _type,
48:         address _baseAssetAddress,
49:         address _quoteAssetAddress,
50:         uint96 _sizePrecision, // <= FOUND
51:         uint32 _pricePrecision, // <= FOUND
52:         uint32 _tickSize, // <= FOUND
53:         uint96 _minSize, // <= FOUND
54:         uint96 _maxSize, // <= FOUND
55:         uint256 _takerFeeBps,
56:         uint256 _makerFeeBps,
57:         uint96 _kuruAmmSpread // <= FOUND
58:     ) external returns (address);
```
['[14](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/TreeMath.sol#L14-L14)']
```solidity
14:     struct TreeUint32 { // <= FOUND
```
['[28](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/TreeMath.sol#L28-L35)']
```solidity
28:     
35:     function add(TreeUint32 storage tree, uint32 id) internal returns (bool) { // <= FOUND
```
['[68](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/TreeMath.sol#L68-L75)']
```solidity
68:     
75:     function remove(TreeUint32 storage tree, uint32 id) internal returns (bool) { // <= FOUND
```
['[108](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/TreeMath.sol#L108-L115)']
```solidity
108:     
115:     function findFirstRight(TreeUint32 storage tree, uint32 id) internal view returns (uint32) { // <= FOUND
```
['[184](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/TreeMath.sol#L184-L191)']
```solidity
184:     
191:     function findFirstLeft(TreeUint32 storage tree, uint32 id) internal view returns (uint32) { // <= FOUND
```
['[30](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L30-L30)']
```solidity
30:     TreeMath.TreeUint32 public s_buyTree; // <= FOUND
```
['[31](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L31-L31)']
```solidity
31:     TreeMath.TreeUint32 public s_sellTree; // <= FOUND
```
['[37](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L37-L37)']
```solidity
37:     uint32 internal pricePrecision; // <= FOUND
```
['[26](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/periphery/MonadDeployer.sol#L26-L26)']
```solidity
26:     uint32 tickSize; // <= FOUND
```
['[85](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L85-L108)']
```solidity
85:     
92:     function initialize(
93:         address _owner,
94:         OrderBookType _type,
95:         address _baseAssetAddress,
96:         uint256 _baseAssetDecimals,
97:         address _quoteAssetAddress,
98:         uint256 _quoteAssetDecimals,
99:         address _marginAccountAddress,
100:         uint96 _sizePrecision, // <= FOUND
101:         uint32 _pricePrecision, // <= FOUND
102:         uint32 _tickSize, // <= FOUND
103:         uint96 _minSize, // <= FOUND
104:         uint96 _maxSize, // <= FOUND
105:         uint256 _takerFeeBps,
106:         uint256 _makerFeeBps,
107:         address _kuruAmmVault,
108:         uint96 _kuruAmmSpread, // <= FOUND
109:         address __trustedForwarder
110:     ) public initializer {
```
['[169](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L169-L175)']
```solidity
169:     
175:     function addBuyOrder(uint32 _price, uint96 size, bool _postOnly) public marketActive nonReentrant { // <= FOUND
```
['[205](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L205-L213)']
```solidity
205:     
213:     function addFlipBuyOrder(uint32 _price, uint32 _flippedPrice, uint96 _size, bool _provisionOrRevert) // <= FOUND
214:         public
215:         marketActive
216:         nonReentrant
217:     {
```
['[241](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L241-L247)']
```solidity
241:     
247:     function addSellOrder(uint32 _price, uint96 _size, bool _postOnly) public marketActive nonReentrant { // <= FOUND
```
['[275](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L275-L283)']
```solidity
275:     
283:     function addFlipSellOrder(uint32 _price, uint32 _flippedPrice, uint96 _size, bool _provisionOrRevert) // <= FOUND
284:         public
285:         marketActive
286:         nonReentrant
287:     {
```
['[311](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L311-L319)']
```solidity
311:     
319:     function addPairedLiquidity(uint32 _bidPrice, uint32 _askPrice, uint96 _bidSize, uint96 _askSize) // <= FOUND
320:         public
321:         marketActive
322:         nonReentrant
323:     {
```
['[359](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L359-L367)']
```solidity
359:     
367:     function _addOrder(uint32 _price, uint96 _size, uint40 _orderId, bool _isBuy, uint40 _prevOrderId) internal { // <= FOUND
```
['[384](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L384-L398)']
```solidity
384:     
395:     function _addFlipOrder(
396:         uint32 _price, // <= FOUND
397:         uint32 _flippedPrice, // <= FOUND
398:         uint96 _size, // <= FOUND
399:         address _owner,
400:         uint40 _orderId, // <= FOUND
401:         uint40 _flippedId, // <= FOUND
402:         bool _isBuy,
403:         uint40 _prevOrderId // <= FOUND
404:     ) internal {
```
['[416](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L416-L430)']
```solidity
416:     
427:     function _addFlippedOrder(
428:         uint32 _price, // <= FOUND
429:         uint32 _flippedPrice, // <= FOUND
430:         uint96 _size, // <= FOUND
431:         address _owner,
432:         uint40 _orderId, // <= FOUND
433:         uint40 _flippedId, // <= FOUND
434:         bool _isBuy,
435:         uint40 _prevOrderId // <= FOUND
436:     ) internal {
```
['[864](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L864-L864)']
```solidity
864:         uint32 _pricePrecision = pricePrecision; // <= FOUND
```
['[1080](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L1080-L1091)']
```solidity
1080:     
1087:     function _fillSizeForPrice(
1088:         TreeMath.TreeUint32 storage _tree, // <= FOUND
1089:         uint32 _price, // <= FOUND
1090:         OrderLinkedList.PricePoint storage _pricePoint,
1091:         uint96 _size // <= FOUND
1092:     ) internal returns (uint96, bytes memory makerCredits) {
```
['[1225](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L1225-L1230)']
```solidity
1225:     
1230:     function _quoteAmountRoundedUp(uint32 _price, uint96 _size) internal view returns (uint96) { // <= FOUND
```
['[1238](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L1238-L1246)']
```solidity
1238:     
1246:     function _creditMaker(bool _isMarketBuy, address _ownerAddress, uint96 _size, uint32 _price) // <= FOUND
1247:         internal
1248:         view
1249:         returns (bytes memory)
1250:     {
```
['[1269](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L1269-L1274)']
```solidity
1269:     
1274:     function _quoteAmountRoundedDown(uint256 _size, uint32 _price) internal view returns (uint256) { // <= FOUND
```
['[1338](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L1338-L1338)']
```solidity
1338:         uint32 firstLeft = TreeMath.findFirstLeft(s_sellTree, 0); // <= FOUND
```
['[1346](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L1346-L1346)']
```solidity
1346:         uint32 firstRight = TreeMath.findFirstRight(s_buyTree, type(uint32).max); // <= FOUND
```
['[1399](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L1399-L1404)']
```solidity
1399:     
1404:     function getL2Book(uint32 _bidPricePoints, uint32 _askPricePoints) public view returns (bytes memory data) { // <= FOUND
```
['[1412](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L1412-L1413)']
```solidity
1412:         
1413:         uint32 price = TreeMath.findFirstRight(s_buyTree, type(uint32).max); // <= FOUND
```
['[74](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L74-L100)']
```solidity
74:     
89:     function deployProxy(
90:         IOrderBook.OrderBookType _type,
91:         address _baseAssetAddress,
92:         address _quoteAssetAddress,
93:         uint96 _sizePrecision, // <= FOUND
94:         uint32 _pricePrecision, // <= FOUND
95:         uint32 _tickSize, // <= FOUND
96:         uint96 _minSize, // <= FOUND
97:         uint96 _maxSize, // <= FOUND
98:         uint256 _takerFeeBps,
99:         uint256 _makerFeeBps,
100:         uint96 _kuruAmmSpread // <= FOUND
101:     ) public returns (address proxy) {
```
['[192](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L192-L202)']
```solidity
192:     function computeAddress(
193:         address _baseAssetAddress,
194:         address _quoteAssetAddress,
195:         uint96 _sizePrecision, // <= FOUND
196:         uint32 _pricePrecision, // <= FOUND
197:         uint32 _tickSize, // <= FOUND
198:         uint96 _minSize, // <= FOUND
199:         uint96 _maxSize, // <= FOUND
200:         uint256 _takerFeeBps,
201:         uint256 _makerFeeBps,
202:         uint96 _kuruAmmSpread, // <= FOUND
203:         address oldImplementation,
204:         bool old
205:     ) public view returns (address proxy) {
```
['[392](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L392-L402)']
```solidity
392:     function _getSalt(
393:         address _baseAssetAddress,
394:         address _quoteAssetAddress,
395:         uint96 _sizePrecision, // <= FOUND
396:         uint32 _pricePrecision, // <= FOUND
397:         uint32 _tickSize, // <= FOUND
398:         uint96 _minSize, // <= FOUND
399:         uint96 _maxSize, // <= FOUND
400:         uint256 _takerFeeBps,
401:         uint256 _makerFeeBps,
402:         uint96 _kuruAmmSpread // <= FOUND
403:     ) internal pure returns (bytes32) {
```
['[30](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L30-L30)']
```solidity
30: TreeMath.TreeUint32 public s_buyTree; // <= FOUND
```
['[31](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L31-L31)']
```solidity
31: TreeMath.TreeUint32 public s_sellTree; // <= FOUND
```
['[37](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L37-L37)']
```solidity
37: uint32 internal pricePrecision; // <= FOUND
```
['[26](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/periphery/MonadDeployer.sol#L26-L26)']
```solidity
26: uint32 tickSize; // <= FOUND
```
['[42](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/AbstractAMM.sol#L42-L48)']
```solidity
42:     function _emitTrade(
43:         uint40 orderId, // <= FOUND
44:         address makerAddress,
45:         bool isBuy,
46:         uint256 price,
47:         uint96 updatedSize, // <= FOUND
48:         uint96 filledSize // <= FOUND
49:     ) internal virtual;
```
['[21](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/interfaces/IOrderBook.sol#L21-L21)']
```solidity
21:         uint40 prev; // <= FOUND
```
['[22](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/interfaces/IOrderBook.sol#L22-L22)']
```solidity
22:         uint40 next; // <= FOUND
```
['[23](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/interfaces/IOrderBook.sol#L23-L23)']
```solidity
23:         uint40 flippedId; // <= FOUND
```
['[74](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/interfaces/IOrderBook.sol#L74-L79)']
```solidity
74:     
79:     event FlipOrderUpdated(uint40 orderId, uint96 size); // <= FOUND
```
['[121](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/interfaces/IOrderBook.sol#L121-L138)']
```solidity
121:     
130:     event Trade(
131:         uint40 orderId, // <= FOUND
132:         address makerAddress,
133:         bool isBuy,
134:         uint256 price,
135:         uint96 updatedSize, // <= FOUND
136:         address takerAddress,
137:         address txOrigin,
138:         uint96 filledSize // <= FOUND
139:     );
```
['[10](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/OrderLinkedList.sol#L10-L10)']
```solidity
10:         uint40 head; // <= FOUND
```
['[11](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/OrderLinkedList.sol#L11-L11)']
```solidity
11:         uint40 tail; // <= FOUND
```
['[15](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/OrderLinkedList.sol#L15-L16)']
```solidity
15:     
16:     uint40 constant NULL = 0; // <= FOUND
```
['[22](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/OrderLinkedList.sol#L22-L27)']
```solidity
22:     
27:     function insertAtTail(PricePoint storage point, uint40 orderId) internal returns (uint40) { // <= FOUND
```
['[23](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/OrderLinkedList.sol#L23-L23)']
```solidity
23:         uint40 _pointTail = point.tail; // <= FOUND
```
['[35](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/OrderLinkedList.sol#L35-L35)']
```solidity
35:     function adjustForTail(PricePoint storage point, uint40 prev, uint40 next) internal { // <= FOUND
```
['[46](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/OrderLinkedList.sol#L46-L51)']
```solidity
46:     
51:     function updateHead(PricePoint storage point, uint40 orderId) internal { // <= FOUND
```
['[27](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L27-L27)']
```solidity
27:     mapping(uint40 => Order) public s_orders; // <= FOUND
```
['[33](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L33-L33)']
```solidity
33:     uint40 public s_orderIdCounter; // <= FOUND
```
['[187](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L187-L187)']
```solidity
187:             uint40 _orderId = s_orderIdCounter + 1; // <= FOUND
```
['[191](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L191-L192)']
```solidity
191:             
192:             uint40 _prevOrderId = OrderLinkedList.insertAtTail(s_buyPricePoints[_price], _orderId); // <= FOUND
```
['[187](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L187-L187)']
```solidity
187:         uint40 _orderId = s_orderIdCounter + 1; // <= FOUND
```
['[191](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L191-L191)']
```solidity
191:         uint40 _prevOrderId = OrderLinkedList.insertAtTail(s_buyPricePoints[_price], _orderId); // <= FOUND
```
['[262](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L262-L263)']
```solidity
262:             
263:             uint40 _prevOrderId = OrderLinkedList.insertAtTail(s_sellPricePoints[_price], _orderId); // <= FOUND
```
['[262](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L262-L262)']
```solidity
262:         uint40 _prevOrderId = OrderLinkedList.insertAtTail(s_sellPricePoints[_price], _orderId); // <= FOUND
```
['[341](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L341-L341)']
```solidity
341:         uint40 _bidOrderId = s_orderIdCounter + 1; // <= FOUND
```
['[342](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L342-L342)']
```solidity
342:         uint40 _askOrderId = _bidOrderId + 1; // <= FOUND
```
['[345](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L345-L345)']
```solidity
345:         uint40 _bidPrevOrderId = OrderLinkedList.insertAtTail(s_buyPricePoints[_bidPrice], _bidOrderId); // <= FOUND
```
['[346](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L346-L346)']
```solidity
346:         uint40 _askPrevOrderId = OrderLinkedList.insertAtTail(s_sellPricePoints[_askPrice], _askOrderId); // <= FOUND
```
['[496](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L496-L500)']
```solidity
496:     
500:     function _cancelFlipOrder(uint40 _orderId) internal nonReentrant { // <= FOUND
```
['[511](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L511-L515)']
```solidity
511:     
515:     function _cancelOrder(uint40 _orderId, bool _revertIfInvalid) internal nonReentrant returns (bool) { // <= FOUND
```
['[531](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L531-L536)']
```solidity
531:     
536:     function _executeCancel(uint40 _orderId, Order memory _order) internal { // <= FOUND
```
['[586](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L586-L595)']
```solidity
586:     
595:     function _checkIfCancelledOrFilled(uint40 _orderId, Order memory _order) internal view returns (bool) { // <= FOUND
```
['[593](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L593-L594)']
```solidity
593:                 
594:                 uint40 _head = s_buyPricePoints[_order.price].head; // <= FOUND
```
['[599](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L599-L599)']
```solidity
599:                 uint40 _head = s_sellPricePoints[_order.price].head; // <= FOUND
```
['[1086](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L1086-L1086)']
```solidity
1086:         uint40 _orderId = _pricePoint.head; // <= FOUND
```
['[1118](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L1118-L1137)']
```solidity
1118:     
1135:     function _fillOrder(uint40 _orderId, uint96 _incomingSizeToBeFilled) // <= FOUND
1136:         internal
1137:         returns (uint96 incomingOrderRemainingSize, uint40 _nextHead, bytes memory _orderUpdate) // <= FOUND
1138:     {
```
['[1166](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L1166-L1166)']
```solidity
1166:     function _handleFlipOrderUpdate(uint40 _orderId, uint96 _size, bool nullify) internal { // <= FOUND
```
['[1171](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L1171-L1172)']
```solidity
1171:             
1172:             uint40 _flipOrderId = s_orderIdCounter + 1; // <= FOUND
```
['[1173](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L1173-L1173)']
```solidity
1173:             uint40 _prevOrderId; // <= FOUND
```
['[1195](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L1195-L1196)']
```solidity
1195:             
1196:             uint40 _flipOrderId = s_orders[_orderId].flippedId; // <= FOUND
```
['[1209](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L1209-L1215)']
```solidity
1209:     function _emitTrade(
1210:         uint40 orderId, // <= FOUND
1211:         address makerAddress,
1212:         bool isBuy,
1213:         uint256 price,
1214:         uint96 updatedSize, // <= FOUND
1215:         uint96 filledSize // <= FOUND
1216:     ) internal override {
```
['[1414](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L1414-L1414)']
```solidity
1414:             uint40 orderId = s_buyPricePoints[price].head; // <= FOUND
```
['[1459](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L1459-L1459)']
```solidity
1459:             uint40 orderId = s_sellPricePoints[price].head; // <= FOUND
```
['[33](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L33-L33)']
```solidity
33: uint40 public s_orderIdCounter; // <= FOUND
```
['[15](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/OrderLinkedList.sol#L15-L15)']
```solidity
15: uint40 constant NULL = 0; // <= FOUND
```
['[23](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/AbstractAMM.sol#L23-L23)']
```solidity
23:     uint96 internal bidPartiallyFilledSize; // <= FOUND
```
['[25](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/AbstractAMM.sol#L25-L25)']
```solidity
25:     uint96 internal askPartiallyFilledSize; // <= FOUND
```
['[26](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/AbstractAMM.sol#L26-L26)']
```solidity
26:     uint96 public vaultAskOrderSize; // <= FOUND
```
['[27](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/AbstractAMM.sol#L27-L27)']
```solidity
27:     uint96 internal vaultBidOrderSize; // <= FOUND
```
['[28](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/AbstractAMM.sol#L28-L28)']
```solidity
28:     uint96 public SPREAD_CONSTANT; // <= FOUND
```
['[59](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/AbstractAMM.sol#L59-L69)']
```solidity
59:     
67:     function _fillVaultBuyMatch(uint256 _breakPoint, uint96 _quoteSize) // <= FOUND
68:         internal
69:         returns (uint96 quoteLeft, uint96 sizeFilled, bytes memory makerCredits) // <= FOUND
70:     {
```
['[65](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/AbstractAMM.sol#L65-L65)']
```solidity
65:         uint96 _cachedLastVaultSize = vaultAskOrderSize; // <= FOUND
```
['[66](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/AbstractAMM.sol#L66-L66)']
```solidity
66:         uint96 _cachedPartiallyFilledBid = bidPartiallyFilledSize; // <= FOUND
```
['[67](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/AbstractAMM.sol#L67-L67)']
```solidity
67:         uint96 _availableSize = _cachedLastVaultSize - askPartiallyFilledSize; // <= FOUND
```
['[76](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/AbstractAMM.sol#L76-L76)']
```solidity
76:                 uint96 _sizeFilledAtPrice = toU96(_quoteInput * _getSizePrecision() / _price); // <= FOUND
```
['[124](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/AbstractAMM.sol#L124-L134)']
```solidity
124:     
132:     function _fillVaultForBuy(uint256 _breakPoint, uint96 _size) // <= FOUND
133:         internal
134:         returns (uint96 sizeLeft, uint96 fundsConsumed, bytes memory makerCredits) // <= FOUND
135:     {
```
['[187](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/AbstractAMM.sol#L187-L197)']
```solidity
187:     
195:     function _fillVaultForSell(uint256 _breakPoint, uint96 _size) // <= FOUND
196:         internal
197:         returns (uint96 sizeLeft, uint256 quoteOwedToUser, bytes memory makerCredits) // <= FOUND
198:     {
```
['[192](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/AbstractAMM.sol#L192-L192)']
```solidity
192:         uint96 _availableSize = vaultBidOrderSize - bidPartiallyFilledSize; // <= FOUND
```
['[193](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/AbstractAMM.sol#L193-L193)']
```solidity
193:         uint96 _cachedLastVaultSize = vaultBidOrderSize; // <= FOUND
```
['[238](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/AbstractAMM.sol#L238-L244)']
```solidity
238:     
244:     function _creditVaultOnMarketBuy(uint96 _sizeFilled, uint256 _fundsOwed) // <= FOUND
245:         internal
246:         view
247:         returns (bytes memory returnData)
248:     {
```
['[259](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/AbstractAMM.sol#L259-L265)']
```solidity
259:     
265:     function _creditVaultOnMarketSell(uint96 _sizeOwedToVault, uint256 _fundsOwedToUser) // <= FOUND
266:         internal
267:         view
268:         returns (bytes memory returnData)
269:     {
```
['[300](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/AbstractAMM.sol#L300-L311)']
```solidity
300:     
309:     function updateVaultOrdSz(
310:         uint96 _vaultAskOrderSize, // <= FOUND
311:         uint96 _vaultBidOrderSize, // <= FOUND
312:         uint256 _askPrice,
313:         uint256 _bidPrice,
314:         bool _nullifyPartialFills
315:     ) external onlyVault nonReentrant marketNotHardPaused {
```
['[335](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/AbstractAMM.sol#L335-L335)']
```solidity
335:     function toU96(uint256 _from) internal pure returns (uint96 _to) { // <= FOUND
```
['[24](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/periphery/MonadDeployer.sol#L24-L24)']
```solidity
24:         uint96 sizePrecision; // <= FOUND
```
['[27](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/periphery/MonadDeployer.sol#L27-L27)']
```solidity
27:         uint96 minSize; // <= FOUND
```
['[28](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/periphery/MonadDeployer.sol#L28-L28)']
```solidity
28:         uint96 maxSize; // <= FOUND
```
['[23](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/interfaces/IKuruAMMVault.sol#L23-L29)']
```solidity
23:     function initialize(
24:         address _owner,
25:         address token1_,
26:         address token2_,
27:         address _marginAccount,
28:         address _market,
29:         uint96 _spread // <= FOUND
30:     ) external;
```
['[20](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/interfaces/IOrderBook.sol#L20-L20)']
```solidity
20:         uint96 size; // <= FOUND
```
['[103](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/interfaces/IOrderBook.sol#L103-L116)']
```solidity
103:     
112:     event VaultParamsUpdated(
113:         uint96 _vaultAskOrderSize, // <= FOUND
114:         uint96 _vaultAskPartiallyFilledSize, // <= FOUND
115:         uint96 _vaultBidOrderSize, // <= FOUND
116:         uint96 _vaultBidPartiallyFilledSize, // <= FOUND
117:         uint256 _askPrice,
118:         uint256 _bidPrice
119:     );
```
['[175](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/interfaces/IOrderBook.sol#L175-L175)']
```solidity
175:     function placeAndExecuteMarketBuy(uint96 _quoteAmount, uint256 _minAmountOut, bool _isMargin, bool _isFillOrKill) // <= FOUND
176:         external
177:         payable
178:         returns (uint256);
```
['[180](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/interfaces/IOrderBook.sol#L180-L180)']
```solidity
180:     function placeAndExecuteMarketSell(uint96 _size, uint256 _minAmountOut, bool _isMargin, bool _isFillOrKill) // <= FOUND
181:         external
182:         payable
183:         returns (uint256);
```
['[187](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/interfaces/IOrderBook.sol#L187-L189)']
```solidity
187:     function updateVaultOrdSz(
188:         uint96 _vaultAskOrderSize, // <= FOUND
189:         uint96 _vaultBidOrderSize, // <= FOUND
190:         uint256 _askPrice,
191:         uint256 _bidPrice,
192:         bool _nullifyPartialFills
193:     ) external;
```
['[45](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L45-L52)']
```solidity
45:     
46:     function initialize(
47:         address _owner,
48:         address token1_,
49:         address token2_,
50:         address _marginAccount,
51:         address _market,
52:         uint96 _spreadConstant // <= FOUND
53:     ) public initializer {
```
['[200](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L200-L200)']
```solidity
200:         (uint96 _newAskSize, uint96 _newBidSize) = _getVaultSizesForBaseAmount(_baseAmount + baseDeposit); // <= FOUND
```
['[259](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L259-L263)']
```solidity
259:         (
260:             uint256 _baseOwedToUser,
261:             uint256 _quoteOwedToUser,
262:             uint96 _newAskSize, // <= FOUND
263:             uint96 _newBidSize, // <= FOUND
264:             bool _nullifyPartialFills
265:         ) = _convertToAssetsWithNewSize(_shares);
```
['[319](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L319-L321)']
```solidity
319:         
320:         
321:         uint96 _normalizedBaseAmount = roundUp // <= FOUND
322:             ? toU96(
323:                 FixedPointMathLib.mulDivUp(
324:                     market.vaultAskOrderSize(), DOUBLE_BPS_MULTIPLIER + SPREAD_CONSTANT, SPREAD_CONSTANT
325:                 )
326:             )
327:             : toU96(
328:                 FixedPointMathLib.mulDiv(
329:                     market.vaultAskOrderSize(), DOUBLE_BPS_MULTIPLIER + SPREAD_CONSTANT, SPREAD_CONSTANT
330:                 )
331:             );
```
['[383](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L383-L383)']
```solidity
383:         (uint96 _newAskSize, uint96 _newBidSize) = _getVaultSizesForBaseAmount(_baseAmountAfterRemoval); // <= FOUND
```
['[384](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L384-L389)']
```solidity
384:         (
385:             ,
386:             uint256 _vaultBestBid,
387:             uint96 _partiallyFilledBidSize, // <= FOUND
388:             uint256 _vaultBestAsk,
389:             uint96 _partiallyFilledAskSize, // <= FOUND
390:             ,
391:             ,
392:         ) = market.getVaultParams();
```
['[433](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L433-L433)']
```solidity
433:         uint96 _newAskSize = toU96( // <= FOUND
434:             (SPREAD_CONSTANT * _baseAmount * _marketParams.sizePrecision)
435:                 / ((DOUBLE_BPS_MULTIPLIER + SPREAD_CONSTANT) * 10 ** _marketParams.baseAssetDecimals)
436:         );
```
['[437](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L437-L437)']
```solidity
437:         uint96 _newBidSize = toU96( // <= FOUND
438:             (SPREAD_CONSTANT * _baseAmount * _marketParams.sizePrecision)
439:                 / (DOUBLE_BPS_MULTIPLIER * 10 ** _marketParams.baseAssetDecimals)
440:         );
```
['[36](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L36-L36)']
```solidity
36:     uint96 internal sizePrecision; // <= FOUND
```
['[27](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/periphery/MonadDeployer.sol#L27-L27)']
```solidity
27:     uint96 minSize; // <= FOUND
```
['[28](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/periphery/MonadDeployer.sol#L28-L28)']
```solidity
28:     uint96 maxSize; // <= FOUND
```
['[176](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L176-L177)']
```solidity
176:         
177:         (uint96 _remainingSize, uint96 _consumedFunds) = _matchAggressiveBuyWithCap(uint256(_price), size); // <= FOUND
```
['[251](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L251-L253)']
```solidity
251:         
252:         
253:         (uint96 _remainingSize,) = _matchAggressiveSell(uint256(_price), _size, true); // <= FOUND
```
['[728](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L728-L736)']
```solidity
728:     
736:     function placeAndExecuteMarketBuy(uint96 _quoteSize, uint256 _minAmountOut, bool _isMargin, bool _isFillOrKill) // <= FOUND
737:         public
738:         payable
739:         override
740:         marketActive
741:         nonReentrant
742:         returns (uint256)
743:     {
```
['[786](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L786-L794)']
```solidity
786:     
794:     function placeAndExecuteMarketSell(uint96 _size, uint256 _minAmountOut, bool _isMargin, bool _isFillOrKill) // <= FOUND
795:         public
796:         payable
797:         marketActive
798:         nonReentrant
799:         returns (uint256)
800:     {
```
['[835](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L835-L835)']
```solidity
835:     function _pricePrecisionToQuoteAssetPrecision(uint96 _quote) internal view returns (uint256) { // <= FOUND
```
['[839](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L839-L839)']
```solidity
839:     function _sizePrecisionToBaseAssetPrecision(uint96 _size) internal view returns (uint256) { // <= FOUND
```
['[855](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L855-L855)']
```solidity
855:     function _matchAggressiveBuyWithCap(uint256 _limitPrice, uint96 _sizeToBeFilled) // <= FOUND
856:         internal
857:         returns (uint96, uint96)
858:     {
```
['[859](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L859-L859)']
```solidity
859:         uint96 sizeToCreditTaker; // <= FOUND
```
['[860](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L860-L860)']
```solidity
860:         uint96 sizeToCreditViaVault; // <= FOUND
```
['[861](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L861-L861)']
```solidity
861:         uint96 fundsConsumed; // <= FOUND
```
['[868](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L868-L868)']
```solidity
868:             uint96 sizeToBeFilledBefore = _sizeToBeFilled;  // <= FOUND
```
['[872](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L872-L872)']
```solidity
872:                 uint96 _vaultFundsConsumed; // <= FOUND
```
['[885](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L885-L885)']
```solidity
885:             uint96 sizeFilled = sizeToBeFilledBefore - _sizeToBeFilled; // <= FOUND
```
['[903](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L903-L903)']
```solidity
903:             uint96 _sizePrecision = sizePrecision; // <= FOUND
```
['[930](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L930-L934)']
```solidity
930:     
934:     function _marketBuyMatch(uint96 _quoteSize, bool _isMargin) internal returns (uint96, uint256) { // <= FOUND
```
['[903](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L903-L903)']
```solidity
903:         uint96 _sizePrecision = sizePrecision; // <= FOUND
```
['[942](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L942-L942)']
```solidity
942:                 uint96 _sizeFilled; // <= FOUND
```
['[948](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L948-L949)']
```solidity
948:                 
949:                 uint96 _sizeFillableAtPriceLeft = // <= FOUND
950:                     toU96(_quoteSize * _sizePrecision * vaultPricePrecision / (_bestAsk * _pricePrecision));
```
['[950](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L950-L950)']
```solidity
950:                 uint96 _sizeFillableAtPriceBefore = _sizeFillableAtPriceLeft;  // <= FOUND
```
['[1003](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L1003-L1009)']
```solidity
1003:     
1009:     function _matchAggressiveSell(uint256 _limitPrice, uint96 _sizeToBeFilledLeft, bool _useMargin) // <= FOUND
1010:         internal
1011:         returns (uint96, uint256)
1012:     {
```
['[1007](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L1007-L1007)']
```solidity
1007:         uint96 quoteCreditTaker; // <= FOUND
```
['[1015](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L1015-L1015)']
```solidity
1015:             uint96 _sizeToBeFilledBefore = _sizeToBeFilledLeft;  // <= FOUND
```
['[1123](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L1123-L1123)']
```solidity
1123:         uint96 _preExistingOrderSize = s_orders[_orderId].size; // <= FOUND
```
['[1127](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L1127-L1127)']
```solidity
1127:         uint96 _preExistingOrderUpdatedSize; // <= FOUND
```
['[1200](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L1200-L1200)']
```solidity
1200:             uint96 _updatedSize = s_orders[_flipOrderId].size + _size; // <= FOUND
```
['[1415](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L1415-L1415)']
```solidity
1415:             uint96 size = 0; // <= FOUND
```
['[35](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/periphery/MonadDeployer.sol#L35-L35)']
```solidity
35:     uint96 public kuruAmmSpread; // <= FOUND
```
['[49](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/periphery/MonadDeployer.sol#L49-L55)']
```solidity
49:     
50:     constructor(
51:         IRouter _router,
52:         address _owner,
53:         address _marginAccount,
54:         address _kuruCollective,
55:         uint96 _kuruAmmSpread, // <= FOUND
56:         uint256 _kuruCollectiveFee
57:     ) {
```
['[105](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/periphery/MonadDeployer.sol#L105-L105)']
```solidity
105:     function setKuruAmmSpread(uint96 _kuruAmmSpread) external onlyOwner { // <= FOUND
```
['[28](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/AbstractAMM.sol#L28-L28)']
```solidity
28: uint96 public SPREAD_CONSTANT; // <= FOUND
```
['[36](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L36-L36)']
```solidity
36: uint96 internal sizePrecision; // <= FOUND
```
['[27](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/periphery/MonadDeployer.sol#L27-L27)']
```solidity
27: uint96 minSize; // <= FOUND
```
['[28](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/periphery/MonadDeployer.sol#L28-L28)']
```solidity
28: uint96 maxSize; // <= FOUND
```
['[35](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/periphery/MonadDeployer.sol#L35-L35)']
```solidity
35: uint96 public kuruAmmSpread; // <= FOUND
```
['[23](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/AbstractAMM.sol#L23-L23)']
```solidity
23: uint96 internal bidPartiallyFilledSize; // <= FOUND
```
['[25](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/AbstractAMM.sol#L25-L25)']
```solidity
25: uint96 internal askPartiallyFilledSize; // <= FOUND
```
['[26](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/AbstractAMM.sol#L26-L26)']
```solidity
26: uint96 public vaultAskOrderSize; // <= FOUND
```
['[27](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/AbstractAMM.sol#L27-L27)']
```solidity
27: uint96 internal vaultBidOrderSize; // <= FOUND
```


</details>

## [Gas-10] Use != 0 instead of > 0

### Resolution 
Replace spotted instances with != 0 for uints as this uses less gas

Num of instances: 27

### Findings 


<details><summary>Click to show findings</summary>

['[73](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/AbstractAMM.sol#L73-L73)']
```solidity
73:         while (_price < _breakPoint && _quoteInput > 0) { // <= FOUND
```
['[139](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/AbstractAMM.sol#L139-L139)']
```solidity
139:         while (_price < _breakPoint && sizeLeft > 0) { // <= FOUND
```
['[199](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/AbstractAMM.sol#L199-L199)']
```solidity
199:         while (_price > _breakPoint && sizeLeft > 0) { // <= FOUND
```
['[248](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/AbstractAMM.sol#L248-L248)']
```solidity
248:         if (feeRebate > 0) { // <= FOUND
```
['[199](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L199-L199)']
```solidity
199:         require(_shares > 0, KuruAMMVaultErrors.InsufficientLiquidityMinted()); // <= FOUND
```
['[213](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L213-L213)']
```solidity
213:         if (_nativeRefund > 0) { // <= FOUND
```
['[182](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L182-L182)']
```solidity
182:             if (_balance > 0) { // <= FOUND
```
['[107](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L107-L107)']
```solidity
107:         require(_kuruAmmSpread % 10 == 0 && _kuruAmmSpread > 0 && _kuruAmmSpread < 500, OrderBookErrors.InvalidSpread()); // <= FOUND
```
['[108](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L108-L108)']
```solidity
108:         require(_minSize > 0 && _maxSize > _minSize, OrderBookErrors.MarketSizeError()); // <= FOUND
```
['[170](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L170-L170)']
```solidity
170:         require(_price > 0 && _price < type(uint32).max, OrderBookErrors.PriceError()); // <= FOUND
```
['[210](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L210-L210)']
```solidity
210:         require(_price > 0 && _flippedPrice > 0 && _flippedPrice < type(uint32).max, OrderBookErrors.PriceError()); // <= FOUND
```
['[280](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L280-L280)']
```solidity
280:         require(_price > 0 && _flippedPrice > 0 && _price < type(uint32).max, OrderBookErrors.PriceError()); // <= FOUND
```
['[316](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L316-L316)']
```solidity
316:         require(_bidPrice > 0 && _askPrice > _bidPrice && _askPrice < type(uint32).max, OrderBookErrors.PriceError()); // <= FOUND
```
['[715](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L715-L716)']
```solidity
715:         
716:         if (orderIdsCanceled.length > 0) { // <= FOUND
```
['[759](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L759-L759)']
```solidity
759:         if (_quoteSize > 0) { // <= FOUND
```
['[811](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L811-L811)']
```solidity
811:         if (_size > 0) { // <= FOUND
```
['[867](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L867-L867)']
```solidity
867:         while (_sizeToBeFilled > 0 && _bestAsk <= _limitPrice && _bestAsk != 0) { // <= FOUND
```
['[906](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L906-L906)']
```solidity
906:             if (sizeToCreditViaVault > 0) { // <= FOUND
```
['[912](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L912-L912)']
```solidity
912:             if (_takerFeeBps > 0) { // <= FOUND
```
['[939](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L939-L939)']
```solidity
939:         while (_quoteSize > 0 && _bestAsk != 0) { // <= FOUND
```
['[976](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L976-L976)']
```solidity
976:             if (sizeToCreditViaVault > 0 && msg.sender != address(0)) { // <= FOUND
```
['[1014](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L1014-L1014)']
```solidity
1014:         while (_sizeToBeFilledLeft > 0 && _bestBid >= _limitPrice && _bestBid != type(uint256).max) { // <= FOUND
```
['[1051](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L1051-L1051)']
```solidity
1051:             if (quoteCreditVaultTaker > 0 && msg.sender != address(0)) { // <= FOUND
```
['[1087](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L1087-L1087)']
```solidity
1087:         while (_size > 0 && _orderId != OrderLinkedList.NULL) { // <= FOUND
```
['[248](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/AbstractAMM.sol#L248-L249)']
```solidity
248:         
249:         if (feeRebate > 0) { // <= FOUND
```
['[98](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L98-L98)']
```solidity
98:         require(_tickSize > 0, RouterErrors.InvalidTickSize()); // <= FOUND
```
['[351](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L351-L351)']
```solidity
351:             require(_marketParams.pricePrecision > 0, RouterErrors.InvalidMarket()); // <= FOUND
```


</details>

## [Gas-11] Default bool values are manually reset

### Resolution 
Using .delete is better than resetting a Solidity variable to its default value manually because it frees up storage space on the Ethereum blockchain, resulting in gas cost savings. 

Num of instances: 1

### Findings 


<details><summary>Click to show findings</summary>

['[111](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruForwarder.sol#L111-L113)']
```solidity
111:     function removeAllowedInterfaces(bytes4[] memory _allowedInterfaces) external onlyOwner { // <= FOUND
112:         for (uint256 i = 0; i < _allowedInterfaces.length; i++) {
113:             allowedInterface[_allowedInterfaces[i]] = false; // <= FOUND
114:         }
115:     }
```


</details>

## [Gas-12] Default int values are manually reset

### Resolution 
Using .delete is better than resetting a Solidity variable to its default value manually because it frees up storage space on the Ethereum blockchain, resulting in gas cost savings.

Num of instances: 9

### Findings 


<details><summary>Click to show findings</summary>

['[70](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/AbstractAMM.sol#L70-L70)']
```solidity
70:             askPartiallyFilledSize = 0;
```
['[80](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/AbstractAMM.sol#L80-L80)']
```solidity
80:                 _quoteInput = 0;
```
['[144](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/AbstractAMM.sol#L144-L144)']
```solidity
144:                 sizeLeft = 0;
```
['[196](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/AbstractAMM.sol#L196-L196)']
```solidity
196:             bidPartiallyFilledSize = 0;
```
['[181](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L181-L181)']
```solidity
181:             balances[_accountKey(_msgSender(), _tokens[i])] = 0;
```
['[485](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L485-L485)']
```solidity
485:                 _orderIdsCanceled[i] = 0;
```
['[700](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L700-L700)']
```solidity
700:                 orderIdsCanceled[i] = 0;
```
['[850](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L850-L850)']
```solidity
850:         baseFeeCollected = 0;
```
['[851](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L851-L851)']
```solidity
851:         quoteFeeCollected = 0;
```


</details>

## [Gas-13] Function calls within for loops

### Resolution 
Making function calls or external calls within loops in Solidity can lead to inefficient gas usage, potential bottlenecks, and increased vulnerability to attacks. Each function call or external call consumes gas, and when executed within a loop, the gas cost multiplies, potentially causing the transaction to run out of gas or exceed block gas limits. This can result in transaction failure or unpredictable behavior.

Num of instances: 21

### Findings 


<details><summary>Click to show findings</summary>

['[348](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L348-L364)']
```solidity
348:         for (uint256 i = 0; i < _marketAddresses.length; i++) {
349:             address _currentMarket = _marketAddresses[i];
350:             MarketParams memory _marketParams = verifiedMarket[_currentMarket];
351:             require(_marketParams.pricePrecision > 0, RouterErrors.InvalidMarket());
352:             IOrderBook market = IOrderBook(_currentMarket);
353:             uint256 _value = _nativeSend[i] ? _amount : 0;
354:             _amountOut = _isBuy[i]
355:                 ? (
356:                     market.placeAndExecuteMarketBuy{value: _value}(
357:                         toU96(_amount * _marketParams.pricePrecision / 10 ** _marketParams.quoteAssetDecimals), // <= FOUND
358:                         0,
359:                         false,
360:                         true
361:                     )
362:                 )
363:                 : market.placeAndExecuteMarketSell{value: _value}(
364:                     toU96(_amount * _marketParams.sizePrecision / 10 ** _marketParams.baseAssetDecimals), 0, false, true // <= FOUND
365:                 );
366: 
367:             _amount = _amountOut;
368:         }
```
['[299](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L299-L300)']
```solidity
299:        for (uint256 i = 0; i < contracts.length; i++) {
300:             Ownable(contracts[i]).transferOwnership(_newOwner); // <= FOUND
301:         }
```
['[299](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L299-L300)']
```solidity
299:         for (uint256 i = 0; i < contracts.length; i++) {
300:             Ownable(contracts[i]).transferOwnership(_newOwner); // <= FOUND
301:         }
```
['[179](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L179-L186)']
```solidity
179:        for (uint256 i = 0; i < _tokens.length; i++) {
180:             _balance = balances[_accountKey(_msgSender(), _tokens[i])]; // <= FOUND
181:             balances[_accountKey(_msgSender(), _tokens[i])] = 0; // <= FOUND
182:             if (_balance > 0) {
183:                 if (_tokens[i] == NATIVE) {
184:                     _msgSender().safeTransferETH(_balance); // <= FOUND
185:                 } else {
186:                     _tokens[i].safeTransfer(_msgSender(), _balance); // <= FOUND
187:                 }
188:             }
189:         }
```
['[179](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L179-L186)']
```solidity
179:         for (uint256 i = 0; i < _tokens.length; i++) {
180:             _balance = balances[_accountKey(_msgSender(), _tokens[i])]; // <= FOUND
181:             balances[_accountKey(_msgSender(), _tokens[i])] = 0; // <= FOUND
182:             if (_balance > 0) {
183:                 if (_tokens[i] == NATIVE) {
184:                     _msgSender().safeTransferETH(_balance); // <= FOUND
185:                 } else {
186:                     _tokens[i].safeTransfer(_msgSender(), _balance); // <= FOUND
187:                 }
188:             }
189:         }
```
['[272](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L272-L273)']
```solidity
272:        for (uint256 i = 0; i < markets.length; i++) {
273:             IOrderBook(markets[i]).toggleMarket(state); // <= FOUND
274:         }
```
['[272](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L272-L273)']
```solidity
272:         for (uint256 i = 0; i < markets.length; i++) {
273:             IOrderBook(markets[i]).toggleMarket(state); // <= FOUND
274:         }
```
['[705](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L705-L706)']
```solidity
705:         for (uint256 i = 0; i < buyPrices.length; i++) {
706:             addBuyOrder(buyPrices[i], buySizes[i], postOnly); // <= FOUND
707:         }
```
['[661](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L661-L663)']
```solidity
661:        for (uint256 i = 0; i < prices.length; i++) {
662:             if (isBuy[i]) {
663:                 addFlipBuyOrder(prices[i], flipPrices[i], sizes[i], _provisionOrRevert); // <= FOUND
664:             } else {
665:                 addFlipSellOrder(prices[i], flipPrices[i], sizes[i], _provisionOrRevert);
666:             }
667:         }
```
['[661](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L661-L663)']
```solidity
661:         for (uint256 i = 0; i < prices.length; i++) {
662:             if (isBuy[i]) {
663:                 addFlipBuyOrder(prices[i], flipPrices[i], sizes[i], _provisionOrRevert); // <= FOUND
664:             } else {
665:                 addFlipSellOrder(prices[i], flipPrices[i], sizes[i], _provisionOrRevert);
666:             }
667:         }
```
['[710](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L710-L711)']
```solidity
710:         for (uint256 i = 0; i < sellPrices.length; i++) {
711:             addSellOrder(sellPrices[i], sellSizes[i], postOnly); // <= FOUND
712:         }
```
['[637](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L637-L638)']
```solidity
637:        for (uint256 i = 0; i < bidPrices.length; i++) {
638:             addPairedLiquidity(bidPrices[i], askPrices[i], bidSizes[i], askSizes[i]); // <= FOUND
639:         }
```
['[637](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L637-L638)']
```solidity
637:         for (uint256 i = 0; i < bidPrices.length; i++) {
638:             addPairedLiquidity(bidPrices[i], askPrices[i], bidSizes[i], askSizes[i]); // <= FOUND
639:         }
```
['[453](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L453-L454)']
```solidity
453:        for (uint256 i = 0; i < _orderIds.length; i++) {
454:             _cancelFlipOrder(_orderIds[i]); // <= FOUND
455:         }
```
['[453](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L453-L454)']
```solidity
453:         for (uint256 i = 0; i < _orderIds.length; i++) {
454:             _cancelFlipOrder(_orderIds[i]); // <= FOUND
455:         }
```
['[466](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L466-L467)']
```solidity
466:        for (uint256 i = 0; i < _orderIds.length; i++) {
467:             _cancelOrder(_orderIds[i], true); // <= FOUND
468:         }
```
['[480](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L480-L481)']
```solidity
480:        for (uint256 i = 0; i < _orderIds.length; i++) {
481:             bool _isCanceled = _cancelOrder(_orderIds[i], false); // <= FOUND
482:             if (_isCanceled) {
483:                 _orderIdsCanceled[i] = _orderIds[i];
484:             } else {
485:                 _orderIdsCanceled[i] = 0;
486:             }
487:         }
```
['[695](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L695-L696)']
```solidity
695:        for (uint256 i = 0; i < orderIdsToCancel.length; i++) {
696:             bool _isCanceled = _cancelOrder(orderIdsToCancel[i], false); // <= FOUND
697:             if (_isCanceled) {
698:                 orderIdsCanceled[i] = orderIdsToCancel[i];
699:             } else {
700:                 orderIdsCanceled[i] = 0;
701:             }
702:         }
```
['[466](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L466-L467)']
```solidity
466:         for (uint256 i = 0; i < _orderIds.length; i++) {
467:             _cancelOrder(_orderIds[i], true); // <= FOUND
468:         }
```
['[480](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L480-L481)']
```solidity
480:         for (uint256 i = 0; i < _orderIds.length; i++) {
481:             bool _isCanceled = _cancelOrder(_orderIds[i], false); // <= FOUND
482:             if (_isCanceled) {
483:                 _orderIdsCanceled[i] = _orderIds[i];
484:             } else {
485:                 _orderIdsCanceled[i] = 0;
486:             }
487:         }
```
['[695](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L695-L696)']
```solidity
695:         for (uint256 i = 0; i < orderIdsToCancel.length; i++) {
696:             bool _isCanceled = _cancelOrder(orderIdsToCancel[i], false); // <= FOUND
697:             if (_isCanceled) {
698:                 orderIdsCanceled[i] = orderIdsToCancel[i];
699:             } else {
700:                 orderIdsCanceled[i] = 0;
701:             }
702:         }
```


</details>

## [Gas-14] For loops in public or external functions should be avoided due to high gas costs and possible DOS

### Resolution 
In Solidity, for loops can potentially cause Denial of Service (DoS) attacks if not handled carefully. DoS attacks can occur when an attacker intentionally exploits the gas cost of a function, causing it to run out of gas or making it too expensive for other users to call. Below are some scenarios where for loops can lead to DoS attacks: Nested for loops can become exceptionally gas expensive and should be used sparingly

Num of instances: 15

### Findings 


<details><summary>Click to show findings</summary>

['[105](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruForwarder.sol#L105-L106)']
```solidity
105:     function setAllowedInterfaces(bytes4[] memory _allowedInterfaces) external onlyOwner {
106:         for (uint256 i = 0; i < _allowedInterfaces.length; i++) { // <= FOUND
107:             allowedInterface[_allowedInterfaces[i]] = true;
108:         }
109:     }
```
['[111](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruForwarder.sol#L111-L112)']
```solidity
111:     function removeAllowedInterfaces(bytes4[] memory _allowedInterfaces) external onlyOwner {
112:         for (uint256 i = 0; i < _allowedInterfaces.length; i++) { // <= FOUND
113:             allowedInterface[_allowedInterfaces[i]] = false;
114:         }
115:     }
```
['[177](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L177-L179)']
```solidity
177:     function batchWithdrawMaxTokens(address[] calldata _tokens) external protocolActive {
178:         uint256 _balance;
179:         for (uint256 i = 0; i < _tokens.length; i++) { // <= FOUND
180:             _balance = balances[_accountKey(_msgSender(), _tokens[i])];
181:             balances[_accountKey(_msgSender(), _tokens[i])] = 0;
182:             if (_balance > 0) {
183:                 if (_tokens[i] == NATIVE) {
184:                     _msgSender().safeTransferETH(_balance);
185:                 } else {
186:                     _tokens[i].safeTransfer(_msgSender(), _balance);
187:                 }
188:             }
189:         }
190:     }
```
['[452](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L452-L453)']
```solidity
452:     function batchCancelFlipOrders(uint40[] calldata _orderIds) external marketNotHardPaused {
453:         for (uint256 i = 0; i < _orderIds.length; i++) { // <= FOUND
454:             _cancelFlipOrder(_orderIds[i]);
455:         }
456: 
457:         emit FlipOrdersCanceled(_orderIds, _msgSender());
458:     }
```
['[465](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L465-L466)']
```solidity
465:     function batchCancelOrders(uint40[] calldata _orderIds) external marketNotHardPaused {
466:         for (uint256 i = 0; i < _orderIds.length; i++) { // <= FOUND
467:             _cancelOrder(_orderIds[i], true);
468:         }
469: 
470:         emit OrdersCanceled(_orderIds, _msgSender());
471:     }
```
['[478](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L478-L480)']
```solidity
478:     function batchCancelOrdersNoRevert(uint40[] calldata _orderIds) external marketNotHardPaused {
479:         uint40[] memory _orderIdsCanceled = new uint40[](_orderIds.length);
480:         for (uint256 i = 0; i < _orderIds.length; i++) { // <= FOUND
481:             bool _isCanceled = _cancelOrder(_orderIds[i], false);
482:             if (_isCanceled) {
483:                 _orderIdsCanceled[i] = _orderIds[i];
484:             } else {
485:                 _orderIdsCanceled[i] = 0;
486:             }
487:         }
488: 
489:         emit OrdersCanceled(_orderIdsCanceled, _msgSender());
490:     }
```
['[628](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L628-L637)']
```solidity
628:     function batchAddPairedLiquidity(
629:         uint32[] calldata bidPrices,
630:         uint32[] calldata askPrices,
631:         uint96[] calldata bidSizes,
632:         uint96[] calldata askSizes
633:     ) external {
634:         require(
635:             bidPrices.length == bidSizes.length && askPrices.length == askSizes.length, OrderBookErrors.LengthMismatch()
636:         );
637:         for (uint256 i = 0; i < bidPrices.length; i++) { // <= FOUND
638:             addPairedLiquidity(bidPrices[i], askPrices[i], bidSizes[i], askSizes[i]);
639:         }
640:     }
```
['[651](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L651-L661)']
```solidity
651:     function batchProvisionLiquidity(
652:         uint32[] calldata prices,
653:         uint32[] calldata flipPrices,
654:         uint96[] calldata sizes,
655:         bool[] calldata isBuy,
656:         bool _provisionOrRevert
657:     ) external {
658:         require(prices.length == flipPrices.length, OrderBookErrors.LengthMismatch());
659:         require(sizes.length == isBuy.length, OrderBookErrors.LengthMismatch());
660:         require(prices.length == sizes.length, OrderBookErrors.LengthMismatch());
661:         for (uint256 i = 0; i < prices.length; i++) { // <= FOUND
662:             if (isBuy[i]) {
663:                 addFlipBuyOrder(prices[i], flipPrices[i], sizes[i], _provisionOrRevert);
664:             } else {
665:                 addFlipSellOrder(prices[i], flipPrices[i], sizes[i], _provisionOrRevert);
666:             }
667:         }
668:     }
```
['[679](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L679-L710)']
```solidity
679:     function batchUpdate(
680:         uint32[] calldata buyPrices,
681:         uint96[] calldata buySizes,
682:         uint32[] calldata sellPrices,
683:         uint96[] calldata sellSizes,
684:         uint40[] calldata orderIdsToCancel,
685:         bool postOnly
686:     ) external marketNotHardPaused {
687:         
688:         require(buyPrices.length == buySizes.length, OrderBookErrors.LengthMismatch());
689: 
690:         
691:         require(sellPrices.length == sellSizes.length, OrderBookErrors.LengthMismatch());
692: 
693:         uint40[] memory orderIdsCanceled = new uint40[](orderIdsToCancel.length);
694:         
695:         for (uint256 i = 0; i < orderIdsToCancel.length; i++) { // <= FOUND
696:             bool _isCanceled = _cancelOrder(orderIdsToCancel[i], false);
697:             if (_isCanceled) {
698:                 orderIdsCanceled[i] = orderIdsToCancel[i];
699:             } else {
700:                 orderIdsCanceled[i] = 0;
701:             }
702:         }
703: 
704:         
705:         for (uint256 i = 0; i < buyPrices.length; i++) { // <= FOUND
706:             addBuyOrder(buyPrices[i], buySizes[i], postOnly);
707:         }
708: 
709:         
710:         for (uint256 i = 0; i < sellPrices.length; i++) { // <= FOUND
711:             addSellOrder(sellPrices[i], sellSizes[i], postOnly);
712:         }
713: 
714:         
715:         if (orderIdsCanceled.length > 0) {
716:             emit OrdersCanceled(orderIdsCanceled, _msgSender());
717:         }
718:     }
```
['[271](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L271-L272)']
```solidity
271:     function toggleMarkets(address[] memory markets, IOrderBook.MarketState state) external onlyOwner {
272:         for (uint256 i = 0; i < markets.length; i++) { // <= FOUND
273:             IOrderBook(markets[i]).toggleMarket(state);
274:         }
275:     }
```
['[298](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L298-L299)']
```solidity
298:     function transferOwnershipForContracts(address[] memory contracts, address _newOwner) external onlyOwner {
299:         for (uint256 i = 0; i < contracts.length; i++) { // <= FOUND
300:             Ownable(contracts[i]).transferOwnership(_newOwner);
301:         }
302:     }
```
['[331](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L331-L348)']
```solidity
331:     function anyToAnySwap(
332:         address[] calldata _marketAddresses,
333:         bool[] calldata _isBuy,
334:         bool[] calldata _nativeSend,
335:         address _debitToken,
336:         address _creditToken,
337:         uint256 _amount,
338:         uint256 _minAmountOut
339:     ) external payable returns (uint256 _amountOut) {
340:         require(_marketAddresses.length >= 1, RouterErrors.NoMarketsPassed());
341:         require(_isBuy.length == _marketAddresses.length, RouterErrors.LengthMismatch());
342:         require(_nativeSend.length == _marketAddresses.length, RouterErrors.LengthMismatch());
343:         if (_nativeSend[0] == false) {
344:             _debitToken.safeTransferFrom(msg.sender, address(this), _amount);
345:         }
346:         uint256 _cachedAmountIn = _amount;
347: 
348:         for (uint256 i = 0; i < _marketAddresses.length; i++) { // <= FOUND
349:             address _currentMarket = _marketAddresses[i];
350:             MarketParams memory _marketParams = verifiedMarket[_currentMarket];
351:             require(_marketParams.pricePrecision > 0, RouterErrors.InvalidMarket());
352:             IOrderBook market = IOrderBook(_currentMarket);
353:             uint256 _value = _nativeSend[i] ? _amount : 0;
354:             _amountOut = _isBuy[i]
355:                 ? (
356:                     market.placeAndExecuteMarketBuy{value: _value}(
357:                         toU96(_amount * _marketParams.pricePrecision / 10 ** _marketParams.quoteAssetDecimals),
358:                         0,
359:                         false,
360:                         true
361:                     )
362:                 )
363:                 : market.placeAndExecuteMarketSell{value: _value}(
364:                     toU96(_amount * _marketParams.sizePrecision / 10 ** _marketParams.baseAssetDecimals), 0, false, true
365:                 );
366: 
367:             _amount = _amountOut;
368:         }
369:         require(_amountOut >= _minAmountOut, RouterErrors.SlippageExceeded());
370:         emit KuruRouterSwap(msg.sender, _debitToken, _creditToken, _cachedAmountIn, _amountOut);
371:         if (_creditToken != address(0)) {
372:             _creditToken.safeTransfer(msg.sender, _amountOut);
373:         } else {
374:             msg.sender.safeTransferETH(_amountOut);
375:         }
376:     }
```
['[96](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruForwarder.sol#L96-L98)']
```solidity
96:     function initialize(address _owner, bytes4[] memory _allowedInterfaces) public initializer {
97:         _initializeOwner(_owner);
98:         for (uint256 i = 0; i < _allowedInterfaces.length; i++) { // <= FOUND
99:             allowedInterface[_allowedInterfaces[i]] = true;
100:         }
101:     }
```
['[281](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L281-L282)']
```solidity
281:     function upgradeMultipleOrderBookProxies(address[] memory proxies, bytes[] memory data) public onlyOwner {
282:         for (uint256 i = 0; i < proxies.length; i++) { // <= FOUND
283:             UUPSUpgradeable(proxies[i]).upgradeToAndCall(orderBookImplementation, data[i]);
284:         }
285:     }
```
['[287](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L287-L288)']
```solidity
287:     function upgradeMultipleVaultProxies(address[] memory proxies, bytes[] memory data) public onlyOwner {
288:         for (uint256 i = 0; i < proxies.length; i++) { // <= FOUND
289:             UUPSUpgradeable(proxies[i]).upgradeToAndCall(kuruAmmVaultImplementation, data[i]);
290:         }
291:     }
```


</details>

## [Gas-15] Mappings used within a function more than once should be cached to save gas

### Resolution 
Cache such mappings and perform operations on them, if operations include modifications to the mapping(s) then remember to equate the mapping to it's cached counterpart at the end

Num of instances: 1

### Findings 


<details><summary>Click to show findings</summary>

['[531](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L531-L566)']
```solidity
531:     function _executeCancel(uint40 _orderId, Order memory _order) internal { // <= FOUND
532:         
533:         if (_order.prev != OrderLinkedList.NULL) {
534:             s_orders[_order.prev].next = _order.next;
535:         }
536:         if (_order.next != OrderLinkedList.NULL) {
537:             s_orders[_order.next].prev = _order.prev;
538:         }
539: 
540:         if (_order.isBuy) {
541:             
542:             if (_orderId == s_buyPricePoints[_order.price].head) {
543:                 OrderLinkedList.updateHead(s_buyPricePoints[_order.price], _order.next);
544:                 if (_order.next == OrderLinkedList.NULL) {
545:                     
546:                     TreeMath.remove(s_buyTree, _order.price);
547:                 }
548:             } else {
549:                 OrderLinkedList.adjustForTail(s_buyPricePoints[_order.price], _order.prev, _order.next);
550:             }
551: 
552:             marginAccount.creditUser(
553:                 _order.ownerAddress,
554:                 quoteAsset,
555:                 (((toU96((_order.size * _order.price) / sizePrecision) * quoteDecimalMultiplier) / pricePrecision)),
556:                 true
557:             );
558:         } else {
559:             if (_orderId == s_sellPricePoints[_order.price].head) { // <= FOUND
560:                 OrderLinkedList.updateHead(s_sellPricePoints[_order.price], _order.next); // <= FOUND
561:                 if (_order.next == OrderLinkedList.NULL) {
562:                     
563:                     TreeMath.remove(s_sellTree, _order.price);
564:                 }
565:             } else {
566:                 OrderLinkedList.adjustForTail(s_sellPricePoints[_order.price], _order.prev, _order.next); // <= FOUND
567:             }
568: 
569:             marginAccount.creditUser(
570:                 _order.ownerAddress, baseAsset, ((_order.size * baseDecimalMultiplier) / sizePrecision), true
571:             );
572:         }
573: 
574:         emit OrderCanceled(_orderId, _order.ownerAddress, _order.price, _order.size, _order.isBuy);
575:     }
```


</details>

## [Gas-16] Use assembly to check for the zero address

### Resolution 
Using assembly for address comparisons in Solidity can save gas because it allows for more direct access to the Ethereum Virtual Machine (EVM), reducing the overhead of higher-level operations. Solidity's high-level abstraction simplifies coding but can introduce additional gas costs. Using assembly for simple operations like address comparisons can be more gas-efficient.

Num of instances: 12

### Findings 


<details><summary>Click to show findings</summary>

['[156](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L156-L164)']
```solidity
156:     function deposit(uint256 baseDeposit, uint256 quoteDeposit, address receiver)
157:         public
158:         payable
159:         nonReentrant
160:         returns (uint256)
161:     {
162:         require(
163:             (token1 == address(0) || token2 == address(0)) // <= FOUND
164:                 ? msg.value >= (token1 == address(0) ? baseDeposit : quoteDeposit) // <= FOUND
165:                 : msg.value == 0,
166:             KuruAMMVaultErrors.NativeAssetMismatch()
167:         );
168: 
169:         return _mintAndDeposit(baseDeposit, quoteDeposit, receiver);
170:     }
```
['[175](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L175-L212)']
```solidity
175:     function _mintAndDeposit(uint256 baseDeposit, uint256 quoteDeposit, address receiver) internal returns (uint256) {
176:         (uint256 _baseAmount, uint256 _currentAskPrice) = _returnNormalizedAmountAndPrice(true);
177:         uint256 _shares;
178:         if (totalSupply() != 0) {
179:             uint256 _expectedQuoteAmount = (
180:                 (
181:                     FixedPointMathLib.mulDivUp(baseDeposit, _currentAskPrice, vaultPricePrecision)
182:                         * 10 ** marketParams.quoteAssetDecimals
183:                 )
184:             ) / 10 ** marketParams.baseAssetDecimals;
185:             require(_expectedQuoteAmount <= quoteDeposit, KuruAMMVaultErrors.InsufficientQuoteToken());
186:             _shares = _convertToShares(baseDeposit, _expectedQuoteAmount, _currentAskPrice);
187:             quoteDeposit = _expectedQuoteAmount;
188:             _mint(receiver, _shares);
189:         } else {
190:             _shares = FixedPointMathLib.sqrt(baseDeposit * quoteDeposit);
191:             _mint(address(marginAccount), MIN_LIQUIDITY);
192:             _shares -= MIN_LIQUIDITY;
193:             _mint(receiver, _shares);
194:             _currentAskPrice = (
195:                 ((quoteDeposit * 10 ** marketParams.baseAssetDecimals)) * vaultPricePrecision
196:                     / 10 ** marketParams.quoteAssetDecimals
197:             ) / (baseDeposit);
198:         }
199:         require(_shares > 0, KuruAMMVaultErrors.InsufficientLiquidityMinted());
200:         (uint96 _newAskSize, uint96 _newBidSize) = _getVaultSizesForBaseAmount(_baseAmount + baseDeposit);
201:         market.updateVaultOrdSz(
202:             _newAskSize,
203:             _newBidSize,
204:             _currentAskPrice,
205:             FixedPointMathLib.mulDivRound(_currentAskPrice, BPS_MULTIPLIER, BPS_MULTIPLIER + SPREAD_CONSTANT),
206:             false
207:         );
208:         address _token1 = token1;
209:         address _token2 = token2;
210:         _depositAmountsToMarginAccount(_token1, _token2, baseDeposit, quoteDeposit);
211:         uint256 _nativeRefund =
212:             _token1 == address(0) ? (msg.value - baseDeposit) : (_token2 == address(0) ? (msg.value - quoteDeposit) : 0); // <= FOUND
213:         if (_nativeRefund > 0) {
214:             msg.sender.safeTransferETH(_nativeRefund);
215:         }
216:         emit KuruVaultDeposit(baseDeposit, quoteDeposit, _shares, receiver);
217:         return _shares;
218:     }
```
['[220](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L220-L230)']
```solidity
220:     function _depositAmountsToMarginAccount(address _token1, address _token2, uint256 baseDeposit, uint256 quoteDeposit)
221:         internal
222:     {
223:         if (_token1 == address(0)) { // <= FOUND
224:             marginAccount.deposit{value: baseDeposit}(address(this), _token1, baseDeposit);
225:         } else {
226:             _token1.safeTransferFrom(msg.sender, address(this), baseDeposit);
227:             marginAccount.deposit(address(this), _token1, baseDeposit);
228:         }
229: 
230:         if (_token2 == address(0)) { // <= FOUND
231:             marginAccount.deposit{value: quoteDeposit}(address(this), _token2, quoteDeposit);
232:         } else {
233:             _token2.safeTransferFrom(msg.sender, address(this), quoteDeposit);
234:             marginAccount.deposit(address(this), _token2, quoteDeposit);
235:         }
236:     }
```
['[294](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L294-L295)']
```solidity
294:     function _transferTokensToUser(uint256 amount, address token, address receiver) internal {
295:         if (token == address(0)) { // <= FOUND
296:             receiver.safeTransferETH(amount);
297:         } else {
298:             token.safeTransfer(receiver, amount);
299:         }
300:     }
```
['[728](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L728-L745)']
```solidity
728:     function placeAndExecuteMarketBuy(uint96 _quoteSize, uint256 _minAmountOut, bool _isMargin, bool _isFillOrKill)
729:         public
730:         payable
731:         override
732:         marketActive
733:         nonReentrant
734:         returns (uint256)
735:     {
736:         OrderBookType _type = orderBookType;
737: 
738:         if (_type == OrderBookType.NATIVE_IN_QUOTE && !_isMargin && (msg.sender != address(0))) { // <= FOUND
739:             require(
740:                 msg.value >= _pricePrecisionToQuoteAssetPrecision(_quoteSize), OrderBookErrors.NativeAssetInsufficient()
741:             );
742:             require(
743:                 msg.value < _pricePrecisionToQuoteAssetPrecision(_quoteSize + 1), OrderBookErrors.NativeAssetSurplus()
744:             );
745:         } else if (msg.sender != address(0)) { // <= FOUND
746:             require(msg.value == 0, OrderBookErrors.NativeAssetNotRequired());
747:             _isMargin
748:                 ? marginAccount.debitUser(_msgSender(), quoteAsset, _pricePrecisionToQuoteAssetPrecision(_quoteSize))
749:                 : quoteAsset.safeTransferFrom(
750:                     _msgSender(), address(marginAccount), _pricePrecisionToQuoteAssetPrecision(_quoteSize)
751:                 );
752:         }
753: 
754:         uint256 _baseTokensCredited;
755:         (_quoteSize, _baseTokensCredited) = _marketBuyMatch(_quoteSize, _isMargin);
756:         if (msg.sender == address(0)) { // <= FOUND
757:             return _baseTokensCredited;
758:         }
759:         if (_quoteSize > 0) {
760:             require(!_isFillOrKill, OrderBookErrors.InsufficientLiquidity());
761:             if (_type == OrderBookType.NATIVE_IN_QUOTE && !_isMargin) {
762:                 
763:                 uint256 _refund = _pricePrecisionToQuoteAssetPrecision(_quoteSize);
764:                 _handleNativeMarketRefundTransfer(_refund);
765:             } else {
766:                 marginAccount.creditUser(
767:                     _msgSender(), quoteAsset, _pricePrecisionToQuoteAssetPrecision(_quoteSize), _isMargin
768:                 );
769:             }
770:         } else if (_type == OrderBookType.NATIVE_IN_QUOTE) {
771:             address(marginAccount).safeTransferETH(msg.value);
772:         }
773:         require(_baseTokensCredited >= _minAmountOut, OrderBookErrors.SlippageExceeded());
774: 
775:         return _baseTokensCredited;
776:     }
```
['[786](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L786-L797)']
```solidity
786:     function placeAndExecuteMarketSell(uint96 _size, uint256 _minAmountOut, bool _isMargin, bool _isFillOrKill)
787:         public
788:         payable
789:         marketActive
790:         nonReentrant
791:         returns (uint256)
792:     {
793:         OrderBookType _type = orderBookType;
794:         if (_type == OrderBookType.NATIVE_IN_BASE && !_isMargin && (msg.sender != address(0))) { // <= FOUND
795:             require(msg.value >= _sizePrecisionToBaseAssetPrecision(_size), OrderBookErrors.NativeAssetInsufficient());
796:             require(msg.value < _sizePrecisionToBaseAssetPrecision(_size + 1), OrderBookErrors.NativeAssetSurplus());
797:         } else if (msg.sender != address(0)) { // <= FOUND
798:             require(msg.value == 0, OrderBookErrors.NativeAssetNotRequired());
799:             _isMargin
800:                 ? marginAccount.debitUser(_msgSender(), baseAsset, _sizePrecisionToBaseAssetPrecision(_size))
801:                 : baseAsset.safeTransferFrom(
802:                     _msgSender(), address(marginAccount), _sizePrecisionToBaseAssetPrecision(_size)
803:                 );
804:         }
805: 
806:         uint256 _quoteCredited;
807:         (_size, _quoteCredited) = _matchAggressiveSell(0, _size, _isMargin);
808:         if (msg.sender == address(0)) { // <= FOUND
809:             return _quoteCredited;
810:         }
811:         if (_size > 0) {
812:             require(!_isFillOrKill, OrderBookErrors.InsufficientLiquidity());
813:             if (_type == OrderBookType.NATIVE_IN_BASE && !_isMargin) {
814:                 uint256 _refund = _sizePrecisionToBaseAssetPrecision(_size);
815:                 _handleNativeMarketRefundTransfer(_refund);
816:             } else {
817:                 marginAccount.creditUser(_msgSender(), baseAsset, _sizePrecisionToBaseAssetPrecision(_size), _isMargin);
818:             }
819:         } else if (_type == OrderBookType.NATIVE_IN_BASE) {
820:             address(marginAccount).safeTransferETH(msg.value);
821:         }
822:         require(_quoteCredited >= _minAmountOut, OrderBookErrors.SlippageExceeded());
823:         return _quoteCredited;
824:     }
```
['[74](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L74-L95)']
```solidity
74:     function deployProxy(
75:         IOrderBook.OrderBookType _type,
76:         address _baseAssetAddress,
77:         address _quoteAssetAddress,
78:         uint96 _sizePrecision,
79:         uint32 _pricePrecision,
80:         uint32 _tickSize,
81:         uint96 _minSize,
82:         uint96 _maxSize,
83:         uint256 _takerFeeBps,
84:         uint256 _makerFeeBps,
85:         uint96 _kuruAmmSpread
86:     ) public returns (address proxy) {
87:         if (_type == IOrderBook.OrderBookType.NATIVE_IN_BASE) {
88:             require(_baseAssetAddress == address(0), RouterErrors.MarketTypeMismatch()); // <= FOUND
89:             require(_quoteAssetAddress != address(0), RouterErrors.MarketTypeMismatch()); // <= FOUND
90:         } else if (_type == IOrderBook.OrderBookType.NATIVE_IN_QUOTE) {
91:             require(_baseAssetAddress != address(0), RouterErrors.MarketTypeMismatch()); // <= FOUND
92:             require(_quoteAssetAddress == address(0), RouterErrors.MarketTypeMismatch()); // <= FOUND
93:         } else {
94:             require(_baseAssetAddress != address(0), RouterErrors.MarketTypeMismatch()); // <= FOUND
95:             require(_quoteAssetAddress != address(0), RouterErrors.MarketTypeMismatch()); // <= FOUND
96:             require(_baseAssetAddress != _quoteAssetAddress, RouterErrors.BaseAndQuoteAssetSame());
97:         }
98:         require(_tickSize > 0, RouterErrors.InvalidTickSize());
99:         require(10 ** Math.log10(_sizePrecision) == _sizePrecision, RouterErrors.InvalidSizePrecision());
100:         require(10 ** Math.log10(_pricePrecision) == _pricePrecision, RouterErrors.InvalidPricePrecision());
101:         uint256 _baseAssetDecimals =
102:             _type == IOrderBook.OrderBookType.NATIVE_IN_BASE ? 18 : IERC20Metadata(_baseAssetAddress).decimals();
103:         uint256 _quoteAssetDecimals =
104:             _type == IOrderBook.OrderBookType.NATIVE_IN_QUOTE ? 18 : IERC20Metadata(_quoteAssetAddress).decimals();
105:         {
106:             bytes32 _salt = _getSalt(
107:                 _baseAssetAddress,
108:                 _quoteAssetAddress,
109:                 _sizePrecision,
110:                 _pricePrecision,
111:                 _tickSize,
112:                 _minSize,
113:                 _maxSize,
114:                 _takerFeeBps,
115:                 _makerFeeBps,
116:                 _kuruAmmSpread
117:             );
118:             proxy = Create2.deploy(
119:                 0,
120:                 _salt,
121:                 abi.encodePacked(type(ERC1967Proxy).creationCode, abi.encode(orderBookImplementation, bytes("")))
122:             );
123:         }
124:         IKuruAMMVault _kuruAmmVault = IKuruAMMVault(
125:             Create2.deploy(
126:                 0,
127:                 keccak256(abi.encode(proxy)),
128:                 abi.encodePacked(type(ERC1967Proxy).creationCode, abi.encode(kuruAmmVaultImplementation, bytes("")))
129:             )
130:         );
131: 
132:         verifiedMarket[proxy] = MarketParams(
133:             _pricePrecision,
134:             _sizePrecision,
135:             _baseAssetAddress,
136:             _baseAssetDecimals,
137:             _quoteAssetAddress,
138:             _quoteAssetDecimals,
139:             _tickSize,
140:             _minSize,
141:             _maxSize,
142:             _takerFeeBps,
143:             _makerFeeBps
144:         );
145:         IMarginAccount(marginAccountAddress).updateMarkets(proxy);
146:         {
147:             IOrderBook(proxy).initialize(
148:                 address(this),
149:                 _type,
150:                 _baseAssetAddress,
151:                 _baseAssetDecimals,
152:                 _quoteAssetAddress,
153:                 _quoteAssetDecimals,
154:                 marginAccountAddress,
155:                 _sizePrecision,
156:                 _pricePrecision,
157:                 _tickSize,
158:                 _minSize,
159:                 _maxSize,
160:                 _takerFeeBps,
161:                 _makerFeeBps,
162:                 address(_kuruAmmVault),
163:                 _kuruAmmSpread,
164:                 TRUSTED_FORWARDER
165:             );
166:         }
167: 
168:         _kuruAmmVault.initialize(
169:             address(this), _baseAssetAddress, _quoteAssetAddress, marginAccountAddress, proxy, _kuruAmmSpread
170:         );
171: 
172:         _setApprovalsForMarket(_baseAssetAddress, _quoteAssetAddress, proxy, _type);
173: 
174:         emit MarketRegistered(
175:             _baseAssetAddress,
176:             _quoteAssetAddress,
177:             proxy,
178:             address(_kuruAmmVault),
179:             _pricePrecision,
180:             _sizePrecision,
181:             _tickSize,
182:             _minSize,
183:             _maxSize,
184:             _takerFeeBps,
185:             _makerFeeBps,
186:             _kuruAmmSpread
187:         );
188: 
189:         return proxy;
190:     }
```
['[45](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L45-L75)']
```solidity
45:     function initialize(
46:         address _owner,
47:         address token1_,
48:         address token2_,
49:         address _marginAccount,
50:         address _market,
51:         uint96 _spreadConstant
52:     ) public initializer {
53:         owner = _owner;
54:         token1 = token1_;
55:         token1Decimals = token1_ != address(0) ? ERC20(token1_).decimals() : 18; // <= FOUND
56:         token2 = token2_;
57:         token2Decimals = token2_ != address(0) ? ERC20(token2_).decimals() : 18; // <= FOUND
58:         marginAccount = IMarginAccount(_marginAccount);
59:         market = IOrderBook(_market);
60:         SPREAD_CONSTANT = _spreadConstant;
61:         setMarketParams();
62:         if (token1_ != address(0)) { // <= FOUND
63:             token1_.safeApprove(_marginAccount, type(uint256).max);
64:         }
65:         if (token2_ != address(0)) { // <= FOUND
66:             token2_.safeApprove(_marginAccount, type(uint256).max);
67:         }
68:         string memory token1Symbol;
69:         string memory token2Symbol;
70:         if (token1_ != address(0)) { // <= FOUND
71:             token1Symbol = ERC20(token1_).symbol();
72:         } else {
73:             token1Symbol = "MON";
74:         }
75:         if (token2_ != address(0)) { // <= FOUND
76:             token2Symbol = ERC20(token2_).symbol();
77:         } else {
78:             token2Symbol = "MON";
79:         }
80:         _name = string.concat(token1Symbol, "-", token2Symbol, "-", "KURU-AMM-VAULT");
81:     }
```
['[198](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L198-L199)']
```solidity
198:     function deposit(address _user, address _token, uint256 _amount) external payable protocolActive {
199:         require(_user != address(0), MarginAccountErrors.ZeroAddressNotAllowed()); // <= FOUND
200:         if (_token == NATIVE) {
201:             require(msg.value == _amount, MarginAccountErrors.NativeAssetMismatch());
202:             balances[_accountKey(_user, NATIVE)] += _amount;
203:         } else {
204:             require(msg.value == 0, MarginAccountErrors.NativeAssetMismatch());
205:             balances[_accountKey(_user, _token)] += _amount;
206:             _token.safeTransferFrom(_msgSender(), address(this), _amount);
207:         }
208: 
209:         emit Deposit(_user, _token, _amount);
210:     }
```
['[930](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L930-L988)']
```solidity
930:     function _marketBuyMatch(uint96 _quoteSize, bool _isMargin) internal returns (uint96, uint256) {
931:         uint96 sizeToCreditTaker;
932:         uint96 sizeToCreditViaVault;
933:         bytes memory makerCredits;
934:         uint32 _pricePrecision = pricePrecision;
935:         uint96 _sizePrecision = sizePrecision;
936: 
937:         (bool _isVaultFill, uint256 _bestAsk) = bestAsk();
938: 
939:         while (_quoteSize > 0 && _bestAsk != 0) {
940:             bytes memory priceUpdate;
941:             if (_isVaultFill) {
942:                 uint96 _sizeFilled;
943:                 (_quoteSize, _sizeFilled, priceUpdate) = _fillVaultBuyMatch(_getOBAsk(), _quoteSize);
944:                 sizeToCreditViaVault += _sizeFilled;
945:                 sizeToCreditTaker += _sizeFilled;
946:             } else {
947:                 
948:                 uint96 _sizeFillableAtPriceLeft =
949:                     toU96(_quoteSize * _sizePrecision * vaultPricePrecision / (_bestAsk * _pricePrecision));
950:                 uint96 _sizeFillableAtPriceBefore = _sizeFillableAtPriceLeft; 
951:                 (_sizeFillableAtPriceLeft, priceUpdate) = _fillSizeForPrice(
952:                     s_sellTree,
953:                     toU32(_bestAsk * _pricePrecision / vaultPricePrecision),
954:                     s_sellPricePoints[(_bestAsk * _pricePrecision / vaultPricePrecision)],
955:                     _sizeFillableAtPriceLeft
956:                 );
957:                 sizeToCreditTaker += (_sizeFillableAtPriceBefore - _sizeFillableAtPriceLeft);
958:                 _quoteSize = toU96(
959:                     FixedPointMathLib.mulDiv(
960:                         _bestAsk * _pricePrecision, _sizeFillableAtPriceLeft, _sizePrecision * vaultPricePrecision
961:                     )
962:                 );
963:             }
964:             makerCredits = bytes.concat(makerCredits, priceUpdate);
965: 
966:             (_isVaultFill, _bestAsk) = bestAsk();
967:         }
968: 
969:         if (sizeToCreditTaker == 0) {
970:             return (_quoteSize, 0);
971:         }
972: 
973:         {
974:             uint256 _baseDecimalMultiplier = baseDecimalMultiplier;
975:             uint256 _tokenCredit = (sizeToCreditTaker * _baseDecimalMultiplier) / _sizePrecision;
976:             if (sizeToCreditViaVault > 0 && msg.sender != address(0)) { // <= FOUND
977:                 marginAccount.debitUser(
978:                     kuruAmmVault, baseAsset, (sizeToCreditViaVault * _baseDecimalMultiplier) / _sizePrecision
979:                 );
980:             }
981:             uint256 _takerFeeBps = takerFeeBps;
982:             if (_takerFeeBps > 0) {
983:                 uint256 _feeDebit = FixedPointMathLib.mulDivUp(_tokenCredit, _takerFeeBps, BPS_MULTIPLIER);
984:                 _tokenCredit -= _feeDebit;
985:                 
986:                 baseFeeCollected += ((_feeDebit * (_takerFeeBps - makerFeeBps)) / _takerFeeBps);
987:             }
988:             if (msg.sender != address(0)) { // <= FOUND
989:                 marginAccount.creditUsersEncoded(
990:                     bytes.concat(makerCredits, abi.encode(_msgSender(), baseAsset, _tokenCredit, _isMargin))
991:                 );
992:             }
993:             return (_quoteSize, _tokenCredit);
994:         }
995:     }
```
['[1003](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L1003-L1063)']
```solidity
1003:     function _matchAggressiveSell(uint256 _limitPrice, uint96 _sizeToBeFilledLeft, bool _useMargin)
1004:         internal
1005:         returns (uint96, uint256)
1006:     {
1007:         uint96 quoteCreditTaker;
1008:         uint256 quoteCreditVaultTaker;
1009:         uint256 tokenCredit;
1010:         (bool _isVaultFill, uint256 _bestBid) = bestBid();
1011:         bytes memory makerCredits;
1012:         uint32 _pricePrecision = pricePrecision;
1013:         _limitPrice = _limitPrice * vaultPricePrecision / _pricePrecision;
1014:         while (_sizeToBeFilledLeft > 0 && _bestBid >= _limitPrice && _bestBid != type(uint256).max) {
1015:             uint96 _sizeToBeFilledBefore = _sizeToBeFilledLeft; 
1016: 
1017:             bytes memory priceUpdate;
1018: 
1019:             if (_isVaultFill) {
1020:                 uint256 _quoteToTaker;
1021:                 (_sizeToBeFilledLeft, _quoteToTaker, priceUpdate) =
1022:                     _fillVaultForSell(_getOBBid() >= _limitPrice ? _getOBBid() : _limitPrice - 1, _sizeToBeFilledLeft);
1023:                 quoteCreditVaultTaker += _quoteToTaker;
1024:             } else {
1025:                 (_sizeToBeFilledLeft, priceUpdate) = _fillSizeForPrice(
1026:                     s_buyTree,
1027:                     toU32(_bestBid * _pricePrecision / vaultPricePrecision),
1028:                     s_buyPricePoints[_bestBid * _pricePrecision / vaultPricePrecision],
1029:                     _sizeToBeFilledLeft
1030:                 );
1031:                 quoteCreditTaker += toU96(
1032:                     FixedPointMathLib.mulDiv(
1033:                         _sizeToBeFilledBefore - _sizeToBeFilledLeft,
1034:                         toU32(_bestBid * _pricePrecision / vaultPricePrecision),
1035:                         sizePrecision
1036:                     )
1037:                 );
1038:             }
1039:             makerCredits = bytes.concat(makerCredits, priceUpdate);
1040: 
1041:             (_isVaultFill, _bestBid) = bestBid();
1042:         }
1043: 
1044:         if (quoteCreditTaker == 0 && quoteCreditVaultTaker == 0) {
1045:             return (_sizeToBeFilledLeft, 0);
1046:         }
1047:         {
1048:             uint256 _quoteDecimalMultiplier = quoteDecimalMultiplier;
1049:             tokenCredit = ((quoteCreditTaker) * _quoteDecimalMultiplier) / _pricePrecision
1050:                 + (quoteCreditVaultTaker * _quoteDecimalMultiplier) / vaultPricePrecision;
1051:             if (quoteCreditVaultTaker > 0 && msg.sender != address(0)) { // <= FOUND
1052:                 marginAccount.debitUser(
1053:                     kuruAmmVault, quoteAsset, (quoteCreditVaultTaker * _quoteDecimalMultiplier) / vaultPricePrecision
1054:                 );
1055:             }
1056:             uint256 _takerFeeBps = takerFeeBps;
1057:             if (_takerFeeBps > 0) {
1058:                 uint256 _feeDebit = FixedPointMathLib.mulDivUp(tokenCredit, _takerFeeBps, BPS_MULTIPLIER);
1059:                 tokenCredit -= _feeDebit;
1060:                 
1061:                 quoteFeeCollected += ((_feeDebit * (_takerFeeBps - makerFeeBps)) / _takerFeeBps);
1062:             }
1063:             if (msg.sender != address(0)) { // <= FOUND
1064:                 marginAccount.creditUsersEncoded(
1065:                     bytes.concat(makerCredits, abi.encode(_msgSender(), quoteAsset, tokenCredit, _useMargin))
1066:                 );
1067:             }
1068:         }
1069: 
1070:         return (_sizeToBeFilledLeft, tokenCredit);
1071:     }
```
['[331](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L331-L371)']
```solidity
331:     function anyToAnySwap(
332:         address[] calldata _marketAddresses,
333:         bool[] calldata _isBuy,
334:         bool[] calldata _nativeSend,
335:         address _debitToken,
336:         address _creditToken,
337:         uint256 _amount,
338:         uint256 _minAmountOut
339:     ) external payable returns (uint256 _amountOut) {
340:         require(_marketAddresses.length >= 1, RouterErrors.NoMarketsPassed());
341:         require(_isBuy.length == _marketAddresses.length, RouterErrors.LengthMismatch());
342:         require(_nativeSend.length == _marketAddresses.length, RouterErrors.LengthMismatch());
343:         if (_nativeSend[0] == false) {
344:             _debitToken.safeTransferFrom(msg.sender, address(this), _amount);
345:         }
346:         uint256 _cachedAmountIn = _amount;
347: 
348:         for (uint256 i = 0; i < _marketAddresses.length; i++) {
349:             address _currentMarket = _marketAddresses[i];
350:             MarketParams memory _marketParams = verifiedMarket[_currentMarket];
351:             require(_marketParams.pricePrecision > 0, RouterErrors.InvalidMarket());
352:             IOrderBook market = IOrderBook(_currentMarket);
353:             uint256 _value = _nativeSend[i] ? _amount : 0;
354:             _amountOut = _isBuy[i]
355:                 ? (
356:                     market.placeAndExecuteMarketBuy{value: _value}(
357:                         toU96(_amount * _marketParams.pricePrecision / 10 ** _marketParams.quoteAssetDecimals),
358:                         0,
359:                         false,
360:                         true
361:                     )
362:                 )
363:                 : market.placeAndExecuteMarketSell{value: _value}(
364:                     toU96(_amount * _marketParams.sizePrecision / 10 ** _marketParams.baseAssetDecimals), 0, false, true
365:                 );
366: 
367:             _amount = _amountOut;
368:         }
369:         require(_amountOut >= _minAmountOut, RouterErrors.SlippageExceeded());
370:         emit KuruRouterSwap(msg.sender, _debitToken, _creditToken, _cachedAmountIn, _amountOut);
371:         if (_creditToken != address(0)) { // <= FOUND
372:             _creditToken.safeTransfer(msg.sender, _amountOut);
373:         } else {
374:             msg.sender.safeTransferETH(_amountOut);
375:         }
376:     }
```


</details>

## [Gas-17] Some error strings are not descriptive

### Resolution 
Consider adding more detail to these error strings

Num of instances: 43

### Findings 


<details><summary>Click to show findings</summary>

['[331](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/AbstractAMM.sol#L331-L332)']
```solidity
331:     function toU32(uint256 _from) internal pure returns (uint32 _to) {
332:         require((_to = uint32(_from)) == _from, OrderBookErrors.Uint32Overflow()); // <= FOUND
333:     }
```
['[335](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/AbstractAMM.sol#L335-L336)']
```solidity
335:     function toU96(uint256 _from) internal pure returns (uint96 _to) {
336:         require((_to = uint96(_from)) == _from, OrderBookErrors.Uint96Overflow()); // <= FOUND
337:     }
```
['[89](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L89-L90)']
```solidity
89:     function _checkOwner() internal view {
90:         require(msg.sender == owner, KuruAMMVaultErrors.Unauthorized()); // <= FOUND
91:     }
```
[]
```solidity
156:     function deposit(uint256 baseDeposit, uint256 quoteDeposit, address receiver)
157:         public
158:         payable
159:         nonReentrant
160:         returns (uint256)
161:     {
162:         require(
163:             (token1 == address(0) || token2 == address(0))
164:                 ? msg.value >= (token1 == address(0) ? baseDeposit : quoteDeposit)
165:                 : msg.value == 0,
166:             KuruAMMVaultErrors.NativeAssetMismatch()
167:         );
168: 
169:         return _mintAndDeposit(baseDeposit, quoteDeposit, receiver);
170:     }
```
['[175](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L175-L185)']
```solidity
175:     function _mintAndDeposit(uint256 baseDeposit, uint256 quoteDeposit, address receiver) internal returns (uint256) {
176:         (uint256 _baseAmount, uint256 _currentAskPrice) = _returnNormalizedAmountAndPrice(true);
177:         uint256 _shares;
178:         if (totalSupply() != 0) {
179:             uint256 _expectedQuoteAmount = (
180:                 (
181:                     FixedPointMathLib.mulDivUp(baseDeposit, _currentAskPrice, vaultPricePrecision)
182:                         * 10 ** marketParams.quoteAssetDecimals
183:                 )
184:             ) / 10 ** marketParams.baseAssetDecimals;
185:             require(_expectedQuoteAmount <= quoteDeposit, KuruAMMVaultErrors.InsufficientQuoteToken()); // <= FOUND
186:             _shares = _convertToShares(baseDeposit, _expectedQuoteAmount, _currentAskPrice);
187:             quoteDeposit = _expectedQuoteAmount;
188:             _mint(receiver, _shares);
189:         } else {
190:             _shares = FixedPointMathLib.sqrt(baseDeposit * quoteDeposit);
191:             _mint(address(marginAccount), MIN_LIQUIDITY);
192:             _shares -= MIN_LIQUIDITY;
193:             _mint(receiver, _shares);
194:             _currentAskPrice = (
195:                 ((quoteDeposit * 10 ** marketParams.baseAssetDecimals)) * vaultPricePrecision
196:                     / 10 ** marketParams.quoteAssetDecimals
197:             ) / (baseDeposit);
198:         }
199:         require(_shares > 0, KuruAMMVaultErrors.InsufficientLiquidityMinted());
200:         (uint96 _newAskSize, uint96 _newBidSize) = _getVaultSizesForBaseAmount(_baseAmount + baseDeposit);
201:         market.updateVaultOrdSz(
202:             _newAskSize,
203:             _newBidSize,
204:             _currentAskPrice,
205:             FixedPointMathLib.mulDivRound(_currentAskPrice, BPS_MULTIPLIER, BPS_MULTIPLIER + SPREAD_CONSTANT),
206:             false
207:         );
208:         address _token1 = token1;
209:         address _token2 = token2;
210:         _depositAmountsToMarginAccount(_token1, _token2, baseDeposit, quoteDeposit);
211:         uint256 _nativeRefund =
212:             _token1 == address(0) ? (msg.value - baseDeposit) : (_token2 == address(0) ? (msg.value - quoteDeposit) : 0);
213:         if (_nativeRefund > 0) {
214:             msg.sender.safeTransferETH(_nativeRefund);
215:         }
216:         emit KuruVaultDeposit(baseDeposit, quoteDeposit, _shares, receiver);
217:         return _shares;
218:     }
```
['[241](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L241-L246)']
```solidity
241:     function withdraw(uint256 _shares, address _receiver, address _owner)
242:         public
243:         nonReentrant
244:         returns (uint256, uint256)
245:     {
246:         require(_shares <= balanceOf(_owner), KuruAMMVaultErrors.InsufficientBalance()); // <= FOUND
247: 
248:         if (msg.sender != _owner) {
249:             _spendAllowance(_owner, msg.sender, _shares);
250:         }
251: 
252:         return _burnAndWithdraw(_shares, _receiver, _owner);
253:     }
```
['[460](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L460-L461)']
```solidity
460:     function toU96(uint256 _from) internal pure returns (uint96 _to) {
461:         require((_to = uint96(_from)) == _from, KuruAMMVaultErrors.Uint96Overflow()); // <= FOUND
462:     }
```
['[130](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruForwarder.sol#L130-L131)']
```solidity
130:     function verify(ForwardRequest calldata req, bytes calldata signature) public view returns (bool) {
131:         require(block.timestamp <= req.deadline, DeadlineExpired()); // <= FOUND
132:         address signer = _hashTypedData(
133:             keccak256(
134:                 abi.encode(
135:                     _FORWARD_TYPEHASH,
136:                     req.from,
137:                     req.market,
138:                     req.value,
139:                     req.nonce,
140:                     req.deadline,
141:                     req.selector,
142:                     keccak256(req.data)
143:                 )
144:             )
145:         ).recoverCalldata(signature);
146:         return req.nonce >= _nonces[req.from] && signer == req.from;
147:     }
```
['[151](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruForwarder.sol#L151-L156)']
```solidity
151:     function verifyPriceDependent(PriceDependentRequest calldata req, bytes calldata signature)
152:         public
153:         view
154:         returns (bool)
155:     {
156:         require(block.timestamp <= req.deadline, DeadlineExpired()); // <= FOUND
157:         address signer = _hashTypedData(
158:             keccak256(
159:                 abi.encode(
160:                     _PRICE_DEPENDENT_TYPEHASH,
161:                     req.from,
162:                     req.market,
163:                     req.price,
164:                     req.value,
165:                     req.nonce,
166:                     req.deadline,
167:                     req.isBelowPrice,
168:                     req.selector,
169:                     keccak256(req.data)
170:                 )
171:             )
172:         ).recoverCalldata(signature);
173:         require(
174:             !executedPriceDependentRequest[keccak256(abi.encodePacked(req.from, req.nonce))],
175:             KuruForwarderErrors.NonceAlreadyUsed()
176:         );
177:         return signer == req.from;
178:     }
```
['[180](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruForwarder.sol#L180-L185)']
```solidity
180:     function verifyCancelPriceDependent(CancelPriceDependentRequest calldata req, bytes calldata signature)
181:         public
182:         view
183:         returns (bool)
184:     {
185:         require(block.timestamp <= req.deadline, DeadlineExpired()); // <= FOUND
186:         address signer = _hashTypedData(
187:             keccak256(abi.encode(_CANCEL_PRICE_DEPENDENT_TYPEHASH, req.from, req.nonce, req.deadline))
188:         ).recoverCalldata(signature);
189:         require(
190:             !executedPriceDependentRequest[keccak256(abi.encodePacked(req.from, req.nonce))],
191:             KuruForwarderErrors.NonceAlreadyUsed()
192:         );
193:         return signer == req.from;
194:     }
```
['[196](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruForwarder.sol#L196-L201)']
```solidity
196:     function verifyMarginAccountRequest(MarginAccountRequest calldata req, bytes calldata signature)
197:         public
198:         view
199:         returns (bool)
200:     {
201:         require(block.timestamp <= req.deadline, DeadlineExpired()); // <= FOUND
202:         address signer = _hashTypedData(
203:             keccak256(
204:                 abi.encode(
205:                     _MARGIN_ACCOUNT_REQUEST_TYPEHASH,
206:                     req.from,
207:                     req.marginAccount,
208:                     req.value,
209:                     req.nonce,
210:                     req.deadline,
211:                     req.selector,
212:                     keccak256(req.data)
213:                 )
214:             )
215:         ).recoverCalldata(signature);
216:         return req.nonce >= _nonces[req.from] && signer == req.from;
217:     }
```
['[219](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruForwarder.sol#L219-L225)']
```solidity
219:     function executeMarginAccountRequest(MarginAccountRequest calldata req, bytes calldata signature)
220:         public
221:         payable
222:         returns (bytes memory)
223:     {
224:         require(verifyMarginAccountRequest(req, signature), KuruForwarderErrors.SignatureMismatch()); // <= FOUND
225:         require(msg.value >= req.value, KuruForwarderErrors.InsufficientValue()); // <= FOUND
226:         require(allowedInterface[req.selector], KuruForwarderErrors.InterfaceNotAllowed());
227: 
228:         _nonces[req.from] = req.nonce + 1;
229: 
230:         (bool success, bytes memory returndata) =
231:             req.marginAccount.call{value: req.value}(abi.encodePacked(req.selector, req.data, req.from));
232: 
233:         if (!success) {
234:             revert ExecutionFailed(returndata);
235:         }
236: 
237:         return returndata;
238:     }
```
['[240](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruForwarder.sol#L240-L242)']
```solidity
240:     function execute(ForwardRequest calldata req, bytes calldata signature) public payable returns (bytes memory) {
241:         require(verify(req, signature), KuruForwarderErrors.SignatureMismatch());
242:         require(msg.value >= req.value, KuruForwarderErrors.InsufficientValue()); // <= FOUND
243:         require(allowedInterface[req.selector], KuruForwarderErrors.InterfaceNotAllowed());
244: 
245:         _nonces[req.from] = req.nonce + 1;
246: 
247:         (bool success, bytes memory returndata) =
248:             req.market.call{value: req.value}(abi.encodePacked(req.selector, req.data, req.from));
249: 
250:         if (!success) {
251:             revert ExecutionFailed(returndata);
252:         }
253: 
254:         return returndata;
255:     }
```
['[257](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruForwarder.sol#L257-L263)']
```solidity
257:     function executePriceDependent(PriceDependentRequest calldata req, bytes calldata signature)
258:         public
259:         payable
260:         returns (bytes memory)
261:     {
262:         require(verifyPriceDependent(req, signature), KuruForwarderErrors.SignatureMismatch());
263:         require(msg.value >= req.value, KuruForwarderErrors.InsufficientValue()); // <= FOUND
264:         require(allowedInterface[req.selector], KuruForwarderErrors.InterfaceNotAllowed());
265:         executedPriceDependentRequest[keccak256(abi.encodePacked(req.from, req.nonce))] = true;
266: 
267:         (uint256 _currentBidPrice,) = IOrderBook(req.market).bestBidAsk();
268:         require(
269:             (req.isBelowPrice && req.price < _currentBidPrice) || (!req.isBelowPrice && req.price > _currentBidPrice),
270:             PriceDependentRequestFailed(_currentBidPrice, req.price)
271:         );
272:         (bool success, bytes memory returndata) =
273:             req.market.call{value: req.value}(abi.encodePacked(req.selector, req.data, req.from));
274: 
275:         if (!success) {
276:             revert ExecutionFailed(returndata);
277:         }
278: 
279:         return returndata;
280:     }
```
['[282](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruForwarder.sol#L282-L283)']
```solidity
282:     function cancelPriceDependent(CancelPriceDependentRequest calldata req, bytes calldata signature) public {
283:         require(verifyCancelPriceDependent(req, signature), KuruForwarderErrors.SignatureMismatch()); // <= FOUND
284: 
285:         executedPriceDependentRequest[keccak256(abi.encodePacked(req.from, req.nonce))] = true;
286:     }
```
['[38](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L38-L39)']
```solidity
38:     function toggleProtocolState(bool _state) external onlyOwner {
39:         require(protocolPaused != _state, MarginAccountErrors.ProtocolStateNotChanged()); // <= FOUND
40:         protocolPaused = _state;
41:         emit ProtocolStateUpdated(_state);
42:     }
```
['[44](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L44-L45)']
```solidity
44:     function setFeeCollector(address _feeCollector) external onlyOwner {
45:         require(feeCollector != _feeCollector, MarginAccountErrors.FeeCollectorNotChanged()); // <= FOUND
46:         feeCollector = _feeCollector;
47:         emit FeeCollectorUpdated(_feeCollector);
48:     }
```
['[104](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L104-L105)']
```solidity
104:     function debitUser(address _user, address _token, uint256 _amount) external protocolActive {
105:         require(verifiedMarket[msg.sender], MarginAccountErrors.OnlyVerifiedMarketsAllowed()); // <= FOUND
106:         require(balances[_accountKey(_user, _token)] >= _amount, MarginAccountErrors.InsufficientBalance());
107: 
108:         balances[_accountKey(_user, _token)] -= _amount;
109:     }
```
['[118](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L118-L119)']
```solidity
118:     function creditUser(address _user, address _token, uint256 _amount, bool _useMargin) external protocolActive {
119:         require(verifiedMarket[msg.sender], MarginAccountErrors.OnlyVerifiedMarketsAllowed()); // <= FOUND
120: 
121:         if (_useMargin) {
122:             balances[_accountKey(_user, _token)] += _amount;
123:         } else {
124:             if (_token != NATIVE) {
125:                 _token.safeTransfer(_user, _amount);
126:             } else {
127:                 _user.safeTransferETH(_amount);
128:             }
129:         }
130:     }
```
['[136](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L136-L137)']
```solidity
136:     function creditUsersEncoded(bytes calldata _encodedData) external protocolActive {
137:         require(verifiedMarket[msg.sender], MarginAccountErrors.OnlyVerifiedMarketsAllowed()); // <= FOUND
138: 
139:         uint256 offset = 0;
140:         while (offset < _encodedData.length) {
141:             (address _user, address _token, uint256 _amount, bool _useMargin) =
142:                 abi.decode(_encodedData[offset:offset + 128], (address, address, uint256, bool));
143:             offset += 128;
144: 
145:             if (_useMargin) {
146:                 balances[_accountKey(_user, _token)] += _amount;
147:             } else {
148:                 if (_token != NATIVE) {
149:                     _token.safeTransfer(_user, _amount);
150:                 } else {
151:                     _user.safeTransferETH(_amount);
152:                 }
153:             }
154:         }
155:     }
```
['[164](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L164-L165)']
```solidity
164:     function creditFee(address _assetA, uint256 _feeA, address _assetB, uint256 _feeB) external protocolActive {
165:         require(verifiedMarket[msg.sender], MarginAccountErrors.OnlyVerifiedMarketsAllowed()); // <= FOUND
166: 
167:         balances[_accountKey(feeCollector, _assetA)] += _feeA;
168:         balances[_accountKey(feeCollector, _assetB)] += _feeB;
169:     }
```
['[198](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L198-L199)']
```solidity
198:     function deposit(address _user, address _token, uint256 _amount) external payable protocolActive {
199:         require(_user != address(0), MarginAccountErrors.ZeroAddressNotAllowed()); // <= FOUND
200:         if (_token == NATIVE) {
201:             require(msg.value == _amount, MarginAccountErrors.NativeAssetMismatch());
202:             balances[_accountKey(_user, NATIVE)] += _amount;
203:         } else {
204:             require(msg.value == 0, MarginAccountErrors.NativeAssetMismatch());
205:             balances[_accountKey(_user, _token)] += _amount;
206:             _token.safeTransferFrom(_msgSender(), address(this), _amount);
207:         }
208: 
209:         emit Deposit(_user, _token, _amount);
210:     }
```
['[217](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L217-L218)']
```solidity
217:     function withdraw(uint256 _amount, address _token) external protocolActive {
218:         require(_amount <= balances[_accountKey(_msgSender(), _token)], MarginAccountErrors.InsufficientBalance()); // <= FOUND
219:         balances[_accountKey(_msgSender(), _token)] -= _amount;
220:         if (_token == NATIVE) {
221:             _msgSender().safeTransferETH(_amount);
222:         } else {
223:             _token.safeTransfer(_msgSender(), _amount);
224:         }
225: 
226:         emit Withdrawal(_msgSender(), _token, _amount);
227:     }
```
['[85](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L85-L106)']
```solidity
85:     function initialize(
86:         address _owner,
87:         OrderBookType _type,
88:         address _baseAssetAddress,
89:         uint256 _baseAssetDecimals,
90:         address _quoteAssetAddress,
91:         uint256 _quoteAssetDecimals,
92:         address _marginAccountAddress,
93:         uint96 _sizePrecision,
94:         uint32 _pricePrecision,
95:         uint32 _tickSize,
96:         uint96 _minSize,
97:         uint96 _maxSize,
98:         uint256 _takerFeeBps,
99:         uint256 _makerFeeBps,
100:         address _kuruAmmVault,
101:         uint96 _kuruAmmSpread,
102:         address __trustedForwarder
103:     ) public initializer {
104:         owner = _owner;
105: 
106:         require(_makerFeeBps <= _takerFeeBps && _takerFeeBps < BPS_MULTIPLIER, OrderBookErrors.MarketFeeError()); // <= FOUND
107:         require(_kuruAmmSpread % 10 == 0 && _kuruAmmSpread > 0 && _kuruAmmSpread < 500, OrderBookErrors.InvalidSpread());
108:         require(_minSize > 0 && _maxSize > _minSize, OrderBookErrors.MarketSizeError());
109:         orderBookType = _type;
110:         baseAsset = _baseAssetAddress;
111:         quoteAsset = _quoteAssetAddress;
112: 
113:         baseAssetDecimals = _baseAssetDecimals;
114:         baseDecimalMultiplier = 10 ** _baseAssetDecimals;
115:         quoteAssetDecimals = _quoteAssetDecimals;
116:         quoteDecimalMultiplier = 10 ** _quoteAssetDecimals;
117: 
118:         marginAccount = IMarginAccount(payable(_marginAccountAddress));
119:         
120:         sizePrecision = _sizePrecision;
121:         pricePrecision = _pricePrecision;
122:         tickSize = _tickSize;
123:         minSize = _minSize;
124:         maxSize = _maxSize;
125:         takerFeeBps = _takerFeeBps;
126:         makerFeeBps = _makerFeeBps;
127:         kuruAmmVault = _kuruAmmVault;
128:         SPREAD_CONSTANT = _kuruAmmSpread;
129:         vaultBestAsk = type(uint256).max;
130:         _trustedForwarder = __trustedForwarder;
131:     }
```
['[133](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L133-L134)']
```solidity
133:     function _checkOwner() internal view {
134:         require(msg.sender == owner, OrderBookErrors.Unauthorized()); // <= FOUND
135:     }
```
['[147](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L147-L149)']
```solidity
147:     function toggleMarket(MarketState _state) external {
148:         _checkOwner();
149:         require(_state != marketState, OrderBookErrors.MarketStateError()); // <= FOUND
150:         marketState = _state;
151:         emit MarketStateUpdated(marketState, _state);
152:     }
```
['[169](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L169-L170)']
```solidity
169:     function addBuyOrder(uint32 _price, uint96 size, bool _postOnly) public marketActive nonReentrant {
170:         require(_price > 0 && _price < type(uint32).max, OrderBookErrors.PriceError()); // <= FOUND
171:         require(size > minSize, OrderBookErrors.SizeError());
172:         require(size < maxSize, OrderBookErrors.SizeError());
173:         require(_price % tickSize == 0, OrderBookErrors.TickSizeError());
174: 
175:         
176:         (uint96 _remainingSize, uint96 _consumedFunds) = _matchAggressiveBuyWithCap(uint256(_price), size);
177: 
178:         _consumedFunds += _quoteAmountRoundedUp(_price, _remainingSize);
179: 
180:         _consumeFunds(quoteAsset, (((_consumedFunds) * quoteDecimalMultiplier) / pricePrecision), _msgSender());
181:         if (_postOnly) {
182:             require(size == _remainingSize, OrderBookErrors.PostOnlyError());
183:         }
184:         if (_remainingSize == 0) {
185:             return;
186:         } else {
187:             uint40 _orderId = s_orderIdCounter + 1;
188:             s_orderIdCounter = _orderId;
189: 
190:             
191:             uint40 _prevOrderId = OrderLinkedList.insertAtTail(s_buyPricePoints[_price], _orderId);
192: 
193:             _addOrder(_price, _remainingSize, _orderId, true, _prevOrderId);
194:         }
195:     }
```
['[241](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L241-L245)']
```solidity
241:     function addSellOrder(uint32 _price, uint96 _size, bool _postOnly) public marketActive nonReentrant {
242:         require(_size > minSize, OrderBookErrors.SizeError());
243:         require(_size < maxSize, OrderBookErrors.SizeError());
244:         require(_price % tickSize == 0, OrderBookErrors.TickSizeError());
245:         require(_price > 0 && _price < type(uint32).max, OrderBookErrors.PriceError()); // <= FOUND
246: 
247:         _consumeFunds(baseAsset, ((_size * baseDecimalMultiplier) / sizePrecision), _msgSender());
248: 
249:         
250:         
251:         (uint96 _remainingSize,) = _matchAggressiveSell(uint256(_price), _size, true);
252:         if (_postOnly) {
253:             require(_remainingSize == _size, OrderBookErrors.PostOnlyError());
254:         }
255: 
256:         if (_remainingSize == 0) {
257:             return;
258:         } else {
259:             uint40 _orderId = s_orderIdCounter + 1;
260:             s_orderIdCounter = _orderId;
261:             
262:             uint40 _prevOrderId = OrderLinkedList.insertAtTail(s_sellPricePoints[_price], _orderId);
263:             _addOrder(_price, _remainingSize, _orderId, false, _prevOrderId);
264:         }
265:     }
```
['[205](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L205-L211)']
```solidity
205:     function addFlipBuyOrder(uint32 _price, uint32 _flippedPrice, uint96 _size, bool _provisionOrRevert)
206:         public
207:         marketActive
208:         nonReentrant
209:     {
210:         require(_price > 0 && _flippedPrice > 0 && _flippedPrice < type(uint32).max, OrderBookErrors.PriceError()); // <= FOUND
211:         require(_price % tickSize == 0 && _flippedPrice % tickSize == 0, OrderBookErrors.TickSizeError()); // <= FOUND
212:         require(_price < _flippedPrice, OrderBookErrors.PriceError());
213:         require(_size > minSize && _size < maxSize, OrderBookErrors.SizeError());
214: 
215:         {
216:             (, uint256 _bestAsk) = bestAsk();
217:             if ((uint256(_price) * vaultPricePrecision / pricePrecision) >= _bestAsk && _bestAsk != 0) {
218:                 if (_provisionOrRevert) {
219:                     revert OrderBookErrors.ProvisionError();
220:                 } else {
221:                     return;
222:                 }
223:             }
224:         }
225:         _consumeFunds(
226:             quoteAsset, _quoteAmountRoundedUp(_price, _size) * quoteDecimalMultiplier / pricePrecision, _msgSender()
227:         );
228: 
229:         uint40 _orderId = s_orderIdCounter + 1;
230:         s_orderIdCounter = _orderId;
231:         uint40 _prevOrderId = OrderLinkedList.insertAtTail(s_buyPricePoints[_price], _orderId);
232:         _addFlipOrder(_price, _flippedPrice, _size, _msgSender(), _orderId, OrderLinkedList.NULL, true, _prevOrderId);
233:     }
```
['[275](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L275-L281)']
```solidity
275:     function addFlipSellOrder(uint32 _price, uint32 _flippedPrice, uint96 _size, bool _provisionOrRevert)
276:         public
277:         marketActive
278:         nonReentrant
279:     {
280:         require(_price > 0 && _flippedPrice > 0 && _price < type(uint32).max, OrderBookErrors.PriceError());
281:         require(_price % tickSize == 0 && _flippedPrice % tickSize == 0, OrderBookErrors.TickSizeError()); // <= FOUND
282:         require(_price > _flippedPrice, OrderBookErrors.PriceError());
283:         require(_size > minSize && _size < maxSize, OrderBookErrors.SizeError());
284: 
285:         {
286:             (, uint256 _bestBid) = bestBid();
287:             if ((uint256(_price) * vaultPricePrecision / pricePrecision) <= _bestBid && _bestBid != type(uint256).max) {
288:                 if (_provisionOrRevert) {
289:                     revert OrderBookErrors.ProvisionError();
290:                 } else {
291:                     return;
292:                 }
293:             }
294:         }
295: 
296:         _consumeFunds(baseAsset, _size * baseDecimalMultiplier / sizePrecision, _msgSender());
297:         uint40 _orderId = s_orderIdCounter + 1;
298:         s_orderIdCounter = _orderId;
299:         uint40 _prevOrderId = OrderLinkedList.insertAtTail(s_sellPricePoints[_price], _orderId);
300:         _addFlipOrder(_price, _flippedPrice, _size, _msgSender(), _orderId, OrderLinkedList.NULL, false, _prevOrderId);
301:     }
```
['[311](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L311-L316)']
```solidity
311:     function addPairedLiquidity(uint32 _bidPrice, uint32 _askPrice, uint96 _bidSize, uint96 _askSize)
312:         public
313:         marketActive
314:         nonReentrant
315:     {
316:         require(_bidPrice > 0 && _askPrice > _bidPrice && _askPrice < type(uint32).max, OrderBookErrors.PriceError()); // <= FOUND
317:         require(_bidPrice % tickSize == 0 && _askPrice % tickSize == 0, OrderBookErrors.TickSizeError());
318:         require(_bidSize > minSize && _bidSize < maxSize, OrderBookErrors.SizeError());
319:         require(_askSize > minSize && _askSize < maxSize, OrderBookErrors.SizeError());
320:         {
321:             (, uint256 _bestBid) = bestBid();
322:             (, uint256 _bestAsk) = bestAsk();
323:             require(
324:                 ((uint256(_bidPrice) * vaultPricePrecision / pricePrecision) < _bestAsk) || (_bestAsk == 0),
325:                 OrderBookErrors.ProvisionError()
326:             );
327:             require(
328:                 ((uint256(_askPrice) * vaultPricePrecision / pricePrecision) > _bestBid)
329:                     || (_bestBid == type(uint256).max),
330:                 OrderBookErrors.ProvisionError()
331:             );
332:         }
333: 
334:         _consumeFunds(
335:             quoteAsset,
336:             _quoteAmountRoundedUp(_bidPrice, _bidSize) * quoteDecimalMultiplier / pricePrecision,
337:             _msgSender()
338:         );
339:         _consumeFunds(baseAsset, _askSize * baseDecimalMultiplier / sizePrecision, _msgSender());
340: 
341:         uint40 _bidOrderId = s_orderIdCounter + 1;
342:         uint40 _askOrderId = _bidOrderId + 1;
343:         s_orderIdCounter = _askOrderId;
344: 
345:         uint40 _bidPrevOrderId = OrderLinkedList.insertAtTail(s_buyPricePoints[_bidPrice], _bidOrderId);
346:         uint40 _askPrevOrderId = OrderLinkedList.insertAtTail(s_sellPricePoints[_askPrice], _askOrderId);
347:         _addFlipOrder(_bidPrice, _askPrice, _bidSize, _msgSender(), _bidOrderId, _askOrderId, true, _bidPrevOrderId);
348:         _addFlipOrder(_askPrice, _bidPrice, _askSize, _msgSender(), _askOrderId, _bidOrderId, false, _askPrevOrderId);
349:     }
```
['[496](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L496-L499)']
```solidity
496:     function _cancelFlipOrder(uint40 _orderId) internal nonReentrant {
497:         Order memory _order = s_orders[_orderId];
498:         require(!_checkIfCancelledOrFilled(_orderId, _order), OrderBookErrors.OrderAlreadyFilledOrCancelled()); // <= FOUND
499:         require(_msgSender() == _order.ownerAddress, OrderBookErrors.OnlyOwnerAllowedError()); // <= FOUND
500:         require(_order.flippedPrice != 0, OrderBookErrors.WrongOrderTypeCancel());
501:         if (_order.flippedId != OrderLinkedList.NULL) {
502:             _executeCancel(_order.flippedId, s_orders[_order.flippedId]);
503:         }
504:         _executeCancel(_orderId, _order);
505:     }
```
['[511](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L511-L513)']
```solidity
511:     function _cancelOrder(uint40 _orderId, bool _revertIfInvalid) internal nonReentrant returns (bool) {
512:         Order memory _order = s_orders[_orderId];
513:         require(_msgSender() == _order.ownerAddress, OrderBookErrors.OnlyOwnerAllowedError()); // <= FOUND
514:         require(_order.flippedPrice == 0, OrderBookErrors.WrongOrderTypeCancel());
515:         if (_checkIfCancelledOrFilled(_orderId, _order)) {
516:             if (_revertIfInvalid) {
517:                 revert OrderBookErrors.OrderAlreadyFilledOrCancelled();
518:             } else {
519:                 return false;
520:             }
521:         }
522:         _executeCancel(_orderId, _order);
523:         return true;
524:     }
```
[]
```solidity
628:     function batchAddPairedLiquidity(
629:         uint32[] calldata bidPrices,
630:         uint32[] calldata askPrices,
631:         uint96[] calldata bidSizes,
632:         uint96[] calldata askSizes
633:     ) external {
634:         require(
635:             bidPrices.length == bidSizes.length && askPrices.length == askSizes.length, OrderBookErrors.LengthMismatch()
636:         );
637:         for (uint256 i = 0; i < bidPrices.length; i++) {
638:             addPairedLiquidity(bidPrices[i], askPrices[i], bidSizes[i], askSizes[i]);
639:         }
640:     }
```
['[651](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L651-L658)']
```solidity
651:     function batchProvisionLiquidity(
652:         uint32[] calldata prices,
653:         uint32[] calldata flipPrices,
654:         uint96[] calldata sizes,
655:         bool[] calldata isBuy,
656:         bool _provisionOrRevert
657:     ) external {
658:         require(prices.length == flipPrices.length, OrderBookErrors.LengthMismatch()); // <= FOUND
659:         require(sizes.length == isBuy.length, OrderBookErrors.LengthMismatch());
660:         require(prices.length == sizes.length, OrderBookErrors.LengthMismatch());
661:         for (uint256 i = 0; i < prices.length; i++) {
662:             if (isBuy[i]) {
663:                 addFlipBuyOrder(prices[i], flipPrices[i], sizes[i], _provisionOrRevert);
664:             } else {
665:                 addFlipSellOrder(prices[i], flipPrices[i], sizes[i], _provisionOrRevert);
666:             }
667:         }
668:     }
```
['[679](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L679-L688)']
```solidity
679:     function batchUpdate(
680:         uint32[] calldata buyPrices,
681:         uint96[] calldata buySizes,
682:         uint32[] calldata sellPrices,
683:         uint96[] calldata sellSizes,
684:         uint40[] calldata orderIdsToCancel,
685:         bool postOnly
686:     ) external marketNotHardPaused {
687:         
688:         require(buyPrices.length == buySizes.length, OrderBookErrors.LengthMismatch()); // <= FOUND
689: 
690:         
691:         require(sellPrices.length == sellSizes.length, OrderBookErrors.LengthMismatch());
692: 
693:         uint40[] memory orderIdsCanceled = new uint40[](orderIdsToCancel.length);
694:         
695:         for (uint256 i = 0; i < orderIdsToCancel.length; i++) {
696:             bool _isCanceled = _cancelOrder(orderIdsToCancel[i], false);
697:             if (_isCanceled) {
698:                 orderIdsCanceled[i] = orderIdsToCancel[i];
699:             } else {
700:                 orderIdsCanceled[i] = 0;
701:             }
702:         }
703: 
704:         
705:         for (uint256 i = 0; i < buyPrices.length; i++) {
706:             addBuyOrder(buyPrices[i], buySizes[i], postOnly);
707:         }
708: 
709:         
710:         for (uint256 i = 0; i < sellPrices.length; i++) {
711:             addSellOrder(sellPrices[i], sellSizes[i], postOnly);
712:         }
713: 
714:         
715:         if (orderIdsCanceled.length > 0) {
716:             emit OrdersCanceled(orderIdsCanceled, _msgSender());
717:         }
718:     }
```
['[728](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L728-L746)']
```solidity
728:     function placeAndExecuteMarketBuy(uint96 _quoteSize, uint256 _minAmountOut, bool _isMargin, bool _isFillOrKill)
729:         public
730:         payable
731:         override
732:         marketActive
733:         nonReentrant
734:         returns (uint256)
735:     {
736:         OrderBookType _type = orderBookType;
737: 
738:         if (_type == OrderBookType.NATIVE_IN_QUOTE && !_isMargin && (msg.sender != address(0))) {
739:             require(
740:                 msg.value >= _pricePrecisionToQuoteAssetPrecision(_quoteSize), OrderBookErrors.NativeAssetInsufficient()
741:             );
742:             require(
743:                 msg.value < _pricePrecisionToQuoteAssetPrecision(_quoteSize + 1), OrderBookErrors.NativeAssetSurplus()
744:             );
745:         } else if (msg.sender != address(0)) {
746:             require(msg.value == 0, OrderBookErrors.NativeAssetNotRequired()); // <= FOUND
747:             _isMargin
748:                 ? marginAccount.debitUser(_msgSender(), quoteAsset, _pricePrecisionToQuoteAssetPrecision(_quoteSize))
749:                 : quoteAsset.safeTransferFrom(
750:                     _msgSender(), address(marginAccount), _pricePrecisionToQuoteAssetPrecision(_quoteSize)
751:                 );
752:         }
753: 
754:         uint256 _baseTokensCredited;
755:         (_quoteSize, _baseTokensCredited) = _marketBuyMatch(_quoteSize, _isMargin);
756:         if (msg.sender == address(0)) {
757:             return _baseTokensCredited;
758:         }
759:         if (_quoteSize > 0) {
760:             require(!_isFillOrKill, OrderBookErrors.InsufficientLiquidity());
761:             if (_type == OrderBookType.NATIVE_IN_QUOTE && !_isMargin) {
762:                 
763:                 uint256 _refund = _pricePrecisionToQuoteAssetPrecision(_quoteSize);
764:                 _handleNativeMarketRefundTransfer(_refund);
765:             } else {
766:                 marginAccount.creditUser(
767:                     _msgSender(), quoteAsset, _pricePrecisionToQuoteAssetPrecision(_quoteSize), _isMargin
768:                 );
769:             }
770:         } else if (_type == OrderBookType.NATIVE_IN_QUOTE) {
771:             address(marginAccount).safeTransferETH(msg.value);
772:         }
773:         require(_baseTokensCredited >= _minAmountOut, OrderBookErrors.SlippageExceeded());
774: 
775:         return _baseTokensCredited;
776:     }
```
['[786](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L786-L798)']
```solidity
786:     function placeAndExecuteMarketSell(uint96 _size, uint256 _minAmountOut, bool _isMargin, bool _isFillOrKill)
787:         public
788:         payable
789:         marketActive
790:         nonReentrant
791:         returns (uint256)
792:     {
793:         OrderBookType _type = orderBookType;
794:         if (_type == OrderBookType.NATIVE_IN_BASE && !_isMargin && (msg.sender != address(0))) {
795:             require(msg.value >= _sizePrecisionToBaseAssetPrecision(_size), OrderBookErrors.NativeAssetInsufficient());
796:             require(msg.value < _sizePrecisionToBaseAssetPrecision(_size + 1), OrderBookErrors.NativeAssetSurplus());
797:         } else if (msg.sender != address(0)) {
798:             require(msg.value == 0, OrderBookErrors.NativeAssetNotRequired()); // <= FOUND
799:             _isMargin
800:                 ? marginAccount.debitUser(_msgSender(), baseAsset, _sizePrecisionToBaseAssetPrecision(_size))
801:                 : baseAsset.safeTransferFrom(
802:                     _msgSender(), address(marginAccount), _sizePrecisionToBaseAssetPrecision(_size)
803:                 );
804:         }
805: 
806:         uint256 _quoteCredited;
807:         (_size, _quoteCredited) = _matchAggressiveSell(0, _size, _isMargin);
808:         if (msg.sender == address(0)) {
809:             return _quoteCredited;
810:         }
811:         if (_size > 0) {
812:             require(!_isFillOrKill, OrderBookErrors.InsufficientLiquidity());
813:             if (_type == OrderBookType.NATIVE_IN_BASE && !_isMargin) {
814:                 uint256 _refund = _sizePrecisionToBaseAssetPrecision(_size);
815:                 _handleNativeMarketRefundTransfer(_refund);
816:             } else {
817:                 marginAccount.creditUser(_msgSender(), baseAsset, _sizePrecisionToBaseAssetPrecision(_size), _isMargin);
818:             }
819:         } else if (_type == OrderBookType.NATIVE_IN_BASE) {
820:             address(marginAccount).safeTransferETH(msg.value);
821:         }
822:         require(_quoteCredited >= _minAmountOut, OrderBookErrors.SlippageExceeded());
823:         return _quoteCredited;
824:     }
```
['[74](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L74-L88)']
```solidity
74:     function deployProxy(
75:         IOrderBook.OrderBookType _type,
76:         address _baseAssetAddress,
77:         address _quoteAssetAddress,
78:         uint96 _sizePrecision,
79:         uint32 _pricePrecision,
80:         uint32 _tickSize,
81:         uint96 _minSize,
82:         uint96 _maxSize,
83:         uint256 _takerFeeBps,
84:         uint256 _makerFeeBps,
85:         uint96 _kuruAmmSpread
86:     ) public returns (address proxy) {
87:         if (_type == IOrderBook.OrderBookType.NATIVE_IN_BASE) {
88:             require(_baseAssetAddress == address(0), RouterErrors.MarketTypeMismatch()); // <= FOUND
89:             require(_quoteAssetAddress != address(0), RouterErrors.MarketTypeMismatch());
90:         } else if (_type == IOrderBook.OrderBookType.NATIVE_IN_QUOTE) {
91:             require(_baseAssetAddress != address(0), RouterErrors.MarketTypeMismatch());
92:             require(_quoteAssetAddress == address(0), RouterErrors.MarketTypeMismatch());
93:         } else {
94:             require(_baseAssetAddress != address(0), RouterErrors.MarketTypeMismatch());
95:             require(_quoteAssetAddress != address(0), RouterErrors.MarketTypeMismatch());
96:             require(_baseAssetAddress != _quoteAssetAddress, RouterErrors.BaseAndQuoteAssetSame());
97:         }
98:         require(_tickSize > 0, RouterErrors.InvalidTickSize());
99:         require(10 ** Math.log10(_sizePrecision) == _sizePrecision, RouterErrors.InvalidSizePrecision());
100:         require(10 ** Math.log10(_pricePrecision) == _pricePrecision, RouterErrors.InvalidPricePrecision());
101:         uint256 _baseAssetDecimals =
102:             _type == IOrderBook.OrderBookType.NATIVE_IN_BASE ? 18 : IERC20Metadata(_baseAssetAddress).decimals();
103:         uint256 _quoteAssetDecimals =
104:             _type == IOrderBook.OrderBookType.NATIVE_IN_QUOTE ? 18 : IERC20Metadata(_quoteAssetAddress).decimals();
105:         {
106:             bytes32 _salt = _getSalt(
107:                 _baseAssetAddress,
108:                 _quoteAssetAddress,
109:                 _sizePrecision,
110:                 _pricePrecision,
111:                 _tickSize,
112:                 _minSize,
113:                 _maxSize,
114:                 _takerFeeBps,
115:                 _makerFeeBps,
116:                 _kuruAmmSpread
117:             );
118:             proxy = Create2.deploy(
119:                 0,
120:                 _salt,
121:                 abi.encodePacked(type(ERC1967Proxy).creationCode, abi.encode(orderBookImplementation, bytes("")))
122:             );
123:         }
124:         IKuruAMMVault _kuruAmmVault = IKuruAMMVault(
125:             Create2.deploy(
126:                 0,
127:                 keccak256(abi.encode(proxy)),
128:                 abi.encodePacked(type(ERC1967Proxy).creationCode, abi.encode(kuruAmmVaultImplementation, bytes("")))
129:             )
130:         );
131: 
132:         verifiedMarket[proxy] = MarketParams(
133:             _pricePrecision,
134:             _sizePrecision,
135:             _baseAssetAddress,
136:             _baseAssetDecimals,
137:             _quoteAssetAddress,
138:             _quoteAssetDecimals,
139:             _tickSize,
140:             _minSize,
141:             _maxSize,
142:             _takerFeeBps,
143:             _makerFeeBps
144:         );
145:         IMarginAccount(marginAccountAddress).updateMarkets(proxy);
146:         {
147:             IOrderBook(proxy).initialize(
148:                 address(this),
149:                 _type,
150:                 _baseAssetAddress,
151:                 _baseAssetDecimals,
152:                 _quoteAssetAddress,
153:                 _quoteAssetDecimals,
154:                 marginAccountAddress,
155:                 _sizePrecision,
156:                 _pricePrecision,
157:                 _tickSize,
158:                 _minSize,
159:                 _maxSize,
160:                 _takerFeeBps,
161:                 _makerFeeBps,
162:                 address(_kuruAmmVault),
163:                 _kuruAmmSpread,
164:                 TRUSTED_FORWARDER
165:             );
166:         }
167: 
168:         _kuruAmmVault.initialize(
169:             address(this), _baseAssetAddress, _quoteAssetAddress, marginAccountAddress, proxy, _kuruAmmSpread
170:         );
171: 
172:         _setApprovalsForMarket(_baseAssetAddress, _quoteAssetAddress, proxy, _type);
173: 
174:         emit MarketRegistered(
175:             _baseAssetAddress,
176:             _quoteAssetAddress,
177:             proxy,
178:             address(_kuruAmmVault),
179:             _pricePrecision,
180:             _sizePrecision,
181:             _tickSize,
182:             _minSize,
183:             _maxSize,
184:             _takerFeeBps,
185:             _makerFeeBps,
186:             _kuruAmmSpread
187:         );
188: 
189:         return proxy;
190:     }
```
['[250](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L250-L251)']
```solidity
250:     function upgradeOrderBookImplementation(address newImplementation) external onlyOwner {
251:         require(newImplementation != orderBookImplementation); // <= FOUND
252:         emit OBImplementationUpdated(orderBookImplementation, newImplementation);
253:         orderBookImplementation = newImplementation;
254:     }
```
['[260](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L260-L261)']
```solidity
260:     function upgradeVaultImplementation(address newImplementation) external onlyOwner {
261:         require(newImplementation != kuruAmmVaultImplementation); // <= FOUND
262:         emit VaultImplementationUpdated(kuruAmmVaultImplementation, newImplementation);
263:         kuruAmmVaultImplementation = newImplementation;
264:     }
```
['[331](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L331-L340)']
```solidity
331:     function anyToAnySwap(
332:         address[] calldata _marketAddresses,
333:         bool[] calldata _isBuy,
334:         bool[] calldata _nativeSend,
335:         address _debitToken,
336:         address _creditToken,
337:         uint256 _amount,
338:         uint256 _minAmountOut
339:     ) external payable returns (uint256 _amountOut) {
340:         require(_marketAddresses.length >= 1, RouterErrors.NoMarketsPassed()); // <= FOUND
341:         require(_isBuy.length == _marketAddresses.length, RouterErrors.LengthMismatch());
342:         require(_nativeSend.length == _marketAddresses.length, RouterErrors.LengthMismatch());
343:         if (_nativeSend[0] == false) {
344:             _debitToken.safeTransferFrom(msg.sender, address(this), _amount);
345:         }
346:         uint256 _cachedAmountIn = _amount;
347: 
348:         for (uint256 i = 0; i < _marketAddresses.length; i++) {
349:             address _currentMarket = _marketAddresses[i];
350:             MarketParams memory _marketParams = verifiedMarket[_currentMarket];
351:             require(_marketParams.pricePrecision > 0, RouterErrors.InvalidMarket());
352:             IOrderBook market = IOrderBook(_currentMarket);
353:             uint256 _value = _nativeSend[i] ? _amount : 0;
354:             _amountOut = _isBuy[i]
355:                 ? (
356:                     market.placeAndExecuteMarketBuy{value: _value}(
357:                         toU96(_amount * _marketParams.pricePrecision / 10 ** _marketParams.quoteAssetDecimals),
358:                         0,
359:                         false,
360:                         true
361:                     )
362:                 )
363:                 : market.placeAndExecuteMarketSell{value: _value}(
364:                     toU96(_amount * _marketParams.sizePrecision / 10 ** _marketParams.baseAssetDecimals), 0, false, true
365:                 );
366: 
367:             _amount = _amountOut;
368:         }
369:         require(_amountOut >= _minAmountOut, RouterErrors.SlippageExceeded());
370:         emit KuruRouterSwap(msg.sender, _debitToken, _creditToken, _cachedAmountIn, _amountOut);
371:         if (_creditToken != address(0)) {
372:             _creditToken.safeTransfer(msg.sender, _amountOut);
373:         } else {
374:             msg.sender.safeTransferETH(_amountOut);
375:         }
376:     }
```
['[420](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L420-L421)']
```solidity
420:     function toU96(uint256 _from) internal pure returns (uint96 _to) {
421:         require((_to = uint96(_from)) == _from, RouterErrors.Uint96Overflow()); // <= FOUND
422:     }
```


</details>

## [Gas-18] Can transfer 0

### Resolution 
In Solidity, performing unnecessary operations can consume more gas than needed, leading to cost inefficiencies. For instance, if a `transfer` function doesn't have a zero amount check and someone calls it with a zero amount, unnecessary gas will be consumed in executing the function, even though the state of the contract remains the same. By implementing a zero amount check, such unnecessary function calls can be avoided, thereby saving gas and making the contract more efficient.


Num of instances: 1

### Findings 


<details><summary>Click to show findings</summary>

['[65](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/periphery/MonadDeployer.sol#L65-L93)']
```solidity
65:     function deployTokenAndMarket(
66:         TokenParams memory tokenParams,
67:         MarketParams memory marketParams,
68:         bytes calldata metadata
69:     ) external payable returns (address market) {
70:         KuruERC20 token = new KuruERC20(tokenParams.name, tokenParams.symbol, tokenParams.initialSupply, address(this));
71:         market = router.deployProxy(
72:             IOrderBook.OrderBookType.NATIVE_IN_QUOTE,
73:             address(token),
74:             address(0),
75:             marketParams.sizePrecision,
76:             marketParams.pricePrecision,
77:             marketParams.tickSize,
78:             marketParams.minSize,
79:             marketParams.maxSize,
80:             marketParams.takerFeeBps,
81:             marketParams.makerFeeBps,
82:             kuruAmmSpread
83:         );
84:         if (msg.value != (marketParams.nativeTokenAmount + kuruCollectiveFee)) {
85:             revert InsufficientAssets(marketParams.nativeTokenAmount + kuruCollectiveFee, msg.value);
86:         }
87:         (address vault,,,,,,,) = IOrderBook(market).getVaultParams();
88:         uint256 _supplyToVault = tokenParams.initialSupply * (10 ** 4 - tokenParams.supplyToDev) / 10 ** 4;
89:         token.approve(vault, _supplyToVault);
90:         IKuruAMMVault(vault).deposit{value: marketParams.nativeTokenAmount}(
91:             _supplyToVault, marketParams.nativeTokenAmount, address(this)
92:         );
93:         token.transfer(tokenParams.dev, tokenParams.initialSupply - _supplyToVault); // <= FOUND
94:         marginAccount.deposit{value: kuruCollectiveFee}(kuruCollective, address(0), kuruCollectiveFee);
95:         emit PumpingTime(
96:             address(token),
97:             tokenParams.tokenURI,
98:             tokenParams.dev,
99:             tokenParams.initialSupply - _supplyToVault,
100:             market,
101:             metadata
102:         );
103:     }
```


</details>

## [Gas-19] State variables which are not modified within functions should be set as constants or immutable for values set at deployment

### Resolution 
Set state variables listed below as constant or immutable for values set at deployment. Ensure it is safe to do so

Num of instances: 1

### Findings 


<details><summary>Click to show findings</summary>

['[10](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/periphery/ERC20.sol#L10-L10)']
```solidity
10:  string private _symbol;
```


</details>

## [Gas-20] Divisions of powers of 2 can be replaced by a right shift operation to save gas

### Resolution 
Replace such found divisions with right shift operations when ensured it is safe to do so. NOTE: This only applies to uint variables!

Num of instances: 2

### Findings 


<details><summary>Click to show findings</summary>

['[450](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L450-L453)']
```solidity
450:         uint256 _halfTotalValuationInQuote = (
451:             (_reserve1 * _vaultPrice * 10 ** _marketParams.quoteAssetDecimals)
452:                 / (10 ** _marketParams.baseAssetDecimals * vaultPricePrecision) + _reserve2
453:         ) / 2; // <= FOUND
```
['[571](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L571-L571)']
```solidity
571:         return (value * multiplier + divisor / 2) / divisor; // <= FOUND
```


</details>

## [Gas-21] multiplications of powers of 2 can be replaced by a left shift operation to save gas

### Resolution 
Replace such found multiplications with left shift operations when ensured it is safe to do so. NOTE: This only applies to uint variables!

Num of instances: 1

### Findings 


<details><summary>Click to show findings</summary>

['[88](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/periphery/MonadDeployer.sol#L88-L88)']
```solidity
88:         uint256 _supplyToVault = tokenParams.initialSupply * (10 ** 4 - tokenParams.supplyToDev) / 10 ** 4; // <= FOUND
```


</details>

## [Gas-22] Structs can be packed into fewer storage slots

### Resolution 
In Solidity, each storage slot has a size of 32 bytes. If a struct contains multiple uint values, it's efficient to pack these into as few storage slots as possible to optimize gas usage. The EVM (Ethereum Virtual Machine) charges gas for each storage operation, so minimizing the number of slots used can result in substantial gas savings. This can be achieved by ordering struct fields according to their size or by using smaller data types where possible. However, developers must balance these optimizations with the need for code clarity and the precision requirements of their application. Always ensure that data packing does not compromise the functionality or security of the contract.

Num of instances: 7

### Findings 


<details><summary>Click to show findings</summary>

['[5](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/interfaces/IKuruAMMVault.sol#L5-L16)']
```solidity
5:     struct MarketParams { // <= FOUND
6:         uint32 pricePrecision;
7:         uint96 sizePrecision;
8:         address baseAssetAddress;
9:         uint256 baseAssetDecimals; // <= FOUND
10:         address quoteAssetAddress;
11:         uint256 quoteAssetDecimals; // <= FOUND
12:         uint32 tickSize;
13:         uint96 minSize;
14:         uint96 maxSize;
15:         uint256 takerFeeBps; // <= FOUND
16:         uint256 makerFeeBps; // <= FOUND
17:     }
```
['[26](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruForwarder.sol#L26-L31)']
```solidity
26:     struct ForwardRequest { // <= FOUND
27:         address from;
28:         address market;
29:         uint256 value; // <= FOUND
30:         uint256 nonce; // <= FOUND
31:         uint256 deadline; // <= FOUND
32:         bytes4 selector;
33:         bytes data;
34:     }
```
['[36](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruForwarder.sol#L36-L42)']
```solidity
36:     struct PriceDependentRequest { // <= FOUND
37:         address from;
38:         address market;
39:         uint256 price; // <= FOUND
40:         uint256 value; // <= FOUND
41:         uint256 nonce; // <= FOUND
42:         uint256 deadline; // <= FOUND
43:         bool isBelowPrice;
44:         bytes4 selector;
45:         bytes data;
46:     }
```
['[48](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruForwarder.sol#L48-L51)']
```solidity
48:     struct CancelPriceDependentRequest { // <= FOUND
49:         address from;
50:         uint256 nonce; // <= FOUND
51:         uint256 deadline; // <= FOUND
52:     }
```
['[54](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruForwarder.sol#L54-L59)']
```solidity
54:     struct MarginAccountRequest { // <= FOUND
55:         address from;
56:         address marginAccount;
57:         uint256 value; // <= FOUND
58:         uint256 nonce; // <= FOUND
59:         uint256 deadline; // <= FOUND
60:         bytes4 selector;
61:         bytes data;
62:     }
```
['[13](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/periphery/MonadDeployer.sol#L13-L19)']
```solidity
13:     struct TokenParams { // <= FOUND
14:         string name;
15:         string symbol;
16:         string tokenURI;
17:         uint256 initialSupply; // <= FOUND
18:         address dev;
19:         uint256 supplyToDev;  // <= FOUND
20:     }
```
['[22](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/periphery/MonadDeployer.sol#L22-L30)']
```solidity
22:     struct MarketParams { // <= FOUND
23:         uint256 nativeTokenAmount; // <= FOUND
24:         uint96 sizePrecision;
25:         uint32 pricePrecision;
26:         uint32 tickSize;
27:         uint96 minSize;
28:         uint96 maxSize;
29:         uint256 takerFeeBps; // <= FOUND
30:         uint256 makerFeeBps; // <= FOUND
31:     }
```


</details>

## [Gas-23] Don't use _msgSender() if not supporting EIP-2771

### Resolution 
From a gas efficiency perspective, using `_msgSender()` in a contract not intended to support EIP-2771 could add unnecessary overhead. The `_msgSender()` function includes checks to determine if the transaction was forwarded, which involves extra function calls that consume more gas than a simple `msg.sender`.

If a contract doesn't require EIP-2771 meta-transaction support, using `msg.sender` directly is more gas efficient. `msg.sender` is a globally accessible variable in Solidity that doesn't require an extra function call, making it a less costly choice.

In the context of Ethereum, where every operation has a gas cost, it's crucial to eliminate unnecessary computations to optimize contract execution and minimize transaction fees. Therefore, if EIP-2771 support isn't necessary, it's recommended to use `msg.sender` instead of `_msgSender()`.

Num of instances: 37

### Findings 


<details><summary>Click to show findings</summary>

['[25](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/ERC2771Context.sol#L25-L25)']
```solidity
25:     function _msgSender() internal view returns (address) { // <= FOUND
```
['[180](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L180-L180)']
```solidity
180:             _balance = balances[_accountKey(_msgSender(), _tokens[i])]; // <= FOUND
```
['[181](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L181-L181)']
```solidity
181:             balances[_accountKey(_msgSender(), _tokens[i])] = 0; // <= FOUND
```
['[184](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L184-L184)']
```solidity
184:                     _msgSender().safeTransferETH(_balance); // <= FOUND
```
['[186](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L186-L186)']
```solidity
186:                     _tokens[i].safeTransfer(_msgSender(), _balance); // <= FOUND
```
['[206](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L206-L206)']
```solidity
206:             _token.safeTransferFrom(_msgSender(), address(this), _amount); // <= FOUND
```
['[218](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L218-L218)']
```solidity
218:         require(_amount <= balances[_accountKey(_msgSender(), _token)], MarginAccountErrors.InsufficientBalance()); // <= FOUND
```
['[219](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L219-L219)']
```solidity
219:         balances[_accountKey(_msgSender(), _token)] -= _amount; // <= FOUND
```
['[221](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L221-L221)']
```solidity
221:             _msgSender().safeTransferETH(_amount); // <= FOUND
```
['[223](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L223-L223)']
```solidity
223:             _token.safeTransfer(_msgSender(), _amount); // <= FOUND
```
['[226](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L226-L226)']
```solidity
226:         emit Withdrawal(_msgSender(), _token, _amount); // <= FOUND
```
['[180](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L180-L180)']
```solidity
180:         _consumeFunds(quoteAsset, (((_consumedFunds) * quoteDecimalMultiplier) / pricePrecision), _msgSender()); // <= FOUND
```
['[225](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L225-L226)']
```solidity
225:         _consumeFunds(
226:             quoteAsset, _quoteAmountRoundedUp(_price, _size) * quoteDecimalMultiplier / pricePrecision, _msgSender() // <= FOUND
227:         );
```
['[232](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L232-L232)']
```solidity
232:         _addFlipOrder(_price, _flippedPrice, _size, _msgSender(), _orderId, OrderLinkedList.NULL, true, _prevOrderId); // <= FOUND
```
['[247](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L247-L247)']
```solidity
247:         _consumeFunds(baseAsset, ((_size * baseDecimalMultiplier) / sizePrecision), _msgSender()); // <= FOUND
```
['[296](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L296-L296)']
```solidity
296:         _consumeFunds(baseAsset, _size * baseDecimalMultiplier / sizePrecision, _msgSender()); // <= FOUND
```
['[300](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L300-L300)']
```solidity
300:         _addFlipOrder(_price, _flippedPrice, _size, _msgSender(), _orderId, OrderLinkedList.NULL, false, _prevOrderId); // <= FOUND
```
['[334](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L334-L337)']
```solidity
334:         _consumeFunds(
335:             quoteAsset,
336:             _quoteAmountRoundedUp(_bidPrice, _bidSize) * quoteDecimalMultiplier / pricePrecision,
337:             _msgSender() // <= FOUND
338:         );
```
['[339](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L339-L339)']
```solidity
339:         _consumeFunds(baseAsset, _askSize * baseDecimalMultiplier / sizePrecision, _msgSender()); // <= FOUND
```
['[347](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L347-L347)']
```solidity
347:         _addFlipOrder(_bidPrice, _askPrice, _bidSize, _msgSender(), _bidOrderId, _askOrderId, true, _bidPrevOrderId); // <= FOUND
```
['[348](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L348-L348)']
```solidity
348:         _addFlipOrder(_askPrice, _bidPrice, _askSize, _msgSender(), _askOrderId, _bidOrderId, false, _askPrevOrderId); // <= FOUND
```
['[365](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L365-L366)']
```solidity
365:         s_orders[_orderId] =
366:             Order(_msgSender(), _size, _prevOrderId, OrderLinkedList.NULL, OrderLinkedList.NULL, _price, 0, _isBuy); // <= FOUND
```
['[370](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L370-L370)']
```solidity
370:         emit OrderCreated(_orderId, _msgSender(), _size, _price, _isBuy); // <= FOUND
```
['[457](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L457-L457)']
```solidity
457:         emit FlipOrdersCanceled(_orderIds, _msgSender()); // <= FOUND
```
['[470](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L470-L470)']
```solidity
470:         emit OrdersCanceled(_orderIds, _msgSender()); // <= FOUND
```
['[489](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L489-L489)']
```solidity
489:         emit OrdersCanceled(_orderIdsCanceled, _msgSender()); // <= FOUND
```
['[499](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L499-L499)']
```solidity
499:         require(_msgSender() == _order.ownerAddress, OrderBookErrors.OnlyOwnerAllowedError()); // <= FOUND
```
['[716](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L716-L716)']
```solidity
716:             emit OrdersCanceled(orderIdsCanceled, _msgSender()); // <= FOUND
```
['[747](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L747-L750)']
```solidity
747:             _isMargin
748:                 ? marginAccount.debitUser(_msgSender(), quoteAsset, _pricePrecisionToQuoteAssetPrecision(_quoteSize)) // <= FOUND
749:                 : quoteAsset.safeTransferFrom(
750:                     _msgSender(), address(marginAccount), _pricePrecisionToQuoteAssetPrecision(_quoteSize) // <= FOUND
751:                 );
```
['[766](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L766-L767)']
```solidity
766:                 marginAccount.creditUser(
767:                     _msgSender(), quoteAsset, _pricePrecisionToQuoteAssetPrecision(_quoteSize), _isMargin // <= FOUND
768:                 );
```
['[799](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L799-L802)']
```solidity
799:             _isMargin
800:                 ? marginAccount.debitUser(_msgSender(), baseAsset, _sizePrecisionToBaseAssetPrecision(_size)) // <= FOUND
801:                 : baseAsset.safeTransferFrom(
802:                     _msgSender(), address(marginAccount), _sizePrecisionToBaseAssetPrecision(_size) // <= FOUND
803:                 );
```
['[817](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L817-L817)']
```solidity
817:                 marginAccount.creditUser(_msgSender(), baseAsset, _sizePrecisionToBaseAssetPrecision(_size), _isMargin); // <= FOUND
```
['[832](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L832-L832)']
```solidity
832:         _msgSender().safeTransferETH(_refund); // <= FOUND
```
['[918](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L918-L919)']
```solidity
918:             marginAccount.creditUsersEncoded(
919:                 bytes.concat(makerCredits, abi.encode(_msgSender(), baseAsset, _tokenCredit, true)) // <= FOUND
920:             );
```
['[989](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L989-L990)']
```solidity
989:                 marginAccount.creditUsersEncoded(
990:                     bytes.concat(makerCredits, abi.encode(_msgSender(), baseAsset, _tokenCredit, _isMargin)) // <= FOUND
991:                 );
```
['[1064](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L1064-L1065)']
```solidity
1064:                 marginAccount.creditUsersEncoded(
1065:                     bytes.concat(makerCredits, abi.encode(_msgSender(), quoteAsset, tokenCredit, _useMargin)) // <= FOUND
1066:                 );
```
['[1217](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L1217-L1217)']
```solidity
1217:         emit Trade(orderId, makerAddress, isBuy, price, updatedSize, _msgSender(), tx.origin, filledSize); // <= FOUND
```


</details>

## [Gas-24] Superfluous event fields

### Resolution 
The Ethereum network automatically appends certain data, including `block.number` and `block.timestamp`, to every event emitted by smart contracts. This inherent feature means that explicitly adding these parameters to your event logs isn't necessary, as they're already accessible through the transaction receipt. In fact, manually adding these details to your events can lead to wasted gas because it increases the data payload of the transaction, thereby upping the associated gas cost. For gas-efficient coding, it's best to rely on the default inclusions of `block.number` and `block.timestamp` rather than duplicating these in your events.

Num of instances: 1

### Findings 


<details><summary>Click to show findings</summary>

['[41](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/periphery/MonadDeployer.sol#L41-L41)']
```solidity
41: event PumpingTime( // <= FOUND
42:         address indexed token, string tokenURI, address dev, uint256 supplyToDev, address market, bytes metadata
43:     );
```


</details>

## [Gas-25] Use assembly to emit events

### Resolution 
With the use of inline assembly in Solidity, we can take advantage of low-level features like scratch space and the free memory pointer, offering more gas-efficient ways of emitting events. The scratch space is a certain area of memory where we can temporarily store data, and the free memory pointer indicates the next available memory slot. Using these, we can efficiently assemble event data without incurring additional memory expansion costs. However, safety is paramount: to avoid overwriting or leakage, we must cache the free memory pointer before use and restore it afterward, ensuring that it points to the correct memory location post-operation.

Num of instances: 23

### Findings 


<details><summary>Click to show findings</summary>

['[321](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/AbstractAMM.sol#L321-L321)']
```solidity
321:         emit VaultParamsUpdated( // <= FOUND
322:             _vaultAskOrderSize,
323:             askPartiallyFilledSize,
324:             _vaultBidOrderSize,
325:             bidPartiallyFilledSize,
326:             vaultBestAsk,
327:             vaultBestBid
328:         );
```
['[216](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L216-L216)']
```solidity
216:         emit KuruVaultDeposit(baseDeposit, quoteDeposit, _shares, receiver); // <= FOUND
```
['[275](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L275-L275)']
```solidity
275:         emit KuruVaultWithdraw(_baseOwedToUser, _quoteOwedToUser, _shares, _owner); // <= FOUND
```
['[41](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L41-L41)']
```solidity
41:         emit ProtocolStateUpdated(_state); // <= FOUND
```
['[47](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L47-L47)']
```solidity
47:         emit FeeCollectorUpdated(_feeCollector); // <= FOUND
```
['[209](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L209-L209)']
```solidity
209:         emit Deposit(_user, _token, _amount); // <= FOUND
```
['[226](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L226-L226)']
```solidity
226:         emit Withdrawal(_msgSender(), _token, _amount); // <= FOUND
```
['[151](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L151-L151)']
```solidity
151:         emit MarketStateUpdated(marketState, _state); // <= FOUND
```
['[370](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L370-L370)']
```solidity
370:         emit OrderCreated(_orderId, _msgSender(), _size, _price, _isBuy); // <= FOUND
```
['[402](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L402-L402)']
```solidity
402:         emit FlipOrderCreated(_orderId, _flippedId, _owner, _size, _price, _flippedPrice, _isBuy); // <= FOUND
```
['[434](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L434-L434)']
```solidity
434:         emit FlippedOrderCreated(_orderId, _flippedId, _owner, _size, _price, _flippedPrice, _isBuy); // <= FOUND
```
['[457](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L457-L457)']
```solidity
457:         emit FlipOrdersCanceled(_orderIds, _msgSender()); // <= FOUND
```
['[470](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L470-L470)']
```solidity
470:         emit OrdersCanceled(_orderIds, _msgSender()); // <= FOUND
```
['[489](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L489-L489)']
```solidity
489:         emit OrdersCanceled(_orderIdsCanceled, _msgSender()); // <= FOUND
```
['[574](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L574-L574)']
```solidity
574:         emit OrderCanceled(_orderId, _order.ownerAddress, _order.price, _order.size, _order.isBuy); // <= FOUND
```
['[716](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L716-L716)']
```solidity
716:             emit OrdersCanceled(orderIdsCanceled, _msgSender()); // <= FOUND
```
['[1202](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L1202-L1202)']
```solidity
1202:             emit FlipOrderUpdated(_flipOrderId, _updatedSize); // <= FOUND
```
['[1217](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L1217-L1217)']
```solidity
1217:         emit Trade(orderId, makerAddress, isBuy, price, updatedSize, _msgSender(), tx.origin, filledSize); // <= FOUND
```
['[95](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/periphery/MonadDeployer.sol#L95-L95)']
```solidity
95:         emit PumpingTime( // <= FOUND
96:             address(token),
97:             tokenParams.tokenURI,
98:             tokenParams.dev,
99:             tokenParams.initialSupply - _supplyToVault,
100:             market,
101:             metadata
102:         );
```
['[174](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L174-L174)']
```solidity
174:         emit MarketRegistered( // <= FOUND
175:             _baseAssetAddress,
176:             _quoteAssetAddress,
177:             proxy,
178:             address(_kuruAmmVault),
179:             _pricePrecision,
180:             _sizePrecision,
181:             _tickSize,
182:             _minSize,
183:             _maxSize,
184:             _takerFeeBps,
185:             _makerFeeBps,
186:             _kuruAmmSpread
187:         );
```
['[252](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L252-L252)']
```solidity
252:         emit OBImplementationUpdated(orderBookImplementation, newImplementation); // <= FOUND
```
['[262](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L262-L262)']
```solidity
262:         emit VaultImplementationUpdated(kuruAmmVaultImplementation, newImplementation); // <= FOUND
```
['[370](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L370-L370)']
```solidity
370:         emit KuruRouterSwap(msg.sender, _debitToken, _creditToken, _cachedAmountIn, _amountOut); // <= FOUND
```


</details>

## [Gas-26] Use assembly in place of abi.decode to extract calldata values more efficiently

### Resolution 
Using inline assembly to extract calldata values can be more gas-efficient than using `abi.decode` in Solidity. Inline assembly gives more direct access to EVM operations, enabling optimized usage of calldata. However, assembly should be used judiciously as it's more prone to errors. Opt for this approach when performance is critical and the complexity it introduces is manageable.

Num of instances: 1

### Findings 


<details><summary>Click to show findings</summary>

['[141](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L141-L142)']
```solidity
141:             (address _user, address _token, uint256 _amount, bool _useMargin) =
142:                 abi.decode(_encodedData[offset:offset + 128], (address, address, uint256, bool)); // <= FOUND
```


</details>

## [Gas-27] Struct variables can be packed into fewer storage slots by truncating timestamp bytes

### Resolution 
Struct uint variables in Solidity are typically stored in 32-byte storage slots. When dealing with timestamps, which generally fit into a smaller byte size, it can be beneficial to truncate these bytes and pack them with other variables. This reduces the number of required storage slots, saving both storage space and associated gas costs. For example, a timestamp generally fits into a uint32, so it can be combined with other small variables within a single storage slot. When designing a contract, carefully structuring struct variables to utilize truncation and packing can lead to a more efficient and cost-effective implementation.

Num of instances: 4

### Findings 


<details><summary>Click to show findings</summary>

['[26](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruForwarder.sol#L26-L31)']
```solidity
26:     struct ForwardRequest { // <= FOUND
27:         address from;
28:         address market;
29:         uint256 value;
30:         uint256 nonce;
31:         uint256 deadline; // <= FOUND
32:         bytes4 selector;
33:         bytes data;
34:     }
```
['[36](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruForwarder.sol#L36-L42)']
```solidity
36:     struct PriceDependentRequest { // <= FOUND
37:         address from;
38:         address market;
39:         uint256 price;
40:         uint256 value;
41:         uint256 nonce;
42:         uint256 deadline; // <= FOUND
43:         bool isBelowPrice;
44:         bytes4 selector;
45:         bytes data;
46:     }
```
['[48](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruForwarder.sol#L48-L51)']
```solidity
48:     struct CancelPriceDependentRequest { // <= FOUND
49:         address from;
50:         uint256 nonce;
51:         uint256 deadline; // <= FOUND
52:     }
```
['[54](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruForwarder.sol#L54-L59)']
```solidity
54:     struct MarginAccountRequest { // <= FOUND
55:         address from;
56:         address marginAccount;
57:         uint256 value;
58:         uint256 nonce;
59:         uint256 deadline; // <= FOUND
60:         bytes4 selector;
61:         bytes data;
62:     }
```


</details>

## [Gas-28] Mark Functions That Revert For Normal Users As payable

### Resolution 
In Solidity, marking functions as `payable` allows them to accept Ether. If a function is known to revert for regular users (non-admin or specific roles) but needs to be accessible to others, marking it as `payable` can be beneficial. This ensures that even if a regular user accidentally sends Ether to the function, the Ether won't be trapped, as the function reverts, returning the funds. This can save gas by avoiding unnecessary failure handling in the function itself. Resolution: Carefully assess the roles and access patterns, and mark functions that should revert for regular users as `payable` to handle accidental Ether transfers.

Num of instances: 16

### Findings 


<details><summary>Click to show findings</summary>

['[105](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruForwarder.sol#L105-L105)']
```solidity
105:     function setAllowedInterfaces(bytes4[] memory _allowedInterfaces) external onlyOwner {
106:         for (uint256 i = 0; i < _allowedInterfaces.length; i++) {
107:             allowedInterface[_allowedInterfaces[i]] = true;
108:         }
109:     }
```
['[111](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruForwarder.sol#L111-L111)']
```solidity
111:     function removeAllowedInterfaces(bytes4[] memory _allowedInterfaces) external onlyOwner {
112:         for (uint256 i = 0; i < _allowedInterfaces.length; i++) {
113:             allowedInterface[_allowedInterfaces[i]] = false;
114:         }
115:     }
```
['[38](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L38-L38)']
```solidity
38:     function toggleProtocolState(bool _state) external onlyOwner {
39:         require(protocolPaused != _state, MarginAccountErrors.ProtocolStateNotChanged());
40:         protocolPaused = _state;
41:         emit ProtocolStateUpdated(_state);
42:     }
```
['[44](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L44-L44)']
```solidity
44:     function setFeeCollector(address _feeCollector) external onlyOwner {
45:         require(feeCollector != _feeCollector, MarginAccountErrors.FeeCollectorNotChanged());
46:         feeCollector = _feeCollector;
47:         emit FeeCollectorUpdated(_feeCollector);
48:     }
```
['[105](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/periphery/MonadDeployer.sol#L105-L105)']
```solidity
105:     function setKuruAmmSpread(uint96 _kuruAmmSpread) external onlyOwner {
106:         kuruAmmSpread = _kuruAmmSpread;
107:     }
```
['[109](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/periphery/MonadDeployer.sol#L109-L109)']
```solidity
109:     function setKuruCollective(address _kuruCollective) external onlyOwner {
110:         kuruCollective = _kuruCollective;
111:     }
```
['[113](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/periphery/MonadDeployer.sol#L113-L113)']
```solidity
113:     function setKuruCollectiveFee(uint256 _kuruCollectiveFee) external onlyOwner {
114:         kuruCollectiveFee = _kuruCollectiveFee;
115:     }
```
['[250](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L250-L250)']
```solidity
250:     function upgradeOrderBookImplementation(address newImplementation) external onlyOwner {
251:         require(newImplementation != orderBookImplementation);
252:         emit OBImplementationUpdated(orderBookImplementation, newImplementation);
253:         orderBookImplementation = newImplementation;
254:     }
```
['[260](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L260-L260)']
```solidity
260:     function upgradeVaultImplementation(address newImplementation) external onlyOwner {
261:         require(newImplementation != kuruAmmVaultImplementation);
262:         emit VaultImplementationUpdated(kuruAmmVaultImplementation, newImplementation);
263:         kuruAmmVaultImplementation = newImplementation;
264:     }
```
['[271](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L271-L271)']
```solidity
271:     function toggleMarkets(address[] memory markets, IOrderBook.MarketState state) external onlyOwner {
272:         for (uint256 i = 0; i < markets.length; i++) {
273:             IOrderBook(markets[i]).toggleMarket(state);
274:         }
275:     }
```
['[281](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L281-L281)']
```solidity
281:     function upgradeMultipleOrderBookProxies(address[] memory proxies, bytes[] memory data) public onlyOwner {
282:         for (uint256 i = 0; i < proxies.length; i++) {
283:             UUPSUpgradeable(proxies[i]).upgradeToAndCall(orderBookImplementation, data[i]);
284:         }
285:     }
```
['[287](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L287-L287)']
```solidity
287:     function upgradeMultipleVaultProxies(address[] memory proxies, bytes[] memory data) public onlyOwner {
288:         for (uint256 i = 0; i < proxies.length; i++) {
289:             UUPSUpgradeable(proxies[i]).upgradeToAndCall(kuruAmmVaultImplementation, data[i]);
290:         }
291:     }
```
['[298](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L298-L298)']
```solidity
298:     function transferOwnershipForContracts(address[] memory contracts, address _newOwner) external onlyOwner {
299:         for (uint256 i = 0; i < contracts.length; i++) {
300:             Ownable(contracts[i]).transferOwnership(_newOwner);
301:         }
302:     }
```
['[84](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L84-L84)']
```solidity
84:     function transferOwnership(address _newOwner) external {
85:         _checkOwner();
86:         owner = _newOwner;
87:     }
```
['[56](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L56-L56)']
```solidity
56:     function _authorizeUpgrade(address) internal view override {
57:         _checkOwner();
58:     }
```
['[147](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L147-L147)']
```solidity
147:     function toggleMarket(MarketState _state) external {
148:         _checkOwner();
149:         require(_state != marketState, OrderBookErrors.MarketStateError());
150:         marketState = _state;
151:         emit MarketStateUpdated(marketState, _state);
152:     }
```


</details>

## [Gas-29] Lack of unchecked in loops

### Resolution 
In Solidity, the `unchecked` block allows arithmetic operations to not revert on overflow. Without using `unchecked` in loops, extra gas is consumed due to overflow checks. If it's certain that overflows won't occur within the loop, using `unchecked` can make the loop more gas-efficient by skipping unnecessary checks.

Num of instances: 31

### Findings 


<details><summary>Click to show findings</summary>

['[98](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruForwarder.sol#L98-L98)']
```solidity
98:        for (uint256 i = 0; i < _allowedInterfaces.length; i++) {
99:             allowedInterface[_allowedInterfaces[i]] = true;
100:         }
```
['[112](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruForwarder.sol#L112-L112)']
```solidity
112:        for (uint256 i = 0; i < _allowedInterfaces.length; i++) {
113:             allowedInterface[_allowedInterfaces[i]] = false;
114:         }
```
['[179](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L179-L179)']
```solidity
179:        for (uint256 i = 0; i < _tokens.length; i++) {
180:             _balance = balances[_accountKey(_msgSender(), _tokens[i])];
181:             balances[_accountKey(_msgSender(), _tokens[i])] = 0;
182:             if (_balance > 0) {
183:                 if (_tokens[i] == NATIVE) {
184:                     _msgSender().safeTransferETH(_balance);
185:                 } else {
186:                     _tokens[i].safeTransfer(_msgSender(), _balance);
187:                 }
188:             }
189:         }
```
['[453](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L453-L453)']
```solidity
453:        for (uint256 i = 0; i < _orderIds.length; i++) {
454:             _cancelFlipOrder(_orderIds[i]);
455:         }
```
['[466](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L466-L466)']
```solidity
466:        for (uint256 i = 0; i < _orderIds.length; i++) {
467:             _cancelOrder(_orderIds[i], true);
468:         }
```
['[480](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L480-L480)']
```solidity
480:        for (uint256 i = 0; i < _orderIds.length; i++) {
481:             bool _isCanceled = _cancelOrder(_orderIds[i], false);
482:             if (_isCanceled) {
483:                 _orderIdsCanceled[i] = _orderIds[i];
484:             } else {
485:                 _orderIdsCanceled[i] = 0;
486:             }
487:         }
```
['[637](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L637-L637)']
```solidity
637:        for (uint256 i = 0; i < bidPrices.length; i++) {
638:             addPairedLiquidity(bidPrices[i], askPrices[i], bidSizes[i], askSizes[i]);
639:         }
```
['[661](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L661-L661)']
```solidity
661:        for (uint256 i = 0; i < prices.length; i++) {
662:             if (isBuy[i]) {
663:                 addFlipBuyOrder(prices[i], flipPrices[i], sizes[i], _provisionOrRevert);
664:             } else {
665:                 addFlipSellOrder(prices[i], flipPrices[i], sizes[i], _provisionOrRevert);
666:             }
667:         }
```
['[695](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L695-L695)']
```solidity
695:        for (uint256 i = 0; i < orderIdsToCancel.length; i++) {
696:             bool _isCanceled = _cancelOrder(orderIdsToCancel[i], false);
697:             if (_isCanceled) {
698:                 orderIdsCanceled[i] = orderIdsToCancel[i];
699:             } else {
700:                 orderIdsCanceled[i] = 0;
701:             }
702:         }
```
['[272](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L272-L272)']
```solidity
272:        for (uint256 i = 0; i < markets.length; i++) {
273:             IOrderBook(markets[i]).toggleMarket(state);
274:         }
```
['[282](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L282-L282)']
```solidity
282:        for (uint256 i = 0; i < proxies.length; i++) {
283:             UUPSUpgradeable(proxies[i]).upgradeToAndCall(orderBookImplementation, data[i]);
284:         }
```
['[288](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L288-L288)']
```solidity
288:        for (uint256 i = 0; i < proxies.length; i++) {
289:             UUPSUpgradeable(proxies[i]).upgradeToAndCall(kuruAmmVaultImplementation, data[i]);
290:         }
```
['[299](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L299-L299)']
```solidity
299:        for (uint256 i = 0; i < contracts.length; i++) {
300:             Ownable(contracts[i]).transferOwnership(_newOwner);
301:         }
```
['[448](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L448-L448)']
```solidity
448:             for {}
```
['[1021](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L1021-L1021)']
```solidity
1021:           for { z := x }
```
['[98](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruForwarder.sol#L98-L98)']
```solidity
98:         for (uint256 i = 0; i < _allowedInterfaces.length; i++) {
99:             allowedInterface[_allowedInterfaces[i]] = true;
100:         }
```
['[112](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruForwarder.sol#L112-L112)']
```solidity
112:         for (uint256 i = 0; i < _allowedInterfaces.length; i++) {
113:             allowedInterface[_allowedInterfaces[i]] = false;
114:         }
```
['[179](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L179-L179)']
```solidity
179:         for (uint256 i = 0; i < _tokens.length; i++) {
180:             _balance = balances[_accountKey(_msgSender(), _tokens[i])];
181:             balances[_accountKey(_msgSender(), _tokens[i])] = 0;
182:             if (_balance > 0) {
183:                 if (_tokens[i] == NATIVE) {
184:                     _msgSender().safeTransferETH(_balance);
185:                 } else {
186:                     _tokens[i].safeTransfer(_msgSender(), _balance);
187:                 }
188:             }
189:         }
```
['[453](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L453-L453)']
```solidity
453:         for (uint256 i = 0; i < _orderIds.length; i++) {
454:             _cancelFlipOrder(_orderIds[i]);
455:         }
```
['[466](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L466-L466)']
```solidity
466:         for (uint256 i = 0; i < _orderIds.length; i++) {
467:             _cancelOrder(_orderIds[i], true);
468:         }
```
['[480](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L480-L480)']
```solidity
480:         for (uint256 i = 0; i < _orderIds.length; i++) {
481:             bool _isCanceled = _cancelOrder(_orderIds[i], false);
482:             if (_isCanceled) {
483:                 _orderIdsCanceled[i] = _orderIds[i];
484:             } else {
485:                 _orderIdsCanceled[i] = 0;
486:             }
487:         }
```
['[637](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L637-L637)']
```solidity
637:         for (uint256 i = 0; i < bidPrices.length; i++) {
638:             addPairedLiquidity(bidPrices[i], askPrices[i], bidSizes[i], askSizes[i]);
639:         }
```
['[661](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L661-L661)']
```solidity
661:         for (uint256 i = 0; i < prices.length; i++) {
662:             if (isBuy[i]) {
663:                 addFlipBuyOrder(prices[i], flipPrices[i], sizes[i], _provisionOrRevert);
664:             } else {
665:                 addFlipSellOrder(prices[i], flipPrices[i], sizes[i], _provisionOrRevert);
666:             }
667:         }
```
['[695](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L695-L695)']
```solidity
695:         for (uint256 i = 0; i < orderIdsToCancel.length; i++) {
696:             bool _isCanceled = _cancelOrder(orderIdsToCancel[i], false);
697:             if (_isCanceled) {
698:                 orderIdsCanceled[i] = orderIdsToCancel[i];
699:             } else {
700:                 orderIdsCanceled[i] = 0;
701:             }
702:         }
```
['[705](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L705-L705)']
```solidity
705:         for (uint256 i = 0; i < buyPrices.length; i++) {
706:             addBuyOrder(buyPrices[i], buySizes[i], postOnly);
707:         }
```
['[710](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L710-L710)']
```solidity
710:         for (uint256 i = 0; i < sellPrices.length; i++) {
711:             addSellOrder(sellPrices[i], sellSizes[i], postOnly);
712:         }
```
['[272](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L272-L272)']
```solidity
272:         for (uint256 i = 0; i < markets.length; i++) {
273:             IOrderBook(markets[i]).toggleMarket(state);
274:         }
```
['[282](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L282-L282)']
```solidity
282:         for (uint256 i = 0; i < proxies.length; i++) {
283:             UUPSUpgradeable(proxies[i]).upgradeToAndCall(orderBookImplementation, data[i]);
284:         }
```
['[288](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L288-L288)']
```solidity
288:         for (uint256 i = 0; i < proxies.length; i++) {
289:             UUPSUpgradeable(proxies[i]).upgradeToAndCall(kuruAmmVaultImplementation, data[i]);
290:         }
```
['[299](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L299-L299)']
```solidity
299:         for (uint256 i = 0; i < contracts.length; i++) {
300:             Ownable(contracts[i]).transferOwnership(_newOwner);
301:         }
```
['[348](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L348-L348)']
```solidity
348:         for (uint256 i = 0; i < _marketAddresses.length; i++) {
349:             address _currentMarket = _marketAddresses[i];
350:             MarketParams memory _marketParams = verifiedMarket[_currentMarket];
351:             require(_marketParams.pricePrecision > 0, RouterErrors.InvalidMarket());
352:             IOrderBook market = IOrderBook(_currentMarket);
353:             uint256 _value = _nativeSend[i] ? _amount : 0;
354:             _amountOut = _isBuy[i]
355:                 ? (
356:                     market.placeAndExecuteMarketBuy{value: _value}(
357:                         toU96(_amount * _marketParams.pricePrecision / 10 ** _marketParams.quoteAssetDecimals),
358:                         0,
359:                         false,
360:                         true
361:                     )
362:                 )
363:                 : market.placeAndExecuteMarketSell{value: _value}(
364:                     toU96(_amount * _marketParams.sizePrecision / 10 ** _marketParams.baseAssetDecimals), 0, false, true
365:                 );
366: 
367:             _amount = _amountOut;
368:         }
```


</details>

## [Gas-30] Where a value is casted more than once, consider caching the result to save gas

### Resolution 
Casting values multiple times in Solidity can be gas-inefficient. When a value undergoes repeated type conversions, the EVM must execute additional operations for each cast, consuming more gas than necessary. To optimize for gas efficiency, cache the result of the initial cast in a local variable and reuse it, rather than performing multiple casts. This not only conserves gas but also enhances code readability, reducing potential error points. For example, instead of repeatedly casting an `address` to `uint256`, cast once, store the result in a local variable, and reference that variable in subsequent operations.

Num of instances: 10

### Findings 


<details><summary>Click to show findings</summary>

['[1051](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L1051-L1063)']
```solidity
1051:     function lerp(int256 a, int256 b, int256 t, int256 begin, int256 end) internal pure returns (int256) { // <= FOUND
1052:         if (begin > end) {
1053:             t = int256(~uint256(t));
1054:             begin = int256(~uint256(begin));
1055:             end = int256(~uint256(end));
1056:         }
1057:         if (t <= begin) return a;
1058:         if (t >= end) return b;
1059:         
1060:         unchecked {
1061:             if (b >= a) return int256(uint256(a) + fullMulDiv(uint256(b) - uint256(a), // <= FOUND
1062:                 uint256(t) - uint256(begin), uint256(end) - uint256(begin)));
1063:             return int256(uint256(a) - fullMulDiv(uint256(a) - uint256(b), // <= FOUND
1064:                 uint256(t) - uint256(begin), uint256(end) - uint256(begin)));
1065:         }
1066:     }
```
['[376](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L376-L412)']
```solidity
376:     function _convertToAssetsWithNewSize(uint256 shares)
377:         internal
378:         view
379:         returns (uint256, uint256, uint96, uint96, bool)
380:     {
381:         (uint256 _baseAmount,) = _returnNormalizedAmountAndPrice(false);
382:         uint256 _baseAmountAfterRemoval = _baseAmount - FixedPointMathLib.mulDiv(shares, _baseAmount, totalSupply());
383:         (uint96 _newAskSize, uint96 _newBidSize) = _getVaultSizesForBaseAmount(_baseAmountAfterRemoval);
384:         (
385:             ,
386:             uint256 _vaultBestBid,
387:             uint96 _partiallyFilledBidSize,
388:             uint256 _vaultBestAsk,
389:             uint96 _partiallyFilledAskSize,
390:             ,
391:             ,
392:         ) = market.getVaultParams();
393:         MarketParams memory _marketParams = marketParams;
394:         (uint256 _reserveBase, uint256 _reserveQuote) = totalAssets();
395:         if (_partiallyFilledAskSize > _newAskSize || _partiallyFilledBidSize > _newBidSize) {
396:             int256 _baseOwedToVault = (
397:                 int256(uint256(_partiallyFilledAskSize)) - int256(uint256(_partiallyFilledBidSize))
398:             ) * int256(10 ** _marketParams.baseAssetDecimals) / int256(uint256(_marketParams.sizePrecision));
399:             int256 _quoteOwedToVault = (
400:                 int256(FixedPointMathLib.mulDivUp(_partiallyFilledBidSize, _vaultBestBid, _marketParams.sizePrecision))
401:                     - int256(FixedPointMathLib.mulDiv(_partiallyFilledAskSize, _vaultBestAsk, _marketParams.sizePrecision))
402:             ) * int256(10 ** _marketParams.quoteAssetDecimals) / int256(vaultPricePrecision);
403:             uint256 _baseOwedToUser;
404:             uint256 _quoteOwedToUser;
405:             if (_baseOwedToVault < 0) {
406:                 _reserveBase = _reserveBase - (uint256(-1 * _baseOwedToVault));
407:                 _baseOwedToUser =
408:                     FixedPointMathLib.mulDiv(shares, _reserveBase, totalSupply()) + uint256(-1 * _baseOwedToVault);
409:             } else {
410:                 _reserveBase = _reserveBase + (uint256(_baseOwedToVault)); // <= FOUND 'int256(_baseOwedToVault)'
411:                 _baseOwedToUser =
412:                     FixedPointMathLib.mulDiv(shares, _reserveBase, totalSupply()) - uint256(_baseOwedToVault); // <= FOUND 'int256(_baseOwedToVault)'
413:             }
414:             if (_quoteOwedToVault < 0) {
415:                 _reserveQuote = _reserveQuote - (uint256(-1 * _quoteOwedToVault));
416:                 _quoteOwedToUser =
417:                     FixedPointMathLib.mulDiv(shares, _reserveQuote, totalSupply()) + uint256(-1 * _quoteOwedToVault);
418:             } else {
419:                 _reserveQuote = _reserveQuote + (uint256(_quoteOwedToVault));
420:                 _quoteOwedToUser =
421:                     FixedPointMathLib.mulDiv(shares, _reserveQuote, totalSupply()) - uint256(_quoteOwedToVault);
422:             }
423:             return (_baseOwedToUser, _quoteOwedToUser, _newAskSize, _newBidSize, true);
424:         } else {
425:             uint256 _baseOwedToUser = FixedPointMathLib.mulDiv(shares, _reserveBase, totalSupply());
426:             uint256 _quoteOwedToUser = FixedPointMathLib.mulDiv(shares, _reserveQuote, totalSupply());
427:             return (_baseOwedToUser, _quoteOwedToUser, _newAskSize, _newBidSize, false);
428:         }
429:     }
```
['[346](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L346-L416)']
```solidity
346:     function lambertW0Wad(int256 x) internal pure returns (int256 w) {
347:         
348:         unchecked {
349:             if ((w = x) <= -367879441171442322) revert OutOfDomain(); 
350:             int256 wad = int256(WAD);
351:             int256 p = x;
352:             uint256 c; 
353:             uint256 i = 4; 
354:             if (w <= 0x1ffffffffffff) {
355:                 if (-0x4000000000000 <= w) {
356:                     i = 1; 
357:                 } else if (w <= -0x3ffffffffffffff) {
358:                     i = 32; 
359:                 }
360:             } else if (uint256(w >> 63) == uint256(0)) { // <= FOUND 'int256(0)'
361:                 
362:                 assembly {
363:                     
364:                     let v := shr(49, w)
365:                     let l := shl(3, lt(0xff, v))
366:                     l := add(or(l, byte(and(0x1f, shr(shr(l, v), 0x8421084210842108cc6318c6db6d54be)),
367:                         0x0706060506020504060203020504030106050205030304010505030400000000)), 49)
368:                     w := sdiv(shl(l, 7), byte(sub(l, 31), 0x0303030303030303040506080c13))
369:                     c := gt(l, 60)
370:                     i := add(2, add(gt(l, 53), c))
371:                 }
372:             } else {
373:                 int256 ll = lnWad(w = lnWad(w));
374:                 
375:                 assembly {
376:                     
377:                     w := add(sdiv(mul(ll, 1023715080943847266), w), sub(w, ll))
378:                     i := add(3, iszero(shr(68, x)))
379:                     c := iszero(shr(143, x))
380:                 }
381:                 if (c == uint256(0)) { // <= FOUND 'int256(0)'
382:                     do { 
383:                         int256 e = expWad(w);
384:                         
385:                         assembly {
386:                             let t := mul(w, div(e, wad))
387:                             w := sub(w, sdiv(sub(t, x), div(add(e, t), wad)))
388:                         }
389:                         if (p <= w) break;
390:                         p = w;
391:                     } while (--i != uint256(0)); // <= FOUND 'int256(0)'
392:                     
393:                     assembly {
394:                         w := sub(w, sgt(w, 2))
395:                     }
396:                     return w;
397:                 }
398:             }
399:             do { 
400:                 int256 e = expWad(w);
401:                 
402:                 assembly {
403:                     let t := add(w, wad)
404:                     let s := sub(mul(w, e), mul(x, wad))
405:                     w := sub(w, sdiv(mul(s, wad), sub(mul(e, t), sdiv(mul(add(t, wad), s), add(t, t)))))
406:                 }
407:                 if (p <= w) break;
408:                 p = w;
409:             } while (--i != c);
410:             
411:             assembly {
412:                 w := sub(w, sgt(w, 2))
413:             }
414:             
415:             
416:             if (c == uint256(0)) return w; // <= FOUND 'int256(0)'
417:             int256 t = w | 1;
418:             
419:             assembly {
420:                 x := sdiv(mul(x, wad), t)
421:             }
422:             x = (t * (wad + lnWad(x)));
423:             
424:             assembly {
425:                 w := sdiv(x, add(wad, t))
426:             }
427:         }
428:     }
```
['[1051](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L1051-L1063)']
```solidity
1051:     function lerp(int256 a, int256 b, int256 t, int256 begin, int256 end) internal pure returns (int256) {
1052:         if (begin > end) {
1053:             t = int256(~uint256(t));
1054:             begin = int256(~uint256(begin));
1055:             end = int256(~uint256(end));
1056:         }
1057:         if (t <= begin) return a;
1058:         if (t >= end) return b;
1059:         
1060:         unchecked {
1061:             if (b >= a) return int256(uint256(a) + fullMulDiv(uint256(b) - uint256(a), // <= FOUND 'int256(a)'
1062:                 uint256(t) - uint256(begin), uint256(end) - uint256(begin)));
1063:             return int256(uint256(a) - fullMulDiv(uint256(a) - uint256(b), // <= FOUND 'int256(a)'
1064:                 uint256(t) - uint256(begin), uint256(end) - uint256(begin)));
1065:         }
1066:     }
```
['[108](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/TreeMath.sol#L108-L170)']
```solidity
108:     function findFirstRight(TreeUint32 storage tree, uint32 id) internal view returns (uint32) {
109:         bytes32 leaves;
110: 
111:         bytes32 key3 = bytes32(uint256(id) >> 8);
112:         uint8 bit = uint8(id & type(uint8).max);
113: 
114:         if (bit != 0) {
115:             leaves = tree.level3[key3];
116:             uint256 closestBit = _closestBitRight(leaves, bit);
117: 
118:             if (closestBit != type(uint256).max) return uint32((uint256(key3) << 8) | closestBit);
119:         }
120: 
121:         bytes32 key2 = key3 >> 8;
122:         bit = uint8(uint256(key3) & type(uint8).max);
123: 
124:         if (bit != 0) {
125:             leaves = tree.level2[key2];
126:             uint256 closestBit = _closestBitRight(leaves, bit);
127: 
128:             if (closestBit != type(uint256).max) {
129:                 key3 = bytes32((uint256(key2) << 8) | closestBit);
130:                 leaves = tree.level3[key3];
131: 
132:                 return uint32((uint256(key3) << 8) | uint256(leaves).mostSignificantBit()); // <= FOUND 'int256(leaves)'
133:             }
134:         }
135: 
136:         bytes32 key1 = key2 >> 8;
137:         bit = uint8(uint256(key2) & type(uint8).max);
138: 
139:         if (bit != 0) {
140:             leaves = tree.level1[key1];
141:             uint256 closestBit = _closestBitRight(leaves, bit);
142: 
143:             if (closestBit != type(uint256).max) {
144:                 key2 = bytes32((uint256(key1) << 8) | closestBit);
145:                 leaves = tree.level2[key2];
146: 
147:                 key3 = bytes32((uint256(key2) << 8) | uint256(leaves).mostSignificantBit()); // <= FOUND 'int256(leaves)'
148:                 leaves = tree.level3[key3];
149: 
150:                 return uint32((uint256(key3) << 8) | uint256(leaves).mostSignificantBit()); // <= FOUND 'int256(leaves)'
151:             }
152:         }
153: 
154:         bit = uint8(uint256(key1) & type(uint8).max);
155: 
156:         if (bit != 0) {
157:             leaves = tree.level0;
158:             uint256 closestBit = _closestBitRight(leaves, bit);
159: 
160:             if (closestBit != type(uint256).max) {
161:                 key1 = bytes32(closestBit);
162:                 leaves = tree.level1[key1];
163: 
164:                 key2 = bytes32((uint256(key1) << 8) | uint256(leaves).mostSignificantBit()); // <= FOUND 'int256(leaves)'
165:                 leaves = tree.level2[key2];
166: 
167:                 key3 = bytes32((uint256(key2) << 8) | uint256(leaves).mostSignificantBit()); // <= FOUND 'int256(leaves)'
168:                 leaves = tree.level3[key3];
169: 
170:                 return uint32((uint256(key3) << 8) | uint256(leaves).mostSignificantBit()); // <= FOUND 'int256(leaves)'
171:             }
172:         }
173: 
174:         return type(uint32).max;
175:     }
```
['[184](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/TreeMath.sol#L184-L246)']
```solidity
184:     function findFirstLeft(TreeUint32 storage tree, uint32 id) internal view returns (uint32) {
185:         bytes32 leaves;
186: 
187:         bytes32 key3 = bytes32(uint256(id) >> 8);
188:         uint8 bit = uint8(id & type(uint8).max);
189: 
190:         if (bit != type(uint8).max) {
191:             leaves = tree.level3[key3];
192:             uint256 closestBit = _closestBitLeft(leaves, bit);
193: 
194:             if (closestBit != type(uint256).max) return uint32((uint256(key3) << 8) | closestBit);
195:         }
196: 
197:         bytes32 key2 = key3 >> 8;
198:         bit = uint8(uint256(key3) & type(uint8).max);
199: 
200:         if (bit != type(uint8).max) {
201:             leaves = tree.level2[key2];
202:             uint256 closestBit = _closestBitLeft(leaves, bit);
203: 
204:             if (closestBit != type(uint256).max) {
205:                 key3 = bytes32((uint256(key2) << 8) | closestBit);
206:                 leaves = tree.level3[key3];
207: 
208:                 return uint32((uint256(key3) << 8) | uint256(leaves).leastSignificantBit()); // <= FOUND 'int256(leaves)'
209:             }
210:         }
211: 
212:         bytes32 key1 = key2 >> 8;
213:         bit = uint8(uint256(key2) & type(uint8).max);
214: 
215:         if (bit != type(uint8).max) {
216:             leaves = tree.level1[key1];
217:             uint256 closestBit = _closestBitLeft(leaves, bit);
218: 
219:             if (closestBit != type(uint256).max) {
220:                 key2 = bytes32((uint256(key1) << 8) | closestBit);
221:                 leaves = tree.level2[key2];
222: 
223:                 key3 = bytes32((uint256(key2) << 8) | uint256(leaves).leastSignificantBit()); // <= FOUND 'int256(leaves)'
224:                 leaves = tree.level3[key3];
225: 
226:                 return uint32((uint256(key3) << 8) | uint256(leaves).leastSignificantBit()); // <= FOUND 'int256(leaves)'
227:             }
228:         }
229: 
230:         bit = uint8(uint256(key1) & type(uint8).max);
231: 
232:         if (bit != type(uint8).max) {
233:             leaves = tree.level0;
234:             uint256 closestBit = _closestBitLeft(leaves, bit);
235: 
236:             if (closestBit != type(uint256).max) {
237:                 key1 = bytes32(closestBit);
238:                 leaves = tree.level1[key1];
239: 
240:                 key2 = bytes32((uint256(key1) << 8) | uint256(leaves).leastSignificantBit()); // <= FOUND 'int256(leaves)'
241:                 leaves = tree.level2[key2];
242: 
243:                 key3 = bytes32((uint256(key2) << 8) | uint256(leaves).leastSignificantBit()); // <= FOUND 'int256(leaves)'
244:                 leaves = tree.level3[key3];
245: 
246:                 return uint32((uint256(key3) << 8) | uint256(leaves).leastSignificantBit()); // <= FOUND 'int256(leaves)'
247:             }
248:         }
249: 
250:         return 0;
251:     }
```
['[728](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L728-L771)']
```solidity
728:     function placeAndExecuteMarketBuy(uint96 _quoteSize, uint256 _minAmountOut, bool _isMargin, bool _isFillOrKill)
729:         public
730:         payable
731:         override
732:         marketActive
733:         nonReentrant
734:         returns (uint256)
735:     {
736:         OrderBookType _type = orderBookType;
737: 
738:         if (_type == OrderBookType.NATIVE_IN_QUOTE && !_isMargin && (msg.sender != address(0))) {
739:             require(
740:                 msg.value >= _pricePrecisionToQuoteAssetPrecision(_quoteSize), OrderBookErrors.NativeAssetInsufficient()
741:             );
742:             require(
743:                 msg.value < _pricePrecisionToQuoteAssetPrecision(_quoteSize + 1), OrderBookErrors.NativeAssetSurplus()
744:             );
745:         } else if (msg.sender != address(0)) {
746:             require(msg.value == 0, OrderBookErrors.NativeAssetNotRequired());
747:             _isMargin
748:                 ? marginAccount.debitUser(_msgSender(), quoteAsset, _pricePrecisionToQuoteAssetPrecision(_quoteSize))
749:                 : quoteAsset.safeTransferFrom(
750:                     _msgSender(), address(marginAccount), _pricePrecisionToQuoteAssetPrecision(_quoteSize) // <= FOUND 'address(marginAccount)'
751:                 );
752:         }
753: 
754:         uint256 _baseTokensCredited;
755:         (_quoteSize, _baseTokensCredited) = _marketBuyMatch(_quoteSize, _isMargin);
756:         if (msg.sender == address(0)) {
757:             return _baseTokensCredited;
758:         }
759:         if (_quoteSize > 0) {
760:             require(!_isFillOrKill, OrderBookErrors.InsufficientLiquidity());
761:             if (_type == OrderBookType.NATIVE_IN_QUOTE && !_isMargin) {
762:                 
763:                 uint256 _refund = _pricePrecisionToQuoteAssetPrecision(_quoteSize);
764:                 _handleNativeMarketRefundTransfer(_refund);
765:             } else {
766:                 marginAccount.creditUser(
767:                     _msgSender(), quoteAsset, _pricePrecisionToQuoteAssetPrecision(_quoteSize), _isMargin
768:                 );
769:             }
770:         } else if (_type == OrderBookType.NATIVE_IN_QUOTE) {
771:             address(marginAccount).safeTransferETH(msg.value); // <= FOUND 'address(marginAccount)'
772:         }
773:         require(_baseTokensCredited >= _minAmountOut, OrderBookErrors.SlippageExceeded());
774: 
775:         return _baseTokensCredited;
776:     }
```
['[786](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L786-L820)']
```solidity
786:     function placeAndExecuteMarketSell(uint96 _size, uint256 _minAmountOut, bool _isMargin, bool _isFillOrKill)
787:         public
788:         payable
789:         marketActive
790:         nonReentrant
791:         returns (uint256)
792:     {
793:         OrderBookType _type = orderBookType;
794:         if (_type == OrderBookType.NATIVE_IN_BASE && !_isMargin && (msg.sender != address(0))) {
795:             require(msg.value >= _sizePrecisionToBaseAssetPrecision(_size), OrderBookErrors.NativeAssetInsufficient());
796:             require(msg.value < _sizePrecisionToBaseAssetPrecision(_size + 1), OrderBookErrors.NativeAssetSurplus());
797:         } else if (msg.sender != address(0)) {
798:             require(msg.value == 0, OrderBookErrors.NativeAssetNotRequired());
799:             _isMargin
800:                 ? marginAccount.debitUser(_msgSender(), baseAsset, _sizePrecisionToBaseAssetPrecision(_size))
801:                 : baseAsset.safeTransferFrom(
802:                     _msgSender(), address(marginAccount), _sizePrecisionToBaseAssetPrecision(_size) // <= FOUND 'address(marginAccount)'
803:                 );
804:         }
805: 
806:         uint256 _quoteCredited;
807:         (_size, _quoteCredited) = _matchAggressiveSell(0, _size, _isMargin);
808:         if (msg.sender == address(0)) {
809:             return _quoteCredited;
810:         }
811:         if (_size > 0) {
812:             require(!_isFillOrKill, OrderBookErrors.InsufficientLiquidity());
813:             if (_type == OrderBookType.NATIVE_IN_BASE && !_isMargin) {
814:                 uint256 _refund = _sizePrecisionToBaseAssetPrecision(_size);
815:                 _handleNativeMarketRefundTransfer(_refund);
816:             } else {
817:                 marginAccount.creditUser(_msgSender(), baseAsset, _sizePrecisionToBaseAssetPrecision(_size), _isMargin);
818:             }
819:         } else if (_type == OrderBookType.NATIVE_IN_BASE) {
820:             address(marginAccount).safeTransferETH(msg.value); // <= FOUND 'address(marginAccount)'
821:         }
822:         require(_quoteCredited >= _minAmountOut, OrderBookErrors.SlippageExceeded());
823:         return _quoteCredited;
824:     }
```
['[65](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/periphery/MonadDeployer.sol#L65-L96)']
```solidity
65:     function deployTokenAndMarket(
66:         TokenParams memory tokenParams,
67:         MarketParams memory marketParams,
68:         bytes calldata metadata
69:     ) external payable returns (address market) {
70:         KuruERC20 token = new KuruERC20(tokenParams.name, tokenParams.symbol, tokenParams.initialSupply, address(this));
71:         market = router.deployProxy(
72:             IOrderBook.OrderBookType.NATIVE_IN_QUOTE,
73:             address(token), // <= FOUND 'address(token)'
74:             address(0),
75:             marketParams.sizePrecision,
76:             marketParams.pricePrecision,
77:             marketParams.tickSize,
78:             marketParams.minSize,
79:             marketParams.maxSize,
80:             marketParams.takerFeeBps,
81:             marketParams.makerFeeBps,
82:             kuruAmmSpread
83:         );
84:         if (msg.value != (marketParams.nativeTokenAmount + kuruCollectiveFee)) {
85:             revert InsufficientAssets(marketParams.nativeTokenAmount + kuruCollectiveFee, msg.value);
86:         }
87:         (address vault,,,,,,,) = IOrderBook(market).getVaultParams();
88:         uint256 _supplyToVault = tokenParams.initialSupply * (10 ** 4 - tokenParams.supplyToDev) / 10 ** 4;
89:         token.approve(vault, _supplyToVault);
90:         IKuruAMMVault(vault).deposit{value: marketParams.nativeTokenAmount}(
91:             _supplyToVault, marketParams.nativeTokenAmount, address(this)
92:         );
93:         token.transfer(tokenParams.dev, tokenParams.initialSupply - _supplyToVault);
94:         marginAccount.deposit{value: kuruCollectiveFee}(kuruCollective, address(0), kuruCollectiveFee);
95:         emit PumpingTime(
96:             address(token), // <= FOUND 'address(token)'
97:             tokenParams.tokenURI,
98:             tokenParams.dev,
99:             tokenParams.initialSupply - _supplyToVault,
100:             market,
101:             metadata
102:         );
103:     }
```
['[74](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L74-L178)']
```solidity
74:     function deployProxy(
75:         IOrderBook.OrderBookType _type,
76:         address _baseAssetAddress,
77:         address _quoteAssetAddress,
78:         uint96 _sizePrecision,
79:         uint32 _pricePrecision,
80:         uint32 _tickSize,
81:         uint96 _minSize,
82:         uint96 _maxSize,
83:         uint256 _takerFeeBps,
84:         uint256 _makerFeeBps,
85:         uint96 _kuruAmmSpread
86:     ) public returns (address proxy) {
87:         if (_type == IOrderBook.OrderBookType.NATIVE_IN_BASE) {
88:             require(_baseAssetAddress == address(0), RouterErrors.MarketTypeMismatch());
89:             require(_quoteAssetAddress != address(0), RouterErrors.MarketTypeMismatch());
90:         } else if (_type == IOrderBook.OrderBookType.NATIVE_IN_QUOTE) {
91:             require(_baseAssetAddress != address(0), RouterErrors.MarketTypeMismatch());
92:             require(_quoteAssetAddress == address(0), RouterErrors.MarketTypeMismatch());
93:         } else {
94:             require(_baseAssetAddress != address(0), RouterErrors.MarketTypeMismatch());
95:             require(_quoteAssetAddress != address(0), RouterErrors.MarketTypeMismatch());
96:             require(_baseAssetAddress != _quoteAssetAddress, RouterErrors.BaseAndQuoteAssetSame());
97:         }
98:         require(_tickSize > 0, RouterErrors.InvalidTickSize());
99:         require(10 ** Math.log10(_sizePrecision) == _sizePrecision, RouterErrors.InvalidSizePrecision());
100:         require(10 ** Math.log10(_pricePrecision) == _pricePrecision, RouterErrors.InvalidPricePrecision());
101:         uint256 _baseAssetDecimals =
102:             _type == IOrderBook.OrderBookType.NATIVE_IN_BASE ? 18 : IERC20Metadata(_baseAssetAddress).decimals();
103:         uint256 _quoteAssetDecimals =
104:             _type == IOrderBook.OrderBookType.NATIVE_IN_QUOTE ? 18 : IERC20Metadata(_quoteAssetAddress).decimals();
105:         {
106:             bytes32 _salt = _getSalt(
107:                 _baseAssetAddress,
108:                 _quoteAssetAddress,
109:                 _sizePrecision,
110:                 _pricePrecision,
111:                 _tickSize,
112:                 _minSize,
113:                 _maxSize,
114:                 _takerFeeBps,
115:                 _makerFeeBps,
116:                 _kuruAmmSpread
117:             );
118:             proxy = Create2.deploy(
119:                 0,
120:                 _salt,
121:                 abi.encodePacked(type(ERC1967Proxy).creationCode, abi.encode(orderBookImplementation, bytes("")))
122:             );
123:         }
124:         IKuruAMMVault _kuruAmmVault = IKuruAMMVault(
125:             Create2.deploy(
126:                 0,
127:                 keccak256(abi.encode(proxy)),
128:                 abi.encodePacked(type(ERC1967Proxy).creationCode, abi.encode(kuruAmmVaultImplementation, bytes("")))
129:             )
130:         );
131: 
132:         verifiedMarket[proxy] = MarketParams(
133:             _pricePrecision,
134:             _sizePrecision,
135:             _baseAssetAddress,
136:             _baseAssetDecimals,
137:             _quoteAssetAddress,
138:             _quoteAssetDecimals,
139:             _tickSize,
140:             _minSize,
141:             _maxSize,
142:             _takerFeeBps,
143:             _makerFeeBps
144:         );
145:         IMarginAccount(marginAccountAddress).updateMarkets(proxy);
146:         {
147:             IOrderBook(proxy).initialize(
148:                 address(this),
149:                 _type,
150:                 _baseAssetAddress,
151:                 _baseAssetDecimals,
152:                 _quoteAssetAddress,
153:                 _quoteAssetDecimals,
154:                 marginAccountAddress,
155:                 _sizePrecision,
156:                 _pricePrecision,
157:                 _tickSize,
158:                 _minSize,
159:                 _maxSize,
160:                 _takerFeeBps,
161:                 _makerFeeBps,
162:                 address(_kuruAmmVault), // <= FOUND 'address(_kuruAmmVault)'
163:                 _kuruAmmSpread,
164:                 TRUSTED_FORWARDER
165:             );
166:         }
167: 
168:         _kuruAmmVault.initialize(
169:             address(this), _baseAssetAddress, _quoteAssetAddress, marginAccountAddress, proxy, _kuruAmmSpread
170:         );
171: 
172:         _setApprovalsForMarket(_baseAssetAddress, _quoteAssetAddress, proxy, _type);
173: 
174:         emit MarketRegistered(
175:             _baseAssetAddress,
176:             _quoteAssetAddress,
177:             proxy,
178:             address(_kuruAmmVault), // <= FOUND 'address(_kuruAmmVault)'
179:             _pricePrecision,
180:             _sizePrecision,
181:             _tickSize,
182:             _minSize,
183:             _maxSize,
184:             _takerFeeBps,
185:             _makerFeeBps,
186:             _kuruAmmSpread
187:         );
188: 
189:         return proxy;
190:     }
```


</details>

## [Gas-31] Assembly let var only used on once

### Resolution 
If a variable is only once, it makes more sense to use the value the variable holds directly

Num of instances: 2

### Findings 


<details><summary>Click to show findings</summary>

['[501](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L501-L501)']
```solidity
501:         assembly {
502:             result := mul(x, y)
503:             let mm := mulmod(x, y, not(0))
504:             let p1 := sub(mm, add(result, lt(mm, result)))
505:             let t := and(d, sub(0, d))
506:             let r := mulmod(x, y, d)
507:             d := div(d, t)
508:             let inv := xor(2, mul(3, d))
509:             inv := mul(inv, sub(2, mul(d, inv)))
510:             inv := mul(inv, sub(2, mul(d, inv)))
511:             inv := mul(inv, sub(2, mul(d, inv)))
512:             inv := mul(inv, sub(2, mul(d, inv)))
513:             inv := mul(inv, sub(2, mul(d, inv)))
514:             result :=
515:                 mul(
516:                     or(mul(sub(p1, gt(r, result)), add(div(sub(0, t), t), 1)), div(sub(result, r), t)),
517:                     mul(sub(2, mul(d, inv)), inv)
518:                 )
519:         }
```
['[1441](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L1441-L1443)']
```solidity
1441:         assembly ("memory-safe") {
1442:             let curFree := mload(0x40) // <= FOUND
1443:             if iszero(eq(curFree, lastFree)) { // <= FOUND
1444:                 let producedLen := sub(lastFree, dataStart)
1445:                 for { let offset := 0 }
```


</details>

## [Gas-32] Assembly let var never used

### Resolution 
If a variable is not used, it is redundant and can be removed if safe to do so

Num of instances: 2

### Findings 


<details><summary>Click to show findings</summary>

['[746](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L746-L746)']
```solidity
746:         assembly {
747:             let p := x
748:             for {}
```
['[1441](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L1441-L1444)']
```solidity
1441:         assembly ("memory-safe") {
1442:             let curFree := mload(0x40)
1443:             if iszero(eq(curFree, lastFree)) {
1444:                 let producedLen := sub(lastFree, dataStart) // <= FOUND
1445:                 for { let offset := 0 }
```


</details>

## [Gas-33] Use assembly to validate msg.sender

### Resolution 
Utilizing assembly for validating `msg.sender` can potentially save gas as it allows for more direct and efficient access to Ethereum’s EVM opcodes, bypassing some of the overhead introduced by Solidity’s higher-level abstractions. However, this practice requires deep expertise in EVM, as incorrect implementation can introduce critical vulnerabilities. It is a trade-off between gas efficiency and code safety.

Num of instances: 3

### Findings 


<details><summary>Click to show findings</summary>

['[90](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L90-L90)']
```solidity
90:         require(msg.sender == owner, KuruAMMVaultErrors.Unauthorized()); // <= FOUND
```
['[61](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L61-L61)']
```solidity
61:         require(msg.sender == routerContractAddress, MarginAccountErrors.OnlyRouterAllowed()); // <= FOUND
```
['[134](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L134-L134)']
```solidity
134:         require(msg.sender == owner, OrderBookErrors.Unauthorized()); // <= FOUND
```


</details>

## [Gas-34] Simple checks for zero uint can be done using assembly to save gas

### Resolution 
Using assembly for simple zero checks on unsigned integers can save gas due to lower-level, optimized operations. 

**Resolution**: Implement inline assembly with Solidity's `assembly` block to perform zero checks. Ensure thorough testing and verification, as assembly lacks the safety checks of high-level Solidity, potentially introducing vulnerabilities if not used carefully.

Num of instances: 3

### Findings 


<details><summary>Click to show findings</summary>

['[173](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L173-L173)']
```solidity
173:         require(_price % tickSize == 0, OrderBookErrors.TickSizeError()); // <= FOUND
```
['[199](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L199-L199)']
```solidity
199:         require(_shares > 0, KuruAMMVaultErrors.InsufficientLiquidityMinted());
```
['[98](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L98-L98)']
```solidity
98:         require(_tickSize > 0, RouterErrors.InvalidTickSize());
```


</details>

## [Gas-35] Using nested if to save gas

### Resolution 
Using nested `if` statements instead of logical AND (`&&`) operators can potentially save gas in Solidity contracts. When a series of conditions are connected with `&&`, all conditions must be evaluated even if the first one fails. In contrast, nested `if` statements allow for short-circuiting; if the first condition fails, the rest are skipped, saving gas. This approach is more gas-efficient, especially when dealing with complex or gas-intensive conditions. However, it's crucial to balance gas savings with code readability and maintainability, ensuring that the code remains clear and easy to understand.

Num of instances: 45

### Findings 


<details><summary>Click to show findings</summary>

['[18](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/ERC2771Context.sol#L18-L18)']
```solidity
18:         if (isTrustedForwarder(msg.sender) && calldataLength >= contextSuffixLength) { // <= FOUND
19:             return msg.data[:calldataLength - contextSuffixLength];
20:         }
```
['[28](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/ERC2771Context.sol#L28-L28)']
```solidity
28:         if (isTrustedForwarder(msg.sender) && calldataLength >= contextSuffixLength) { // <= FOUND
29:             return address(bytes20(msg.data[calldataLength - contextSuffixLength:]));
30:         }
```
['[738](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L738-L738)']
```solidity
738:         if (_type == OrderBookType.NATIVE_IN_QUOTE && !_isMargin && (msg.sender != address(0))) { // <= FOUND
739:             require(
740:                 msg.value >= _pricePrecisionToQuoteAssetPrecision(_quoteSize), OrderBookErrors.NativeAssetInsufficient()
741:             );
742:             require(
743:                 msg.value < _pricePrecisionToQuoteAssetPrecision(_quoteSize + 1), OrderBookErrors.NativeAssetSurplus()
744:             );
745:         }
```
['[761](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L761-L761)']
```solidity
761:             if (_type == OrderBookType.NATIVE_IN_QUOTE && !_isMargin) { // <= FOUND
762:                 
763:                 uint256 _refund = _pricePrecisionToQuoteAssetPrecision(_quoteSize);
764:                 _handleNativeMarketRefundTransfer(_refund);
765:             }
```
['[794](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L794-L794)']
```solidity
794:         if (_type == OrderBookType.NATIVE_IN_BASE && !_isMargin && (msg.sender != address(0))) { // <= FOUND
795:             require(msg.value >= _sizePrecisionToBaseAssetPrecision(_size), OrderBookErrors.NativeAssetInsufficient());
796:             require(msg.value < _sizePrecisionToBaseAssetPrecision(_size + 1), OrderBookErrors.NativeAssetSurplus());
797:         }
```
['[813](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L813-L813)']
```solidity
813:             if (_type == OrderBookType.NATIVE_IN_BASE && !_isMargin) { // <= FOUND
814:                 uint256 _refund = _sizePrecisionToBaseAssetPrecision(_size);
815:                 _handleNativeMarketRefundTransfer(_refund);
816:             }
```
['[976](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L976-L976)']
```solidity
976:             if (sizeToCreditViaVault > 0 && msg.sender != address(0)) { // <= FOUND
977:                 marginAccount.debitUser(
978:                     kuruAmmVault, baseAsset, (sizeToCreditViaVault * _baseDecimalMultiplier) / _sizePrecision
979:                 );
980:             }
```
['[1044](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L1044-L1044)']
```solidity
1044:         if (quoteCreditTaker == 0 && quoteCreditVaultTaker == 0) { // <= FOUND
1045:             return (_sizeToBeFilledLeft, 0);
1046:         }
```
['[1051](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L1051-L1051)']
```solidity
1051:             if (quoteCreditVaultTaker > 0 && msg.sender != address(0)) { // <= FOUND
1052:                 marginAccount.debitUser(
1053:                     kuruAmmVault, quoteAsset, (quoteCreditVaultTaker * _quoteDecimalMultiplier) / vaultPricePrecision
1054:                 );
1055:             }
```
['[217](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L217-L217)']
```solidity
217:            if ((uint256(_price) * vaultPricePrecision / pricePrecision) >= _bestAsk && _bestAsk != 0) { // <= FOUND
218:                 if (_provisionOrRevert) {
219:                     revert OrderBookErrors.ProvisionError();
220:                 } else {
221:                     return;
222:                 }
223:             }
```
['[287](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L287-L287)']
```solidity
287:            if ((uint256(_price) * vaultPricePrecision / pricePrecision) <= _bestBid && _bestBid != type(uint256).max) { // <= FOUND
288:                 if (_provisionOrRevert) {
289:                     revert OrderBookErrors.ProvisionError();
290:                 } else {
291:                     return;
292:                 }
293:             }
```
['[73](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/AbstractAMM.sol#L73-L73)']
```solidity
73:         while (_price < _breakPoint && _quoteInput > 0) { // <= FOUND
```
['[139](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/AbstractAMM.sol#L139-L139)']
```solidity
139:         while (_price < _breakPoint && sizeLeft > 0) { // <= FOUND
```
['[199](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/AbstractAMM.sol#L199-L199)']
```solidity
199:         while (_price > _breakPoint && sizeLeft > 0) { // <= FOUND
```
['[146](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruForwarder.sol#L146-L146)']
```solidity
146:         return req.nonce >= _nonces[req.from] && signer == req.from; // <= FOUND
```
['[268](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruForwarder.sol#L268-L269)']
```solidity
268:         require(
269:             (req.isBelowPrice && req.price < _currentBidPrice) || (!req.isBelowPrice && req.price > _currentBidPrice), // <= FOUND
270:             PriceDependentRequestFailed(_currentBidPrice, req.price)
271:         );
```
['[18](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/ERC2771Context.sol#L18-L18)']
```solidity
18:         if (isTrustedForwarder(msg.sender) && calldataLength >= contextSuffixLength) { // <= FOUND
```
['[106](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L106-L106)']
```solidity
106:         require(_makerFeeBps <= _takerFeeBps && _takerFeeBps < BPS_MULTIPLIER, OrderBookErrors.MarketFeeError()); // <= FOUND
```
['[107](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L107-L107)']
```solidity
107:         require(_kuruAmmSpread % 10 == 0 && _kuruAmmSpread > 0 && _kuruAmmSpread < 500, OrderBookErrors.InvalidSpread()); // <= FOUND
```
['[108](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L108-L108)']
```solidity
108:         require(_minSize > 0 && _maxSize > _minSize, OrderBookErrors.MarketSizeError()); // <= FOUND
```
['[170](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L170-L170)']
```solidity
170:         require(_price > 0 && _price < type(uint32).max, OrderBookErrors.PriceError()); // <= FOUND
```
['[210](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L210-L210)']
```solidity
210:         require(_price > 0 && _flippedPrice > 0 && _flippedPrice < type(uint32).max, OrderBookErrors.PriceError()); // <= FOUND
```
['[211](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L211-L211)']
```solidity
211:         require(_price % tickSize == 0 && _flippedPrice % tickSize == 0, OrderBookErrors.TickSizeError()); // <= FOUND
```
['[213](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L213-L213)']
```solidity
213:         require(_size > minSize && _size < maxSize, OrderBookErrors.SizeError()); // <= FOUND
```
['[217](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L217-L217)']
```solidity
217:             if ((uint256(_price) * vaultPricePrecision / pricePrecision) >= _bestAsk && _bestAsk != 0) { // <= FOUND
```
['[280](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L280-L280)']
```solidity
280:         require(_price > 0 && _flippedPrice > 0 && _price < type(uint32).max, OrderBookErrors.PriceError()); // <= FOUND
```
['[287](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L287-L287)']
```solidity
287:             if ((uint256(_price) * vaultPricePrecision / pricePrecision) <= _bestBid && _bestBid != type(uint256).max) { // <= FOUND
```
['[316](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L316-L316)']
```solidity
316:         require(_bidPrice > 0 && _askPrice > _bidPrice && _askPrice < type(uint32).max, OrderBookErrors.PriceError()); // <= FOUND
```
['[317](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L317-L317)']
```solidity
317:         require(_bidPrice % tickSize == 0 && _askPrice % tickSize == 0, OrderBookErrors.TickSizeError()); // <= FOUND
```
['[318](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L318-L318)']
```solidity
318:         require(_bidSize > minSize && _bidSize < maxSize, OrderBookErrors.SizeError()); // <= FOUND
```
['[319](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L319-L319)']
```solidity
319:         require(_askSize > minSize && _askSize < maxSize, OrderBookErrors.SizeError()); // <= FOUND
```
['[634](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L634-L635)']
```solidity
634:         require(
635:             bidPrices.length == bidSizes.length && askPrices.length == askSizes.length, OrderBookErrors.LengthMismatch() // <= FOUND
636:         );
```
['[738](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L738-L738)']
```solidity
738:         if (_type == OrderBookType.NATIVE_IN_QUOTE && !_isMargin && (msg.sender != address(0))) { // <= FOUND
```
['[761](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L761-L761)']
```solidity
761:             if (_type == OrderBookType.NATIVE_IN_QUOTE && !_isMargin) { // <= FOUND
```
['[794](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L794-L794)']
```solidity
794:         if (_type == OrderBookType.NATIVE_IN_BASE && !_isMargin && (msg.sender != address(0))) { // <= FOUND
```
['[813](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L813-L813)']
```solidity
813:             if (_type == OrderBookType.NATIVE_IN_BASE && !_isMargin) { // <= FOUND
```
['[867](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L867-L867)']
```solidity
867:         while (_sizeToBeFilled > 0 && _bestAsk <= _limitPrice && _bestAsk != 0) { // <= FOUND
```
['[939](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L939-L939)']
```solidity
939:         while (_quoteSize > 0 && _bestAsk != 0) { // <= FOUND
```
['[976](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L976-L976)']
```solidity
976:             if (sizeToCreditViaVault > 0 && msg.sender != address(0)) { // <= FOUND
```
['[1014](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L1014-L1014)']
```solidity
1014:         while (_sizeToBeFilledLeft > 0 && _bestBid >= _limitPrice && _bestBid != type(uint256).max) { // <= FOUND
```
['[1044](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L1044-L1044)']
```solidity
1044:         if (quoteCreditTaker == 0 && quoteCreditVaultTaker == 0) { // <= FOUND
```
['[1051](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L1051-L1051)']
```solidity
1051:             if (quoteCreditVaultTaker > 0 && msg.sender != address(0)) { // <= FOUND
```
['[1087](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L1087-L1087)']
```solidity
1087:         while (_size > 0 && _orderId != OrderLinkedList.NULL) { // <= FOUND
```
['[1413](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L1413-L1413)']
```solidity
1413:         while (price != type(uint32).max && price != 0 && _bidPricePoints != 0) { // <= FOUND
```
['[1458](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L1458-L1458)']
```solidity
1458:         while (price != type(uint32).max && price != 0 && _askPricePoints != 0) { // <= FOUND
```


</details>

## [Gas-36] Using delete instead of setting mapping to 0 saves gas

Num of instances: 1

### Findings 


<details><summary>Click to show findings</summary>

['[181](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L181-L181)']
```solidity
181:             balances[_accountKey(_msgSender(), _tokens[i])] = 0; // <= FOUND
```


</details>

## [Gas-37] Stack variable cost less than state variables while used in emiting event

### Resolution 
When emitting events in Solidity, using stack variables (local variables within a function) instead of state variables can lead to significant gas savings. Stack variables reside in memory only for the duration of the function execution and are less costly to access compared to state variables, which are stored on the blockchain. When an event is emitted, accessing these stack variables requires less gas than fetching data from state variables, which involves reading from the contract's storage - a more expensive operation. Thus, for efficiency, prefer using local variables within functions for event emission, especially in functions that are called frequently.

Num of instances: 5

### Findings 


<details><summary>Click to show findings</summary>

['[95](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/periphery/MonadDeployer.sol#L95-L100)']
```solidity
95:         emit PumpingTime( // <= FOUND
96:             address(token),
97:             tokenParams.tokenURI,
98:             tokenParams.dev,
99:             tokenParams.initialSupply - _supplyToVault,
100:             market, // <= FOUND
101:             metadata
102:         );
```
['[321](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/AbstractAMM.sol#L321-L325)']
```solidity
321:         emit VaultParamsUpdated( // <= FOUND
322:             _vaultAskOrderSize,
323:             askPartiallyFilledSize,
324:             _vaultBidOrderSize,
325:             bidPartiallyFilledSize, // <= FOUND
326:             vaultBestAsk,
327:             vaultBestBid
328:         );
```
['[151](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L151-L151)']
```solidity
151:         emit MarketStateUpdated(marketState, _state); // <= FOUND
```
['[252](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L252-L252)']
```solidity
252:         emit OBImplementationUpdated(orderBookImplementation, newImplementation); // <= FOUND
```
['[262](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L262-L262)']
```solidity
262:         emit VaultImplementationUpdated(kuruAmmVaultImplementation, newImplementation); // <= FOUND
```


</details>

## [Gas-38] Low level call can be optimized with assembly

### Resolution 
Optimizing low-level calls using assembly in Solidity can be beneficial, particularly when dealing with function return data. Typically, even if return data from a low-level call is not used, Solidity still allocates memory to store it, which incurs gas costs. By using assembly, developers can bypass the automatic memory allocation for unused return data. This manual optimization involves handling the call at the assembly level and deliberately choosing not to store the return data in memory when it's not needed.

Num of instances: 4

### Findings 


<details><summary>Click to show findings</summary>

['[230](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruForwarder.sol#L230-L231)']
```solidity
230:         (bool success, bytes memory returndata) =
231:             req.marginAccount.call{value: req.value}(abi.encodePacked(req.selector, req.data, req.from)); // <= FOUND
```
['[230](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruForwarder.sol#L230-L231)']
```solidity
230:         (bool success, bytes memory returndata) =
231:             req.market.call{value: req.value}(abi.encodePacked(req.selector, req.data, req.from)); // <= FOUND
```
['[230](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruForwarder.sol#L230-L231)']
```solidity
230:         (bool success, bytes memory returndata) =
231:             req.marginAccount.call{value: req.value}(abi.encodePacked(req.selector, req.data, req.from)); // <= FOUND
```
['[230](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruForwarder.sol#L230-L231)']
```solidity
230:         (bool success, bytes memory returndata) =
231:             req.market.call{value: req.value}(abi.encodePacked(req.selector, req.data, req.from)); // <= FOUND
```


</details>

## [Gas-39] Using constants directly, rather than caching the value, saves gas

Num of instances: 2

### Findings 


<details><summary>Click to show findings</summary>

['[48](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/OrderLinkedList.sol#L48-L48)']
```solidity
48:             point.head = NULL; // <= FOUND
```
['[49](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/OrderLinkedList.sol#L49-L49)']
```solidity
49:             point.tail = NULL; // <= FOUND
```


</details>

## [Gas-40] Inline modifiers used only once

Num of instances: 2

### Findings 


<details><summary>Click to show findings</summary>

['[31](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/AbstractAMM.sol#L31-L31)']
```solidity
31:     modifier onlyVault() { // <= FOUND
32:         if (msg.sender != kuruAmmVault) {
33:             revert OrderBookErrors.OnlyVaultAllowed();
34:         }
35:         _;
36:     }
```
['[60](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L60-L60)']
```solidity
60:     modifier onlyRouter() { // <= FOUND
61:         require(msg.sender == routerContractAddress, MarginAccountErrors.OnlyRouterAllowed());
62:         _;
63:     }
```


</details>

## [Gas-41] Solidity versions 0.8.19 and above are more gas efficient

### Resolution 
Solidity version 0.8.19 introduced a array of gas optimizations which make contracts which use it more efficient. Provided compatability it may be beneficial to upgrade to this version

Num of instances: 2

### Findings 


<details><summary>Click to show findings</summary>

['[3](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/TreeMath.sol#L3-L3)']
```solidity
3: pragma solidity ^0.8.10;
```
['[2](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L2-L2)']
```solidity
2: pragma solidity ^0.8.4;
```


</details>

## [Gas-42] Calling .length in a for loop wastes gas

### Resolution 
Rather than calling .length for an array in a for loop declaration, it is far more gas efficient to cache this length before and use that instead. This will prevent the array length from being called every loop iteration

Num of instances: 30

### Findings 


<details><summary>Click to show findings</summary>

['[98](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruForwarder.sol#L98-L98)']
```solidity
98: for (uint256 i = 0; i < _allowedInterfaces.length; i++)  // <= FOUND
```
['[98](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruForwarder.sol#L98-L98)']
```solidity
98: for (uint256 i = 0; i < _allowedInterfaces.length; i++)  // <= FOUND
```
['[179](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L179-L179)']
```solidity
179: for (uint256 i = 0; i < _tokens.length; i++)  // <= FOUND
```
['[453](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L453-L453)']
```solidity
453: for (uint256 i = 0; i < _orderIds.length; i++)  // <= FOUND
```
['[453](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L453-L453)']
```solidity
453: for (uint256 i = 0; i < _orderIds.length; i++)  // <= FOUND
```
['[453](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L453-L453)']
```solidity
453: for (uint256 i = 0; i < _orderIds.length; i++)  // <= FOUND
```
['[637](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L637-L637)']
```solidity
637: for (uint256 i = 0; i < bidPrices.length; i++)  // <= FOUND
```
['[661](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L661-L661)']
```solidity
661: for (uint256 i = 0; i < prices.length; i++)  // <= FOUND
```
['[695](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L695-L695)']
```solidity
695: for (uint256 i = 0; i < orderIdsToCancel.length; i++)  // <= FOUND
```
['[272](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L272-L272)']
```solidity
272: for (uint256 i = 0; i < markets.length; i++)  // <= FOUND
```
['[282](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L282-L282)']
```solidity
282: for (uint256 i = 0; i < proxies.length; i++)  // <= FOUND
```
['[282](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L282-L282)']
```solidity
282: for (uint256 i = 0; i < proxies.length; i++)  // <= FOUND
```
['[299](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L299-L299)']
```solidity
299: for (uint256 i = 0; i < contracts.length; i++)  // <= FOUND
```
['[348](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L348-L348)']
```solidity
348: for (uint256 i = 0; i < _marketAddresses.length; i++)  // <= FOUND
```
['[98](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruForwarder.sol#L98-L98)']
```solidity
98: for (uint256 i = 0; i < _allowedInterfaces.length; i++)  // <= FOUND
```
['[98](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruForwarder.sol#L98-L98)']
```solidity
98: for (uint256 i = 0; i < _allowedInterfaces.length; i++)  // <= FOUND
```
['[179](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L179-L179)']
```solidity
179: for (uint256 i = 0; i < _tokens.length; i++)  // <= FOUND
```
['[453](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L453-L453)']
```solidity
453: for (uint256 i = 0; i < _orderIds.length; i++)  // <= FOUND
```
['[453](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L453-L453)']
```solidity
453: for (uint256 i = 0; i < _orderIds.length; i++)  // <= FOUND
```
['[453](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L453-L453)']
```solidity
453: for (uint256 i = 0; i < _orderIds.length; i++)  // <= FOUND
```
['[637](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L637-L637)']
```solidity
637: for (uint256 i = 0; i < bidPrices.length; i++)  // <= FOUND
```
['[661](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L661-L661)']
```solidity
661: for (uint256 i = 0; i < prices.length; i++)  // <= FOUND
```
['[695](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L695-L695)']
```solidity
695: for (uint256 i = 0; i < orderIdsToCancel.length; i++)  // <= FOUND
```
['[705](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L705-L705)']
```solidity
705: for (uint256 i = 0; i < buyPrices.length; i++)  // <= FOUND
```
['[710](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L710-L710)']
```solidity
710: for (uint256 i = 0; i < sellPrices.length; i++)  // <= FOUND
```
['[272](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L272-L272)']
```solidity
272: for (uint256 i = 0; i < markets.length; i++)  // <= FOUND
```
['[282](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L282-L282)']
```solidity
282: for (uint256 i = 0; i < proxies.length; i++)  // <= FOUND
```
['[282](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L282-L282)']
```solidity
282: for (uint256 i = 0; i < proxies.length; i++)  // <= FOUND
```
['[299](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L299-L299)']
```solidity
299: for (uint256 i = 0; i < contracts.length; i++)  // <= FOUND
```
['[348](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L348-L348)']
```solidity
348: for (uint256 i = 0; i < _marketAddresses.length; i++)  // <= FOUND
```


</details>

## [Gas-43] Internal functions only used once can be inlined to save gas

### Resolution 
If a internal function is only used once it doesn't make sense to modularise it unless the function which does call the function would be overly long and complex otherwise

Num of instances: 19

### Findings 


<details><summary>Click to show findings</summary>

['[59](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/AbstractAMM.sol#L59-L59)']
```solidity
59:     function _fillVaultBuyMatch(uint256 _breakPoint, uint96 _quoteSize) // <= FOUND
60:         internal
61:         returns (uint96 quoteLeft, uint96 sizeFilled, bytes memory makerCredits)
62:     
```
['[124](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/AbstractAMM.sol#L124-L124)']
```solidity
124:     function _fillVaultForBuy(uint256 _breakPoint, uint96 _size) // <= FOUND
125:         internal
126:         returns (uint96 sizeLeft, uint96 fundsConsumed, bytes memory makerCredits)
127:     
```
['[187](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/AbstractAMM.sol#L187-L187)']
```solidity
187:     function _fillVaultForSell(uint256 _breakPoint, uint96 _size) // <= FOUND
188:         internal
189:         returns (uint96 sizeLeft, uint256 quoteOwedToUser, bytes memory makerCredits)
190:     
```
['[259](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/AbstractAMM.sol#L259-L259)']
```solidity
259:     function _creditVaultOnMarketSell(uint96 _sizeOwedToVault, uint256 _fundsOwedToUser) // <= FOUND
260:         internal
261:         view
262:         returns (bytes memory returnData)
263:     
```
['[175](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L175-L175)']
```solidity
175:     function _mintAndDeposit(uint256 baseDeposit, uint256 quoteDeposit, address receiver) internal returns (uint256)  // <= FOUND
```
['[220](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L220-L220)']
```solidity
220:     function _depositAmountsToMarginAccount(address _token1, address _token2, uint256 baseDeposit, uint256 quoteDeposit) // <= FOUND
221:         internal
222:     
```
['[258](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L258-L258)']
```solidity
258:     function _burnAndWithdraw(uint256 _shares, address _receiver, address _owner) internal returns (uint256, uint256)  // <= FOUND
```
['[283](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L283-L283)']
```solidity
283:     function _withdrawFromMarginAccount(uint256 baseWithdraw, uint256 quoteWithdraw, address receiver) internal  // <= FOUND
```
['[842](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L842-L842)']
```solidity
842:     function log256(uint256 x) internal pure returns (uint256 r)  // <= FOUND
```
['[855](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L855-L855)']
```solidity
855:     function log256Up(uint256 x) internal pure returns (uint256 r)  // <= FOUND
```
['[865](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L865-L865)']
```solidity
865:     function sci(uint256 x) internal pure returns (uint256 mantissa, uint256 exponent)  // <= FOUND
```
['[416](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L416-L416)']
```solidity
416:     function _addFlippedOrder( // <= FOUND
417:         uint32 _price,
418:         uint32 _flippedPrice,
419:         uint96 _size,
420:         address _owner,
421:         uint40 _orderId,
422:         uint40 _flippedId,
423:         bool _isBuy,
424:         uint40 _prevOrderId
425:     ) internal 
```
['[496](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L496-L496)']
```solidity
496:     function _cancelFlipOrder(uint40 _orderId) internal nonReentrant  // <= FOUND
```
['[855](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L855-L855)']
```solidity
855:     function _matchAggressiveBuyWithCap(uint256 _limitPrice, uint96 _sizeToBeFilled) // <= FOUND
856:         internal
857:         returns (uint96, uint96)
858:     
```
['[930](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L930-L930)']
```solidity
930:     function _marketBuyMatch(uint96 _quoteSize, bool _isMargin) internal returns (uint96, uint256)  // <= FOUND
```
['[1118](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L1118-L1118)']
```solidity
1118:     function _fillOrder(uint40 _orderId, uint96 _incomingSizeToBeFilled) // <= FOUND
1119:         internal
1120:         returns (uint96 incomingOrderRemainingSize, uint40 _nextHead, bytes memory _orderUpdate)
1121:     
```
['[1166](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L1166-L1166)']
```solidity
1166:     function _handleFlipOrderUpdate(uint40 _orderId, uint96 _size, bool nullify) internal  // <= FOUND
```
['[1238](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L1238-L1238)']
```solidity
1238:     function _creditMaker(bool _isMarketBuy, address _ownerAddress, uint96 _size, uint32 _price) // <= FOUND
1239:         internal
1240:         view
1241:         returns (bytes memory)
1242:     
```
['[304](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L304-L304)']
```solidity
304:     function _setApprovalsForMarket( // <= FOUND
305:         address _baseAsset,
306:         address _quoteAsset,
307:         address _marketAddress,
308:         IOrderBook.OrderBookType _type
309:     ) internal 
```


</details>

## [Gas-44] Constructors can be marked as payable to save deployment gas

Num of instances: 3

### Findings 


<details><summary>Click to show findings</summary>

['[33](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L33-L33)']
```solidity
33:     constructor() {
34:         _disableInitializers();
35:     }
```
['[12](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/periphery/ERC20.sol#L12-L12)']
```solidity
12:     constructor(string memory name_, string memory symbol_, uint256 initialSupply_, address mintRecipient_) {
13:         _name = name_;
14:         _symbol = symbol_;
15:         
16:         _mint(mintRecipient_, initialSupply_);
17:     }
```
['[49](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/periphery/MonadDeployer.sol#L49-L49)']
```solidity
49:     constructor(
50:         IRouter _router,
51:         address _owner,
52:         address _marginAccount,
53:         address _kuruCollective,
54:         uint96 _kuruAmmSpread,
55:         uint256 _kuruCollectiveFee
56:     ) {
57:         _initializeOwner(_owner);
58:         router = _router;
59:         marginAccount = IMarginAccount(_marginAccount);
60:         kuruAmmSpread = _kuruAmmSpread;
61:         kuruCollective = _kuruCollective;
62:         kuruCollectiveFee = _kuruCollectiveFee;
63:     }
```


</details>

## [Gas-45] View function called more than once in iteration

### Resolution 
Local caching in Solidity involves storing the result of a `view` function call in a local variable before entering a loop, especially when the function is called repeatedly within that loop. This technique is particularly beneficial for reducing gas costs and enhancing contract efficiency. By caching the result, the contract avoids the overhead associated with multiple external calls to the same function. This method is especially effective if the data retrieved by the `view` function remains constant throughout the loop's execution. Implementing local caching not only optimizes performance but also contributes to clearer, more maintainable code, as it reduces redundant operations and simplifies the logic within the loop.

Num of instances: 5

### Findings 


<details><summary>Click to show findings</summary>

['[179](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L179-L186)']
```solidity
179:        for (uint256 i = 0; i < _tokens.length; i++) { // <= FOUND
180:             _balance = balances[_accountKey(_msgSender(), _tokens[i])]; // <= FOUND
181:             balances[_accountKey(_msgSender(), _tokens[i])] = 0; // <= FOUND
182:             if (_balance > 0) {
183:                 if (_tokens[i] == NATIVE) {
184:                     _msgSender().safeTransferETH(_balance); // <= FOUND
185:                 } else {
186:                     _tokens[i].safeTransfer(_msgSender(), _balance); // <= FOUND
187:                 }
188:             }
189:         }
```
['[179](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L179-L186)']
```solidity
179:         for (uint256 i = 0; i < _tokens.length; i++) { // <= FOUND
180:             _balance = balances[_accountKey(_msgSender(), _tokens[i])]; // <= FOUND
181:             balances[_accountKey(_msgSender(), _tokens[i])] = 0; // <= FOUND
182:             if (_balance > 0) {
183:                 if (_tokens[i] == NATIVE) {
184:                     _msgSender().safeTransferETH(_balance); // <= FOUND
185:                 } else {
186:                     _tokens[i].safeTransfer(_msgSender(), _balance); // <= FOUND
187:                 }
188:             }
189:         }
```
['[867](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L867-L874)']
```solidity
867:         while (_sizeToBeFilled > 0 && _bestAsk <= _limitPrice && _bestAsk != 0) { // <= FOUND
868:             uint96 sizeToBeFilledBefore = _sizeToBeFilled; 
869:             bytes memory priceUpdate;
870: 
871:             if (_isVaultFill) {
872:                 uint96 _vaultFundsConsumed;
873:                 (_sizeToBeFilled, _vaultFundsConsumed, priceUpdate) =
874:                     _fillVaultForBuy(_getOBAsk() > _limitPrice ? _limitPrice + 1 : _getOBAsk(), _sizeToBeFilled); // <= FOUND
875:                 fundsConsumed += _vaultFundsConsumed;
876:             } else {
877:                 (_sizeToBeFilled, priceUpdate) = _fillSizeForPrice(
878:                     s_sellTree,
879:                     toU32(_bestAsk * _pricePrecision / vaultPricePrecision),
880:                     s_sellPricePoints[_bestAsk * _pricePrecision / vaultPricePrecision],
881:                     _sizeToBeFilled
882:                 );
883:             }
884: 
885:             uint96 sizeFilled = sizeToBeFilledBefore - _sizeToBeFilled;
886:             sizeToCreditTaker += sizeFilled;
887:             if (_isVaultFill) {
888:                 sizeToCreditViaVault += sizeFilled;
889:             } else {
890:                 fundsConsumed += _quoteAmountRoundedUp(
891:                     toU32(FixedPointMathLib.mulDivUp(_bestAsk, _pricePrecision, vaultPricePrecision)), sizeFilled
892:                 );
893:             }
894:             makerCredits = bytes.concat(makerCredits, priceUpdate);
895: 
896:             (_isVaultFill, _bestAsk) = bestAsk();
897:         }
```
['[1014](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L1014-L1022)']
```solidity
1014:         while (_sizeToBeFilledLeft > 0 && _bestBid >= _limitPrice && _bestBid != type(uint256).max) { // <= FOUND
1015:             uint96 _sizeToBeFilledBefore = _sizeToBeFilledLeft; 
1016: 
1017:             bytes memory priceUpdate;
1018: 
1019:             if (_isVaultFill) {
1020:                 uint256 _quoteToTaker;
1021:                 (_sizeToBeFilledLeft, _quoteToTaker, priceUpdate) =
1022:                     _fillVaultForSell(_getOBBid() >= _limitPrice ? _getOBBid() : _limitPrice - 1, _sizeToBeFilledLeft); // <= FOUND
1023:                 quoteCreditVaultTaker += _quoteToTaker;
1024:             } else {
1025:                 (_sizeToBeFilledLeft, priceUpdate) = _fillSizeForPrice(
1026:                     s_buyTree,
1027:                     toU32(_bestBid * _pricePrecision / vaultPricePrecision),
1028:                     s_buyPricePoints[_bestBid * _pricePrecision / vaultPricePrecision],
1029:                     _sizeToBeFilledLeft
1030:                 );
1031:                 quoteCreditTaker += toU96(
1032:                     FixedPointMathLib.mulDiv(
1033:                         _sizeToBeFilledBefore - _sizeToBeFilledLeft,
1034:                         toU32(_bestBid * _pricePrecision / vaultPricePrecision),
1035:                         sizePrecision
1036:                     )
1037:                 );
1038:             }
1039:             makerCredits = bytes.concat(makerCredits, priceUpdate);
1040: 
1041:             (_isVaultFill, _bestBid) = bestBid();
1042:         }
```
['[73](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/AbstractAMM.sol#L73-L76)']
```solidity
73:         while (_price < _breakPoint && _quoteInput > 0) { // <= FOUND
74:             uint256 _quoteNeededForFill = FixedPointMathLib.mulDivUp(_price, _availableSize, _getSizePrecision()); // <= FOUND
75:             if (_quoteNeededForFill > _quoteInput) {
76:                 uint96 _sizeFilledAtPrice = toU96(_quoteInput * _getSizePrecision() / _price); // <= FOUND
77:                 sizeFilled += _sizeFilledAtPrice;
78:                 askPartiallyFilledSize += _sizeFilledAtPrice;
79:                 _emitTrade(0, kuruAmmVault, true, _price, _availableSize - _sizeFilledAtPrice, _sizeFilledAtPrice);
80:                 _quoteInput = 0;
81:                 break;
82:             }
```


</details>

## [Gas-46] Internal functions never used once can be removed

### Resolution 
Internal functions which are never used use unnecessary gas and should be safely removed.

Num of instances: 50

### Findings 


<details><summary>Click to show findings</summary>

['[15](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/ERC2771Context.sol#L15-L15)']
```solidity
15:     function _msgData() internal view returns (bytes calldata)  // <= FOUND
```
['[64](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L64-L64)']
```solidity
64:     function mulWad(uint256 x, uint256 y) internal pure returns (uint256 z)  // <= FOUND
```
['[107](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L107-L107)']
```solidity
107:     function mulWadUp(uint256 x, uint256 y) internal pure returns (uint256 z)  // <= FOUND
```
['[77](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L77-L77)']
```solidity
77:     function sMulWad(int256 x, int256 y) internal pure returns (int256 z)  // <= FOUND
```
['[91](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L91-L91)']
```solidity
91:     function rawMulWad(uint256 x, uint256 y) internal pure returns (uint256 z)  // <= FOUND
```
['[120](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L120-L120)']
```solidity
120:     function rawMulWadUp(uint256 x, uint256 y) internal pure returns (uint256 z)  // <= FOUND
```
['[99](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L99-L99)']
```solidity
99:     function rawSMulWad(int256 x, int256 y) internal pure returns (int256 z)  // <= FOUND
```
['[128](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L128-L128)']
```solidity
128:     function divWad(uint256 x, uint256 y) internal pure returns (uint256 z)  // <= FOUND
```
['[171](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L171-L171)']
```solidity
171:     function divWadUp(uint256 x, uint256 y) internal pure returns (uint256 z)  // <= FOUND
```
['[141](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L141-L141)']
```solidity
141:     function sDivWad(int256 x, int256 y) internal pure returns (int256 z)  // <= FOUND
```
['[155](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L155-L155)']
```solidity
155:     function rawDivWad(uint256 x, uint256 y) internal pure returns (uint256 z)  // <= FOUND
```
['[184](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L184-L184)']
```solidity
184:     function rawDivWadUp(uint256 x, uint256 y) internal pure returns (uint256 z)  // <= FOUND
```
['[163](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L163-L163)']
```solidity
163:     function rawSDivWad(int256 x, int256 y) internal pure returns (int256 z)  // <= FOUND
```
['[194](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L194-L194)']
```solidity
194:     function powWad(int256 x, int256 y) internal pure returns (int256)  // <= FOUND
```
['[346](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L346-L346)']
```solidity
346:     function lambertW0Wad(int256 x) internal pure returns (int256 w)  // <= FOUND
```
['[526](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L526-L526)']
```solidity
526:     function fullMulDivUp(uint256 x, uint256 y, uint256 d) internal pure returns (uint256 result)  // <= FOUND
```
['[576](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L576-L576)']
```solidity
576:     function divUp(uint256 x, uint256 d) internal pure returns (uint256 z)  // <= FOUND
```
['[588](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L588-L588)']
```solidity
588:     function zeroFloorSub(uint256 x, uint256 y) internal pure returns (uint256 z)  // <= FOUND
```
['[596](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L596-L596)']
```solidity
596:     function ternary(bool condition, uint256 x, uint256 y) internal pure returns (uint256 result)  // <= FOUND
```
['[605](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L605-L605)']
```solidity
605:     function rpow(uint256 x, uint256 y, uint256 b) internal pure returns (uint256 z)  // <= FOUND
```
['[724](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L724-L724)']
```solidity
724:     function sqrtWad(uint256 x) internal pure returns (uint256 z)  // <= FOUND
```
['[739](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L739-L739)']
```solidity
739:     function cbrtWad(uint256 x) internal pure returns (uint256 z)  // <= FOUND
```
['[766](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L766-L766)']
```solidity
766:     function factorial(uint256 x) internal pure returns (uint256 result)  // <= FOUND
```
['[797](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L797-L797)']
```solidity
797:     function log2Up(uint256 x) internal pure returns (uint256 r)  // <= FOUND
```
['[832](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L832-L832)']
```solidity
832:     function log10Up(uint256 x) internal pure returns (uint256 r)  // <= FOUND
```
['[855](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L855-L855)']
```solidity
855:     function log256Up(uint256 x) internal pure returns (uint256 r)  // <= FOUND
```
['[910](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L910-L910)']
```solidity
910:     function packSci(uint256 x) internal pure returns (uint256 packed)  // <= FOUND
```
['[923](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L923-L923)']
```solidity
923:     function unpackSci(uint256 packed) internal pure returns (uint256 unpacked)  // <= FOUND
```
['[930](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L930-L930)']
```solidity
930:     function avg(uint256 x, uint256 y) internal pure returns (uint256 z)  // <= FOUND
```
['[937](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L937-L937)']
```solidity
937:     function avg(int256 x, int256 y) internal pure returns (int256 z)  // <= FOUND
```
['[944](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L944-L944)']
```solidity
944:     function abs(int256 x) internal pure returns (uint256 z)  // <= FOUND
```
['[952](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L952-L952)']
```solidity
952:     function dist(uint256 x, uint256 y) internal pure returns (uint256 z)  // <= FOUND
```
['[960](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L960-L960)']
```solidity
960:     function dist(int256 x, int256 y) internal pure returns (uint256 z)  // <= FOUND
```
['[1000](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L1000-L1000)']
```solidity
1000:     function clamp(uint256 x, uint256 minValue, uint256 maxValue) internal pure returns (uint256 z)  // <= FOUND
```
['[1009](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L1009-L1009)']
```solidity
1009:     function clamp(int256 x, int256 minValue, int256 maxValue) internal pure returns (int256 z)  // <= FOUND
```
['[1018](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L1018-L1018)']
```solidity
1018:     function gcd(uint256 x, uint256 y) internal pure returns (uint256 z)  // <= FOUND
```
['[1033](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L1033-L1033)']
```solidity
1033:     function lerp(uint256 a, uint256 b, uint256 t, uint256 begin, uint256 end) internal pure returns (uint256)  // <= FOUND
```
['[1051](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L1051-L1051)']
```solidity
1051:     function lerp(int256 a, int256 b, int256 t, int256 begin, int256 end) internal pure returns (int256)  // <= FOUND
```
['[1073](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L1073-L1073)']
```solidity
1073:     function rawAdd(uint256 x, uint256 y) internal pure returns (uint256 z)  // <= FOUND
```
['[1080](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L1080-L1080)']
```solidity
1080:     function rawAdd(int256 x, int256 y) internal pure returns (int256 z)  // <= FOUND
```
['[1147](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L1147-L1147)']
```solidity
1147:     function rawAddMod(uint256 x, uint256 y, uint256 d) internal pure returns (uint256 z)  // <= FOUND
```
['[1087](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L1087-L1087)']
```solidity
1087:     function rawSub(uint256 x, uint256 y) internal pure returns (uint256 z)  // <= FOUND
```
['[1094](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L1094-L1094)']
```solidity
1094:     function rawSub(int256 x, int256 y) internal pure returns (int256 z)  // <= FOUND
```
['[1101](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L1101-L1101)']
```solidity
1101:     function rawMul(uint256 x, uint256 y) internal pure returns (uint256 z)  // <= FOUND
```
['[1108](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L1108-L1108)']
```solidity
1108:     function rawMul(int256 x, int256 y) internal pure returns (int256 z)  // <= FOUND
```
['[1155](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L1155-L1155)']
```solidity
1155:     function rawMulMod(uint256 x, uint256 y, uint256 d) internal pure returns (uint256 z)  // <= FOUND
```
['[1115](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L1115-L1115)']
```solidity
1115:     function rawDiv(uint256 x, uint256 y) internal pure returns (uint256 z)  // <= FOUND
```
['[1123](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L1123-L1123)']
```solidity
1123:     function rawSDiv(int256 x, int256 y) internal pure returns (int256 z)  // <= FOUND
```
['[1131](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L1131-L1131)']
```solidity
1131:     function rawMod(uint256 x, uint256 y) internal pure returns (uint256 z)  // <= FOUND
```
['[1139](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L1139-L1139)']
```solidity
1139:     function rawSMod(int256 x, int256 y) internal pure returns (int256 z)  // <= FOUND
```


</details>

## [Gas-47] There are comparisons to boolean literals (true and false), these can be simplified to save gas

### Resolution 
In Solidity, gas optimization is crucial due to the cost associated with executing operations on the Ethereum network. Simplifying comparisons to boolean literals is one such optimization technique. Instead of explicitly comparing a boolean expression to true or false, you can use the expression directly or its negation. For example, replace if (x == true) with if (x) and if (x == false) with if (!x). This simplification reduces the bytecode size of the contract, thereby saving gas. It also enhances code readability and clarity.

Num of instances: 1

### Findings 


<details><summary>Click to show findings</summary>

['[343](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L343-L343)']
```solidity
343:         if (_nativeSend[0] == false) { // <= FOUND
```


</details>

## [Gas-48] Use OZ Array.unsafeAccess() to avoid repeated array length checks

### Resolution 
The OpenZeppelin Array.unsafeAccess() method is a optimization strategy for Solidity, aimed at reducing gas costs by bypassing automatic length checks on storage array accesses. In Solidity, every access to an array element involves a hidden gas cost due to a length check, ensuring that accesses do not exceed the array bounds. However, if a developer has already verified the array's bounds earlier in the function or knows through logic that the access is safe, directly accessing the array elements without redundant length checks can save gas. This approach requires careful consideration to avoid out-of-bounds errors, as it trades off safety checks for efficiency.

Num of instances: 26

### Findings 


<details><summary>Click to show findings</summary>

['[99](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruForwarder.sol#L99-L99)']
```solidity
99:             allowedInterface[_allowedInterfaces[i]] = true; // <= FOUND
```
['[113](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruForwarder.sol#L113-L113)']
```solidity
113:             allowedInterface[_allowedInterfaces[i]] = false; // <= FOUND
```
['[180](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L180-L180)']
```solidity
180:             _balance = balances[_accountKey(_msgSender(), _tokens[i])]; // <= FOUND
```
['[181](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L181-L181)']
```solidity
181:             balances[_accountKey(_msgSender(), _tokens[i])] = 0; // <= FOUND
```
['[183](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L183-L183)']
```solidity
183:                 if (_tokens[i] == NATIVE) { // <= FOUND
```
['[186](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L186-L186)']
```solidity
186:                     _tokens[i].safeTransfer(_msgSender(), _balance); // <= FOUND
```
['[454](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L454-L454)']
```solidity
454:             _cancelFlipOrder(_orderIds[i]); // <= FOUND
```
['[467](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L467-L467)']
```solidity
467:             _cancelOrder(_orderIds[i], true); // <= FOUND
```
['[481](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L481-L481)']
```solidity
481:             bool _isCanceled = _cancelOrder(_orderIds[i], false); // <= FOUND
```
['[483](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L483-L483)']
```solidity
483:                 _orderIdsCanceled[i] = _orderIds[i]; // <= FOUND
```
['[485](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L485-L485)']
```solidity
485:                 _orderIdsCanceled[i] = 0; // <= FOUND
```
['[638](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L638-L638)']
```solidity
638:             addPairedLiquidity(bidPrices[i], askPrices[i], bidSizes[i], askSizes[i]); // <= FOUND
```
['[663](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L663-L663)']
```solidity
663:                 addFlipBuyOrder(prices[i], flipPrices[i], sizes[i], _provisionOrRevert); // <= FOUND
```
['[665](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L665-L665)']
```solidity
665:                 addFlipSellOrder(prices[i], flipPrices[i], sizes[i], _provisionOrRevert); // <= FOUND
```
['[696](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L696-L696)']
```solidity
696:             bool _isCanceled = _cancelOrder(orderIdsToCancel[i], false); // <= FOUND
```
['[698](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L698-L698)']
```solidity
698:                 orderIdsCanceled[i] = orderIdsToCancel[i]; // <= FOUND
```
['[700](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L700-L700)']
```solidity
700:                 orderIdsCanceled[i] = 0; // <= FOUND
```
['[706](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L706-L706)']
```solidity
706:             addBuyOrder(buyPrices[i], buySizes[i], postOnly); // <= FOUND
```
['[711](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L711-L711)']
```solidity
711:             addSellOrder(sellPrices[i], sellSizes[i], postOnly); // <= FOUND
```
['[273](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L273-L273)']
```solidity
273:             IOrderBook(markets[i]).toggleMarket(state); // <= FOUND
```
['[283](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L283-L283)']
```solidity
283:             UUPSUpgradeable(proxies[i]).upgradeToAndCall(orderBookImplementation, data[i]); // <= FOUND
```
['[289](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L289-L289)']
```solidity
289:             UUPSUpgradeable(proxies[i]).upgradeToAndCall(kuruAmmVaultImplementation, data[i]); // <= FOUND
```
['[300](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L300-L300)']
```solidity
300:             Ownable(contracts[i]).transferOwnership(_newOwner); // <= FOUND
```
['[349](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L349-L349)']
```solidity
349:             address _currentMarket = _marketAddresses[i]; // <= FOUND
```
['[353](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L353-L353)']
```solidity
353:             uint256 _value = _nativeSend[i] ? _amount : 0; // <= FOUND
```
['[354](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L354-L354)']
```solidity
354:             _amountOut = _isBuy[i] // <= FOUND
355:                 ? (
356:                     market.placeAndExecuteMarketBuy{value: _value}(
357:                         toU96(_amount * _marketParams.pricePrecision / 10 ** _marketParams.quoteAssetDecimals),
358:                         0,
359:                         false,
360:                         true
361:                     )
362:                 )
363:                 : market.placeAndExecuteMarketSell{value: _value}(
364:                     toU96(_amount * _marketParams.sizePrecision / 10 ** _marketParams.baseAssetDecimals), 0, false, true
365:                 );
```


</details>

## [Gas-49] State variable written in a loop

### Resolution 
To optimize gas consumption in smart contracts, especially when dealing with loops that write to state variables, a recommended approach is to use a local (memory) variable within the loop for calculations and then update the state variable only once after the loop completes. This method reduces the number of state changes, each of which costs gas, thereby making the operation more gas-efficient.

Num of instances: 4

### Findings 


<details><summary>Click to show findings</summary>

['[348](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L348-L352)']
```solidity
348:         for (uint256 i = 0; i < _marketAddresses.length; i++) {
349:             address _currentMarket = _marketAddresses[i];
350:             MarketParams memory _marketParams = verifiedMarket[_currentMarket];
351:             require(_marketParams.pricePrecision > 0, RouterErrors.InvalidMarket());
352:             IOrderBook market = IOrderBook(_currentMarket); // <= FOUND
353:             uint256 _value = _nativeSend[i] ? _amount : 0;
354:             _amountOut = _isBuy[i]
355:                 ? (
356:                     market.placeAndExecuteMarketBuy{value: _value}(
357:                         toU96(_amount * _marketParams.pricePrecision / 10 ** _marketParams.quoteAssetDecimals),
358:                         0,
359:                         false,
360:                         true
361:                     )
362:                 )
363:                 : market.placeAndExecuteMarketSell{value: _value}(
364:                     toU96(_amount * _marketParams.sizePrecision / 10 ** _marketParams.baseAssetDecimals), 0, false, true
365:                 );
366: 
367:             _amount = _amountOut;
368:         }
```
['[199](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/AbstractAMM.sol#L199-L201)']
```solidity
199:         while (_price > _breakPoint && sizeLeft > 0) {
200:             if (_availableSize > sizeLeft) {
201:                 bidPartiallyFilledSize += sizeLeft; // <= FOUND
202:                 quoteOwedToUser += FixedPointMathLib.mulDiv(_price, sizeLeft, _getSizePrecision());
203:                 _emitTrade(0, kuruAmmVault, false, _price, _availableSize - sizeLeft, sizeLeft);
204:                 sizeLeft = 0;
205:                 break;
206:             }
```
['[73](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/AbstractAMM.sol#L73-L78)']
```solidity
73:         while (_price < _breakPoint && _quoteInput > 0) {
74:             uint256 _quoteNeededForFill = FixedPointMathLib.mulDivUp(_price, _availableSize, _getSizePrecision());
75:             if (_quoteNeededForFill > _quoteInput) {
76:                 uint96 _sizeFilledAtPrice = toU96(_quoteInput * _getSizePrecision() / _price);
77:                 sizeFilled += _sizeFilledAtPrice;
78:                 askPartiallyFilledSize += _sizeFilledAtPrice; // <= FOUND
79:                 _emitTrade(0, kuruAmmVault, true, _price, _availableSize - _sizeFilledAtPrice, _sizeFilledAtPrice);
80:                 _quoteInput = 0;
81:                 break;
82:             }
```
['[139](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/AbstractAMM.sol#L139-L141)']
```solidity
139:         while (_price < _breakPoint && sizeLeft > 0) {
140:             if (_availableSize > sizeLeft) {
141:                 askPartiallyFilledSize += sizeLeft; // <= FOUND
142:                 _consumedQuote += FixedPointMathLib.mulDivUp(sizeLeft, _price, _getSizePrecision());
143:                 _emitTrade(0, kuruAmmVault, true, _price, _availableSize - sizeLeft, sizeLeft);
144:                 sizeLeft = 0;
145:                 break;
146:             }
```


</details>

## [Gas-50] State variable read in a loop

### Resolution 
Reading a state variable inside a loop in a smart contract can unnecessarily increase gas consumption, as each read operation from the blockchain state is costly. This inefficiency becomes pronounced in loops with many iterations. To optimize gas usage, it's advisable to read the state variable once before the loop starts, store its value in a local (memory) variable, and then use this local variable within the loop. This approach minimizes the number of state read operations, thereby reducing the gas cost associated with executing the contract function, making the smart contract more efficient and cost-effective to run.

Num of instances: 15

### Findings 


<details><summary>Click to show findings</summary>

['[1014](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L1014-L1026)']
```solidity
1014:         while (_sizeToBeFilledLeft > 0 && _bestBid >= _limitPrice && _bestBid != type(uint256).max) {
1015:             uint96 _sizeToBeFilledBefore = _sizeToBeFilledLeft; 
1016: 
1017:             bytes memory priceUpdate;
1018: 
1019:             if (_isVaultFill) {
1020:                 uint256 _quoteToTaker;
1021:                 (_sizeToBeFilledLeft, _quoteToTaker, priceUpdate) =
1022:                     _fillVaultForSell(_getOBBid() >= _limitPrice ? _getOBBid() : _limitPrice - 1, _sizeToBeFilledLeft);
1023:                 quoteCreditVaultTaker += _quoteToTaker;
1024:             } else {
1025:                 (_sizeToBeFilledLeft, priceUpdate) = _fillSizeForPrice(
1026:                     s_buyTree, // <= FOUND
1027:                     toU32(_bestBid * _pricePrecision / vaultPricePrecision),
1028:                     s_buyPricePoints[_bestBid * _pricePrecision / vaultPricePrecision],
1029:                     _sizeToBeFilledLeft
1030:                 );
1031:                 quoteCreditTaker += toU96(
1032:                     FixedPointMathLib.mulDiv(
1033:                         _sizeToBeFilledBefore - _sizeToBeFilledLeft,
1034:                         toU32(_bestBid * _pricePrecision / vaultPricePrecision),
1035:                         sizePrecision
1036:                     )
1037:                 );
1038:             }
1039:             makerCredits = bytes.concat(makerCredits, priceUpdate);
1040: 
1041:             (_isVaultFill, _bestBid) = bestBid();
1042:         }
```
['[867](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L867-L878)']
```solidity
867:         while (_sizeToBeFilled > 0 && _bestAsk <= _limitPrice && _bestAsk != 0) {
868:             uint96 sizeToBeFilledBefore = _sizeToBeFilled; 
869:             bytes memory priceUpdate;
870: 
871:             if (_isVaultFill) {
872:                 uint96 _vaultFundsConsumed;
873:                 (_sizeToBeFilled, _vaultFundsConsumed, priceUpdate) =
874:                     _fillVaultForBuy(_getOBAsk() > _limitPrice ? _limitPrice + 1 : _getOBAsk(), _sizeToBeFilled);
875:                 fundsConsumed += _vaultFundsConsumed;
876:             } else {
877:                 (_sizeToBeFilled, priceUpdate) = _fillSizeForPrice(
878:                     s_sellTree, // <= FOUND
879:                     toU32(_bestAsk * _pricePrecision / vaultPricePrecision),
880:                     s_sellPricePoints[_bestAsk * _pricePrecision / vaultPricePrecision],
881:                     _sizeToBeFilled
882:                 );
883:             }
884: 
885:             uint96 sizeFilled = sizeToBeFilledBefore - _sizeToBeFilled;
886:             sizeToCreditTaker += sizeFilled;
887:             if (_isVaultFill) {
888:                 sizeToCreditViaVault += sizeFilled;
889:             } else {
890:                 fundsConsumed += _quoteAmountRoundedUp(
891:                     toU32(FixedPointMathLib.mulDivUp(_bestAsk, _pricePrecision, vaultPricePrecision)), sizeFilled
892:                 );
893:             }
894:             makerCredits = bytes.concat(makerCredits, priceUpdate);
895: 
896:             (_isVaultFill, _bestAsk) = bestAsk();
897:         }
```
['[939](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L939-L952)']
```solidity
939:         while (_quoteSize > 0 && _bestAsk != 0) {
940:             bytes memory priceUpdate;
941:             if (_isVaultFill) {
942:                 uint96 _sizeFilled;
943:                 (_quoteSize, _sizeFilled, priceUpdate) = _fillVaultBuyMatch(_getOBAsk(), _quoteSize);
944:                 sizeToCreditViaVault += _sizeFilled;
945:                 sizeToCreditTaker += _sizeFilled;
946:             } else {
947:                 
948:                 uint96 _sizeFillableAtPriceLeft =
949:                     toU96(_quoteSize * _sizePrecision * vaultPricePrecision / (_bestAsk * _pricePrecision));
950:                 uint96 _sizeFillableAtPriceBefore = _sizeFillableAtPriceLeft; 
951:                 (_sizeFillableAtPriceLeft, priceUpdate) = _fillSizeForPrice(
952:                     s_sellTree, // <= FOUND
953:                     toU32(_bestAsk * _pricePrecision / vaultPricePrecision),
954:                     s_sellPricePoints[(_bestAsk * _pricePrecision / vaultPricePrecision)],
955:                     _sizeFillableAtPriceLeft
956:                 );
957:                 sizeToCreditTaker += (_sizeFillableAtPriceBefore - _sizeFillableAtPriceLeft);
958:                 _quoteSize = toU96(
959:                     FixedPointMathLib.mulDiv(
960:                         _bestAsk * _pricePrecision, _sizeFillableAtPriceLeft, _sizePrecision * vaultPricePrecision
961:                     )
962:                 );
963:             }
964:             makerCredits = bytes.concat(makerCredits, priceUpdate);
965: 
966:             (_isVaultFill, _bestAsk) = bestAsk();
967:         }
```
['[73](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/AbstractAMM.sol#L73-L79)']
```solidity
73:         while (_price < _breakPoint && _quoteInput > 0) {
74:             uint256 _quoteNeededForFill = FixedPointMathLib.mulDivUp(_price, _availableSize, _getSizePrecision());
75:             if (_quoteNeededForFill > _quoteInput) {
76:                 uint96 _sizeFilledAtPrice = toU96(_quoteInput * _getSizePrecision() / _price);
77:                 sizeFilled += _sizeFilledAtPrice;
78:                 askPartiallyFilledSize += _sizeFilledAtPrice;
79:                 _emitTrade(0, kuruAmmVault, true, _price, _availableSize - _sizeFilledAtPrice, _sizeFilledAtPrice); // <= FOUND
80:                 _quoteInput = 0;
81:                 break;
82:             }
```
['[139](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/AbstractAMM.sol#L139-L143)']
```solidity
139:         while (_price < _breakPoint && sizeLeft > 0) {
140:             if (_availableSize > sizeLeft) {
141:                 askPartiallyFilledSize += sizeLeft;
142:                 _consumedQuote += FixedPointMathLib.mulDivUp(sizeLeft, _price, _getSizePrecision());
143:                 _emitTrade(0, kuruAmmVault, true, _price, _availableSize - sizeLeft, sizeLeft); // <= FOUND
144:                 sizeLeft = 0;
145:                 break;
146:             }
```
['[199](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/AbstractAMM.sol#L199-L203)']
```solidity
199:         while (_price > _breakPoint && sizeLeft > 0) {
200:             if (_availableSize > sizeLeft) {
201:                 bidPartiallyFilledSize += sizeLeft;
202:                 quoteOwedToUser += FixedPointMathLib.mulDiv(_price, sizeLeft, _getSizePrecision());
203:                 _emitTrade(0, kuruAmmVault, false, _price, _availableSize - sizeLeft, sizeLeft); // <= FOUND
204:                 sizeLeft = 0;
205:                 break;
206:             }
```
['[179](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L179-L183)']
```solidity
179:        for (uint256 i = 0; i < _tokens.length; i++) {
180:             _balance = balances[_accountKey(_msgSender(), _tokens[i])];
181:             balances[_accountKey(_msgSender(), _tokens[i])] = 0;
182:             if (_balance > 0) {
183:                 if (_tokens[i] == NATIVE) { // <= FOUND
184:                     _msgSender().safeTransferETH(_balance);
185:                 } else {
186:                     _tokens[i].safeTransfer(_msgSender(), _balance);
187:                 }
188:             }
189:         }
```
['[179](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L179-L183)']
```solidity
179:         for (uint256 i = 0; i < _tokens.length; i++) {
180:             _balance = balances[_accountKey(_msgSender(), _tokens[i])];
181:             balances[_accountKey(_msgSender(), _tokens[i])] = 0;
182:             if (_balance > 0) {
183:                 if (_tokens[i] == NATIVE) { // <= FOUND
184:                     _msgSender().safeTransferETH(_balance);
185:                 } else {
186:                     _tokens[i].safeTransfer(_msgSender(), _balance);
187:                 }
188:             }
189:         }
```
['[140](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L140-L148)']
```solidity
140:         while (offset < _encodedData.length) {
141:             (address _user, address _token, uint256 _amount, bool _useMargin) =
142:                 abi.decode(_encodedData[offset:offset + 128], (address, address, uint256, bool));
143:             offset += 128;
144: 
145:             if (_useMargin) {
146:                 balances[_accountKey(_user, _token)] += _amount;
147:             } else {
148:                 if (_token != NATIVE) { // <= FOUND
149:                     _token.safeTransfer(_user, _amount);
150:                 } else {
151:                     _user.safeTransferETH(_amount);
152:                 }
153:             }
154:         }
```
['[272](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L272-L272)']
```solidity
272:        for (uint256 i = 0; i < markets.length; i++) {
273:             IOrderBook(markets[i]).toggleMarket(state);
274:         }
```
['[272](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L272-L272)']
```solidity
272:         for (uint256 i = 0; i < markets.length; i++) {
273:             IOrderBook(markets[i]).toggleMarket(state);
274:         }
```
['[282](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L282-L282)']
```solidity
282:        for (uint256 i = 0; i < proxies.length; i++) {
283:             UUPSUpgradeable(proxies[i]).upgradeToAndCall(orderBookImplementation, data[i]);
284:         }
```
['[282](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L282-L282)']
```solidity
282:         for (uint256 i = 0; i < proxies.length; i++) {
283:             UUPSUpgradeable(proxies[i]).upgradeToAndCall(orderBookImplementation, data[i]);
284:         }
```
['[288](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L288-L288)']
```solidity
288:        for (uint256 i = 0; i < proxies.length; i++) {
289:             UUPSUpgradeable(proxies[i]).upgradeToAndCall(kuruAmmVaultImplementation, data[i]);
290:         }
```
['[288](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L288-L288)']
```solidity
288:         for (uint256 i = 0; i < proxies.length; i++) {
289:             UUPSUpgradeable(proxies[i]).upgradeToAndCall(kuruAmmVaultImplementation, data[i]);
290:         }
```


</details>

## [Gas-51] Use uint256(1)/uint256(2) instead of true/false to save gas for changes

### Resolution 
In Solidity, the use of `uint256` values instead of boolean for certain state variables can result in gas savings. This is due to how Ethereum's storage optimization works: changing a variable from `0` to a non-zero value (like flipping `false` to `true`) incurs a higher gas cost compared to modifying an already non-zero value. By using `uint256` with values `1` and `2` instead of `true` and `false`, you avoid the higher cost associated with the `0` to non-zero change, since `1` and `2` are both non-zero. This approach is notably used in OpenZeppelin's `ReentrancyGuard` as a gas optimization technique. However, this should be applied where it makes sense and where gas optimization is critical, as it can decrease code readability.

Num of instances: 5

### Findings 


<details><summary>Click to show findings</summary>

['[53](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L53-L53)']
```solidity
53:         guard = true; // <= FOUND
```
['[99](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruForwarder.sol#L99-L99)']
```solidity
99:             allowedInterface[_allowedInterfaces[i]] = true; // <= FOUND
```
['[265](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruForwarder.sol#L265-L265)']
```solidity
265:         executedPriceDependentRequest[keccak256(abi.encodePacked(req.from, req.nonce))] = true; // <= FOUND
```
['[93](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L93-L93)']
```solidity
93:         verifiedMarket[_marketAddress] = true; // <= FOUND
```
['[113](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruForwarder.sol#L113-L113)']
```solidity
113:             allowedInterface[_allowedInterfaces[i]] = false; // <= FOUND
```


</details>

## [Gas-52] Call msg.XYZ directly rather than caching the value to save gas

Num of instances: 1

### Findings 


<details><summary>Click to show findings</summary>

['[16](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/ERC2771Context.sol#L16-L16)']
```solidity
16:         uint256 calldataLength = msg.data.length; // <= FOUND
```


</details>

## [Gas-53] Consider pre-calculating the address of address(this) to save gas

### Resolution 
Consider saving the address(this) value within a constant using foundry's script.sol or solady's LibRlp.sol to save gas

Num of instances: 13

### Findings 


<details><summary>Click to show findings</summary>

['[150](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L150-L150)']
```solidity
150:         return (marginAccount.getBalance(address(this), token1), marginAccount.getBalance(address(this), token2)); // <= FOUND
```
['[224](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L224-L224)']
```solidity
224:             marginAccount.deposit{value: baseDeposit}(address(this), _token1, baseDeposit); // <= FOUND
```
['[226](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L226-L226)']
```solidity
226:             _token1.safeTransferFrom(msg.sender, address(this), baseDeposit); // <= FOUND
```
['[227](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L227-L227)']
```solidity
227:             marginAccount.deposit(address(this), _token1, baseDeposit); // <= FOUND
```
['[231](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L231-L231)']
```solidity
231:             marginAccount.deposit{value: quoteDeposit}(address(this), _token2, quoteDeposit); // <= FOUND
```
['[233](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L233-L233)']
```solidity
233:             _token2.safeTransferFrom(msg.sender, address(this), quoteDeposit); // <= FOUND
```
['[234](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L234-L234)']
```solidity
234:             marginAccount.deposit(address(this), _token2, quoteDeposit); // <= FOUND
```
['[206](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L206-L206)']
```solidity
206:             _token.safeTransferFrom(_msgSender(), address(this), _amount); // <= FOUND
```
['[70](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/periphery/MonadDeployer.sol#L70-L70)']
```solidity
70:         KuruERC20 token = new KuruERC20(tokenParams.name, tokenParams.symbol, tokenParams.initialSupply, address(this)); // <= FOUND
```
['[90](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/periphery/MonadDeployer.sol#L90-L91)']
```solidity
90:         IKuruAMMVault(vault).deposit{value: marketParams.nativeTokenAmount}(
91:             _supplyToVault, marketParams.nativeTokenAmount, address(this) // <= FOUND
92:         );
```
['[147](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L147-L148)']
```solidity
147:             IOrderBook(proxy).initialize(
148:                 address(this), // <= FOUND
149:                 _type,
150:                 _baseAssetAddress,
151:                 _baseAssetDecimals,
152:                 _quoteAssetAddress,
153:                 _quoteAssetDecimals,
154:                 marginAccountAddress,
155:                 _sizePrecision,
156:                 _pricePrecision,
157:                 _tickSize,
158:                 _minSize,
159:                 _maxSize,
160:                 _takerFeeBps,
161:                 _makerFeeBps,
162:                 address(_kuruAmmVault),
163:                 _kuruAmmSpread,
164:                 TRUSTED_FORWARDER
165:             );
```
['[168](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L168-L169)']
```solidity
168:         _kuruAmmVault.initialize(
169:             address(this), _baseAssetAddress, _quoteAssetAddress, marginAccountAddress, proxy, _kuruAmmSpread // <= FOUND
170:         );
```
['[344](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L344-L344)']
```solidity
344:             _debitToken.safeTransferFrom(msg.sender, address(this), _amount); // <= FOUND
```


</details>

## [Gas-54] Use 'storage' instead of 'memory' for struct/array state variables

### Resolution 
In Solidity, choosing between `memory` and `storage` for variables, especially when dealing with structs or arrays, is crucial for optimizing gas costs. Variables declared as `storage` are pointers to the blockchain data, leading to lower gas consumption when fields are accessed or modified, as they don't require reading the entire structure. In contrast, `memory` variables copy the entire struct or array from `storage`, incurring significant gas costs, especially for large or complex structures. Therefore, use `storage` for state variables or when working within functions to manipulate existing contract data. Reserve `memory` for temporary data or when data needs to be passed to external functions as copies, ensuring efficient use of gas and avoiding unnecessary costs.

Num of instances: 4

### Findings 


<details><summary>Click to show findings</summary>

['[393](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L393-L393)']
```solidity
393:         MarketParams memory _marketParams = marketParams; // <= FOUND
```
['[350](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L350-L350)']
```solidity
350:             MarketParams memory _marketParams = verifiedMarket[_currentMarket]; // <= FOUND
```
['[497](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L497-L497)']
```solidity
497:         Order memory _order = s_orders[_orderId]; // <= FOUND
```
['[1169](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L1169-L1169)']
```solidity
1169:             Order memory _filledOrder = s_orders[_orderId]; // <= FOUND
```


</details>

## [Gas-55] Empty blocks should be removed or emit something

### Resolution 
Empty code blocks (i.e., {}) in a Solidity contract can be harmful as they can lead to ambiguity, misinterpretation, and unintended behavior. When developers encounter empty code blocks, it may be unclear whether the absence of code is intentional or the result of an oversight. This uncertainty can cause confusion during development, testing, and debugging, increasing the likelihood of introducing errors or vulnerabilities. Moreover, empty code blocks may give a false impression of implemented functionality or security measures, creating a misleading sense of assurance. To ensure clarity and maintainability, it is essential to avoid empty code blocks and explicitly document the intended behavior or any intentional omissions.

Num of instances: 1

### Findings 


<details><summary>Click to show findings</summary>

['[13](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/ERC2771Context.sol#L13-L13)']
```solidity
13:     function isTrustedForwarder(address) public view virtual returns (bool) {}
```


</details>

## [Gas-56] Use constants instead of type(uint<n>).max

### Resolution 
In smart contract development, utilizing constants for known maximum or minimum values, rather than computing `type(uint<n>).max` or assuming `0` for `.min`, can significantly reduce gas costs. Constants require less runtime computation and storage, optimizing contract efficiency—a crucial strategy for developers aiming for cost-effective and performant code.

Num of instances: 43

### Findings 


<details><summary>Click to show findings</summary>

['[315](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/AbstractAMM.sol#L315-L315)']
```solidity
315:         if (vaultBestAsk == type(uint256).max) { // <= FOUND
```
['[63](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L63-L63)']
```solidity
63:             token1_.safeApprove(_marginAccount, type(uint256).max); // <= FOUND
```
['[66](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L66-L66)']
```solidity
66:             token2_.safeApprove(_marginAccount, type(uint256).max); // <= FOUND
```
['[726](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L726-L726)']
```solidity
726:             if (x <= type(uint256).max / 10 ** 18) return sqrt(x * 10 ** 18); // <= FOUND
```
['[741](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L741-L741)']
```solidity
741:             if (x <= type(uint256).max / 10 ** 36) return cbrt(x * 10 ** 36); // <= FOUND
```
['[32](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/TreeMath.sol#L32-L32)']
```solidity
32:         bytes32 newLeaves = leaves | bytes32(1 << (id & type(uint8).max)); // <= FOUND
```
['[41](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/TreeMath.sol#L41-L41)']
```solidity
41:                 tree.level2[key2] = leaves | bytes32(1 << (uint256(key3) & type(uint8).max)); // <= FOUND
```
['[47](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/TreeMath.sol#L47-L47)']
```solidity
47:                     tree.level1[key1] = leaves | bytes32(1 << (uint256(key2) & type(uint8).max)); // <= FOUND
```
['[50](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/TreeMath.sol#L50-L50)']
```solidity
50:                         tree.level0 |= bytes32(1 << (uint256(key1) & type(uint8).max)); // <= FOUND
```
['[72](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/TreeMath.sol#L72-L72)']
```solidity
72:         bytes32 newLeaves = leaves & ~bytes32(1 << (id & type(uint8).max)); // <= FOUND
```
['[79](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/TreeMath.sol#L79-L79)']
```solidity
79:                 newLeaves = tree.level2[key2] & ~bytes32(1 << (uint256(key3) & type(uint8).max)); // <= FOUND
```
['[85](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/TreeMath.sol#L85-L85)']
```solidity
85:                     newLeaves = tree.level1[key1] & ~bytes32(1 << (uint256(key2) & type(uint8).max)); // <= FOUND
```
['[90](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/TreeMath.sol#L90-L90)']
```solidity
90:                         tree.level0 &= ~bytes32(1 << (uint256(key1) & type(uint8).max)); // <= FOUND
```
['[112](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/TreeMath.sol#L112-L112)']
```solidity
112:         uint8 bit = uint8(id & type(uint8).max); // <= FOUND
```
['[118](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/TreeMath.sol#L118-L118)']
```solidity
118:             if (closestBit != type(uint256).max) return uint32((uint256(key3) << 8) | closestBit); // <= FOUND
```
['[122](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/TreeMath.sol#L122-L122)']
```solidity
122:         bit = uint8(uint256(key3) & type(uint8).max); // <= FOUND
```
['[128](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/TreeMath.sol#L128-L128)']
```solidity
128:             if (closestBit != type(uint256).max) { // <= FOUND
```
['[137](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/TreeMath.sol#L137-L137)']
```solidity
137:         bit = uint8(uint256(key2) & type(uint8).max); // <= FOUND
```
['[154](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/TreeMath.sol#L154-L154)']
```solidity
154:         bit = uint8(uint256(key1) & type(uint8).max); // <= FOUND
```
['[174](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/TreeMath.sol#L174-L174)']
```solidity
174:         return type(uint32).max; // <= FOUND
```
['[190](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/TreeMath.sol#L190-L190)']
```solidity
190:         if (bit != type(uint8).max) { // <= FOUND
```
['[129](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L129-L129)']
```solidity
129:         vaultBestAsk = type(uint256).max; // <= FOUND
```
['[170](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L170-L170)']
```solidity
170:         require(_price > 0 && _price < type(uint32).max, OrderBookErrors.PriceError()); // <= FOUND
```
['[210](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L210-L210)']
```solidity
210:         require(_price > 0 && _flippedPrice > 0 && _flippedPrice < type(uint32).max, OrderBookErrors.PriceError()); // <= FOUND
```
['[280](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L280-L280)']
```solidity
280:         require(_price > 0 && _flippedPrice > 0 && _price < type(uint32).max, OrderBookErrors.PriceError()); // <= FOUND
```
['[287](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L287-L287)']
```solidity
287:             if ((uint256(_price) * vaultPricePrecision / pricePrecision) <= _bestBid && _bestBid != type(uint256).max) { // <= FOUND
```
['[316](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L316-L316)']
```solidity
316:         require(_bidPrice > 0 && _askPrice > _bidPrice && _askPrice < type(uint32).max, OrderBookErrors.PriceError()); // <= FOUND
```
['[329](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L329-L329)']
```solidity
329:                     || (_bestBid == type(uint256).max), // <= FOUND
```
['[1014](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L1014-L1014)']
```solidity
1014:         while (_sizeToBeFilledLeft > 0 && _bestBid >= _limitPrice && _bestBid != type(uint256).max) { // <= FOUND
```
['[1342](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L1342-L1342)']
```solidity
1342:         return type(uint256).max; // <= FOUND
```
['[1346](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L1346-L1346)']
```solidity
1346:         uint32 firstRight = TreeMath.findFirstRight(s_buyTree, type(uint32).max); // <= FOUND
```
['[1347](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L1347-L1347)']
```solidity
1347:         if (firstRight != type(uint32).max) { // <= FOUND
```
['[1356](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L1356-L1356)']
```solidity
1356:             if (vaultBestAsk != type(uint256).max) { // <= FOUND
```
['[1366](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L1366-L1366)']
```solidity
1366:         return (vaultBestAsk != type(uint256).max) ? (true, vaultBestAsk) : (false, 0); // <= FOUND
```
['[1370](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L1370-L1370)']
```solidity
1370:         uint256 firstRight = TreeMath.findFirstRight(s_buyTree, type(uint32).max) * vaultPricePrecision / pricePrecision; // <= FOUND
```
['[1371](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L1371-L1371)']
```solidity
1371:         if (firstRight != type(uint32).max * vaultPricePrecision / pricePrecision) { // <= FOUND
```
['[1382](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L1382-L1382)']
```solidity
1382:         return vaultBestBid != 0 ? (true, vaultBestBid) : (false, type(uint256).max); // <= FOUND
```
['[1391](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L1391-L1391)']
```solidity
1391:         return getL2Book(type(uint32).max, type(uint32).max); // <= FOUND
```
['[1412](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L1412-L1412)']
```solidity
1412:         uint32 price = TreeMath.findFirstRight(s_buyTree, type(uint32).max); // <= FOUND
```
['[1413](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L1413-L1413)']
```solidity
1413:         while (price != type(uint32).max && price != 0 && _bidPricePoints != 0) { // <= FOUND
```
['[1458](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L1458-L1458)']
```solidity
1458:         while (price != type(uint32).max && price != 0 && _askPricePoints != 0) { // <= FOUND
```
['[311](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L311-L311)']
```solidity
311:             _quoteAsset.safeApprove(_marketAddress, type(uint256).max); // <= FOUND
```
['[313](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L313-L313)']
```solidity
313:             _baseAsset.safeApprove(_marketAddress, type(uint256).max); // <= FOUND
```


</details>

## [Gas-57] Using named returns for pure and view functions is cheaper than using regular returns

Num of instances: 62

### Findings 


<details><summary>Click to show findings</summary>

['[275](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/AbstractAMM.sol#L275-L280)']
```solidity
275:     function getVaultParams()
276:         external
277:         view
278:         returns (address, uint256, uint96, uint256, uint96, uint96, uint96, uint96)
279:     {
280:         return ( // <= FOUND
281:             kuruAmmVault,
282:             vaultBestBid,
283:             bidPartiallyFilledSize,
284:             vaultBestAsk,
285:             askPartiallyFilledSize,
286:             vaultBidOrderSize,
287:             vaultAskOrderSize,
288:             SPREAD_CONSTANT
289:         );
290:     }
```
['[97](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L97-L98)']
```solidity
97:     function name() public view virtual override returns (string memory) {
98:         return _name; // <= FOUND
99:     }
```
['[101](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L101-L102)']
```solidity
101:     function symbol() public view virtual override returns (string memory) {
102:         return _name; // <= FOUND
103:     }
```
['[127](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L127-L129)']
```solidity
127:     function previewDeposit(uint256 asset1, uint256 asset2) public view virtual returns (uint256) {
128:         (, uint256 _price) = _returnNormalizedAmountAndPrice(true);
129:         return _convertToShares(asset1, asset2, _price); // <= FOUND
130:     }
```
['[135](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L135-L136)']
```solidity
135:     function previewMint(uint256 shares) public view virtual returns (uint256, uint256) {
136:         return _convertToAssets(shares, true); // <= FOUND
137:     }
```
['[142](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L142-L143)']
```solidity
142:     function previewWithdraw(uint256 shares) public view virtual returns (uint256, uint256) {
143:         return _convertToAssets(shares, false); // <= FOUND
144:     }
```
['[149](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L149-L150)']
```solidity
149:     function totalAssets() public view returns (uint256, uint256) {
150:         return (marginAccount.getBalance(address(this), token1), marginAccount.getBalance(address(this), token2)); // <= FOUND
151:     }
```
['[316](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L316-L331)']
```solidity
316:     function _returnNormalizedAmountAndPrice(bool roundUp) internal view returns (uint256, uint256) {
317:         
318:         
319:         uint96 _normalizedBaseAmount = roundUp
320:             ? toU96(
321:                 FixedPointMathLib.mulDivUp(
322:                     market.vaultAskOrderSize(), DOUBLE_BPS_MULTIPLIER + SPREAD_CONSTANT, SPREAD_CONSTANT
323:                 )
324:             )
325:             : toU96(
326:                 FixedPointMathLib.mulDiv(
327:                     market.vaultAskOrderSize(), DOUBLE_BPS_MULTIPLIER + SPREAD_CONSTANT, SPREAD_CONSTANT
328:                 )
329:             );
330:         uint256 _price = market.vaultBestAsk();
331:         return ((_normalizedBaseAmount * 10 ** marketParams.baseAssetDecimals) / marketParams.sizePrecision, _price); // <= FOUND
332:     }
```
['[337](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L337-L344)']
```solidity
337:     function _convertToShares(uint256 baseAmount, uint256 quoteAmount, uint256 _currentAskPrice)
338:         internal
339:         view
340:         returns (uint256)
341:     {
342:         (uint256 _reserve1, uint256 _reserve2) = totalAssets();
343:         (_reserve1, _reserve2) = _returnVirtuallyRebalancedTotalAssets(_reserve1, _reserve2, _currentAskPrice);
344:         return FixedPointMathLib.min( // <= FOUND
345:             FixedPointMathLib.mulDiv(baseAmount, totalSupply(), _reserve1),
346:             FixedPointMathLib.mulDiv(quoteAmount, totalSupply(), _reserve2)
347:         );
348:     }
```
['[350](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L350-L370)']
```solidity
350:     function _convertToAssets(uint256 shares, bool isDeposit)
351:         internal
352:         view
353:         returns (uint256 _baseAmount, uint256 _quoteAmount)
354:     {
355:         if (isDeposit) {
356:             if (totalSupply() == 0) {
357:                 return (0, 0); // <= FOUND
358:             }
359:             (uint256 _baseReserve, uint256 _quoteReserve) = totalAssets();
360:             (, uint256 _currentAskPrice) = _returnNormalizedAmountAndPrice(true);
361:             (_baseReserve, _quoteReserve) =
362:                 _returnVirtuallyRebalancedTotalAssets(_baseReserve, _quoteReserve, _currentAskPrice);
363:             _baseAmount = FixedPointMathLib.mulDiv(shares, _baseReserve, totalSupply());
364:             _quoteAmount = (
365:                 (
366:                     FixedPointMathLib.mulDivUp(_baseAmount, _currentAskPrice, vaultPricePrecision)
367:                         * 10 ** marketParams.quoteAssetDecimals
368:                 )
369:             ) / 10 ** marketParams.baseAssetDecimals;
370:             return (_baseAmount, _quoteAmount); // <= FOUND
371:         } else {
372:             (_baseAmount, _quoteAmount,,,) = _convertToAssetsWithNewSize(shares);
373:         }
374:     }
```
['[376](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L376-L427)']
```solidity
376:     function _convertToAssetsWithNewSize(uint256 shares)
377:         internal
378:         view
379:         returns (uint256, uint256, uint96, uint96, bool)
380:     {
381:         (uint256 _baseAmount,) = _returnNormalizedAmountAndPrice(false);
382:         uint256 _baseAmountAfterRemoval = _baseAmount - FixedPointMathLib.mulDiv(shares, _baseAmount, totalSupply());
383:         (uint96 _newAskSize, uint96 _newBidSize) = _getVaultSizesForBaseAmount(_baseAmountAfterRemoval);
384:         (
385:             ,
386:             uint256 _vaultBestBid,
387:             uint96 _partiallyFilledBidSize,
388:             uint256 _vaultBestAsk,
389:             uint96 _partiallyFilledAskSize,
390:             ,
391:             ,
392:         ) = market.getVaultParams();
393:         MarketParams memory _marketParams = marketParams;
394:         (uint256 _reserveBase, uint256 _reserveQuote) = totalAssets();
395:         if (_partiallyFilledAskSize > _newAskSize || _partiallyFilledBidSize > _newBidSize) {
396:             int256 _baseOwedToVault = (
397:                 int256(uint256(_partiallyFilledAskSize)) - int256(uint256(_partiallyFilledBidSize))
398:             ) * int256(10 ** _marketParams.baseAssetDecimals) / int256(uint256(_marketParams.sizePrecision));
399:             int256 _quoteOwedToVault = (
400:                 int256(FixedPointMathLib.mulDivUp(_partiallyFilledBidSize, _vaultBestBid, _marketParams.sizePrecision))
401:                     - int256(FixedPointMathLib.mulDiv(_partiallyFilledAskSize, _vaultBestAsk, _marketParams.sizePrecision))
402:             ) * int256(10 ** _marketParams.quoteAssetDecimals) / int256(vaultPricePrecision);
403:             uint256 _baseOwedToUser;
404:             uint256 _quoteOwedToUser;
405:             if (_baseOwedToVault < 0) {
406:                 _reserveBase = _reserveBase - (uint256(-1 * _baseOwedToVault));
407:                 _baseOwedToUser =
408:                     FixedPointMathLib.mulDiv(shares, _reserveBase, totalSupply()) + uint256(-1 * _baseOwedToVault);
409:             } else {
410:                 _reserveBase = _reserveBase + (uint256(_baseOwedToVault));
411:                 _baseOwedToUser =
412:                     FixedPointMathLib.mulDiv(shares, _reserveBase, totalSupply()) - uint256(_baseOwedToVault);
413:             }
414:             if (_quoteOwedToVault < 0) {
415:                 _reserveQuote = _reserveQuote - (uint256(-1 * _quoteOwedToVault));
416:                 _quoteOwedToUser =
417:                     FixedPointMathLib.mulDiv(shares, _reserveQuote, totalSupply()) + uint256(-1 * _quoteOwedToVault);
418:             } else {
419:                 _reserveQuote = _reserveQuote + (uint256(_quoteOwedToVault));
420:                 _quoteOwedToUser =
421:                     FixedPointMathLib.mulDiv(shares, _reserveQuote, totalSupply()) - uint256(_quoteOwedToVault);
422:             }
423:             return (_baseOwedToUser, _quoteOwedToUser, _newAskSize, _newBidSize, true); // <= FOUND
424:         } else {
425:             uint256 _baseOwedToUser = FixedPointMathLib.mulDiv(shares, _reserveBase, totalSupply());
426:             uint256 _quoteOwedToUser = FixedPointMathLib.mulDiv(shares, _reserveQuote, totalSupply());
427:             return (_baseOwedToUser, _quoteOwedToUser, _newAskSize, _newBidSize, false); // <= FOUND
428:         }
429:     }
```
['[431](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L431-L441)']
```solidity
431:     function _getVaultSizesForBaseAmount(uint256 _baseAmount) internal view returns (uint96, uint96) {
432:         MarketParams memory _marketParams = marketParams;
433:         uint96 _newAskSize = toU96(
434:             (SPREAD_CONSTANT * _baseAmount * _marketParams.sizePrecision)
435:                 / ((DOUBLE_BPS_MULTIPLIER + SPREAD_CONSTANT) * 10 ** _marketParams.baseAssetDecimals)
436:         );
437:         uint96 _newBidSize = toU96(
438:             (SPREAD_CONSTANT * _baseAmount * _marketParams.sizePrecision)
439:                 / (DOUBLE_BPS_MULTIPLIER * 10 ** _marketParams.baseAssetDecimals)
440:         );
441:         return (_newAskSize, _newBidSize); // <= FOUND
442:     }
```
['[444](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruAMMVault.sol#L444-L457)']
```solidity
444:     function _returnVirtuallyRebalancedTotalAssets(uint256 _reserve1, uint256 _reserve2, uint256 _vaultPrice)
445:         internal
446:         view
447:         returns (uint256, uint256)
448:     {
449:         MarketParams memory _marketParams = marketParams;
450:         uint256 _halfTotalValuationInQuote = (
451:             (_reserve1 * _vaultPrice * 10 ** _marketParams.quoteAssetDecimals)
452:                 / (10 ** _marketParams.baseAssetDecimals * vaultPricePrecision) + _reserve2
453:         ) / 2;
454:         uint256 _rebalancedBaseAsset = (
455:             _halfTotalValuationInQuote * vaultPricePrecision * 10 ** _marketParams.baseAssetDecimals
456:         ) / (10 ** _marketParams.quoteAssetDecimals * _vaultPrice);
457:         return (_rebalancedBaseAsset, _halfTotalValuationInQuote); // <= FOUND
458:     }
```
['[126](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruForwarder.sol#L126-L127)']
```solidity
126:     function getNonce(address from) public view returns (uint256) {
127:         return _nonces[from]; // <= FOUND
128:     }
```
['[130](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruForwarder.sol#L130-L146)']
```solidity
130:     function verify(ForwardRequest calldata req, bytes calldata signature) public view returns (bool) {
131:         require(block.timestamp <= req.deadline, DeadlineExpired());
132:         address signer = _hashTypedData(
133:             keccak256(
134:                 abi.encode(
135:                     _FORWARD_TYPEHASH,
136:                     req.from,
137:                     req.market,
138:                     req.value,
139:                     req.nonce,
140:                     req.deadline,
141:                     req.selector,
142:                     keccak256(req.data)
143:                 )
144:             )
145:         ).recoverCalldata(signature);
146:         return req.nonce >= _nonces[req.from] && signer == req.from; // <= FOUND
147:     }
```
['[151](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruForwarder.sol#L151-L177)']
```solidity
151:     function verifyPriceDependent(PriceDependentRequest calldata req, bytes calldata signature)
152:         public
153:         view
154:         returns (bool)
155:     {
156:         require(block.timestamp <= req.deadline, DeadlineExpired());
157:         address signer = _hashTypedData(
158:             keccak256(
159:                 abi.encode(
160:                     _PRICE_DEPENDENT_TYPEHASH,
161:                     req.from,
162:                     req.market,
163:                     req.price,
164:                     req.value,
165:                     req.nonce,
166:                     req.deadline,
167:                     req.isBelowPrice,
168:                     req.selector,
169:                     keccak256(req.data)
170:                 )
171:             )
172:         ).recoverCalldata(signature);
173:         require(
174:             !executedPriceDependentRequest[keccak256(abi.encodePacked(req.from, req.nonce))],
175:             KuruForwarderErrors.NonceAlreadyUsed()
176:         );
177:         return signer == req.from; // <= FOUND
178:     }
```
['[180](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruForwarder.sol#L180-L193)']
```solidity
180:     function verifyCancelPriceDependent(CancelPriceDependentRequest calldata req, bytes calldata signature)
181:         public
182:         view
183:         returns (bool)
184:     {
185:         require(block.timestamp <= req.deadline, DeadlineExpired());
186:         address signer = _hashTypedData(
187:             keccak256(abi.encode(_CANCEL_PRICE_DEPENDENT_TYPEHASH, req.from, req.nonce, req.deadline))
188:         ).recoverCalldata(signature);
189:         require(
190:             !executedPriceDependentRequest[keccak256(abi.encodePacked(req.from, req.nonce))],
191:             KuruForwarderErrors.NonceAlreadyUsed()
192:         );
193:         return signer == req.from; // <= FOUND
194:     }
```
['[196](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruForwarder.sol#L196-L216)']
```solidity
196:     function verifyMarginAccountRequest(MarginAccountRequest calldata req, bytes calldata signature)
197:         public
198:         view
199:         returns (bool)
200:     {
201:         require(block.timestamp <= req.deadline, DeadlineExpired());
202:         address signer = _hashTypedData(
203:             keccak256(
204:                 abi.encode(
205:                     _MARGIN_ACCOUNT_REQUEST_TYPEHASH,
206:                     req.from,
207:                     req.marginAccount,
208:                     req.value,
209:                     req.nonce,
210:                     req.deadline,
211:                     req.selector,
212:                     keccak256(req.data)
213:                 )
214:             )
215:         ).recoverCalldata(signature);
216:         return req.nonce >= _nonces[req.from] && signer == req.from; // <= FOUND
217:     }
```
['[15](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/ERC2771Context.sol#L15-L21)']
```solidity
15:     function _msgData() internal view returns (bytes calldata) {
16:         uint256 calldataLength = msg.data.length;
17:         uint256 contextSuffixLength = _contextSuffixLength();
18:         if (isTrustedForwarder(msg.sender) && calldataLength >= contextSuffixLength) {
19:             return msg.data[:calldataLength - contextSuffixLength]; // <= FOUND
20:         } else {
21:             return msg.data; // <= FOUND
22:         }
23:     }
```
['[25](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/ERC2771Context.sol#L25-L31)']
```solidity
25:     function _msgSender() internal view returns (address) {
26:         uint256 calldataLength = msg.data.length;
27:         uint256 contextSuffixLength = _contextSuffixLength();
28:         if (isTrustedForwarder(msg.sender) && calldataLength >= contextSuffixLength) {
29:             return address(bytes20(msg.data[calldataLength - contextSuffixLength:])); // <= FOUND
30:         } else {
31:             return msg.sender; // <= FOUND
32:         }
33:     }
```
['[108](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/TreeMath.sol#L108-L174)']
```solidity
108:     function findFirstRight(TreeUint32 storage tree, uint32 id) internal view returns (uint32) {
109:         bytes32 leaves;
110: 
111:         bytes32 key3 = bytes32(uint256(id) >> 8);
112:         uint8 bit = uint8(id & type(uint8).max);
113: 
114:         if (bit != 0) {
115:             leaves = tree.level3[key3];
116:             uint256 closestBit = _closestBitRight(leaves, bit);
117: 
118:             if (closestBit != type(uint256).max) return uint32((uint256(key3) << 8) | closestBit); // <= FOUND
119:         }
120: 
121:         bytes32 key2 = key3 >> 8;
122:         bit = uint8(uint256(key3) & type(uint8).max);
123: 
124:         if (bit != 0) {
125:             leaves = tree.level2[key2];
126:             uint256 closestBit = _closestBitRight(leaves, bit);
127: 
128:             if (closestBit != type(uint256).max) {
129:                 key3 = bytes32((uint256(key2) << 8) | closestBit);
130:                 leaves = tree.level3[key3];
131: 
132:                 return uint32((uint256(key3) << 8) | uint256(leaves).mostSignificantBit()); // <= FOUND
133:             }
134:         }
135: 
136:         bytes32 key1 = key2 >> 8;
137:         bit = uint8(uint256(key2) & type(uint8).max);
138: 
139:         if (bit != 0) {
140:             leaves = tree.level1[key1];
141:             uint256 closestBit = _closestBitRight(leaves, bit);
142: 
143:             if (closestBit != type(uint256).max) {
144:                 key2 = bytes32((uint256(key1) << 8) | closestBit);
145:                 leaves = tree.level2[key2];
146: 
147:                 key3 = bytes32((uint256(key2) << 8) | uint256(leaves).mostSignificantBit());
148:                 leaves = tree.level3[key3];
149: 
150:                 return uint32((uint256(key3) << 8) | uint256(leaves).mostSignificantBit()); // <= FOUND
151:             }
152:         }
153: 
154:         bit = uint8(uint256(key1) & type(uint8).max);
155: 
156:         if (bit != 0) {
157:             leaves = tree.level0;
158:             uint256 closestBit = _closestBitRight(leaves, bit);
159: 
160:             if (closestBit != type(uint256).max) {
161:                 key1 = bytes32(closestBit);
162:                 leaves = tree.level1[key1];
163: 
164:                 key2 = bytes32((uint256(key1) << 8) | uint256(leaves).mostSignificantBit());
165:                 leaves = tree.level2[key2];
166: 
167:                 key3 = bytes32((uint256(key2) << 8) | uint256(leaves).mostSignificantBit());
168:                 leaves = tree.level3[key3];
169: 
170:                 return uint32((uint256(key3) << 8) | uint256(leaves).mostSignificantBit()); // <= FOUND
171:             }
172:         }
173: 
174:         return type(uint32).max; // <= FOUND
175:     }
```
['[184](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/TreeMath.sol#L184-L250)']
```solidity
184:     function findFirstLeft(TreeUint32 storage tree, uint32 id) internal view returns (uint32) {
185:         bytes32 leaves;
186: 
187:         bytes32 key3 = bytes32(uint256(id) >> 8);
188:         uint8 bit = uint8(id & type(uint8).max);
189: 
190:         if (bit != type(uint8).max) {
191:             leaves = tree.level3[key3];
192:             uint256 closestBit = _closestBitLeft(leaves, bit);
193: 
194:             if (closestBit != type(uint256).max) return uint32((uint256(key3) << 8) | closestBit); // <= FOUND
195:         }
196: 
197:         bytes32 key2 = key3 >> 8;
198:         bit = uint8(uint256(key3) & type(uint8).max);
199: 
200:         if (bit != type(uint8).max) {
201:             leaves = tree.level2[key2];
202:             uint256 closestBit = _closestBitLeft(leaves, bit);
203: 
204:             if (closestBit != type(uint256).max) {
205:                 key3 = bytes32((uint256(key2) << 8) | closestBit);
206:                 leaves = tree.level3[key3];
207: 
208:                 return uint32((uint256(key3) << 8) | uint256(leaves).leastSignificantBit()); // <= FOUND
209:             }
210:         }
211: 
212:         bytes32 key1 = key2 >> 8;
213:         bit = uint8(uint256(key2) & type(uint8).max);
214: 
215:         if (bit != type(uint8).max) {
216:             leaves = tree.level1[key1];
217:             uint256 closestBit = _closestBitLeft(leaves, bit);
218: 
219:             if (closestBit != type(uint256).max) {
220:                 key2 = bytes32((uint256(key1) << 8) | closestBit);
221:                 leaves = tree.level2[key2];
222: 
223:                 key3 = bytes32((uint256(key2) << 8) | uint256(leaves).leastSignificantBit());
224:                 leaves = tree.level3[key3];
225: 
226:                 return uint32((uint256(key3) << 8) | uint256(leaves).leastSignificantBit()); // <= FOUND
227:             }
228:         }
229: 
230:         bit = uint8(uint256(key1) & type(uint8).max);
231: 
232:         if (bit != type(uint8).max) {
233:             leaves = tree.level0;
234:             uint256 closestBit = _closestBitLeft(leaves, bit);
235: 
236:             if (closestBit != type(uint256).max) {
237:                 key1 = bytes32(closestBit);
238:                 leaves = tree.level1[key1];
239: 
240:                 key2 = bytes32((uint256(key1) << 8) | uint256(leaves).leastSignificantBit());
241:                 leaves = tree.level2[key2];
242: 
243:                 key3 = bytes32((uint256(key2) << 8) | uint256(leaves).leastSignificantBit());
244:                 leaves = tree.level3[key3];
245: 
246:                 return uint32((uint256(key3) << 8) | uint256(leaves).leastSignificantBit()); // <= FOUND
247:             }
248:         }
249: 
250:         return 0; // <= FOUND
251:     }
```
['[70](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L70-L71)']
```solidity
70:     function isTrustedForwarder(address forwarder) public view override returns (bool) {
71:         return forwarder == trustedForwarder; // <= FOUND
72:     }
```
['[234](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L234-L235)']
```solidity
234:     function getBalance(address _user, address _token) external view returns (uint256) {
235:         return balances[_accountKey(_user, _token)]; // <= FOUND
236:     }
```
['[74](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L74-L75)']
```solidity
74:     function isTrustedForwarder(address forwarder) public view virtual override returns (bool) {
75:         return forwarder == _trustedForwarder; // <= FOUND
76:     }
```
['[586](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L586-L615)']
```solidity
586:     function _checkIfCancelledOrFilled(uint40 _orderId, Order memory _order) internal view returns (bool) {
587:         if (_order.prev != OrderLinkedList.NULL) {
588:             if (s_orders[_order.prev].next != _orderId) {
589:                 return true; // <= FOUND
590:             }
591:             if (_order.isBuy) {
592:                 
593:                 uint40 _head = s_buyPricePoints[_order.price].head;
594:                 if (_head > _orderId || _head == OrderLinkedList.NULL) {
595:                     return true; // <= FOUND
596:                 }
597:                 return false; // <= FOUND
598:             } else {
599:                 uint40 _head = s_sellPricePoints[_order.price].head;
600:                 if (_head > _orderId || _head == OrderLinkedList.NULL) {
601:                     return true; // <= FOUND
602:                 }
603:                 return false; // <= FOUND
604:             }
605:         } else {
606:             if (_order.isBuy) {
607:                 if (s_buyPricePoints[_order.price].head != _orderId) {
608:                     return true; // <= FOUND
609:                 }
610:                 return false; // <= FOUND
611:             } else {
612:                 if (s_sellPricePoints[_order.price].head != _orderId) {
613:                     return true; // <= FOUND
614:                 }
615:                 return false; // <= FOUND
616:             }
617:         }
618:     }
```
['[835](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L835-L836)']
```solidity
835:     function _pricePrecisionToQuoteAssetPrecision(uint96 _quote) internal view returns (uint256) {
836:         return (uint256(_quote) * quoteDecimalMultiplier) / pricePrecision; // <= FOUND
837:     }
```
['[839](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L839-L840)']
```solidity
839:     function _sizePrecisionToBaseAssetPrecision(uint96 _size) internal view returns (uint256) {
840:         return (uint256(_size) * baseDecimalMultiplier) / sizePrecision; // <= FOUND
841:     }
```
['[1225](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L1225-L1227)']
```solidity
1225:     function _quoteAmountRoundedUp(uint32 _price, uint96 _size) internal view returns (uint96) {
1226:         uint256 _result = FixedPointMathLib.mulDivUp(_price, _size, sizePrecision);
1227:         return toU96(_result); // <= FOUND
1228:     }
```
['[1238](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L1238-L1261)']
```solidity
1238:     function _creditMaker(bool _isMarketBuy, address _ownerAddress, uint96 _size, uint32 _price)
1239:         internal
1240:         view
1241:         returns (bytes memory)
1242:     {
1243:         address creditAsset = _isMarketBuy ? quoteAsset : baseAsset;
1244:         uint256 amount =
1245:             _isMarketBuy ? _quoteAmountRoundedDown(_size, _price) : ((_size * baseDecimalMultiplier) / sizePrecision);
1246:         uint256 feeRebate;
1247:         address feeAsset;
1248:         bytes memory returnData;
1249:         if (_isMarketBuy) {
1250:             feeAsset = baseAsset;
1251:             feeRebate = (((_size * baseDecimalMultiplier) / sizePrecision) * makerFeeBps) / BPS_MULTIPLIER;
1252:         } else {
1253:             feeAsset = quoteAsset;
1254:             feeRebate = (_quoteAmountRoundedDown(_size, _price) * makerFeeBps) / BPS_MULTIPLIER;
1255:         }
1256:         
1257:         if (feeRebate > 0) {
1258:             returnData = abi.encode(_ownerAddress, feeAsset, feeRebate, true);
1259:         }
1260: 
1261:         return bytes.concat(returnData, abi.encode(_ownerAddress, creditAsset, amount, true)); // <= FOUND
1262:     }
```
['[1269](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L1269-L1270)']
```solidity
1269:     function _quoteAmountRoundedDown(uint256 _size, uint32 _price) internal view returns (uint256) {
1270:         return ((_price * _size) / sizePrecision) * quoteDecimalMultiplier / pricePrecision; // <= FOUND
1271:     }
```
['[1273](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L1273-L1274)']
```solidity
1273:     function _getPricePrecision() internal view override returns (uint32) {
1274:         return pricePrecision; // <= FOUND
1275:     }
```
['[1277](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L1277-L1278)']
```solidity
1277:     function _getSizePrecision() internal view override returns (uint96) {
1278:         return sizePrecision; // <= FOUND
1279:     }
```
['[1281](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L1281-L1282)']
```solidity
1281:     function _getTakerFeeBps() internal view override returns (uint256) {
1282:         return takerFeeBps; // <= FOUND
1283:     }
```
['[1285](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L1285-L1286)']
```solidity
1285:     function _getMakerFeeBps() internal view override returns (uint256) {
1286:         return makerFeeBps; // <= FOUND
1287:     }
```
['[1289](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L1289-L1290)']
```solidity
1289:     function _getBaseAssetDecimals() internal view override returns (uint256) {
1290:         return baseAssetDecimals; // <= FOUND
1291:     }
```
['[1293](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L1293-L1294)']
```solidity
1293:     function _getQuoteAssetDecimals() internal view override returns (uint256) {
1294:         return quoteAssetDecimals; // <= FOUND
1295:     }
```
['[1297](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L1297-L1298)']
```solidity
1297:     function _getBaseAsset() internal view override returns (address) {
1298:         return baseAsset; // <= FOUND
1299:     }
```
['[1301](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L1301-L1302)']
```solidity
1301:     function _getQuoteAsset() internal view override returns (address) {
1302:         return quoteAsset; // <= FOUND
1303:     }
```
['[1308](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L1308-L1313)']
```solidity
1308:     function getMarketParams()
1309:         external
1310:         view
1311:         returns (uint32, uint96, address, uint256, address, uint256, uint32, uint96, uint96, uint256, uint256)
1312:     {
1313:         return ( // <= FOUND
1314:             pricePrecision,
1315:             sizePrecision,
1316:             baseAsset,
1317:             baseAssetDecimals,
1318:             quoteAsset,
1319:             quoteAssetDecimals,
1320:             tickSize,
1321:             minSize,
1322:             maxSize,
1323:             takerFeeBps,
1324:             makerFeeBps
1325:         );
1326:     }
```
['[1331](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L1331-L1334)']
```solidity
1331:     function bestBidAsk() external view returns (uint256, uint256) {
1332:         (, uint256 _bestBid) = bestBid();
1333:         (, uint256 _bestAsk) = bestAsk();
1334:         return (_bestBid, _bestAsk); // <= FOUND
1335:     }
```
['[1337](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L1337-L1342)']
```solidity
1337:     function _getOBAsk() internal view returns (uint256) {
1338:         uint32 firstLeft = TreeMath.findFirstLeft(s_sellTree, 0);
1339:         if (firstLeft != 0) {
1340:             return firstLeft * vaultPricePrecision / pricePrecision; // <= FOUND
1341:         }
1342:         return type(uint256).max; // <= FOUND
1343:     }
```
['[1345](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L1345-L1350)']
```solidity
1345:     function _getOBBid() internal view returns (uint256) {
1346:         uint32 firstRight = TreeMath.findFirstRight(s_buyTree, type(uint32).max);
1347:         if (firstRight != type(uint32).max) {
1348:             return firstRight * vaultPricePrecision / pricePrecision; // <= FOUND
1349:         }
1350:         return 0; // <= FOUND
1351:     }
```
['[1353](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L1353-L1366)']
```solidity
1353:     function bestAsk() internal view returns (bool, uint256) {
1354:         uint256 firstLeft = TreeMath.findFirstLeft(s_sellTree, 0) * vaultPricePrecision / pricePrecision;
1355:         if (firstLeft != 0) {
1356:             if (vaultBestAsk != type(uint256).max) {
1357:                 if (firstLeft == vaultBestAsk) {
1358:                     return (false, firstLeft); // <= FOUND
1359:                 }
1360:                 return (FixedPointMathLib.min(firstLeft, vaultBestAsk)) == vaultBestAsk // <= FOUND
1361:                     ? (true, vaultBestAsk)
1362:                     : (false, firstLeft);
1363:             }
1364:             return (false, firstLeft); // <= FOUND
1365:         }
1366:         return (vaultBestAsk != type(uint256).max) ? (true, vaultBestAsk) : (false, 0); // <= FOUND
1367:     }
```
['[1369](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L1369-L1382)']
```solidity
1369:     function bestBid() internal view returns (bool, uint256) {
1370:         uint256 firstRight = TreeMath.findFirstRight(s_buyTree, type(uint32).max) * vaultPricePrecision / pricePrecision;
1371:         if (firstRight != type(uint32).max * vaultPricePrecision / pricePrecision) {
1372:             if (vaultBestBid != 0) {
1373:                 if (firstRight == vaultBestBid) {
1374:                     return (false, firstRight); // <= FOUND
1375:                 }
1376:                 return (FixedPointMathLib.max(firstRight, vaultBestBid)) == vaultBestBid // <= FOUND
1377:                     ? (true, vaultBestBid)
1378:                     : (false, firstRight);
1379:             }
1380:             return (false, firstRight); // <= FOUND
1381:         }
1382:         return vaultBestBid != 0 ? (true, vaultBestBid) : (false, type(uint256).max); // <= FOUND
1383:     }
```
['[1390](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L1390-L1391)']
```solidity
1390:     function getL2Book() external view returns (bytes memory) {
1391:         return getL2Book(type(uint32).max, type(uint32).max); // <= FOUND
1392:     }
```
['[23](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/periphery/ERC20.sol#L23-L24)']
```solidity
23:     function symbol() public view virtual override returns (string memory) {
24:         return _symbol; // <= FOUND
25:     }
```
['[229](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L229-L235)']
```solidity
229:     function computeVaultAddress(address _marketAddress, address oldImplementation, bool old)
230:         public
231:         view
232:         returns (address)
233:     {
234:         bytes32 _salt = keccak256(abi.encode(_marketAddress));
235:         return Create2.computeAddress( // <= FOUND
236:             _salt,
237:             keccak256(
238:                 abi.encodePacked(
239:                     type(ERC1967Proxy).creationCode,
240:                     abi.encode(old ? oldImplementation : kuruAmmVaultImplementation, bytes(""))
241:                 )
242:             )
243:         );
244:     }
```
['[117](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/KuruForwarder.sol#L117-L118)']
```solidity
117:     function _domainNameAndVersionMayChange() internal pure override returns (bool result) {
118:         return true; // <= FOUND
119:     }
```
['[38](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/ERC2771Context.sol#L38-L39)']
```solidity
38:     function _contextSuffixLength() internal pure returns (uint256) {
39:         return 20; // <= FOUND
40:     }
```
['[194](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L194-L196)']
```solidity
194:     function powWad(int256 x, int256 y) internal pure returns (int256) {
195:         
196:         return expWad((lnWad(x) * y) / int256(WAD)); // <= FOUND
197:     }
```
['[202](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L202-L206)']
```solidity
202:     function expWad(int256 x) internal pure returns (int256 r) {
203:         unchecked {
204:             
205:             
206:             if (x <= -41446531673892822313) return r; // <= FOUND
207: 
208:             
209:             assembly {
210:                 
211:                 
212:                 if iszero(slt(x, 135305999368893231589)) {
213:                     mstore(0x00, 0xa37bfec9) 
214:                     revert(0x1c, 0x04)
215:                 }
216:             }
217: 
218:             
219:             
220:             
221:             x = (x << 78) / 5 ** 18;
222: 
223:             
224:             
225:             
226:             int256 k = ((x << 96) / 54916777467707473351141471128 + 2 ** 95) >> 96;
227:             x = x - k * 54916777467707473351141471128;
228: 
229:             
230: 
231:             
232:             
233:             int256 y = x + 1346386616545796478920950773328;
234:             y = ((y * x) >> 96) + 57155421227552351082224309758442;
235:             int256 p = y + x - 94201549194550492254356042504812;
236:             p = ((p * y) >> 96) + 28719021644029726153956944680412240;
237:             p = p * x + (4385272521454847904659076985693276 << 96);
238: 
239:             
240:             int256 q = x - 2855989394907223263936484059900;
241:             q = ((q * x) >> 96) + 50020603652535783019961831881945;
242:             q = ((q * x) >> 96) - 533845033583426703283633433725380;
243:             q = ((q * x) >> 96) + 3604857256930695427073651918091429;
244:             q = ((q * x) >> 96) - 14423608567350463180887372962807573;
245:             q = ((q * x) >> 96) + 26449188498355588339934803723976023;
246: 
247:             
248:             assembly {
249:                 
250:                 
251:                 
252:                 r := sdiv(p, q)
253:             }
254: 
255:             
256: 
257:             
258:             
259:             
260:             
261:             
262:             
263:             r = int256((uint256(r) * 3822833074963236453042738258902158003155416615667) >> uint256(195 - k));
264:         }
265:     }
```
['[346](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L346-L416)']
```solidity
346:     function lambertW0Wad(int256 x) internal pure returns (int256 w) {
347:         
348:         unchecked {
349:             if ((w = x) <= -367879441171442322) revert OutOfDomain(); 
350:             int256 wad = int256(WAD);
351:             int256 p = x;
352:             uint256 c; 
353:             uint256 i = 4; 
354:             if (w <= 0x1ffffffffffff) {
355:                 if (-0x4000000000000 <= w) {
356:                     i = 1; 
357:                 } else if (w <= -0x3ffffffffffffff) {
358:                     i = 32; 
359:                 }
360:             } else if (uint256(w >> 63) == uint256(0)) {
361:                 
362:                 assembly {
363:                     
364:                     let v := shr(49, w)
365:                     let l := shl(3, lt(0xff, v))
366:                     l := add(or(l, byte(and(0x1f, shr(shr(l, v), 0x8421084210842108cc6318c6db6d54be)),
367:                         0x0706060506020504060203020504030106050205030304010505030400000000)), 49)
368:                     w := sdiv(shl(l, 7), byte(sub(l, 31), 0x0303030303030303040506080c13))
369:                     c := gt(l, 60)
370:                     i := add(2, add(gt(l, 53), c))
371:                 }
372:             } else {
373:                 int256 ll = lnWad(w = lnWad(w));
374:                 
375:                 assembly {
376:                     
377:                     w := add(sdiv(mul(ll, 1023715080943847266), w), sub(w, ll))
378:                     i := add(3, iszero(shr(68, x)))
379:                     c := iszero(shr(143, x))
380:                 }
381:                 if (c == uint256(0)) {
382:                     do { 
383:                         int256 e = expWad(w);
384:                         
385:                         assembly {
386:                             let t := mul(w, div(e, wad))
387:                             w := sub(w, sdiv(sub(t, x), div(add(e, t), wad)))
388:                         }
389:                         if (p <= w) break;
390:                         p = w;
391:                     } while (--i != uint256(0));
392:                     
393:                     assembly {
394:                         w := sub(w, sgt(w, 2))
395:                     }
396:                     return w; // <= FOUND
397:                 }
398:             }
399:             do { 
400:                 int256 e = expWad(w);
401:                 
402:                 assembly {
403:                     let t := add(w, wad)
404:                     let s := sub(mul(w, e), mul(x, wad))
405:                     w := sub(w, sdiv(mul(s, wad), sub(mul(e, t), sdiv(mul(add(t, wad), s), add(t, t)))))
406:                 }
407:                 if (p <= w) break;
408:                 p = w;
409:             } while (--i != c);
410:             
411:             assembly {
412:                 w := sub(w, sgt(w, 2))
413:             }
414:             
415:             
416:             if (c == uint256(0)) return w; // <= FOUND
417:             int256 t = w | 1;
418:             
419:             assembly {
420:                 x := sdiv(mul(x, wad), t)
421:             }
422:             x = (t * (wad + lnWad(x)));
423:             
424:             assembly {
425:                 w := sdiv(x, add(wad, t))
426:             }
427:         }
428:     }
```
['[570](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L570-L571)']
```solidity
570:     function mulDivRound(uint256 value, uint256 multiplier, uint256 divisor) internal pure returns (uint256) {
571:         return (value * multiplier + divisor / 2) / divisor; // <= FOUND
572:     }
```
['[724](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L724-L726)']
```solidity
724:     function sqrtWad(uint256 x) internal pure returns (uint256 z) {
725:         unchecked {
726:             if (x <= type(uint256).max / 10 ** 18) return sqrt(x * 10 ** 18); // <= FOUND
727:             z = (1 + sqrt(x)) * 10 ** 9;
728:             z = (fullMulDivUnchecked(x, 10 ** 18, z) + z) >> 1;
729:         }
730:         
731:         assembly {
732:             z := sub(z, gt(999999999999999999, sub(mulmod(z, z, x), 1))) 
733:         }
734:     }
```
['[739](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L739-L741)']
```solidity
739:     function cbrtWad(uint256 x) internal pure returns (uint256 z) {
740:         unchecked {
741:             if (x <= type(uint256).max / 10 ** 36) return cbrt(x * 10 ** 36); // <= FOUND
742:             z = (1 + cbrt(x)) * 10 ** 12;
743:             z = (fullMulDivUnchecked(x, 10 ** 36, z * z) + z + z) / 3;
744:         }
745:         
746:         assembly {
747:             let p := x
748:             for {} 1 {} {
749:                 if iszero(shr(229, p)) {
750:                     if iszero(shr(199, p)) {
751:                         p := mul(p, 100000000000000000) 
752:                         break
753:                     }
754:                     p := mul(p, 100000000) 
755:                     break
756:                 }
757:                 if iszero(shr(249, p)) { p := mul(p, 100) }
758:                 break
759:             }
760:             let t := mulmod(mul(z, z), z, p)
761:             z := sub(z, gt(lt(t, shr(1, p)), iszero(t))) 
762:         }
763:     }
```
['[1033](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L1033-L1043)']
```solidity
1033:     function lerp(uint256 a, uint256 b, uint256 t, uint256 begin, uint256 end) internal pure returns (uint256) {
1034:         if (begin > end) {
1035:             t = ~t;
1036:             begin = ~begin;
1037:             end = ~end;
1038:         }
1039:         if (t <= begin) return a; // <= FOUND
1040:         if (t >= end) return b; // <= FOUND
1041:         unchecked {
1042:             if (b >= a) return a + fullMulDiv(b - a, t - begin, end - begin); // <= FOUND
1043:             return a - fullMulDiv(a - b, t - begin, end - begin); // <= FOUND
1044:         }
1045:     }
```
['[1051](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/FixedPointMathLib.sol#L1051-L1063)']
```solidity
1051:     function lerp(int256 a, int256 b, int256 t, int256 begin, int256 end) internal pure returns (int256) {
1052:         if (begin > end) {
1053:             t = int256(~uint256(t));
1054:             begin = int256(~uint256(begin));
1055:             end = int256(~uint256(end));
1056:         }
1057:         if (t <= begin) return a; // <= FOUND
1058:         if (t >= end) return b; // <= FOUND
1059:         
1060:         unchecked {
1061:             if (b >= a) return int256(uint256(a) + fullMulDiv(uint256(b) - uint256(a), // <= FOUND
1062:                 uint256(t) - uint256(begin), uint256(end) - uint256(begin)));
1063:             return int256(uint256(a) - fullMulDiv(uint256(a) - uint256(b), // <= FOUND
1064:                 uint256(t) - uint256(begin), uint256(end) - uint256(begin)));
1065:         }
1066:     }
```
['[260](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/TreeMath.sol#L260-L262)']
```solidity
260:     function _closestBitRight(bytes32 leaves, uint8 bit) private pure returns (uint256) {
261:         unchecked {
262:             return uint256(leaves).closestBitRight(bit - 1); // <= FOUND
263:         }
264:     }
```
['[273](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/libraries/TreeMath.sol#L273-L275)']
```solidity
273:     function _closestBitLeft(bytes32 leaves, uint8 bit) private pure returns (uint256) {
274:         unchecked {
275:             return uint256(leaves).closestBitLeft(bit + 1); // <= FOUND
276:         }
277:     }
```
['[243](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/MarginAccount.sol#L243-L244)']
```solidity
243:     function _accountKey(address _user, address _token) internal pure returns (bytes32) {
244:         return keccak256(abi.encodePacked(_user, _token)); // <= FOUND
245:     }
```
['[392](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/Router.sol#L392-L404)']
```solidity
392:     function _getSalt(
393:         address _baseAssetAddress,
394:         address _quoteAssetAddress,
395:         uint96 _sizePrecision,
396:         uint32 _pricePrecision,
397:         uint32 _tickSize,
398:         uint96 _minSize,
399:         uint96 _maxSize,
400:         uint256 _takerFeeBps,
401:         uint256 _makerFeeBps,
402:         uint96 _kuruAmmSpread
403:     ) internal pure returns (bytes32) {
404:         return keccak256( // <= FOUND
405:             abi.encodePacked(
406:                 _baseAssetAddress,
407:                 _quoteAssetAddress,
408:                 _sizePrecision,
409:                 _pricePrecision,
410:                 _tickSize,
411:                 _minSize,
412:                 _maxSize,
413:                 _takerFeeBps,
414:                 _makerFeeBps,
415:                 _kuruAmmSpread
416:             )
417:         );
418:     }
```


</details>

## [Gas-58] It is redundant to compare msg.sender against address(0)

### Resolution 
Comparing msg.sender against address(0) in Solidity is redundant because msg.sender cannot be address(0). In Ethereum, msg.sender represents the address executing the current function call, which inherently implies an active, non-zero address. This check is unnecessary as address(0), or the zero address, typically represents an uninitialized state or a burn address, neither of which can initiate transactions. Including such a comparison does not add security or functional value to the contract and only serves to clutter the code and potentially waste gas.

Num of instances: 7

### Findings 


<details><summary>Click to show findings</summary>

['[756](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L756-L756)']
```solidity
756:         if (msg.sender == address(0)) { // <= FOUND
```
['[738](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L738-L738)']
```solidity
738:         if (_type == OrderBookType.NATIVE_IN_QUOTE && !_isMargin && (msg.sender != address(0))) { // <= FOUND
```
['[745](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L745-L745)']
```solidity
745:         } else if (msg.sender != address(0)) { // <= FOUND
```
['[794](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L794-L794)']
```solidity
794:         if (_type == OrderBookType.NATIVE_IN_BASE && !_isMargin && (msg.sender != address(0))) { // <= FOUND
```
['[976](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L976-L976)']
```solidity
976:             if (sizeToCreditViaVault > 0 && msg.sender != address(0)) { // <= FOUND
```
['[988](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L988-L988)']
```solidity
988:             if (msg.sender != address(0)) { // <= FOUND
```
['[1051](https://cantina.xyz/code/cdce21ba-b787-4df4-9c56-b31d085388e7/contracts/OrderBook.sol#L1051-L1051)']
```solidity
1051:             if (quoteCreditVaultTaker > 0 && msg.sender != address(0)) { // <= FOUND
```


</details>
